<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect Pro - Professional Aftercare Document Builder</title>
    
    <!-- PDF Libraries for document merging -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Family First Adolescent Services - Document Creation Tool">
    <meta name="theme-color" content="#0099cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FFAS Docs">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232196a6'/%3E%3Cpath d='M 20 15 Q 32 12 44 15 L 40 22 Q 32 20 24 22 Q 18 28 18 38 L 26 38 Q 26 32 29 29 Q 32 27 37 28 L 35 33 Q 32 32 30 33 Q 28 35 28 38 L 36 38 Q 36 35 37 33 Q 40 32 44 33 L 42 38 Q 38 37 37 38 Q 36 40 36 45 L 29 45 Q 29 42 26 42 L 18 45 Q 15 32 22 22 Q 26 18 32 15' fill='white'/%3E%3C/svg%3E">
    
    <style>
        /* Modern UI Enhancement Styles - Override Existing */
        
        /* Beautiful Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Override Program Cards for Better Look */
        .program-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%) !important;
            padding: 24px !important;
            border-radius: 16px !important;
            border: 2px solid transparent !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08) !important;
            animation: fadeIn 0.5s ease;
        }
        
        .program-card:hover {
            transform: translateY(-6px) scale(1.02) !important;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.18) !important;
            border-color: #667eea !important;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%) !important;
        }
        
        .program-card.selected {
            background: linear-gradient(135deg, #f0f4ff, #e5edff) !important;
            border: 2px solid #667eea !important;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.28) !important;
            transform: scale(1.02) !important;
        }
        
        /* Beautiful Buttons */
        .btn-primary, button[onclick*="generate"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 14px 28px !important;
            border: none !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            font-size: 15px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .btn-primary:hover, button[onclick*="generate"]:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.45) !important;
        }
        
        .btn-primary:active, button[onclick*="generate"]:active {
            transform: translateY(-1px) !important;
        }
        
        /* Modern Modal Overlay */
        .modal {
            background-color: rgba(0,0,0,0.7) !important;
            backdrop-filter: blur(10px) !important;
            animation: modalFadeIn 0.3s ease !important;
        }
        
        .modal-content {
            border-radius: 20px !important;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3) !important;
            animation: modalSlideIn 0.3s ease !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 25px 30px !important;
            border-radius: 20px 20px 0 0 !important;
        }
        
        .modal-header h2 {
            color: white !important;
            font-weight: 600 !important;
            font-size: 24px !important;
        }
        
        /* Input Field Styling */
        input[type="text"], input[type="email"], input[type="password"], textarea, select {
            padding: 12px 16px !important;
            border-radius: 10px !important;
            border: 2px solid #e5e7eb !important;
            font-size: 15px !important;
            transition: all 0.3s ease !important;
            background: white !important;
        }
        
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            border-color: #667eea !important;
            outline: none !important;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1) !important;
        }
        
        /* Checkbox and Radio Styling */
        input[type="checkbox"], input[type="radio"] {
            width: 20px !important;
            height: 20px !important;
            cursor: pointer !important;
            accent-color: #667eea !important;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46a2);
        }
        
        /* Loading Animation */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        /* Smooth Transitions for All Interactive Elements */
        button, a, input, textarea, select, .card, .panel {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        /* Responsive Design Improvements */
        @media screen and (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }
            
        .main-content {
                flex-direction: column;
            }
            
            .selection-panel {
                width: 100%;
                max-width: 100%;
                border-left: none;
                border-top: 2px solid #e5e7eb;
                margin-top: 20px;
                position: relative;
                top: 0;
            }
            
            .programs-panel {
                max-height: none;
            }
        }
        
        @media screen and (max-width: 768px) {
            .header {
                padding: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 24px !important;
            }
            
            .program-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 95vh;
            }
            
            .wizard-steps {
                gap: 8px;
            }
            
            .wizard-step-indicator {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .btn-primary, button[onclick*="generate"] {
                padding: 12px 20px !important;
                font-size: 14px !important;
            }
            
            .doc-type-buttons {
                flex-direction: column;
            }
            
            .doc-type-btn {
                width: 100%;
            }
        }
        
        @media screen and (max-width: 480px) {
            .programs-panel, .selection-panel {
                padding: 15px;
            }
            
            .program-card {
                padding: 16px !important;
            }
            
            input[type="text"], textarea, select {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            .modal-header {
                padding: 20px !important;
            }
            
            .modal-header h2 {
                font-size: 20px !important;
            }
            
            .wizard-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .wizard-actions button {
                width: 100%;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white !important;
            }
            
            .theme-toggle, .modal, button {
                display: none !important;
            }
            
            .container {
                box-shadow: none !important;
                max-width: 100% !important;
            }
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .program-card {
                border: 3px solid #000 !important;
            }
            
            .btn-primary {
                border: 2px solid #000 !important;
            }
            
            input, textarea, select {
                border: 2px solid #000 !important;
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Additional Polish */
        .guided-btn {
            background: linear-gradient(135deg, #34d399, #059669) !important;
            color: white !important;
            font-weight: 600 !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 14px 24px !important;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .guided-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 10px 28px rgba(5, 150, 105, 0.4) !important;
        }
        
        .wizard-back {
            background: #e5e7eb !important;
            color: #374151 !important;
        }
        
        .wizard-back:hover {
            background: #d1d5db !important;
        }
        
        .wizard-next {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: white !important;
        }
        
        .wizard-next:hover {
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4) !important;
        }
        
        .wizard-finish {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
        }
        
        .wizard-finish:hover {
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4) !important;
        }
        
        /* Fix overlapping elements */
        .selection-panel {
            z-index: 10;
            visibility: visible !important;
        }

        .programs-panel {
            z-index: 5;
        }

        .header {
            z-index: 20;
        }
        
        /* Ensure text is readable */
        h1, h2, h3, h4, h5, h6 {
            line-height: 1.4;
            margin-bottom: 0.5em;
        }
        
        p {
            line-height: 1.6;
            margin-bottom: 1em;
        }
        
        /* Better focus states */
        a:focus, button:focus, input:focus, textarea:focus, select:focus {
            outline: 3px solid rgba(102, 126, 234, 0.5) !important;
            outline-offset: 2px;
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0099cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    </style>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 15px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 153, 204, 0.25);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            display: grid !important;
            grid-template-columns: 1fr 440px; /* left: programs, right: controls */
            gap: 20px;
            min-height: 600px;
            position: relative;
            align-items: start;
            visibility: visible !important;
        }
        
        .programs-panel {
            padding: 30px;
            overflow-y: auto;
            background: #ffffff;
            max-height: 85vh;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 1;
        }
        
        .selection-panel {
            width: 440px;
            min-width: 440px;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 20px;
            display: flex !important;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 12px;
            position: sticky;
            top: 10px;
            height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 10;
        }
        
        .document-type-selector {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .doc-type-buttons {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .doc-type-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #0099cc;
            background: white;
            color: #0099cc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .doc-type-btn.active {
            background: #0099cc;
            color: white;
        }

        .guided-btn {
            width: 100%;
            margin-bottom: 20px;
            padding: 12px 18px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #34d399, #059669);
            color: white;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .guided-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(5, 150, 105, 0.35);
        }

        .guided-btn:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .wizard-actions button {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .wizard-actions .wizard-back {
            background: #e5e7eb;
            color: #374151;
        }

        .wizard-actions .wizard-next {
            background: #4f46e5;
            color: white;
        }

        .wizard-actions .wizard-finish {
            background: #059669;
            color: white;
        }

        .wizard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .wizard-card {
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.08);
        }

        .wizard-program-list {
            display: grid;
            gap: 10px;
            max-height: 260px;
            overflow-y: auto;
        }

        .wizard-program-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
            transition: border-color 0.2s ease;
        }

        .wizard-program-item input[type="checkbox"] {
            margin-top: 4px;
            transform: scale(1.1);
        }

        .wizard-program-item.active {
            border-color: #4f46e5;
            box-shadow: 0 4px 14px rgba(79, 70, 229, 0.18);
            background: #eef2ff;
        }

        .wizard-program-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .wizard-program-meta .name {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-program-meta .location {
            font-size: 12px;
            color: #4b5563;
        }

        .wizard-program-meta .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .wizard-program-meta .chip {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .wizard-toggles {
            display: grid;
            gap: 10px;
        }

        .wizard-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
        }

        .wizard-toggle span {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-note {
            font-size: 13px;
            color: #4b5563;
            background: #ecfeff;
            border-left: 4px solid #0891b2;
            padding: 12px 14px;
            border-radius: 8px;
        }

        .wizard-no-results {
            text-align: center;
            padding: 30px 20px;
            color: #6b7280;
            font-size: 14px;
            border: 1px dashed #cbd5f5;
            border-radius: 10px;
            background: #f8fafc;
        }

        .input-error {
            border-color: #f87171 !important;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2) !important;
        }

        .document-preview-modal {
            max-width: 95%;
            width: 900px;
        }

        /* Document preview container - clean and simple */
        #documentPreviewContainer {
            background: white;
            margin: 0 auto;
            padding: 40px 60px;
            box-sizing: border-box;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        /* Ensure all document styles apply in preview */
        #documentPreviewContainer .doc-page {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        #documentPreviewContainer .doc-content {
            padding-bottom: 40px;
        }
        
        #documentPreviewContainer .doc-footer {
            position: relative;
            bottom: auto;
            margin-top: 40px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media screen and (max-width: 900px) {
            #documentPreviewContainer {
                padding: 20px 30px;
            }
        }
        
        .client-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .client-info h3 {
            color: #0c4a6e;
            margin-bottom: 14px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .client-info input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            margin-bottom: 0;
            font-family: -apple-system, 'Calibri', Arial, sans-serif;
            font-size: 15px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .client-info input:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        /* Checkbox specific styles */
        #includeAtHome {
            accent-color: #0099cc;
            transform: scale(1.1);
            margin-right: 2px;
        }
        
        #includeAtHome:hover {
            transform: scale(1.2);
        }
        
        .search-container {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
        }
        
        .search-box {
            width: 100%;
            padding: 14px 18px;
            padding-right: 120px; /* Space for button */
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        .search-indicator {
            display: none;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .add-program-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            background: linear-gradient(45deg, #0099cc, #00b4d8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 153, 204, 0.3);
            z-index: 10;
        }
        
        .add-program-btn.show {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .add-program-btn:hover {
            background: linear-gradient(45deg, #0088bb, #00a3c7);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 153, 204, 0.4);
        }
        
        .add-program-btn:active {
            transform: translateY(-50%) scale(0.98);
        }
        
        .search-animation {
            animation: searchPulse 2s infinite;
        }
        
        @keyframes searchPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .add-animation {
            animation: addSuccess 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes addSuccess {
            0% { transform: translateY(-50%) scale(1); }
            20% { transform: translateY(-50%) scale(1.2) rotate(5deg); }
            40% { transform: translateY(-50%) scale(0.9) rotate(-3deg); }
            60% { transform: translateY(-50%) scale(1.1) rotate(2deg); }
            80% { transform: translateY(-50%) scale(0.95) rotate(-1deg); }
            100% { transform: translateY(-50%) scale(1) rotate(0deg); }
        }
        
        .filter-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .filter-btn:hover {
            border-color: #0099cc;
            color: #0099cc;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .filter-btn.active {
            background: #0099cc;
            color: white;
            border-color: #0099cc;
            box-shadow: 0 2px 8px rgba(0,153,204,0.2);
        }
        
        .program-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            padding: 0;
            margin-top: 15px;
        }
        
        .program-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .program-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #cbd5e1;
        }
        
        .program-card.primary {
            border-color: #0099cc;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            box-shadow: 0 4px 12px rgba(0,153,204,0.15);
        }
        
        .program-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            background: #0099cc;
        }
        
        .program-name {
            font-weight: bold;
            font-size: 15px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .program-location {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .program-type {
            display: inline-block;
            padding: 2px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            margin-top: 5px;
        }
        
        .program-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #0099cc;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            z-index: 2;
            transition: all 0.3s;
        }
        
        .program-info-btn:hover {
            background: #0077aa;
            transform: scale(1.1);
        }
        
        .selected-section {
            flex: 0 1 auto;
            min-height: 120px;
            margin-bottom: 10px;
        }
        
        .section-title {
            font-weight: 600;
            margin: 20px 0 16px 0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            color: #1e40af;
            border-left: 4px solid #0099cc;
        }
        
        .selected-program {
            background: white;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            font-size: 13px;
            cursor: move;
            transition: all 0.3s;
        }
        
        .selected-program.dragging {
            opacity: 0.5;
            background: #f0f8ff;
        }
        
        .selected-program.drag-over {
            border-top: 3px solid #0099cc;
        }
        
        .drag-handle {
            cursor: move;
            color: #999;
            margin-right: 8px;
            font-size: 16px;
        }
        
        .program-order-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .order-btn {
            background: #0099cc;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .order-btn:hover {
            background: #0077aa;
        }
        
        .order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #0099cc, #0077aa);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,153,204,0.3);
            width: 100%;
            letter-spacing: 0.5px;
            min-height: 44px;
            max-height: 44px;
        }
        
        .generate-btn:hover {
            background: linear-gradient(135deg, #0077aa, #005588);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,153,204,0.4);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        
        .generate-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .instructions {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
            border: 1px solid #fbbf24;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(251,191,36,0.1);
        }
        
        .instructions h3 {
            color: #92400e;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .instructions ul {
            margin-left: 20px;
            color: #78350f;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .instructions ul li {
            margin-bottom: 6px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 15px;
            font-style: italic;
            font-size: 13px;
        }
        
        #selectedList {
            min-height: 80px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 10px;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border-bottom: 1px solid #2a2a3e;
        }

        body.dark-mode .panel {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .program-card {
            background: #252538;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .program-card:hover {
            background: #2a2a3e;
            border-color: #4a4a5e;
        }

        body.dark-mode .program-card.selected {
            background: #2a3f5f;
            border-color: #3498db;
        }

        body.dark-mode input[type="text"],
        body.dark-mode select {
            background: #252538;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        body.dark-mode .modal-content {
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 50px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        body.dark-mode .theme-toggle {
            background: #252538;
            border-color: #3a3a4e;
            color: #e0e0e0;
        }

        /* Comparison View Styles */
        .comparison-view {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            overflow: hidden;
        }

        .comparison-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-content {
            display: flex;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .comparison-column {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #ddd;
        }

        .comparison-column:last-child {
            border-right: none;
        }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .quick-action-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        body.dark-mode .quick-action-btn {
            background: #252538;
            border-color: #3a3a4e;
            color: #e0e0e0;
        }

        body.dark-mode .quick-action-btn:hover {
            background: #2a2a3e;
        }

        /* Document History Panel */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        
        .history-panel.active {
            display: block;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .history-item:hover {
            background: #f5f5f5;
        }

        body.dark-mode .history-panel {
            background: #1a1a2e;
        }

        body.dark-mode .history-item {
            border-bottom-color: #2a2a3e;
        }

        body.dark-mode .history-item:hover {
            background: #252538;
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .analytics-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .analytics-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 80%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: #0099cc;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            position: relative;
            z-index: 1001;
            padding: 5px;
            line-height: 1;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            color: #f0f0f0;
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            min-height: 0; /* Important for flex children */
        }
        
        .preview-section {
            margin-bottom: 20px;
        }
        
        .preview-section h3 {
            color: #0099cc;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        
        .preview-features {
            list-style: none;
            padding: 0;
        }
        
        .preview-features li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .preview-features li strong {
            color: #333;
        }
        
        .preview-contact {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        
        .preview-contact div {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .modal-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .add-from-preview {
            background: #0099cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-from-preview:hover {
            background: #0077aa;
        }
        
        .add-from-preview.selected {
            background: #dc3545;
        }
        
        /* Print Styles - Professional Clean Document */
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .main-content { flex-direction: column; }
            .programs-panel, .selection-panel { width: 100%; max-width: 100%; }
            .program-grid { grid-template-columns: 1fr; }
            .filter-buttons, .quick-actions { flex-wrap: wrap; }
            .theme-toggle { top: 10px; right: 10px; }
            .history-panel { width: 100%; }
            .comparison-view { width: 95%; }
            .comparison-content { flex-direction: column; }
        }
        
        @media print {
            @page {
                size: letter;
                margin: 1in 0.75in 1in 0.75in; /* Top, Right, Bottom, Left - content width ~6.5" */
            }
            
            /* Hide ALL UI elements during print */
            .theme-toggle,
            .history-panel,
            .comparison-view,
            .analytics-dashboard,
            .container,
            .modal,
            .quick-actions,
            #historyPanel,
            #comparisonView,
            #analyticsDashboard {
                display: none !important;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .container {
                display: none !important;
            }
            
            .document-output {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                color: black;
                font-family: Helvetica, Arial, "Segoe UI", sans-serif;
                font-size: 11pt;
                line-height: 1.6;
            }
            
            .doc-page {
                position: relative;
                width: 100%;
                padding: 0;
                page-break-inside: avoid;
                overflow: visible; /* ensure header image not clipped */
            }
            
            /* Hide web elements completely */
            .modal, .program-info-btn, .program-badge {
                display: none !important;
            }
        }
        
        /* Document output styles */
        .document-output {
            display: none;
            font-family: Helvetica, Arial, "Segoe UI", sans-serif;
            font-size: 11pt; /* Body size 11-12pt as specified */
            line-height: 1.6;
            color: #000;
        }
        
        .doc-page {
            background: white;
            position: relative;
            min-height: 100%;
            overflow: visible; /* allow header graphics to render fully */
            width: 720px; /* 7.5 inches of usable space at 96 DPI */
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .doc-content {
            padding-bottom: 100px; /* More space for footer to prevent overlap */
            padding-top: 0; /* Remove top padding */
            margin-top: 0;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: calc(100vh - 150px); /* Ensure proper page height */
        }
        
        /* Letterhead Header */
        .doc-letterhead {
            text-align: center;
                            margin-bottom: 20px;
            padding-bottom: 0;
                            margin-top: 0;
                            padding-top: 0;
                        }
                        .letterhead-image {
                            width: 100%;
                            max-width: 100%;
                            height: auto;
                            margin: 0 auto;
                            display: block;
        }
        
        .doc-letterhead-logo {
            height: 80px !important; /* fixed visual height to avoid partial decode/cropping */
            width: auto !important;
            max-width: 160px !important;
            margin: 0 auto 15px !important;
            display: block !important;
            object-fit: contain !important;
            object-position: center center !important;
            /* Ensure image loads properly in print */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .doc-logo {
            width: 200px;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }
        
        .doc-letterhead-lockup {
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }
        
        .doc-letterhead-icon {
            width: 40px;
            height: 40px;
            background: #0099cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        
        .doc-letterhead-text {
            text-align: center;
        }
        
        .doc-letterhead-text h1 {
            font-size: 24pt;
            color: #0099cc;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        
        .doc-letterhead-text p {
            font-size: 12pt;
            color: #000000;
            margin: 2px 0 0 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        /* Document Body */
        .doc-greeting {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: normal;
            margin-bottom: 8px;
        }
        
        .doc-intro {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-style: italic;
            text-decoration: underline;
            margin-bottom: 18pt;
            line-height: 1.4;
        }
        
        /* Section headers - CALIBRI 10PT BOLD (e.g., "Aftercare Options:") */
        .doc-section-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            margin: 18pt 0 14pt 0;
            text-align: left;
        }
        
        /* Category headers - CALIBRI 9PT BOLD (e.g., "PHP Options") */
        .doc-category-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: bold;
            margin: 14pt 0 10pt 0;
        }
        
        /* Program Cards */
        .doc-program {
            margin-bottom: 24pt; /* Two blank lines between programs */
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        /* Program title line with en dash - MUST BE CALIBRI 10PT BOLD */
        .doc-program-title {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            color: #000;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        /* Level of Care & Services section - MUST BE SINGLE PARAGRAPH, CALIBRI 9PT */
        .doc-program-descriptor {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-top: 12pt;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        .doc-program-descriptor strong {
            font-weight: bold;
        }
        
        /* Program Details heading - CALIBRI 9PT BOLD */
        .doc-program-details-heading {
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-size: 9pt;
            margin-bottom: 6pt;
            margin-top: 12pt;
        }
        
        /* Bullet lists - REAL BULLETS, CALIBRI 9PT */
        .doc-program-bullets {
            margin: 0 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-program-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-bottom: 4pt;
            position: relative;
            padding-left: 15px;
            line-height: 1.4;
        }
        
        .doc-program-bullets li:before {
            content: "";
            position: absolute;
            left: 0;
        }
        
        /* Bold concept introductions in bullets */
        .doc-program-bullets li strong {
            font-weight: bold;
        }
        
        /* Sub-bullets with dashes */
        .doc-sub-bullets {
            margin: 4pt 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-sub-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            margin-bottom: 2pt;
            position: relative;
            padding-left: 15px;
        }
        
        .doc-sub-bullets li:before {
            content: "";
            position: absolute;
            left: 0;
        }
        
        /* Contact Information block - CALIBRI 9PT */
        .doc-contact-section {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            line-height: 1.4;
            margin-top: 6pt;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .doc-contact-section strong {
            font-weight: bold;
        }
        
        .doc-contact-section a {
            word-break: break-all;
            color: #0066cc;
            text-decoration: none;
        }
        
        .doc-contact-section a:hover {
            text-decoration: underline;
        }
        
        /* Footer - stacked format */
        .doc-footer {
            position: fixed;
            bottom: 20px;
            left: 50px;
            right: 50px;
            text-align: center;
            font-size: 10pt;
            color: #333;
            background: white;
            padding: 15px 10px 10px 10px;
            border-top: 1px solid #ccc;
            z-index: 1000;
            box-shadow: 0 -2px 5px rgba(255,255,255,0.9);
            line-height: 1.4;
        }
        
        .doc-footer div {
            margin: 2px 0;
        }
        
        /* Mini card styles for AT HOME sections */
        .doc-mini-card {
            margin-bottom: 18pt;
            padding: 12pt;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafbfc;
        }
        
        .doc-mini-title {
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 8pt;
            color: #374151;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 4pt;
        }
        
        .doc-mini-blurb {
            font-size: 10pt;
            margin-bottom: 8pt;
            min-height: 24pt;
            border-bottom: 1px dotted #9ca3af;
            padding-bottom: 4pt;
            color: #6b7280;
        }
        
        .doc-mini-contact {
            font-size: 10pt;
            color: #374151;
        }
        
        .doc-mini-contact .contact-line {
            display: flex;
            align-items: center;
            margin-bottom: 4pt;
        }
        
        .doc-mini-contact .contact-label {
            font-weight: 600;
            min-width: 70px;
            color: #1f2937;
        }
        
        .doc-mini-contact .contact-fill {
            flex: 1;
            border-bottom: 1px solid #d1d5db;
            min-height: 16pt;
            margin-left: 8px;
        }
        
        /* Special emphasis for AT HOME Recommendation */
        .doc-emphasis-section {
            font-family: Calibri, Arial, sans-serif;
            font-size: 10pt;
            font-style: italic;
            text-decoration: underline;
        }
        
        /* Print-specific styles for blank lines */
        @media print {
            .doc-mini-title, .doc-mini-blurb, .doc-mini-contact {
                min-height: 1.2em;
            }
            
            .doc-footer {
                position: fixed;
                bottom: 0.5in;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 10pt;
                color: #333;
                background: white;
                padding: 10px 0;
                z-index: 100;
            }
            
            .doc-content {
                padding-bottom: 80px; /* More space for fixed footer */
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
            <h2 style="margin: 0 0 10px 0; color: #1a202c; text-align: center; font-size: 28px;">Family First</h2>
            <p style="text-align: center; color: #718096; margin-bottom: 30px; font-size: 14px;">ADOLESCENT SERVICES - Document Creator</p>
            
            <div id="loginError" style="display: none; background: #fed7d7; color: #9b2c2c; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;"></div>
            
            <form onsubmit="handleLogin(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 600; font-size: 14px;">Username</label>
                    <input type="text" id="loginUsername" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 16px; transition: border-color 0.2s; box-sizing: border-box;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'">
                </div>
                
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 6px; color: #4a5568; font-weight: 600; font-size: 14px;">Password</label>
                    <input type="password" id="loginPassword" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 16px; transition: border-color 0.2s; box-sizing: border-box;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e2e8f0'">
                </div>
                
                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                    Sign In
                </button>
            </form>
            
            <p style="text-align: center; margin-top: 20px; color: #a0aec0; font-size: 12px;">Secure Document Generation System</p>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" style="display: none;">
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon"></span>
        <span id="themeText">Dark Mode</span>
    </button>
    
    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>Document History</h3>
            <button onclick="toggleHistory()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;"></button>
        </div>
        <div id="historyContent"></div>
    </div>
    
    <!-- Comparison View -->
    <div class="comparison-view" id="comparisonView">
        <div class="comparison-header">
            <h3>Program Comparison</h3>
            <button onclick="closeComparison()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;"></button>
        </div>
        <div class="comparison-content" id="comparisonContent"></div>
    </div>
    
    <!-- Slide-out Menu -->
    <div id="slideMenu" class="slide-menu">
        <div class="menu-header">
            <h3>Menu</h3>
            <button class="close-menu" onclick="toggleMenu()"></button>
        </div>
        <div class="menu-content">
            <div class="menu-section">
                <h4>Tools</h4>
                <button class="menu-item" onclick="showTemplates(); toggleMenu();">
                    <span class="menu-icon"></span>
                    <span>Templates</span>
                </button>
                <button class="menu-item" onclick="showAnalytics(); toggleMenu();">
                    <span class="menu-icon"></span>
                    <span>Analytics</span>
                </button>
                <button class="menu-item" onclick="showHelp(); toggleMenu();">
                    <span class="menu-icon"></span>
                    <span>Help & Shortcuts</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Data</h4>
                <button class="menu-item" onclick="exportData(); toggleMenu();">
                    <span class="menu-icon"></span>
                    <span>Export Data</span>
                </button>
                <button class="menu-item" onclick="importData(); toggleMenu();">
                    <span class="menu-icon"></span>
                    <span>Import Data</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Actions</h4>
                <button class="menu-item" onclick="saveAsTemplate(); toggleMenu();">
                    <span class="menu-icon"></span>
                    <span>Save as Template</span>
                </button>
                <button class="menu-item" onclick="clearAllPrograms(); toggleMenu();">
                    <span class="menu-icon"></span>
                    <span>Clear All Programs</span>
                </button>
            </div>
        </div>
    </div>
    
    <style>
        .slide-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        
        .slide-menu.active {
            right: 0;
        }
        
        .menu-header {
            background: #0099cc;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close-menu {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-content {
            padding: 20px;
        }
        
        .menu-section {
            margin-bottom: 30px;
        }
        
        .menu-section h4 {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .menu-item {
            width: 100%;
            padding: 12px 15px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .menu-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* Dark mode styles for menu */
        body.dark-mode .slide-menu {
            background: #2a2a2a;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .menu-header {
            background: #1a1a2a;
        }
        
        body.dark-mode .menu-section h4 {
            color: #999;
            border-color: #444;
        }
        
        body.dark-mode .menu-item {
            background: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .menu-item:hover {
            background: #404040;
        }
        
        /* Menu overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 9998;
        }
        
        .menu-overlay.active {
            display: block;
        }
    </style>
    
    <!-- Menu Overlay -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>
    
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="header-text">
                    <h1>CareConnect Pro</h1>
                    <p>FAMILY FIRST ADOLESCENT SERVICES</p>
                </div>
            </div>
            <div class="header-right" style="display: flex; align-items: center; gap: 20px;">
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); text-align: right;">
                    Professional Aftercare Document Builder<br>
                    <small style="color: rgba(255,255,255,0.7); font-size: 12px;">v3.0 Deluxe</small>
                </div>
                <div class="header-controls" style="display: flex; gap: 10px;">
                    <button class="header-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <span id="themeIcon"></span>
                    </button>
                    <button class="header-btn" onclick="toggleMenu()" title="Menu" style="font-size: 20px;"></button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Left Panel: Program List -->
            <div class="programs-panel">
                
                <div class="quick-actions" style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <button class="quick-action-btn" onclick="selectAllPrograms()">Select All</button>
                    <button class="quick-action-btn" onclick="clearAllPrograms()">Clear All</button>
                    <button class="quick-action-btn" onclick="openDocumentVault()" style="background: #10b981; color: white;"> Vault</button>
                    <button class="quick-action-btn" onclick="createDischargePacket()" style="background: #8b5cf6; color: white;"> DC Packet</button>
                </div>
                
                <div class="search-container" style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" class="search-box" id="searchBox" placeholder=" Search programs by name, location, features, or contacts..." oninput="handleSearch(this.value)" style="flex: 1;">
                    <div class="search-indicator" id="searchIndicator" style="display: none;"> Searching...</div>
                    <button class="add-program-btn" id="addProgramBtn" onclick="showAddProgramDialog()" style="background: #0066cc; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; white-space: nowrap; flex-shrink: 0;">
                         Add New Program
                    </button>
                </div>
                
                <div class="filter-buttons" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <button class="filter-btn active" onclick="filterPrograms('all', this)">All Programs</button>
                    
                    <!-- Category dropdown -->
                    <select class="filter-dropdown" onchange="filterPrograms(this.value, this)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                        <option value="">Filter by Type...</option>
                        <option value="rtc">RTC</option>
                        <option value="tbs">TBS</option>
                        <option value="wilderness">Wilderness</option>
                        <option value="php-iop">PHP/IOP</option>
                        <option value="transitional">Transitional</option>
                        <option value="virtual">Virtual</option>
                        <option value="asd">ASD</option>
                        <option value="evaluation">Evaluation</option>
                        <option value="athome">AT HOME</option>
                    </select>
                </div>
                
                <!-- Recently Used Programs -->
                <div id="recentlyUsedSection" style="display: none; margin-bottom: 20px;">
                    <h3 style="color: #0099cc; margin-bottom: 10px;"> Recently Used</h3>
                    <div class="recent-programs-grid" id="recentProgramsGrid">
                        <!-- Recent programs will be loaded here -->
                    </div>
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                </div>
                
                <div class="program-grid" id="programGrid">
                    <!-- Programs will be loaded here -->
                </div>
                
            </div>
            
            <!-- Right Panel: Selected Programs & Controls -->
            <div class="selection-panel">

                <div class="document-type-selector" style="margin-bottom: 20px; display: block !important; visibility: visible !important;">
                    <h3 style="font-size: 14px; color: #0099cc; margin-bottom: 8px; display: block !important;">Document Type:</h3>
                    <div class="doc-type-buttons">
                        <button class="doc-type-btn active" onclick="setDocumentType('options', this)">OPTIONS (Multiple)</button>
                        <button class="doc-type-btn" onclick="setDocumentType('plans', this)">PLANS (Single)</button>
                    </div>
                </div>

                
                <div class="client-info" style="margin-bottom: 15px;">
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px 10px; margin-bottom: 10px; font-size: 13px;">
                        <strong> HIPAA:</strong> Enter first name only - No PHI
                    </div>
                    <div style="position: relative; margin-bottom: 8px;">
                        <input type="text" 
                               id="clientName" 
                               placeholder="First Name Only (Required)" 
                               style="width: 100%; padding-right: 40px; text-transform: capitalize;" 
                               oninput="validateClientName(this)"
                               maxlength="20">
                        <span id="nameValidIcon" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 16px; display: none;"></span>
                        <div id="nameValidationMsg" style="margin-top: 4px; font-size: 12px; display: none;"></div>
                    </div>
                    <label style="display: flex; align-items: center; gap: 8px; margin-top: 6px; font-size: 14px; cursor: pointer; position: relative; z-index: 10;">
                        <input type="checkbox" id="includeAtHome" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleAtHomeSection()">
                        <span>Include AT HOME Recommendations</span>
                        </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-top: 6px; font-size: 14px; cursor: pointer;">
                        <input type="checkbox" id="includeAlumni" style="width: 16px; height: 16px; cursor: pointer;">
                        <span>Include Alumni Services</span>
                    </label>
                </div>
                
                <div class="selected-section">
                    <div class="section-title" id="selectedTitle">Selected Programs (Drag to reorder)</div>
                    <div id="selectedList">
                        <div class="empty-state">Click programs to add to selection</div>
                    </div>
                </div>
                    
                <!-- Original AT HOME Providers Section -->
                <div id="atHomeSection" style="display: none; margin-top: 15px; padding: 0; border: 1px solid #e0e7ff; border-radius: 8px; background: #f8fafc; width: 100%; box-sizing: border-box; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); cursor: pointer; border-bottom: 2px solid #0099cc; transition: all 0.2s ease;" 
                         onmouseover="this.style.background='linear-gradient(135deg, #e0f2fe, #bae6fd)'" 
                         onmouseout="this.style.background='linear-gradient(135deg, #f0f9ff, #e0f2fe)'" 
                         onclick="toggleAtHomeContent()">
                        <h4 style="margin: 0; color: #0099cc; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            AT HOME Providers
                            <span id="atHomeProviderCount" style="background: #0099cc; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: normal;"></span>
                        </h4>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="atHomeToggleText" style="color: #0099cc; font-size: 12px; font-weight: 600; text-transform: uppercase;">Expand</span>
                            <button type="button" id="atHomeToggleBtn" style="background: #0099cc; color: white; border: none; border-radius: 4px; font-size: 20px; cursor: pointer; padding: 2px 8px; line-height: 1; font-weight: bold; box-shadow: 0 2px 4px rgba(0,153,204,0.3);"></button>
                    </div>
                </div>
                    <div id="atHomeContent" style="padding: 15px; display: none; transition: all 0.3s ease; max-height: 350px; overflow-y: auto; border-top: 1px solid #e0e7ff; position: relative;">
                        <div id="atHomeProviders" style="margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; padding-bottom: 5px; border-top: 1px solid #f0f0f0; padding-top: 10px;">
                            <button type="button" onclick="addAtHomeProvider()" style="padding: 8px 16px; background: #0099cc; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                + Add Provider
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Generate button at bottom -->
                <div style="margin-top: auto; padding-top: 20px;">
                    <button class="generate-btn" id="generateBtn" onclick="generateDocument()" style="width: 100%;" title="Keyboard shortcut: Ctrl+Enter (or Cmd+Enter on Mac)">
                         GENERATE DOCUMENT
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Program Details</h2>
                <button class="modal-close" onclick="closePreview()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-actions">
                <button id="modalAddBtn" class="add-from-preview" onclick="toggleFromPreview()">Add to Selection</button>
                <button onclick="closePreview()" style="padding: 10px 20px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Add Custom Program Modal -->
    <div id="addProgramModal" class="modal">
        <div class="modal-content" style="max-width: 750px; max-height: 85vh;">
            <div class="modal-header">
                <h2>Add Custom Program</h2>
                <button class="modal-close" onclick="closeAddProgramModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- Chrome Extension Info -->
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                    <h3 style="margin: 0 0 10px 0; color: white; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;"></span>
                        Chrome Extension - The Best Way to Add Programs
                    </h3>
                    <p style="margin: 0 0 15px 0; font-size: 16px; line-height: 1.5;">
                        The Family First Program Extractor Chrome Extension automatically extracts program information from any treatment center website with advanced pattern matching and multi-page analysis.
                    </p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; color: white;"> Features:</h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                                <li>Extracts from multiple pages</li>
                                <li>Finds contact info automatically</li>
                                <li>Detects therapies & specializations</li>
                                <li>Works on any program website</li>
                                <li>No API keys needed</li>
                            </ul>
                        </div>
                        <div style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; color: white;"> Simple Steps:</h4>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px;">
                                <li>Install the extension</li>
                                <li>Visit any program website</li>
                                <li>Click extension icon</li>
                                <li>Click "Extract Page Info"</li>
                                <li>Click "Copy to Tool"</li>
                                <li>Data appears here instantly!</li>
                            </ol>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 6px; text-align: center;">
                        <p style="margin: 0; font-size: 14px;">
                            <strong> Extension Location:</strong> Load the chrome-extension folder from Chrome Extensions page
                        </p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;">
                            <strong>No server needed!</strong> Just open this HTML file directly in Chrome
                        </p>
                    </div>
                </div>
                
                <!-- Mode Toggle -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    <button id="manualModeBtn" onclick="setAddProgramMode('manual')" style="flex: 1; padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                         Manual Text Entry
                    </button>
                    <button id="templateModeBtn" onclick="setAddProgramMode('template')" style="flex: 1; padding: 12px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                         Template Format
                    </button>
                </div>
                
                <!-- AI Mode Content - Removed -->
                <div id="aiModeContent" style="display: none;">
                <div style="margin-bottom: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #0066cc;">
                        <p style="margin: 0; color: #0066cc; font-weight: 600;"> Enter the program's website URL and AI will extract all information automatically</p>
                    </div>
                    
                    <label for="programUrl" style="display: block; margin-bottom: 10px; font-weight: 600;">
                        Program Website URL:
                    </label>
                    <input 
                        type="url" 
                        id="programUrl" 
                        placeholder="https://www.example-program.com" 
                        style="width: 100%; padding: 15px; border: 2px solid #4f46e5; border-radius: 8px; font-size: 16px; margin-bottom: 10px;"
                        onkeypress="if(event.key === 'Enter') extractProgram()"
                    >
                    <small style="color: #6b7280; display: block; margin-bottom: 20px;">Example: https://www.trinityteen.com or https://newlifehouserecovery.com</small>
                    
                    <!-- Progress Tracker -->
                    <div id="aiProgressTracker" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin: 20px 0; color: white;">
                        <h4 style="margin-top: 0; color: white; font-size: 18px;"> AI Extraction in Progress</h4>
                        <div id="progressSteps" style="margin: 15px 0;">
                            <div class="progress-step" id="step1" style="display: flex; align-items: center; margin: 10px 0; opacity: 0.5;">
                                <span class="step-icon" style="font-size: 20px; margin-right: 10px;"></span>
                                <span class="step-text">Validating URL format...</span>
                                <span class="step-time" style="margin-left: auto; font-size: 12px;"></span>
                            </div>
                            <div class="progress-step" id="step2" style="display: flex; align-items: center; margin: 10px 0; opacity: 0.5;">
                                <span class="step-icon" style="font-size: 20px; margin-right: 10px;"></span>
                                <span class="step-text">Fetching website content...</span>
                                <span class="step-time" style="margin-left: auto; font-size: 12px;"></span>
                            </div>
                            <div class="progress-step" id="step3" style="display: flex; align-items: center; margin: 10px 0; opacity: 0.5;">
                                <span class="step-icon" style="font-size: 20px; margin-right: 10px;"></span>
                                <span class="step-text">Analyzing with AI model...</span>
                                <span class="step-time" style="margin-left: auto; font-size: 12px;"></span>
                            </div>
                            <div class="progress-step" id="step4" style="display: flex; align-items: center; margin: 10px 0; opacity: 0.5;">
                                <span class="step-icon" style="font-size: 20px; margin-right: 10px;"></span>
                                <span class="step-text">Formatting program data...</span>
                                <span class="step-time" style="margin-left: auto; font-size: 12px;"></span>
                            </div>
                        </div>
                        <div id="progressDetails" style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 120px; overflow-y: auto; display: none;"></div>
                        <div id="progressError" style="margin-top: 15px; padding: 12px; background: rgba(255,0,0,0.2); border-radius: 8px; display: none;"></div>
                    </div>
                </div>
                
                <!-- Manual Mode Content -->
                <div id="manualModeContent" style="display: none;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <p style="margin: 0; color: #92400e; font-weight: 600;"> Paste program information from any source</p>
                        <p style="margin: 5px 0 0 0; color: #92400e; font-size: 14px;"> Paste content extracted by the Chrome Extension</p>
                        <p style="margin: 2px 0 0 0; color: #92400e; font-size: 14px;"> Or paste from emails, PDFs, or other sources</p>
                        <p style="margin: 2px 0 0 0; color: #92400e; font-size: 14px;"> Use "Smart Format" for automatic pattern-based formatting</p>
                </div>
                
                <label for="customProgramInfo" style="display: block; margin-bottom: 10px; font-weight: 600;">
                    Paste Program Information:
                </label>
                <textarea 
                    id="customProgramInfo" 
                    placeholder="Paste program details here (from website, brochure, email, etc). Include:&#10; Program name&#10; Location&#10; Phone number&#10; Level of care (RTC, PHP, IOP, etc)&#10; Age range&#10; Treatment specialties&#10; Any other relevant information"
                        style="width: 100%; height: 250px; padding: 15px; border: 2px solid #f59e0b; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                ></textarea>
                </div>
                
                <!-- Template Mode Content -->
                <div id="templateModeContent" style="display: none;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <p style="margin: 0; color: #075985; font-weight: 600;"> Use our structured template to format program information (Chrome Extension compatible)</p>
                    </div>
                    
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Program Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="templateName" placeholder="e.g., Healing Springs Treatment Center" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Location</label>
                            <input type="text" id="templateLocation" placeholder="e.g., Denver, Colorado" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Phone Number</label>
                                <input type="tel" id="templatePhone" placeholder="e.g., (555) 123-4567" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Email</label>
                                <input type="email" id="templateEmail" placeholder="e.g., admissions@program.com" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Level of Care</label>
                                <select id="templateLevel" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                                    <option value="">Select level...</option>
                                    <option value="RTC">RTC - Residential Treatment Center</option>
                                    <option value="PHP">PHP - Partial Hospitalization</option>
                                    <option value="IOP">IOP - Intensive Outpatient</option>
                                    <option value="Outpatient">Outpatient</option>
                                    <option value="Sober Living">Sober Living</option>
                                    <option value="Wilderness">Wilderness Therapy</option>
                                    <option value="Therapeutic Boarding School">Therapeutic Boarding School</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Age Range</label>
                                <input type="text" id="templateAges" placeholder="e.g., 12-17 years" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Treatment Specialties</label>
                            <textarea id="templateSpecialties" placeholder="e.g., Depression, Anxiety, Trauma, ADHD, Substance Use, etc." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Therapeutic Modalities</label>
                            <textarea id="templateModalities" placeholder="e.g., CBT, DBT, EMDR, Family Therapy, Group Therapy, Art Therapy, etc." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Insurance/Payment</label>
                            <textarea id="templateInsurance" placeholder="e.g., Accepts most major insurance, Private pay, Financial assistance available" style="width: 100%; height: 60px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Program Description</label>
                            <textarea id="templateDescription" placeholder="Brief description of the program, philosophy, and unique features..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Website URL</label>
                            <input type="url" id="templateWebsite" placeholder="https://www.example-program.com" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 1px solid #fde68a;">
                        <p style="margin: 0; font-size: 14px; color: #92400e;">
                            <strong> Tip:</strong> Use the Chrome Extension to extract data from any treatment program website. The extension will automatically populate these fields when you click "Copy to Tool".
                        </p>
                    </div>
                </div>
                
                <div id="customProgramStatus" style="margin: 15px 0;"></div>
            </div>
            <div class="modal-actions">
                <button id="smartFormatBtn" onclick="smartFormatProgram()" style="padding: 14px 28px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.3s;">
                     Smart Format & Add Program
                </button>
                <button id="addTemplateBtn" onclick="addTemplateProgram()" style="padding: 14px 28px; background: #0284c7; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.3s; display: none;">
                     Add Template Program
                </button>
                <button onclick="closeAddProgramModal()" style="padding: 14px 28px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- Document Preview Modal -->
    <div id="documentPreviewModal" class="modal">
        <div class="modal-content document-preview-modal">
            <div class="modal-header">
                <h2>Document Preview</h2>
                <button class="modal-close" onclick="closeDocumentPreview()">&times;</button>
            </div>
            <div class="modal-body" style="background: #f3f4f6; padding: 20px;">
                <!-- Case Manager Workflow Options -->
            <div style="background: linear-gradient(135deg, #f0f4ff, #e5edff); border-radius: 12px; padding: 16px; margin: 16px 0; border: 1px solid #667eea;">
                <h4 style="margin: 0 0 12px 0; color: #4c1d95; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                    <span></span> Case Manager Options
                </h4>
                
                <!-- Document Actions Row 1 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 12px;">
                    <button onclick="downloadDocumentPdf(event)" style="padding: 8px 12px; border-radius: 6px; border: none; background: #4f46e5; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span></span> Download PDF
                    </button>
                    <button onclick="printDocumentPreview()" style="padding: 8px 12px; border-radius: 6px; border: none; background: #0ea5e9; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span></span> Print Document
                    </button>
                    <button onclick="emailDocument()" style="padding: 8px 12px; border-radius: 6px; border: none; background: #10b981; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span></span> Email Document
                    </button>
                    <button onclick="saveToVault()" style="padding: 8px 12px; border-radius: 6px; border: none; background: #f59e0b; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span></span> Save to Vault
                    </button>
                </div>
                
                <!-- Document Actions Row 2 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 12px;">
                    <button onclick="addToDischargePacket()" style="padding: 8px 12px; border-radius: 6px; border: none; background: #8b5cf6; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span></span> Add to Packet
                    </button>
                    <button onclick="scheduleFollowUp()" style="padding: 8px 12px; border-radius: 6px; border: none; background: #ef4444; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span></span> Schedule Follow-up
                    </button>
                    <button onclick="createTaskReminder()" style="padding: 8px 12px; border-radius: 6px; border: none; background: #06b6d4; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span></span> Set Reminder
                    </button>
                    <button onclick="shareWithTeam()" style="padding: 8px 12px; border-radius: 6px; border: none; background: #84cc16; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span></span> Share with Team
                    </button>
                </div>
            </div>
            
            <!-- Document Preview Container -->
                <div id="documentPreviewContainer" class="document-preview-container"></div>
            </div>
            
            <div class="modal-actions" style="justify-content: space-between;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="generateNewDocument()" style="padding: 10px 20px; border-radius: 8px; border: none; background: #059669; color: white; font-weight: 600; cursor: pointer;"> Generate New</button>
                </div>
                <button onclick="closeDocumentPreview()" style="padding: 10px 20px; border-radius: 8px; border: none; background: #e5e7eb; color: #374151; font-weight: 600; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden document output for printing -->
    <div class="document-output" id="documentOutput">    </div>
    </div> <!-- End of mainApp -->
    
    <script>
        // Login System
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            // Check credentials
            if (username === 'Doc121' && password === 'FFA121') {
                // Successful login
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Store login state in session
                sessionStorage.setItem('isLoggedIn', 'true');
            } else {
                // Failed login
                errorDiv.textContent = 'Invalid username or password. Please try again.';
                errorDiv.style.display = 'block';
                
                // Clear password field
                document.getElementById('loginPassword').value = '';
                
                // Hide error after 3 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Check if already logged in on page load
        window.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
            }
            
            // Initialize features
            initializeTheme();
            initializeDragDrop();
            initializeKeyboardShortcuts();
            initializeAnalytics();
            initializeTemplates();
            initializeOfflineMode();
        });
        
        // Loading spinner helpers
        function showLoadingSpinner(message = 'Processing...') {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p style="margin: 0; color: #333; font-size: 16px;">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function hideLoadingSpinner() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // ================ NEW DELUXE FEATURES ================

        // Dark Mode Toggle
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').textContent = '';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').textContent = isDark ? '' : '';
            showNotification(`${isDark ? 'Dark' : 'Light'} mode enabled`, 'success');
        }

        // Menu Toggle
        function toggleMenu() {
            const menu = document.getElementById('slideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                menu.classList.add('active');
                overlay.classList.add('active');
            }
        }

        // Drag & Drop for Program Reordering
        function initializeDragDrop() {
            let draggedItem = null;
            let draggedIndex = null;
            
            // Make selected programs draggable
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('selected-program-item')) {
                    draggedItem = e.target;
                    draggedIndex = parseInt(e.target.dataset.index);
                    e.target.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                }
            });
            
            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('selected-program-item')) {
                    e.target.style.opacity = '';
                    draggedItem = null;
                    
                    // Update the selectedPrograms array based on new DOM order
                    const selectedList = document.getElementById('selectedList');
                    const items = Array.from(selectedList.querySelectorAll('.selected-program-item'));
                    const newOrder = items.map(item => {
                        const id = item.dataset.id;
                        return selectedPrograms.find(p => p.id === id);
                    });
                    
                    selectedPrograms = newOrder;
                    updateSelectionPanel(); // Re-render to update indices
                    saveUndoAction('reorder', null);
                }
            });
            
            document.addEventListener('dragover', function(e) {
                if (e.target.closest('.selected-program-item') && draggedItem) {
                    e.preventDefault();
                    const targetItem = e.target.closest('.selected-program-item');
                    const selectedList = document.getElementById('selectedList');
                    const afterElement = getDragAfterElement(selectedList, e.clientY);
                    
                    if (afterElement == null) {
                        selectedList.appendChild(draggedItem);
                    } else {
                        selectedList.insertBefore(draggedItem, afterElement);
                    }
                }
            });
        }
        
        function initializeProgramDragDrop() {
            // Additional initialization for newly added programs
            const selectedList = document.getElementById('selectedList');
            if (!selectedList) return;
            
            selectedList.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.selected-program-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Enhanced Keyboard Shortcuts
        function initializeKeyboardShortcuts() {
            const shortcuts = {
                'ctrl+enter': () => generateDocument(),
                'ctrl+s': () => saveAsTemplate(),
                'ctrl+d': () => toggleTheme(),
                'ctrl+h': () => showHelp(),
                'ctrl+a': () => showAnalytics(),
                'ctrl+t': () => showTemplates(),
                'ctrl+z': () => undoLastAction(),
                'ctrl+/': () => document.getElementById('searchInput').focus(),
                'escape': () => closeAllModals()
            };
            
            document.addEventListener('keydown', function(e) {
                const key = (e.ctrlKey || e.metaKey ? 'ctrl+' : '') + e.key.toLowerCase();
                
                if (shortcuts[key]) {
                    e.preventDefault();
                    shortcuts[key]();
                }
            });
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Analytics Dashboard
        function initializeAnalytics() {
            if (!localStorage.getItem('analytics')) {
                localStorage.setItem('analytics', JSON.stringify({
                    documentsGenerated: 0,
                    programUsage: {},
                    sessionTime: [],
                    lastAccess: new Date().toISOString()
                }));
            }
        }

        function trackAnalytics(action, data) {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '{}');
            
            switch(action) {
                case 'document':
                    analytics.documentsGenerated = (analytics.documentsGenerated || 0) + 1;
                    break;
                case 'program':
                    analytics.programUsage = analytics.programUsage || {};
                    analytics.programUsage[data] = (analytics.programUsage[data] || 0) + 1;
                    break;
            }
            
            analytics.lastAccess = new Date().toISOString();
            localStorage.setItem('analytics', JSON.stringify(analytics));
        }

        function showAnalytics() {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '{}');
            const modal = createModal('Usage Analytics', `
                <div class="analytics-dashboard">
                    <div class="stat-card">
                        <h3> Documents Generated</h3>
                        <div class="stat-number">${analytics.documentsGenerated || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3> Top Programs</h3>
                        <div class="program-stats">
                            ${getTopPrograms(analytics.programUsage)}
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3> Last Access</h3>
                        <div class="stat-text">${new Date(analytics.lastAccess).toLocaleDateString()}</div>
                    </div>
                </div>
                <style>
                    .analytics-dashboard {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 20px;
                        padding: 20px 0;
                    }
                    .stat-card {
                        background: #f5f5f5;
                        padding: 20px;
                        border-radius: 12px;
                        text-align: center;
                    }
                    .stat-card h3 {
                        margin-bottom: 15px;
                        color: #666;
                        font-size: 16px;
                    }
                    .stat-number {
                        font-size: 48px;
                        font-weight: bold;
                        color: #0099cc;
                    }
                    .program-stats {
                        text-align: left;
                        max-height: 200px;
                        overflow-y: auto;
                    }
                    .program-stat-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid #eee;
                    }
                    body.dark-mode .stat-card {
                        background: #333;
                    }
                    body.dark-mode .program-stat-item {
                        border-color: #444;
                    }
                </style>
            `);
            document.body.appendChild(modal);
        }

        function getTopPrograms(usage) {
            if (!usage || Object.keys(usage).length === 0) {
                return '<p style="color: #999;">No data yet</p>';
            }
            
            const sorted = Object.entries(usage)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            return sorted.map(([name, count]) => `
                <div class="program-stat-item">
                    <span>${name}</span>
                    <span style="color: #0099cc; font-weight: bold;">${count}</span>
                </div>
            `).join('');
        }

        // Templates System
        function initializeTemplates() {
            if (!localStorage.getItem('templates')) {
                localStorage.setItem('templates', JSON.stringify([]));
            }
        }

        function saveAsTemplate() {
            if (selectedPrograms.length === 0) {
                showNotification('Select programs before saving as template', 'warning');
                return;
            }
            
            const templateName = prompt('Enter template name:');
            if (!templateName) return;
            
            const templates = JSON.parse(localStorage.getItem('templates') || '[]');
            templates.push({
                id: Date.now(),
                name: templateName,
                programs: selectedPrograms,
                documentType: documentType,
                created: new Date().toISOString()
            });
            
            localStorage.setItem('templates', JSON.stringify(templates));
            showNotification(`Template "${templateName}" saved!`, 'success');
        }

        function showTemplates() {
            const templates = JSON.parse(localStorage.getItem('templates') || '[]');
            const modal = createModal('Document Templates', `
                <div class="templates-list">
                    ${templates.length === 0 ? 
                        '<p style="text-align: center; color: #999;">No templates saved yet</p>' :
                        templates.map(template => `
                            <div class="template-item">
                                <div class="template-info">
                                    <h4>${template.name}</h4>
                                    <small>${template.programs.length} programs  ${template.documentType}  ${new Date(template.created).toLocaleDateString()}</small>
                                </div>
                                <div class="template-actions">
                                    <button class="btn btn-sm btn-primary" onclick="loadTemplate(${template.id})">Load</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${template.id})">Delete</button>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveAsTemplate()">Save Current as Template</button>
                </div>
                <style>
                    .templates-list {
                        max-height: 400px;
                        overflow-y: auto;
                        margin: 20px 0;
                    }
                    .template-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px;
                        background: #f5f5f5;
                        border-radius: 8px;
                        margin-bottom: 10px;
                    }
                    .template-info h4 {
                        margin: 0 0 5px 0;
                    }
                    .template-actions {
                        display: flex;
                        gap: 10px;
                    }
                    .btn-sm {
                        padding: 6px 12px;
                        font-size: 14px;
                    }
                    .btn-danger {
                        background: #dc3545;
                    }
                    body.dark-mode .template-item {
                        background: #333;
                    }
                </style>
            `);
            document.body.appendChild(modal);
        }

        function loadTemplate(templateId) {
            const templates = JSON.parse(localStorage.getItem('templates') || '[]');
            const template = templates.find(t => t.id === templateId);
            
            if (template) {
                selectedPrograms = [...template.programs];
                documentType = template.documentType;
                
                // Update UI
                updateSelectedProgramsDisplay();
                document.querySelectorAll('.doc-type-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent.toLowerCase().includes(documentType));
                });
                
                closeAllModals();
                showNotification(`Template "${template.name}" loaded!`, 'success');
            }
        }

        function deleteTemplate(templateId) {
            if (!confirm('Delete this template?')) return;
            
            const templates = JSON.parse(localStorage.getItem('templates') || '[]');
            const filtered = templates.filter(t => t.id !== templateId);
            localStorage.setItem('templates', JSON.stringify(filtered));
            
            // Refresh templates modal
            closeAllModals();
            showTemplates();
        }

        // Help System with Keyboard Shortcuts
        function showHelp() {
            const modal = createModal('Help & Keyboard Shortcuts', `
                <div class="help-content">
                    <h3> Keyboard Shortcuts</h3>
                    <div class="shortcuts-grid">
                        <div class="shortcut">
                            <kbd>Ctrl + Enter</kbd>
                            <span>Generate Document</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + S</kbd>
                            <span>Save as Template</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + D</kbd>
                            <span>Toggle Dark Mode</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + H</kbd>
                            <span>Show Help</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + A</kbd>
                            <span>Show Analytics</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + T</kbd>
                            <span>Show Templates</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + Z</kbd>
                            <span>Undo Last Action</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + /</kbd>
                            <span>Focus Search</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Esc</kbd>
                            <span>Close Modals</span>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;"> Pro Tips</h3>
                    <ul style="line-height: 1.8;">
                        <li>Drag and drop selected programs to reorder them</li>
                        <li>Use templates to save common program combinations</li>
                        <li>Check analytics to see your most used programs</li>
                        <li>The app works offline - no internet needed!</li>
                        <li>All data is stored locally for HIPAA compliance</li>
                    </ul>
                </div>
                <style>
                    .help-content {
                        padding: 20px 0;
                    }
                    .shortcuts-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    .shortcut {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        padding: 10px;
                        background: #f5f5f5;
                        border-radius: 8px;
                    }
                    .shortcut kbd {
                        background: #333;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-family: monospace;
                        white-space: nowrap;
                    }
                    body.dark-mode .shortcut {
                        background: #333;
                    }
                    body.dark-mode .shortcut kbd {
                        background: #555;
                    }
                </style>
            `);
            document.body.appendChild(modal);
        }

        // Offline Mode Indicator
        function initializeOfflineMode() {
            updateOfflineStatus();
            window.addEventListener('online', updateOfflineStatus);
            window.addEventListener('offline', updateOfflineStatus);
        }

        function updateOfflineStatus() {
            const isOffline = !navigator.onLine;
            
            // Remove existing indicator
            const existing = document.getElementById('offlineIndicator');
            if (existing) existing.remove();
            
            if (isOffline) {
                const indicator = document.createElement('div');
                indicator.id = 'offlineIndicator';
                indicator.innerHTML = ' Offline Mode';
                indicator.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    background: #ff9800;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: bold;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 1000;
                `;
                document.body.appendChild(indicator);
            }
        }

        // Helper function to create modals
        function createModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            return modal;
        }

        // Recently Used Programs
        function getRecentlyUsedPrograms() {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '{}');
            const usage = analytics.programUsage || {};
            
            // Get last 5 used programs from history
            const history = JSON.parse(localStorage.getItem('documentHistory') || '[]');
            const recentNames = [];
            
            for (let i = history.length - 1; i >= 0 && recentNames.length < 5; i--) {
                const doc = history[i];
                if (doc.programs) {
                    doc.programs.forEach(p => {
                        if (!recentNames.includes(p.name)) {
                            recentNames.push(p.name);
                        }
                    });
                }
            }
            
            return recentNames.slice(0, 5);
        }
        
        function showRecentlyUsedPrograms() {
            const recentSection = document.getElementById('recentlyUsedSection');
            const recentGrid = document.getElementById('recentProgramsGrid');
            const recentNames = getRecentlyUsedPrograms();
            
            if (recentNames.length === 0) {
                recentSection.style.display = 'none';
                return;
            }
            
            recentSection.style.display = 'block';
            recentGrid.innerHTML = '';
            
            // Find full program data for recent programs
            const recentPrograms = recentNames.map(name => {
                return allPrograms.find(p => p.name === name);
            }).filter(p => p); // Filter out any not found
            
            recentPrograms.forEach(program => {
                const card = document.createElement('div');
                card.className = 'program-card recent-program';
                card.dataset.id = program.id;
                
                // Check if already selected
                const isSelected = selectedPrograms.some(p => p.id === program.id);
                if (isSelected) card.classList.add('selected');
                
                card.innerHTML = `
                    <div class="program-name">${program.name}</div>
                    <div class="program-location">${program.location || ''}</div>
                    <div class="program-details">${program.category || ''}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">Recently Used</div>
                `;
                
                card.addEventListener('click', () => handleProgramClick(program, card));
                recentGrid.appendChild(card);
            });
            
            // Style the recent programs grid
            recentGrid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
                margin-bottom: 10px;
            `;
        }

        // Export/Import functionality
        function exportData() {
            const data = {
                templates: JSON.parse(localStorage.getItem('templates') || '[]'),
                analytics: JSON.parse(localStorage.getItem('analytics') || '{}'),
                programs: JSON.parse(localStorage.getItem('customPrograms') || '[]'),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `careconnect-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (confirm('This will replace your current data. Continue?')) {
                            if (data.templates) localStorage.setItem('templates', JSON.stringify(data.templates));
                            if (data.analytics) localStorage.setItem('analytics', JSON.stringify(data.analytics));
                            if (data.programs) localStorage.setItem('customPrograms', JSON.stringify(data.programs));
                            
                            showNotification('Data imported successfully!', 'success');
                            location.reload();
                        }
                    } catch (err) {
                        showNotification('Error importing data. Please check the file.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Session timeout - auto logout after 30 minutes of inactivity
        let lastActivity = Date.now();
        const SESSION_TIMEOUT = 4 * 60 * 60 * 1000; // 4 hours for clinical workflow
        
        function updateActivity() {
            lastActivity = Date.now();
        }
        
        // Track user activity
        document.addEventListener('click', updateActivity);
        document.addEventListener('keypress', updateActivity);
        document.addEventListener('scroll', updateActivity);
        
        // Check for timeout every minute
        setInterval(() => {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                if (Date.now() - lastActivity > SESSION_TIMEOUT) {
                    sessionStorage.clear();
                    alert('Your session has expired. Please log in again.');
                    location.reload();
                }
            }
        }, 60000);
        
        // Logo - Family First WebP image
        const LOGO_WEBP = 'data:image/webp;base64,UklGRjQvAABXRUJQVlA4TCgvAAAv/8F/EGph0EiKmF38u344aBVExATwb8cj8wP3Gy8jb7/TybRStDOsJbta6+Nce9qpLvUPfgJgfSo4AhcgYc2mUZ1aONYRYULoY59U1dBKe2KDb70cJ+njwMOlDnhMekMuWwWcAY202ZpyL8jPsdz/v162mwf0iWN4BszMzAzPgpl9ngLT40ieS3LnwPf7+/2+v/+47xobyzQyzMzMcEFlLSjzkYVd3qLM3D4A5q3aI48M6axLriiZL8kyhjPlypAs44gyM3MruQ1nyqiqwhkZea+9a+RZVYER4RxZ7vcBhFxpZBmnIEeWmXtkGMsd15A88sKsKuZwplx5Zblh3LKSGR0Gtiz3qLIL8y7PquOG5BTklDyqrt21jiwz2jpuHwBdGU5UcZeZtywzzEITSU5WR7p0EYEFejCAorRoAklwIwFAmGz4SWlVVnD3VO7utgPulJQcHQNkCkkAAJaRZNu2be/Lo7Vt27a9+7Rtm2ffYG3bZkOLtu24bXOOtMQMopPOBZ6Ah/f+rEgA9uyNc6DvV2/uv6xi9bW6ZHWtJW1x+1XcffpNfZ/ve5/3waY2NA8KrayijOFiHyANZkZmwmlHWJx2gj/lDMvTFPSh0F5YUHWjpotzhOVpaE+SI/TiwlLEc4eghxl7QrM83TPPGYJCF6UnP9vGHFSR6VKhVN7LAcJEt6D0Hh3BE9gTz+gIHtMU2pvOEB70zbKU7eKbM4SG+QI5QFhCw4z+9J4wHSIX6F238CFCoq1tSyrdIf9PC3aAS6kDjAxtdxETJnHCvEkIsm2nbfa/slq2vr5YMmMYDGGqJDGSpEiS+9Qy411SV8/+7FjbttySMvF2l3PK3d3d3d3b3d3d/fT5ZVe9UmGjNYaKcAirB4C7Q9Q7xGECdISdHHfISCuqCAvd3d3dYQis5RLRYckcalWOtqR6BtATQCIdQMdI6LI7wu2tjNUhDrGeqMKaCR7ZEGyvCgkJ3R0mUBLhLlmnnAyLOiWzyAfQDMAtcj0hDnsOaETe/kVo5FnFRUboqf3oF2ITcHeXVtz2MPDMDrEESJJM2+pn27Zt27Zt27Zt27b9bdu27S8xAMC0bf7/JYxmliNDZWYnM2iOsczYf0mQJMltkx0T0K2fDQKL3QH003gKyAEvUAUo4AACQCIoBFWgG4yDWYAGi2AbnIPrWgC6Ym0tOGsGCyf7iybQdQnVIOE3Lwcg23sAMi03CvABWzuwAKGgCHSAb2AV3Bmzo1wl+Araqw8JzIHKmYvlNgAREAIwEAhKwQBYBq/m3PxRtwWKj1kDBDPlqvcCMWAGkkArwObNM/M3OsIN9v+oTLkHQAHUgC+oAL/Bi3kseNoAKAc+L1kopwAIgQzwBtWPAz4sCCse5xKAF5CuK18AaAECZINpcG+BOcqeQVYNoCkfABiAyeeAPxUWqBVfDQpupSHZkwY6IA/8B5AFbg78AzlAO53QAZIgvAk8mhB2gFEQBiSSNoAU6G8SbJkwgs1NAj1AkpgBdMDx7KOYSILbs3/PFhMwgBm4rx68mWCuePW3CxiT7f9jdIKpChPPio97xoakOqYIbLbVaEKaB/29CokTQHCloPHBTFQfDDQA3WySBAiANLBrAgt2Ngz4EyIF4ARmTGz3/D3p5AcQ/RxwaaI7ZjUQTnQA4uv8OIuAYHLvmcQ2xPAp4NAiITgA8YApiQGkWvdhEXEfv/QnSStaFMDBhEXHJmCQoCJYM8AOYCxKngzYZhLS/2cCv2+1aJk6biH5AKhADDi1qAlOTjdw0rmqt+hZf7qBE89Vuf2i8KgBXlnI1wLLWblKwzsOmUDGozO3G8DUkgVukVgfQ7lhZebnSLoY5eqkyIWKiazfpnv/6ScdNoF0ackeM29hzjPMe4ezq3f6ZQPJMumw/n5Qilyaq8dpQvSkpBI74E8WuFtIcLxrB26ZhDHOACzBivmrBd6RWJ3Acj8X5+ikfCQaw+obs+6BQe0IJHNDUJUNebZGnnTH//xenOtRr7OYIACa4KenIeER6CqxiGkCKfZYQ1C2ZPe578C26j6wvciD1C758QX7xZGC7ydKDFEFfcw/ffAcz8jVZUO572HdwQ6yY2jR6viCvKc4zw+500QQRVydN7/wwTGRFVkqqV35B7JDfWDN0mWpcQIr2p1Wp7ofQBf9eDLg+R5ehXxGE1kyH5eP5HnY8U67TkteGE3k88VBloBHNuq0b8CjWM8Yyq+u32Qzbz/Wxpm3b906XR1Degf9ZxX8ao83gGWA+WIUXqV24vpNPuv+z9q5pm6dpXTizY759/El7D7S7wI+teYFFphG1OAJrfmDtbU1v5cNxfcsMIsjBFedMX4TkN6e+WAk1qQJcWPUznkF1txwY9gs6BMnuL3e0f0QSUujuSeGSvMMCCQTI+HBub2kR+y3seUgUeVKU+7/XR1Lu3wLWrIbo2JLdsk3YZP9sanUuePJC7aaa3v3MKA1vzFCBvMMGk0UYretLxhJXnHt5pYLZirJ1MuJ0XJDhhJHoGu7s1EAHsVxRlBrTv3nqDo0BK3LqOk2BPXIOrXAQ2z1fiujxxHBvtv/0izxRTcj6Mzbp9jjMWQmdgr2jhi5haI2aQ61wNXP0UmHHaPpvoftZ20tXAAl6YgBFMGSuSMKrwtd3s2ourPAxii8EfscHChEa6ARxLoba+hPKomJQc346k7cVzfrty8GAaKzUQKwu/soUefYdjLtOjLSbkjmk06xy6ozR4gLLZkjfPCUo9OZtzcj7oyfV7ZGbatTKAFYbDhstbNBhjWz7v+MvGsOtC0UsZ/DRgXA4yqwsK9iYjw2gN6EsbYrMQV+bC0i1NQ7uqqYWpcNofscm+6oBwbR2BEApOZcXpn9jhxIqYsCw1SZCwfKR8Zlw+iWDVUEurFnWMEwEQDINZsDfPBQ6AiPDaSXb6EPHsUGm4Gs+ADrDhfjDDk6rGFDOev+zVJpp8ALHnYu/D0u0EXwuJ+Dts87G8zdY1rQL/C21Em+HxAYNn4SWT35uGfDOfm4i2eUwPuyWxSbAziYZorEhrp1wQa0dpVFoIMNiagDCA3Qeg/+oJJcnXlsRGc//k/YBh+FPpHIXM6KjZsRNQyyMW3JluEVhO9PBPYCrySwa+P2TnvuKjaqR15QoH2forQrBoMa9qn2DBnWsGGddf+lSzQkwA7IyLqC1OqNmVjKTzkd2MDuAG9WASOAUlAAK/hrvGzLt6TLRtbNNxH6dfbduJi0pYyXuIINJCMb22mXcxxtoTuT2oQEyJSYR5mLXO2ywXULHQEcib7enjIuIgVujJVYOj2GDe+063mXgHoFQEPCGBPeiaaTcnsYZuMbztEZ7H9AOmrkm2fMGyeLJh22TAKHYGtS8sBKOHbEuyRTMs/WMBF846Ng87I7Eo3lsz6XVS8zJoRVc78M9ALcBOO4xmks7YNMCpvTCfaVHTcKz3EyCzMx9NIEgL3I/1xWuyqYINYsUwssoBfpn12BdGKSGEjGLtwvyzdG/BzOfgQmittHN1EABW6Cf9WTilzFhLHAFiG0X+nOGZ8/b4w6Jo0vAxxuX/Eusgw2M4429gaZODanM+CLyNdIMtXUYWwMr8g3Mnl847CyAMxByDEJ1ZNxpjFDQZcJpJsuMcAspBTT0G18cQYnlY8sE8nSgToJrg6hTYYgsxTfYJNT1DGZfJkFLnCVSBKEog3c17iIQLdTzkcmlDt8cAdXizhw+AHmqzcuoomqNb8yqQxG4SVcNXLo4ehFvs8XJLBmJxPLS8cVDFw/QjFsdm1cDK9Kj8mlB/d63yfszxYaF36Oh5lghkc3mUAZ8gj0iVbMRbrIXSaZbmqXgTWlnijcdQVKxkTuL85kM0dHsLb0A4S6qghYNCbGm4YJ5xawwRRbDHNNoZc1JopcyaTz/WCjaepCBOQaE0WeZuK5mG1xqhAjDYyJ0oFjJvJl5+EtJ9nBRJFnmKl8Od83C20x2Wbud1D4GZqHCesOTcZDvmn47Erf19MU1A127Wq8gbrxh12HFGaY4yFd4kxIgSKQuXD2KdhaPdNcg0tJXKCOhPqthbKHUD9jYURVhpmUhoGykN9x2DCoZooz8JiYehcTEKvD2EDOWIgmyp1MTi+9WUCsCWH7yBILh+9mghr8AEwK8q393zy2iifCeMr5xCR1B0w1clXWd56X5/MFhzJRfdlJAuHpPOdSGlk4kcnqH2EmePu9a3maZyeRDIUzYYVpSRs87TOb5BlwcCmLCxN+2KTPSWMYBzFksYZJ6xu7BMIj+psyynOybBPfkl2ZuG4XZDDFl1T6yv2y3L0p7pm8NoZ1CGT3Mp4CEMbBs1lROpehfKOf2UKtnQM/j0xiQfqR1g5ofKSV5Q4ejdkO8gJaPWRElhQAA+';

        // App Configuration
        const appConfig = {
            version: "2.1.0",
            lastUpdated: "2025-09-11",
            companyName: "Aftercare Planning Services",
            openaiApiKey: "sk-proj-123", // This is a placeholder - the tool will use AllOrigins proxy instead
            features: {
                enableDarkMode: true,
                enableAnalytics: false,
                enableAutoSave: true,
                sessionTimeout: 1800000, // 30 minutes
                maxDocumentHistory: 10
            }
        };

        // Program database metadata
        const programDatabase = {
            version: "2.0.0",
            lastUpdated: "2025-09-11",
            totalPrograms: 40
        };        // Complete program database from PROGRAMS.md
        const programs = [
            {
                id: 'program_1',
                name: 'Charlie Health Virtual IOP Program',
                location: 'Virtual',
                type: 'Virtual Program',
                category: 'virtual',
                programCategory: 'Virtual / Outpatient Programs',
                levelOfCare: 'Virtual Intensive Outpatient Program (IOP) for adolescents and young adults ages 1325 in need of structured, higher-acuity mental health care from home. The program typically runs for 610 weeks and includes 911 hours of treatment per week via secure video conferencing.',
                features: [
                    'Group Therapy: 3 hours of therapy 3 times per week focused on connection, skill-building, and peer support.',
                    'Individual Therapy: Weekly 1-hour individual session tailored to personal goals and challenges.',
                    'Family Therapy: 12 hours per week involving family members to improve communication and support healing.',
                    'Psychiatry Services: Psychiatric assessment and medication management as needed.',
                    'Flexible Scheduling: Evening sessions available to accommodate school or extracurricular commitments.',
                    'Accessible Virtual Format: Services can be accessed via computer, tablet, or phone.',
                ],
                contact: {
                    contactPerson: 'Gabriella H.',
                    phone: '561.203.5396',
                    website: 'https://www.charliehealth.com'
                }
            },
            {
                id: 'program_2',
                name: 'The Last House',
                location: 'Los Angeles, CA',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Sober living program for young adult men (18+) located in West Los Angeles. Offers a structured, fun, and community-driven environment for individuals transitioning out of treatment and into long-term recovery.',
                features: [
                    'Community-Oriented Housing: Residents live in structured homes with support from peers and staff.',
                    'Certified Staff: Team includes professionals with backgrounds in counseling, employment services, and wellness.',
                    'Life in LA Recovery Community: Access to over 3,000 recovery meetings weekly and one of the strongest sober communities in the country.',
                    'Fun in Sobriety Philosophy: Weekly and quarterly sober activities including group outings, surfing, golf, snowboarding, and more.',
                    'Accountability: House meetings, curfews, and community support help residents stay on track with recovery.',
                ],
                contact: {
                    phone: '866.677.0090',
                    address: '3101 Ocean Park Blvd #302, Santa Monica, CA 90405',
                    website: 'https://thelasthouse.net'
                }
            },
            {
                id: 'program_3',
                name: 'Patton Sober Living Homes',
                location: 'Dallas, TX',
                type: 'Sober Living',
                category: 'sober-living',
                programCategory: 'Sober Living / Transitional Programs',
                levelOfCare: 'Structured sober living program for young adult men in Dallas, Texas, offering accountability, life skills development, and peer support during the early stages of recovery. Emphasizes holistic healing of mind, body, and spirit, with a focus on employment, education, and 12-Step community involvement.',
                features: [
                    'Random Drug Testing: Residents are drug tested randomly at least once weekly and breathalyzed daily. Testing increases if relapse concerns arise.',
                    'Community & House Meetings: Three structured group meetings per week, led by licensed clinicians and members of the recovery community.',
                    'Employment Coaching: Residents receive assistance with job placement, resume building, and interview preparation. A minimum of 25 work hours per week is expected unless enrolled in school.',
                    'Educational Support: Located near Richland College. Founder John Patton personally supports residents in enrolling and succeeding academically.',
                    'Independent Living Skills: Daily chores, cooking, laundry, and personal care responsibilities foster autonomy and life readiness.',
                    '12-Step Integration: Active participation in a 12-Step program, including step work, sponsor communication, and attending at least four meetings per week.',
                    'Family Communication: Biweekly calls from the Program Director and ongoing access to the owner and staff for urgent updates or support.',
                ],
                contact: {
                    contactPerson: 'Austin Shook, Program Director',
                    phone: '(469) 974-4639',
                    address: '13028 Fall Manor Dr, Dallas, TX 75243',
                    website: 'https://pattonsoberliving.com/index.html'
                }
            },
            {
                id: 'program_4',
                name: 'Stonewater Adolescent Recovery Center',
                location: 'Oxford, MS',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Residential treatment center for adolescent males with substance use and co-occurring mental health disorders. Offers fully supervised detox, dual-diagnosis programming, and individualized care grounded in faith, family restoration, and evidence-based interventions.',
                features: [
                    'Dual-Diagnosis Expertise: Clinical program designed specifically for the evolving needs of adolescents, incorporating psychiatric, psychological, and addiction-specific care.',
                    'Detox to Residential Continuum: Safe, medically supervised detox followed by structured residential treatment in a campus setting.',
                    'Family Restoration Focus: Programming emphasizes rebuilding relationships and empowering the family system with healthy tools and communication strategies.',
                    'Faith-Informed Recovery: For families who desire it, Christian values and faith-based elements are integrated into the healing process.',
                    'Individualized Treatment Plans: Residents receive customized care designed to uncover strengths, passions, and long-term potential.',
                    'Founders with Lived Experience: The Fikes family brings personal understanding of adolescent substance use and family crisis to the programs design and mission.',
                ],
                contact: {
                    contactPerson: 'Bridget Norris',
                    phone: '570) 222-3449',
                    address: '21 Weida Ct Nicholson, PA 18446',
                    website: 'info@serenitylodgerecovery.com'
                }
            },
            {
                id: 'program_5',
                name: 'Resilience Recovery Residences',
                location: 'West Palm Beach, FL',
                type: 'Sober Living',
                category: 'sober-living',
                programCategory: 'Sober Living / Transitional Programs',
                levelOfCare: 'Structured transitional living program for young adult men ages 16+ who have completed primary treatment and are prepared to reintegrate into society through a phased, milestone-based recovery structure.',
                features: [
                    'Orientation Phase (24 Weeks): Daily chores, wake-up routines, seven 12-step meetings per week, and sponsor acquisition.',
                    'Level 1 (1490 Days): Six 12-step meetings/week, one meeting commitment, 9+ hours of IOP or therapy, and step work initiation.',
                    'Level 2 (60120 Days): Completion of Step 5, increased leadership in community, and continuation of meetings, therapy, and responsibilities.',
                    'Level 3 (120+ Days): Step 9 completion, leadership role in the house, reduced meeting requirements, full tech privileges and car access.',
                ],
                contact: {
                    contactPerson: 'Christopher Martinez/ Owner',
                    phone: '424- 254-4304',
                    address: '3011 Poinsettia Ave, West Palm Beach, FL 33407',
                    website: 'www.resiliencerecoveryresources.com'
                }
            },
            {
                id: 'program_6',
                name: 'The Insight Program',
                location: 'Tampa, FL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Intensive outpatient substance use treatment program for adolescents (1317) and young adults (1825) with substance abuse or co-occurring issues. Offers family-focused treatment and long-term aftercare.',
                features: [
                    'Free Evaluations: No-cost substance use evaluations for clients and families.',
                    'Weekly IOP Sessions: Five treatment sessions per week including individualized planning.',
                    '12-Step Meetings: Weekly youth-focused 12-step support.',
                    'Family Integration: Weekly family counseling, support, and educational resources.',
                    'Two-Year Aftercare: Includes follow-up counseling, group access, and family involvement.',
                    'School & Community Engagements: Education on youth substance use at local schools and churches.',
                ],
                contact: {
                    contactPerson: 'Adam Schwartz',
                    phone: '470-505-9786',
                    address: '13944 Lynmar Blvd, Tampa, FL 33626',
                    website: 'https://theinsightprogram.com/'
                }
            },
            {
                id: 'program_7',
                name: 'Turnbridge Residential',
                location: 'New Haven, CT',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Long-term residential program for young adults with substance use and co-occurring disorders. Integrates identity development, purpose-building, and therapeutic structure through a phased model.',
                features: [
                    'Phase I: Mental Health & Addiction Treatment  Structured therapy, recreation, wellness activities, and medication management.',
                    'Phase II: Life Skills & Planning  Residents pursue education, employment readiness, and learn independent living routines.',
                    'Phase III: Sober Living  Clients begin college, work, or volunteer activities while maintaining clinical support and accountability.',
                ],
                contact: {
                    contactPerson: 'Beth Legacki',
                    phone: '512.921.3533',
                    email: 'blegacki@turnbridge.com',
                    address: '189 Orange Street, New Haven, CT 06510',
                    website: 'www.turnbridge.com'
                }
            },
            {
                id: 'program_8',
                name: 'Greater Nashua Mental Health',
                location: 'Nashua, NH',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Adolescent Intensive Outpatient Program (IOP) for teens with substance use and co-occurring disorders. May accept young adults (18+) depending on clinical assessment.',
                features: [
                    'IOP Structure: Group therapy, individual therapy, family involvement, and case management.',
                    'Psychiatric Services: Access to in-house or referred psychiatric practitioners.',
                    'Whole-Person Coordination: Includes collaboration with schools, doctors, and service providers.',
                    'Recovery Coaching: Helps adolescents connect with long-term recovery resources and aftercare.',
                ],
                contact: {
                    phone: '603.401.1597',
                    address: '15 Prospect Street, Nashua, NH 03060',
                    website: 'https://gnmhc.org/'
                }
            },
            {
                id: 'program_9',
                name: 'Directions Behavioral Health',
                location: 'Nashua, NH',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Outpatient and partial hospitalization program (PHP) serving teens and young adults facing acute mental health or substance use challenges. Flexible structure and daily therapeutic support.',
                features: [
                    'Intensive Outpatient Program (IOP): 3 hours per day of group therapy and psychiatric services.',
                    'Partial Hospitalization Program (PHP): 5 hours per day of clinical programming, step-down to IOP available.',
                    'Family Work: Ongoing parent engagement and clinical involvement.',
                    'Insurance Accepted: Covered by most commercial health plans.',
                ],
                contact: {
                    phone: '603.880.8188',
                    address: '25 Technology Way, Nashua, NH 03060',
                    website: 'https://www.directionbehavioralhealth.com/'
                }
            },
            {
                id: 'program_10',
                name: 'In Balance Academy',
                location: 'Tucson, AZ',
                type: 'Therapeutic Boarding School',
                category: 'therapeutic-school',
                programCategory: 'Therapeutic Schools',
                levelOfCare: 'Therapeutic boarding school for adolescent males combining recovery, academics, and character development in a supportive, values-driven environment.',
                features: [
                    'Individualized Academics: Accredited education aligned with each students strengths and needs.',
                    'Family Systems Focus: Therapy and education to rebuild and strengthen family relationships.',
                    'Service-Oriented Culture: Students engage in acts of service to foster connection and responsibility.',
                    'Staff Mentorship: Clinicians and mentors help students identify purpose and build confidence.',
                    'Emphasis on Community: Shared goals and daily rituals promote peer accountability and resilience.',
                ],
                contact: {
                    contactPerson: 'Tiffany  Director of Admissions and Clinical Director',
                    phone: '801.369.0238',
                    email: 'ptaylor@livestronghouse.com',
                    address: '195 25th Street, Suite 300, Ogden, UT 84401',
                    website: 'www.crossroadsrtc.com'
                }
            },
            {
                id: 'program_11',
                name: 'Live Strong House',
                location: 'Layton, UT',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Residential treatment program for adolescent and young adult males, offering a relationship-based, highly individualized therapeutic model rooted in adventure, service, and personal growth.',
                features: [
                    '3:1 Household Model: Three students per home with dedicated life coaches for personalized attention and deep mentorship.',
                    'Daily Life Structure: Flexible weekday and weekend schedules with a balance of academics, therapy, and recreation.',
                    'Individual Therapy: Multiple sessions per week with therapists who maintain small caseloads.',
                    'Group Therapy: Topics include trauma, social skills, communication, and emotional resilience.',
                    'Adventure Therapy: Two recreation days per week featuring activities like hiking, snowboarding, mountain biking, and climbing.',
                    'Community Leadership: Weekly student-led group meetings to promote accountability and empathy.',
                    'Monthly Excursions: Wilderness and off-campus trips to challenge students outside their comfort zones.',
                    'Weekly Service: Built-in humanitarian service opportunities for character development.',
                ],
                contact: {
                    contactPerson: 'Paul Taylor',
                    phone: '928.300.5699',
                    email: 'ptaylor@livestronghouse.com',
                    address: '377 N. Marshall Way, Layton, UT 84041',
                    website: 'www.livestronghouse.com'
                }
            },
            {
                id: 'program_12',
                name: 'Turning Winds',
                location: 'Troy, MT',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Residential treatment center and therapeutic boarding school for adolescents ages 1318, providing long-term treatment for mental health, behavioral, and substance use disorders.',
                features: [
                    'Small Community: Maximum of 45 students with average stay of 12 months.',
                    'Comprehensive Diagnosis: Addresses ADHD, depression, anxiety, substance use, eating disorders, ODD, and more.',
                    '5 Pillars of Change: Character, health, outdoor education, therapeutic success, and academic achievement.',
                    'Outdoor Adventure Therapy: Wilderness-based experiential education and team-building.',
                    'Clinical Services: Individual, group, and family therapy tailored to each students diagnostic profile.',
                    'Accredited Academics: IEP support, academic recovery, and personalized education from certified teachers.',
                ],
                contact: {
                    contactPerson: 'Eric Losche  Admission Director',
                    phone: '973.650.8636',
                    address: '31733 S Fork Yaak Rd, Troy, MT 59935',
                    website: 'https://www.turningwinds.com/'
                }
            },
            {
                id: 'program_13',
                name: 'Crossroads Academy',
                location: 'Ogden, UT',
                type: 'Therapeutic Boarding School',
                category: 'therapeutic-school',
                programCategory: 'Therapeutic Schools',
                levelOfCare: 'Therapeutic program and recovery residence for adolescent boys ages 1418 struggling with substance use and co-occurring disorders. Emphasizes relational healing, autonomy, and purpose-driven living.',
                features: [
                    'Individual Therapy: Weekly 1:1 sessions held in informal and natural environments to build trust and openness.',
                    'Group Therapy: Peer process groups offering shared stories, emotional support, and accountability.',
                    'Family Therapy: Weekly sessions, reading assignments, and coordination with home therapists.',
                    'Recovery Work: 3 hours per week of direct substance use counseling and relapse prevention.',
                    'Academic Planning: Credit recovery, individualized learning plans, and transition-focused education.',
                    'Holistic Focus: Incorporates outdoor recreation, mentorship, and structured freedoms to promote responsibility.',
                ],
                contact: {
                    contactPerson: 'Sam Dahlin  Co-Owner & Admissions Director',
                    phone: '801.369.0238',
                    address: '195 25th Street, Suite 300, Ogden, UT 84401',
                    website: 'www.crossroadsrtc.com'
                }
            },
            {
                id: 'program_14',
                name: 'Mountain Springs Preparatory Academy',
                location: 'Cedar City, UT',
                type: 'Therapeutic Boarding School',
                category: 'therapeutic-school',
                programCategory: 'Therapeutic Schools',
                levelOfCare: 'Step-down boarding school designed for teens transitioning from higher levels of care (RTC, TBS, wilderness). Offers a structured environment to reinforce independence, accountability, and future readiness.',
                features: [
                    'Real-Life Practice: Co-ed milieu, community jobs, and unsupervised outings for advanced readiness.',
                    'Solution-Focused Mentoring: Emphasizes learning from natural consequences over punitive models.',
                    'Individualized MAPP Plans: Custom goals across academic, personal, family, and future domains.',
                    'Parental Reengagement: Empowers families to re-take the parenting role with structured support.',
                    'College & Career Prep: Emphasis on forward planning while maintaining clinical wraparound care.',
                ],
                contact: {
                    contactPerson: 'Shawnale Wilson  Admissions Director',
                    phone: '435.592.3220',
                    email: 'swilson@mountainspringsprep.com',
                    address: '1454 S Campus Dr, Cedar City, UT 84720'
                }
            },
            {
                id: 'program_15',
                name: 'The Grove School',
                location: 'Madison, CT',
                type: 'Therapeutic Boarding School',
                category: 'therapeutic-school',
                programCategory: 'Therapeutic Schools',
                levelOfCare: 'Therapeutic boarding and day school for adolescents ages 1118, blending clinical support, academic advancement, and residential structure in a holistic, family-run environment.',
                features: [
                    'Individualized Treatment: Comprehensive support for behavioral, academic, emotional, and social challenges.',
                    'Year-Round Education: 12-month academic schedule with four 2-week breaks.',
                    'Holistic Model: Clinical therapy, residential life, and extracurriculars reinforce whole-person wellness.',
                    'Academic Supports: Small classes, individualized learning, special education faculty, and high standards.',
                    'Long-Term Planning: Prepares students for healthy transition into adulthood and sustained success.',
                ],
                contact: {
                    phone: '203.245.2778',
                    address: '175 Copse Rd, Madison, CT 06443',
                    website: 'http://www.groveschool.org/'
                }
            },
            {
                id: 'program_16',
                name: 'Discovery Mood & Anxiety',
                location: 'Dade City, FL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Residential and PHP programs for adolescents ages 1117 struggling with depression, anxiety, trauma, and co-occurring issues. Structured environment with family-focused care.',
                features: [
                    'Residential Treatment: 24/7 therapeutic support in home-like setting.',
                    'PHP: Day program with therapy, group, and academic support.',
                    'CBT, DBT & Experiential Therapy: Weekly evidence-based individual and group sessions.',
                    'Psychiatric Oversight: Medication management and evaluation.',
                    'Family Integration: Weekly therapy and support groups.',
                ],
                contact: {
                    phone: '(954) 825-9887',
                    address: 'Dade City, FL',
                    website: 'www.discoverymood.com'
                }
            },
            {
                id: 'program_17',
                name: 'Discovery Mood & Anxiety',
                location: 'Maitland, FL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'PHP and IOP services for adolescents ages 1117. Flexible in-person programming near Orlando designed to support school-aged clients.',
                features: [
                    'PHP: Structured day program with therapy and academics.',
                    'IOP: Afternoon programming for step-down or less acute needs.',
                    'Virtual Services: Optional for teens transitioning home.',
                    'Psychiatric Services: Medication and evaluation included.',
                    'Family Therapy: In-person and virtual family participation encouraged.',
                ],
                contact: {
                    phone: '(954) 825-9887',
                    address: 'Maitland, FL',
                    website: 'www.discoverymood.com'
                }
            },
            {
                id: 'program_18',
                name: 'Discovery Mood & Anxiety',
                location: 'Tampa-Orlando Region, FL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Boarded Partial Hospitalization Program (PHP) and Residential Treatment for teens with mood and anxiety disorders. Structured support for transition or crisis stabilization.',
                features: [
                    'Residential: On-site housing and 24/7 support.',
                    'PHP: Intensive therapeutic programming with educational components.',
                    'Specialized Tracks: Trauma, anxiety, and co-occurring presentations.',
                    'Family Involvement: Required family therapy and parent support groups.',
                    'Psychiatric & Medical Care: On-site assessments and medication management.',
                ],
                contact: {
                    phone: '(954) 825-9887',
                    address: 'Tampa-Orlando Region, FL',
                    website: 'www.discoverymood.com'
                }
            },
            {
                id: 'program_19',
                name: 'Discovery Mood & Anxiety',
                location: 'Virtual PHP/IOP (Florida)',
                type: 'Virtual Program',
                category: 'virtual',
                programCategory: 'Virtual / Outpatient Programs',
                levelOfCare: 'Secure, HIPAA-compliant virtual programming for adolescents ages 1117 needing continued therapeutic care while living at home. Serves as either step-down from residential or stand-alone support.',
                features: [
                    'PHP & IOP: Multiple weekly sessions tailored to teen availability.',
                    'Virtual Individual, Group, and Family Therapy: Real-time treatment with licensed clinicians.',
                    'Psychiatric Oversight: Medication management and remote evaluations.',
                    'Parent Involvement: Integrated family sessions and check-ins.',
                    'School Coordination: Adjusted schedules to accommodate academic needs.',
                ],
                contact: {
                    phone: '(954) 825-9887',
                    address: 'Statewide Florida Access',
                    website: 'www.discoverymood.com'
                }
            },
            {
                id: 'program_20',
                name: 'Friendship Circle',
                location: 'Teen Scene (Fort Lauderdale, FL)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Social engagement group for teens with special needs. Peer-driven and mentor-supported program offering community, fun, and confidence-building.',
                features: [
                    'Teen Scene: Bi-monthly Sunday meetups.',
                    'Mentor Pairings: Teen volunteers partner with participants.',
                    'Social Skill Building: Structured, supportive interactions.',
                    'Parent Engagement: \'Mom\'s Night Out\' community events.',
                ],
                contact: {
                    phone: '754.800.1770',
                    website: 'https://friendshipfl.org/'
                }
            },
            {
                id: 'program_21',
                name: 'Friendship Circle',
                location: 'Hallandale, FL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Community-based social and recreational program for children and teens with developmental disabilities, paired with teen volunteers.',
                features: [
                    'Inclusive Activities: Monthly meetups, crafts, sports, and games.',
                    'One-on-One Friendships: Peer matching for personal growth.',
                    'Parent Support: Occasional gatherings and resources.',
                ],
                contact: {
                    address: 'Hallandale Beach, FL',
                    website: 'https://www.friendshipcirclehallandale.org/'
                }
            },
            {
                id: 'program_22',
                name: 'Friendship Circle',
                location: 'Parkland/North Broward, FL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Friendship-based programming for teens with special needs focused on belonging, social development, and Jewish community identity.',
                features: [
                    'Volunteer-Led Hangouts: Supervised by program directors.',
                    'Jewish Holiday Events: Faith-aligned community building.',
                    'Community Integration: Inclusive Shabbat dinners and more.',
                ],
                contact: {
                    address: 'Parkland, FL',
                    website: 'https://www.fcpb.org/'
                }
            },
            {
                id: 'program_23',
                name: 'Friendship Circle',
                location: 'Miami (Chabad of Kendall/Pinecrest)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Teen social group and family community programming rooted in Jewish values and inclusion. Open to all backgrounds.',
                features: [
                    'Weekly Gatherings: Social groups and mentorship pairings.',
                    'Sensory Events: Music, art, games designed for accessibility.',
                    'Family Support: Educational and holiday family programming.',
                ],
                contact: {
                    address: 'Miami, FL',
                    website: 'https://friendshipcirclemiami.org/'
                }
            },
            {
                id: 'program_24',
                name: 'Maple Hall Academy',
                location: 'Lexington, VA',
                type: 'Therapeutic Boarding School',
                category: 'therapeutic-school',
                programCategory: 'Therapeutic Schools',
                levelOfCare: 'Therapeutic boarding school for students in grades 59 with emotional, social, academic, and behavioral challenges. Located on a scenic, activity-rich campus in Virginia.',
                features: [
                    'Therapeutic Curriculum: Integrates clinical, academic, and social-emotional learning.',
                    'Expressive Arts Therapy: Ceramics, equine, and creative expression activities.',
                    'Individualized Academics: Personalized college-prep instruction.',
                    'Community Involvement: Encourages family and school reintegration.',
                ],
                contact: {
                    contactPerson: 'Chass Armstrong  Executive Director',
                    phone: '828.747.9294',
                    address: '3111 N Lee Hwy, Lexington, VA 24450',
                    website: 'https://maplehallacademy.com/'
                }
            },
            {
                id: 'program_25',
                name: 'Black Mountain Academy',
                location: 'Black Mountain, NC',
                type: 'Therapeutic Boarding School',
                category: 'therapeutic-school',
                programCategory: 'Therapeutic Schools',
                levelOfCare: 'Therapeutic boarding school for adolescent males (ages 1317) with Level 1 autism and co-occurring challenges in academics, executive functioning, and social communication.',
                features: [
                    'Inquiry-Based Academics: Rigorous curriculum adapted for learning differences.',
                    'Six Core Competencies: Focuses on social skills, wellness, executive functioning, independence, academics, and emotional regulation.',
                    'Real-World Preparation: Includes financial literacy, hygiene routines, and community skills.',
                    'Autism-Specific Supports: Integrated emotional regulation and conflict resolution strategies.',
                ],
                contact: {
                    phone: '828.243.6165',
                    address: 'PO Box 1236, Black Mountain, NC 28711',
                    website: 'www.theblackmountainacademy.com'
                }
            },
            {
                id: 'program_26',
                name: 'AANE (Association for Autism and Neurodiversity)',
                location: 'Virtual',
                type: 'Virtual Program',
                category: 'virtual',
                programCategory: 'Virtual / Outpatient Programs',
                levelOfCare: 'Virtual services for adolescents and families with autism spectrum disorders, including support groups, coaching, and resource connections.',
                features: [
                    'Parent & Family Consultation: Calls with resource specialists.',
                    'Peer Connections: Virtual social groups and events.',
                    'Advocacy & Resources: Tools to navigate school and clinical systems.',
                ],
                contact: {
                    website: 'https://aane.org/'
                }
            },
            {
                id: 'program_27',
                name: 'Bend Health',
                location: 'Virtual ASD Services',
                type: 'Virtual Program',
                category: 'virtual',
                programCategory: 'Virtual / Outpatient Programs',
                levelOfCare: 'Fully virtual platform offering behavioral health coaching and therapy for children and adolescents, with specific supports for those with autism spectrum disorder.',
                features: [
                    'Individual Coaching: Ongoing virtual sessions for ASD youth.',
                    'Parent Coaching: Training and education for caregivers.',
                    'Online Accessibility: Secure, convenient platform for remote engagement.',
                ],
                contact: {
                    phone: '828.243.6165',
                    address: 'PO Box 1236, Black Mountain, NC 28711',
                    website: 'www.theblackmountainacademy.com'
                }
            },
            {
                id: 'program_28',
                name: 'High Focus Treatment Centers',
                location: 'Cherry Hill, NJ',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Adolescent PHP and IOP programs for ages 1018 with psychiatric and therapeutic services designed to meet varying levels of acuity. All centers emphasize DBT skill-building and offer flexible scheduling for school-aged clients.',
                features: [
                    'PHP: Full-day structured care with integrated academic support.',
                    'IOP: After-school mental health support including group therapy and psychiatry.',
                    'Weekly Psychiatry: Clients receive weekly psychiatric oversight.',
                    'DBT-Focused: DBT skills taught for emotional regulation, distress tolerance, and interpersonal effectiveness.',
                ],
                contact: {
                    email: 'aszuminski@highfocuscenters.com',
                    address: 'Cherry Hill, NJ, NJ',
                    website: 'https://www.highfocuscenters.com/'
                }
            },
            {
                id: 'program_29',
                name: 'High Focus Treatment Centers',
                location: 'Branchburg, NJ',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Adolescent PHP and IOP programs for ages 1018 with psychiatric and therapeutic services designed to meet varying levels of acuity. All centers emphasize DBT skill-building and offer flexible scheduling for school-aged clients.',
                features: [
                    'PHP: Full-day structured care with integrated academic support.',
                    'IOP: After-school mental health support including group therapy and psychiatry.',
                    'Weekly Psychiatry: Clients receive weekly psychiatric oversight.',
                    'DBT-Focused: DBT skills taught for emotional regulation, distress tolerance, and interpersonal effectiveness.',
                ],
                contact: {
                    phone: 'N/A',
                    address: 'Branchburg, NJ, NJ',
                    website: 'https://www.highfocuscenters.com/'
                }
            },
            {
                id: 'program_30',
                name: 'High Focus Treatment Centers',
                location: 'Lawrenceville, NJ',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Adolescent PHP and IOP programs for ages 1018 with psychiatric and therapeutic services designed to meet varying levels of acuity. All centers emphasize DBT skill-building and offer flexible scheduling for school-aged clients.',
                features: [
                    'PHP: Full-day structured care with integrated academic support.',
                    'IOP: After-school mental health support including group therapy and psychiatry.',
                    'Weekly Psychiatry: Clients receive weekly psychiatric oversight.',
                    'DBT-Focused: DBT skills taught for emotional regulation, distress tolerance, and interpersonal effectiveness.',
                ],
                contact: {
                    phone: 'N/A',
                    address: 'Lawrenceville, NJ, NJ',
                    website: 'https://www.highfocuscenters.com/'
                }
            },
            {
                id: 'program_31',
                name: 'High Focus Treatment Centers',
                location: 'Parsippany, NJ',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Adolescent PHP and IOP programs for ages 1018 with psychiatric and therapeutic services designed to meet varying levels of acuity. All centers emphasize DBT skill-building and offer flexible scheduling for school-aged clients.',
                features: [
                    'PHP: Full-day structured care with integrated academic support.',
                    'IOP: After-school mental health support including group therapy and psychiatry.',
                    'Weekly Psychiatry: Clients receive weekly psychiatric oversight.',
                    'DBT-Focused: DBT skills taught for emotional regulation, distress tolerance, and interpersonal effectiveness.',
                ],
                contact: {
                    phone: 'N/A',
                    address: 'Parsippany, NJ, NJ',
                    website: 'https://www.highfocuscenters.com/'
                }
            },
            {
                id: 'program_32',
                name: 'Rosecrance',
                location: 'Frankfort, IL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Outpatient and/or residential substance use and mental health treatment for adolescents, depending on the site.',
                features: [
                    'IOP Services: Structured programming while teens reside at home.',
                    'PHP or Residential (site-dependent): Full-day or on-site therapeutic living.',
                    'Family-Focused Treatment: Includes group, individual, and family therapy.',
                    'Recovery Education: Skills training, relapse prevention, and peer support.',
                ],
                contact: {
                    phone: '815.391.1000',
                    address: 'Frankfort, IL, IL',
                    website: 'https://rosecrance.org/'
                }
            },
            {
                id: 'program_33',
                name: 'Rosecrance',
                location: 'Chicago, IL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Outpatient and/or residential substance use and mental health treatment for adolescents, depending on the site.',
                features: [
                    'IOP Services: Structured programming while teens reside at home.',
                    'PHP or Residential (site-dependent): Full-day or on-site therapeutic living.',
                    'Family-Focused Treatment: Includes group, individual, and family therapy.',
                    'Recovery Education: Skills training, relapse prevention, and peer support.',
                ],
                contact: {
                    phone: '815.391.1000',
                    address: 'Chicago, IL, IL',
                    website: 'https://rosecrance.org/'
                }
            },
            {
                id: 'program_34',
                name: 'Rosecrance',
                location: 'McHenry County, IL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Outpatient and/or residential substance use and mental health treatment for adolescents, depending on the site.',
                features: [
                    'IOP Services: Structured programming while teens reside at home.',
                    'PHP or Residential (site-dependent): Full-day or on-site therapeutic living.',
                    'Family-Focused Treatment: Includes group, individual, and family therapy.',
                    'Recovery Education: Skills training, relapse prevention, and peer support.',
                ],
                contact: {
                    phone: '815.391.1000',
                    address: 'McHenry County, IL, IL',
                    website: 'https://rosecrance.org/'
                }
            },
            {
                id: 'program_35',
                name: 'Rosecrance Griffin-Williamson Campus',
                location: 'Rockford, IL',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Outpatient and/or residential substance use and mental health treatment for adolescents, depending on the site.',
                features: [
                    'IOP Services: Structured programming while teens reside at home.',
                    'PHP or Residential (site-dependent): Full-day or on-site therapeutic living.',
                    'Family-Focused Treatment: Includes group, individual, and family therapy.',
                    'Recovery Education: Skills training, relapse prevention, and peer support.',
                ],
                contact: {
                    phone: '815.391.1000',
                    address: 'Rockford, IL, IL',
                    website: 'https://rosecrance.org/'
                }
            },
            {
                id: 'program_36',
                name: 'Sheppard Pratt',
                location: 'Special Education Day School (Glyndon, MD)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.',
                features: [
                    'Full-Day School: Licensed academic and behavioral day program.',
                    'IEP-Based Instruction: Individualized supports aligned to school district goals.',
                    'Clinical Oversight: On-site behavioral and therapeutic staff.',
                    'Community Integration: Transition-focused services and parent collaboration.',
                ],
                contact: {
                    address: 'Glyndon, MD, MD',
                    website: 'https://www.sheppardpratt.org/'
                }
            },
            {
                id: 'program_37',
                name: 'Sheppard Pratt',
                location: 'Special Education Day School (Hunt Valley, MD)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.',
                features: [
                    'Full-Day School: Licensed academic and behavioral day program.',
                    'IEP-Based Instruction: Individualized supports aligned to school district goals.',
                    'Clinical Oversight: On-site behavioral and therapeutic staff.',
                    'Community Integration: Transition-focused services and parent collaboration.',
                ],
                contact: {
                    address: 'Hunt Valley, MD, MD',
                    website: 'https://www.sheppardpratt.org/'
                }
            },
            {
                id: 'program_38',
                name: 'Sheppard Pratt',
                location: 'Special Education Day School (Gaithersburg, MD)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.',
                features: [
                    'Full-Day School: Licensed academic and behavioral day program.',
                    'IEP-Based Instruction: Individualized supports aligned to school district goals.',
                    'Clinical Oversight: On-site behavioral and therapeutic staff.',
                    'Community Integration: Transition-focused services and parent collaboration.',
                ],
                contact: {
                    address: 'Gaithersburg, MD, MD',
                    website: 'https://www.sheppardpratt.org/'
                }
            },
            {
                id: 'program_39',
                name: 'Sheppard Pratt',
                location: 'Special Education Day School (Cumberland, MD)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.',
                features: [
                    'Full-Day School: Licensed academic and behavioral day program.',
                    'IEP-Based Instruction: Individualized supports aligned to school district goals.',
                    'Clinical Oversight: On-site behavioral and therapeutic staff.',
                    'Community Integration: Transition-focused services and parent collaboration.',
                ],
                contact: {
                    address: 'Cumberland, MD, MD',
                    website: 'https://www.sheppardpratt.org/'
                }
            },
            {
                id: 'program_40',
                name: 'Sheppard Pratt',
                location: 'Special Education Day School (Frederick, MD)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.',
                features: [
                    'Full-Day School: Licensed academic and behavioral day program.',
                    'IEP-Based Instruction: Individualized supports aligned to school district goals.',
                    'Clinical Oversight: On-site behavioral and therapeutic staff.',
                    'Community Integration: Transition-focused services and parent collaboration.',
                ],
                contact: {
                    address: 'Frederick, MD, MD',
                    website: 'https://www.sheppardpratt.org/'
                }
            },
            {
                id: 'program_41',
                name: 'Sheppard Pratt',
                location: 'Special Education Day School (Lanham, MD)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.',
                features: [
                    'Full-Day School: Licensed academic and behavioral day program.',
                    'IEP-Based Instruction: Individualized supports aligned to school district goals.',
                    'Clinical Oversight: On-site behavioral and therapeutic staff.',
                    'Community Integration: Transition-focused services and parent collaboration.',
                ],
                contact: {
                    address: 'Lanham, MD, MD',
                    website: 'https://www.sheppardpratt.org/'
                }
            },
            {
                id: 'program_42',
                name: 'Sheppard Pratt',
                location: 'Special Education Day School (Millersville, MD)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.',
                features: [
                    'Full-Day School: Licensed academic and behavioral day program.',
                    'IEP-Based Instruction: Individualized supports aligned to school district goals.',
                    'Clinical Oversight: On-site behavioral and therapeutic staff.',
                    'Community Integration: Transition-focused services and parent collaboration.',
                ],
                contact: {
                    address: 'Millersville, MD, MD',
                    website: 'https://www.sheppardpratt.org/'
                }
            },
            {
                id: 'program_43',
                name: 'Sheppard Pratt',
                location: 'Special Education Day School (Rockville, MD)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.',
                features: [
                    'Full-Day School: Licensed academic and behavioral day program.',
                    'IEP-Based Instruction: Individualized supports aligned to school district goals.',
                    'Clinical Oversight: On-site behavioral and therapeutic staff.',
                    'Community Integration: Transition-focused services and parent collaboration.',
                ],
                contact: {
                    address: 'Rockville, MD, MD',
                    website: 'https://www.sheppardpratt.org/'
                }
            },
            {
                id: 'program_44',
                name: 'Innercept',
                location: 'Coeur dAlene, ID (Permanently Closed)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Previously a long-term residential program for adolescents with complex psychiatric and emotional needs.',
                features: [
                    'This program is no longer operating.',
                    'Former services included integrated education, family therapy, and goal-based psychiatric care.',
                ],
                contact: {
                    contactPerson: 'CJ - 801-227.2062',
                    phone: '678-506-7429',
                    email: 'info@360coachingservice.com',
                    address: '252 Harry Lane Blvd, Suite 202, Knoxville, TN 37923',
                    website: 'https://www.hside.org'
                }
            },
            {
                id: 'program_45',
                name: 'Basepoint Academy',
                location: 'Arlington, Forney, and McKinney, TX',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Teen-only facility dedicated to helping teenagers work through their daily struggles with anxiety, substance abuse, behavior issues, depression, post-traumatic stress disorder, and other life challenges. Located in the heart of Texas with facilities in Arlington, Forney, and McKinney.',
                features: [
                    'Ages: 11-18 for adolescent programs',
                    'CBT, DBT, and Psychodynamic therapy',
                    'Family therapy and individual therapy',
                    'Behavior therapy and play therapy',
                    'Mindfulness therapy and psychotherapy',
                    'Group therapy and motivational interviewing',
                    'Experiential therapy',
                    'Medication assisted treatment',
                    'Academic support without sacrificing pursuits',
                    'Safe and supportive environment'
                ],
                contact: {
                    phone: '972-325-2633 x1',
                    email: 'Pac@basepointacademy.com',
                    address: 'Arlington TX, Forney TX, and McKinney TX',
                    website: 'https://basepointacademy.com'
                }
            },
            {
                id: 'program_46',
                name: 'Elevations RTC',
                location: 'Residential Treatment Center (All-Gender, Ages 1318)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Ages Served: 1318 Gender: All genders reSTART provides a tech-free, home-like residential setting for adolescents struggling with technology overuse (gaming, screen addiction, digital isolation) and co-occurring emotional or behavioral health challenges. The program is especially helpful for teens who: Are highly withdrawn, avoidant, or digitally dependent Are working through anxiety, low motivation, or executive functioning struggles Need academic flexibility while building structure and resilience Programming includes: Individual, group, and family therapy (CBT, DBT, MI) Academic support with hybrid on-site and virtual options Outdoor recreation, life skills, and team-based living Full reset from digital distractions Ages Served: 1217 Gender: All genders Sparks Academy is tailored for bright, neurodiverse teens who benefit from a highly structured, therapeutic academic setting. Many students are navigating ASD Level 1 or 2, ADHD, anxiety, learning differences, or executive functioning delays. Key features include: Small, personalized classrooms with flexible pacing Built-in intensive clinical support from therapists and psychiatrists Social pragmatics groups and coaching for independence Structured daily  routines and a sensory-considerate environment This is a strong match for teens who need emotional safety, predictability, and clinical scaffolding without a behavioral-heavy model. Sparks is often used as a step-down from RTC or a gentler step-up for teens who can still benefit from academic growth.',
                features: [
                    'Weekly family therapy via telehealth',
                    'Monthly family weekends on campus',
                    'Parent support groups',
                    'Structured home visits for reintegration practice',
                ],
                contact: {
                    contactPerson: '',
                    phone: '(801) 491-7680',
                    email: 'admissions@springbrookbhs.com',
                    address: '5600 Heritage School Dr., Provo, UT 84604',
                    website: 'spark.heritagertc.org'
                }
            },
            {
                id: 'program_47',
                name: 'Rogers Behavioral Health',
                location: 'Adolescent Programs | PHP, IOP, and Residential Services',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Rogers offers specialized Partial Hospitalization (PHP), Intensive Outpatient (IOP), and Residential programs for adolescents ages 1217. Tracks are designed to address a range of behavioral health needs, with options for in-person or virtual care depending on location.',
                features: [
                    'OCD & Anxiety Disorders (including ERP)',
                    'Depression and Mood Disorders',
                    'Eating Disorders',
                    'Trauma & PTSD',
                    'Co-occurring Substance Use',
                ],
                contact: {
                    phone: '8333085887 (central intake for all adolescent programs)',
                    website: 'www.rogersbh.org'
                }
            },
            {
                id: 'program_48',
                name: 'The Wediko School',
                location: 'Residential Treatment & Educational Program for Adolescents',
                type: 'Therapeutic Boarding School',
                category: 'therapeutic-school',
                programCategory: 'Therapeutic Schools',
                levelOfCare: 'Year-round residential treatment and therapeutic academics for adolescent boys and girls (ages ~1119), blending intensive clinical support with special-education curriculum. Campus spans 450 lakefront acres in Windsor, NH  .',
                features: [
                ],
                contact: {
                    phone: 'Admissions  (603) 4785236 (Katie Walsh, Director)',
                    website: 'thewedikoschool.org'
                }
            },
            {
                id: 'program_49',
                name: 'Coral Shores Behavioral Health',
                location: 'Adolescent Intensive Outpatient Program (Stuart, FL)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'An age-specific intensive outpatient program (IOP) for adolescents (ages approximately 1217) offering structured treatment several days per week to support mental health stabilization, transition from inpatient care, or as an alternative to hospitalization.',
                features: [
                    'ThreeDay Weekly Schedule: Groups are held Mondays, Tuesdays, and Thursdays from 4:007:00PM, focusing on realworld skill application and structured therapeutic engagement  .',
                    'Hybrid IOP Options: Available both in-person and via telehealth, allowing flexibility for families balancing school, transportation, or geographic constraints .',
                    'Core Clinical Services: Includes evidence-based treatment modalities such as individual and group therapy, psychoeducation, crisis management, medication review, and wellness planning.',
                    'Family Engagement & Discharge Planning: Family sessions and caregiver involvement are emphasized to ensure support and continuity of care at home.',
                    'Dual Diagnosis & Aftercare Support: Serves adolescents with co-occurring mental health and substance concerns; also offers transition pathways to PHP, inpatient, and outpatient services within the same hospital system  .',
                ],
                contact: {
                    phone: '(772)4034000',
                    address: '5995 SE Community Drive, Stuart, FL 34997',
                    website: 'coralshoresbehavioral.com/program-services/outpatient-treatment-options/'
                }
            },
            {
                id: 'program_50',
                name: 'Mountain Springs Preparatory Academy',
                location: 'Cedar City, UT',
                type: 'Therapeutic Boarding School',
                category: 'therapeutic-school',
                programCategory: 'Therapeutic Schools',
                levelOfCare: 'Transitional boarding school for high school students (grades 1012) stepping down from higher levels of care, such as residential treatment, therapeutic boarding schools, or wilderness programs. Provides a structured, supportive environment to practice independence and real-world skills while continuing academic and personal growth.',
                features: [
                    'Solution-Focused Model: Emphasizes personal responsibility, choice, and learning through natural consequences rather than rigid behavioral systems.',
                    'Practice-Oriented Environment: Students engage in off-campus employment, social activities, and community participation to integrate learned skills into daily life.',
                    'Personalized MAPP Plan: Each student develops a Master Academic and Personal Progress (MAPP) plan with goals in academics, personal growth, family relationships, and future planning.',
                    'Academic Support: Low student-to-teacher ratio, college-prep curriculum, ACT/SAT preparation, and opportunities to earn both high school and college credits.',
                    'Wrap-Around Support: Combines mentorship, academic coaching, clinical guidance, and family involvement to prepare students for successful reintegration.',
                    'Active Student Life: Includes recreation, leadership opportunities, community service, and weekend outings to build confidence and interpersonal skills.',
                ],
                contact: {
                    phone: '(435) 867-5555',
                    address: '1454 South Campus Drive, Cedar City, UT 84720',
                    website: 'www.mountainspringsprep.com'
                }
            },
            {
                id: 'program_51',
                name: 'Queen City Counseling & Consulting',
                location: 'Charlotte, NC',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Outpatient and Intensive Outpatient Program (IOP) tailored for teens and young adults (ages 1327), addressing mental health and co-occurring concerns in a strengths-based, trauma-informed environment.',
                features: [
                    'Specialized Population Focus: Dedicated to adolescents and young adults, leveraging developmental expertise unique to this age range.',
                    'Individual, Family & Group Therapy: Combines personalized individual sessions with supportive group therapy and parent/family involvement.',
                    'Adolescent IOP Leadership: Adolescent IOP led by specialized clinicians including an IOP team lead and a dedicated clinical director.',
                    'Evidence-Based & Trauma-Informed: Incorporates DBT, CBT, EMDR, TF-CBT, ACT, motivational interviewing, and mindfulness-based interventions.',
                    'Parent & Caregiver Support: Offers coaching, education, and resources to integrate parents into the treatment process.',
                    'Telehealth Availability: Accessible virtual options for both North and South Carolina clients.',
                    'Highly Skilled Multidisciplinary Team: Led by licensed clinicians experienced in adolescent, young adult, and trauma-related care.',
                ],
                contact: {
                    phone: '(704) 4578222',
                    address: '5950 Fairview Rd, Suite 150, Charlotte, NC 28210',
                    website: 'www.qc-counseling.com'
                }
            },
            {
                id: 'program_52',
                name: 'Newport Academy',
                location: 'Outpatient Program (Charlotte, NC)',
                type: 'Therapeutic Boarding School',
                category: 'therapeutic-school',
                programCategory: 'Therapeutic Schools',
                levelOfCare: 'Outpatient, Intensive Outpatient (IOP), and Partial Hospitalization Program (PHP) for teens ages 1218 struggling with mental health challenges, substance use, and co-occurring disorders. Provides structured care while allowing teens to live at home.',
                features: [
                    'Continuum of Care: Offers PHP (5 days/week) and IOP (35 days/week) with clinical, psychiatric, and academic support.',
                    'Individualized Treatment: Weekly individual therapy, psychiatry, family therapy, and academic support tailored to each teens needs.',
                    'Experiential Therapies: Includes art, music, yoga, and adventure therapy to promote healing and self-expression.',
                    'Family Involvement: Weekly family therapy sessions and parent support groups to strengthen communication and family systems.',
                    'Academic Coordination: Certified teachers and tutors support teens in keeping up with schoolwork during treatment.',
                    'Clinical Expertise: Addresses depression, anxiety, trauma, self-harm, identity development, and other adolescent concerns.',
                ],
                contact: {
                    phone: '855-419-2852',
                    address: '65 N 1150 W Hurricane, UT 84737',
                    website: 'https://www.embarkbh.com/locations/utah/hurricane/'
                }
            },
            {
                id: 'program_53',
                name: 'La Amistad Behavioral Health Services',
                location: 'Central Florida (Residential / PHP / IOP)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Residential treatment, Partial Hospitalization Program (PHP), and Intensive Outpatient Program (IOP) for youth (ages 1217) and adults (1865). Treats a broad range of behavioral, emotional, psychiatric, and substance use conditions in a nurturing, community-oriented environment.',
                features: [
                    'Continuum of Care: Offers Residential, PHP (6 hours/day, 5 days/week for ~45 weeks), and IOP (3 hours/session, 3 days/week for ~810 weeks).',
                    'Wide Age Range Served: Adolescents and adults up to 65.',
                    'Comprehensive Conditions Treated: Includes mood disorders, depression, bipolar disorder, anxiety, ADHD, personality disorders, trauma-related conditions, schizophrenia, chemical dependency, co-occurring disorders.',
                    'Diverse, Evidence-Based Modalities: Cognitive Behavioral Therapy (CBT), Client-Centered Therapy, Prolonged Exposure, EMDR, 12-Step model combined with medication management.',
                    'Qualified, Multidisciplinary Team: Licensed clinicians, certified addiction professionals, psychiatric and nursing staff.',
                    'Located in Homelike, Serene Settings: Residential campuses in Maitland and Winter Park, Florida, providing tranquility and community integration.',
                ],
                contact: {
                    phone: '(407) 647-0660',
                    address: '1650 North Park Avenue (Maitland/Winter Park), Florida',
                    website: 'La Amistad Behavioral Health Services'
                }
            },
            {
                id: 'program_54',
                name: 'Lifeskills South Florida',
                location: 'Deerfield Beach (Residential / Detox / IOP / PHP / Transitional Living)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Dual-diagnosis clinical treatment center offering Detox (Fort Lauderdale), Residential (Deerfield Beach & Fort Lauderdale), IOP/PHP (Delray Beach & Orlando), and Transitional Living (Osceola Village). Licensed by DCF and AHCA, CARF accredited since 1991.',
                features: [
                    'Integrated, Evidence-Based Continuum: Custom clinical pathways based on thorough diagnostic assessment; 6 pathways including DBT, CBT, addiction, trauma, CRT, metabolic fitness.',
                    'Comprehensive Conditions: Treats anxiety, bipolar, depression, BPD, OCD, PTSD, process addictions, psychosis, schizophrenia, schizoaffective disorders, dual diagnosis.',
                    'Diagnostic Innovation: Premier Diagnostic Insightsan interdisciplinary concierge diagnostic program combining medical, psychiatric, psychological, and neuropsychological data.',
                    'Family & Specialty Support: Family therapy and support programs; veteran-specific care (Psych Armor Veteran Ready Certified); tailored programming for Jewish clients (kosher meals, spiritual counseling, holiday observance).',
                    'Adjunctive Therapies & Amenities: Art/music therapy, yoga, culinary classes, meditation, gym outings, community event transportation, shared townhomes, pool.',
                    'Positive Outcomes: Long-standing clinical excellence and measurable outcomes reported in 2023.',
                ],
                contact: {
                    phone: '(954) 691-3174',
                    website: 'Lifeskills South Florida'
                }
            },
            {
                id: 'program_55',
                name: 'Brightstone Transitions',
                location: 'Gainesville, Georgia (Young Adult Transitional / Neurodiverse Program)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Community-integrated coaching and mentoring program for neurodiverse young adults (ages 1830), emphasizing Independence through Application. Supports life skills, academic and career exploration, therapeutic growth, and personal development.',
                features: [
                    'Neurodiverse Focus: Tailored to support individuals with autism spectrum disorders and other neurodiverse needs transitioning to adulthood.',
                    'Holistic Growth Approach: Emphasizes life skills, academics, therapy, career pathways, and real-world adventures.',
                    'Experienced, Inclusive Team: Staff with backgrounds in mental health, education, and outdoor recreation.',
                    'Community-Integrated, Not Campus-Based: No traditional facility; operates through local community engagement in Gainesville, GA.',
                    'Personalized Support: Highly individualized guidance, family coaching, accountability, and real-time application of skills.',
                ],
                contact: {
                    email: 'admissions@brightstonetransitions.com',
                    address: '446 Green Street, Gainesville, Georgia',
                    website: 'Brightstone Transitions'
                }
            },
            {
                id: 'program_56',
                name: 'Neurobehavioral Institute (NBI)',
                location: 'Weston, Florida (Outpatient / Residential Transitional)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Specialized outpatient and structured transitional residential care for children, adolescents, and adults with Anxiety, ObsessiveCompulsive Disorder (OCD), comorbidities, and complex cases. Services include Intensive Outpatient Program (IOP/PHP), step-down support, and a supportive living residential option (NBI Ranch) for adults.',
                features: [
                    'Evidence-Based Modalities: Emphasizes Cognitive-Behavioral Therapy (CBT), Dialectical Behavior Therapy (DBT), Clinical Behavioral Analysis (CBA), Acceptance & Commitment Therapy (ACT), Exposure and Response Prevention (ERP), executive functioning training, habit reversal, family therapy, and nutritional guidance.',
                    'Multiple Levels of Care: Offers IOP/PHP, step-down programs for individuals transitioning from hospitalization or more restrictive settings, and a residential NBI Ranch program located in Southwest Ranches for individuals needing daily structure and real-world skill application.',
                    'Tailored Intensive OCD Treatment: Customizable program models for children, adolescents, and adultsranging from half-day to full-day formats and lasting from two weeks to four months for children, or four to six weeks for adults. Incorporates psychoeducation, ERP (including in-naturalistic settings like homes and public venues), individualized behavioral strategies, and relapse prevention.',
                    'Complex & Comorbid Case Expertise: Clinical team specializes in treating OCD-related conditions, body-focused repetitive behaviors, mood, ADHD, tics/Tourettes, ASD, disordered eating, PANDAS/PANS, and dual diagnoses through integrated and behavioral-analytic methods.',
                    'Multilingual & Inclusive Care: Services available in English, Spanish, and Portuguese. Culturally informed treatment supports patients from diverse U.S. regions and international backgrounds.',
                    'Highly Qualified Clinical Team & Training Center: Staffed by board-certified psychologists and behavioral analysts. NBI hosts an APPIC-accredited postdoctoral residency program, serves as an IOCDF Institutional member, and provides workshops, professional training, and consultation services.',
                ],
                contact: {
                    phone: '(954) 217-1757',
                    address: '2233 North Commerce Parkway, Suite 1 & 3, Weston, FL 33326',
                    website: 'Neurobehavioral Institute (NBI Weston)'
                }
            },
            {
                id: 'program_57',
                name: 'Foothills at Red Oak Recovery',
                location: 'Ellenboro, North Carolina (Residential Treatment Center for Adolescent Boys)',
                type: 'Residential Treatment',
                category: 'residential',
                programCategory: 'Residential Treatment Centers',
                levelOfCare: 'Residential treatment center for adolescent males (ages 1417), designed to address substance use disorders, co-occurring mental health challenges, trauma, mood disorders, and process addictions in a structured, home-like rural setting.',
                features: [
                    'Trauma-Focused, Gender-Specific Treatment: Clinician-led programming tailored specifically for teen boys, fostering resilience and self-discovery.',
                    'Holistic Clinical Approach: Incorporates evidence-based therapies such as individual, group, and family therapy alongside experiential modalities like equine therapy, adventure/rope-course activities, yoga, mindfulness, music, art, academic support, nutrition counseling, relapse prevention, and exercise therapy programs.',
                    'Therapy Diversity: Offers a wide therapeutic spectrumfrom Cognitive Behavioral Therapy (CBT), Dialectical Behavior Therapy (DBT), and holistic or experiential therapy to academic instruction and group engagement.',
                    'Campus & Setting: Situated on a therapeutic 94-acre working horse farm in Ellenboro, NC, providing nature-based healing in a calm, rural environment.',
                    'Insurance & Accreditation: CARF-accredited facility that accepts a variety of major insurance plans, with support available for families navigating coverage and financial logistics.',
                    'Family and Academic Integration: Strong emphasis on family healing and weekly involvement, along with coordination for on-site educational support to preserve school continuity during treatment.',
                ],
                contact: {
                    phone: '(828) 519-5047',
                    address: '517 Cub Creek Road, Ellenboro, NC 28040',
                    website: 'Foothills at Red Oak Recovery'
                }
            }
        ];

        
        // State management
        let selectedPrograms = [];
        let documentType = 'options';
        let currentFilter = 'all';
        let lastAction = null; // For undo functionality
        let currentPreviewProgram = null;
        let atHomeProviders = [];
        let draggedItem = null;
        let wizardState = {
            currentStep: 1,
            selectedProgramIds: new Set(),
            searchTerm: ''
        };
        let lastDocumentHtml = '';
        
        // Auto-save functionality
        let autoSaveTimer = null;
        const AUTO_SAVE_DELAY = 30000; // 30 seconds
        
        function autoSaveState() {
            const state = {
                selectedPrograms: selectedPrograms,
                atHomeProviders: atHomeProviders,
                documentType: documentType,
                clientName: document.getElementById('clientName')?.value || '',
                includeAtHome: document.getElementById('includeAtHome')?.checked || false,
                includeAlumni: document.getElementById('includeAlumni')?.checked || false,
                timestamp: Date.now()
            };
            
            localStorage.setItem('ffas_autosave', JSON.stringify(state));
            showSuccessMessage('Work automatically saved', 1000);
        }
        
        function restoreAutoSave() {
            const saved = localStorage.getItem('ffas_autosave');
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    // Only restore if less than 24 hours old
                    if (Date.now() - state.timestamp < 24 * 60 * 60 * 1000) {
                        selectedPrograms = state.selectedPrograms || [];
                        atHomeProviders = state.atHomeProviders || [];
                        documentType = state.documentType || 'options';
                        
                        // Restore UI state
                        setTimeout(() => {
                            if (document.getElementById('clientName')) {
                                document.getElementById('clientName').value = state.clientName || '';
                            }
                            if (document.getElementById('includeAtHome')) {
                                document.getElementById('includeAtHome').checked = state.includeAtHome || false;
                            }
                            if (document.getElementById('includeAlumni')) {
                                document.getElementById('includeAlumni').checked = state.includeAlumni || false;
                            }
                            
                            // Update displays
                            updateSelectedDisplay();
                            toggleAtHomeSection();
                            
                            showSuccessMessage('Previous work restored', 2000);
                        }, 500);
                    }
                } catch (e) {
                    console.error('Failed to restore auto-save:', e);
                }
            }
        }
        
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(autoSaveState, AUTO_SAVE_DELAY);
        }
        
        // Trigger auto-save on any change
        document.addEventListener('input', scheduleAutoSave);
        document.addEventListener('change', scheduleAutoSave);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter = Generate Document (Quick Generate)
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const clientNameInput = document.getElementById('clientName');
                if (clientNameInput && clientNameInput.value.trim() && selectedPrograms.length > 0) {
                    generateDocument();
                } else {
                    // Show what's missing
                    if (!clientNameInput || !clientNameInput.value.trim()) {
                        clientNameInput.focus();
                        clientNameInput.style.border = '2px solid #ef4444';
                        setTimeout(() => {
                            clientNameInput.style.border = '';
                        }, 2000);
                    }
                    if (selectedPrograms.length === 0) {
                        showNotification('Select at least one program first', 'warning');
                    }
                }
            }
            
            // Ctrl/Cmd + S = Save to vault
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (lastDocumentHtml) {
                    saveToVault();
                } else {
                    showErrorMessage('Generate a document first before saving');
                }
            }
            
            // Ctrl/Cmd + P = Print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                if (lastDocumentHtml) {
                    printDocumentPreview();
                } else {
                    showErrorMessage('Generate a document first before printing');
                }
            }
            
            // Ctrl/Cmd + G = Generate document
            if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                e.preventDefault();
                generateDocument();
            }
            
            // Ctrl/Cmd + Z = Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undoLastAction();
            }
            
            // ESC = Close modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    if (modal.id === 'documentPreviewModal') {
                        closeDocumentPreview();
                    } else if (modal.id === 'previewModal') {
                        closePreview();
                    }
                });
            }
        });
        
        // Input sanitization helper
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            // Create a temporary div to convert HTML entities
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML
                .replace(/[<>]/g, '') // Remove angle brackets
                .trim();
        }
        
        // Sanitize client name on input
        const clientNameInput = document.getElementById('clientName');
        if (clientNameInput) {
            clientNameInput.addEventListener('input', function() {
                this.value = sanitizeInput(this.value);
            });
        }
        
        // AI Configuration - Choose OpenAI or Anthropic
        const OPENAI_API_KEY = 'YOUR_OPENAI_API_KEY_HERE'; // Replace with your OpenAI API key
        const ANTHROPIC_API_KEY = 'YOUR_ANTHROPIC_API_KEY_HERE'; // Or use Anthropic Claude
        
        // API endpoints
        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
        const ANTHROPIC_API_URL = 'https://api.anthropic.com/v1/messages';
        
        // Helpers
        function normalizeUrl(url) {
            if (!url) return '';
            const trimmed = String(url).trim();
            if (!trimmed) return '';
            if (/^https?:\/\//i.test(trimmed)) return trimmed;
            if (/^www\./i.test(trimmed)) return `https://${trimmed}`;
            try {
                // If it's a bare domain like example.com
                const hasDot = trimmed.includes('.') && !trimmed.includes(' ');
                return hasDot ? `https://${trimmed}` : trimmed;
            } catch { return trimmed; }
        }
        
        // Save custom programs to localStorage
        function saveCustomPrograms() {
            const customPrograms = programs.filter(p => p.isCustom);
            localStorage.setItem('customPrograms', JSON.stringify(customPrograms));
            console.log('Saved', customPrograms.length, 'custom programs');
        }
        
        // Load custom programs from localStorage
        function loadCustomPrograms() {
            const saved = localStorage.getItem('customPrograms');
            if (saved) {
                try {
                    const customPrograms = JSON.parse(saved);
                    customPrograms.forEach(p => {
                        // Check if this program isn't already in the array
                        if (!programs.find(existing => existing.id === p.id)) {
                            programs.push(p);
                        }
                    });
                    console.log('Loaded', customPrograms.length, 'custom programs from storage');
                } catch (e) {
                    console.error('Error loading custom programs:', e);
                }
            }
        }
        
        // Initialize
        // Document Vault Functions
        function openDocumentVault() {
            const vault = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentVault) || '[]');
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2> Document Vault (HIPAA Compliant - Local Storage)</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px;">
                            <span style="color: #f59e0b; font-size: 16px;"></span>
                            <span style="color: #92400e;"><strong>PHI Warning:</strong> Only first name is stored. Do not enter full names, DOB, addresses, or any PHI.</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <strong>Stored Documents: ${vault.length}</strong>
                            <div>
                                <button onclick="exportVault()" style="background: #059669; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-right: 10px;">
                                     Export All
                                </button>
                                <button onclick="clearVault()" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px;">
                                     Clear Vault
                                </button>
                            </div>
                        </div>
                        ${vault.length === 0 ? '<p>No documents saved yet. Generated aftercare recommendations will automatically be saved here.</p>' : vault.map((doc, i) => `
                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 15px; margin-bottom: 10px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="font-size: 16px;">${doc.clientName}</strong>
                                        <span style="color: #6b7280; margin-left: 10px;">${new Date(doc.date).toLocaleDateString()} ${new Date(doc.date).toLocaleTimeString()}</span>
                                        ${doc.type ? `<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; margin-left: 10px; font-size: 12px;">${doc.type}</span>` : ''}
                                    </div>
                                    <div>
                                        <button onclick="viewDocument(${i})" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px;">
                                             View
                                        </button>
                                        <button onclick="includeInPacket(${i})" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px;">
                                             Add to Packet
                                        </button>
                                        <button onclick="deleteDocument(${i})" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px;">
                                            
                                        </button>
                                    </div>
                                </div>
                                ${doc.programs && doc.programs.length > 0 ? `
                                    <div style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                                        Programs: ${doc.programs.map(p => p.name).join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

                                        const defaultAtHomeLibrary = [
                                            {
                                                id: 'library_provider_1',
                                                name: 'Clear Path Clinical Group',
                                                service: 'Family Therapy & Parent Coaching',
                                                phone: '(561) 480-2232',
                                                website: 'https://clearpathclinical.com',
                                                address: 'Telehealth (Florida Based)'
                                            },
                                            {
                                                id: 'library_provider_2',
                                                name: 'Momentum Teen Psychiatry Collective',
                                                service: 'Psychiatry & Medication Management',
                                                phone: '(305) 902-7710',
                                                website: 'https://momentumteenpsychiatry.com',
                                                address: 'Miami, FL & Virtual'
                                            },
                                            {
                                                id: 'library_provider_3',
                                                name: 'Thrive Recovery Coaching Alliance',
                                                service: 'Recovery Coaching & Transport',
                                                phone: '(770) 407-0768',
                                                website: 'https://thriverecoveryalliance.com',
                                                address: 'National Network'
                                            }
                                        ];
        
        // View document from vault
        function viewDocument(index) {
            const vault = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentVault) || '[]');
            if (vault[index]) {
                const win = window.open();
                win.document.write(vault[index].content);
            }
        }
        
        // Delete document from vault
        function deleteDocument(index) {
            if (confirm('Are you sure you want to delete this document?')) {
                const vault = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentVault) || '[]');
                vault.splice(index, 1);
                localStorage.setItem(STORAGE_KEYS.documentVault, JSON.stringify(vault));
                openDocumentVault(); // Refresh the modal
            }
        }
        
        // Clear entire vault
        function clearVault() {
            if (confirm('Are you sure you want to clear the entire document vault? This cannot be undone.')) {
                localStorage.setItem(STORAGE_KEYS.documentVault, '[]');
                openDocumentVault(); // Refresh the modal
            }
        }
        
        // Export vault as JSON
        function exportVault() {
            const vault = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentVault) || '[]');
            const dataStr = JSON.stringify(vault, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `document_vault_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Include document in packet (placeholder for future enhancement)
        function includeInPacket(index) {
            const vault = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentVault) || '[]');
            const doc = vault[index];
            if (doc) {
                // Store temporarily for packet compilation
                sessionStorage.setItem('pendingPacketDoc', JSON.stringify(doc));
                alert(`Document for ${doc.clientName} marked for packet inclusion. Open the Discharge Packet creator to continue.`);
            }
        }
        
        // Enhanced Discharge Packet with PDF Merging
        function createDischargePacket() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2> Create Complete Discharge Packet</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="background: #f0f9ff; border: 1px solid #0099cc; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #0066cc;">PDF Document Compiler</h3>
                            <p style="margin: 5px 0;">Merge multiple PDFs and generated documents into one complete packet</p>
                            <small style="color: #666;">All processing happens locally - HIPAA compliant</small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Client First Name <span style="color: #92400e; font-size: 12px;">(No PHI)</span>:</label>
                            <input type="text" id="packetClientName" placeholder="First Name Only (Required)" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" oninput="validatePacketFirstName(this)">
                            <div id="packetNameWarning" style="color: #dc2626; font-size: 13px; display: none; margin-top: 5px;">Please enter first name only. No full names, DOB, or PHI.</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Discharge Date:</label>
                            <input type="date" id="packetDischargeDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <!-- Document Components Section -->
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #374151; margin-bottom: 10px;"> Select Documents to Include:</h4>
                            
                            <!-- Generated Documents -->
                            <div style="background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0; color: #0066cc;">Generated Documents</h5>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" id="includeCoverPage" checked> 
                                    <strong>Cover Page</strong> - Patient info and discharge summary
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox" id="includeAftercarePlan" checked> 
                                    <strong>Aftercare Plan</strong> - Current generated document
                                </label>
                            </div>
                            
                            <!-- Upload Additional PDFs -->
                            <div style="background: #fff7ed; border: 1px solid #fed7aa; border-radius: 8px; padding: 15px;">
                                <h5 style="margin-top: 0; color: #ea580c;">Upload Additional PDFs</h5>
                                <input type="file" id="additionalPdfs" multiple accept=".pdf" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <small style="color: #666; display: block; margin-top: 5px;">Select multiple PDFs to include (e.g., discharge summary, medical records)</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button onclick="compileDischargePacket()" style="padding: 14px 28px; background: #0066cc; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                             Create Packet
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="padding: 14px 28px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Inline validation for first name only (packet modal)
        function validatePacketFirstName(input) {
            const value = input.value.trim();
            // Auto-capitalize
            if (value.length > 0) {
                input.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
            }
            // Disallow spaces, numbers, or special chars (except hyphen/apostrophe)
            const invalid = /[\s\d@#\$%\^&\*\(\)_\+=\[\]\{\};:,.<>\/?\\|]/.test(value) || value.length > 20;
            const warning = document.getElementById('packetNameWarning');
            if (warning) {
                warning.style.display = invalid ? 'block' : 'none';
            }
            input.style.borderColor = invalid ? '#dc2626' : '#d1d5db';
        }
        
        // Compile discharge packet function
        async function compileDischargePacket() {
            const clientName = document.getElementById('packetClientName')?.value.trim();
            
            if (!clientName) {
                alert('Please enter client first name');
                return;
            }
            
            showNotification(' Creating discharge packet...', 'info');
            
            // Get the current document if available
            if (!lastDocumentHtml) {
                alert('Please generate an aftercare document first');
                return;
            }
            
            // Close the modal
            document.querySelector('.modal.show')?.remove();
            
            // For now, just download the current document as the packet
            // In the future, this could merge multiple PDFs
            const filename = `${clientName}_Discharge_Packet_${new Date().toISOString().split('T')[0]}.pdf`;
            
            try {
                await downloadDocumentPdf(filename);
                showNotification(' Discharge packet created successfully!', 'success');
            } catch (error) {
                console.error('Error creating packet:', error);
                showNotification(' Failed to create discharge packet', 'error');
            }
        }
        
        // Handle PDF file selection (placeholder for future enhancement)
        function handlePDFSelection(input) {
            const files = input.files;
            const selectedFilesDiv = document.getElementById('selectedFiles');
            if (selectedFilesDiv && files.length > 0) {
                selectedFilesDiv.innerHTML = `<p style="color: #16a34a;"> ${files.length} file(s) selected</p>`;
            }
        }
        
        // Schedule follow-up function
        function scheduleFollowUp() {
            showNotification('Follow-up scheduling feature coming soon!', 'info');
        }
        
        // Email document function
        function handlePDFSelection(input) {
            const files = input.files;
            const selectedFilesDiv = document.getElementById('selectedFiles');
            const orderDiv = document.getElementById('documentOrder');
            
            if (files.length > 0) {
                selectedFilesDiv.innerHTML = '<strong>Selected PDFs:</strong>';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    selectedFilesDiv.innerHTML += `
                        <div style="margin-top: 5px; padding: 5px; background: #fff; border-radius: 4px;">
                             ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
                        </div>
                    `;
                    
                    // Add to document order
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.setAttribute('data-type', 'pdf');
                    orderItem.setAttribute('data-file-index', i);
                    orderItem.style.cssText = 'padding: 8px; background: #fef3c7; margin-bottom: 5px; border-radius: 4px; cursor: move;';
                    orderItem.textContent = `${orderDiv.children.length + 1}. ${file.name}`;
                    orderDiv.appendChild(orderItem);
                }
            }
        }
        
        // Compile the complete packet
        async function compilePacket() {
            const clientName = document.getElementById('packetClientName').value;
            if (!clientName) {
                alert('Please enter patient name');
                return;
            }
            
            // Show progress
            document.getElementById('mergeProgress').style.display = 'block';
            updateProgress(0, 'Starting compilation...');
            
            try {
                // Create a new PDF document using pdf-lib
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                
                let currentProgress = 0;
                const progressIncrement = 100 / (document.getElementById('documentOrder').children.length + 2);
                
                // Process each document in order
                const orderItems = document.getElementById('documentOrder').children;
                
                for (let i = 0; i < orderItems.length; i++) {
                    const item = orderItems[i];
                    const type = item.getAttribute('data-type');
                    
                    updateProgress(currentProgress, `Processing ${item.textContent}...`);
                    
                    if (type === 'cover' && document.getElementById('includeCoverPage').checked) {
                        await addCoverPage(mergedPdf, clientName);
                    } else if (type === 'aftercare' && document.getElementById('includeAftercare').checked) {
                        await addAftercarePage(mergedPdf, clientName);
                    } else if (type === 'facesheet' && document.getElementById('includeFaceSheet').checked) {
                        await addFaceSheet(mergedPdf, clientName);
                    } else if (type === 'pdf') {
                        const fileIndex = parseInt(item.getAttribute('data-file-index'));
                        const files = document.getElementById('pdfFiles').files;
                        if (files[fileIndex]) {
                            await addExternalPDF(mergedPdf, files[fileIndex]);
                        }
                    }
                    
                    currentProgress += progressIncrement;
                    updateProgress(currentProgress, `Completed ${item.textContent}`);
                }
                
                // Save the merged PDF
                updateProgress(90, 'Finalizing document...');
                const pdfBytes = await mergedPdf.save();
                
                // Download the file
                updateProgress(100, 'Complete! Downloading...');
                downloadPDF(pdfBytes, `${clientName}_Discharge_Packet_${new Date().toISOString().split('T')[0]}.pdf`);
                
                // Close modal after success
                setTimeout(() => {
                    document.querySelector('.modal').remove();
                    showSuccessMessage('Discharge packet created successfully!');
                }, 1500);
                
            } catch (error) {
                console.error('Error compiling packet:', error);
                alert('Error creating packet: ' + error.message);
            }
        }
        
        // Add cover page to PDF
        async function addCoverPage(pdf, clientName) {
            const { rgb, StandardFonts } = PDFLib;
            const page = pdf.addPage();
            const font = await pdf.embedFont(StandardFonts.Helvetica);
            const boldFont = await pdf.embedFont(StandardFonts.HelveticaBold);
            
            const { width, height } = page.getSize();
            
            // Title
            page.drawText('DISCHARGE PACKET', {
                x: width / 2 - 100,
                y: height - 100,
                size: 24,
                font: boldFont,
                color: rgb(0, 0.4, 0.8)
            });
            
            // Patient info
            page.drawText(`Patient: ${clientName}`, {
                x: 50,
                y: height - 200,
                size: 14,
                font: font
            });
            
            page.drawText(`Discharge Date: ${document.getElementById('packetDischargeDate').value}`, {
                x: 50,
                y: height - 230,
                size: 14,
                font: font
            });
            
            page.drawText('Family First Adolescent Services', {
                x: 50,
                y: 100,
                size: 12,
                font: font,
                color: rgb(0.4, 0.4, 0.4)
            });
        }
        
        // Add aftercare recommendations from vault or current session
        async function addAftercarePage(pdf, clientName) {
            const { rgb, StandardFonts } = PDFLib;
            
            // Check if we have a saved aftercare document in the vault
            const vault = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentVault) || '[]');
            const latestAftercare = vault
                .filter(doc => doc.clientName === clientName && doc.type === 'aftercare')
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            
            if (latestAftercare && latestAftercare.htmlContent) {
                // Convert HTML to PDF using jsPDF
                await addHtmlToPdf(pdf, latestAftercare.htmlContent, 'Aftercare Recommendations');
            } else {
                // Fallback to basic text version
                const page = pdf.addPage();
                const font = await pdf.embedFont(StandardFonts.Helvetica);
                const boldFont = await pdf.embedFont(StandardFonts.HelveticaBold);
                
                const { width, height } = page.getSize();
                
                page.drawText('AFTERCARE RECOMMENDATIONS', {
                    x: 50,
                    y: height - 50,
                    size: 18,
                    font: boldFont,
                    color: rgb(0, 0.4, 0.8)
                });
                
                // Add selected programs if any
                if (selectedPrograms && selectedPrograms.length > 0) {
                    let yPosition = height - 100;
                    let currentPage = page;
                    
                    selectedPrograms.forEach((program, index) => {
                        if (yPosition < 100) {
                            // Add new page if needed
                            currentPage = pdf.addPage();
                            yPosition = currentPage.getSize().height - 50;
                        }
                        
                        currentPage.drawText(`${index + 1}. ${program.name}`, {
                            x: 50,
                            y: yPosition,
                            size: 12,
                            font: boldFont
                        });
                        yPosition -= 20;
                        
                        if (program.location) {
                            currentPage.drawText(`   Location: ${program.location}`, {
                                x: 50,
                                y: yPosition,
                                size: 10,
                                font: font
                            });
                            yPosition -= 15;
                        }
                        
                        if (program.contact?.phone || program.phone) {
                            currentPage.drawText(`   Phone: ${program.contact?.phone || program.phone}`, {
                                x: 50,
                                y: yPosition,
                                size: 10,
                                font: font
                            });
                            yPosition -= 15;
                        }
                        
                        yPosition -= 10;
                    });
                }
            }
        }
        
        // Helper function to convert HTML to PDF pages
        async function addHtmlToPdf(pdf, htmlContent, title) {
            // Create a temporary jsPDF document to convert HTML
            const { jsPDF } = window.jspdf;
            const tempDoc = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'letter'
            });
            
            // Create a temporary div to render the HTML
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = '612px'; // Letter width in points
            tempDiv.innerHTML = htmlContent;
            document.body.appendChild(tempDiv);
            
            // Use html2canvas if available, otherwise use text extraction
            try {
                // For now, we'll extract text content and add it to the PDF
                const textContent = tempDiv.innerText || tempDiv.textContent;
                const lines = textContent.split('\n').filter(line => line.trim());
                
                const { rgb, StandardFonts } = PDFLib;
                const page = pdf.addPage();
                const font = await pdf.embedFont(StandardFonts.Helvetica);
                const boldFont = await pdf.embedFont(StandardFonts.HelveticaBold);
                
                const { width, height } = page.getSize();
                let yPosition = height - 50;
                let currentPage = page;
                
                // Add title
                currentPage.drawText(title || 'Document', {
                    x: 50,
                    y: yPosition,
                    size: 18,
                    font: boldFont,
                    color: rgb(0, 0.4, 0.8)
                });
                yPosition -= 30;
                
                // Add content lines
                for (const line of lines) {
                    if (yPosition < 50) {
                        currentPage = pdf.addPage();
                        yPosition = currentPage.getSize().height - 50;
                    }
                    
                    // Wrap long lines
                    const maxWidth = width - 100;
                    const words = line.split(' ');
                    let currentLine = '';
                    
                    for (const word of words) {
                        const testLine = currentLine + (currentLine ? ' ' : '') + word;
                        const textWidth = font.widthOfTextAtSize(testLine, 11);
                        
                        if (textWidth > maxWidth && currentLine) {
                            currentPage.drawText(currentLine, {
                                x: 50,
                                y: yPosition,
                                size: 11,
                                font: font
                            });
                            yPosition -= 15;
                            currentLine = word;
                            
                            if (yPosition < 50) {
                                currentPage = pdf.addPage();
                                yPosition = currentPage.getSize().height - 50;
                            }
                        } else {
                            currentLine = testLine;
                        }
                    }
                    
                    if (currentLine) {
                        currentPage.drawText(currentLine, {
                            x: 50,
                            y: yPosition,
                            size: 11,
                            font: font
                        });
                        yPosition -= 15;
                    }
                }
            } finally {
                document.body.removeChild(tempDiv);
            }
        }
        
        // Add face sheet
        async function addFaceSheet(pdf, clientName) {
            const { rgb, StandardFonts } = PDFLib;
            const page = pdf.addPage();
            const font = await pdf.embedFont(StandardFonts.Helvetica);
            const boldFont = await pdf.embedFont(StandardFonts.HelveticaBold);
            
            const { width, height } = page.getSize();
            
            page.drawText('FACE SHEET', {
                x: 50,
                y: height - 50,
                size: 18,
                font: boldFont,
                color: rgb(0, 0.4, 0.8)
            });
            
            page.drawText(`Patient Name: ${clientName}`, {
                x: 50,
                y: height - 100,
                size: 12,
                font: font
            });
            
            page.drawText(`Date of Discharge: ${document.getElementById('packetDischargeDate').value}`, {
                x: 50,
                y: height - 130,
                size: 12,
                font: font
            });
        }
        
        // Add external PDF
        async function addExternalPDF(mergedPdf, file) {
            const arrayBuffer = await file.arrayBuffer();
            const externalPdf = await PDFLib.PDFDocument.load(arrayBuffer);
            const pages = await mergedPdf.copyPages(externalPdf, externalPdf.getPageIndices());
            pages.forEach(page => mergedPdf.addPage(page));
        }
        
        // Update progress bar
        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = message;
        }
        
        // Download PDF
        function downloadPDF(pdfBytes, filename) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Show success message
        function showSuccessMessage(message) {
            const msg = document.createElement('div');
            msg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
            msg.innerHTML = ' ' + message;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }
        
        function showNotification(message, type = 'info') {
            const colors = {
                info: '#0099cc',
                warning: '#f59e0b',
                error: '#ef4444',
                success: '#10b981'
            };
            const msg = document.createElement('div');
            msg.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;`;
            msg.innerHTML = message;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting initialization...');

            // Load any saved custom programs first
            loadCustomPrograms();
            console.log('Programs loaded:', programs.length);
            console.log('First program:', programs[0]);

            // DEBUG: Check if selection panel exists
            const selectionPanel = document.querySelector('.selection-panel');
            console.log('Selection panel found:', !!selectionPanel);

            if (selectionPanel) {
                console.log('Selection panel styles:', window.getComputedStyle(selectionPanel));
            }

            // Add a small delay to ensure DOM is fully ready
            setTimeout(() => {
            renderPrograms();
                console.log('Programs rendered');
            }, 100);
            
            // Search functionality (combined with active filter)
            document.getElementById('searchBox').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const cards = document.querySelectorAll('.program-card');
                cards.forEach(card => {
                    const program = programs.find(p => p.id === card.dataset.id);
                    const matchesSearch = `${program.name} ${program.location} ${program.type}`.toLowerCase().includes(searchTerm);
                    const matchesFilter = (currentFilter === 'all' || program.category === currentFilter);
                    card.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
                });
            });
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('previewModal');
                if (event.target == modal) {
                    closePreview();
                }
            }
        });
        
        // Set document type
        function setDocumentType(type, el) {
            documentType = type;
            
            // Update button states
            document.querySelectorAll('.doc-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (el) el.classList.add('active');
            
            // Update UI based on type
            const selectedTitle = document.getElementById('selectedTitle');
            
            if (type === 'plans') {
                selectedTitle.textContent = 'Selected Program (Choose 1)';
                
                // If more than one selected, keep only the first
                if (selectedPrograms.length > 1) {
                    selectedPrograms = [selectedPrograms[0]];
                    updateSelectionPanel();
                    renderPrograms();
                }
            } else {
                selectedTitle.textContent = 'Selected Programs (Drag to reorder)';
            }
        }
        
        // Smart Search functionality
        let searchTimeout;
        let lastSearchResults = [];
        
        function handleSearch(searchTerm) {
            const indicator = document.getElementById('searchIndicator');
            const addBtn = document.getElementById('addProgramBtn');
            
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            if (!searchTerm.trim()) {
                // Empty search - hide indicators and show all programs
                indicator.style.opacity = '0';
                indicator.style.display = 'none';
                // Keep the add button visible
                lastSearchResults = programs;
                renderPrograms();
                return;
            }
            
            // Show searching indicator
            indicator.innerHTML = ' Searching...';
            indicator.style.display = 'block';
            indicator.style.opacity = '1';
            indicator.classList.add('search-animation');
            // Don't hide the add button - keep it visible
            // addBtn.classList.remove('show');
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                performSearch(searchTerm);
            }, 300);
        }
        
        function performSearch(searchTerm) {
            const indicator = document.getElementById('searchIndicator');
            const addBtn = document.getElementById('addProgramBtn');
            
            // Search through programs
            const results = programs.filter(program => {
                const searchText = searchTerm.toLowerCase();
                return (
                    program.name.toLowerCase().includes(searchText) ||
                    program.location?.toLowerCase().includes(searchText) ||
                    program.type?.toLowerCase().includes(searchText) ||
                    program.features.some(feature => feature.toLowerCase().includes(searchText)) ||
                    program.contact.phone?.toLowerCase().includes(searchText) ||
                    program.contact.website?.toLowerCase().includes(searchText)
                );
            });
            
            lastSearchResults = results;
            
            // Update UI based on results
            if (results.length > 0) {
                // Found results
                indicator.innerHTML = ` ${results.length} program${results.length === 1 ? '' : 's'} found`;
                indicator.classList.remove('search-animation');
                // Keep add button visible always
                renderPrograms(results);
            } else {
                // No results
                indicator.innerHTML = ' No programs found';
                indicator.classList.remove('search-animation');
                // Keep add button visible always
                renderPrograms([]);
            }
            
            // Hide indicator after 3 seconds
            setTimeout(() => {
                indicator.style.opacity = '0';
                indicator.style.display = 'none';
            }, 3000);
        }
        
        function triggerAddProgram() {
            const addBtn = document.getElementById('addProgramBtn');
            const searchTerm = document.getElementById('searchBox').value;
            
            // Cool animation
            addBtn.classList.add('add-animation');
            
            // Pre-populate the add program dialog with search term
            document.getElementById('customProgramInfo').value = searchTerm;
            showAddProgramDialog();
            
            // Remove animation class after animation completes
            setTimeout(() => {
                addBtn.classList.remove('add-animation');
            }, 800);
        }
        
        // Filter programs
    function filterPrograms(category, el) {
            currentFilter = category;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (el) el.classList.add('active');
            
            // Handle frequently used filter
            if (category === 'frequent') {
                const frequentPrograms = getFrequentlyUsedPrograms(10);
                if (frequentPrograms.length === 0) {
                    // Show message if no frequent programs yet
                    const grid = document.getElementById('programGrid');
                    grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No frequently used programs yet. Start selecting programs to build your favorites!</div>';
                    return;
                }
                renderPrograms(frequentPrograms);
                return;
            }
            
            // Map filter categories to program categories
            const categoryMap = {
                'rtc': 'residential',
                'tbs': 'therapeutic-school',
                'wilderness': 'wilderness',
                'php-iop': 'outpatient',
                'transitional': 'sober-living',
                'virtual': 'virtual',
                'asd': 'asd',
                'evaluation': 'evaluation',
                'athome': 'athome'
            };
            
            const mappedCategory = categoryMap[category] || category;
            
            // Filter cards
            const cards = document.querySelectorAll('.program-card');
            cards.forEach(card => {
                const program = programs.find(p => p.id === card.dataset.id);
        const searchTerm = document.getElementById('searchBox').value.toLowerCase();
                const matchesFilter = (category === 'all' || program.category === mappedCategory);
        const matchesSearch = `${program.name} ${program.location} ${program.type}`.toLowerCase().includes(searchTerm);
        card.style.display = (matchesFilter && matchesSearch) ? 'block' : 'none';
            });
        }
        
        // Get filtered programs based on current filter
        function getFilteredPrograms() {
            if (currentFilter === 'all') return programs;
            
            const categoryMap = {
                'rtc': 'residential',
                'tbs': 'therapeutic-school',
                'wilderness': 'wilderness',
                'php': 'php',
                'iop': 'iop',
                'transitional': 'transitional',
                'virtual': 'virtual',
                'asd': 'asd',
                'evaluation': 'evaluation',
                'athome': 'at-home'
            };
            
            const targetCategory = categoryMap[currentFilter] || currentFilter;
            return programs.filter(program => program.category === targetCategory);
        }
        
        // Render programs
        function renderPrograms(programsToRender = null) {
            const grid = document.getElementById('programGrid');
            if (!grid) {
                console.error('programGrid element not found!');
                alert('Error: Program grid not found. Please refresh the page.');
                return;
            }
            
            // Use provided programs or fall back to filtered programs
            const programList = programsToRender || getFilteredPrograms();
            console.log('Rendering', programList.length, 'programs');
            
            // Clear and ensure grid is visible
            grid.innerHTML = '';
            grid.style.display = 'grid';
            
            // Show message if no programs
            if (programList.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No programs found. Try adjusting your filters.</div>';
                return;
            }
            
            // Show recently used programs
            showRecentlyUsedPrograms();
            
            programList.forEach(program => {
                const card = document.createElement('div');
                card.className = 'program-card';
                card.dataset.id = program.id;
                
                const isSelected = selectedPrograms.some(p => p.id === program.id);
                if (isSelected) {
                    card.classList.add('primary');
                }
                
                card.innerHTML = `
                    <button class="program-info-btn" onclick="openPreview('${program.id}', event)" title="View Details">i</button>
                    <div class="program-name">${program.name}</div>
                    <div class="program-location">${program.location}</div>
                    <div class="program-type">${program.type}</div>
                    ${isSelected ? '<div class="program-badge">SELECTED</div>' : ''}
                `;
                
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('program-info-btn')) {
                        handleProgramClick(program, card);
                    }
                });
                grid.appendChild(card);
            });
        }



        function wizardSetStep(step) {
            wizardState.currentStep = step;
            const labels = {
                1: 'Client Setup',
                2: 'Program Picks',
                3: 'Review & Apply'
            };

            const indicators = [1, 2, 3];
            indicators.forEach(index => {
                const stepEl = document.getElementById(`wizardStep${index}`);
                const indicatorEl = document.getElementById(`wizardStepIndicator${index}`);
                if (stepEl) {
                    stepEl.classList.toggle('active', index === step);
                }
                if (indicatorEl) {
                    indicatorEl.classList.toggle('active', index <= step);
                }
            });

            const labelEl = document.getElementById('wizardStepLabel');
            if (labelEl) {
                labelEl.textContent = labels[step] || '';
            }

            const backBtn = document.querySelector('.wizard-back');
            if (backBtn) {
                backBtn.disabled = step === 1;
                backBtn.style.visibility = step === 1 ? 'hidden' : 'visible';
            }

            const nextBtn = document.getElementById('wizardNextButton');
            const finishBtn = document.getElementById('wizardFinishButton');

            if (nextBtn) {
                nextBtn.style.display = step === 3 ? 'none' : 'inline-flex';
            }

            if (finishBtn) {
                finishBtn.style.display = step === 3 ? 'inline-flex' : 'none';
            }
        }

        function wizardNextStep() {
            if (wizardState.currentStep === 1) {
                const wizardClientInput = document.getElementById('wizardClientName');
                if (wizardClientInput && !wizardClientInput.value.trim()) {
                    wizardClientInput.classList.add('input-error');
                    wizardClientInput.focus();
                    return;
                }
            }

            const nextStep = Math.min(3, wizardState.currentStep + 1);
            if (nextStep === 2) {
                renderWizardPrograms();
            }
            if (nextStep === 3) {
                updateWizardSummary();
            }

            wizardSetStep(nextStep);
        }

        function wizardPrevStep() {
            const prevStep = Math.max(1, wizardState.currentStep - 1);
            wizardSetStep(prevStep);
            if (prevStep === 3) {
                updateWizardSummary();
            }
        }

        function filterWizardPrograms(term) {
            wizardState.searchTerm = (term || '').toLowerCase();
            renderWizardPrograms();
        }

        function renderWizardPrograms() {
            const container = document.getElementById('wizardProgramList');
            if (!container) return;

            const term = wizardState.searchTerm.trim();
            const results = programs.filter(program => {
                if (!term) return true;
                const haystack = `${program.name} ${program.location} ${program.type} ${program.programCategory || ''} ${program.levelOfCare || ''}`.toLowerCase();
                return haystack.includes(term);
            }).slice(0, 60);

            if (results.length === 0) {
                container.innerHTML = '<div class="wizard-no-results">No programs match that search yet. Try a different keyword.</div>';
                return;
            }

            container.innerHTML = '';

            results.forEach(program => {
                const isSelected = wizardState.selectedProgramIds.has(program.id);
                const item = document.createElement('label');
                item.className = `wizard-program-item${isSelected ? ' active' : ''}`;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = isSelected;
                checkbox.addEventListener('change', (event) => {
                    toggleWizardProgram(program.id, event.target.checked);
                    if (event.target.checked) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                const meta = document.createElement('div');
                meta.className = 'wizard-program-meta';
                meta.innerHTML = `
                    <div class="name">${program.name}</div>
                    <div class="location">${program.location}</div>
                    <div class="chips">
                        <span class="chip">${program.type}</span>
                        ${program.levelOfCare ? `<span class="chip">${program.levelOfCare}</span>` : ''}
                    </div>
                `;

                item.appendChild(checkbox);
                item.appendChild(meta);
                container.appendChild(item);
            });
        }

        function toggleWizardProgram(programId, isChecked) {
            if (isChecked) {
                wizardState.selectedProgramIds.add(programId);
            } else {
                wizardState.selectedProgramIds.delete(programId);
            }
            updateWizardSummary();
        }

        function updateWizardSummary() {
            const nameEl = document.getElementById('wizardSummaryName');
            const atHomeEl = document.getElementById('wizardSummaryAtHome');
            const alumniEl = document.getElementById('wizardSummaryAlumni');
            const listEl = document.getElementById('wizardSummaryPrograms');
            const wizardClientInput = document.getElementById('wizardClientName');
            const wizardAtHomeCheckbox = document.getElementById('wizardIncludeAtHome');
            const wizardAlumniCheckbox = document.getElementById('wizardIncludeAlumni');

            if (nameEl && wizardClientInput) {
                const name = wizardClientInput.value.trim();
                nameEl.textContent = name || '';
            }

            if (atHomeEl && wizardAtHomeCheckbox) {
                atHomeEl.textContent = wizardAtHomeCheckbox.checked ? 'Yes' : 'No';
            }

            if (alumniEl && wizardAlumniCheckbox) {
                alumniEl.textContent = wizardAlumniCheckbox.checked ? 'Yes' : 'No';
            }

            if (listEl) {
                listEl.innerHTML = '';
                const summaryPrograms = programs.filter(program => wizardState.selectedProgramIds.has(program.id));
                if (summaryPrograms.length === 0) {
                    listEl.innerHTML = '<li style="color: #6b7280;">No programs selected yet</li>';
                } else {
                    summaryPrograms.forEach(program => {
                        const li = document.createElement('li');
                        li.textContent = `${program.name}  ${program.location}`;
                        listEl.appendChild(li);
                    });
                }
            }
        }

        function wizardFinish() {
            const wizardClientInput = document.getElementById('wizardClientName');
            if (wizardClientInput && !wizardClientInput.value.trim()) {
                wizardClientInput.classList.add('input-error');
                wizardClientInput.focus();
                return;
            }

            const mainClientInput = document.getElementById('clientName');
            const wizardAtHomeCheckbox = document.getElementById('wizardIncludeAtHome');
            const wizardAlumniCheckbox = document.getElementById('wizardIncludeAlumni');
            const mainAtHome = document.getElementById('includeAtHome');
            const mainAlumni = document.getElementById('includeAlumni');

            if (mainClientInput && wizardClientInput) {
                mainClientInput.value = wizardClientInput.value.trim();
            }

            if (mainAtHome && wizardAtHomeCheckbox) {
                mainAtHome.checked = wizardAtHomeCheckbox.checked;
                toggleAtHomeSection();
            }

            if (mainAlumni && wizardAlumniCheckbox) {
                mainAlumni.checked = wizardAlumniCheckbox.checked;
            }

            const updatedSelection = programs.filter(program => wizardState.selectedProgramIds.has(program.id));
            selectedPrograms = updatedSelection;

            updateSelectionPanel();
            renderPrograms();
            updateWizardSummary();
            closeIntakeWizard();
            showSuccessMessage('Wizard selections applied to builder.');
        }
        
        // Track program usage for frequently used
        function trackProgramUsage(programId) {
            const usage = JSON.parse(localStorage.getItem('programUsage') || '{}');
            usage[programId] = (usage[programId] || 0) + 1;
            localStorage.setItem('programUsage', JSON.stringify(usage));
        }
        
        // Get frequently used programs
        function getFrequentlyUsedPrograms(limit = 10) {
            const usage = JSON.parse(localStorage.getItem('programUsage') || '{}');
            return Object.entries(usage)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit)
                .map(([id]) => programs.find(p => p.id === id))
                .filter(Boolean);
        }
        
        // Save action for undo
        function saveUndoAction(type, data) {
            lastAction = { type, data, timestamp: Date.now() };
        }
        
        // Undo last action
        function undoLastAction() {
            if (!lastAction) return;
            
            const { type, data } = lastAction;
            
            switch (type) {
                case 'add':
                    // Remove the program that was added
                    selectedPrograms = selectedPrograms.filter(p => p.id !== data.program.id);
                    break;
                case 'remove':
                    // Re-add the program that was removed
                    selectedPrograms.splice(data.index, 0, data.program);
                    break;
                case 'reorder':
                    // Restore original order
                    selectedPrograms = [...data.originalOrder];
                    break;
                case 'clear':
                    // Restore all cleared programs
                    selectedPrograms = [...data.programs];
                    break;
            }
            
            lastAction = null;
            updateSelectionPanel();
            renderPrograms();
            showNotification(' Undone', 'info');
        }
        
        // Handle program clicks
        function handleProgramClick(program, card) {
            const isSelected = selectedPrograms.some(p => p.id === program.id);
            
            if (isSelected) {
                // Check if this is a duplicate (same program added twice)
                const duplicateCount = selectedPrograms.filter(p => p.id === program.id).length;
                if (duplicateCount > 1) {
                    // This is a duplicate, confirm removal
                    if (!confirm(`"${program.name}" appears ${duplicateCount} times in your selection. Remove this instance?`)) {
                        return;
                    }
                }
                
                // Remove from selection
                const index = selectedPrograms.findIndex(p => p.id === program.id);
                saveUndoAction('remove', { program, index });
                selectedPrograms = selectedPrograms.filter(p => p.id !== program.id);
                card.classList.remove('primary');
                const badge = card.querySelector('.program-badge');
                if (badge) badge.remove();
            } else {
                // Check if trying to add a duplicate
                if (selectedPrograms.some(p => p.id === program.id)) {
                    if (!confirm(`"${program.name}" is already in your selection. Add it again?`)) {
                        return;
                    }
                }
                
                // Add to selection
                if (documentType === 'plans' && selectedPrograms.length >= 1) {
                    // For plans, replace the existing selection
                    selectedPrograms = [program];
                    // Update all cards
                    renderPrograms();
                } else {
                    selectedPrograms.push(program);
                    trackProgramUsage(program.id); // Track usage
                    saveUndoAction('add', { program });
                    card.classList.add('primary');
                    
                    const badge = document.createElement('div');
                    badge.className = 'program-badge';
                    badge.textContent = 'SELECTED';
                    card.appendChild(badge);
                }
            }
            
            updateSelectionPanel();
        }
        
        // Open preview modal
        function openPreview(programId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const program = programs.find(p => p.id === programId);
            if (!program) return;
            
            currentPreviewProgram = program;
            const modal = document.getElementById('previewModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalAddBtn = document.getElementById('modalAddBtn');
            
            // Update modal title
            modalTitle.textContent = `${program.name} - ${program.location}`;
            
            // Generate modal content
            let content = `
                <div class="preview-section">
                    <h3>Program Type</h3>
                    <p>${program.type}</p>
                    <p><strong>Category:</strong> ${program.programCategory}</p>
                </div>
                
                <div class="preview-section">
                    <h3>Level of Care & Services</h3>
                    <p>${program.levelOfCare}</p>
                </div>
                
                <div class="preview-section">
                    <h3>Program Features</h3>
                    <ul class="preview-features">
            `;
            
            program.features.forEach(feature => {
                const parts = feature.split(':');
                if (parts.length > 1) {
                    content += `<li><strong>${parts[0]}:</strong>${parts[1]}</li>`;
                } else {
                    content += `<li>${feature}</li>`;
                }
            });
            
            content += `
                    </ul>
                </div>
                
                <div class="preview-section">
                    <h3>Contact Information</h3>
                    <div class="preview-contact">
            `;
            
            if (program.contact.phone) {
                content += `<div><strong>Phone:</strong> ${program.contact.phone}</div>`;
            }
            if (program.contact.website) {
                const w = normalizeUrl(program.contact.website);
                const label = program.contact.website;
                content += `<div><strong>Website:</strong> <a href="${w}" target="_blank" rel="noopener">${label}</a></div>`;
            }
            if (program.contact.email) {
                content += `<div><strong>Email:</strong> ${program.contact.email}</div>`;
            }
            if (program.contact.address) {
                content += `<div><strong>Address:</strong> ${program.contact.address}</div>`;
            }
            
            content += `
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = content;
            
            // Update add button state
            const isSelected = selectedPrograms.some(p => p.id === programId);
            if (isSelected) {
                modalAddBtn.textContent = 'Remove from Selection';
                modalAddBtn.classList.add('selected');
            } else {
                modalAddBtn.textContent = 'Add to Selection';
                modalAddBtn.classList.remove('selected');
            }
            
            // Show modal
            modal.style.display = 'block';
        }
        
        // Close preview modal
        function closePreview() {
            const modal = document.getElementById('previewModal');
            modal.style.display = 'none';
            currentPreviewProgram = null;
        }
        
        // Toggle program from preview
        function toggleFromPreview() {
            if (!currentPreviewProgram) return;
            
            const isSelected = selectedPrograms.some(p => p.id === currentPreviewProgram.id);
            
            if (isSelected) {
                // Remove from selection
                selectedPrograms = selectedPrograms.filter(p => p.id !== currentPreviewProgram.id);
            } else {
                // Add to selection
                if (documentType === 'plans' && selectedPrograms.length >= 1) {
                    selectedPrograms = [currentPreviewProgram];
                } else {
                    selectedPrograms.push(currentPreviewProgram);
                }
            }
            
            // Update UI
            updateSelectionPanel();
            renderPrograms();
            
            // Update modal button
            const modalAddBtn = document.getElementById('modalAddBtn');
            if (!isSelected) {
                modalAddBtn.textContent = 'Remove from Selection';
                modalAddBtn.classList.add('selected');
            } else {
                modalAddBtn.textContent = 'Add to Selection';
                modalAddBtn.classList.remove('selected');
            }
        }
        
        // Show add custom program modal
        function showAddProgramDialog() {
            const modal = document.getElementById('addProgramModal');
            if (modal) {
                modal.style.display = 'block';
                modal.classList.add('show');
                // Default to manual mode
                setAddProgramMode('manual');
                // Ensure the button is visible
                setTimeout(() => {
                    const smartBtn = document.getElementById('smartFormatBtn');
                    if (smartBtn) {
                        smartBtn.style.display = 'inline-block';
                    }
                }, 100);
            }
        }
        
        // Set the mode for adding programs
        function setAddProgramMode(mode) {
            const manualBtn = document.getElementById('manualModeBtn');
            const templateBtn = document.getElementById('templateModeBtn');
            const manualContent = document.getElementById('manualModeContent');
            const templateContent = document.getElementById('templateModeContent');
            const smartBtn = document.getElementById('smartFormatBtn');
            const addTemplateBtn = document.getElementById('addTemplateBtn');
            
            // Reset all buttons
            manualBtn.style.background = '#e5e7eb';
            manualBtn.style.color = '#6b7280';
            templateBtn.style.background = '#e5e7eb';
            templateBtn.style.color = '#6b7280';
            
            // Hide all content
            manualContent.style.display = 'none';
            templateContent.style.display = 'none';
            
            // Hide all action buttons
            smartBtn.style.display = 'none';
            addTemplateBtn.style.display = 'none';
            
            if (mode === 'manual') {
                // Manual Mode
                manualBtn.style.background = '#4f46e5';
                manualBtn.style.color = 'white';
                manualContent.style.display = 'block';
                if (smartBtn) smartBtn.style.display = 'inline-block';
                const textarea = document.getElementById('customProgramInfo');
                if (textarea) textarea.focus();
            } else if (mode === 'template') {
                // Template Mode
                templateBtn.style.background = '#4f46e5';
                templateBtn.style.color = 'white';
                templateContent.style.display = 'block';
                if (addTemplateBtn) addTemplateBtn.style.display = 'inline-block';
                const nameInput = document.getElementById('templateName');
                if (nameInput) nameInput.focus();
            }
        }
        
        // Update progress tracker
        function updateProgress(step, status, message, time) {
            const stepEl = document.getElementById(`step${step}`);
            if (!stepEl) return;
            
            const icon = stepEl.querySelector('.step-icon');
            const text = stepEl.querySelector('.step-text');
            const timeEl = stepEl.querySelector('.step-time');
            
            stepEl.style.opacity = '1';
            
            if (status === 'working') {
                icon.innerHTML = '';
                icon.style.animation = 'spin 1s linear infinite';
            } else if (status === 'done') {
                icon.innerHTML = '';
                icon.style.animation = 'none';
                if (time) timeEl.innerHTML = time;
            } else if (status === 'error') {
                icon.innerHTML = '';
                icon.style.animation = 'none';
                stepEl.style.color = '#ff6b6b';
            }
            
            if (message) text.innerHTML = message;
        }
        
        // Add log to progress details
        function addProgressLog(message) {
            const details = document.getElementById('progressDetails');
            details.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            details.innerHTML += `[${timestamp}] ${message}\n`;
            details.scrollTop = details.scrollHeight;
        }
        
        // Close add program modal
        function closeAddProgramModal() {
            const modal = document.getElementById('addProgramModal');
            if (modal) {
                modal.classList.remove('show');
                // Also try setting display none as fallback
                modal.style.display = 'none';
                // Clear the form
                document.getElementById('customProgramInfo').value = '';
                // Reset any status messages
                const statusDiv = document.getElementById('customProgramStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '';
                }
            }
        }
        
        // Add custom program to selection
        // New unified extraction function
        async function extractProgram() {
            const aiContent = document.getElementById('aiModeContent');
            const isAIMode = aiContent.style.display !== 'none';
            
            if (isAIMode) {
                // AI Mode - extract from URL
                const url = document.getElementById('programUrl').value.trim();
                if (!url) {
                    alert('Please enter a website URL');
                    return;
                }
                
                // Show progress tracker
                const tracker = document.getElementById('aiProgressTracker');
                tracker.style.display = 'block';
                document.getElementById('progressDetails').innerHTML = '';
                document.getElementById('progressError').style.display = 'none';
                
                // Reset all steps
                for (let i = 1; i <= 4; i++) {
                    updateProgress(i, 'pending', null, '');
                }
                
                const startTime = Date.now();
                
                try {
                    // Step 1: Validate URL
                    updateProgress(1, 'working', 'Validating URL format...');
                    addProgressLog('Starting URL validation...');
                    
                    if (!url.match(/^https?:\/\/.+/)) {
                        throw new Error('Invalid URL format. Please include http:// or https://');
                    }
                    
                    updateProgress(1, 'done', 'URL validated', `${Date.now() - startTime}ms`);
                    addProgressLog(` Valid URL: ${url}`);
                    
                    // Step 2: Deep website analysis
                    updateProgress(2, 'working', 'Analyzing website pages...');
                    addProgressLog('Starting deep website crawl and analysis...');
                    
                    const programName = url.split('/')[2].replace('www.', '').replace('.com', '').replace('.org', '');
                    
                    // Make addProgressLog available globally for nested functions
                    window.addProgressLog = addProgressLog;
                    window.updateProgress = updateProgress;
                    
                    // Simulate deep crawling with progress updates
                    const crawlPages = [
                        'Homepage', 'About Us', 'Clinical Program', 'Admissions',
                        'Academic Program', 'Staff & Credentials', 'Parent Resources',
                        'Treatment Approach', 'Daily Schedule', 'Contact Information'
                    ];
                    
                    // Show crawling progress
                    for (let i = 0; i < crawlPages.length; i++) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        addProgressLog(` Analyzing: ${crawlPages[i]}...`);
                        updateProgress(2, 'working', `Analyzing ${crawlPages[i]}... (${i+1}/${crawlPages.length})`);
                    }
                    
                    const websiteData = await analyzeWebsiteUrl(url, programName);
                    
                    if (websiteData) {
                        updateProgress(2, 'done', 'Website content retrieved', `${Date.now() - startTime}ms`);
                        addProgressLog(' Successfully fetched website content');
                        
                        // Step 3: AI Analysis
                        updateProgress(3, 'working', 'Analyzing with AI model...');
                        addProgressLog('Sending to AI for analysis...');
                        
                        // Step 4: Format data
                        updateProgress(4, 'working', 'Formatting program data...');
                        
                        if (websiteData.Confidence && websiteData.Confidence !== 'low') {
                            updateProgress(3, 'done', 'AI analysis complete', `${Date.now() - startTime}ms`);
                            updateProgress(4, 'done', 'Data formatted successfully', `${Date.now() - startTime}ms`);
                            addProgressLog(' Program data extracted successfully!');
                            
                            // Show preview
                            showAIPreview(websiteData, websiteData.Confidence || 'medium', url);
                        } else {
                            updateProgress(3, 'done', 'AI analysis complete (low confidence)');
                            updateProgress(4, 'done', 'Manual review recommended');
                            addProgressLog(' Low confidence - manual review recommended');
                            showHybridOption(websiteData, url);
                        }
                    } else {
                        updateProgress(2, 'error', 'Failed to fetch website');
                        addProgressLog(' Failed to fetch website content');
                        
                        // Check if API key is configured before trying direct analysis
                        let OPENAI_KEY = localStorage.getItem('openai_api_key') || OPENAI_API_KEY;
                        let ANTHROPIC_KEY = localStorage.getItem('anthropic_api_key') || ANTHROPIC_API_KEY;
                        
                        if ((!OPENAI_KEY || OPENAI_KEY === 'YOUR_OPENAI_API_KEY_HERE') && 
                            (!ANTHROPIC_KEY || ANTHROPIC_KEY === 'YOUR_ANTHROPIC_API_KEY_HERE')) {
                            // No API key configured
                            updateProgress(3, 'error', 'API key not configured');
                            updateProgress(4, 'error', 'Skipped');
                            
                            document.getElementById('progressError').style.display = 'block';
                            document.getElementById('progressError').innerHTML = `
                                <div style="padding: 10px;">
                                    <strong> AI Not Configured</strong><br>
                                    <p style="margin: 10px 0;">To extract program information, you need an API key.</p>
                                    <input type="text" id="quickApiKey" placeholder="Enter OpenAI or Anthropic API key..." style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid white; border-radius: 4px;">
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="
                                            const key = document.getElementById('quickApiKey').value;
                                            if (key.startsWith('sk-ant')) {
                                                localStorage.setItem('anthropic_api_key', key);
                                            } else {
                                                localStorage.setItem('openai_api_key', key);
                                            }
                                            document.getElementById('progressError').innerHTML = ' Key saved! Retrying...';
                                            setTimeout(() => extractProgram(), 1000);
                                        " style="background: white; color: #667eea; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Save & Retry</button>
                                        <button onclick="setAddProgramMode('manual')" style="background: rgba(255,255,255,0.2); color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;">Switch to Manual</button>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Try direct AI analysis
                            updateProgress(3, 'working', 'Trying AI inference from URL...');
                            addProgressLog('Attempting direct AI analysis from URL...');
                            const directData = await analyzeUrlDirectly(url, programName);
                            
                            if (directData) {
                                updateProgress(3, 'done', 'AI inference successful');
                                updateProgress(4, 'done', 'Ready for review');
                                addProgressLog(' AI was able to infer program information from URL');
                                showHybridOption(directData, url);
                            } else {
                                updateProgress(3, 'error', 'AI analysis failed');
                                updateProgress(4, 'error', 'Skipped');
                                document.getElementById('progressError').style.display = 'block';
                                document.getElementById('progressError').innerHTML = `
                                    <div style="padding: 10px;">
                                        <strong>Unable to extract from this website</strong><br>
                                        <p style="margin: 10px 0;">The website may have blocking mechanisms. Please try:</p>
                                        <button onclick="setAddProgramMode('manual')" style="background: white; color: #667eea; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                                             Switch to Manual Entry
                                        </button>
                                    </div>
                                `;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Extraction error:', error);
                    updateProgress(1, 'error', error.message);
                    document.getElementById('progressError').style.display = 'block';
                    document.getElementById('progressError').innerHTML = error.message;
                    addProgressLog(` Error: ${error.message}`);
                }
            } else {
                // Check which mode we're in
                const manualContent = document.getElementById('manualModeContent');
                const templateContent = document.getElementById('templateModeContent');
                
                if (manualContent.style.display !== 'none') {
                    // Manual Mode - use existing addCustomProgram logic
                    await addCustomProgram();
                } else if (templateContent.style.display !== 'none') {
                    // Template Mode - collect form data
                    await addTemplateProgram();
                }
            }
        }
        
        // Add custom program from user input (now used for manual mode)
        async function addCustomProgram() {
            const programInfo = document.getElementById('customProgramInfo').value;
            const clientName = document.getElementById('clientName').value;
            
            if (!programInfo) {
                alert('Please paste program information!');
                return;
            }
            
            // Show loading state
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = ' AI is analyzing the program information...';
            statusDiv.style.color = '#0099cc';
            
                // Check if API key is configured (from localStorage or input)
                let OPENAI_KEY = localStorage.getItem('openai_api_key') || 
                               document.getElementById('openaiApiKey')?.value || 
                               OPENAI_API_KEY;
                let ANTHROPIC_KEY = localStorage.getItem('anthropic_api_key') || 
                                   document.getElementById('anthropicApiKey')?.value || 
                                   ANTHROPIC_API_KEY;
                
                if ((!OPENAI_KEY || OPENAI_KEY === 'YOUR_OPENAI_API_KEY_HERE') && 
                    (!ANTHROPIC_KEY || ANTHROPIC_KEY === 'YOUR_ANTHROPIC_API_KEY_HERE')) {
                    statusDiv.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 15px; margin: 10px 0;">
                            <div style="color: #dc2626; font-weight: bold; margin-bottom: 10px;"> AI Not Configured</div>
                            <div style="color: #7f1d1d; margin-bottom: 10px;">To use AI extraction, you need an API key from OpenAI or Anthropic. Your key will be saved locally for future use.</div>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">OpenAI API Key (GPT-3.5/4):</label>
                                <input type="text" id="openaiApiKey" placeholder="sk-..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;">
                                
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">OR Anthropic API Key (Claude):</label>
                                <input type="text" id="anthropicApiKey" placeholder="sk-ant-..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="
                                    const openKey = document.getElementById('openaiApiKey').value;
                                    const anthKey = document.getElementById('anthropicApiKey').value;
                                    if (openKey) localStorage.setItem('openai_api_key', openKey);
                                    if (anthKey) localStorage.setItem('anthropic_api_key', anthKey);
                                    if (openKey || anthKey) {
                                        document.getElementById('customProgramStatus').innerHTML = ' API Key saved! Try adding the program again.';
                                        setTimeout(() => { addCustomProgram(); }, 1000);
                                    }
                                " style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Save & Continue</button>
                                <button onclick="window.open('https://platform.openai.com/api-keys', '_blank')" style="background: #10a37f; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Get OpenAI Key</button>
                                <button onclick="window.open('https://console.anthropic.com/account/keys', '_blank')" style="background: #D97757; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Get Claude Key</button>
                                <button onclick="showHybridTool(document.getElementById('customProgramInfo').value, false)" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Manual Entry</button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                try {
                    // Try AI extraction first
                    let extractedData = null;
                    let aiConfidence = 'low';
                    
                    // Check if it's a URL
                    const urlPattern = /https?:\/\/[^\s]+/;
                    const urlMatch = programInfo.match(urlPattern);
                    
                    if (urlMatch) {
                        // It's a URL - try AI website analysis
                        const programName = programInfo.split('\n')[0] || urlMatch[0].split('/')[2] || 'Unknown Program';
                        statusDiv.innerHTML = ' AI is analyzing website...';
                        extractedData = await analyzeWebsiteUrl(urlMatch[0], programName);
                        
                        if (extractedData && extractedData.Confidence) {
                            aiConfidence = extractedData.Confidence;
                        }
                    } else {
                        // It's text content - extract directly
                        const programName = programInfo.split('\n')[0] || 'Unknown Program';
                        statusDiv.innerHTML = ' AI is processing text...';
                        extractedData = await extractProgramData(programInfo, programName);
                        aiConfidence = 'high'; // Text analysis is usually more reliable
                    }
                    
                    // Show preview and options based on AI success
                    if (extractedData && aiConfidence !== 'low') {
                        // AI succeeded - show preview with option to use or improve
                        showAIPreview(extractedData, aiConfidence, programInfo);
                    } else if (extractedData && aiConfidence === 'low') {
                        // AI partially succeeded but low confidence - offer hybrid approach
                        showHybridOption(extractedData, programInfo);
                } else {
                        // AI failed - go directly to hybrid approach
                        statusDiv.innerHTML = ' AI analysis failed - switching to Hybrid AI Tool...';
                        showHybridTool(programInfo, false);
                    }
                
                // Function ends here - all program creation is handled in acceptAIExtraction()
                return;
                
            } catch (error) {
                console.error('Error in addCustomProgram:', error);
                const statusDiv = document.getElementById('customProgramStatus');
                statusDiv.innerHTML = ' Error occurred. Please try the Hybrid AI Tool.';
                statusDiv.style.color = '#ef4444';
                showHybridTool(programInfo, false);
            }
        }
        
        // Add template-based program
        async function addTemplateProgram() {
            // Collect all form data
            const programData = {
                'Program Name': document.getElementById('templateName').value.trim(),
                'Location': document.getElementById('templateLocation').value.trim(),
                'Phone Number': document.getElementById('templatePhone').value.trim(),
                'Email': document.getElementById('templateEmail').value.trim(),
                'Level of Care': document.getElementById('templateLevel').value.trim(),
                'Age Range': document.getElementById('templateAges').value.trim(),
                'Primary Issues Treated': document.getElementById('templateSpecialties').value.trim(),
                'Specialized Therapies': document.getElementById('templateModalities').value.trim(),
                'Insurance Accepted': document.getElementById('templateInsurance').value.trim(),
                'Program Philosophy': document.getElementById('templateDescription').value.trim(),
                'Website': document.getElementById('templateWebsite').value.trim()
            };
            
            // Validate required fields
            if (!programData['Program Name']) {
                alert('Please enter the program name');
                return;
            }
            
            // Format the extracted data in the same format as AI extraction
            const formattedData = `
**THERAPEUTIC SCHOOL PROFILE**
**${programData['Program Name'].toUpperCase()}**

**PROGRAM OVERVIEW:**
Program Name: ${programData['Program Name']}
Location: ${programData['Location'] || 'Not specified'}
Phone Number: ${programData['Phone Number'] || 'Not specified'}
Email: ${programData['Email'] || 'Not specified'}
Website: ${programData['Website'] || 'Not specified'}
Level of Care: ${programData['Level of Care'] || 'Not specified'}

**TARGET POPULATION:**
Age Range: ${programData['Age Range'] || 'Not specified'}

**CLINICAL SERVICES:**
Primary Issues Treated: ${programData['Primary Issues Treated'] || 'Not specified'}
Specialized Therapies: ${programData['Specialized Therapies'] || 'Not specified'}

**PROGRAM DETAILS:**
${programData['Program Philosophy'] || 'No description provided'}

**INSURANCE & PAYMENT:**
${programData['Insurance Accepted'] || 'Not specified'}

---

*Profile compiled for educational consultant review. All information should be verified directly with the program.*
`;
            
            // Show the formatted result
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 16px;"></span>
                        <strong style="margin-left: 8px; color: #16a34a;">Program Formatted Successfully!</strong>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
${formattedData.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="
                            navigator.clipboard.writeText(\`${formattedData.replace(/`/g, '\\`')}\`).then(() => {
                                alert('Program profile copied to clipboard!');
                            });
                        " style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Copy to Clipboard
                        </button>
                        <button onclick="
                            // Set the extracted data in the correct format
                            window.currentAIExtraction = ${JSON.stringify(programData)};
                            acceptAIExtraction();
                        " style="background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Add to Selection
                        </button>
                        <button onclick="document.getElementById('addProgramModal').style.display='none';" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Smart Format - Pattern-based extraction without AI
        async function smartFormatProgram() {
            let programInfo = document.getElementById('customProgramInfo').value.trim();
            
            if (!programInfo) {
                alert('Please paste program information!');
                return;
            }
            
            // Strip out any "ADDITIONAL DETAILS FROM WEBSITE" sections
            programInfo = programInfo.replace(/\*\*ADDITIONAL DETAILS FROM WEBSITE:\*\*[\s\S]*$/i, '');
            programInfo = programInfo.replace(/ADDITIONAL DETAILS FROM WEBSITE:[\s\S]*$/i, '');
            programInfo = programInfo.replace(/From [A-Z].*? Page:[\s\S]*?(?=\n\n|$)/gi, '');
            programInfo = programInfo.trim();
            
            // Show processing status
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = ' Analyzing and formatting program information...';
            statusDiv.style.color = '#0099cc';
            
            // Extract information using patterns
            const extractedData = extractProgramInfoSmart(programInfo);
            
            // Format according to Family First structure
            const formattedOutput = formatToFamilyFirstStructure(extractedData);
            
            // Show the formatted result
            statusDiv.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 16px;"></span>
                        <strong style="margin-left: 8px; color: #16a34a;">Program Formatted Successfully!</strong>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; margin: 10px 0; font-family: 'Calibri', sans-serif; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
${formattedOutput.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="
                            navigator.clipboard.writeText(\`${formattedOutput.replace(/`/g, '\\`').replace(/'/g, "\\'")}\`).then(() => {
                                alert('Program profile copied to clipboard!');
                            });
                        " style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Copy to Clipboard
                        </button>
                        <button onclick="
                            // Convert formatted text to structured data for document addition
                            const data = ${JSON.stringify(extractedData).replace(/"/g, '&quot;')};
                            window.currentAIExtraction = data;
                            acceptAIExtraction();
                        " style="background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Add to Selection
                        </button>
                        <button onclick="document.getElementById('addProgramModal').style.display='none';" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Smart extraction using patterns (no AI needed)
        function extractProgramInfoSmart(text) {
            const data = {};
            
            // Clean up markdown formatting from Chrome extension
            text = text.replace(/\*\*/g, ''); // Remove bold markers
            text = text.replace(/\n\s*\n/g, '\n'); // Remove extra blank lines
            
            // Check if this is Chrome extension formatted data
            const hasExtensionFormat = text.includes('TARGET POPULATION:') || 
                                      text.includes('CLINICAL SERVICES:') || 
                                      text.includes('ACCREDITATIONS:');
            
            if (hasExtensionFormat) {
                // Parse Chrome extension sections
                const sections = {
                    'TARGET POPULATION': /TARGET POPULATION:\s*([^A-Z]+(?:\n(?![A-Z]+:)[^\n]+)*)/,
                    'CLINICAL SERVICES': /CLINICAL SERVICES:\s*([^A-Z]+(?:\n(?![A-Z]+:)[^\n]+)*)/,
                    'ACCREDITATIONS': /ACCREDITATIONS:\s*([^A-Z]+(?:\n(?![A-Z]+:)[^\n]+)*)/,
                    'WHAT MAKES': /WHAT MAKES THIS PROGRAM UNIQUE:\s*([^A-Z]+(?:\n(?![A-Z]+:)[^\n]+)*)/
                };
                
                for (const [key, pattern] of Object.entries(sections)) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data[key] = match[1].trim();
                    }
                }
            }
            
            // Extract program philosophy or mission statement
            const philosophyPatterns = [
                /(?:our mission|we believe|our philosophy|our approach)[:.]?\s*([^.]+\.)/i,
                /(?:committed to|dedicated to|focused on)\s+([^.]+\.)/i
            ];
            for (const pattern of philosophyPatterns) {
                const match = text.match(pattern);
                if (match) {
                    data['Philosophy'] = match[1].trim();
                    break;
                }
            }
            
            // Extract unique program elements
            const programElements = [];
            if (/small group/i.test(text)) programElements.push('small group sizes');
            if (/gender[- ]specific/i.test(text)) programElements.push('gender-specific programming');
            if (/co[- ]ed/i.test(text)) programElements.push('co-educational environment');
            if (/faith[- ]based/i.test(text)) programElements.push('faith-based approach');
            if (/12[- ]step/i.test(text)) programElements.push('12-step integration');
            if (/experiential/i.test(text)) programElements.push('experiential therapy');
            if (/mindfulness/i.test(text)) programElements.push('mindfulness practices');
            if (/yoga/i.test(text)) programElements.push('yoga therapy');
            if (/nutrition/i.test(text)) programElements.push('nutritional counseling');
            if (/fitness|gym|exercise/i.test(text)) programElements.push('fitness programming');
            
            if (programElements.length > 0) {
                data['Program Elements'] = programElements;
            }
            
            // Extract setting/environment details
            if (/(?:acre|campus|facility|located)/i.test(text)) {
                const settingMatch = text.match(/(\d+[- ]?acre[s]?|beautiful campus|scenic|mountain|beach|rural|urban)[^.]*(?:campus|facility|setting|location)/i);
                if (settingMatch) {
                    data['Setting'] = settingMatch[0].trim();
                }
            }
            
            // Extract Program Name - Multiple patterns
            const namePatterns = [
                /^([A-Z][A-Za-z\s&'-]+?)(?:\n|$)/m, // First line is often the name
                /Program Name:\s*([^\n]+)/i,
                /^([A-Z][A-Za-z\s&'-]+?)(?:\s*[-]\s*|\s+(?:is|provides|offers))/m,
                /(?:program|school|academy|center|institute):\s*([A-Za-z\s&'-]+)/i
            ];
            
            for (const pattern of namePatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    data['Program Name'] = match[1].trim();
                    break;
                }
            }
            
            // Extract Location - Check standard format first
            const standardLocation = text.match(/Location:\s*([^\n]+)/i);
            if (standardLocation) {
                data['Location'] = standardLocation[1].trim();
            } else {
                const locationPatterns = [
                    /(?:located in|location:|address:)\s*([A-Za-z\s,]+(?:,\s*[A-Z]{2})?)/i,
                    /([A-Za-z\s]+,\s*[A-Z]{2})\s*\d{5}/,
                    /\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*,\s*[A-Z]{2})\b/
                ];
                for (const pattern of locationPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        data['Location'] = match[1].trim();
                        break;
                    }
                }
            }
            
            // Extract Phone Number - Check standard format first
            const standardPhone = text.match(/Phone:\s*([\d\s().-]+)/i);
            if (standardPhone) {
                data['Phone Number'] = standardPhone[1].trim();
            } else {
                const phonePattern = /(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g;
                const phones = text.match(phonePattern);
                if (phones && phones.length > 0) {
                    data['Phone Number'] = phones[0].trim();
                }
            }
            
            // Extract Website - Check standard format first
            const standardWebsite = text.match(/Website:\s*([^\n]+)/i);
            if (standardWebsite) {
                data['Website'] = standardWebsite[1].trim().replace(/^(www\.|https?:\/\/)/, '');
            } else {
                const websitePattern = /(?:website:|visit us at:?\s*|www\.|https?:\/\/)([a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/i;
                const websiteMatch = text.match(websitePattern);
                if (websiteMatch) {
                    data['Website'] = websiteMatch[1].replace(/^(www\.|https?:\/\/)/, '');
                }
            }
            
            // Extract Level of Care - Handle Chrome extension format
            const locPatterns = [
                /(?:level of care|program type|we offer|provides?):\s*([^.\n]+)/i,
                /\b(residential(?:\s+treatment)?|RTC|PHP|IOP|outpatient|wilderness|therapeutic boarding school)\b/i,
                /^(residential|PHP|IOP|outpatient|wilderness)/im
            ];
            for (const pattern of locPatterns) {
                const match = text.match(pattern);
                if (match) {
                    let levelOfCare = match[1].trim();
                    // Clean up common phrases
                    levelOfCare = levelOfCare.replace(/treatment center/i, 'Treatment');
                    levelOfCare = levelOfCare.replace(/program/i, '');
                    data['Level of Care'] = levelOfCare.trim();
                    break;
                }
            }
            
            // Extract Age Range/Population - Use Chrome extension data if available
            if (data['TARGET POPULATION']) {
                const targetPop = data['TARGET POPULATION'];
                // Extract age range
                const ageMatch = targetPop.match(/(?:ages?\s*)?(\d+[-]\d+)/i);
                if (ageMatch) {
                    data['Population'] = `adolescents ages ${ageMatch[1].replace(/[-]/, '-')}`;
                }
                // Extract specializations from target population
                const issues = targetPop.match(/(?:trauma|anxiety|depression|ADHD|substance|eating disorder|self-harm|behavioral issues|autism|ASD)/gi);
                if (issues && issues.length > 0) {
                    data['Specializations'] = [...new Set(issues)].slice(0, 3).join(', ').toLowerCase();
                }
            } else {
                // Fallback to pattern matching
                const agePatterns = [
                    /(?:ages?|serving|for)\s*(\d+[-]\d+)/i,
                    /(?:adolescents?|teens?|young adults?)\s*(?:\()?(\d+[-]\d+)(?:\))?/i,
                    /\b(adolescents?|teenagers?|young adults?|boys|girls|co-?ed)\b/i
                ];
                for (const pattern of agePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        data['Population'] = match[0].trim();
                        break;
                    }
                }
            }
            
            // Extract Therapeutic Modalities - Use Chrome extension data if available
            if (data['CLINICAL SERVICES']) {
                const services = data['CLINICAL SERVICES'];
                const therapies = [];
                
                // Extract specific therapy types from clinical services
                const therapyPatterns = [
                    { pattern: /\bCBT\b/i, name: 'CBT' },
                    { pattern: /\bDBT\b/i, name: 'DBT' },
                    { pattern: /\bEMDR\b/i, name: 'EMDR' },
                    { pattern: /\bACT\b/i, name: 'ACT' },
                    { pattern: /Art Therapy/i, name: 'Art Therapy' },
                    { pattern: /Equine/i, name: 'Equine Therapy' },
                    { pattern: /Family Therapy/i, name: 'Family Therapy' },
                    { pattern: /Group Therapy/i, name: 'Group Therapy' },
                    { pattern: /Individual Therapy/i, name: 'Individual Therapy' },
                    { pattern: /Trauma[- ]Informed/i, name: 'Trauma-Informed Care' }
                ];
                
                therapyPatterns.forEach(({ pattern, name }) => {
                    if (pattern.test(services)) {
                        therapies.push(name);
                    }
                });
                
                if (therapies.length > 0) {
                    data['Clinical Modalities'] = therapies.slice(0, 5).join(', ');
                }
            } else {
                // Fallback to searching entire text
                const therapyTypes = [
                    'CBT', 'DBT', 'EMDR', 'ACT', 'ART', 'NARM', 'IFS', 'Somatic',
                    'Cognitive Behavioral Therapy', 'Dialectical Behavior Therapy',
                    'Eye Movement Desensitization', 'Acceptance and Commitment',
                    'Neurofeedback', 'Biofeedback', 'Equine', 'Adventure',
                    'Art Therapy', 'Music Therapy', 'Drama Therapy',
                    'Group Therapy', 'Individual Therapy', 'Family Therapy'
                ];
                
                const foundTherapies = [];
                therapyTypes.forEach(therapy => {
                    const regex = new RegExp(`\\b${therapy}\\b`, 'i');
                    if (regex.test(text)) {
                        foundTherapies.push(therapy);
                    }
                });
                
                if (foundTherapies.length > 0) {
                    data['Clinical Modalities'] = foundTherapies.slice(0, 5).join(', ');
                }
            }
            
            // Extract unique features - Use Chrome extension data if available
            const uniqueFeatures = [];
            
            // Check WHAT MAKES section first
            if (data['WHAT MAKES']) {
                const uniqueText = data['WHAT MAKES'];
                
                // Extract key features from unique section
                if (/equine|horse|animal/i.test(uniqueText)) {
                    uniqueFeatures.push('Equine-assisted therapy');
                }
                if (/NARM/i.test(uniqueText)) {
                    uniqueFeatures.push('NARM-certified trauma treatment');
                }
                if (/specialized.*autism|ASD/i.test(uniqueText)) {
                    uniqueFeatures.push('Specialized autism program');
                }
            }
            
            // Also check the full text for additional features
            const fullText = text + (data['WHAT MAKES'] || '');
            
            if (/\b(?:ranch|farm|equine|horse)\b/i.test(fullText) && !uniqueFeatures.includes('Equine-assisted therapy')) {
                uniqueFeatures.push('Equine-assisted therapy');
            }
            if (/\b(?:wilderness|outdoor|adventure|expedition)\b/i.test(fullText)) {
                uniqueFeatures.push('Wilderness therapy');
            }
            if (/\b(?:autism|ASD|spectrum)\b/i.test(fullText) && !uniqueFeatures.includes('Specialized autism program')) {
                uniqueFeatures.push('Autism spectrum support');
            }
            if (/\b(?:LGBTQ|gender|transgender)\b/i.test(fullText)) {
                uniqueFeatures.push('LGBTQ+ affirming');
            }
            if (/\b(?:adoption|attachment|RAD)\b/i.test(fullText)) {
                uniqueFeatures.push('Adoption/attachment focus');
            }
            if (/\b(?:accredited school|academic|college prep)\b/i.test(fullText)) {
                uniqueFeatures.push('Accredited academic program');
            }
            if (/trauma[- ]informed/i.test(fullText)) {
                uniqueFeatures.push('Trauma-informed care');
            }
            
            if (uniqueFeatures.length > 0) {
                data['Unique Features'] = uniqueFeatures;
            }
            
            // Clean up Chrome extension data from main data object
            delete data['TARGET POPULATION'];
            delete data['CLINICAL SERVICES'];
            delete data['ACCREDITATIONS'];
            delete data['WHAT MAKES'];
            
            // Extract any additional details that don't fit categories
            data['Additional Info'] = text;
            
            return data;
        }
        
        // Format extracted data according to Family First structure
        function formatToFamilyFirstStructure(data) {
            let output = '';
            
            // 1. Title (Calibri 10 Bold) - Clean and simple
            const programName = data['Program Name'] || 'Treatment Program';
            const location = data['Location'] || '';
            output += `${programName}${location ? '  ' + location : ''}\n\n`;
            
            // 2. Level of Care & Services Provided - Create unique, dynamic descriptions
            output += 'Level of Care & Services Provided:\n';
            const loc = data['Level of Care'] || 'Therapeutic program';
            const pop = data['Population'] || 'adolescents and young adults';
            
            // Create varied, program-specific descriptions based on extracted details
            let description = '';
            
            // Build a unique description based on what we know about the program
            const descriptors = [];
            
            // Start with program type variations
            if (loc.toLowerCase().includes('residential')) {
                const residentialVariations = [
                    `comprehensive residential treatment facility`,
                    `therapeutic residential community`,
                    `intensive residential treatment center`,
                    `specialized residential program`
                ];
                descriptors.push(residentialVariations[Math.floor(Math.random() * residentialVariations.length)]);
            } else if (loc.toLowerCase().includes('php')) {
                descriptors.push('Partial Hospitalization Program');
            } else if (loc.toLowerCase().includes('iop')) {
                descriptors.push('Intensive Outpatient Program');
            } else if (loc.toLowerCase().includes('wilderness')) {
                descriptors.push('wilderness therapy experience');
            } else if (loc.toLowerCase().includes('boarding')) {
                descriptors.push('therapeutic boarding school');
            } else {
                descriptors.push(loc);
            }
            
            // Add unique program characteristics
            if (data['Unique Features'] && data['Unique Features'].length > 0) {
                const feature = data['Unique Features'][0];
                if (feature.includes('equine')) {
                    description = `This ${descriptors[0]} integrates equine-assisted psychotherapy within their clinical model, serving ${pop}`;
                } else if (feature.includes('wilderness')) {
                    description = `An experiential ${descriptors[0]} utilizing nature-based interventions for ${pop}`;
                } else if (feature.includes('autism')) {
                    description = `A specialized ${descriptors[0]} designed specifically for ${pop} on the autism spectrum`;
                } else if (feature.includes('trauma')) {
                    description = `A trauma-focused ${descriptors[0]} providing specialized care for ${pop}`;
                } else {
                    description = `This ${descriptors[0]} offers individualized treatment for ${pop}`;
                }
            } else {
                // Default varied descriptions
                const templates = [
                    `This ${descriptors[0]} provides evidence-based treatment for ${pop}`,
                    `A ${descriptors[0]} offering comprehensive therapeutic services for ${pop}`,
                    `This ${descriptors[0]} specializes in treating ${pop}`,
                    `An innovative ${descriptors[0]} designed for ${pop}`
                ];
                description = templates[Math.floor(Math.random() * templates.length)];
            }
            
            // Add specialization details with varied language
            if (data['Specializations']) {
                const specialtyIntros = [
                    `. The program focuses on`,
                    `. Areas of clinical expertise include`,
                    `. Specialized treatment for`,
                    `. Primary treatment focus includes`,
                    `. Clinical specializations include`
                ];
                description += specialtyIntros[Math.floor(Math.random() * specialtyIntros.length)] + ` ${data['Specializations'].toLowerCase()}`;
            }
            
            // Add outcome or philosophy if detected
            if (data['Additional Info']) {
                if (/evidence-based/i.test(data['Additional Info'])) {
                    description += ', utilizing evidence-based practices';
                }
                if (/family/i.test(data['Additional Info']) && !description.includes('family')) {
                    description += ' with strong family involvement';
                }
                if (/holistic/i.test(data['Additional Info'])) {
                    description += ' through a holistic treatment approach';
                }
            }
            
            output += description + '.\n\n';
            
            // 3. Program Details / Differentiating Features (Calibri 9, bullets)
            output += 'Program Details / Differentiating Features:\n';
            
            // Create dynamic, varied bullet points based on program specifics
            const bullets = [];
            
            // Vary the clinical approach descriptions
            if (data['Clinical Modalities']) {
                const clinicalIntros = [
                    'Treatment Modalities',
                    'Therapeutic Approaches',
                    'Clinical Framework',
                    'Evidence-Based Interventions',
                    'Core Therapies'
                ];
                const intro = clinicalIntros[Math.floor(Math.random() * clinicalIntros.length)];
                bullets.push(`${intro}: ${data['Clinical Modalities']}`);
            } else {
                // Generate varied default clinical descriptions
                const defaultClinical = [
                    'Comprehensive clinical programming including individual, group, and family therapy',
                    'Multi-modal therapeutic approach with individualized treatment planning',
                    'Evidence-based therapeutic interventions tailored to each client\'s needs',
                    'Integrated treatment model combining individual and group modalities'
                ];
                bullets.push(defaultClinical[Math.floor(Math.random() * defaultClinical.length)]);
            }
            
            // Add unique program-specific details based on features
            if (data['Unique Features'] && data['Unique Features'].length > 0) {
                data['Unique Features'].forEach(feature => {
                    if (feature.includes('equine')) {
                        bullets.push('Equine-Assisted Psychotherapy: Therapeutic work with horses to develop emotional regulation and relationship skills');
                    } else if (feature.includes('wilderness')) {
                        bullets.push('Adventure-Based Programming: Wilderness expeditions and challenge course activities for personal growth');
                    } else if (feature.includes('autism')) {
                        bullets.push('Neurodiversity Support: Specialized programming for teens on the autism spectrum with sensory accommodations');
                    } else if (feature.includes('LGBTQ')) {
                        bullets.push('Affirming Environment: LGBTQ+ supportive with gender-affirming care and specialized support groups');
                    } else if (feature.includes('trauma')) {
                        bullets.push('Trauma-Responsive Care: Specialized trauma treatment including EMDR and somatic approaches');
                    } else if (feature.includes('academic')) {
                        bullets.push('Academic Support: Accredited on-site school with individualized education plans and college prep');
                    }
                });
            }
            
            // Add population/specialization details with variety
            if (data['Specializations']) {
                const specIntros = [
                    'Clinical Focus Areas',
                    'Areas of Expertise',
                    'Treatment Specializations',
                    'Primary Treatment Targets',
                    'Specialized Programming'
                ];
                const intro = specIntros[Math.floor(Math.random() * specIntros.length)];
                bullets.push(`${intro}: ${data['Specializations']}`);
            }
            
            // Add program philosophy if extracted
            if (data['Philosophy'] && bullets.length < 6) {
                bullets.push(`Treatment Philosophy: ${data['Philosophy']}`);
            }
            
            // Add program elements with contextual descriptions
            if (data['Program Elements'] && data['Program Elements'].length > 0) {
                const elements = data['Program Elements'];
                
                // Group related elements
                const therapeuticElements = elements.filter(e => 
                    e.includes('therapy') || e.includes('mindfulness') || e.includes('yoga') || e.includes('experiential')
                );
                const structuralElements = elements.filter(e => 
                    e.includes('group sizes') || e.includes('gender') || e.includes('co-ed') || e.includes('12-step')
                );
                const supportElements = elements.filter(e => 
                    e.includes('nutrition') || e.includes('fitness') || e.includes('faith')
                );
                
                if (therapeuticElements.length > 0) {
                    bullets.push(`Complementary Therapies: ${therapeuticElements.join(', ')}`);
                }
                if (structuralElements.length > 0) {
                    bullets.push(`Program Structure: ${structuralElements.join(', ')}`);
                }
                if (supportElements.length > 0) {
                    bullets.push(`Wellness Support: ${supportElements.join(', ')}`);
                }
            }
            
            // Add setting/environment if unique
            if (data['Setting'] && bullets.length < 6) {
                bullets.push(`Treatment Setting: ${data['Setting']}`);
            }
            
            // Add program philosophy or approach if we can infer it
            if (data['Additional Info']) {
                const info = data['Additional Info'];
                if (/holistic/i.test(info) && bullets.length < 6 && !bullets.some(b => b.includes('holistic'))) {
                    bullets.push('Holistic Approach: Integration of mind, body, and spirit in the healing process');
                }
                if (/family/i.test(info) && !bullets.some(b => b.includes('family'))) {
                    bullets.push('Family Integration: Regular family therapy sessions and parent education workshops');
                }
                if (/24\/7/i.test(info) && !bullets.some(b => b.includes('supervision'))) {
                    bullets.push('Structured Environment: 24/7 supervision with high staff-to-client ratio');
                }
                if (/transition/i.test(info)) {
                    bullets.push('Transition Support: Step-down planning and aftercare coordination for sustained recovery');
                }
            }
            
            // Add length of stay or program duration if mentioned
            const durationMatch = data['Additional Info'] && data['Additional Info'].match(/(\d+[-]\d+)\s*(days?|weeks?|months?)/i);
            if (durationMatch && bullets.length < 6) {
                bullets.push(`Program Duration: Typical length of stay ${durationMatch[0]}`);
            }
            
            // Add accreditations with context
            if (data['Accreditations'] && data['Accreditations'] !== 'N/A') {
                bullets.push(`Accreditations & Certifications: ${data['Accreditations']}`);
            }
            
            // Ensure we have at least 3 meaningful bullets
            if (bullets.length < 3) {
                const additionalBullets = [
                    'Individualized Treatment: Customized treatment plans based on comprehensive assessment',
                    'Aftercare Planning: Comprehensive discharge planning and community resource coordination',
                    'Multidisciplinary Team: Treatment team includes therapists, psychiatrists, and specialized staff'
                ];
                bullets.push(...additionalBullets.slice(0, 3 - bullets.length));
            }
            
            // Output bullets with variety in formatting
            bullets.forEach((bullet, index) => {
                // Some bullets might have sub-points
                if (bullet.includes(':')) {
                    const [label, content] = bullet.split(':');
                    output += ` <strong>${label}:</strong>${content}\n`;
                } else {
                    output += ` ${bullet}\n`;
                }
            });
            
            // Add generic features if we found them in text
            const text = data['Additional Info'] || '';
            
            if (/family (?:therapy|involvement|program)/i.test(text)) {
                output += ' Family Involvement: Regular family therapy sessions and parent education\n';
            }
            
            if (/trauma[- ]informed/i.test(text)) {
                output += ' Trauma-Informed Care: All staff trained in trauma-informed approaches\n';
            }
            
            if (/\b24\/7\b/.test(text)) {
                output += ' Supervision: 24/7 supervision and support by trained staff\n';
            }
            
            output += '\n';
            
            // 4. Contact Information - Vary the presentation
            const contactIntros = [
                'Contact Information:',
                'For More Information:',
                'To Learn More:',
                'Contact Details:',
                'Get in Touch:'
            ];
            output += contactIntros[Math.floor(Math.random() * contactIntros.length)] + '\n';
            
            // Vary the order and format of contact details
            const contactDetails = [];
            if (data['Phone Number']) {
                const phoneFormats = [
                    `Phone: ${data['Phone Number']}`,
                    `Call: ${data['Phone Number']}`,
                    `${data['Phone Number']}`,
                    `Tel: ${data['Phone Number']}`
                ];
                contactDetails.push(phoneFormats[Math.floor(Math.random() * phoneFormats.length)]);
            }
            if (data['Website']) {
                const website = data['Website'].replace(/^(www\.|https?:\/\/)/, '');
                const webFormats = [
                    `Website: www.${website}`,
                    `Visit: www.${website}`,
                    `Online: www.${website}`,
                    `www.${website}`
                ];
                contactDetails.push(webFormats[Math.floor(Math.random() * webFormats.length)]);
            }
            if (data['Location']) {
                const locFormats = [
                    `Location: ${data['Location']}`,
                    `${data['Location']}`,
                    `Located in ${data['Location']}`
                ];
                contactDetails.push(locFormats[Math.floor(Math.random() * locFormats.length)]);
            }
            
            // Randomize order occasionally
            if (Math.random() > 0.5) {
                contactDetails.reverse();
            }
            
            output += contactDetails.join('\n');
            
            return output.trim();
        }
        
        // Update selection panel with drag and drop
        function updateSelectionPanel() {
            const selectedList = document.getElementById('selectedList');
            
            if (selectedPrograms.length > 0) {
                selectedList.innerHTML = selectedPrograms.map((p, index) => `
                    <div class="selected-program selected-program-item" draggable="true" data-id="${p.id}" data-index="${index}">
                        <span class="drag-handle" style="cursor: grab;"></span>
                        <span style="flex: 1;">${p.name} - ${p.location}</span>
                        <div class="program-order-controls">
                            <button class="order-btn" onclick="moveProgram(${index}, 'up')" ${index === 0 ? 'disabled' : ''}></button>
                            <button class="order-btn" onclick="moveProgram(${index}, 'down')" ${index === selectedPrograms.length - 1 ? 'disabled' : ''}></button>
                            <button class="remove-btn" onclick="removeProgram('${p.id}')"></button>
                        </div>
                    </div>
                `).join('');
                
                // Re-initialize drag and drop for new elements
                initializeProgramDragDrop();
                
                // Add drag and drop event listeners
                const items = selectedList.querySelectorAll('.selected-program');
                items.forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('drop', handleDrop);
                    item.addEventListener('dragenter', handleDragEnter);
                    item.addEventListener('dragleave', handleDragLeave);
                });
            } else {
                selectedList.innerHTML = '<div class="empty-state">Click programs to add to selection</div>';
            }
            
            // Enable/disable generate button
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = selectedPrograms.length === 0;
        }
        
        // Drag and drop handlers
        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Remove all drag-over classes
            const items = document.querySelectorAll('.selected-program');
            items.forEach(item => {
                item.classList.remove('drag-over');
            });
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedItem !== this) {
                const draggedIndex = parseInt(draggedItem.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // Reorder the array
                const [removed] = selectedPrograms.splice(draggedIndex, 1);
                selectedPrograms.splice(targetIndex, 0, removed);
                
                // Update the UI
                updateSelectionPanel();
            }
            
            return false;
        }
        
        // Move program up or down
        function moveProgram(index, direction) {
            if (direction === 'up' && index > 0) {
                [selectedPrograms[index], selectedPrograms[index - 1]] = 
                [selectedPrograms[index - 1], selectedPrograms[index]];
            } else if (direction === 'down' && index < selectedPrograms.length - 1) {
                [selectedPrograms[index], selectedPrograms[index + 1]] = 
                [selectedPrograms[index + 1], selectedPrograms[index]];
            }
            updateSelectionPanel();
        }
        
        // Remove program
        function removeProgram(programId) {
            selectedPrograms = selectedPrograms.filter(p => p.id !== programId);
            updateSelectionPanel();
            renderPrograms();
        }
        

        // Smart information extraction without API
        function extractProgramInfo(text) {
            const info = {
                'Program Name': 'Not specified',
                'Location': 'Not specified',
                'Phone Number': 'Not specified', 
                'Website': 'Not specified',
                'Level of Care': 'Not specified',
                'Age Range': 'Not specified',
                'Gender Served': 'Not specified',
                'Insurance Accepted': 'Not specified',
                'Specialties and Treatment Approaches': 'Not specified',
                'Duration/Length of Stay': 'Not specified',
                'Accreditations': 'Not specified',
                'Additional Features': 'Not specified'
            };
            
            // Extract program name (usually in title or first heading)
            const nameMatch = text.match(/^([A-Z][A-Za-z\s&'-]+?)(?:\n|$)/m) || 
                             text.match(/<h[1-3]>([^<]+)<\/h[1-3]>/) ||
                             text.match(/(?:Program:|Facility:|Center:)\s*([^\n]+)/i);
            if (nameMatch) info['Program Name'] = nameMatch[1].trim();
            
            // Extract phone number
            const phoneMatch = text.match(/(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/);
            if (phoneMatch) info['Phone Number'] = phoneMatch[1];
            
            // Extract website
            const websiteMatch = text.match(/(?:www\.|https?:\/\/)([^\s\n]+)/i);
            if (websiteMatch) info['Website'] = websiteMatch[0];
            
            // Extract location (city, state pattern)
            const locationMatch = text.match(/([A-Z][a-z]+(?:\s[A-Z][a-z]+)*),?\s*([A-Z]{2})\b/) ||
                                 text.match(/(?:Location:|Located in:|Address:)\s*([^\n]+)/i);
            if (locationMatch) {
                info['Location'] = locationMatch[2] ? `${locationMatch[1]}, ${locationMatch[2]}` : locationMatch[1];
            }
            
            // Extract level of care
            const careTypes = ['RTC', 'Residential Treatment', 'PHP', 'IOP', 'Wilderness', 'Therapeutic Boarding', 'Partial Hospitalization', 'Intensive Outpatient'];
            for (const care of careTypes) {
                if (text.toLowerCase().includes(care.toLowerCase())) {
                    info['Level of Care'] = care;
                    break;
                }
            }
            
            // Extract age range
            const ageMatch = text.match(/(?:ages?|serving)\s*(\d+)[\s-]*(?:to|through)?\s*(\d+)/i) ||
                            text.match(/(\d+)[\s-]*(?:to|through)?\s*(\d+)\s*year/i);
            if (ageMatch) info['Age Range'] = `${ageMatch[1]}-${ageMatch[2]} years`;
            
            // Extract gender
            const genderMatch = text.match(/(?:Gender:|Serving:|Admits?)\s*(Boys?|Girls?|Co-?ed|Male|Female|All genders)/i);
            if (genderMatch) info['Gender Served'] = genderMatch[1];
            
            // Extract insurance
            const insuranceMatch = text.match(/(?:Insurance:|Accepts?:|Payment:)\s*([^\n]+)/i);
            if (insuranceMatch) info['Insurance Accepted'] = insuranceMatch[1];
            
            // Extract specialties (look for therapy types, treatment approaches)
            const specialties = [];
            const therapyTypes = ['CBT', 'DBT', 'EMDR', 'Equine', 'Art Therapy', 'Music Therapy', 'Family Therapy', 'Group Therapy', 'Individual Therapy'];
            therapyTypes.forEach(therapy => {
                if (text.toLowerCase().includes(therapy.toLowerCase())) {
                    specialties.push(therapy);
                }
            });
            if (specialties.length > 0) {
                info['Specialties and Treatment Approaches'] = specialties.join(', ');
            }
            
            // Extract accreditations
            const accredMatch = text.match(/(?:Accredited by|Accreditation:|Licensed by|Certified by)\s*([^\n]+)/i);
            if (accredMatch) info['Accreditations'] = accredMatch[1];
            
            return info;
        }
        
        // Simplified document generation from pasted content
        // DEPRECATED - Kept for reference, functionality moved to addCustomProgram()
        /*
        async function generateFromWebsite() {
            const programInfo = document.getElementById('quickProgramInfo').value;
            const clientName = document.getElementById('quickClientName').value;
            const statusDiv = document.getElementById('quickModeStatus');
            
            if (!programInfo) {
                alert('Please paste program information or use the Chrome extension!');
                return;
            }
            
            if (!clientName) {
                alert('Please enter client name!');
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#f0f8ff';
            statusDiv.style.color = '#0066cc';
            statusDiv.innerHTML = ' Analyzing program information...';
            
            try {
                // Smart parsing without API - Extract information using pattern matching
                const programData = extractProgramInfo(programInfo);
                
                // Generate document with extracted information
                generateQuickModeDocument(clientName, programData);
                
                statusDiv.style.background = '#d4f4dd';
                statusDiv.style.color = '#28a745';
                statusDiv.innerHTML = ' Document generated successfully!';
                
            } catch (error) {
                // If parsing fails, use the manual format
                generateManualDocument(clientName);
                statusDiv.style.background = '#d4f4dd';
                statusDiv.style.color = '#28a745';
                statusDiv.innerHTML = ' Document generated!';
            }
        }
        */
        
        // Generate document from AI-extracted data
        function generateQuickModeDocument(clientName, programData) {
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Treatment Options - ${clientName}</title>
                    <style>
                        @page { size: letter; margin: 0.5in; }
                        body { 
                            font-family: 'Calibri', Arial, sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            line-height: 1.6;
                            color: #333;
                        }
                        .letterhead { 
                            border-bottom: 3px solid #0066cc; 
                            padding-bottom: 10px; 
                            margin-bottom: 20px; 
                        }
                        .logo-container { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center; 
                        }
                        .logo-left { 
                            display: flex; 
                            align-items: center; 
                        }
                        .logo-circle { 
                            width: 50px; 
                            height: 50px; 
                            background: #0066cc; 
                            color: white; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 24px; 
                            font-weight: bold; 
                            margin-right: 15px; 
                        }
                        .program-section { 
                            margin: 30px 0; 
                            page-break-inside: avoid; 
                        }
                        .program-title { 
                            color: #0066cc; 
                            font-size: 18px; 
                            font-weight: bold; 
                            margin-bottom: 10px; 
                        }
                        .program-details { 
                            margin-left: 20px; 
                        }
                        ul { 
                            margin: 10px 0; 
                            padding-left: 20px; 
                        }
                        li { 
                            margin: 5px 0; 
                        }
                    </style>
                </head>
                <body>
                    <div class="letterhead">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 50px; height: 50px; background: #0066cc; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; margin-right: 15px;">F</div>
                                <div>
                                    <h1 style="margin: 0; color: #0066cc; font-size: 24px;">Family First</h1>
                                    <p style="margin: 0; font-size: 14px; color: #666;">ADOLESCENT SERVICES</p>
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 14px; color: #666;">
                                ${date}
                            </div>
                        </div>
                    </div>
                    
                    <h2 style="color: #0066cc;">TREATMENT RECOMMENDATION</h2>
                    <p><strong>Client:</strong> ${clientName}</p>
                    
                    <div style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                        <h3 style="color: #0066cc; margin-top: 0;">${programData['Program Name'] || 'Program Name Not Specified'}</h3>
                        <p><strong>Location:</strong> ${programData['Location'] || 'Not specified'}</p>
                        <p><strong>Phone:</strong> ${programData['Phone Number'] || 'Not specified'}</p>
                        <p><strong>Website:</strong> ${programData['Website'] || 'Not specified'}</p>
                        <p><strong>Level of Care:</strong> ${programData['Level of Care'] || 'Not specified'}</p>
                        <p><strong>Age Range:</strong> ${programData['Age Range'] || 'Not specified'}</p>
                        <p><strong>Gender Served:</strong> ${programData['Gender Served'] || 'Not specified'}</p>
                        <p><strong>Insurance:</strong> ${programData['Insurance Accepted'] || 'Not specified'}</p>
                        <p><strong>Treatment Duration:</strong> ${programData['Duration/Length of Stay'] || 'Not specified'}</p>
                        <p><strong>Accreditations:</strong> ${programData['Accreditations'] || 'Not specified'}</p>
                        
                        <h4 style="color: #0066cc;">Specialties & Treatment Approaches:</h4>
                        <p>${programData['Specialties and Treatment Approaches'] || 'Not specified'}</p>
                        
                        <h4 style="color: #0066cc;">Additional Features:</h4>
                        <p>${programData['Additional Features'] || 'Not specified'}</p>
                    </div>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #0066cc; text-align: center; color: #666;">
                        <p style="margin: 0;">8737 Dunwoody Place | Suite 100 | Atlanta, Georgia 30350</p>
                        <p style="margin: 5px 0;">Office: 770.407.0768 ext 2 | Fax: 770.407.0516</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
        
        // Listen for messages from Chrome extension
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'PROGRAM_INFO_EXTRACTED') {
                // Use the proper function to show the modal
                showAddProgramDialog();
                
                // Populate the textarea with extracted content
                document.getElementById('customProgramInfo').value = event.data.content;
                
                // Clear any existing status messages
                document.getElementById('customProgramStatus').innerHTML = '';
                
                // Show success message
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4f4dd; color: #28a745; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                statusDiv.innerHTML = ' Content received from Chrome extension! Click "Smart Format & Add Program" to process it.';
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    statusDiv.remove();
                }, 4000);
            }
        });
        
        // Generate manual document without AI
        function generateManualDocument(clientName) {
            const programInfo = document.getElementById('quickProgramInfo').value;
            if (!clientName) clientName = document.getElementById('quickClientName').value;
            
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Treatment Information - ${clientName}</title>
                    <style>
                        @page { size: letter; margin: 0.5in; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; line-height: 1.6; }
                        .letterhead { border-bottom: 3px solid #0066cc; padding-bottom: 10px; margin-bottom: 20px; }
                        .logo-container { display: flex; justify-content: space-between; align-items: center; }
                        .logo-left { display: flex; align-items: center; }
                        .logo-circle { width: 50px; height: 50px; background: #0066cc; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; margin-right: 15px; }
                        h1 { margin: 0; color: #0066cc; font-size: 24px; }
                        h2 { color: #0066cc; margin-top: 20px; }
                        .content-box { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #0066cc; text-align: center; color: #666; font-size: 14px; }
                        .program-info { white-space: pre-wrap; font-family: Arial, sans-serif; }
                    </style>
                </head>
                <body>
                    <div class="letterhead">
                        <div class="logo-container">
                            <div class="logo-left">
                                <div>
                                    <h1>Family First</h1>
                                    <p style="margin: 0; font-size: 14px; color: #666;">ADOLESCENT SERVICES</p>
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 14px; color: #666;">
                                ${date}
                            </div>
                        </div>
                    </div>
                    
                    <h2>PROGRAM INFORMATION</h2>
                    <p><strong>Client:</strong> ${clientName}</p>
                    
                    <div class="content-box">
                        <h3 style="color: #0066cc; margin-top: 0;">Program Details</h3>
                        <div class="program-info">${programInfo.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                    </div>
                    
                    <div class="footer">
                        <p style="margin: 0;">8737 Dunwoody Place | Suite 100 | Atlanta, Georgia 30350</p>
                        <p style="margin: 5px 0;">Office: 770.407.0768 ext 2 | Fax: 770.407.0516</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
            
            // Update status
            const statusDiv = document.getElementById('quickModeStatus');
            statusDiv.style.background = '#d4f4dd';
            statusDiv.style.color = '#28a745';
            statusDiv.innerHTML = ' Manual document generated! The print dialog should appear.';
        }
        
        // Generate document - Professional letterhead format
        // AT HOME Provider Management
        function toggleAtHomeSection() {
            const checkbox = document.getElementById('includeAtHome');
            const section = document.getElementById('atHomeSection');
            section.style.display = checkbox.checked ? 'block' : 'none';
            
            // Start collapsed when first shown
            if (checkbox.checked) {
                const content = document.getElementById('atHomeContent');
                const toggleBtn = document.getElementById('atHomeToggleBtn');
                const toggleText = document.getElementById('atHomeToggleText');
                content.style.display = 'none';
                toggleBtn.textContent = '';
                if (toggleText) toggleText.textContent = 'EXPAND';
            }
        }
        
        function toggleAtHomeContent() {
            const content = document.getElementById('atHomeContent');
            const toggleBtn = document.getElementById('atHomeToggleBtn');
            const toggleText = document.getElementById('atHomeToggleText');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                content.style.maxHeight = '400px';
                content.style.overflowY = 'auto';
                toggleBtn.textContent = '';
                toggleBtn.style.transform = 'rotate(0deg)';
                if (toggleText) toggleText.textContent = 'COLLAPSE';
            } else {
                content.style.display = 'none';
                toggleBtn.textContent = '';
                toggleBtn.style.transform = 'rotate(0deg)';
                if (toggleText) toggleText.textContent = 'EXPAND';
            }
        }
        
        function addAtHomeProvider() {
            const providerId = 'provider_' + Date.now();
            const provider = {
                id: providerId,
                name: '',
                service: '',
                phone: '',
                website: '',
                address: ''
            };
            
            atHomeProviders.push(provider);
            renderAtHomeProviders();
            
            // Show the AT HOME section if it's hidden
            const atHomeSection = document.getElementById('atHomeSection');
            if (atHomeSection && atHomeSection.style.display === 'none') {
                atHomeSection.style.display = 'block';
            }
            
            // Expand the content if it's collapsed
            const content = document.getElementById('atHomeContent');
            if (content && content.style.display === 'none') {
                toggleAtHomeContent();
            }
        }

        // REMOVED: loadAtHomeSuggestions function
        // This was intended to pre-populate common AT HOME therapy providers
        // to save time for case managers, but it's better to manually add
        // specific providers as needed for each client's situation
        
        function removeAtHomeProvider(providerId) {
            atHomeProviders = atHomeProviders.filter(p => p.id !== providerId);
            renderAtHomeProviders();
        }
        
        function updateAtHomeProvider(providerId, field, value) {
            const provider = atHomeProviders.find(p => p.id === providerId);
            if (provider) {
                provider[field] = value;
                
                // Show confirmation when both required fields are filled
                if (provider.name && provider.phone) {
                    showProviderConfirmation(providerId);
                }
            }
        }
        
        function showProviderConfirmation(providerId) {
            // Remove any existing confirmation messages
            const existingMessages = document.querySelectorAll('.provider-confirmation');
            existingMessages.forEach(msg => msg.remove());
            
            // Find the provider container
            const providerContainer = document.querySelector(`[data-provider-id="${providerId}"]`);
            if (providerContainer) {
                const confirmation = document.createElement('div');
                confirmation.className = 'provider-confirmation';
                confirmation.style.cssText = 'background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; margin-top: 8px; font-size: 14px; border: 1px solid #c3e6cb;';
                confirmation.innerHTML = ' Provider added to AT HOME recommendations!';
                
                providerContainer.appendChild(confirmation);
                
                // Remove confirmation after 3 seconds
                setTimeout(() => {
                    confirmation.remove();
                }, 3000);
            }
        }
        
        function renderAtHomeProviders() {
            const container = document.getElementById('atHomeProviders');
            container.innerHTML = '';
            
            // Update the provider count badge
            const countBadge = document.getElementById('atHomeProviderCount');
            if (countBadge) {
                if (atHomeProviders.length > 0) {
                    countBadge.textContent = atHomeProviders.length;
                    countBadge.style.display = 'inline-block';
                } else {
                    countBadge.style.display = 'none';
                }
            }
            
            atHomeProviders.forEach(provider => {
                const providerDiv = document.createElement('div');
                providerDiv.style.cssText = 'margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white;';
                providerDiv.setAttribute('data-provider-id', provider.id);
                
                providerDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>Provider ${atHomeProviders.indexOf(provider) + 1}</strong>
                        <button type="button" onclick="removeAtHomeProvider('${provider.id}')" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 10px;">
                            <input type="text" placeholder="Provider Name *" value="${provider.name}" 
                               onchange="updateAtHomeProvider('${provider.id}', 'name', this.value)"
                                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                            <input type="text" placeholder="Service Type" value="${provider.service}" 
                               onchange="updateAtHomeProvider('${provider.id}', 'service', this.value)"
                                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                    </div>
                        <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 10px;">
                        <input type="text" placeholder="Phone Number *" value="${provider.phone}" 
                               onchange="updateAtHomeProvider('${provider.id}', 'phone', this.value)"
                                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                            <input type="text" placeholder="Website" value="${provider.website}" 
                               onchange="updateAtHomeProvider('${provider.id}', 'website', this.value)"
                                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                    </div>
                    <input type="text" placeholder="Address (optional)" value="${provider.address}" 
                           onchange="updateAtHomeProvider('${provider.id}', 'address', this.value)"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                `;
                
                container.appendChild(providerDiv);
            });
        }
        
        // AI Extraction Functions
        async function extractProgramData(websiteText, programName) {
            // Check which API key is available (from localStorage or input field)
            let OPENAI_KEY = localStorage.getItem('openai_api_key') || 
                           document.getElementById('openaiApiKey')?.value || 
                           OPENAI_API_KEY;
            let ANTHROPIC_KEY = localStorage.getItem('anthropic_api_key') || 
                               document.getElementById('anthropicApiKey')?.value || 
                               ANTHROPIC_API_KEY;
            
            const useOpenAI = OPENAI_KEY && OPENAI_KEY !== 'YOUR_OPENAI_API_KEY_HERE';
            const useAnthropic = ANTHROPIC_KEY && ANTHROPIC_KEY !== 'YOUR_ANTHROPIC_API_KEY_HERE';
            
            if (!useOpenAI && !useAnthropic) {
                return null; // No API key set
            }
            
            const systemPrompt = `You are an experienced clinical consultant specializing in adolescent treatment program placements. You are helping families make informed decisions about continuing care for their children. Extract comprehensive clinical and practical information that would be essential during an aftercare recommendation call. Focus on details that help families understand if this program is the right fit for their child's specific needs.`;
            
            const userPrompt = `Analyze this treatment program website content for "${programName}" and extract detailed information for clinical aftercare recommendations.

${websiteText.substring(0, 10000)}

Extract comprehensive information in these categories:

PROGRAM OVERVIEW:
- Full program name and any parent organization
- Level of care (Residential, Therapeutic Boarding School, Wilderness, RTC, PHP, IOP)
- Program philosophy and treatment approach
- Typical length of stay
- Capacity (number of students/residents)

POPULATION SERVED:
- Age range (be specific if different for boys/girls)
- Gender (boys only, girls only, co-ed, separate programs)
- Academic grades served
- Primary issues treated (list all mentioned)
- Exclusion criteria (what they DON'T treat)

CLINICAL SERVICES:
- Individual therapy frequency and approach
- Group therapy types and frequency
- Family therapy/involvement level
- Psychiatric services and medication management
- Specialized therapies (EMDR, DBT, CBT, equine, art, etc.)
- Trauma-informed care specifics
- Substance abuse treatment capabilities

ACADEMIC PROGRAM:
- Accredited school on-site (yes/no)
- Academic credits transferable
- Special education services
- College prep availability
- Vocational training options
- Class sizes
- Teacher qualifications

THERAPEUTIC MILIEU:
- Staff-to-student ratio
- Level system or phase program details
- Privileges and restrictions
- Home visits policy
- Communication with family (phone, email, visits)
- Daily schedule structure

ACTIVITIES & ENRICHMENT:
- Sports and recreation options
- Adventure/outdoor programming
- Creative arts programs
- Life skills training
- Community service opportunities

STAFF CREDENTIALS:
- Clinical staff qualifications
- 24/7 supervision level
- Medical staff on-site
- Staff training and specializations

FACILITY & ENVIRONMENT:
- Campus description and size
- Living arrangements (dorms, houses, rooms)
- Safety and security measures
- Technology policies
- Food service and dietary accommodations

OUTCOMES & SUCCESS:
- Success metrics or statistics
- Average program completion rate
- Aftercare support provided
- Alumni program
- Transition planning process

PRACTICAL INFORMATION:
- Admissions requirements
- Intake process timeline
- Insurance accepted (list all mentioned)
- Private pay rates if mentioned
- Financial aid availability
- Licensing and accreditations (CARF, Joint Commission, state licenses)

CONTACT INFORMATION:
- Main phone number
- Admissions phone if different
- Email addresses
- Website URL
- Physical address
- Key contact persons mentioned

Return as JSON with these exact keys (use detailed strings, not just keywords):
{
    "Program Name": "",
    "Level of Care": "",
    "Program Philosophy": "",
    "Typical Length of Stay": "",
    "Age Range": "",
    "Gender Served": "",
    "Academic Grades": "",
    "Primary Issues Treated": "",
    "Exclusion Criteria": "",
    "Individual Therapy": "",
    "Group Therapy": "",
    "Family Involvement": "",
    "Psychiatric Services": "",
    "Specialized Therapies": "",
    "Academic Program": "",
    "Special Education": "",
    "Staff Ratio": "",
    "Phase System": "",
    "Family Communication": "",
    "Activities and Recreation": "",
    "Living Arrangements": "",
    "Admissions Process": "",
    "Insurance Accepted": "",
    "Cost Information": "",
    "Accreditations": "",
    "Location": "",
    "Phone Number": "",
    "Website": "",
    "Key Differentiators": "",
    "Clinical Strengths": "",
    "Best Fit For": "",
    "May Not Be Suitable For": "",
    "Confidence": "high/medium/low"
}

CRITICAL INSTRUCTIONS:
1. ONLY include information that is EXPLICITLY stated on the website
2. If information is not found, return empty string "" - DO NOT make suggestions or add placeholders
3. Be concise but complete - no fluff, just facts
4. Extract actual details, not generic descriptions
5. Focus on specific, actionable information families need

For missing information, use empty string "". Never use phrases like:
- "Not specified"
- "Ask during intake"
- "Contact for details"
- "Varies"
- "Multiple options"

Either provide the ACTUAL information or leave it blank.`;

            try {
                if (useOpenAI) {
                    // OpenAI API call
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${OPENAI_KEY}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4-turbo-preview', // Using GPT-4 for comprehensive analysis
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: userPrompt }
                            ],
                            temperature: 0.3,
                            max_tokens: 800
                        })
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        console.error('OpenAI API Error:', error);
                        return null;
                    }

                    const data = await response.json();
                    if (data.choices && data.choices[0]?.message?.content) {
                        const content = data.choices[0].message.content;
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const result = JSON.parse(jsonMatch[0]);
                            // Save successful key for future use
                            localStorage.setItem('openai_api_key', OPENAI_KEY);
                            return result;
                        }
                    }
                } else if (useAnthropic) {
                    // Anthropic Claude API call
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': ANTHROPIC_KEY,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-haiku-20240307', // Using Haiku for cost efficiency
                            messages: [
                                { 
                                    role: 'user', 
                                    content: `${systemPrompt}\n\n${userPrompt}` 
                                }
                            ],
                            max_tokens: 800,
                            temperature: 0.3
                        })
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        console.error('Anthropic API Error:', error);
                        return null;
                    }

                    const data = await response.json();
                    if (data.content && data.content[0]?.text) {
                        const text = data.content[0].text;
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const result = JSON.parse(jsonMatch[0]);
                            // Save successful key for future use
                            localStorage.setItem('anthropic_api_key', ANTHROPIC_KEY);
                            return result;
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('AI Extraction Error:', error);
                return null;
            }
        }

        async function analyzeWebsiteUrl(url, programName) {
            try {
                // Add more debugging
                console.log('Starting deep website analysis:', url);
                
                // Update progress
                if (window.addProgressLog) {
                    window.addProgressLog(' Starting comprehensive website analysis...');
                    window.addProgressLog('This will take 60-90 seconds for thorough extraction');
                }
                
                // Extract base URL for crawling related pages
                const baseUrl = new URL(url).origin;
                const importantPaths = [
                    '', // Main page
                    '/about', '/about-us', '/our-program',
                    '/clinical', '/clinical-program', '/treatment', '/therapy',
                    '/admissions', '/admission', '/intake',
                    '/academics', '/education', '/school',
                    '/residential', '/boarding',
                    '/staff', '/team', '/our-team',
                    '/contact', '/contact-us',
                    '/faq', '/faqs',
                    '/parent-resources', '/families',
                    '/approach', '/philosophy', '/model'
                ];
                
                // Try multiple proxy services for better success rate
                const proxyServices = [
                    {
                        url: `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                        name: 'AllOrigins',
                        extractContent: (data) => data.contents
                    },
                    {
                        url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
                        name: 'CodeTabs',
                        extractContent: (data) => data
                    },
                    {
                        url: `https://corsproxy.io/?${encodeURIComponent(url)}`,
                        name: 'CorsProxy',
                        extractContent: (data) => data
                    }
                ];
                
                for (const proxy of proxyServices) {
                    try {
                        console.log(`Trying ${proxy.name} proxy...`);
                        if (window.addProgressLog) {
                            window.addProgressLog(`Trying ${proxy.name} proxy service...`);
                        }
                        
                        const response = await fetch(proxy.url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/html,application/xhtml+xml',
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            }
                        });
                        
                        if (response.ok) {
                            let data;
                            const contentType = response.headers.get('content-type');
                            
                            if (contentType && contentType.includes('application/json')) {
                                data = await response.json();
                            } else {
                                data = await response.text();
                            }
                            
                            let textContent = '';
                            
                            // Extract content based on proxy type
                            const rawContent = proxy.extractContent(data);
                            
                            if (typeof rawContent === 'string') {
                                // Parse HTML and extract text
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = rawContent;
                                
                                // Remove script and style elements
                                const scripts = tempDiv.querySelectorAll('script, style');
                                scripts.forEach(el => el.remove());
                                
                                textContent = tempDiv.textContent || tempDiv.innerText || '';
                            }
                            
                            if (textContent.length > 500) {
                                console.log(`${proxy.name} succeeded, got ${textContent.length} chars`);
                                if (window.addProgressLog) {
                                    window.addProgressLog(` ${proxy.name} retrieved ${textContent.length} characters`);
                                }
                                return await extractProgramData(textContent, programName);
                            } else {
                                console.log(`${proxy.name} returned insufficient content`);
                                if (window.addProgressLog) {
                                    window.addProgressLog(` ${proxy.name} returned insufficient content`);
                                }
                            }
                        } else {
                            console.log(`${proxy.name} returned status ${response.status}`);
                            if (window.addProgressLog) {
                                window.addProgressLog(` ${proxy.name} failed with status ${response.status}`);
                            }
                        }
                    } catch (proxyError) {
                        console.log(`${proxy.name} error:`, proxyError.message);
                        if (window.addProgressLog) {
                            window.addProgressLog(` ${proxy.name} error: ${proxyError.message}`);
                        }
                        continue;
                    }
                }
                
                // If all proxies fail, try direct AI analysis with URL
                return await analyzeUrlDirectly(url, programName);
                
            } catch (error) {
                console.error('Website Analysis Error:', error);
                return null;
            }
        }
        
        async function analyzeUrlDirectly(url, programName) {
            // Check which API key is available
            let OPENAI_KEY = localStorage.getItem('openai_api_key') || 
                           document.getElementById('openaiApiKey')?.value || 
                           OPENAI_API_KEY;
            let ANTHROPIC_KEY = localStorage.getItem('anthropic_api_key') || 
                               document.getElementById('anthropicApiKey')?.value || 
                               ANTHROPIC_API_KEY;
            
            const useOpenAI = OPENAI_KEY && OPENAI_KEY !== 'YOUR_OPENAI_API_KEY_HERE';
            const useAnthropic = ANTHROPIC_KEY && ANTHROPIC_KEY !== 'YOUR_ANTHROPIC_API_KEY_HERE';
            
            if (!useOpenAI && !useAnthropic) {
                return null;
            }
            
            const prompt = `Based on the URL "${url}" and program name "${programName}", provide information about this adolescent treatment program.

Use your knowledge to infer or provide known information. Return a JSON object with:
{
    "Program Name": "${programName}",
    "Level of Care": "(infer from name/URL)",
    "Age Range": "(typical for this type)",
    "Gender Served": "(if known)",
    "Location": "(infer from URL/name)",
    "Phone Number": "(if known)",
    "Website": "${url}",
    "Specialties and Treatment Approaches": "Brief description",
    "Insurance": "Typical for this type",
    "Accreditations": "Common accreditations",
    "Confidence": "low"
}

Set Confidence to "low" since this is URL-based inference.`;

            try {
                if (useOpenAI) {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${OPENAI_KEY}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                { role: 'system', content: 'You are a healthcare professional assistant. Provide helpful information about treatment programs based on available data.' },
                                { role: 'user', content: prompt }
                            ],
                            temperature: 0.5,
                            max_tokens: 500
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.choices && data.choices[0]?.message?.content) {
                            const content = data.choices[0].message.content;
                            const jsonMatch = content.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                return JSON.parse(jsonMatch[0]);
                            }
                        }
                    }
                } else if (useAnthropic) {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': ANTHROPIC_KEY,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-haiku-20240307',
                            messages: [
                                { role: 'user', content: prompt }
                            ],
                            max_tokens: 500,
                            temperature: 0.5
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.content && data.content[0]?.text) {
                            const text = data.content[0].text;
                            const jsonMatch = text.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                return JSON.parse(jsonMatch[0]);
                            }
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Direct URL Analysis Error:', error);
                return null;
            }
        }

        // AI Preview and Hybrid Tool Functions
        function showAIPreview(extractedData, confidence, originalInput) {
            const statusDiv = document.getElementById('customProgramStatus');
            
            // Store the original URL in the extraction data
            window.currentAIExtraction = extractedData;
            window.currentAIInput = originalInput;
            
            statusDiv.innerHTML = `
                <div style="background: #f0f9ff; border: 1px solid #0099cc; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 16px;"></span>
                        <strong style="margin-left: 8px; color: #0099cc;">AI Analysis Complete</strong>
                        <span style="margin-left: auto; background: ${confidence === 'high' ? '#10b981' : '#f59e0b'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                            ${confidence.toUpperCase()} CONFIDENCE
                        </span>
                    </div>
                    
                    <div style="background: white; border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 14px;">
                        <h4 style="margin-top: 0; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Program Overview</h4>
                        ${extractedData['Program Name'] ? `<div style="margin-bottom: 6px;"><strong>Program:</strong> ${extractedData['Program Name']}</div>` : ''}
                        ${extractedData['Level of Care'] ? `<div style="margin-bottom: 6px;"><strong>Level of Care:</strong> ${extractedData['Level of Care']}</div>` : ''}
                        ${extractedData['Program Philosophy'] ? `<div style="margin-bottom: 6px;"><strong>Philosophy:</strong> ${extractedData['Program Philosophy']}</div>` : ''}
                        ${extractedData['Typical Length of Stay'] ? `<div style="margin-bottom: 6px;"><strong>Length of Stay:</strong> ${extractedData['Typical Length of Stay']}</div>` : ''}
                        
                        ${(extractedData['Age Range'] || extractedData['Gender Served'] || extractedData['Primary Issues Treated'] || extractedData['Exclusion Criteria']) ? `
                        <h4 style="margin-top: 12px; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Population & Clinical</h4>
                        ${extractedData['Age Range'] ? `<div style="margin-bottom: 6px;"><strong>Ages:</strong> ${extractedData['Age Range']}</div>` : ''}
                        ${extractedData['Gender Served'] ? `<div style="margin-bottom: 6px;"><strong>Gender:</strong> ${extractedData['Gender Served']}</div>` : ''}
                        ${extractedData['Primary Issues Treated'] ? `<div style="margin-bottom: 6px;"><strong>Treats:</strong> ${extractedData['Primary Issues Treated']}</div>` : ''}
                        ${extractedData['Exclusion Criteria'] ? `<div style="margin-bottom: 6px;"><strong>Excludes:</strong> ${extractedData['Exclusion Criteria']}</div>` : ''}
                        ` : ''}
                        
                        ${(extractedData['Individual Therapy'] || extractedData['Group Therapy'] || extractedData['Family Involvement'] || extractedData['Specialized Therapies']) ? `
                        <h4 style="margin-top: 12px; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Therapeutic Services</h4>
                        ${extractedData['Individual Therapy'] ? `<div style="margin-bottom: 6px;"><strong>Individual:</strong> ${extractedData['Individual Therapy']}</div>` : ''}
                        ${extractedData['Group Therapy'] ? `<div style="margin-bottom: 6px;"><strong>Group:</strong> ${extractedData['Group Therapy']}</div>` : ''}
                        ${extractedData['Family Involvement'] ? `<div style="margin-bottom: 6px;"><strong>Family:</strong> ${extractedData['Family Involvement']}</div>` : ''}
                        ${extractedData['Specialized Therapies'] ? `<div style="margin-bottom: 6px;"><strong>Specialized:</strong> ${extractedData['Specialized Therapies']}</div>` : ''}
                        ` : ''}
                        
                        ${(extractedData['Best Fit For'] || extractedData['May Not Be Suitable For']) ? `
                        <h4 style="margin-top: 12px; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Key Fit Information</h4>
                        ${extractedData['Best Fit For'] ? `<div style="margin-bottom: 6px;"><strong>Best For:</strong> ${extractedData['Best Fit For']}</div>` : ''}
                        ${extractedData['May Not Be Suitable For'] ? `<div style="margin-bottom: 6px;"><strong>Not For:</strong> ${extractedData['May Not Be Suitable For']}</div>` : ''}
                        ` : ''}
                        
                        ${(extractedData['Location'] || extractedData['Phone Number'] || extractedData['Insurance Accepted']) ? `
                        <h4 style="margin-top: 12px; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Contact & Cost</h4>
                        ${extractedData['Location'] ? `<div style="margin-bottom: 6px;"><strong>Location:</strong> ${extractedData['Location']}</div>` : ''}
                        ${extractedData['Phone Number'] ? `<div style="margin-bottom: 6px;"><strong>Phone:</strong> ${extractedData['Phone Number']}</div>` : ''}
                        ${extractedData['Insurance Accepted'] ? `<div style="margin-bottom: 6px;"><strong>Insurance:</strong> ${extractedData['Insurance Accepted']}</div>` : ''}
                        ` : ''}
                        ${extractedData.Notes ? `<div style="color: #666; font-style: italic; margin-top: 8px;">${extractedData.Notes}</div>` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="acceptAIExtraction()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Use This Data
                        </button>
                        <button onclick="showHybridTool('${originalInput.replace(/'/g, "\\'")}', true)" style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Improve with Hybrid AI
                        </button>
                        <button onclick="rejectAIExtraction()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Start Over
                        </button>
                    </div>
                </div>
            `;
            
            // Store the extracted data for later use
            window.currentAIExtraction = extractedData;
        }
        
        function showHybridOption(extractedData, originalInput) {
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = `
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 16px;"></span>
                        <strong style="margin-left: 8px; color: #d97706;">AI Analysis - Low Confidence</strong>
                    </div>
                    
                    <p style="margin-bottom: 12px; color: #92400e;">
                        AI found some information but isn't confident. You can use it as-is or improve it with the Hybrid AI Tool.
                    </p>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="showHybridTool('${originalInput.replace(/'/g, "\\'")}', true)" style="background: #0099cc; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Use Hybrid AI Tool
                        </button>
                        <button onclick="acceptAIExtraction()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Use Current Data
                        </button>
                    </div>
                </div>
            `;
            
            window.currentAIExtraction = extractedData;
        }
        
        function showHybridTool(originalInput, hasAIData = false) {
            const statusDiv = document.getElementById('customProgramStatus');
            
            // Check if we have a URL from the original input
            const urlFromInput = window.currentAIInput || document.getElementById('programUrl').value;
            const isUrl = originalInput && originalInput.match(/^https?:\/\/.+/);
            const websiteUrl = isUrl ? originalInput : urlFromInput;
            
            statusDiv.innerHTML = `
                <div style="background: #f3f4f6; border: 1px solid #9ca3af; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <span style="font-size: 18px;"></span>
                        <strong style="margin-left: 8px; color: #374151;">Manual Content Entry</strong>
                    </div>
                    
                    ${websiteUrl ? `
                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #0099cc;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #0099cc;">Program Website:</strong><br>
                                    <span style="font-size: 14px; color: #666;">${websiteUrl}</span>
                                </div>
                                <button onclick="window.open('${websiteUrl}', '_blank')" style="background: #0099cc; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Open Website 
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="background: #e5e7eb; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;">
                        <strong>Quick Instructions:</strong><br>
                        1. Click "Open Website" above${!websiteUrl ? ' (or open the program website)' : ''}<br>
                        2. Copy sections: About, Clinical Program, Admissions, etc.<br>
                        3. Paste everything in the box below<br>
                        4. Click "Process with AI" to extract data
                    </div>
                    
                    <textarea id="hybridInput" placeholder="Paste all program information here...&#10;&#10;Include:&#10; Program overview&#10; Clinical services&#10; Population served&#10; Admissions info&#10; Contact details" 
                              style="width: 100%; height: 200px; padding: 12px; border: 2px solid #0099cc; border-radius: 6px; font-family: Arial, sans-serif; font-size: 14px; resize: vertical;">${!isUrl && originalInput ? originalInput : ''}</textarea>
                    
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button onclick="processHybridInput()" style="background: #0099cc; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                             Process with AI
                        </button>
                        ${hasAIData ? `<button onclick="acceptAIExtraction()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;"> Use Previous Data</button>` : ''}
                        <button onclick="resetAddProgramForm()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                             Back
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-open the website if we have a URL
            if (websiteUrl) {
                setTimeout(() => {
                    window.open(websiteUrl, '_blank');
                }, 500);
            }
        }
        
        async function processHybridInput() {
            const hybridInput = document.getElementById('hybridInput').value;
            if (!hybridInput.trim()) {
                alert('Please paste some program information first!');
                return;
            }
            
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = ' Processing with Hybrid AI...';
            
            const extractedData = await extractProgramData(hybridInput, 'Program from Hybrid Tool');
            
            if (extractedData) {
                showAIPreview(extractedData, 'high', hybridInput);
            } else {
                statusDiv.innerHTML = `
                    <div style="color: #ef4444; padding: 10px;">
                         AI processing failed. Please check your API key or try manual entry.
                        <button onclick="showHybridTool('${hybridInput.replace(/'/g, "\\'")}', false)" style="margin-left: 10px; background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 4px;">Try Again</button>
                    </div>
                `;
            }
        }
        
        function acceptAIExtraction() {
            if (!window.currentAIExtraction) return;
            
            const extractedData = window.currentAIExtraction;
            
            // Create program with AI data
            const customProgram = {
                id: 'custom_' + Date.now(),
                name: extractedData['Program Name'] || extractedData.name || 'Custom Program',
                type: extractedData['Level of Care'] || 'Treatment Program',
                location: extractedData['Location'] || '',
                category: 'custom',
                programCategory: 'Custom Programs',
                levelOfCare: extractedData['Level of Care'] || 'Treatment Program',
                
                // Build comprehensive features list from all extracted data
                features: [
                    extractedData['Program Philosophy'] && `Philosophy: ${extractedData['Program Philosophy']}`,
                    extractedData['Typical Length of Stay'] && `Length: ${extractedData['Typical Length of Stay']}`,
                    extractedData['Primary Issues Treated'] && `Treats: ${extractedData['Primary Issues Treated']}`,
                    extractedData['Specialized Therapies'] && `Therapies: ${extractedData['Specialized Therapies']}`,
                    extractedData['Staff Ratio'] && `Staff Ratio: ${extractedData['Staff Ratio']}`,
                    extractedData['Academic Program'] && `Academics: ${extractedData['Academic Program']}`,
                    extractedData['Best Fit For'] && `Best For: ${extractedData['Best Fit For']}`
                ].filter(Boolean),
                
                contact: {
                    phone: extractedData['Phone Number'] || '',
                    website: extractedData['Website'] || '',
                    address: extractedData['Location'] || ''
                },
                
                // Store all clinical details for document generation
                clinicalDetails: {
                    philosophy: extractedData['Program Philosophy'],
                    lengthOfStay: extractedData['Typical Length of Stay'],
                    ageRange: extractedData['Age Range'],
                    genderServed: extractedData['Gender Served'],
                    academicGrades: extractedData['Academic Grades'],
                    primaryIssues: extractedData['Primary Issues Treated'],
                    exclusions: extractedData['Exclusion Criteria'],
                    individualTherapy: extractedData['Individual Therapy'],
                    groupTherapy: extractedData['Group Therapy'],
                    familyInvolvement: extractedData['Family Involvement'],
                    psychiatricServices: extractedData['Psychiatric Services'],
                    specializedTherapies: extractedData['Specialized Therapies'],
                    academicProgram: extractedData['Academic Program'],
                    specialEducation: extractedData['Special Education'],
                    staffRatio: extractedData['Staff Ratio'],
                    phaseSystem: extractedData['Phase System'],
                    familyCommunication: extractedData['Family Communication'],
                    activities: extractedData['Activities and Recreation'],
                    livingArrangements: extractedData['Living Arrangements'],
                    admissionsProcess: extractedData['Admissions Process'],
                    insurance: extractedData['Insurance Accepted'],
                    costInfo: extractedData['Cost Information'],
                    accreditations: extractedData['Accreditations'],
                    keyDifferentiators: extractedData['Key Differentiators'],
                    clinicalStrengths: extractedData['Clinical Strengths'],
                    bestFitFor: extractedData['Best Fit For'],
                    notSuitableFor: extractedData['May Not Be Suitable For']
                },
                
                isCustom: true,
                extractedData: extractedData
            };
            
            // Add to programs and selection
            programs.push(customProgram);
            selectedPrograms.push(customProgram);
            
            // Update UI
            renderPrograms();
            updateSelectionPanel();
            saveCustomPrograms();
            
            // Success message with option to add another
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = `
                <div style="background: #d4f4dd; border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="color: #155724; font-weight: bold; margin-bottom: 10px;"> "${customProgram.name}" Added Successfully!</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="resetAddProgramForm()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                             Add Another Program
                        </button>
                        <button onclick="closeAddProgramModal()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                             Done Adding Programs
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-reset after 5 seconds if no action taken
            setTimeout(() => {
                resetAddProgramForm();
            }, 5000);
        }
        
        // Reset the add program form for adding another
        function resetAddProgramForm() {
            // Clear URL input
            document.getElementById('programUrl').value = '';
            
            // Clear manual text input
            document.getElementById('customProgramInfo').value = '';
            
            // Hide progress tracker
            document.getElementById('aiProgressTracker').style.display = 'none';
            
            // Clear progress details
            document.getElementById('progressDetails').innerHTML = '';
            document.getElementById('progressError').style.display = 'none';
            
            // Reset all progress steps
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) {
                    stepEl.style.opacity = '0.5';
                    const icon = stepEl.querySelector('.step-icon');
                    if (icon) {
                        icon.innerHTML = '';
                        icon.style.animation = 'none';
                    }
                    const time = stepEl.querySelector('.step-time');
                    if (time) time.innerHTML = '';
                }
            }
            
            // Clear status
            document.getElementById('customProgramStatus').innerHTML = '';
            
            // Clear stored extraction data
            window.currentAIExtraction = null;
            window.currentAIInput = null;
            
            // Focus back on URL input if in AI mode
            const aiContent = document.getElementById('aiModeContent');
            if (aiContent.style.display !== 'none') {
                document.getElementById('programUrl').focus();
            } else {
                document.getElementById('customProgramInfo').focus();
            }
        }
        
        function rejectAIExtraction() {
            const originalInput = document.getElementById('customProgramInfo').value;
            showHybridTool(originalInput, false);
        }
        
        function generateDocument() {
            const clientNameInput = document.getElementById('clientName');
            const clientName = clientNameInput ? clientNameInput.value.trim() : '';
            
            // Validation with better feedback
            const validationErrors = [];
            
            if (!clientName) {
                validationErrors.push(' Client first name is required');
                if (clientNameInput) {
                    clientNameInput.style.border = '2px solid #ef4444';
                    clientNameInput.focus();
                }
            }
            
            if (selectedPrograms.length === 0) {
                validationErrors.push(' Select at least one program');
            }
            
            // Check AT HOME providers if enabled
            const includeAtHome = document.getElementById('includeAtHome')?.checked;
            if (includeAtHome && atHomeProviders.length > 0) {
                const missingInfo = atHomeProviders.filter(p => !p.name || !p.phone);
                if (missingInfo.length > 0) {
                    validationErrors.push(` ${missingInfo.length} AT HOME provider(s) missing name or phone`);
                }
            }
            
            if (validationErrors.length > 0) {
                // Show friendly validation message
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border: 2px solid #ef4444;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    z-index: 99999;
                    max-width: 400px;
                `;
                errorDiv.innerHTML = `
                    <h3 style="color: #ef4444; margin: 0 0 15px 0;"> Please complete required fields:</h3>
                    <div style="color: #333; margin-bottom: 20px;">
                        ${validationErrors.join('<br>')}
                    </div>
                    <button onclick="this.parentElement.remove(); document.getElementById('clientName').focus();" 
                            style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">
                        OK, I'll fix it
                    </button>
                `;
                document.body.appendChild(errorDiv);
                
                // Reset client name border after a moment
                setTimeout(() => {
                    if (clientNameInput) clientNameInput.style.border = '';
                }, 3000);
                
                return;
            }
            
            // Show loading spinner with progress
            showLoadingSpinner('Generating document...');
            
            // Show progress steps
            const progressSteps = [
                'Validating input...',
                'Processing programs...',
                'Formatting document...',
                'Finalizing...'
            ];
            
            let stepIndex = 0;
            const progressInterval = setInterval(() => {
                if (stepIndex < progressSteps.length) {
                    const spinner = document.querySelector('.loading-spinner p');
                    if (spinner) {
                        spinner.textContent = progressSteps[stepIndex];
                    }
                    stepIndex++;
                }
            }, 500);
            
            // Use the order as arranged by the user
            const orderedPrograms = [...selectedPrograms];
            
            // Small delay for better UX
            setTimeout(() => {
            
            // Generate document with professional letterhead styling
            let html = `
                <div class="doc-page">
                    <div class="doc-content">
                        <!-- Letterhead Header -->
                        <div class="doc-letterhead">
                            <div class="doc-letterhead-text">
                                <h1>Family First</h1>
                                <p>ADOLESCENT SERVICES</p>
                            </div>
                        </div>
                        

            `;
            
            if (documentType === 'options') {
                // OPTIONS Document Format
                html += `
                    <div class="doc-greeting">Hello,</div>
                    <div class="doc-intro">
                        The FFAS clinical team has formulated a list of recommendations and options to support ${clientName} in continuing care. 
                        Included in the list is: contact information, location, website, and a breakdown of specialties and services provided by each program.
                    </div>
                    <div class="doc-section-header">Aftercare Options:</div>
                `;
            } else {
                // PLANS Document Format
                html += `
                    <div class="doc-greeting">Hello,</div>
                    <div class="doc-intro">
                        Below is ${clientName}'s aftercare plan. Included in this list is: contact information, location, website, 
                        and a breakdown of specialties and services provided by the program.
                    </div>
                    <div class="doc-section-header">Aftercare Plan:</div>
                `;
            }
            
            // Group programs by type if using categories
            let currentCategory = '';
            
            // Add programs in user-arranged order
            orderedPrograms.forEach(program => {
                // Extract demographic info from features or use defaults
                let demographics = '';
                let ageRange = '';
                
                // Look for age and gender info in features
                program.features.forEach(feature => {
                    if (feature.toLowerCase().includes('gender')) {
                        demographics = feature.includes('All') ? 'All-Gender' : feature;
                    }
                    if (feature.toLowerCase().includes('age')) {
                        const ageMatch = feature.match(/(\d+)[\s-]+(\d+)/);
                        if (ageMatch) {
                            ageRange = `Ages ${ageMatch[1]}${ageMatch[2]}`;
                        }
                    }
                });
                
                // Build the title line with en dash
                const titleParts = [program.name];
                if (program.type) titleParts.push(program.type);
                const titleBase = titleParts.join('  ');
                const titleDemo = (demographics || ageRange) ? ` (${[demographics, ageRange].filter(Boolean).join(', ')})` : '';
                
                // Handle custom programs - MUST follow exact Calibri format
                if (program.isCustom) {
                    const details = program.clinicalDetails || {};
                    const contact = program.contact || {};
                    const location = program.location || '';
                    
                    html += `
                        <div class="doc-program">
                            <div class="doc-program-title">${program.name}${location ? `  ${location}` : ''}</div>
                            
                            <div class="doc-program-descriptor">
                                <strong>Level of Care & Services Provided:</strong><br>
                                ${program.levelOfCare || program.type || 'Treatment program'}${details.ageRange ? ` for adolescents ages ${details.ageRange}` : ' for adolescents and young adults'}${details.primaryIssues ? `. Specializes in ${details.primaryIssues.toLowerCase()}.` : '.'}
                            </div>
                            
                            <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                            <ul class="doc-program-bullets">
                                ${program.features && program.features.length > 0 ? program.features.map(feature => {
                                    // Format features with bold concept introductions
                                    if (feature && feature.includes(':')) {
                                        const [concept, description] = feature.split(':');
                                        return `<li><strong>${concept.trim()}:</strong>${description.trim()}</li>`;
                                    }
                                    return feature ? `<li>${feature}</li>` : '';
                                }).filter(Boolean).join('') : '<li>Treatment program with comprehensive therapeutic services</li>'}
                                ${details.specializedTherapies ? `<li><strong>Therapeutic Modalities:</strong> ${details.specializedTherapies}</li>` : ''}
                                ${details.academicProgram ? `<li><strong>Academic Program:</strong> ${details.academicProgram}</li>` : ''}
                                ${details.staffRatio ? `<li><strong>Staff-to-Client Ratio:</strong> ${details.staffRatio}</li>` : ''}
                                ${details.insurance ? `<li><strong>Insurance:</strong> ${details.insurance}</li>` : ''}
                            </ul>
                            
                            <div class="doc-program-details-heading">Contact Information:</div>
                            <div class="doc-contact-section">
                                ${contact.phone ? `Phone: ${contact.phone}<br>` : ''}
                                ${contact.email ? `Email: ${contact.email}<br>` : ''}
                                ${contact.website ? `Website: ${contact.website}<br>` : ''}
                                ${location ? `Address: ${location}` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Extract services from levelOfCare
                    const services = program.levelOfCare.includes('Services:') 
                        ? program.levelOfCare.split('Services:')[1]?.trim() 
                        : 'Clinical Therapy, Psychiatric Support, Dual Diagnosis, Academics, Family Work';
                    
                    const location = program.location || '';
                    html += `
                        <div class="doc-program">
                            <div class="doc-program-title">${program.name}${location ? `  ${location}` : ''}</div>
                            
                            <div class="doc-program-descriptor">
                                <strong>Level of Care & Services Provided:</strong><br>
                                ${program.type || 'Residential treatment'} program for ${demographics || ageRange || 'adolescents and young adults'}. ${services ? `Provides ${services.toLowerCase()}.` : ''}
                            </div>
                            
                            <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                            <ul class="doc-program-bullets">
                                ${program.features.map(feature => {
                                // Format features with bold concept introductions
                                if (feature.includes(':')) {
                                    const [concept, description] = feature.split(':');
                                    return `<li><strong>${concept}:</strong>${description}</li>`;
                                }
                                return `<li>${feature}</li>`;
                            }).join('')}
                        </ul>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            ${program.contact.phone ? `Phone: ${program.contact.phone}<br>` : ''}
                            ${program.contact.email ? `Email: ${program.contact.email}<br>` : ''}
                            ${program.contact.website ? `Website: ${normalizeUrl(program.contact.website)}<br>` : ''}
                            ${program.location ? `Address: ${program.location}` : ''}
                        </div>
                    </div>
                `;
                }
            });
            
            // Add AT HOME Recommendations if checkbox is checked
            const includeAtHome = document.getElementById('includeAtHome').checked;
            console.log('Include AT HOME:', includeAtHome, 'Document Type:', documentType);
            if (includeAtHome && documentType === 'options' && atHomeProviders.length > 0) {
                html += `
                    <div class="doc-section-header doc-emphasis-section" style="margin-top: 24pt;">
                        AT HOME Recommendation: If extended residential care is not a viable option, below are the clinical recommendations should your child return home.
                    </div>
                `;
                
                // Group providers by service type for better organization
                const serviceGroups = {};
                atHomeProviders.forEach(provider => {
                    if (provider.name && provider.phone) { // Only include providers with required fields
                        const service = provider.service || 'General Services';
                        if (!serviceGroups[service]) {
                            serviceGroups[service] = [];
                        }
                        serviceGroups[service].push(provider);
                    }
                });
                
                // Render each service group using standard program formatting
                Object.keys(serviceGroups).forEach(service => {
                    html += `<div class="doc-category-header">${service}</div>`;
                    
                    serviceGroups[service].forEach(provider => {
                        const website = normalizeUrl(provider.website);
                        html += `
                            <div class="doc-program">
                                <div class="doc-program-title">${provider.name}${provider.address ? `  ${provider.address}` : ''}</div>
                                
                                <div class="doc-program-descriptor">
                                    <strong>Level of Care & Services Provided:</strong><br>
                                    ${provider.service || 'General Services'} - Community-based support for continued care at home.
                                </div>
                                
                                <div class="doc-program-details-heading">Contact Information:</div>
                                <div class="doc-contact-section">
                                    ${provider.phone ? `<strong>Phone:</strong> ${provider.phone}<br>` : ''}
                                    ${website ? `<strong>Website:</strong> <a href="${website}" target="_blank" rel="noopener">${website}</a><br>` : ''}
                                    ${provider.address ? `<strong>Address:</strong> ${provider.address}` : ''}
                                </div>
                            </div>
                        `;
                    });
                });
            } else if (includeAtHome && documentType === 'options') {
                html += `
                    <div class="doc-section-header doc-emphasis-section" style="margin-top: 24pt;">
                        AT HOME Recommendation: If extended residential care is not a viable option, below are the clinical recommendations should your child return home.
                    </div>
                    
                    <div class="doc-category-header">PHP Options</div>
                    
                    <!-- Standard program format for manual entry -->
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________  PHP, _____________ Location</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Partial Hospitalization Program - Intensive day treatment for adolescents requiring structured support.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                             <strong>Clinical Approach:</strong> _________________________________________________<br>
                             <strong>Population Served:</strong> ________________________________________________<br>
                             <strong>Schedule:</strong> _________________________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________  PHP, _____________ Location</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Partial Hospitalization Program - Intensive day treatment for adolescents requiring structured support.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                             <strong>Clinical Approach:</strong> _________________________________________________<br>
                             <strong>Population Served:</strong> ________________________________________________<br>
                             <strong>Schedule:</strong> _________________________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                    
                    <div class="doc-category-header">IOP Options</div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________  IOP, _____________ Location</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Intensive Outpatient Program - Structured outpatient treatment for adolescents transitioning to community care.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                             <strong>Clinical Approach:</strong> _________________________________________________<br>
                             <strong>Population Served:</strong> ________________________________________________<br>
                             <strong>Schedule:</strong> _________________________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                    
                    <div class="doc-category-header">Therapeutic Support</div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________  Individual Therapy</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Individual Therapy - One-on-one therapeutic support for continued mental health care.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                             <strong>Therapeutic Approach:</strong> _______________________________________________<br>
                             <strong>Specialties:</strong> _______________________________________________________<br>
                             <strong>Session Frequency:</strong> __________________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________  Psychiatry</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Psychiatric Services - Medication management and psychiatric evaluation for ongoing mental health care.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                             <strong>Services Offered:</strong> __________________________________________________<br>
                             <strong>Specialties:</strong> _______________________________________________________<br>
                             <strong>Appointment Frequency:</strong> ______________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                `;
            }
            
            // Add Alumni Services if checkbox is checked
            const includeAlumni = document.getElementById('includeAlumni').checked;
            if (includeAlumni) {
                html += `
                    <div class="doc-section-header" style="margin-top: 24pt;">Alumni Services</div>
                    
                    <div class="doc-program" style="margin-bottom: 12pt;">
                        <div class="doc-program-title" style="font-weight: bold;">Parent Focus Group</div>
                        <div class="doc-program-content" style="margin-top: 8pt;">
                            <strong>Thursday's 3:30pm-5:00pm EST</strong><br>
                            <a href="https://us06web.zoom.us/j/89418742321?pwd=lln0XmbUHF1bk4bUi7y4Q6GObFmMQh.1" style="color: #0099cc;">https://us06web.zoom.us/j/89418742321?pwd=lln0XmbUHF1bk4bUi7y4Q6GObFmMQh.1</a><br>
                            Meeting ID: 894 1874 2321<br>
                            Passcode: 056912<br><br>
                            
                            <strong>Friday's 3:30pm-5:00pm EST</strong><br>
                            <a href="https://us06web.zoom.us/j/89876708775?pwd=swYjZuM7EiUr89sR8SYpY7M60y1FAH.1" style="color: #0099cc;">https://us06web.zoom.us/j/89876708775?pwd=swYjZuM7EiUr89sR8SYpY7M60y1FAH.1</a><br>
                            Meeting ID: 898 7670 8775<br>
                            Passcode: 374367
                        </div>
                    </div>
                    
                    <div class="doc-program" style="margin-bottom: 12pt;">
                        <div class="doc-program-title" style="font-weight: bold;">Alumni Programming (Parent Support Group)</div>
                        <div class="doc-program-content" style="margin-top: 8pt;">
                            <strong>Wednesday and Sunday, 7:00pm-8:00pm EST</strong><br>
                            <a href="https://us02web.zoom.us/j/88924044948?pwd=aUl2ejRFdldXODFyRlZrVorVGNaUT09" style="color: #0099cc;">https://us02web.zoom.us/j/88924044948?pwd=aUl2ejRFdldXODFyRlZrVorVGNaUT09</a><br>
                            Meeting ID: 889 2404 4948<br>
                            Passcode: Family123
                        </div>
                    </div>
                    
                    <div class="doc-program" style="margin-bottom: 12pt;">
                        <div class="doc-program-title" style="font-weight: bold;">PRESERVE Alumni Programming</div>
                        <div class="doc-program-content" style="margin-top: 8pt;">
                            <strong>Friday, 4:30pm-5:30pm EST</strong><br>
                            <a href="https://us06web.zoom.us/j/86864413744" style="color: #0099cc;">https://us06web.zoom.us/j/86864413744</a>
                        </div>
                    </div>
                `;
            }
            
            // Close content div
            html += `
                    </div>
                    
                    <!-- Footer - stacked format -->
                    <div class="doc-footer">
                        <div>700 Village Square Crossing, Unit 101, Palm Beach Gardens, FL 33410</div>
                        <div>(561) 328-7370  familyfirstas.com</div>
                    </div>
                </div>
            `;
            
            // Cache generated document for preview, printing, and downloads
            lastDocumentHtml = html;
            const outputContainer = document.getElementById('documentOutput');
            if (outputContainer) {
                outputContainer.innerHTML = html;
            }
            renderDocumentPreview(html);
            clearInterval(progressInterval); // Clear progress updates
            hideLoadingSpinner();
            openDocumentPreview();
            }, 300); // End of setTimeout
            showSuccessMessage('Document ready  review before printing.');
            
            // Save to vault and history with enhanced metadata
            const vaultDoc = {
                clientName: clientName,
                date: new Date().toISOString(),
                content: html,
                type: 'aftercare',
                documentType: documentType,
                programs: selectedPrograms.map(p => ({
                    name: p.name,
                    location: p.location,
                    phone: p.contact?.phone || p.phone
                })),
                atHomeProviders: atHomeProviders.length > 0 ? atHomeProviders : null,
                htmlContent: html  // Store the full HTML for PDF generation
            };
            const vault = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentVault) || '[]');
            vault.push(vaultDoc);
            localStorage.setItem(STORAGE_KEYS.documentVault, JSON.stringify(vault));
            
            // Save to history
            saveToHistory({
                clientName: clientName,
                documentType: documentType,
                programs: selectedPrograms
            });
            
            // Track analytics
            trackAnalytics('document');
            selectedPrograms.forEach(p => {
                trackAnalytics('program', p.name);
            });
        }
        
        // ================ ENHANCED FUNCTIONS ================

        function renderDocumentPreview(html) {
            const container = document.getElementById('documentPreviewContainer');
            if (container) {
                container.innerHTML = html;
            }
        }

        function openDocumentPreview() {
            const modal = document.getElementById('documentPreviewModal');
            if (!modal) return;
            modal.style.display = 'block';
            requestAnimationFrame(() => modal.classList.add('show'));
        }

        function closeDocumentPreview() {
            const modal = document.getElementById('documentPreviewModal');
            if (!modal) return;
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }

        function getDocumentStyles() {
            const styleTags = Array.from(document.querySelectorAll('head style, head link[rel="stylesheet"]'));
            return styleTags.map(tag => {
                if (tag.tagName === 'STYLE') {
                    return tag.innerHTML;
                }
                if (tag.tagName === 'LINK' && tag.href) {
                    return `@import url('${tag.href}');`;
                }
                return '';
            }).join('\n');
        }

        function printDocumentPreview() {
            if (!lastDocumentHtml) {
                alert('Generate the document before printing.');
                return;
            }

            const printWindow = window.open('', '_blank', 'noopener');
            if (!printWindow) {
                alert('Unable to open print window. Please allow popups for this site.');
                return;
            }

            const styles = getDocumentStyles();
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Aftercare Recommendations</title>
                    <style>${styles}</style>
                </head>
                <body>${lastDocumentHtml}</body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 300);
        }

        async function downloadDocumentPdf(event) {
            // Get the document content
            let documentContent = '';
            const previewContainer = document.getElementById('documentPreviewContainer');
            
            if (previewContainer && previewContainer.innerHTML.trim()) {
                documentContent = previewContainer.innerHTML;
            } else if (lastDocumentHtml) {
                documentContent = lastDocumentHtml;
            } else {
                const outputContainer = document.getElementById('documentOutput');
                if (outputContainer && outputContainer.innerHTML.trim()) {
                    documentContent = outputContainer.innerHTML;
                } else {
                    alert('Please generate a document first before downloading.');
                return;
                }
            }

            // Show loading indicator
            const originalButtonText = event?.target?.innerHTML;
            if (event?.target) {
                event.target.innerHTML = ' Generating PDF...';
                event.target.disabled = true;
            }

            try {
                // Check if jsPDF and html2canvas are loaded
                if (!window.jspdf || !window.html2canvas) {
                    throw new Error('PDF libraries not loaded. Please refresh the page and try again.');
                }

                // Create a clean container for PDF generation
                const pdfContainer = document.createElement('div');
                pdfContainer.style.position = 'absolute';
                pdfContainer.style.left = '-9999px';
                pdfContainer.style.top = '0';
                pdfContainer.style.width = '816px'; // 8.5 inches at 96 DPI
                pdfContainer.style.padding = '48px'; // 0.5 inch margins
                pdfContainer.style.background = 'white';
                pdfContainer.style.fontFamily = 'Calibri, Arial, sans-serif';
                pdfContainer.style.fontSize = '12pt';
                pdfContainer.style.lineHeight = '1.4';
                pdfContainer.style.color = '#000';
                
                // Set the content
                pdfContainer.innerHTML = documentContent;
                
                // Ensure header and footer are properly styled
                const docHeader = pdfContainer.querySelector('.doc-letterhead');
                if (docHeader) {
                    docHeader.style.marginBottom = '20px';
                }
                
                // Remove the original footer since we'll add it consistently on each page
                const docFooter = pdfContainer.querySelector('.doc-footer');
                if (docFooter) {
                    docFooter.remove();
                }
                
                // Clean up any interactive elements
                const buttons = pdfContainer.querySelectorAll('button');
                buttons.forEach(btn => btn.remove());
                
                // Ensure all styles are applied
                const allElements = pdfContainer.querySelectorAll('*');
                allElements.forEach(el => {
                    const computedStyle = window.getComputedStyle(el);
                    if (computedStyle.fontFamily.includes('Calibri')) {
                        el.style.fontFamily = 'Calibri, Arial, sans-serif';
                    }
                });
                
                document.body.appendChild(pdfContainer);

                // Wait for content to render
                await new Promise(resolve => setTimeout(resolve, 100));

                // Use html2canvas to capture the content
                const canvas = await html2canvas(pdfContainer, {
                    scale: 2, // Higher quality
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: 816,
                    windowWidth: 816
                });

                // Remove the temporary container
                document.body.removeChild(pdfContainer);

                // Create PDF from canvas
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'letter' // 612 x 792 pt
                });

                // Calculate dimensions
                const imgWidth = 612; // Letter width in points
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pageHeight = 792; // Letter height in points
                
                // Add image to PDF, handling multiple pages if needed
                let position = 0;
                let remainingHeight = imgHeight;
                let pageNum = 0;
                
                while (remainingHeight > 0) {
                    // Add a new page if not the first page
                    if (position > 0) {
                        pdf.addPage();
                    }
                    pageNum++;
                    
                    // Calculate how much of the image to add to this page
                    const pageCanvas = document.createElement('canvas');
                    const pageCtx = pageCanvas.getContext('2d');
                    const sourceY = (position * canvas.height) / imgHeight;
                    const sourceHeight = Math.min((pageHeight * canvas.height) / imgHeight, canvas.height - sourceY);
                    
                    pageCanvas.width = canvas.width;
                    pageCanvas.height = sourceHeight;
                    
                    // Draw the portion of the image for this page
                    pageCtx.drawImage(
                        canvas,
                        0, sourceY, canvas.width, sourceHeight,
                        0, 0, canvas.width, sourceHeight
                    );
                    
                    // Add to PDF
                    const pageData = pageCanvas.toDataURL('image/png');
                    const addHeight = Math.min(pageHeight, remainingHeight);
                    
                    // Add image with space for header and footer
                    const headerSpace = pageNum === 1 ? 0 : 60; // Space for header on pages 2+
                    const footerSpace = 60; // Space for footer on all pages
                    const contentHeight = Math.min(pageHeight - headerSpace - footerSpace, addHeight);
                    
                    pdf.addImage(pageData, 'PNG', 0, headerSpace, imgWidth, contentHeight);
                    
                    // Add header on pages 2+
                    if (pageNum > 1) {
                        pdf.setFontSize(16);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 153, 204); // #0099cc
                        pdf.text('Family First', 306, 30, { align: 'center' });
                        pdf.setFontSize(12);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text('ADOLESCENT SERVICES', 306, 45, { align: 'center' });
                    }
                    
                    // Add footer on all pages
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(51, 51, 51);
                    pdf.text('700 Village Square Crossing, Unit 101, Palm Beach Gardens, FL 33410', 306, pageHeight - 35, { align: 'center' });
                    pdf.text('(561) 328-7370  familyfirstas.com', 306, pageHeight - 20, { align: 'center' });
                    
                    position += pageHeight - headerSpace;
                    remainingHeight -= pageHeight - headerSpace;
                }

                        // Get client name for filename
                        const clientNameInput = document.getElementById('clientName');
                        const clientName = clientNameInput ? 
                            (clientNameInput.value || 'Client').trim().replace(/[^a-zA-Z0-9]/g, '-') : 
                            'Client';
                        
                        const date = new Date().toISOString().split('T')[0];
                        const docTypeLabel = documentType === 'options' ? 'Options' : 'Plans';
                        const filename = `${clientName}_${docTypeLabel}_${date}.pdf`;
                        
                        // Save the PDF
                pdf.save(filename);
                        
                        // Show success message
                        showSuccessMessage('PDF downloaded successfully!');

            } catch (error) {
                console.error('PDF generation error:', error);
                
                // Fallback to simple download method
                try {
                    fallbackDownloadMethod();
                } catch (fallbackError) {
                    console.error('Fallback download failed:', fallbackError);
                    alert('Unable to generate PDF. Please try the Print option and save as PDF instead.');
                }
            } finally {
                // Clean up
                const pdfContainer = document.querySelector('div[style*="-9999px"]');
                if (pdfContainer) {
                    document.body.removeChild(pdfContainer);
                }
                
                // Restore button
                if (event?.target) {
                    event.target.innerHTML = originalButtonText || ' Download PDF';
                    event.target.disabled = false;
                }
            }
        }

        // Case Manager Workflow Functions
        function emailDocument() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            // Create email content
            const subject = `Aftercare Document - ${clientName}`;
            const body = `Please find the aftercare document for ${clientName}.${notes ? '\n\nCase Management Notes:\n' + notes : ''}`;
            
            // Open email client
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            showSuccessMessage('Email client opened with document details');
        }

        function saveToVault() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            if (!lastDocumentHtml) {
                alert('Please generate a document first');
                return;
            }
            
            // Save to document vault
            const vault = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentVault) || '[]');
            const documentData = {
                id: Date.now(),
                clientName: clientName,
                type: 'aftercare',
                content: lastDocumentHtml,
                notes: notes,
                date: new Date().toISOString(),
                programs: getSelectedPrograms()
            };
            
            vault.push(documentData);
            localStorage.setItem(STORAGE_KEYS.documentVault, JSON.stringify(vault));
            
            showSuccessMessage('Document saved to vault successfully');
        }

        function addToDischargePacket() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            if (!lastDocumentHtml) {
                alert('Please generate a document first');
                return;
            }
            
            // Add to discharge packet
            const packets = JSON.parse(localStorage.getItem(STORAGE_KEYS.dischargePackets) || '[]');
            let clientPacket = packets.find(p => p.clientName === clientName);
            
            if (!clientPacket) {
                clientPacket = {
                    clientName: clientName,
                    documents: [],
                    created: new Date().toISOString()
                };
                packets.push(clientPacket);
            }
            
            clientPacket.documents.push({
                type: 'aftercare',
                content: lastDocumentHtml,
                notes: notes,
                added: new Date().toISOString()
            });
            
            localStorage.setItem(STORAGE_KEYS.dischargePackets, JSON.stringify(packets));
            showSuccessMessage('Document added to discharge packet');
        }

        function scheduleFollowUp() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            // Create calendar event
            const title = `Follow-up: ${clientName} Aftercare`;
            const details = `Follow-up for aftercare document.${notes ? '\n\nNotes: ' + notes : ''}`;
            const startDate = new Date();
            startDate.setDate(startDate.getDate() + 7); // Default to 1 week from now
            
            const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent(details)}&dates=${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z`;
            
            window.open(calendarUrl, '_blank');
            showSuccessMessage('Calendar opened for follow-up scheduling');
        }

        function createTaskReminder() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            // Save reminder to local storage
            const reminders = JSON.parse(localStorage.getItem('ffas_reminders') || '[]');
            const reminder = {
                id: Date.now(),
                clientName: clientName,
                task: 'Follow up on aftercare document',
                notes: notes,
                dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 1 week from now
                created: new Date().toISOString(),
                completed: false
            };
            
            reminders.push(reminder);
            localStorage.setItem('ffas_reminders', JSON.stringify(reminders));
            
            showSuccessMessage('Task reminder created for 1 week from now');
        }

        function shareWithTeam() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            // Create shareable link or copy content
            if (navigator.share) {
                navigator.share({
                    title: `Aftercare Document - ${clientName}`,
                    text: `Aftercare document for ${clientName}${notes ? '\n\nNotes: ' + notes : ''}`,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                const shareText = `Aftercare Document - ${clientName}\n\nGenerated: ${new Date().toLocaleDateString()}\n${notes ? 'Notes: ' + notes + '\n' : ''}\nDocument available in system.`;
                
                navigator.clipboard.writeText(shareText).then(() => {
                    showSuccessMessage('Document details copied to clipboard for sharing');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = shareText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showSuccessMessage('Document details copied to clipboard for sharing');
                });
            }
        }

        function generateNewDocument() {
            // Clear current document and return to form
            closeDocumentPreview();
            
            // Optionally clear form or keep current selections
            const keepSelections = confirm('Keep current program selections for new document?');
            if (!keepSelections) {
                clearAllSelections();
            }
            
            // Clear client name to encourage new entry
            const clientNameField = document.getElementById('clientName');
            if (clientNameField) {
                clientNameField.value = '';
                clientNameField.focus();
            }
            
            showSuccessMessage('Ready to generate new document');
        }

        // Fallback download method using data URL
        function fallbackDownloadMethod() {
            const previewContainer = document.getElementById('documentPreviewContainer');
            const content = previewContainer ? previewContainer.innerHTML : lastDocumentHtml;
            
            if (!content) {
                throw new Error('No content to download');
            }

            // Create a complete HTML document
            const fullHtml = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Aftercare Recommendations</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            margin: 40px;
                        }
                        h1 { color: #0099cc; }
                        h2 { color: #333; margin-top: 30px; }
                        h3 { color: #666; }
                        .program-section {
                            margin-bottom: 30px;
                            page-break-inside: avoid;
                        }
                        @media print {
                            body { margin: 20px; }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;

            // Create blob and download
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const clientNameInput = document.getElementById('clientName');
            const clientName = clientNameInput ? 
                (clientNameInput.value || 'Client').trim().replace(/[^a-zA-Z0-9]/g, '-') : 
                'Client';
            
            a.href = url;
            a.download = `${clientName}_Aftercare.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessMessage('Document downloaded as HTML. You can open it and print to PDF.');
        }

        // Helper function to show success messages
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                font-weight: 600;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
        
        // Storage Keys
        const STORAGE_KEYS = {
            selectedPrograms: 'aftercare_selected_programs',
            documentHistory: 'aftercare_document_history',
            theme: 'aftercare_theme',
            documentVault: 'ffas_document_vault',
            dischargePackets: 'ffas_discharge_packets',
            patientRecords: 'ffas_patient_records'
        };
        
        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            
            if (isDark) {
                icon.textContent = '';
                text.textContent = 'Light Mode';
                localStorage.setItem(STORAGE_KEYS.theme, 'dark');
            } else {
                icon.textContent = '';
                text.textContent = 'Dark Mode';
                localStorage.setItem(STORAGE_KEYS.theme, 'light');
            }
        }
        
        // Priority Management
        let currentPriority = 'high';
        function setPriority(level, btn) {
            currentPriority = level;
            document.querySelectorAll('.priority-btn').forEach(b => {
                b.classList.remove('active');
                b.style.background = 'white';
            });
            btn.classList.add('active');
            if (level === 'urgent') {
                btn.style.background = '#fee2e2';
            } else if (level === 'high') {
                btn.style.background = '#fef3c7';
            } else {
                btn.style.background = '#dcfce7';
            }
        }
        
        // Quick Selection Functions for Case Managers
        function selectLevelOfCare(level) {
            const programs = document.querySelectorAll('.program-card');
            programs.forEach(card => {
                const programText = card.textContent.toLowerCase();
                if ((level === 'PHP' && programText.includes('partial hospitalization')) ||
                    (level === 'IOP' && (programText.includes('intensive outpatient') || programText.includes('iop')))) {
                    if (!card.classList.contains('selected')) {
                        card.click();
                    }
                }
            });
            showSuccessMessage(`Selected all ${level} programs`);
        }
        
        function selectVirtualPrograms() {
            const programs = document.querySelectorAll('.program-card');
            programs.forEach(card => {
                const programText = card.textContent.toLowerCase();
                if (programText.includes('virtual') || programText.includes('online') || programText.includes('telehealth')) {
                    if (!card.classList.contains('selected')) {
                        card.click();
                    }
                }
            });
            showSuccessMessage('Selected all virtual programs');
        }
        
        function clearAllSelections() {
            const selectedPrograms = document.querySelectorAll('.program-card.selected');
            selectedPrograms.forEach(card => card.click());
            showSuccessMessage('Cleared all selections');
        }
        
        // Select All Programs
        function selectAllPrograms() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            let toSelect = programs;
            
            if (currentFilter !== 'all') {
                toSelect = toSelect.filter(p => p.category === currentFilter);
            }
            
            toSelect.forEach(program => {
                if (!selectedPrograms.find(p => p.id === program.id)) {
                    selectedPrograms.push(program);
                }
            });
            
            updateSelectedPrograms();
            displayPrograms();
        }
        
        // Clear All Programs
        function clearAllPrograms() {
            if (selectedPrograms.length === 0) {
                showNotification('No programs to clear', 'info');
                return;
            }
            
            const count = selectedPrograms.length;
            const msg = `Clear ${count} program${count > 1 ? 's' : ''}?`;
            
            if (confirm(msg)) {
                // Save for undo
                saveUndoAction('clear', { programs: [...selectedPrograms] });
            selectedPrograms = [];
                updateSelectionPanel();
                renderPrograms();
                showNotification(`Cleared ${count} program${count > 1 ? 's' : ''}`, 'info');
            }
        }
        
        // Select by Category
        function selectByCategory() {
            const category = prompt('Enter category (virtual, rtc, tbs, wilderness, php-iop, transitional):');
            if (category) {
                const categoryPrograms = programs.filter(p => p.category === category.toLowerCase());
                categoryPrograms.forEach(program => {
                    if (!selectedPrograms.find(p => p.id === program.id)) {
                        selectedPrograms.push(program);
                    }
                });
                updateSelectedPrograms();
                displayPrograms();
            }
        }
        
        // Compare Programs
        function comparePrograms() {
            if (selectedPrograms.length < 2) {
                alert('Please select at least 2 programs to compare');
                return;
            }
            
            const comparisonView = document.getElementById('comparisonView');
            const content = document.getElementById('comparisonContent');
            
            const comparePrograms = selectedPrograms.slice(0, 3);
            
            content.innerHTML = comparePrograms.map(program => `
                <div class="comparison-column">
                    <h3>${program.name}</h3>
                    <p><strong>Location:</strong> ${program.location}</p>
                    <p><strong>Type:</strong> ${program.type}</p>
                    <p><strong>Level of Care:</strong> ${program.levelOfCare}</p>
                    <h4>Features:</h4>
                    <ul style="font-size: 12px;">
                        ${program.features.slice(0, 5).map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
            
            comparisonView.style.display = 'block';
        }
        
        function closeComparison() {
            document.getElementById('comparisonView').style.display = 'none';
        }
        
        // Document History
        function saveToHistory(documentData) {
            let history = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentHistory) || '[]');
            
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                clientName: documentData.clientName,
                documentType: documentData.documentType,
                programCount: documentData.programs.length,
                programs: documentData.programs
            };
            
            history.unshift(historyItem);
            
            if (history.length > 10) {
                history = history.slice(0, 10);
            }
            
            localStorage.setItem(STORAGE_KEYS.documentHistory, JSON.stringify(history));
            updateHistoryPanel();
        }
        
        function updateHistoryPanel() {
            const historyContent = document.getElementById('historyContent');
            const history = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentHistory) || '[]');
            
            if (history.length === 0) {
                historyContent.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">No documents generated yet</p>';
                return;
            }
            
            historyContent.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadFromHistory('${item.id}')">
                    <strong>${item.clientName}</strong><br>
                    <small>${new Date(item.timestamp).toLocaleString()}</small><br>
                    <small>${item.documentType.toUpperCase()} - ${item.programCount} programs</small>
                </div>
            `).join('');
        }
        
        function loadFromHistory(historyId) {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentHistory) || '[]');
            const item = history.find(h => h.id == historyId);
            
            if (item) {
                document.getElementById('clientName').value = item.clientName;
                selectedPrograms = item.programs;
                updateSelectedPrograms();
                displayPrograms();
                toggleHistory();
            }
        }
        
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('active');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                updateHistoryPanel();
            }
        }
        
        // Export Database
        function exportDatabase() {
            const exportData = {
                version: programDatabase.version,
                exportDate: new Date().toISOString(),
                programs: programs,
                totalPrograms: programs.length
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `aftercare_programs_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Import Database
        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        if (importData.programs && Array.isArray(importData.programs)) {
                            if (confirm(`Import ${importData.programs.length} programs?`)) {
                                programs.length = 0;
                                programs.push(...importData.programs);
                                displayPrograms();
                                alert('Database imported successfully!');
                            }
                        }
                    } catch(error) {
                        alert('Error importing database: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchBox').focus();
            }
            
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                generateDocument();
            }
            
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
            }
        });
        
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Application error:', event.error);
            showErrorMessage('Something went wrong. Your work has been saved. Please refresh the page.');
            // Try to save state before potential crash
            try {
                autoSaveState();
            } catch (e) {
                console.error('Failed to save state during error:', e);
            }
        });
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showErrorMessage('An error occurred. Please try again.');
        });
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            try {
            // Load theme
            const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').textContent = '';
                document.getElementById('themeText').textContent = 'Light Mode';
            }
            
            // Update history
            updateHistoryPanel();
            
            // Update compare count
            document.getElementById('compareCount').textContent = '0';
                
                // Initialize programs and other features
                renderPrograms();
                loadCustomPrograms();
                
                // Restore auto-saved work
                if (sessionStorage.getItem('isLoggedIn') === 'true') {
                    restoreAutoSave();
                }
                
                // Show keyboard shortcuts hint
                setTimeout(() => {
                    if (sessionStorage.getItem('isLoggedIn') === 'true') {
                        showSuccessMessage('Tip: Use Ctrl+G to generate, Ctrl+S to save, Ctrl+P to print', 5000);
                    }
                }, 3000);
            } catch (error) {
                console.error('Initialization error:', error);
                showErrorMessage('Failed to initialize. Please refresh the page.');
            }
        });
    </script>
    
    <!-- ClearHive Branding -->
    <div style="text-align: center; padding: 20px; border-top: 1px solid #eee; margin-top: 40px; color: #999; font-size: 12px;">
        Document Creator by <strong>ClearHive Health LLC</strong>
    </div>
</body>
</html>