<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect Pro ‚Äî Programs & Document Creator</title>
    <meta name="description" content="Three-pane Programs and Document Creator workspace for CareConnect Pro.">
    <style>
        :root {
            --navy-900: #0F1020;
            --navy-700: #151633;
            --navy-500: #1F2145;
            --accent-500: #6E7BFF;
            --accent-400: #8D97FF;
            --accent-200: #C9CEFF;
            --neutral-50: #F7F8FF;
            --neutral-100: #E9ECFF;
            --neutral-200: #D7DBF8;
            --neutral-400: #9FA6D7;
            --surface: #FFFFFF;
            --surface-alt: rgba(239, 241, 255, 0.75);
            --text-strong: #151633;
            --text-subtle: #48508A;
            --success: #4CAF9F;
            --warning: #FFB347;
            --danger: #FF6B6B;
            --shadow-soft: 0 12px 30px rgba(15, 16, 32, 0.18);
            --shadow-card: 0 16px 40px rgba(15, 16, 32, 0.12);
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --transition-fast: 160ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-medium: 260ms cubic-bezier(0.22, 1, 0.36, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Segoe UI", "Inter", "Helvetica Neue", Arial, sans-serif;
            color: var(--text-strong);
            background:
                radial-gradient(circle at 12% 18%, rgba(203, 207, 255, 0.35), transparent 45%),
                radial-gradient(circle at 88% 8%, rgba(110, 123, 255, 0.22), transparent 52%),
                linear-gradient(145deg, #ffffff 0%, #F3F4FF 100%);
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(circle at 20% 70%, rgba(110, 123, 255, 0.08), transparent 60%);
            z-index: -1;
        }

        .toolbar {
            position: sticky;
            top: 0;
            z-index: 20;
            padding: 18px 28px;
            display: grid;
            grid-template-columns: 320px 1fr auto;
            gap: 18px;
            align-items: center;
            background: rgba(15, 16, 32, 0.88);
            color: #fff;
            backdrop-filter: blur(14px);
            border-bottom: 1px solid rgba(233, 236, 255, 0.16);
            box-shadow: 0 12px 32px rgba(10, 12, 32, 0.24);
        }

        .toolbar__brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .toolbar__brand span {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            font-weight: 700;
        }

        .toolbar__search {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar__search label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(233, 236, 255, 0.14);
            border-radius: 999px;
            width: 100%;
            border: 1px solid transparent;
            transition: border var(--transition-fast), background var(--transition-fast);
        }

        .toolbar__search label:focus-within {
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.26);
        }

        .toolbar__search input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.95rem;
            background: transparent;
            color: #fff;
        }

        .toolbar__search input::placeholder {
            color: rgba(255, 255, 255, 0.65);
        }

        .toolbar__actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar__document-toggle {
            display: inline-flex;
            align-items: center;
            padding: 4px;
            gap: 6px;
            border-radius: 999px;
            border: 1px solid rgba(233, 236, 255, 0.2);
            background: rgba(233, 236, 255, 0.12);
        }

        .toolbar__document-toggle-btn {
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.78);
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .toolbar__document-toggle-btn:is(:hover, :focus-visible) {
            color: #fff;
            background: rgba(233, 236, 255, 0.18);
            transform: translateY(-1px);
        }

        .toolbar__document-toggle-btn.is-active {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(110, 123, 255, 0.3);
        }

        button,
        select {
            font: inherit;
        }

        .pill-button {
            padding: 10px 18px;
            border-radius: 999px;
            border: 1px solid rgba(233, 236, 255, 0.24);
            background: rgba(233, 236, 255, 0.08);
            color: #fff;
            cursor: pointer;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
        }

        .pill-button:is(:hover, :focus-visible) {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(110, 123, 255, 0.36);
            background: rgba(233, 236, 255, 0.18);
        }

        .pill-button.is-primary {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            font-weight: 600;
        }

        .pill-button.is-primary:is(:hover, :focus-visible) {
            background: linear-gradient(135deg, var(--accent-400), var(--accent-200));
        }

        .toolbar__document-select {
            border-radius: 999px;
            padding: 10px 18px;
            border: 1px solid rgba(233, 236, 255, 0.2);
            background: rgba(233, 236, 255, 0.08);
            color: #fff;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 280px minmax(520px, 1fr) 360px;
            gap: 24px;
            padding: 32px 28px 80px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .pane {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            min-height: 540px;
        }

        h1, h2, h3, h4 {
            font-family: "Segoe UI", "Inter", sans-serif;
            margin: 0;
        }

        .filters h2,
        .builder h2 {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .filters__group {
            margin-top: 22px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chip {
            padding: 8px 14px;
            border-radius: 999px;
            background: var(--neutral-50);
            border: 1px solid transparent;
            color: var(--text-subtle);
            font-size: 0.85rem;
            cursor: pointer;
            transition: transform var(--transition-fast), border var(--transition-fast), background var(--transition-fast), color var(--transition-fast);
        }

        .chip:is(:hover, :focus-visible) {
            transform: translateY(-2px);
            border-color: var(--accent-200);
            color: var(--navy-700);
        }

        .chip.is-active {
            background: rgba(110, 123, 255, 0.16);
            border-color: var(--accent-400);
            color: var(--navy-700);
            font-weight: 600;
        }

        .filters__meta {
            margin-top: auto;
            padding-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-top: 1px solid rgba(21, 22, 51, 0.08);
        }

        .filters__meta small {
            color: var(--text-subtle);
        }

        .results {
            position: relative;
            gap: 24px;
        }

        .results__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .results__header-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .results__count {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .results__filters {
            color: var(--text-subtle);
            font-size: 0.85rem;
        }

        .results__controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .view-toggle {
            display: inline-flex;
            padding: 4px;
            border-radius: 999px;
            background: var(--neutral-50);
            border: 1px solid rgba(21, 22, 51, 0.08);
            gap: 6px;
        }

        .view-toggle button {
            border: none;
            background: transparent;
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 0.85rem;
            color: var(--text-subtle);
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .view-toggle button.is-active {
            background: linear-gradient(135deg, rgba(110, 123, 255, 0.22), rgba(110, 123, 255, 0.05));
            color: var(--navy-700);
            font-weight: 600;
            transform: translateY(-1px);
        }

        .results select {
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid rgba(21, 22, 51, 0.08);
            background: var(--neutral-50);
            color: var(--text-strong);
        }

        .results__grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 18px;
        }

        .results__grid.is-compact {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 14px;
        }

        .results__map {
            display: none;
            width: 100%;
            flex: 1;
            min-height: 420px;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-card);
        }

        .results__map.is-visible {
            display: block;
        }

        .map-legend {
            position: absolute;
            top: 120px;
            right: 24px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
            display: none;
            flex-direction: column;
            gap: 8px;
            font-size: 0.78rem;
            color: var(--text-subtle);
            z-index: 10;
        }

        .map-legend.is-visible {
            display: flex;
        }

        .map-legend__title {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-subtle);
        }

        .map-legend__row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-legend__count {
            margin-left: auto;
            font-weight: 600;
            color: var(--text-strong);
        }

        .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 6px rgba(15, 16, 32, 0.2);
        }

        .legend-swatch--onsite {
            background: #6E7BFF;
        }

        .legend-swatch--hybrid {
            background: linear-gradient(135deg, #6E7BFF, #4CAF9F);
        }

        .legend-swatch--virtual {
            background: #10B981;
        }

        .legend-swatch--telehealth {
            background: #FFA94D;
        }

        .results__map {
            display: none;
            flex-direction: column;
            gap: 12px;
            min-height: 480px;
            position: relative;
        }

        .results__map.is-visible {
            display: flex;
        }

        .map-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            background: rgba(233, 236, 255, 0.4);
            border: 1px solid rgba(110, 123, 255, 0.16);
            color: var(--text-subtle);
            font-size: 0.85rem;
        }

        .map-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-canvas {
            flex: 1;
            min-height: 440px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid rgba(110, 123, 255, 0.18);
            box-shadow: var(--shadow-soft);
        }

        .leaflet-container {
            width: 100%;
            height: 100%;
        }

        .map-legend {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .map-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .map-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-subtle);
        }

        .map-control span strong {
            color: var(--navy-700);
        }

        .map-control input[type="text"],
        .map-control select,
        .map-control input[type="range"] {
            border-radius: 10px;
            border: 1px solid rgba(110, 123, 255, 0.24);
            background: rgba(255, 255, 255, 0.85);
            color: var(--text-strong);
            font-size: 0.82rem;
            padding: 6px 10px;
        }

        .map-control input[type="text"]:focus,
        .map-control select:focus {
            outline: none;
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.9);
        }

        .map-control--radius input[type="range"] {
            width: 160px;
            padding: 0;
            background: transparent;
        }

        .map-control__button {
            border: none;
            border-radius: 999px;
            background: rgba(110, 123, 255, 0.2);
            color: var(--navy-700);
            padding: 6px 14px;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .map-control__button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.32);
            transform: translateY(-1px);
        }

        .map-legend__item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78rem;
            color: var(--text-subtle);
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(21, 22, 51, 0.08);
        }

        .map-marker-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-500);
        }

        .results__compare {
            display: none;
            flex-direction: column;
            gap: 16px;
        }

        .results__compare.is-visible {
            display: flex;
        }

        .compare-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(110, 123, 255, 0.16);
            background: rgba(233, 236, 255, 0.4);
        }

        .compare-status {
            font-size: 0.85rem;
            color: var(--text-subtle);
        }

        .compare-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .compare-action__button {
            border: none;
            border-radius: 999px;
            padding: 6px 14px;
            background: rgba(110, 123, 255, 0.2);
            color: var(--navy-700);
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .compare-action__button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.32);
            transform: translateY(-1px);
        }

        .compare-grid {
            display: grid;
            gap: 16px;
            overflow-x: auto;
        }

        .compare-grid--columns-1 {
            grid-template-columns: minmax(240px, 320px);
        }

        .compare-grid--columns-2 {
            grid-template-columns: repeat(2, minmax(240px, 1fr));
        }

        .compare-grid--columns-3 {
            grid-template-columns: repeat(3, minmax(240px, 1fr));
        }

        .compare-grid--columns-4 {
            grid-template-columns: repeat(4, minmax(240px, 1fr));
        }

        .compare-card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(110, 123, 255, 0.2);
            box-shadow: var(--shadow-soft);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }

        .compare-card header {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .compare-remove {
            position: absolute;
            top: 12px;
            right: 12px;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            background: rgba(21, 22, 51, 0.1);
            color: var(--navy-700);
            cursor: pointer;
            font-weight: 600;
        }

        .compare-remove:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.25);
        }

        .compare-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .compare-meta span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.72rem;
            color: var(--navy-700);
            background: rgba(110, 123, 255, 0.18);
        }

        .compare-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .compare-section h4 {
            margin: 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-subtle);
        }

        .compare-list {
            margin: 0;
            padding-left: 18px;
            display: grid;
            gap: 4px;
            font-size: 0.82rem;
            color: var(--text-subtle);
        }

        .compare-empty {
            padding: 24px;
            border: 1px dashed rgba(110, 123, 255, 0.35);
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-subtle);
            background: rgba(233, 236, 255, 0.35);
        }

        .program-card.is-compared {
            border-color: rgba(110, 123, 255, 0.6);
            box-shadow: 0 16px 40px rgba(110, 123, 255, 0.18);
        }

        .program-card__actions .compare-toggle {
            background: rgba(21, 22, 51, 0.08);
        }

        .program-card__actions .compare-toggle.is-active {
            background: linear-gradient(135deg, rgba(110, 123, 255, 0.22), rgba(110, 123, 255, 0.08));
            color: var(--navy-700);
        }

        .virtual-sentinel {
            width: 100%;
            height: 24px;
        }

        .map-cluster-icon {
            background: linear-gradient(135deg, rgba(110, 123, 255, 0.9), rgba(110, 123, 255, 0.75));
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 14px 28px rgba(15, 16, 32, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.85);
        }

        .leaflet-popup-button {
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 999px;
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }

        .leaflet-popup-button:is(:hover, :focus-visible) {
            background: linear-gradient(135deg, var(--accent-400), var(--accent-200));
        }


        .program-card {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 20px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(145, 153, 225, 0.18);
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
            transform: translateY(6px);
            opacity: 0;
            animation: cardIn var(--transition-medium) forwards;
        }

        .program-card::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(circle at top right, rgba(110, 123, 255, 0.12), transparent 45%);
        }

        .program-card__header {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .program-card__title {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .program-card__title h3 {
            font-size: 1.05rem;
            line-height: 1.3;
        }

        .program-card__meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(110, 123, 255, 0.15);
            color: var(--navy-700);
        }

        .badge--neutral {
            background: rgba(21, 22, 51, 0.08);
            color: var(--text-subtle);
        }

        .program-card__summary {
            font-size: 0.92rem;
            color: var(--text-subtle);
            line-height: 1.5;
        }

        .program-card__tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .program-card__tag {
            font-size: 0.75rem;
            padding: 4px 12px;
            background: rgba(233, 236, 255, 0.7);
            border-radius: 999px;
            color: var(--navy-500);
        }

        .program-card__actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .program-card__actions select {
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            background: var(--neutral-50);
            color: var(--text-strong);
        }

        .program-card__actions .pill-button {
            flex-grow: 1;
            justify-content: center;
            text-align: center;
        }

        .builder {
            background: linear-gradient(160deg, rgba(233, 236, 255, 0.88), rgba(255, 255, 255, 0.94));
            backdrop-filter: blur(18px);
            box-shadow: 0 20px 45px rgba(15, 16, 32, 0.22);
            position: relative;
        }

        .builder header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
        }

        .builder__meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-subtle);
        }

        .builder__lanes {
            display: flex;
            flex-direction: column;
            gap: 18px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .builder-tile--manual {
            border: 1px solid rgba(110, 123, 255, 0.22);
            background: rgba(255, 255, 255, 0.94);
        }

        .builder-program-heading {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .builder-track-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            background: rgba(110, 123, 255, 0.16);
            color: var(--navy-700);
            white-space: nowrap;
        }

        .builder-track-chip[data-track="strong-alt"] {
            background: rgba(255, 196, 0, 0.2);
            color: #805002;
        }

        .builder-track-chip[data-track="local-step-down"] {
            background: rgba(76, 175, 159, 0.24);
            color: #1f5f54;
        }

        .builder-track-chip[data-track="at-home-support"] {
            background: rgba(111, 207, 221, 0.24);
            color: #166b78;
        }

        .builder-track-chip[data-track="alumni"] {
            background: rgba(135, 123, 255, 0.2);
            color: #2f3180;
        }

        .builder-track-select {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-subtle);
        }

        .track-select-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .track-select-row select {
            border-radius: 12px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            padding: 8px 12px;
            background: rgba(233, 236, 255, 0.28);
            font-size: 0.85rem;
            color: var(--text-strong);
        }

        .track-select-row select:focus {
            outline: none;
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.4);
        }

        .track-apply-button {
            border: none;
            background: rgba(110, 123, 255, 0.18);
            color: var(--navy-700);
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .track-apply-button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.32);
            transform: translateY(-1px);
        }

        .builder-manual-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .builder-manual-header input[type="text"] {
            border: 1px solid rgba(21, 22, 51, 0.12);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 0.85rem;
            background: rgba(233, 236, 255, 0.28);
            transition: border var(--transition-fast), background var(--transition-fast);
        }

        .builder-manual-header input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.4);
        }

        .builder-manual-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .builder-manual-meta input[type="text"] {
            flex: 1;
            min-width: 140px;
        }

        .lane {
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius-md);
            border: 1px solid rgba(145, 153, 225, 0.22);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .builder-editor {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .editor-toolbar button {
            border: none;
            background: rgba(21, 22, 51, 0.08);
            color: var(--navy-700);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast), color var(--transition-fast);
        }

        .editor-toolbar button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.2);
            color: var(--navy-500);
            transform: translateY(-1px);
        }

        .editor-surface {
            min-height: 96px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            border-radius: 12px;
            padding: 10px 12px;
            background: rgba(233, 236, 255, 0.22);
            font-size: 0.85rem;
            line-height: 1.45;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .editor-surface:focus {
            outline: none;
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.32);
        }

        .editor-surface:empty::before {
            content: attr(data-placeholder);
            color: var(--text-subtle);
            pointer-events: none;
        }

        .lane__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .lane__title {
            display: flex;
            flex-direction: column;
        }

        .lane__title span {
            font-size: 0.8rem;
            color: var(--text-subtle);
        }

        .lane__add {
            border: none;
            background: rgba(110, 123, 255, 0.1);
            color: var(--navy-700);
            border-radius: 999px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            gap: 6px;
            align-items: center;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .lane__add:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.22);
            transform: translateY(-1px);
        }

        .lane__list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .builder-tile {
            background: var(--surface);
            border-radius: 16px;
            padding: 14px 16px 16px;
            border: 1px solid rgba(110, 123, 255, 0.16);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 12px;
            animation: tileIn var(--transition-medium) forwards;
        }

        .builder-tile__title {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .builder-tile__title small {
            color: var(--text-subtle);
            font-size: 0.75rem;
        }

        .builder-tile label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-subtle);
        }

        .builder-tile input,
        .builder-tile textarea {
            border-radius: 12px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            padding: 8px 10px;
            font-size: 0.85rem;
            font-family: inherit;
            color: var(--text-strong);
            background: rgba(233, 236, 255, 0.2);
            transition: border var(--transition-fast), background var(--transition-fast);
        }

        .builder-tile textarea {
            resize: vertical;
            min-height: 56px;
        }

        .builder-tile input:focus,
        .builder-tile textarea:focus {
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.35);
            outline: none;
        }

        .builder-tile__actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .tile-actions {
            display: inline-flex;
            gap: 6px;
        }

        .tile-actions button {
            border: none;
            background: rgba(21, 22, 51, 0.08);
            color: var(--navy-700);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .tile-actions button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.16);
            transform: translateY(-1px);
        }

        .builder-hint {
            font-size: 0.72rem;
            color: var(--text-subtle);
        }

        .details-panel {
            position: fixed;
            top: 96px;
            right: -420px;
            width: 360px;
            max-width: calc(100% - 56px);
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 28px 60px rgba(15, 16, 32, 0.26);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            z-index: 30;
            transition: right var(--transition-medium);
        }

        .details-panel.is-open {
            right: 32px;
        }

        .details-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 16, 32, 0.45);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
            z-index: 25;
        }

        .details-overlay.is-active {
            opacity: 1;
            pointer-events: all;
        }

        .details-panel header {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .details-panel header h2 {
            font-size: 1.15rem;
        }

        .details-panel__meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .details-panel__section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .details-panel__section h3 {
            font-size: 0.9rem;
            color: var(--text-subtle);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .details-panel__list {
            padding-left: 18px;
            margin: 0;
            display: grid;
            gap: 4px;
            color: var(--text-subtle);
        }

        .details-panel__actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .details-close {
            position: absolute;
            top: 16px;
            right: 16px;
            border: none;
            background: rgba(21, 22, 51, 0.08);
            border-radius: 999px;
            width: 34px;
            height: 34px;
            cursor: pointer;
            font-weight: 600;
            color: var(--navy-700);
        }

        .quick-add {
            position: fixed;
            bottom: 28px;
            right: 32px;
            width: 340px;
            max-width: calc(100% - 48px);
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 48px rgba(15, 16, 32, 0.28);
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 40;
        }

        .quick-add.is-visible {
            display: flex;
        }

        .quick-add select {
            width: 100%;
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            background: rgba(233, 236, 255, 0.35);
        }

        .quick-add__actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .app-footer {
            max-width: 1600px;
            margin: 0 auto;
            padding: 18px 28px 48px;
            color: var(--text-subtle);
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(110, 123, 255, 0.95), rgba(95, 106, 255, 0.9));
            color: #fff;
            padding: 12px 18px;
            border-radius: 12px;
            box-shadow: 0 18px 36px rgba(15, 16, 32, 0.32);
            transform: translateY(-18px);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast), transform var(--transition-fast);
            z-index: 60;
        }

        .toast.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .sr-announcer {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @keyframes cardIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes tileIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1380px) {
            .app-shell {
                grid-template-columns: 260px minmax(420px, 1fr) 320px;
            }

            .toolbar {
                grid-template-columns: 1fr;
                grid-auto-rows: auto;
            }

            .toolbar__brand {
                order: 1;
            }

            .toolbar__search {
                order: 2;
            }

            .toolbar__actions {
                order: 3;
                justify-content: flex-end;
            }
        }

        @media (max-width: 1120px) {
            .app-shell {
                grid-template-columns: minmax(0, 1fr);
            }

            .filters {
                order: 1;
                flex-direction: column;
            }

            .results {
                order: 2;
            }

            .builder {
                order: 3;
                position: relative;
            }

            .details-panel {
                top: 90px;
                right: 24px;
                width: calc(100% - 48px);
                max-width: none;
            }
        }

        @media (max-width: 720px) {
            .toolbar {
                padding: 16px;
            }

            .app-shell {
                padding: 24px 18px 72px;
            }

            .pane {
                padding: 18px;
            }

            .results__grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }

            .app-footer {
                padding: 24px 18px 64px;
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 1ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 1ms !important;
                scroll-behavior: auto !important;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(233, 236, 255, 0.4);
            border-radius: 999px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(110, 123, 255, 0.45);
            border-radius: 999px;
        }
    </style>
</head>
<body>
    <div class="sr-announcer" id="srAnnouncer" aria-live="polite"></div>
    <div class="details-overlay" id="detailsOverlay" aria-hidden="true"></div>
    <header class="toolbar" role="banner">
        <div class="toolbar__brand">
            <span>CC</span>
            <div>
                CareConnect Pro
                <div style="font-size:0.75rem; opacity:0.7;">Programs + Document Creator</div>
            </div>
        </div>
        <div class="toolbar__search">
            <label for="globalSearch" aria-label="Search programs">
                üîç
                <input id="globalSearch" type="search" placeholder="Search programs, modalities, or keywords (press `/` to focus)">
            </label>
        </div>
        <div class="toolbar__actions">
            <div class="toolbar__document-toggle" role="group" aria-label="Document type">
                <button type="button" class="toolbar__document-toggle-btn is-active" data-doc-type="aftercare-options" aria-pressed="true">
                    Aftercare Options
                </button>
                <button type="button" class="toolbar__document-toggle-btn" data-doc-type="aftercare-plan" aria-pressed="false">
                    Aftercare Plan
                </button>
            </div>
            <button class="pill-button" type="button" id="saveDraftButton">Save Draft</button>
            <button class="pill-button is-primary" type="button" id="generateDocumentButton">Generate Document</button>
        </div>
    </header>

    <main class="app-shell">
        <aside class="pane filters" aria-label="Program filters">
            <h2>Filter Programs</h2>
            <p style="margin:8px 0 0; color: var(--text-subtle); font-size:0.88rem;">
                Narrow by focus, delivery format, or alignment to insurance resources. Filters stack to refine results.
            </p>

            <section class="filters__group" aria-label="Focus areas">
                <h3 style="font-size:0.9rem; text-transform:uppercase; letter-spacing:0.05em; color: var(--text-subtle); margin:0;">Focus</h3>
                <div class="chip-row">
                    <button class="chip" data-group="focus" data-value="Intensive Outpatient">Intensive Outpatient</button>
                    <button class="chip" data-group="focus" data-value="Partial Hospitalization">Partial Hospitalization</button>
                    <button class="chip" data-group="focus" data-value="Family Systems">Family Systems</button>
                </div>
            </section>

            <section class="filters__group" aria-label="Format">
                <h3 style="font-size:0.9rem; text-transform:uppercase; letter-spacing:0.05em; color: var(--text-subtle); margin:0;">Format</h3>
                <div class="chip-row">
                    <button class="chip" data-group="format" data-value="Hybrid">Hybrid</button>
                    <button class="chip" data-group="format" data-value="Onsite">Onsite</button>
                    <button class="chip" data-group="format" data-value="Virtual">Virtual</button>
                </div>
            </section>

            <section class="filters__group" aria-label="Insurance alignment">
                <h3 style="font-size:0.9rem; text-transform:uppercase; letter-spacing:0.05em; color: var(--text-subtle); margin:0;">Insurance Alignment</h3>
                <div class="chip-row">
                    <button class="chip" data-group="insurance" data-value="In-Network">In-Network</button>
                    <button class="chip" data-group="insurance" data-value="OON w/ Negotiation">OON with Negotiation</button>
                    <button class="chip" data-group="insurance" data-value="Scholarship Track">Scholarship Track</button>
                </div>
            </section>

            <section class="filters__group" aria-label="Quick toggles">
                <h3 style="font-size:0.9rem; text-transform:uppercase; letter-spacing:0.05em; color: var(--text-subtle); margin:0;">Quick Toggles</h3>
                <div class="chip-row">
                    <button class="chip" data-group="flag" data-value="Immediate">Immediate Starts</button>
                    <button class="chip" data-group="flag" data-value="Openings">Openings this Week</button>
                    <button class="chip" data-group="flag" data-value="Family">Includes Family Work</button>
                </div>
            </section>

            <div class="filters__meta">
                <small id="activeFiltersLabel">No filters active</small>
                <button class="pill-button" type="button" id="clearFiltersButton">Clear Filters</button>
            </div>
        </aside>

        <section class="pane results" aria-labelledby="resultsHeading">
            <div class="results__header">
                <div class="results__header-info">
                    <div class="results__count" id="resultsHeading">Programs Ready for Next Step</div>
                    <div class="results__filters" id="resultsSummary">Loading programs‚Ä¶</div>
                </div>
                <div class="results__controls">
                    <div class="view-toggle" role="group" aria-label="Change program layout">
                        <button type="button" class="is-active" data-view="grid">Grid</button>
                        <button type="button" data-view="rows">Rows</button>
                        <button type="button" data-view="compare">Compare</button>
                        <button type="button" data-view="map">Map</button>
                    </div>
                    <label for="sortSelect" style="font-size:0.85rem; color: var(--text-subtle); display:flex; gap:8px; align-items:center;">
                        Sort
                        <select id="sortSelect">
                            <option value="availability" selected>Availability (Soonest)</option>
                            <option value="acuity">Acuity (High ‚Üí Low)</option>
                        </select>
                    </label>
                </div>
            </div>
            <div class="results__grid" id="resultsGrid" role="list"></div>
            <section class="results__map" id="resultsMapContainer" aria-label="Program map workspace">
                <div class="map-toolbar">
                    <div class="map-status" id="mapStatusLabel" role="status" aria-live="polite">
                        Map view ready. Adjust filters or tap markers to explore programs.
                    </div>
                    <div class="map-controls" id="mapControls">
                        <label class="map-control">
                            <span>ZIP</span>
                            <input type="text" id="mapZipInput" inputmode="numeric" pattern="\\d*" maxlength="5" placeholder="e.g. 33458" aria-label="Center map by ZIP code">
                        </label>
                        <label class="map-control map-control--radius">
                            <span>Radius <strong id="mapRadiusValue">50 mi</strong></span>
                            <input type="range" id="mapRadiusInput" min="5" max="250" value="50" step="5" aria-label="Adjust search radius in miles">
                        </label>
                        <label class="map-control">
                            <span>Focus</span>
                            <select id="mapDistanceFilter" aria-label="Filter map by service focus">
                                <option value="all" selected>All resources</option>
                                <option value="therapy">Therapy / Counseling</option>
                                <option value="psychiatry">Psychiatry</option>
                                <option value="iop">IOP / Day Programs</option>
                                <option value="virtual">Virtual Support</option>
                            </select>
                        </label>
                        <button type="button" class="map-control__button" id="mapLocateButton" aria-label="Use my current location">My Location</button>
                    </div>
                    <div class="map-legend" id="mapLegend"></div>
                </div>
                <div class="map-canvas" id="resultsMapCanvas" role="presentation"></div>
            </section>
            <section class="results__compare" id="resultsCompareContainer" aria-label="Program comparison workspace">
                <header class="compare-toolbar">
                    <div class="compare-status" id="compareStatusLabel" role="status" aria-live="polite">Select up to four programs to compare.</div>
                    <div class="compare-actions">
                        <button type="button" class="compare-action__button" id="compareAddAllButton">Add All to Builder</button>
                        <button type="button" class="compare-action__button" id="compareExportButton">Export Snapshot</button>
                        <button type="button" class="compare-action__button" id="comparePrintButton">Print</button>
                    </div>
                </header>
                <div class="compare-grid" id="compareGrid"></div>
            </section>
        </section>

        <aside class="pane builder" aria-label="Document builder">
            <header>
                <h2>Document Builder</h2>
                <div class="builder__meta">
                    <span id="builderSummary">No programs added yet</span>
                    <span id="draftStatus">Draft not saved</span>
                </div>
            </header>
            <div class="builder__lanes" id="builderLanes" aria-live="polite"></div>
        </aside>
    </main>

    <section class="details-panel" id="detailsPanel" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
        <button class="details-close" type="button" aria-label="Close details" id="closeDetailsButton">√ó</button>
        <header>
            <h2 id="detailsTitle">Select a program</h2>
            <p id="detailsSubtitle" style="margin:0; color: var(--text-subtle); font-size:0.88rem;">
                View licensing, clinical programming, outcomes, and contacts without leaving the workflow.
            </p>
            <div class="details-panel__meta" id="detailsMeta"></div>
        </header>
        <div id="detailsBody" class="details-panel__body" style="display:flex; flex-direction:column; gap:18px;">
            <p style="color: var(--text-subtle);">
                Select any program card to view deeper details, clinical highlights, and handoff guidance. Keyboard: press <strong>C</strong> to open the highlighted program.
            </p>
        </div>
        <div class="details-panel__actions">
            <button class="pill-button" type="button" id="detailsAddButton">Add to Builder</button>
            <button class="pill-button is-primary" type="button" id="detailsGenerateButton">Generate with This Program</button>
        </div>
    </section>

    <section class="quick-add" id="quickAddSheet" aria-hidden="true" aria-label="Quick add program to builder">
        <h3 style="margin:0; font-size:1rem;">Quick Add</h3>
        <label style="display:flex; flex-direction:column; gap:6px; font-size:0.85rem; color: var(--text-subtle);">
            Program
            <select id="quickAddProgram"></select>
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; font-size:0.85rem; color: var(--text-subtle);">
            Lane
            <select id="quickAddLane">
                <option value="stabilize">Stabilize (0‚Äì7 days)</option>
                <option value="bridge">Bridge (Week 2‚Äì4)</option>
                <option value="sustain">Sustain (30+ days)</option>
            </select>
        </label>
        <div class="quick-add__actions">
            <button class="pill-button" type="button" id="quickAddCancel">Cancel</button>
            <button class="pill-button is-primary" type="button" id="quickAddConfirm">Add</button>
        </div>
    </section>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <footer class="app-footer">
        <div>ClearHive palette ‚Ä¢ Navy #0F1020 ¬∑ Accent #6E7BFF ¬∑ Neutral #E9ECFF</div>
        <div id="versionFooter">UX Preview ¬∑ Draft not saved</div>
    </footer>

    <script>
        (function () {
            const PROGRAMS = [
                {
                    id: "prg-harbor",
                    name: "Harbor Haven Intensive Outpatient",
                    focus: "Intensive Outpatient",
                    format: "Hybrid",
                    insurance: ["In-Network", "OON w/ Negotiation"],
                    flags: ["Immediate", "Family"],
                    acuity: 8,
                    availabilityDays: 2,
                    summary: "Staged handoff for clients stepping down from residential with 5-day clinical wraparound, embedded family intensives, and on-call psychiatric support.",
                    tags: ["Adolescent", "Dual-Diagnosis", "Medication Management", "Family Intensives"],
                    weeklyStructure: [
                        "5-day clinical schedule with 18 hours of group",
                        "Daily psychiatry consults during first week",
                        "Family reset weekend with on-site apartments"
                    ],
                    defaultTrack: "primary",
                    tracks: [
                        { id: "primary", label: "Primary Recommendation" },
                        { id: "strong-alt", label: "Strong Alternative" },
                        { id: "local-step-down", label: "Local / Step-Down" }
                    ],
                    location: {
                        address: "1840 Ocean Ridge Blvd",
                        city: "Delray Beach",
                        state: "FL",
                        zip: "33444",
                        lat: 26.4615,
                        lng: -80.0728,
                        region: "Southeast",
                        distanceFromFamilyMiles: 32
                    },
                    serviceRadiusMiles: 60,
                    contacts: {
                        director: "Jamie Collins, LMHC",
                        phone: "(561) 555-3201",
                        email: "jamie.collins@harborhaven.org"
                    },
                    outcomes: [
                        "78% 6-month sobriety maintenance",
                        "Reduced readmission to residential by 42%",
                        "Family cohesion scores improve +3.1 within 14 days"
                    ],
                    highlights: [
                        "Dedicated transition mentor assigned within 2 hours",
                        "Evening stabilization groups for school reintegration",
                        "Telehealth bridge sessions if travel delayed"
                    ]
                },
                {
                    id: "prg-aurora",
                    name: "Aurora Transitions Partial Hospitalization",
                    focus: "Partial Hospitalization",
                    format: "Onsite",
                    insurance: ["In-Network"],
                    flags: ["Openings"],
                    acuity: 9,
                    availabilityDays: 4,
                    summary: "Bridge-level PHP with medical coordination, academic coaching, and attachment-based family repair series tailored to post-detox stabilization.",
                    tags: ["Co-Occurring", "Psychiatry", "Academic Support", "Family Systems"],
                    weeklyStructure: [
                        "6-hour PHP days with 1:1 psychiatry weekly",
                        "Academic coaching 3x week to transition back to school",
                        "Boundaries & repair track for caregivers"
                    ],
                    defaultTrack: "primary",
                    tracks: [
                        { id: "primary", label: "Primary Recommendation" },
                        { id: "strong-alt", label: "Strong Alternative" },
                        { id: "local-step-down", label: "Local / Step-Down" }
                    ],
                    location: {
                        address: "6112 Sunrise Bay Rd",
                        city: "Miami",
                        state: "FL",
                        zip: "33101",
                        lat: 25.7617,
                        lng: -80.1918,
                        region: "Southeast",
                        distanceFromFamilyMiles: 48
                    },
                    serviceRadiusMiles: 45,
                    contacts: {
                        director: "Elena Ramirez, LCSW",
                        phone: "(305) 555-4412",
                        email: "elena.ramirez@auroratransitions.org"
                    },
                    outcomes: [
                        "Average GAD-7 reduction of 6.2 within 21 days",
                        "88% retention through full 21-day protocol",
                        "90% caregiver satisfaction with transition plan"
                    ],
                    highlights: [
                        "Dedicated medical navigator for complex medication tapers",
                        "Embedded academic liaison communicates with school teams",
                        "Real-time shared dashboard for CareConnect updates"
                    ]
                },
                {
                    id: "prg-cedar",
                    name: "Cedar Path Family System Coaching Collective",
                    focus: "Family Systems",
                    format: "Virtual",
                    insurance: ["Scholarship Track", "OON w/ Negotiation"],
                    flags: ["Family"],
                    acuity: 6,
                    availabilityDays: 1,
                    summary: "Virtual family system coaching for sustainment phase with HIPAA-secure whiteboards, capacity planning, and relapse signal rehearsals.",
                    tags: ["Family Coaching", "Virtual Delivery", "Relapse Planning"],
                    weeklyStructure: [
                        "2x week coaching with between-session micro-drills",
                        "HIPAA-safe digital family agreements & signatures",
                        "Bi-directional alerts into CareConnect tracker"
                    ],
                    location: {
                        address: "Virtual Practice",
                        city: "Remote",
                        state: "NC",
                        zip: "27511",
                        lat: 35.7596,
                        lng: -79.0193,
                        region: "National Telehealth",
                        distanceFromFamilyMiles: 0
                    },
                    defaultTrack: "at-home-support",
                    tracks: [
                        { id: "at-home-support", label: "At-Home Support" },
                        { id: "alumni", label: "Alumni Follow-Up" },
                        { id: "strong-alt", label: "Strong Alternative" }
                    ],
                    location: {
                        address: "Remote",
                        city: "Virtual Services",
                        state: "NA",
                        zip: "00000",
                        lat: 0,
                        lng: 0,
                        region: "Telehealth"
                    },
                    serviceRadiusMiles: 0,
                    contacts: {
                        director: "Morgan Blake, LMFT",
                        phone: "(845) 555-2087",
                        email: "morgan.blake@cedarpath.co"
                    },
                    outcomes: [
                        "94% families report improved conflict recovery",
                        "Average 2.6 fewer high-alert tracker pings per month",
                        "Families sustain agreements for 90 days avg."
                    ],
                    highlights: [
                        "Builder-ready collaborative documents exported to PDF",
                        "Coaches join discharge huddles within 12 hours",
                        "HIPAA-initials only with encrypted note syncs"
                    ]
                }
            ];

            const STORAGE_KEY = "ccpro-program-builder-v2";
            const LEGACY_STORAGE_KEYS = ["ccpro-program-builder-v1"];
            const TRACK_LIBRARY = [
                { id: "primary", label: "Primary Recommendation" },
                { id: "strong-alt", label: "Strong Alternative" },
                { id: "local-step-down", label: "Local / Step-Down" },
                { id: "at-home-support", label: "At-Home Support" },
                { id: "alumni", label: "Alumni Follow-Up" }
            ];
            const DOCUMENT_TYPE_LABELS = {
                "aftercare-options": "Aftercare Options",
                "aftercare-plan": "Aftercare Plan"
            };
            const srAnnouncer = document.getElementById("srAnnouncer");
            const overlays = {
                overlay: document.getElementById("detailsOverlay"),
                panel: document.getElementById("detailsPanel"),
                quickAdd: document.getElementById("quickAddSheet")
            };

            const savedDraft = loadDraft();

            const elements = {
                resultsGrid: document.getElementById("resultsGrid"),
                mapContainer: document.getElementById("resultsMapContainer"),
                mapCanvas: document.getElementById("resultsMapCanvas"),
                mapLegend: document.getElementById("mapLegend"),
                mapStatusLabel: document.getElementById("mapStatusLabel"),
                mapZipInput: document.getElementById("mapZipInput"),
                mapRadiusInput: document.getElementById("mapRadiusInput"),
                mapRadiusValue: document.getElementById("mapRadiusValue"),
                mapDistanceFilter: document.getElementById("mapDistanceFilter"),
                mapLocateButton: document.getElementById("mapLocateButton"),
                compareContainer: document.getElementById("resultsCompareContainer"),
                compareGrid: document.getElementById("compareGrid"),
                compareStatusLabel: document.getElementById("compareStatusLabel"),
                compareAddAllButton: document.getElementById("compareAddAllButton"),
                compareExportButton: document.getElementById("compareExportButton"),
                comparePrintButton: document.getElementById("comparePrintButton"),
                resultsSummary: document.getElementById("resultsSummary"),
                filtersLabel: document.getElementById("activeFiltersLabel"),
                sortSelect: document.getElementById("sortSelect"),
                searchInput: document.getElementById("globalSearch"),
                builderLanes: document.getElementById("builderLanes"),
                builderSummary: document.getElementById("builderSummary"),
                draftStatus: document.getElementById("draftStatus"),
                versionFooter: document.getElementById("versionFooter"),
                toast: document.getElementById("toast"),
                detailsTitle: document.getElementById("detailsTitle"),
                detailsSubtitle: document.getElementById("detailsSubtitle"),
                detailsMeta: document.getElementById("detailsMeta"),
                detailsBody: document.getElementById("detailsBody"),
                detailsAddButton: document.getElementById("detailsAddButton"),
                detailsGenerateButton: document.getElementById("detailsGenerateButton"),
                quickAddProgram: document.getElementById("quickAddProgram"),
                quickAddLane: document.getElementById("quickAddLane")
            };

            const filterButtons = Array.from(document.querySelectorAll(".chip"));
            const viewToggleButtons = Array.from(document.querySelectorAll(".view-toggle button"));
            const documentTypeButtons = Array.from(document.querySelectorAll(".toolbar__document-toggle-btn"));
            const clearFiltersButton = document.getElementById("clearFiltersButton");
            const saveDraftButton = document.getElementById("saveDraftButton");
            const generateButton = document.getElementById("generateDocumentButton");
            const closeDetailsButton = document.getElementById("closeDetailsButton");
            const quickAddCancel = document.getElementById("quickAddCancel");
            const quickAddConfirm = document.getElementById("quickAddConfirm");

            const laneConfig = {
                stabilize: {
                    label: "Stabilize (0‚Äì7 days)",
                    description: "Immediate continuity resources during first week after discharge."
                },
                bridge: {
                    label: "Bridge (Week 2‚Äì4)",
                    description: "Programming to maintain gains and prep for sustainment."
                },
                sustain: {
                    label: "Sustain (30+ days)",
                    description: "Longer-term anchors and relapse signal rehearsals."
                },
                atHome: {
                    label: "At-Home Supports",
                    description: "Local therapy, psychiatry, and alumni resources for home environment."
                }
            };

            function createEmptyBuilder() {
                return {
                    lanes: {
                        stabilize: [],
                        bridge: [],
                        sustain: [],
                        atHome: []
                    },
                    lastSaved: null
                };
            }

            const state = {
                filters: {
                    focus: new Set(),
                    format: new Set(),
                    insurance: new Set(),
                    flag: new Set()
                },
                searchTerm: "",
                sort: "availability",
                view: "grid",
                documentType: savedDraft?.documentType || "aftercare-options",
                builder: savedDraft?.builder || createEmptyBuilder(),
                map: {
                    center: (() => {
                        const primaryProgram = PROGRAMS.find(p => p.location && typeof p.location.lat === "number" && typeof p.location.lng === "number");
                        if (primaryProgram?.location) {
                            return {
                                lat: primaryProgram.location.lat,
                                lng: primaryProgram.location.lng,
                                source: "default"
                            };
                        }
                        return { lat: 37.0902, lng: -95.7129, source: "default" }; // USA centroid fallback
                    })(),
                    defaultRadius: 50,
                    radiusMiles: 50,
                    distanceFilter: "all",
                    applyFiltersGlobally: false,
                    geocodeCache: {},
                    lastError: null,
                    isReady: false
                },
                comparison: {
                    programIds: [],
                    limit: 4
                },
                virtual: {
                    enabled: false,
                    pageSize: 24,
                    renderedCount: 0,
                    observer: null,
                    sentinel: null,
                    data: []
                },
                selectedProgramId: null,
                quickAddLane: "stabilize"
            };

            if (savedDraft?.comparisonProgramIds?.length) {
                state.comparison.programIds = savedDraft.comparisonProgramIds
                    .slice(0, state.comparison.limit)
                    .filter(id => typeof id === "string");
            }

            if (savedDraft?.mapState) {
                if (typeof savedDraft.mapState.radiusMiles === "number") {
                    state.map.radiusMiles = savedDraft.mapState.radiusMiles;
                }
                if (typeof savedDraft.mapState.distanceFilter === "string") {
                    state.map.distanceFilter = savedDraft.mapState.distanceFilter;
                }
                if (savedDraft.mapState.center && typeof savedDraft.mapState.center.lat === "number" && typeof savedDraft.mapState.center.lng === "number") {
                    state.map.center = {
                        lat: savedDraft.mapState.center.lat,
                        lng: savedDraft.mapState.center.lng,
                        source: savedDraft.mapState.center.source || "restored"
                    };
                }
                if (typeof savedDraft.mapState.applyFiltersGlobally === "boolean") {
                    state.map.applyFiltersGlobally = savedDraft.mapState.applyFiltersGlobally;
                }
            }

            let autosaveTimer = null;
            let leafletLoader = null;
            const mapState = {
                instance: null,
                markersLayer: null,
                circleLayer: null,
                legendControl: null,
                groups: [],
                isReady: false
            };
            const refreshMapDebounced = debounce(() => {
                if (state.view === "map") {
                    updateMap(state.filteredPrograms || PROGRAMS);
                }
            }, 260);

            function debounce(fn, delay = 250) {
                let timeout;
                return function (...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = window.setTimeout(() => fn.apply(context, args), delay);
                };
            }

            function announce(message) {
                srAnnouncer.textContent = "";
                window.requestAnimationFrame(() => {
                    srAnnouncer.textContent = message;
                });
            }

            function showToast(message) {
                elements.toast.textContent = message;
                elements.toast.classList.add("is-visible");
                announce(message);
                window.setTimeout(() => {
                    elements.toast.classList.remove("is-visible");
                }, 2800);
            }

            function updateResultsSummary(filteredPrograms) {
                const activeFilters = countActiveFilters();
                const summaryParts = [];
                if (state.searchTerm) {
                    summaryParts.push(`Matching ‚Äú${state.searchTerm}‚Äù`);
                }
                if (activeFilters.length) {
                    summaryParts.push(`${activeFilters.length} filter${activeFilters.length > 1 ? "s" : ""} active`);
                }
                elements.resultsSummary.textContent = summaryParts.length
                    ? `${filteredPrograms.length} program${filteredPrograms.length !== 1 ? "s" : ""} ¬∑ ${summaryParts.join(" ¬∑ ")}`
                    : `${filteredPrograms.length} program${filteredPrograms.length !== 1 ? "s are" : " is"} ready`;
                elements.filtersLabel.textContent = activeFilters.length
                    ? `Active filters: ${activeFilters.map(f => f.label).join(", ")}`
                    : "No filters active";
            }

            function countActiveFilters() {
                return filterButtons.filter(btn => btn.classList.contains("is-active"));
            }

            function getDocumentTypeLabel(value) {
                return DOCUMENT_TYPE_LABELS[value] || DOCUMENT_TYPE_LABELS["aftercare-options"];
            }

            function updateDocumentTypeButtons() {
                documentTypeButtons.forEach(button => {
                    const isActive = button.dataset.docType === state.documentType;
                    button.classList.toggle("is-active", isActive);
                    button.setAttribute("aria-pressed", isActive ? "true" : "false");
                });
            }

            function updateDraftMeta() {
                const label = getDocumentTypeLabel(state.documentType);
                if (state.builder.lastSaved) {
                    const timestamp = new Date(state.builder.lastSaved).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
                    elements.draftStatus.textContent = `Draft saved ${timestamp}`;
                    elements.versionFooter.textContent = `Programs workspace ‚Ä¢ ${label} ‚Ä¢ Last saved ${timestamp}`;
                } else {
                    elements.draftStatus.textContent = "Draft not saved";
                    elements.versionFooter.textContent = `Programs workspace ‚Ä¢ ${label} ‚Ä¢ Draft not saved`;
                }
            }

            function refreshGenerationLabels() {
                const label = getDocumentTypeLabel(state.documentType);
                generateButton.textContent = `Generate ${label}`;
                elements.detailsGenerateButton.textContent = `Generate ${label}`;
            }

            function setDocumentType(type, options = {}) {
                const normalized = type === "aftercare-plan" ? "aftercare-plan" : "aftercare-options";
                const previous = state.documentType;
                state.documentType = normalized;
                updateDocumentTypeButtons();
                refreshGenerationLabels();
                updateDraftMeta();
                if (options.announce !== false && previous !== normalized) {
                    announce(`Document type set to ${getDocumentTypeLabel(normalized)}`);
                }
                if (options.scheduleSave !== false && previous !== normalized) {
                    scheduleAutosave();
                }
            }

            function sanitizeTextForExport(text = "") {
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            function escapeAttribute(value = "") {
                return value
                    .replace(/&/g, "&amp;")
                    .replace(/"/g, "&quot;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            function formatTextForExport(text = "") {
                const sanitized = sanitizeTextForExport(text);
                return sanitized.replace(/\r\n|\r|\n/g, "<br>");
            }

            function sanitizeRichText(html = "") {
                if (!html) return "";
                let normalized = html
                    .replace(/<\/?b>/gi, tag => tag.startsWith("</") ? "</strong>" : "<strong>")
                    .replace(/<\/?i>/gi, tag => tag.startsWith("</") ? "</em>" : "<em>");
                const container = document.createElement("div");
                container.innerHTML = normalized;
                const allowed = new Set(["STRONG", "EM", "UL", "OL", "LI", "BR"]);
                const walker = document.createTreeWalker(container, NodeFilter.SHOW_ELEMENT, null);
                const toClean = [];
                while (walker.nextNode()) {
                    const node = walker.currentNode;
                    if (!allowed.has(node.tagName)) {
                        toClean.push(node);
                    }
                }
                toClean.forEach(node => {
                    const parent = node.parentNode;
                    if (!parent) return;
                    if (node.childNodes.length) {
                        const fragment = document.createDocumentFragment();
                        while (node.firstChild) {
                            fragment.appendChild(node.firstChild);
                        }
                        parent.replaceChild(fragment, node);
                    } else {
                        parent.removeChild(node);
                    }
                });
                normalized = container.innerHTML.replace(/&nbsp;/g, " ");
                return normalized;
            }

            function getPlainTextFromHtml(html = "") {
                if (!html) return "";
                const temp = document.createElement("div");
                temp.innerHTML = html;
                return temp.textContent?.trim() || "";
            }

            function collectBuilderSnapshot(focusProgramId = null) {
                const lanes = {};
                Object.entries(state.builder.lanes).forEach(([laneKey, items]) => {
                    lanes[laneKey] = items.map(item => {
                        if (!item.programId || laneKey === "atHome") {
                            return {
                                type: "manual",
                                resourceName: item.name || "",
                                city: item.city || "",
                                focus: item.focus || "",
                                notesHtml: item.notesHtml || "",
                                notesText: item.notesText || "",
                                addedAt: item.addedAt || null,
                                lastEdited: item.lastEdited || null
                            };
                        }
                        const program = getProgramById(item.programId);
                        return {
                            type: "program",
                            programId: item.programId,
                            programName: program?.name || "",
                            focus: program?.focus || "",
                            format: program?.format || "",
                            availabilityDays: program?.availabilityDays ?? null,
                            acuity: program?.acuity ?? null,
                            clientInitials: item.client || "",
                            reason: item.reason || "",
                            reasonFormatted: formatTextForExport(item.reason || ""),
                            track: item.track || getDefaultTrackId(item.programId),
                            trackLabel: getTrackLabel(item.track || getDefaultTrackId(item.programId), item.programId),
                            addedAt: item.addedAt || null
                        };
                    });
                });
                return {
                    documentType: state.documentType,
                    generatedAt: new Date().toISOString(),
                    focusProgramId,
                    lanes
                };
            }

            function renderDocumentHtml(snapshot) {
                const label = getDocumentTypeLabel(snapshot.documentType);
                const generatedAt = new Date(snapshot.generatedAt).toLocaleString();
                const laneOrder = ["stabilize", "bridge", "sustain", "atHome"];
                const laneNames = {
                    stabilize: "Stabilize (0‚Äì7 days)",
                    bridge: "Bridge (Week 2‚Äì4)",
                    sustain: "Sustain (30+ days)",
                    atHome: "At-Home Supports"
                };

                const sections = laneOrder.map(laneKey => {
                    const entries = snapshot.lanes[laneKey] || [];
                    if (!entries.length) return "";
                    const entryHtml = entries.map(entry => {
                        if (entry.type === "manual") {
                            return `
                                <article class="doc-card">
                                    <h3>${sanitizeTextForExport(entry.resourceName || "Resource")}</h3>
                                    <div class="doc-meta">
                                        ${entry.city ? `<span>${sanitizeTextForExport(entry.city)}</span>` : ""}
                                        ${entry.focus ? `<span>${sanitizeTextForExport(entry.focus)}</span>` : ""}
                                    </div>
                                    ${entry.notesHtml ? `<div class="doc-notes">${entry.notesHtml}</div>` : ""}
                                </article>
                            `;
                        }
                        return `
                            <article class="doc-card">
                                <h3>${sanitizeTextForExport(entry.programName || "Program")}</h3>
                                <div class="doc-meta">
                                    ${entry.focus ? `<span>${sanitizeTextForExport(entry.focus)}</span>` : ""}
                                    ${entry.format ? `<span>${sanitizeTextForExport(entry.format)}</span>` : ""}
                                    ${entry.trackLabel ? `<span>Track: ${sanitizeTextForExport(entry.trackLabel)}</span>` : ""}
                                </div>
                                ${
                                    entry.reason
                                        ? `<div class="doc-notes">${formatTextForExport(entry.reason)}</div>`
                                        : ""
                                }
                            </article>
                        `;
                    }).join("");
                    return `
                        <section>
                            <h2>${laneNames[laneKey]}</h2>
                            <div class="doc-grid">${entryHtml}</div>
                        </section>
                    `;
                }).join("");

                return `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>${sanitizeTextForExport(label)} ‚Ä¢ ${generatedAt}</title>
                        <style>
                            body { font-family: "Segoe UI", Arial, sans-serif; margin: 32px; background: #f7f8ff; color: #151633; }
                            header { margin-bottom: 24px; }
                            h1 { margin: 0; font-size: 1.6rem; }
                            .doc-meta { margin-top: 6px; color: #48508A; font-size: 0.9rem; }
                            section { margin-bottom: 24px; }
                            section h2 { margin-bottom: 12px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.08em; color: #48508A; }
                            .doc-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
                            .doc-card { background: #fff; border: 1px solid #c9ceff; border-radius: 16px; padding: 16px; box-shadow: 0 12px 24px rgba(15,16,32,0.08); }
                            .doc-card h3 { margin: 0 0 6px; font-size: 1.05rem; }
                            .doc-card .doc-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem; color: #6970a0; }
                            .doc-card .doc-notes { margin-top: 10px; font-size: 0.9rem; color: #43497d; line-height: 1.5; }
                        </style>
                    </head>
                    <body>
                        <header>
                            <h1>${sanitizeTextForExport(label)}</h1>
                            <div class="doc-meta">Generated ${generatedAt}</div>
                        </header>
                        ${sections}
                    </body>
                    </html>
                `;
            }

            function generateAtHomeId() {
                if (window.crypto?.randomUUID) {
                    return window.crypto.randomUUID();
                }
                return `athome-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            }

            function normalizeProgramEntry(entry = {}) {
                return {
                    programId: entry.programId || "",
                    client: entry.client || "",
                    reason: entry.reason || "",
                    track: entry.track || getDefaultTrackId(entry.programId),
                    addedAt: entry.addedAt || entry.timestamp || new Date().toISOString()
                };
            }

            function normalizeAtHomeEntry(entry = {}) {
                const notesHtml = sanitizeRichText(entry.notesHtml || entry.notes || "");
                return {
                    id: entry.id || generateAtHomeId(),
                    name: entry.name || "",
                    city: entry.city || "",
                    focus: entry.focus || "",
                    notesHtml,
                    notesText: getPlainTextFromHtml(notesHtml),
                    addedAt: entry.addedAt || new Date().toISOString(),
                    lastEdited: entry.lastEdited || entry.addedAt || null
                };
            }

            function getProgramTrackOptions(programId) {
                if (!programId) return TRACK_LIBRARY;
                const program = getProgramById(programId);
                if (program?.tracks?.length) {
                    return program.tracks;
                }
                return TRACK_LIBRARY;
            }

            function getDefaultTrackId(programId) {
                const program = getProgramById(programId);
                if (program?.defaultTrack) {
                    return program.defaultTrack;
                }
                const options = getProgramTrackOptions(programId);
                return options[0]?.id || TRACK_LIBRARY[0].id;
            }

            function getTrackLabel(trackId, programId = null) {
                if (!trackId) return "Unassigned";
                const scopedOptions = programId ? getProgramTrackOptions(programId) : TRACK_LIBRARY;
                const match = scopedOptions.find(option => option.id === trackId) || TRACK_LIBRARY.find(option => option.id === trackId);
                return match?.label || "Unassigned";
            }

            function loadLeafletAssets() {
                if (window.L && typeof window.L.map === "function") {
                    return Promise.resolve();
                }
                if (leafletLoader) {
                    return leafletLoader;
                }
                leafletLoader = new Promise((resolve, reject) => {
                    const existingScript = document.querySelector('script[data-leaflet]');
                    if (existingScript) {
                        existingScript.addEventListener("load", resolve);
                        existingScript.addEventListener("error", reject);
                        return;
                    }
                    const link = document.createElement("link");
                    link.rel = "stylesheet";
                    link.href = "libs/leaflet.css";
                    link.dataset.leaflet = "true";
                    document.head.appendChild(link);

                    const script = document.createElement("script");
                    script.src = "libs/leaflet.js";
                    script.async = true;
                    script.dataset.leaflet = "true";
                    script.onload = resolve;
                    script.onerror = () => reject(new Error("Failed to load Leaflet assets"));
                    document.head.appendChild(script);
                });
                return leafletLoader;
            }

            function ensureMapLegend() {
                if (mapState.legendControl) return;
                mapState.legendControl = window.L.control({ position: "bottomright" });
                mapState.legendControl.onAdd = () => {
                    const div = window.L.DomUtil.create("div", "map-legend-control");
                    div.innerHTML = `
                        <div class="map-legend">
                            <span class="map-legend__item">
                                <span class="map-marker-dot"></span>
                                Program location
                            </span>
                            <span class="map-legend__item">
                                <span class="map-marker-dot" style="background:#6FD8A6;"></span>
                                Within radius
                            </span>
                            <span class="map-legend__item">
                                Cluster size indicates number of nearby programs
                            </span>
                        </div>
                    `;
                    return div;
                };
                mapState.legendControl.addTo(mapState.instance);
            }

            function updateMapLegendPrograms(count) {
                if (elements.mapLegend) {
                    elements.mapLegend.innerHTML = `
                        <span class="map-legend__item">
                            Showing ${count} program${count === 1 ? "" : "s"} on map
                        </span>
                    `;
                }
            }

            function computeDistanceMiles(lat1, lon1, lat2, lon2) {
                const toRad = Math.PI / 180;
                const dLat = (lat2 - lat1) * toRad;
                const dLon = (lon2 - lon1) * toRad;
                const a = Math.sin(dLat / 2) ** 2 +
                    Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) * Math.sin(dLon / 2) ** 2;
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return 3958.8 * c; // Earth radius in miles
            }

            function matchesDistanceFilter(program) {
                const filter = state.map.distanceFilter;
                if (!filter || filter === "all") return true;
                const tags = (program.tags || []).map(tag => tag.toLowerCase());
                const focus = (program.focus || "").toLowerCase();
                const format = (program.format || "").toLowerCase();
                switch (filter) {
                    case "therapy":
                        return focus.includes("therapy") ||
                            tags.some(tag => tag.includes("therapy") || tag.includes("family") || tag.includes("counsel"));
                    case "psychiatry":
                        return focus.includes("psychi") ||
                            tags.some(tag => tag.includes("psychi") || tag.includes("medication"));
                    case "iop":
                        return focus.includes("intensive") || focus.includes("partial") ||
                            tags.some(tag => tag.includes("iop") || tag.includes("day program"));
                    case "virtual":
                        return format.includes("virtual") ||
                            tags.some(tag => tag.includes("virtual") || tag.includes("telehealth"));
                    default:
                        return true;
                }
            }

            function buildMapGroups(programs) {
                const groups = new Map();
                const center = state.map.center;
                const radius = state.map.radiusMiles;
                programs.forEach(program => {
                    const loc = program.location;
                    if (!loc || typeof loc.lat !== "number" || typeof loc.lng !== "number") return;
                    if (!matchesDistanceFilter(program)) return;
                    let distanceMiles = null;
                    if (typeof center.lat === "number" && typeof center.lng === "number") {
                        distanceMiles = computeDistanceMiles(center.lat, center.lng, loc.lat, loc.lng);
                        if (radius && distanceMiles > radius) {
                            return;
                        }
                    }
                    const key = `${loc.lat.toFixed(2)}|${loc.lng.toFixed(2)}`;
                    if (!groups.has(key)) {
                        groups.set(key, { lat: loc.lat, lng: loc.lng, programs: [] });
                    }
                    groups.get(key).programs.push({ program, distanceMiles });
                });
                return Array.from(groups.values());
            }

            function createMarker(group) {
                const count = group.programs.length;
                if (count === 0) return null;
                const [lat, lng] = [group.lat, group.lng];
                if (count === 1) {
                    const entry = group.programs[0];
                    const program = entry.program;
                    const marker = window.L.marker([lat, lng]);
                    marker.bindPopup(`
                        <div style="min-width:200px;">
                            <strong>${program.name}</strong><br>
                            <span style="color:var(--text-subtle); font-size:0.8rem;">${program.focus} ¬∑ ${program.format}</span><br>
                            ${program.location?.city ? `<span style="font-size:0.78rem; color:var(--text-subtle);">${program.location.city}, ${program.location.state}</span><br>` : ""}
                            ${typeof entry.distanceMiles === "number" ? `<span style="font-size:0.75rem; color:var(--text-subtle);">${entry.distanceMiles.toFixed(1)} mi away</span><br>` : ""}
                            <button class="leaflet-popup-button" data-program-id="${program.id}">View details</button>
                        </div>
                    `);
                    marker.on("popupopen", () => {
                        const btn = document.querySelector(".leaflet-popup-button");
                        if (btn) {
                            btn.addEventListener("click", () => openDetails(program.id), { once: true });
                        }
                    });
                    return marker;
                }

            const icon = window.L.divIcon({
                    html: `<div class="map-cluster-icon">${count}</div>`,
                    className: "",
                    iconSize: [42, 42]
                });
                const marker = window.L.marker([lat, lng], { icon });
                marker.bindPopup(`
                    <div style="min-width:220px;">
                        <strong>${count} programs nearby</strong>
                        <ul style="margin:8px 0 0 16px; padding:0; font-size:0.8rem; color:var(--text-subtle);">
                            ${group.programs.slice(0, 4).map(entry => `<li>${entry.program.name}</li>`).join("")}
                        </ul>
                        ${count > 4 ? `<div style="font-size:0.75rem; margin-top:4px; color:var(--text-subtle);">+${count - 4} more</div>` : ""}
                    </div>
                `);
                return marker;
            }

            async function ensureMapReady() {
                if (mapState.isReady && mapState.instance) {
                    return mapState.instance;
                }
                await loadLeafletAssets();
                const { lat, lng } = state.map.center;
                mapState.instance = window.L.map(elements.mapCanvas, {
                    center: [lat, lng],
                    zoom: 7,
                    scrollWheelZoom: true,
                    doubleClickZoom: false
                });
                window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(mapState.instance);
                mapState.markersLayer = window.L.layerGroup().addTo(mapState.instance);
                mapState.circleLayer = window.L.circle([lat, lng], {
                    radius: state.map.radiusMiles * 1609.34,
                    color: "#6E7BFF",
                fillColor: "#6E7BFF",
                    fillOpacity: 0.12,
                    weight: 1.5
                }).addTo(mapState.instance);
                ensureMapLegend();
                mapState.isReady = true;
                elements.mapStatusLabel.textContent = "Map view ready. Drag to explore programs.";
                mapState.instance.on("moveend", () => {
                    const center = mapState.instance.getCenter();
                    state.map.center = { lat: center.lat, lng: center.lng, source: "pan" };
                    if (mapState.circleLayer) {
                        mapState.circleLayer.setLatLng(center);
                    }
                });
                mapState.instance.on("dblclick", event => {
                    setMapCenter(event.latlng.lat, event.latlng.lng, "dblclick");
                    state.map.applyFiltersGlobally = true;
                    elements.mapStatusLabel.textContent = `Center moved to ${event.latlng.lat.toFixed(3)}, ${event.latlng.lng.toFixed(3)}`;
                    renderPrograms();
                });
                return mapState.instance;
            }

            function updateMapCircle() {
                if (!mapState.circleLayer || !mapState.instance) return;
                const center = state.map.center;
                mapState.circleLayer.setLatLng([center.lat, center.lng]);
                mapState.circleLayer.setRadius(state.map.radiusMiles * 1609.34);
            }

            async function updateMap(programs) {
                await ensureMapReady();
                mapState.markersLayer.clearLayers();
                const groups = buildMapGroups(programs);
                groups.forEach(group => {
                    const marker = createMarker(group);
                    if (marker) {
                        mapState.markersLayer.addLayer(marker);
                    }
                });
                if (!groups.length) {
                    elements.mapStatusLabel.textContent = "No mappable programs with the current filters. Try expanding the radius or removing a filter.";
                    updateMapLegendPrograms(0);
                    mapState.groups = [];
                    return;
                }
                updateMapCircle();
                updateMapLegendPrograms(groups.reduce((sum, group) => sum + group.programs.length, 0));
                mapState.groups = groups;
                if (groups.length === 1) {
                    const group = groups[0];
                    mapState.instance.flyTo([group.lat, group.lng], Math.max(mapState.instance.getZoom(), 9), { duration: 0.6 });
                } else if (groups.length > 1) {
                    const bounds = window.L.latLngBounds(groups.map(group => [group.lat, group.lng]));
                    mapState.instance.flyToBounds(bounds.pad(0.12), { duration: 0.6 });
                }
            }

            function setMapCenter(lat, lng, source = "manual") {
                if (typeof lat !== "number" || typeof lng !== "number") return;
                state.map.center = { lat, lng, source };
                if (state.view === "map" && mapState.instance) {
                    mapState.instance.panTo([lat, lng], { animate: true });
                    updateMapCircle();
                }
            }

            function setMapRadiusMiles(miles, options = {}) {
                if (typeof miles !== "number" || Number.isNaN(miles)) return;
                const clamped = Math.min(250, Math.max(5, Math.round(miles)));
                state.map.radiusMiles = clamped;
                if (elements.mapRadiusInput) {
                    elements.mapRadiusInput.value = String(clamped);
                }
                if (elements.mapRadiusValue) {
                    elements.mapRadiusValue.textContent = `${clamped} mi`;
                }
                if (!options.silent) {
                    state.map.applyFiltersGlobally = true;
                }
                updateMapCircle();
            }

            async function geocodeZip(zip) {
                const trimmed = (zip || "").trim();
                if (!/^\d{5}$/.test(trimmed)) {
                    throw new Error("ZIP must be 5 digits");
                }
                if (state.map.geocodeCache[trimmed]) {
                    return state.map.geocodeCache[trimmed];
                }
                const url = `https://nominatim.openstreetmap.org/search?countrycodes=us&format=json&postalcode=${trimmed}&limit=1`;
                const response = await fetch(url, {
                    headers: {
                        "Accept": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error("Geocoding request failed");
                }
                const data = await response.json();
                if (!Array.isArray(data) || !data.length) {
                    throw new Error("ZIP not found");
                }
                const result = {
                    lat: Number(data[0].lat),
                    lng: Number(data[0].lon),
                    displayName: data[0].display_name || trimmed
                };
                state.map.geocodeCache[trimmed] = result;
                return result;
            }

            async function centerMapByZip(zip) {
                const cleaned = (zip || "").trim();
                if (!cleaned) {
                    showToast("Enter a ZIP code to center the map");
                    return;
                }
                elements.mapStatusLabel.textContent = `Searching for ${cleaned}‚Ä¶`;
                try {
                    const result = await geocodeZip(cleaned);
                    setMapCenter(result.lat, result.lng, "zip");
                    state.map.applyFiltersGlobally = true;
                    elements.mapStatusLabel.textContent = `Centered near ${result.displayName}`;
                    renderPrograms();
                } catch (error) {
                    console.error("Geocoding error:", error);
                    elements.mapStatusLabel.textContent = `Unable to locate ZIP ${cleaned}`;
                    showToast(error.message || "Could not locate ZIP code");
                }
            }

            function handleLocateButton() {
                if (!navigator.geolocation) {
                    showToast("Current location not supported on this device");
                    return;
                }
                elements.mapStatusLabel.textContent = "Locating‚Ä¶";
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        setMapCenter(latitude, longitude, "geolocation");
                        state.map.applyFiltersGlobally = true;
                        elements.mapStatusLabel.textContent = "Centered on your location";
                        renderPrograms();
                    },
                    error => {
                        console.error("Geolocation error:", error);
                        elements.mapStatusLabel.textContent = "Unable to get current location";
                        showToast("Unable to access current location");
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
                );
            }

            function isProgramCompared(programId) {
                return state.comparison.programIds.includes(programId);
            }

            function updateComparisonStatus() {
                const count = state.comparison.programIds.length;
                if (elements.compareStatusLabel) {
                    elements.compareStatusLabel.textContent = count
                        ? `${count} program${count === 1 ? "" : "s"} selected.`
                        : "Select up to four programs to compare.";
                }
                if (state.view === "compare") {
                    elements.resultsSummary.textContent = count
                        ? `${count} program${count === 1 ? "" : "s"} in comparison`
                        : "No programs selected for comparison";
                }
            }

            function addProgramToComparison(programId) {
                if (isProgramCompared(programId)) return;
                if (state.comparison.programIds.length >= state.comparison.limit) {
                    showToast(`Comparison limited to ${state.comparison.limit} programs.`);
                    return;
                }
                state.comparison.programIds.push(programId);
                updateComparisonStatus();
                if (state.view === "compare") {
                    renderComparisonView();
                } else {
                    renderPrograms();
                }
            }

            function removeProgramFromComparison(programId) {
                const before = state.comparison.programIds.length;
                state.comparison.programIds = state.comparison.programIds.filter(id => id !== programId);
                if (state.comparison.programIds.length !== before) {
                    updateComparisonStatus();
                    if (state.view === "compare") {
                        renderComparisonView();
                    } else {
                        renderPrograms();
                    }
                }
            }

            function toggleProgramComparison(programId) {
                if (isProgramCompared(programId)) {
                    removeProgramFromComparison(programId);
                } else {
                    addProgramToComparison(programId);
                }
            }

            function renderComparisonView() {
                if (!elements.compareGrid) return;
                const selectedPrograms = state.comparison.programIds
                    .map(id => getProgramById(id))
                    .filter(Boolean);

                if (!selectedPrograms.length) {
                    elements.compareGrid.className = "compare-grid compare-grid--columns-1";
                    elements.compareGrid.innerHTML = `
                        <div class="compare-empty">
                            Select programs from the grid or rows view to start a side-by-side comparison.
                        </div>
                    `;
                    updateComparisonStatus();
                    return;
                }

                const columns = Math.min(selectedPrograms.length, 4);
                elements.compareGrid.className = `compare-grid compare-grid--columns-${columns}`;
                elements.compareGrid.innerHTML = selectedPrograms.map(program => {
                    const location = program.location
                        ? `${program.location.city}, ${program.location.state}`
                        : "Location not provided";
                    const availability = program.availabilityDays <= 0
                        ? "Immediate start"
                        : `Start in ${program.availabilityDays} day${program.availabilityDays === 1 ? "" : "s"}`;
                    return `
                        <article class="compare-card" data-program-id="${program.id}">
                            <button type="button" class="compare-remove" aria-label="Remove ${program.name} from comparison">√ó</button>
                            <header>
                                <h3>${program.name}</h3>
                                <span style="color:var(--text-subtle); font-size:0.85rem;">${program.focus} ¬∑ ${program.format}</span>
                            </header>
                            <div class="compare-meta">
                                <span>Location ¬∑ ${location}</span>
                                <span>Acuity ${program.acuity}/10</span>
                                <span>${availability}</span>
                            </div>
                            <div class="compare-section">
                                <h4>Overview</h4>
                                <div style="font-size:0.85rem; color:var(--text-subtle);">${program.summary}</div>
                            </div>
                            <div class="compare-section">
                                <h4>Weekly Structure</h4>
                                <div class="compare-list">
                                    ${program.weeklyStructure.map(item => `<div>‚Ä¢ ${item}</div>`).join("")}
                                </div>
                            </div>
                            <div class="compare-section">
                                <h4>Outcomes</h4>
                                <div class="compare-list">
                                    ${program.outcomes.map(item => `<div>‚Ä¢ ${item}</div>`).join("")}
                                </div>
                            </div>
                            <div class="compare-section">
                                <h4>Highlights</h4>
                                <div class="compare-list">
                                    ${program.highlights.map(item => `<div>‚Ä¢ ${item}</div>`).join("")}
                                </div>
                            </div>
                            <div class="compare-section">
                                <h4>Contact</h4>
                                <div style="font-size:0.82rem; color:var(--text-subtle);">
                                    ${program.contacts?.director ? `${program.contacts.director}<br>` : ""}
                                    ${program.contacts?.phone ? `${program.contacts.phone}<br>` : ""}
                                    ${program.contacts?.email ? `${program.contacts.email}` : ""}
                                </div>
                            </div>
                        </article>
                    `;
                }).join("");
                updateComparisonStatus();
            }

            function exportComparisonSnapshot(mode = "preview") {
                const selectedPrograms = state.comparison.programIds
                    .map(id => getProgramById(id))
                    .filter(Boolean);
                if (!selectedPrograms.length) {
                    showToast("Add programs to comparison before exporting.");
                    return;
                }
                const title = `CareConnect Comparison ‚Äì ${selectedPrograms.length} Program${selectedPrograms.length === 1 ? "" : "s"}`;
                const html = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>${title}</title>
                        <style>
                            body { font-family: "Segoe UI", Arial, sans-serif; margin: 24px; color: #1f2145; }
                            h1 { margin-bottom: 6px; }
                            .meta { color: #48508A; margin-bottom: 18px; font-size: 0.9rem; }
                            .grid { display: grid; gap: 16px; }
                            .grid.columns-1 { grid-template-columns: minmax(260px, 340px); }
                            .grid.columns-2 { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
                            .grid.columns-3 { grid-template-columns: repeat(3, minmax(240px, 1fr)); }
                            .grid.columns-4 { grid-template-columns: repeat(4, minmax(220px, 1fr)); }
                            .card { border: 1px solid #c9ceff; border-radius: 16px; padding: 16px; background: #fff; box-shadow: 0 8px 24px rgba(15,16,32,0.12); }
                            .card h2 { margin: 0 0 4px; font-size: 1.1rem; }
                            .sub { color: #48508A; font-size: 0.85rem; }
                            .section { margin-top: 14px; }
                            .section h3 { margin: 0 0 6px; font-size: 0.8rem; text-transform: uppercase; color: #6970a0; letter-spacing: 0.08em; }
                            ul { margin: 0; padding-left: 18px; color: #48508A; }
                        </style>
                    </head>
                    <body>
                        <h1>${title}</h1>
                        <div class="meta">Generated ${new Date().toLocaleString()}</div>
                        <div class="grid columns-${Math.min(selectedPrograms.length, 4)}">
                            ${selectedPrograms.map(program => `
                                <article class="card">
                                    <h2>${program.name}</h2>
                                    <div class="sub">${program.focus} ¬∑ ${program.format}</div>
                                    <div class="sub">${program.location ? `${program.location.city}, ${program.location.state}` : "Location not provided"}</div>
                                    <div class="section">
                                        <h3>Overview</h3>
                                        <p>${program.summary}</p>
                                    </div>
                                    <div class="section">
                                        <h3>Weekly Structure</h3>
                                        <ul>${program.weeklyStructure.map(item => `<li>${item}</li>`).join("")}</ul>
                                    </div>
                                    <div class="section">
                                        <h3>Outcomes</h3>
                                        <ul>${program.outcomes.map(item => `<li>${item}</li>`).join("")}</ul>
                                    </div>
                                    <div class="section">
                                        <h3>Highlights</h3>
                                        <ul>${program.highlights.map(item => `<li>${item}</li>`).join("")}</ul>
                                    </div>
                                    <div class="section">
                                        <h3>Contact</h3>
                                        <p>
                                            ${program.contacts?.director ? `${program.contacts.director}<br>` : ""}
                                            ${program.contacts?.phone ? `${program.contacts.phone}<br>` : ""}
                                            ${program.contacts?.email ? `${program.contacts.email}` : ""}
                                        </p>
                                    </div>
                                </article>
                            `).join("")}
                        </div>
                    </body>
                    </html>
                `;
                const win = window.open("", "_blank", "noopener,width=1080,height=720");
                if (!win) {
                    showToast("Enable pop-ups to export comparison.");
                    return;
                }
                win.document.write(html);
                win.document.close();
                if (mode === "print") {
                    win.focus();
                    setTimeout(() => win.print(), 400);
                }
            }

            function addComparisonProgramsToBuilder() {
                const selected = state.comparison.programIds.slice();
                if (!selected.length) {
                    showToast("Add programs to comparison before sending to the builder.");
                    return;
                }
                const targetLane = "bridge";
                let added = 0;
                selected.forEach(programId => {
                    const laneItems = state.builder.lanes[targetLane] || [];
                    const exists = laneItems.some(item => item.programId === programId);
                    if (!exists) {
                        addToBuilder(programId, targetLane, { silent: true });
                        added += 1;
                    }
                });
                if (added > 0) {
                    showToast(`Added ${added} program${added === 1 ? "" : "s"} to ${laneConfig[targetLane].label}`);
                } else {
                    showToast("All compared programs are already staged in the builder.");
                }
            }

            function handleCompareGridClick(event) {
                const button = event.target;
                if (!(button instanceof HTMLButtonElement)) return;
                if (!button.classList.contains("compare-remove")) return;
                const card = button.closest(".compare-card");
                if (!card) return;
                const programId = card.dataset.programId;
                if (programId) {
                    removeProgramFromComparison(programId);
                }
            }

            function createProgramCard(program) {
                const card = document.createElement("article");
                card.className = "program-card";
                card.setAttribute("role", "listitem");
                card.dataset.programId = program.id;
                const isCompared = isProgramCompared(program.id);
                if (isCompared) {
                    card.classList.add("is-compared");
                }
                card.innerHTML = `
                    <div class="program-card__header">
                        <div class="program-card__title">
                            <h3>${program.name}</h3>
                            <div class="program-card__meta">
                                <span class="badge badge--neutral">${program.focus}</span>
                                <span class="badge badge--neutral">${program.format}</span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px; font-size:0.78rem; color:var(--text-subtle);">
                            <span>Acuity ${program.acuity}/10</span>
                            <span>${program.availabilityDays <= 0 ? "Immediate start" : `Start in ${program.availabilityDays} day${program.availabilityDays > 1 ? "s" : ""}`}</span>
                        </div>
                    </div>
                    <p class="program-card__summary">${program.summary}</p>
                    <div class="program-card__tags">
                        ${program.tags.map(tag => `<span class="program-card__tag">${tag}</span>`).join("")}
                    </div>
                    <div class="program-card__actions">
                        <button class="pill-button compare-toggle ${isCompared ? "is-active" : ""}" data-action="compare" type="button">
                            ${isCompared ? "In Compare" : "Compare"}
                        </button>
                        <select aria-label="Select builder lane" data-program-lane>
                            <option value="stabilize">Stabilize (0‚Äì7 days)</option>
                            <option value="bridge">Bridge (Week 2‚Äì4)</option>
                            <option value="sustain">Sustain (30+ days)</option>
                        </select>
                        <button class="pill-button is-primary" data-action="add" type="button">
                            Add to Builder
                        </button>
                        <button class="pill-button" data-action="details" type="button">
                            View Details
                        </button>
                    </div>
                `;
                return card;
            }

            function resetVirtualization() {
                if (state.virtual.observer) {
                    state.virtual.observer.disconnect();
                    state.virtual.observer = null;
                }
                if (state.virtual.sentinel) {
                    state.virtual.sentinel.remove();
                    state.virtual.sentinel = null;
                }
                state.virtual.enabled = false;
                state.virtual.data = [];
                state.virtual.renderedCount = 0;
            }

            function appendVirtualChunk(start, end) {
                const fragment = document.createDocumentFragment();
                for (let i = start; i < end && i < state.virtual.data.length; i++) {
                    fragment.appendChild(createProgramCard(state.virtual.data[i]));
                }
                elements.resultsGrid.appendChild(fragment);
                state.virtual.renderedCount = Math.min(end, state.virtual.data.length);
            }

            function setupVirtualization(programs) {
                resetVirtualization();
                state.virtual.enabled = true;
                state.virtual.data = programs;
                const initialEnd = Math.min(state.virtual.pageSize, programs.length);
                appendVirtualChunk(0, initialEnd);
                const sentinel = document.createElement("div");
                sentinel.className = "virtual-sentinel";
                sentinel.setAttribute("aria-hidden", "true");
                elements.resultsGrid.appendChild(sentinel);
                state.virtual.sentinel = sentinel;
                state.virtual.observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const nextEnd = state.virtual.renderedCount + state.virtual.pageSize;
                            appendVirtualChunk(state.virtual.renderedCount, nextEnd);
                            if (state.virtual.renderedCount >= state.virtual.data.length) {
                                resetVirtualization();
                            }
                        }
                    });
                }, { root: null, threshold: 0.1 });
                state.virtual.observer.observe(sentinel);
            }

            async function renderPrograms() {
                const filtered = applyFilters(PROGRAMS);
                const sorted = sortPrograms(filtered.slice());
                state.filteredPrograms = sorted;

                if (state.view === "compare") {
                    resetVirtualization();
                    renderComparisonView();
                    updateComparisonStatus();
                    return;
                }

                if (state.view === "map") {
                    resetVirtualization();
                    elements.resultsGrid.innerHTML = "";
                    if (!sorted.length) {
                        elements.mapStatusLabel.textContent = "No programs match these filters yet. Adjust filters or radius to widen results.";
                        if (mapState.markersLayer) {
                            mapState.markersLayer.clearLayers();
                        }
                        updateResultsSummary(sorted);
                        return;
                    }
                    elements.mapStatusLabel.textContent = "Map view ready. Drag, zoom, or double-click to explore.";
                    await updateMap(sorted);
                    updateResultsSummary(sorted);
                    return;
                }

                elements.resultsGrid.innerHTML = "";

                if (!sorted.length) {
                    resetVirtualization();
                    const emptyState = document.createElement("div");
                    emptyState.setAttribute("role", "status");
                    emptyState.style.background = "rgba(233,236,255,0.6)";
                    emptyState.style.borderRadius = "18px";
                    emptyState.style.padding = "32px";
                    emptyState.style.textAlign = "center";
                    emptyState.style.color = "var(--text-subtle)";
                    emptyState.innerHTML = `
                        <strong>No programs match these filters yet.</strong>
                        <div style="margin-top:8px;">Try removing a filter or widening the focus area.</div>
                    `;
                    elements.resultsGrid.appendChild(emptyState);
                    updateResultsSummary(sorted);
                    return;
                }

                const shouldVirtualize = sorted.length > state.virtual.pageSize * 2;
                if (shouldVirtualize) {
                    elements.resultsGrid.innerHTML = "";
                    setupVirtualization(sorted);
                    updateResultsSummary(sorted);
                    return;
                }

                resetVirtualization();
                sorted.forEach(program => elements.resultsGrid.appendChild(createProgramCard(program)));

                updateResultsSummary(sorted);
            }

            function applyFilters(programs) {
                return programs.filter(program => {
                    if (state.filters.focus.size && !state.filters.focus.has(program.focus)) {
                        return false;
                    }
                    if (state.filters.format.size && !state.filters.format.has(program.format)) {
                        return false;
                    }
                    if (state.filters.insurance.size) {
                        const matchesInsurance = program.insurance.some(ins => state.filters.insurance.has(ins));
                        if (!matchesInsurance) return false;
                    }
                    if (state.filters.flag.size) {
                        const matchesFlag = program.flags?.some(flag => state.filters.flag.has(flag));
                        if (!matchesFlag) return false;
                    }
                    if (state.searchTerm) {
                        const term = state.searchTerm.toLowerCase();
                        const haystack = [
                            program.name,
                            program.summary,
                            ...(program.tags || []),
                            program.focus,
                            program.format
                        ].join(" ").toLowerCase();
                        if (!haystack.includes(term)) return false;
                    }
                    const applyMapFilters = state.map.applyFiltersGlobally || state.view === "map";
                    if (applyMapFilters) {
                        if (!matchesDistanceFilter(program)) {
                            return false;
                        }
                        const loc = program.location;
                        if (!loc || typeof loc.lat !== "number" || typeof loc.lng !== "number") {
                            return false;
                        }
                        const center = state.map.center;
                        if (typeof center.lat === "number" && typeof center.lng === "number") {
                            const distance = computeDistanceMiles(center.lat, center.lng, loc.lat, loc.lng);
                            if (distance > state.map.radiusMiles) {
                                return false;
                            }
                        }
                    }
                    return true;
                });
            }

            function sortPrograms(programs) {
                const sortKey = state.sort;
                return programs.sort((a, b) => {
                    if (sortKey === "acuity") {
                        return b.acuity - a.acuity;
                    }
                    if (sortKey === "availability") {
                        return a.availabilityDays - b.availabilityDays;
                    }
                    return a.name.localeCompare(b.name);
                });
            }

            function renderBuilder() {
                elements.builderLanes.innerHTML = "";
                Object.entries(laneConfig).forEach(([laneKey, laneInfo]) => {
                    const lane = document.createElement("section");
                    lane.className = "lane";
                    lane.dataset.lane = laneKey;
                    const items = state.builder.lanes[laneKey] || [];

                    lane.innerHTML = `
                        <div class="lane__header">
                            <div class="lane__title">
                                <strong>${laneInfo.label}</strong>
                                <span>${laneInfo.description}</span>
                            </div>
                            <button class="lane__add" data-lane="${laneKey}" type="button" aria-haspopup="true">
                                ${laneKey === "atHome" ? "Ôºã Add Resource" : "Ôºã Add Program"}
                            </button>
                        </div>
                        <div class="lane__list" id="lane-${laneKey}">
                            ${items.length ? "" : `<div class="builder-hint">${laneKey === "atHome" ? "No resources added yet. Use Add Resource to capture local supports." : "No programs added yet. Use Add Program or from a card."}</div>`}
                        </div>
                    `;

                    elements.builderLanes.appendChild(lane);

                    const listElement = lane.querySelector(".lane__list");
                    items.forEach((item, index) => {
                        const tile = document.createElement("article");
                        tile.dataset.lane = laneKey;
                        tile.dataset.index = index.toString();

                        if (laneKey === "atHome" || !item.programId) {
                            const addedStamp = item.addedAt
                                ? new Date(item.addedAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
                                : "just now";
                            tile.className = "builder-tile builder-tile--manual";
                            tile.dataset.resourceId = item.id || "";
                            tile.innerHTML = `
                                <div class="builder-manual-header">
                                    <input type="text" data-field="name" value="${escapeAttribute(item.name || "")}" placeholder="Resource name (e.g., Dr. Smith, LCSW)" aria-label="Resource name">
                                    <div class="builder-manual-meta">
                                        <input type="text" data-field="city" value="${escapeAttribute(item.city || "")}" placeholder="City / Telehealth" aria-label="Location or delivery">
                                        <input type="text" data-field="focus" value="${escapeAttribute(item.focus || "")}" placeholder="Focus or service type" aria-label="Service focus">
                                    </div>
                                </div>
                                <div class="builder-editor">
                                    <div class="editor-toolbar" role="toolbar" aria-label="Formatting options">
                                        <button type="button" data-editor-command="bold" aria-label="Bold">B</button>
                                        <button type="button" data-editor-command="italic" aria-label="Italic"><em>I</em></button>
                                        <button type="button" data-editor-command="bullet" aria-label="Bulleted list">‚Ä¢</button>
                                        <button type="button" data-editor-command="clear" aria-label="Clear formatting">‚úï</button>
                                    </div>
                                    <div class="editor-surface" data-field="notes" contenteditable="true" role="textbox" aria-multiline="true" data-placeholder="Type family-friendly notes, availability, or contact instructions.">${item.notesHtml || ""}</div>
                                </div>
                                <div class="builder-tile__actions">
                                    <div class="tile-actions">
                                        <button type="button" data-action="up" aria-label="Move up">‚ñ≤</button>
                                        <button type="button" data-action="down" aria-label="Move down">‚ñº</button>
                                        <button type="button" data-action="remove" aria-label="Remove resource">‚úï</button>
                                    </div>
                                    <span class="builder-hint">Auto-saves ¬∑ added ${addedStamp}</span>
                                </div>
                            `;
                            listElement.appendChild(tile);
                            return;
                        }

                        const program = getProgramById(item.programId);
                        if (!program) return;
                        const trackOptions = getProgramTrackOptions(item.programId);
                        const currentTrack = item.track || getDefaultTrackId(item.programId);
                        const trackOptionsHtml = trackOptions.map(option => `
                            <option value="${option.id}" ${option.id === currentTrack ? "selected" : ""}>${option.label}</option>
                        `).join("");
                        const trackLabel = getTrackLabel(currentTrack, item.programId);
                        tile.className = "builder-tile";
                        tile.dataset.programId = program.id;
                        tile.innerHTML = `
                            <div class="builder-tile__title">
                                <div class="builder-program-heading">
                                    <strong>${program.name}</strong>
                                    <small>${program.focus} ¬∑ ${program.format}</small>
                                </div>
                                <span class="builder-track-chip" data-track="${currentTrack}">${trackLabel}</span>
                            </div>
                            <label class="builder-track-select">
                                Track emphasis
                                <div class="track-select-row">
                                    <select data-field="track" aria-label="Select track emphasis">
                                        ${trackOptionsHtml}
                                    </select>
                                    <button type="button" class="track-apply-button" data-track-apply="lane" aria-label="Apply track to entire lane">Apply to lane</button>
                                </div>
                            </label>
                            <label>
                                Client initials
                                <input type="text" maxlength="8" value="${item.client || ""}" placeholder="e.g., JD" aria-label="Client initials">
                            </label>
                            <label>
                                Why this program?
                                <textarea rows="2" placeholder="Add clinical rationale">${item.reason || ""}</textarea>
                            </label>
                            <div class="builder-tile__actions">
                                <div class="tile-actions">
                                    <button type="button" data-action="up" aria-label="Move up">‚ñ≤</button>
                                    <button type="button" data-action="down" aria-label="Move down">‚ñº</button>
                                    <button type="button" data-action="remove" aria-label="Remove from builder">‚úï</button>
                                </div>
                                <span class="builder-hint">Auto-saves ¬∑ added ${new Date(item.addedAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
                            </div>
                        `;
                        listElement.appendChild(tile);
                    });
                });

                updateBuilderSummary();
            }

            function updateBuilderSummary() {
                const laneKeys = Object.keys(laneConfig);
                const counts = laneKeys.map(key => state.builder.lanes[key]?.length || 0);
                const total = counts.reduce((sum, value) => sum + value, 0);
                elements.builderSummary.textContent = total
                    ? `${total} entr${total === 1 ? "y" : "ies"} staged across ${counts.map((count, idx) => {
                        const laneKey = laneKeys[idx];
                        const label = laneConfig[laneKey].label.split(" ")[0];
                        return `${count} ${label}`;
                    }).join(", ")}`
                    : "No entries staged yet";
            }

            function openDetails(id) {
                const program = PROGRAMS.find(p => p.id === id);
                if (!program) return;
                state.selectedProgramId = program.id;
                elements.detailsTitle.textContent = program.name;
                elements.detailsSubtitle.textContent = program.summary;
                elements.detailsMeta.innerHTML = `
                    <span class="badge badge--neutral">${program.focus}</span>
                    <span class="badge badge--neutral">${program.format}</span>
                    <span class="badge badge--neutral">Starts ${program.availabilityDays <= 0 ? "now" : `in ${program.availabilityDays} day${program.availabilityDays > 1 ? "s" : ""}`}</span>
                `;
                elements.detailsBody.innerHTML = `
                    <div class="details-panel__section">
                        <h3>Programming cadence</h3>
                        <ul class="details-panel__list">
                            ${program.weeklyStructure.map(item => `<li>${item}</li>`).join("")}
                        </ul>
                    </div>
                    <div class="details-panel__section">
                        <h3>Outcomes & analytics</h3>
                        <ul class="details-panel__list">
                            ${program.outcomes.map(item => `<li>${item}</li>`).join("")}
                        </ul>
                    </div>
                    <div class="details-panel__section">
                        <h3>Highlights</h3>
                        <ul class="details-panel__list">
                            ${program.highlights.map(item => `<li>${item}</li>`).join("")}
                        </ul>
                    </div>
                    <div class="details-panel__section">
                        <h3>Contacts</h3>
                        <div style="font-size:0.85rem; color:var(--text-subtle); display:grid; gap:4px;">
                            <span>${program.contacts.director}</span>
                            <span>${program.contacts.phone}</span>
                            <span>${program.contacts.email}</span>
                        </div>
                    </div>
                `;
                overlays.overlay.classList.add("is-active");
                overlays.panel.classList.add("is-open");
                overlays.overlay.setAttribute("aria-hidden", "false");
                elements.detailsAddButton.disabled = false;
                elements.detailsGenerateButton.disabled = false;
                elements.detailsAddButton.setAttribute("data-program-id", program.id);
                elements.detailsGenerateButton.setAttribute("data-program-id", program.id);
                announce(`Details open for ${program.name}`);
            }

            function closeDetails() {
                overlays.overlay.classList.remove("is-active");
                overlays.panel.classList.remove("is-open");
                overlays.overlay.setAttribute("aria-hidden", "true");
                elements.detailsAddButton.removeAttribute("data-program-id");
                elements.detailsGenerateButton.removeAttribute("data-program-id");
            }

            function toggleFilter(button) {
                const group = button.dataset.group;
                const value = button.dataset.value;
                const active = button.classList.toggle("is-active");
                const targetSet = state.filters[group];
                if (!targetSet) return;
                if (active) {
                    targetSet.add(value);
                } else {
                    targetSet.delete(value);
                }
                renderPrograms();
            }

            function setView(view) {
                if (!view) return;
                state.view = view;
                viewToggleButtons.forEach(btn => {
                    btn.classList.toggle("is-active", btn.dataset.view === view);
                });
                const isRows = view === "rows";
                const isMap = view === "map";
                const isCompare = view === "compare";
                elements.resultsGrid.classList.toggle("is-compact", isRows);
                elements.resultsGrid.style.display = (isMap || isCompare) ? "none" : "grid";
                elements.mapContainer.classList.toggle("is-visible", isMap);
                elements.compareContainer.classList.toggle("is-visible", isCompare);
                if (isMap) {
                    if (elements.mapRadiusInput) {
                        elements.mapRadiusInput.value = String(state.map.radiusMiles);
                    }
                    if (elements.mapRadiusValue) {
                        elements.mapRadiusValue.textContent = `${state.map.radiusMiles} mi`;
                    }
                    if (elements.mapDistanceFilter) {
                        elements.mapDistanceFilter.value = state.map.distanceFilter || "all";
                    }
                }
                if (isCompare) {
                    renderComparisonView();
                }
                try {
                    localStorage.setItem("ccpro-preferred-view", view);
                } catch (error) {
                    console.warn("Unable to persist preferred view", error);
                }
                renderPrograms();
            }

            function getProgramById(id) {
                return PROGRAMS.find(program => program.id === id);
            }

            function addToBuilder(programId, lane, options = {}) {
                const program = getProgramById(programId);
                if (!program) {
                    showToast("Program not found");
                    return;
                }
                const laneItems = state.builder.lanes[lane];
                if (!laneItems) {
                    showToast("Lane unavailable");
                    return;
                }
                const alreadyExists = laneItems.some(item => item.programId === programId);
                if (alreadyExists) {
                    if (!options.silent) {
                        showToast(`${program.name} is already in ${laneConfig[lane].label}`);
                    }
                    return;
                }
                laneItems.push({
                    programId,
                    client: "",
                    reason: "",
                    track: getDefaultTrackId(programId),
                    addedAt: new Date().toISOString()
                });
                renderBuilder();
                scheduleAutosave();
                if (!options.silent) {
                    showToast(`${program.name} added to ${laneConfig[lane].label}`);
                }
            }

            function addManualAtHomeResource() {
                const entry = normalizeAtHomeEntry({
                    id: generateAtHomeId(),
                    addedAt: new Date().toISOString(),
                    notesHtml: "",
                    notesText: ""
                });
                state.builder.lanes.atHome.push(entry);
                renderBuilder();
                scheduleAutosave();
                showToast("At-home resource added");
                window.requestAnimationFrame(() => {
                    const newIndex = state.builder.lanes.atHome.length - 1;
                    const editor = elements.builderLanes.querySelector(`.builder-tile[data-lane="atHome"][data-index="${newIndex}"] .editor-surface`);
                    if (editor) {
                        editor.focus();
                    }
                });
            }

            function handleBuilderInput(event) {
                const target = event.target;
                const tile = target.closest(".builder-tile");
                if (!tile) return;
                const lane = tile.dataset.lane;
                const index = Number(tile.dataset.index);
                const laneItems = state.builder.lanes[lane];
                if (!laneItems || laneItems[index] == null) return;
                const item = laneItems[index];

                if (lane === "atHome") {
                    if (target instanceof HTMLInputElement && target.dataset.field) {
                        item[target.dataset.field] = target.value;
                        item.lastEdited = new Date().toISOString();
                        scheduleAutosave();
                    } else if (target instanceof HTMLElement && target.dataset.field === "notes") {
                        const sanitized = sanitizeRichText(target.innerHTML);
                        if (sanitized !== target.innerHTML) {
                            target.innerHTML = sanitized;
                        }
                        if (!sanitized) {
                            target.innerHTML = "";
                        }
                        item.notesHtml = sanitized;
                        item.notesText = getPlainTextFromHtml(sanitized);
                        item.lastEdited = new Date().toISOString();
                        scheduleAutosave();
                    }
                    return;
                }

                if (target instanceof HTMLSelectElement && target.dataset.field === "track") {
                    item.track = target.value;
                    item.addedAt = item.addedAt || new Date().toISOString();
                    renderBuilder();
                    scheduleAutosave();
                    return;
                }

                if (target instanceof HTMLInputElement) {
                    item.client = target.value.toUpperCase();
                    item.addedAt = item.addedAt || new Date().toISOString();
                    scheduleAutosave();
                } else if (target instanceof HTMLTextAreaElement) {
                    item.reason = target.value;
                    item.addedAt = item.addedAt || new Date().toISOString();
                    scheduleAutosave();
                }
            }

            function applyEditorCommand(tile, command) {
                const editor = tile.querySelector(".editor-surface");
                if (!editor) return;
                editor.focus();
                if (command === "clear") {
                    editor.innerHTML = "";
                    const syntheticClear = new Event("input", { bubbles: true });
                    editor.dispatchEvent(syntheticClear);
                    return;
                }
                const execCommand = command === "bullet" ? "insertUnorderedList" : command;
                try {
                    document.execCommand(execCommand);
                } catch (error) {
                    console.warn("Formatting command failed:", command, error);
                }
                const synthetic = new Event("input", { bubbles: true });
                editor.dispatchEvent(synthetic);
            }

            function applyTrackToLane(lane, trackId) {
                if (!trackId || lane === "atHome") return;
                const laneItems = state.builder.lanes[lane];
                if (!laneItems || !laneItems.length) return;
                laneItems.forEach(item => {
                    if (item.programId) {
                        item.track = trackId;
                    }
                });
                renderBuilder();
                scheduleAutosave();
                const laneLabel = laneConfig[lane]?.label || "Lane";
                showToast(`${laneLabel} set to ${getTrackLabel(trackId)}`);
            }

            function handleTileAction(event) {
                const button = event.target;
                if (!(button instanceof HTMLButtonElement)) return;
                const tile = button.closest(".builder-tile");
                if (!tile) return;
                const lane = tile.dataset.lane;
                const index = Number(tile.dataset.index);
                const laneItems = state.builder.lanes[lane];
                if (!laneItems) return;
                const editorCommand = button.dataset.editorCommand;
                if (editorCommand) {
                    applyEditorCommand(tile, editorCommand);
                    return;
                }
                const trackApply = button.dataset.trackApply;
                if (trackApply === "lane") {
                    const item = laneItems[index];
                    if (item?.track) {
                        applyTrackToLane(lane, item.track);
                    }
                    return;
                }
                const action = button.dataset.action;
                if (action === "remove") {
                    const removed = laneItems.splice(index, 1)[0];
                    renderBuilder();
                    scheduleAutosave();
                    if (removed) {
                        if (removed.programId) {
                            const program = getProgramById(removed.programId);
                            showToast(`${program?.name ?? "Program"} removed from builder`);
                        } else {
                            showToast(`${removed.name || "Resource"} removed from builder`);
                        }
                    }
                } else if (action === "up" && index > 0) {
                    [laneItems[index - 1], laneItems[index]] = [laneItems[index], laneItems[index - 1]];
                    renderBuilder();
                    scheduleAutosave();
                } else if (action === "down" && index < laneItems.length - 1) {
                    [laneItems[index], laneItems[index + 1]] = [laneItems[index + 1], laneItems[index]];
                    renderBuilder();
                    scheduleAutosave();
                }
            }

            function saveDraft(trigger = "auto") {
                state.builder.lastSaved = new Date().toISOString();
                const payload = {
                    version: 2,
                    documentType: state.documentType,
                    builder: state.builder,
                    comparison: {
                        programIds: state.comparison.programIds.slice(0, state.comparison.limit)
                    },
                    map: {
                        radiusMiles: state.map.radiusMiles,
                        distanceFilter: state.map.distanceFilter,
                        applyFiltersGlobally: state.map.applyFiltersGlobally,
                        center: state.map.center
                    }
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                updateDraftMeta();
                if (trigger === "manual") {
                    showToast("Draft saved");
                }
            }

            function scheduleAutosave() {
                if (autosaveTimer) {
                    clearTimeout(autosaveTimer);
                }
                autosaveTimer = window.setTimeout(() => saveDraft("auto"), 800);
            }

            function loadDraft() {
                try {
                    const storageKeys = [STORAGE_KEY, ...LEGACY_STORAGE_KEYS];
                    let sourceKey = null;
                    let raw = null;
                    for (const key of storageKeys) {
                        try {
                            raw = localStorage.getItem(key);
                        } catch {
                            raw = null;
                        }
                        if (raw) {
                            sourceKey = key;
                            break;
                        }
                    }
                    if (!raw) return null;
                    const data = JSON.parse(raw);
                    if (!data) return null;

                    let builder;
                    if (data.builder) {
                        builder = {
                            lanes: {
                                stabilize: (data.builder.lanes?.stabilize || []).map(normalizeProgramEntry),
                                bridge: (data.builder.lanes?.bridge || []).map(normalizeProgramEntry),
                                sustain: (data.builder.lanes?.sustain || []).map(normalizeProgramEntry),
                                atHome: (data.builder.lanes?.atHome || []).map(normalizeAtHomeEntry)
                            },
                            lastSaved: data.builder.lastSaved || data.lastSaved || null
                        };
                    } else if (data.lanes) {
                        builder = {
                            lanes: {
                                stabilize: (data.lanes.stabilize || []).map(normalizeProgramEntry),
                                bridge: (data.lanes.bridge || []).map(normalizeProgramEntry),
                                sustain: (data.lanes.sustain || []).map(normalizeProgramEntry),
                                atHome: []
                            },
                            lastSaved: data.lastSaved || null
                        };
                    } else {
                        builder = null;
                    }

                    if (sourceKey && sourceKey !== STORAGE_KEY) {
                        try {
                            localStorage.removeItem(sourceKey);
                        } catch (error) {
                            console.warn("Unable to remove legacy draft key", error);
                        }
                    }

                    if (!builder) return null;

                    const comparisonProgramIds = Array.isArray(data.comparison?.programIds)
                        ? data.comparison.programIds.filter(id => typeof id === "string")
                        : [];

                    const mapState = data.map && typeof data.map === "object"
                        ? {
                            radiusMiles: typeof data.map.radiusMiles === "number" ? data.map.radiusMiles : undefined,
                            distanceFilter: typeof data.map.distanceFilter === "string" ? data.map.distanceFilter : undefined,
                            applyFiltersGlobally: Boolean(data.map.applyFiltersGlobally),
                            center: data.map.center && typeof data.map.center.lat === "number" && typeof data.map.center.lng === "number"
                                ? data.map.center
                                : undefined
                        }
                        : null;

                    return {
                        builder,
                        documentType: data.documentType === "aftercare-plan" ? "aftercare-plan" : "aftercare-options",
                        comparisonProgramIds,
                        mapState
                    };
                } catch (error) {
                    console.warn("Unable to load draft", error);
                    return null;
                }
            }

            function generateDocument(docType = state.documentType, programId) {
                const builderItems = Object.values(state.builder.lanes).flat();
                if (!builderItems.length && !programId) {
                    showToast("Add at least one program before generating");
                    return;
                }
                const usedPrograms = programId
                    ? [getProgramById(programId)]
                    : builderItems.map(item => getProgramById(item.programId)).filter(Boolean);
                const names = usedPrograms.map(p => p?.name).filter(Boolean);
                saveDraft("manual");
                const snapshot = collectBuilderSnapshot(programId || null);
                window.latestGeneratedDocument = snapshot;
                const label = getDocumentTypeLabel(docType);
                const summary = names.length ? names.join(", ") : (programId ? "selected program" : "current builder entries");
                const html = renderDocumentHtml(snapshot);
                const docWindow = window.open("", "_blank", "noopener,width=980,height=720");
                if (!docWindow) {
                    showToast("Enable pop-ups to preview the document.");
                    return;
                }
                docWindow.document.write(html);
                docWindow.document.close();
                docWindow.focus();
                showToast(`${label} generated with ${summary}`);
            }

            function populateQuickAddOptions() {
                const frag = document.createDocumentFragment();
                PROGRAMS.forEach(program => {
                    const option = document.createElement("option");
                    option.value = program.id;
                    option.textContent = program.name;
                    frag.appendChild(option);
                });
                elements.quickAddProgram.innerHTML = "";
                elements.quickAddProgram.appendChild(frag);
                elements.quickAddLane.value = state.quickAddLane;
            }

            function showQuickAdd(lane) {
                state.quickAddLane = lane;
                overlays.quickAdd.classList.add("is-visible");
                overlays.quickAdd.setAttribute("aria-hidden", "false");
                elements.quickAddLane.value = lane;
                populateQuickAddOptions();
            }

            function hideQuickAdd() {
                overlays.quickAdd.classList.remove("is-visible");
                overlays.quickAdd.setAttribute("aria-hidden", "true");
            }

            function clearFilters() {
                filterButtons.forEach(btn => btn.classList.remove("is-active"));
                Object.values(state.filters).forEach(set => set.clear());
                state.map.distanceFilter = "all";
                state.map.applyFiltersGlobally = false;
                setMapRadiusMiles(state.map.defaultRadius, { silent: true });
                if (elements.mapDistanceFilter) {
                    elements.mapDistanceFilter.value = "all";
                }
                if (elements.mapRadiusValue) {
                    elements.mapRadiusValue.textContent = `${state.map.defaultRadius} mi`;
                }
                renderPrograms();
            }

            function handleProgramCardClick(event) {
                const button = event.target;
                if (!(button instanceof HTMLButtonElement)) return;
                const card = button.closest(".program-card");
                if (!card) return;
                const programId = card.dataset.programId;
                if (!programId) return;
                if (button.dataset.action === "details") {
                    openDetails(programId);
                    return;
                }
                if (button.dataset.action === "add") {
                    const select = card.querySelector("[data-program-lane]");
                    const lane = select?.value || "stabilize";
                    addToBuilder(programId, lane);
                    return;
                }
                if (button.dataset.action === "compare") {
                    toggleProgramComparison(programId);
                    return;
                }
            }

            function handleLaneAddClick(event) {
                const button = event.target;
                if (!(button instanceof HTMLButtonElement)) return;
                if (!button.classList.contains("lane__add")) return;
                const lane = button.dataset.lane || "stabilize";
                if (lane === "atHome") {
                    addManualAtHomeResource();
                    return;
                }
                showQuickAdd(lane);
            }

            function handleKeyboardShortcuts(event) {
                const tag = event.target.tagName;
                if (["INPUT", "TEXTAREA", "SELECT"].includes(tag)) {
                    return;
                }
                if (event.key === "/") {
                    event.preventDefault();
                    elements.searchInput.focus();
                } else if (event.key.toLowerCase() === "a") {
                    event.preventDefault();
                    showQuickAdd("stabilize");
                } else if (event.key.toLowerCase() === "c") {
                    event.preventDefault();
                    const firstCard = elements.resultsGrid.querySelector(".program-card");
                    if (firstCard) {
                        const programId = firstCard.dataset.programId;
                        openDetails(programId);
                    }
                } else if (event.key.toLowerCase() === "g") {
                    event.preventDefault();
                    generateDocument(state.documentType, state.selectedProgramId);
                }
            }

            function hydrateFromDraft() {
                setDocumentType(state.documentType, { announce: false, scheduleSave: false });
                renderBuilder();
            }

            function init() {
                renderPrograms();
                hydrateFromDraft();
                populateQuickAddOptions();
                updateComparisonStatus();

                documentTypeButtons.forEach(button => {
                    button.addEventListener("click", () => setDocumentType(button.dataset.docType));
                });
                filterButtons.forEach(button => button.addEventListener("click", () => toggleFilter(button)));
                viewToggleButtons.forEach(button => button.addEventListener("click", () => setView(button.dataset.view)));
                const savedView = (() => {
                    try {
                        return localStorage.getItem("ccpro-preferred-view");
                    } catch {
                        return null;
                    }
                })();
                if (savedView && ["grid", "rows", "map", "compare"].includes(savedView)) {
                    if (savedView === "compare" && state.comparison.programIds.length === 0) {
                        setView("grid");
                    } else {
                        setView(savedView);
                    }
                } else {
                    setView("grid");
                }

                clearFiltersButton.addEventListener("click", clearFilters);
                elements.searchInput.addEventListener("input", event => {
                    state.searchTerm = event.target.value.trim();
                    renderPrograms();
                });
                elements.sortSelect.addEventListener("change", event => {
                    state.sort = event.target.value;
                    renderPrograms();
                });
                elements.resultsGrid.addEventListener("click", handleProgramCardClick);
                elements.builderLanes.addEventListener("click", handleLaneAddClick);
                elements.builderLanes.addEventListener("input", handleBuilderInput);
                elements.builderLanes.addEventListener("change", handleBuilderInput);
                elements.builderLanes.addEventListener("click", handleTileAction);
                elements.builderLanes.addEventListener("mousedown", event => {
                    const target = event.target;
                    if (target instanceof HTMLButtonElement && target.dataset.editorCommand) {
                        event.preventDefault();
                    }
                });
                if (elements.mapRadiusInput) {
                    elements.mapRadiusInput.value = String(state.map.radiusMiles);
                    elements.mapRadiusValue.textContent = `${state.map.radiusMiles} mi`;
                    elements.mapRadiusInput.addEventListener("input", event => {
                        const value = Number(event.target.value);
                        if (!Number.isNaN(value)) {
                            setMapRadiusMiles(value);
                            if (state.view === "map") {
                                refreshMapDebounced();
                            } else {
                                renderPrograms();
                            }
                        }
                    });
                }
                if (elements.mapDistanceFilter) {
                    elements.mapDistanceFilter.value = state.map.distanceFilter || "all";
                    elements.mapDistanceFilter.addEventListener("change", event => {
                        state.map.distanceFilter = event.target.value;
                        state.map.applyFiltersGlobally = true;
                        renderPrograms();
                    });
                }
                if (elements.mapZipInput) {
                    elements.mapZipInput.addEventListener("keydown", event => {
                        if (event.key === "Enter") {
                            event.preventDefault();
                            centerMapByZip(event.target.value);
                        }
                    });
                }
                if (elements.mapLocateButton) {
                    elements.mapLocateButton.addEventListener("click", handleLocateButton);
                }
                if (elements.compareGrid) {
                    elements.compareGrid.addEventListener("click", handleCompareGridClick);
                }
                if (elements.compareAddAllButton) {
                    elements.compareAddAllButton.addEventListener("click", addComparisonProgramsToBuilder);
                }
                if (elements.compareExportButton) {
                    elements.compareExportButton.addEventListener("click", () => exportComparisonSnapshot("preview"));
                }
                if (elements.comparePrintButton) {
                    elements.comparePrintButton.addEventListener("click", () => exportComparisonSnapshot("print"));
                }
                overlays.overlay.addEventListener("click", closeDetails);
                closeDetailsButton.addEventListener("click", closeDetails);
                document.addEventListener("keydown", handleKeyboardShortcuts);

                saveDraftButton.addEventListener("click", () => saveDraft("manual"));
                generateButton.addEventListener("click", () => generateDocument());
                elements.detailsAddButton.addEventListener("click", event => {
                    const programId = event.currentTarget.getAttribute("data-program-id") || state.selectedProgramId;
                    if (!programId) return;
                    addToBuilder(programId, "bridge");
                });
                elements.detailsGenerateButton.addEventListener("click", event => {
                    const programId = event.currentTarget.getAttribute("data-program-id");
                    if (!programId) return;
                    generateDocument(state.documentType, programId);
                });

                quickAddCancel.addEventListener("click", hideQuickAdd);
                quickAddConfirm.addEventListener("click", () => {
                    const programId = elements.quickAddProgram.value;
                    const lane = elements.quickAddLane.value;
                    if (programId && lane) {
                        addToBuilder(programId, lane);
                        hideQuickAdd();
                    }
                });

                announce("Programs workspace ready");
            }

            window.openDetails = openDetails;
            window.addToBuilder = addToBuilder;
            window.generateDocument = generateDocument;
            window.saveDraft = saveDraft;

            init();
        }());
    </script>
</body>
</html>


