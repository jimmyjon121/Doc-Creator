<!DOCTYPE html>

<!-- 
    CareConnect Pro - Interactive Clinical Learning & Planning Suite
    Version: 1.0.0
    Built: 2025-10-15T02:30:45.698Z
    
    Features:
    - 5 Interactive Learning Modules
    - Guided Workflow Engine
    - Smart Feedback System
    - Professional Documentation
    - Progress Tracking & Achievements
    - HIPAA Compliant (No PHI Stored)
    
    Ready for Production Deployment
-->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect Pro - Interactive Clinical Learning & Planning Suite</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-teal: #17a2b8;
            --secondary-coral: #ff6b6b;
            --success-green: #51cf66;
            --warning-amber: #ffc107;
            --warm-cream: #fdfbf7;
            --warm-gray: #495057;
            --light-gray: #e9ecef;
            --border-color: #dee2e6;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--warm-cream) 0%, #fff 100%);
            color: var(--warm-gray);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Onboarding Screen */
        .onboarding-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .onboarding-card {
            background: white;
            border-radius: 24px;
            padding: 48px;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            text-align: center;
            animation: slideUp 0.6s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .onboarding-emoji {
            font-size: 72px;
            margin-bottom: 24px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .onboarding-title {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
        }
        
        .onboarding-subtitle {
            font-size: 18px;
            color: var(--warm-gray);
            margin-bottom: 32px;
        }
        
        .onboarding-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .onboarding-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .role-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .role-option {
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .role-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .role-option.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-color: #667eea;
        }
        
        .role-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .role-label {
            font-weight: 600;
            font-size: 14px;
        }
        
        .btn-start {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        /* Main App Layout */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: 100vh;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* Left Sidebar */
        .sidebar-left {
            background: white;
            border-right: 1px solid var(--border-color);
            padding: 24px;
            overflow-y: auto;
        }
        
        .user-welcome {
            background: linear-gradient(135deg, var(--primary-teal) 0%, #138496 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .welcome-greeting {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .welcome-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 16px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 11px;
            opacity: 0.9;
        }
        
        .workflow-progress {
            margin-bottom: 32px;
        }
        
        .workflow-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--warm-gray);
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .workflow-step::before {
            content: '';
            position: absolute;
            left: 28px;
            top: 100%;
            width: 2px;
            height: 8px;
            background: var(--light-gray);
        }
        
        .workflow-step:last-child::before {
            display: none;
        }
        
        .workflow-step:hover {
            background: var(--warm-cream);
        }
        
        .workflow-step.active {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.1) 0%, rgba(19, 132, 150, 0.1) 100%);
            border-left: 3px solid var(--primary-teal);
        }
        
        .workflow-step.completed {
            opacity: 0.7;
        }
        
        .workflow-step.completed .step-icon {
            background: var(--success-green);
            color: white;
        }
        
        .step-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--light-gray);
            transition: all 0.3s ease;
        }
        
        .workflow-step.active .step-icon {
            background: var(--primary-teal);
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .step-description {
            font-size: 11px;
            color: var(--warm-gray);
            opacity: 0.7;
        }
        
        .daily-goals {
            background: var(--warm-cream);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .goal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .goal-icon {
            font-size: 20px;
        }
        
        .goal-text {
            flex: 1;
            font-size: 13px;
        }
        
        .goal-progress {
            font-size: 12px;
            color: var(--primary-teal);
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            padding: 32px;
            overflow-y: auto;
            background: var(--warm-cream);
        }
        
        .content-header {
            margin-bottom: 32px;
        }
        
        .content-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-teal);
            margin-bottom: 8px;
        }
        
        .content-subtitle {
            font-size: 16px;
            color: var(--warm-gray);
        }
        
        .progress-bar {
            height: 8px;
            background: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 16px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-teal) 0%, var(--success-green) 100%);
            transition: width 0.5s ease;
        }
        
        /* Module Cards */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .module-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .module-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-teal) 0%, var(--secondary-coral) 100%);
        }
        
        .module-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }
        
        .module-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        
        .module-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .module-duration {
            font-size: 12px;
            color: var(--warm-gray);
            opacity: 0.7;
        }
        
        .module-badge {
            background: var(--secondary-coral);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .module-description {
            font-size: 14px;
            color: var(--warm-gray);
            margin-bottom: 16px;
        }
        
        .module-progress {
            margin-top: 16px;
        }
        
        .module-progress-bar {
            height: 6px;
            background: var(--light-gray);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .module-progress-fill {
            height: 100%;
            background: var(--success-green);
            transition: width 0.3s ease;
        }
        
        .module-progress-text {
            font-size: 11px;
            color: var(--warm-gray);
            margin-top: 4px;
            text-align: right;
        }
        
        /* Right Sidebar */
        .sidebar-right {
            background: white;
            border-left: 1px solid var(--border-color);
            padding: 24px;
            overflow-y: auto;
        }
        
        .achievement-banner {
            background: linear-gradient(135deg, var(--success-green) 0%, #37b24d 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .achievement-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .achievement-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .achievement-description {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .tips-section {
            margin-bottom: 32px;
        }
        
        .tips-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--primary-teal);
        }
        
        .tip-card {
            background: linear-gradient(135deg, #fff9e6 0%, #fff 100%);
            border-left: 3px solid #ffd43b;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        
        .tip-icon {
            font-size: 20px;
            margin-bottom: 8px;
        }
        
        .tip-text {
            font-size: 13px;
            line-height: 1.5;
        }
        
        .leaderboard {
            background: var(--warm-cream);
            padding: 16px;
            border-radius: 12px;
        }
        
        .leaderboard-title {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .leaderboard-rank {
            font-weight: 700;
            color: var(--primary-teal);
            width: 20px;
        }
        
        .leaderboard-name {
            flex: 1;
            font-size: 13px;
        }
        
        .leaderboard-score {
            font-weight: 600;
            font-size: 13px;
            color: var(--warm-gray);
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .app-container {
                grid-template-columns: 280px 1fr;
            }
            
            .sidebar-right {
                display: none;
            }
        }
        
        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar-left {
                display: none;
            }
        }
        
        .hidden {
            display: none !important;
        }
    </style>

<style>
/* ============= MODULE STYLES ============= */
/* modules.css - Styling for Interactive Learning Modules */

/* Module Viewer */
.module-viewer {
    background: white;
    border-radius: 20px;
    padding: 32px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.module-viewer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border-color);
}

.btn-back {
    background: none;
    border: none;
    color: var(--primary-teal);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.btn-back:hover {
    transform: translateX(-4px);
}

.module-viewer-progress {
    background: var(--light-gray);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    color: var(--warm-gray);
}

.module-viewer-content {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 32px;
}

/* Lessons Sidebar */
.lesson-sidebar {
    background: var(--warm-cream);
    border-radius: 16px;
    padding: 20px;
}

.module-title-sidebar {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 18px;
    margin-bottom: 8px;
}

.module-icon {
    font-size: 28px;
}

.lessons {
    margin-top: 20px;
}

.lesson-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.lesson-item:hover {
    background: white;
}

.lesson-item.active {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.lesson-item.completed {
    opacity: 0.7;
}

.lesson-number {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 13px;
}

.lesson-item.active .lesson-number {
    background: var(--primary-teal);
    color: white;
}

.lesson-item.completed .lesson-number {
    background: var(--success-green);
    color: white;
}

.lesson-info {
    flex: 1;
}

.lesson-title {
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 2px;
}

.lesson-type {
    font-size: 11px;
    color: var(--warm-gray);
    opacity: 0.7;
}

.lesson-check {
    color: var(--success-green);
    font-size: 20px;
}

/* Lesson Content */
.lesson-content {
    background: white;
}

.lesson-main-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary-teal);
    margin-bottom: 24px;
}

.lesson-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 40px;
    padding-top: 24px;
    border-top: 2px solid var(--border-color);
}

/* Visual Hierarchy */
.visual-hierarchy {
    margin-bottom: 32px;
}

.treatment-ladder {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.ladder-level {
    background: linear-gradient(135deg, white 0%, var(--warm-cream) 100%);
    border-left: 4px solid var(--primary-teal);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
}

.ladder-level:hover {
    transform: translateX(8px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.level-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.level-header h4 {
    font-size: 18px;
    color: var(--primary-teal);
}

.intensity-badge {
    background: var(--primary-teal);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.level-description {
    font-size: 14px;
    margin-bottom: 12px;
    color: var(--warm-gray);
}

.level-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-top: 12px;
}

.detail-item {
    font-size: 13px;
}

.detail-item strong {
    display: block;
    color: var(--warm-gray);
    margin-bottom: 4px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Drag and Drop Exercise */
.matching-exercise {
    padding: 24px;
    background: var(--warm-cream);
    border-radius: 16px;
}

.instructions {
    font-size: 16px;
    margin-bottom: 24px;
    color: var(--warm-gray);
}

.drag-drop-exercise {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
}

.scenarios-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.scenario-card {
    background: white;
    padding: 16px;
    border-radius: 12px;
    cursor: move;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.scenario-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.scenario-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.scenario-card strong {
    display: block;
    margin-bottom: 8px;
    color: var(--primary-teal);
}

.scenario-card p {
    font-size: 13px;
    color: var(--warm-gray);
}

.drop-zones {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.drop-zone {
    background: white;
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 16px;
    min-height: 100px;
}

.drop-zone.drag-over {
    border-color: var(--primary-teal);
    background: rgba(23, 162, 184, 0.05);
}

.drop-zone h4 {
    font-size: 16px;
    margin-bottom: 12px;
    color: var(--primary-teal);
}

.drop-area {
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    color: var(--warm-gray);
    opacity: 0.5;
}

.drop-feedback {
    margin-top: 12px;
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
}

.drop-feedback.correct {
    background: #d1fae5;
    color: #065f46;
}

.drop-feedback.incorrect {
    background: #fee2e2;
    color: #991b1b;
}

/* Quiz Styling */
.quiz-lesson {
    padding: 24px;
}

.quiz-info {
    background: #fff9e6;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 24px;
    font-size: 14px;
    border-left: 3px solid #ffd43b;
}

.quiz-questions {
    margin-bottom: 32px;
}

.quiz-question {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.question-number {
    background: var(--primary-teal);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.question-text {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--warm-gray);
}

.question-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.quiz-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--warm-cream);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quiz-option:hover {
    background: var(--light-gray);
}

.quiz-option input[type="radio"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.question-feedback {
    margin-top: 16px;
    padding: 16px;
    border-radius: 8px;
}

.question-feedback.correct {
    background: #d1fae5;
    border-left: 3px solid var(--success-green);
}

.question-feedback.incorrect {
    background: #fee2e2;
    border-left: 3px solid var(--danger-red);
}

.quiz-results {
    background: white;
    border-radius: 16px;
    padding: 32px;
    text-align: center;
    margin-top: 24px;
}

.quiz-results.passed {
    border: 3px solid var(--success-green);
}

.quiz-results.failed {
    border: 3px solid var(--warning-amber);
}

.results-header h3 {
    font-size: 24px;
    margin-bottom: 8px;
}

.results-score {
    font-size: 48px;
    font-weight: 700;
    color: var(--primary-teal);
    margin: 16px 0;
}

/* Case Study Styling */
.case-study-lesson {
    padding: 24px;
}

.case-study-card {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
}

.case-title {
    font-size: 20px;
    color: var(--primary-teal);
    margin-bottom: 16px;
}

.case-section {
    margin-bottom: 16px;
    padding: 12px;
    background: var(--warm-cream);
    border-radius: 8px;
}

.case-section.challenge {
    background: #fff3cd;
    border-left: 3px solid var(--warning-amber);
}

.case-section.intervention {
    background: #cfe2ff;
    border-left: 3px solid var(--primary-teal);
}

.case-section.outcome {
    background: #d1fae5;
    border-left: 3px solid var(--success-green);
}

.case-lesson {
    background: linear-gradient(135deg, #fff9e6 0%, #fff 100%);
    padding: 16px;
    border-radius: 12px;
    border-left: 3px solid #ffd43b;
    font-size: 15px;
    margin-top: 16px;
}

/* Communication Styles */
.communication-style {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.communication-style h4 {
    color: var(--primary-teal);
    margin-bottom: 16px;
    font-size: 18px;
}

.style-characteristics,
.style-approach,
.style-sample {
    margin-bottom: 16px;
}

.sample-text {
    background: var(--warm-cream);
    padding: 16px;
    border-radius: 8px;
    font-style: italic;
    margin-top: 8px;
    border-left: 3px solid var(--primary-teal);
}

/* Scenarios */
.scenario-card {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.scenario-situation {
    color: var(--primary-teal);
    margin-bottom: 12px;
}

.scenario-reaction {
    background: #fee2e2;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
    border-left: 3px solid var(--secondary-coral);
}

.scenario-response {
    background: #d1fae5;
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid var(--success-green);
}

.scenario-response ol {
    margin-left: 20px;
    margin-top: 8px;
}

/* Module Completion */
.module-completion {
    text-align: center;
    padding: 48px;
}

.completion-animation {
    font-size: 96px;
    margin-bottom: 24px;
    animation: bounce 1s infinite;
}

.module-completion h2 {
    font-size: 36px;
    color: var(--primary-teal);
    margin-bottom: 8px;
}

.module-completion h3 {
    font-size: 24px;
    color: var(--warm-gray);
    margin-bottom: 32px;
}

.completion-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    margin: 32px 0;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
}

.completion-stat {
    background: var(--warm-cream);
    padding: 20px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.stat-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--warm-gray);
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-teal);
}

.certificate-preview {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 32px;
    border-radius: 16px;
    margin: 32px 0;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

.certificate-preview h4 {
    font-size: 20px;
    margin-bottom: 16px;
}

.certificate-preview p {
    font-size: 16px;
    margin: 8px 0;
}

.completion-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 32px;
}

/* All Complete */
.all-complete {
    text-align: center;
    padding: 64px 32px;
}

.all-complete .completion-animation {
    font-size: 120px;
    margin-bottom: 32px;
}

.all-complete h2 {
    font-size: 42px;
    color: var(--primary-teal);
    margin-bottom: 16px;
}

.all-complete h3 {
    font-size: 28px;
    color: var(--warm-gray);
    margin-bottom: 24px;
}

.all-complete p {
    font-size: 18px;
    color: var(--warm-gray);
    max-width: 600px;
    margin: 0 auto 32px;
}

/* Success Notification */
.success-notification {
    position: fixed;
    top: 24px;
    right: 24px;
    background: var(--success-green);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideInRight 0.5s ease;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Fade in animation */
.fade-in {
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive */
@media (max-width: 1024px) {
    .module-viewer-content {
        grid-template-columns: 1fr;
    }
    
    .lesson-sidebar {
        display: none;
    }
    
    .completion-stats {
        grid-template-columns: 1fr;
    }
    
    .level-details {
        grid-template-columns: 1fr;
    }
}

</style>
</head>
<body>
    <!-- Onboarding Screen -->
    <div id="onboardingScreen" class="onboarding-screen">
        <div class="onboarding-card">
            <div class="onboarding-emoji">üéØ</div>
            <h1 class="onboarding-title">Welcome to CareConnect Pro</h1>
            <p class="onboarding-subtitle">Let's create amazing aftercare plans together!</p>
            
            <input type="text" 
                   class="onboarding-input" 
                   id="userName"
                   placeholder="Your name"
                   autofocus>
            
            <input type="text" 
                   class="onboarding-input" 
                   id="userCredentials"
                   placeholder="Your credentials (e.g., LCSW, LPC)">
            
            <div class="role-selector">
                <div class="role-option" data-role="new">
                    <div class="role-icon">üå±</div>
                    <div class="role-label">New Coach</div>
                </div>
                <div class="role-option selected" data-role="experienced">
                    <div class="role-icon">‚≠ê</div>
                    <div class="role-label">Experienced</div>
                </div>
                <div class="role-option" data-role="supervisor">
                    <div class="role-icon">üëë</div>
                    <div class="role-label">Supervisor</div>
                </div>
            </div>
            
            <button class="btn-start" onclick="startApp()">
                Let's Get Started! üöÄ
            </button>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">
        <!-- Left Sidebar -->
        <div class="sidebar-left">
            <div class="user-welcome">
                <div class="welcome-greeting" id="welcomeGreeting">Good morning!</div>
                <div class="welcome-motivation" id="welcomeMotivation">Ready to help families today?</div>
                <div class="welcome-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="statCases">0</div>
                        <div class="stat-label">Cases</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statStreak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statModules">0/5</div>
                        <div class="stat-label">Modules</div>
                    </div>
                </div>
            </div>
            
            <div class="workflow-progress">
                <div class="workflow-title">Your Workflow</div>
                
                <div class="workflow-step active" data-step="learn" onclick="switchView('learn')">
                    <div class="step-icon">üìö</div>
                    <div class="step-content">
                        <div class="step-name">Learn & Grow</div>
                        <div class="step-description">Master your skills</div>
                    </div>
                </div>
                
                <div class="workflow-step" data-step="profile" onclick="switchView('profile')">
                    <div class="step-icon">üë§</div>
                    <div class="step-content">
                        <div class="step-name">Client Profile</div>
                        <div class="step-description">Build client profile</div>
                    </div>
                </div>
                
                <div class="workflow-step" data-step="explore" onclick="switchView('explore')">
                    <div class="step-icon">üîç</div>
                    <div class="step-content">
                        <div class="step-name">Explore Programs</div>
                        <div class="step-description">Find the right fit</div>
                    </div>
                </div>
                
                <div class="workflow-step" data-step="compare" onclick="switchView('compare')">
                    <div class="step-icon">‚öñÔ∏è</div>
                    <div class="step-content">
                        <div class="step-name">Compare Options</div>
                        <div class="step-description">Side-by-side analysis</div>
                    </div>
                </div>
                
                <div class="workflow-step" data-step="document" onclick="switchView('document')">
                    <div class="step-icon">üìù</div>
                    <div class="step-content">
                        <div class="step-name">Create Documents</div>
                        <div class="step-description">Professional plans</div>
                    </div>
                </div>
            </div>
            
            <div class="daily-goals">
                <div class="workflow-title">Today's Goals</div>
                <div class="goal-item">
                    <span class="goal-icon">üìö</span>
                    <span class="goal-text">Complete a module</span>
                    <span class="goal-progress">0/1</span>
                </div>
                <div class="goal-item">
                    <span class="goal-icon">üë®‚Äçüë©‚Äçüëß</span>
                    <span class="goal-text">Help 3 families</span>
                    <span class="goal-progress">0/3</span>
                </div>
                <div class="goal-item">
                    <span class="goal-icon">‚ö°</span>
                    <span class="goal-text">Complete in 30min</span>
                    <span class="goal-progress">--</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div id="learnView">
                <div class="content-header">
                    <h1 class="content-title">Learning Center</h1>
                    <p class="content-subtitle">Build your expertise while helping families</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="overallProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="modules-grid" id="modulesGrid">
                    <!-- Modules will be loaded here -->
                </div>
            </div>
            
            <div id="profileView" class="hidden">
                <!-- Client Profile Builder -->
            </div>
            
            <div id="exploreView" class="hidden">
                <!-- Program Explorer -->
            </div>
            
            <div id="compareView" class="hidden">
                <!-- Comparison Matrix -->
            </div>
            
            <div id="documentView" class="hidden">
                <!-- Document Studio -->
            </div>
        </div>
        
        <!-- Right Sidebar -->
        <div class="sidebar-right">
            <div class="achievement-banner" id="achievementBanner" style="display: none;">
                <div class="achievement-icon">üèÜ</div>
                <div class="achievement-title">Achievement Unlocked!</div>
                <div class="achievement-description">You're amazing!</div>
            </div>
            
            <div class="tips-section">
                <h3 class="tips-title">üí° Pro Tips</h3>
                
                <div class="tip-card">
                    <div class="tip-icon">‚ú®</div>
                    <div class="tip-text" id="currentTip">
                        Start with Module 1 to master the basics of levels of care!
                    </div>
                </div>
            </div>
            
            <div class="leaderboard">
                <div class="leaderboard-title">Team Leaders This Week</div>
                <div class="leaderboard-item">
                    <span class="leaderboard-rank">1</span>
                    <span class="leaderboard-name">Sarah M.</span>
                    <span class="leaderboard-score">12 cases</span>
                </div>
                <div class="leaderboard-item">
                    <span class="leaderboard-rank">2</span>
                    <span class="leaderboard-name">You</span>
                    <span class="leaderboard-score">8 cases</span>
                </div>
                <div class="leaderboard-item">
                    <span class="leaderboard-rank">3</span>
                    <span class="leaderboard-name">Mike R.</span>
                    <span class="leaderboard-score">7 cases</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let currentUser = {
            name: '',
            credentials: '',
            role: 'experienced'
        };
        
        let currentView = 'learn';
        
        // Initialize app
        function startApp() {
            currentUser.name = document.getElementById('userName').value || 'Clinician';
            currentUser.credentials = document.getElementById('userCredentials').value || '';
            currentUser.role = document.querySelector('.role-option.selected')?.dataset.role || 'experienced';
            
            // Hide onboarding, show main app
            document.getElementById('onboardingScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Initialize components
            initializeWelcome();
            loadModules();
            initializeWorkflow();
        }
        
        function initializeWelcome() {
            const hour = new Date().getHours();
            let greeting = '';
            
            if (hour < 12) {
                greeting = `Good morning, ${currentUser.name}! ‚òÄÔ∏è`;
            } else if (hour < 17) {
                greeting = `Good afternoon, ${currentUser.name}! üå§Ô∏è`;
            } else {
                greeting = `Good evening, ${currentUser.name}! üåô`;
            }
            
            document.getElementById('welcomeGreeting').textContent = greeting;
            
            // Set motivation based on role
            const motivations = {
                'new': 'Let\'s learn and help families together!',
                'experienced': 'Ready to make a difference today?',
                'supervisor': 'Leading by example - let\'s go!'
            };
            
            document.getElementById('welcomeMotivation').textContent = motivations[currentUser.role];
        }
        
        function loadModules() {
            const modulesGrid = document.getElementById('modulesGrid');
            
            const modules = [
                {
                    id: 'levels-of-care',
                    icon: 'üè•',
                    title: 'Understanding Levels of Care',
                    duration: '30 min',
                    description: 'Learn when to recommend each level of treatment',
                    progress: 0,
                    badge: 'ESSENTIAL'
                },
                {
                    id: 'reading-profiles',
                    icon: 'üìã',
                    title: 'Reading Program Profiles',
                    duration: '25 min',
                    description: 'Master the art of analyzing treatment programs',
                    progress: 0,
                    badge: null
                },
                {
                    id: 'family-communication',
                    icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                    title: 'Family Communication',
                    duration: '35 min',
                    description: 'Build confidence in family conversations',
                    progress: 0,
                    badge: null
                },
                {
                    id: 'documentation',
                    icon: 'üìù',
                    title: 'Documentation Mastery',
                    duration: '20 min',
                    description: 'Write professional clinical documents efficiently',
                    progress: 0,
                    badge: null
                },
                {
                    id: 'advanced-matching',
                    icon: 'üéØ',
                    title: 'Advanced Matching',
                    duration: '40 min',
                    description: 'Handle complex cases with confidence',
                    progress: 0,
                    badge: 'ADVANCED'
                }
            ];
            
            modulesGrid.innerHTML = '';
            modules.forEach(module => {
                const card = createModuleCard(module);
                modulesGrid.appendChild(card);
            });
        }
        
        function createModuleCard(module) {
            const card = document.createElement('div');
            card.className = 'module-card';
            card.onclick = () => startModule(module.id);
            
            // Load progress from localStorage
            const savedProgress = localStorage.getItem(`module_progress_${module.id}`);
            let progress = 0;
            let badge = module.badge;
            
            if (savedProgress) {
                const data = JSON.parse(savedProgress);
                progress = data.progress || 0;
                if (data.completed) {
                    badge = 'COMPLETED ‚úì';
                }
            }
            
            card.innerHTML = `
                <div class="module-header">
                    <div>
                        <div class="module-icon">${module.icon}</div>
                        <h3 class="module-title">${module.title}</h3>
                        <div class="module-duration">${module.duration}</div>
                    </div>
                    ${badge ? `<div class="module-badge">${badge}</div>` : ''}
                </div>
                <p class="module-description">${module.description}</p>
                <div class="module-progress">
                    <div class="module-progress-bar">
                        <div class="module-progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="module-progress-text">${progress}% Complete</div>
                </div>
            `;
            
            return card;
        }
        
        function startModule(moduleId) {
            console.log('Starting module:', moduleId);
            
            // Initialize module viewer if not exists
            if (!window.moduleViewer) {
                window.moduleViewer = new ModuleViewer();
            }
            
            // Open the module
            window.moduleViewer.openModule(moduleId);
        }
        
        function initializeWorkflow() {
            // Initialize workflow steps
            updateWorkflowProgress();
        }
        
        function updateWorkflowProgress() {
            // Update visual progress indicators
        }
        
        function switchView(view) {
            // Hide all views
            document.querySelectorAll('.main-content > div').forEach(v => v.classList.add('hidden'));
            
            // Show selected view
            const viewElement = document.getElementById(`${view}View`);
            if (viewElement) {
                viewElement.classList.remove('hidden');
            }
            
            // Update workflow steps
            document.querySelectorAll('.workflow-step').forEach(step => {
                step.classList.remove('active');
                if (step.dataset.step === view) {
                    step.classList.add('active');
                }
            });
            
            currentView = view;
        }
        
        // Role selector
        document.querySelectorAll('.role-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.role-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
            });
        });
        
        // Achievement display
        function showAchievement(achievement) {
            const banner = document.getElementById('achievementBanner');
            banner.querySelector('.achievement-icon').textContent = achievement.icon;
            banner.querySelector('.achievement-title').textContent = achievement.title;
            banner.querySelector('.achievement-description').textContent = achievement.message;
            
            banner.style.display = 'block';
            
            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }
        
        // Update tip
        function updateTip(tip) {
            document.getElementById('currentTip').textContent = tip;
        }
    </script>

<script>

// ============= CARECONNECT INTERACTIVE SUITE =============
// Built: 2025-10-15T02:30:45.697Z
// Version: 1.0.0
// HIPAA Compliant - No PHI Stored

(function() {
    'use strict';
    
    console.log('[CareConnect] Interactive Suite v1.0.0 Loading...');
    
    // ============= PROGRAMS DATABASE =============
    // programs-data.js - Treatment programs database
// This data is loaded from your existing programs or can be populated via Chrome Extension

window.programsData = [
    {
        id: 'program_1',
        name: 'Charlie Health Virtual IOP Program',
        location: { city: 'Virtual', state: '', distance: null },
        type: 'Virtual Program',
        category: 'virtual',
        clinical: {
            levelsOfCare: ['IOP'],
            primaryFocus: 'Mental Health',
            specializations: ['Anxiety', 'Depression', 'Mental Health'],
            modalities: {
                evidenceBased: ['Group Therapy', 'Individual Therapy', 'Family Therapy'],
                experiential: [],
                holistic: []
            }
        },
        population: {
            ages: '13-25',
            gender: 'Co-ed',
            specialPopulations: []
        },
        structure: {
            lengthOfStay: '6-10 weeks',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: ['Most Major Insurers'],
            privatePay: true,
            requirements: []
        },
        contact: {
            phone: '561.203.5396',
            email: '',
            contactPerson: 'Gabriella H.'
        },
        website: 'https://www.charliehealth.com',
        quality: {
            accreditations: [],
            memberships: []
        }
    },
    {
        id: 'program_2',
        name: 'The Last House',
        location: { city: 'Los Angeles', state: 'CA', distance: null },
        type: 'Sober Living',
        category: 'sober-living',
        clinical: {
            levelsOfCare: ['Sober Living'],
            primaryFocus: 'Substance Use Disorders',
            specializations: ['Substance Use', 'Recovery Support'],
            modalities: {
                evidenceBased: ['12-Step'],
                experiential: ['Community Activities'],
                holistic: []
            }
        },
        population: {
            ages: '18+',
            gender: 'Males Only',
            specialPopulations: ['Young Adults']
        },
        structure: {
            lengthOfStay: 'Flexible',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: [],
            privatePay: true,
            requirements: []
        },
        contact: {
            phone: '866.677.0090',
            email: '',
            address: '3101 Ocean Park Blvd #302, Santa Monica, CA 90405'
        },
        website: 'https://thelasthouse.net',
        quality: {
            accreditations: [],
            memberships: []
        }
    },
    {
        id: 'program_3',
        name: 'Patton Sober Living Homes',
        location: { city: 'Dallas', state: 'TX', distance: null },
        type: 'Sober Living',
        category: 'sober-living',
        clinical: {
            levelsOfCare: ['Sober Living'],
            primaryFocus: 'Substance Use Disorders',
            specializations: ['Substance Use', 'Life Skills'],
            modalities: {
                evidenceBased: ['12-Step', 'Employment Coaching'],
                experiential: ['Life Skills Training'],
                holistic: []
            }
        },
        population: {
            ages: '18-25',
            gender: 'Males Only',
            specialPopulations: ['Young Adults']
        },
        structure: {
            lengthOfStay: 'Flexible',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: [],
            privatePay: true,
            requirements: ['Employment or Education (25+ hrs/week)']
        },
        contact: {
            phone: '(469) 974-4639',
            email: '',
            contactPerson: 'Austin Shook, Program Director',
            address: '13028 Fall Manor Dr, Dallas, TX 75243'
        },
        website: 'https://pattonsoberliving.com/index.html',
        quality: {
            accreditations: [],
            memberships: []
        }
    },
    {
        id: 'program_4',
        name: 'Stonewater Adolescent Recovery Center',
        location: { city: 'Oxford', state: 'MS', distance: null },
        type: 'Residential Treatment',
        category: 'residential',
        clinical: {
            levelsOfCare: ['Residential', 'Detox'],
            primaryFocus: 'Dual Diagnosis',
            specializations: ['Substance Use', 'Mental Health', 'Dual Diagnosis'],
            modalities: {
                evidenceBased: ['Psychiatric Care', 'Individual Therapy', 'Family Therapy'],
                experiential: [],
                holistic: ['Faith-Based']
            }
        },
        population: {
            ages: 'Adolescents',
            gender: 'Males Only',
            specialPopulations: []
        },
        structure: {
            lengthOfStay: 'Variable',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: ['Most Major Insurers'],
            privatePay: true,
            requirements: []
        },
        contact: {
            phone: '(570) 222-3449',
            email: 'info@serenitylodgerecovery.com',
            contactPerson: 'Bridget Norris',
            address: '21 Weida Ct Nicholson, PA 18446'
        },
        website: 'https://stonewaterrecovery.com',
        quality: {
            accreditations: [],
            memberships: []
        }
    },
    {
        id: 'program_5',
        name: 'Resilience Recovery Residences',
        location: { city: 'West Palm Beach', state: 'FL', distance: null },
        type: 'Sober Living',
        category: 'sober-living',
        clinical: {
            levelsOfCare: ['Sober Living', 'IOP'],
            primaryFocus: 'Substance Use Disorders',
            specializations: ['Substance Use', 'Recovery Support'],
            modalities: {
                evidenceBased: ['12-Step', 'IOP', 'Therapy'],
                experiential: [],
                holistic: []
            }
        },
        population: {
            ages: '16+',
            gender: 'Males Only',
            specialPopulations: ['Young Adults']
        },
        structure: {
            lengthOfStay: 'Phased (60-120+ days)',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: [],
            privatePay: true,
            requirements: ['Completed Primary Treatment']
        },
        contact: {
            phone: '424-254-4304',
            email: '',
            contactPerson: 'Christopher Martinez, Owner',
            address: '3011 Poinsettia Ave, West Palm Beach, FL 33407'
        },
        website: 'www.resiliencerecoveryresources.com',
        quality: {
            accreditations: [],
            memberships: []
        }
    },
    {
        id: 'program_6',
        name: 'The Insight Program',
        location: { city: 'Tampa', state: 'FL', distance: null },
        type: 'IOP',
        category: 'outpatient',
        clinical: {
            levelsOfCare: ['IOP'],
            primaryFocus: 'Substance Use Disorders',
            specializations: ['Substance Use', 'Co-Occurring Disorders'],
            modalities: {
                evidenceBased: ['Individual Therapy', 'Family Therapy', '12-Step'],
                experiential: [],
                holistic: []
            }
        },
        population: {
            ages: '13-25',
            gender: 'Co-ed',
            specialPopulations: ['Adolescents', 'Young Adults']
        },
        structure: {
            lengthOfStay: 'Variable',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: ['Most Major Insurers'],
            privatePay: true,
            requirements: []
        },
        contact: {
            phone: '470-505-9786',
            email: '',
            contactPerson: 'Adam Schwartz',
            address: '13944 Lynmar Blvd, Tampa, FL 33626'
        },
        website: 'https://theinsightprogram.com/',
        quality: {
            accreditations: [],
            memberships: []
        }
    },
    {
        id: 'program_7',
        name: 'Turnbridge Residential',
        location: { city: 'New Haven', state: 'CT', distance: null },
        type: 'Residential Treatment',
        category: 'residential',
        clinical: {
            levelsOfCare: ['Residential', 'Sober Living'],
            primaryFocus: 'Dual Diagnosis',
            specializations: ['Substance Use', 'Mental Health', 'Life Skills'],
            modalities: {
                evidenceBased: ['Therapy', 'Medication Management'],
                experiential: ['Recreation', 'Wellness Activities'],
                holistic: []
            }
        },
        population: {
            ages: 'Young Adults',
            gender: 'Co-ed',
            specialPopulations: []
        },
        structure: {
            lengthOfStay: 'Long-term (Phased)',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: ['Most Major Insurers'],
            privatePay: true,
            requirements: []
        },
        contact: {
            phone: '512.921.3533',
            email: 'blegacki@turnbridge.com',
            contactPerson: 'Beth Legacki',
            address: '189 Orange Street, New Haven, CT 06510'
        },
        website: 'www.turnbridge.com',
        quality: {
            accreditations: [],
            memberships: []
        }
    },
    {
        id: 'program_8',
        name: 'Greater Nashua Mental Health',
        location: { city: 'Nashua', state: 'NH', distance: null },
        type: 'IOP',
        category: 'outpatient',
        clinical: {
            levelsOfCare: ['IOP'],
            primaryFocus: 'Dual Diagnosis',
            specializations: ['Substance Use', 'Mental Health'],
            modalities: {
                evidenceBased: ['Group Therapy', 'Individual Therapy', 'Family Therapy', 'Psychiatric Services'],
                experiential: [],
                holistic: []
            }
        },
        population: {
            ages: 'Adolescents',
            gender: 'Co-ed',
            specialPopulations: []
        },
        structure: {
            lengthOfStay: 'Variable',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: ['Most Commercial Plans'],
            privatePay: true,
            requirements: []
        },
        contact: {
            phone: '603.401.1597',
            email: '',
            address: '15 Prospect Street, Nashua, NH 03060'
        },
        website: 'https://gnmhc.org/',
        quality: {
            accreditations: [],
            memberships: []
        }
    },
    {
        id: 'program_9',
        name: 'Directions Behavioral Health',
        location: { city: 'Nashua', state: 'NH', distance: null },
        type: 'PHP/IOP',
        category: 'outpatient',
        clinical: {
            levelsOfCare: ['PHP', 'IOP'],
            primaryFocus: 'Mental Health',
            specializations: ['Mental Health', 'Substance Use'],
            modalities: {
                evidenceBased: ['Group Therapy', 'Psychiatric Services'],
                experiential: [],
                holistic: []
            }
        },
        population: {
            ages: 'Adolescents & Young Adults',
            gender: 'Co-ed',
            specialPopulations: []
        },
        structure: {
            lengthOfStay: 'Variable',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: ['Most Commercial Plans'],
            privatePay: true,
            requirements: []
        },
        contact: {
            phone: '603.880.8188',
            email: '',
            address: '25 Technology Way, Nashua, NH 03060'
        },
        website: 'https://www.directionbehavioralhealth.com/',
        quality: {
            accreditations: [],
            memberships: []
        }
    },
    {
        id: 'program_10',
        name: 'In Balance Academy',
        location: { city: 'Tucson', state: 'AZ', distance: null },
        type: 'Therapeutic Boarding School',
        category: 'therapeutic-school',
        clinical: {
            levelsOfCare: ['Residential'],
            primaryFocus: 'Therapeutic Education',
            specializations: ['Character Development', 'Academic Support'],
            modalities: {
                evidenceBased: ['Family Therapy', 'Individual Therapy'],
                experiential: ['Service Learning', 'Mentorship'],
                holistic: ['Values-Based']
            }
        },
        population: {
            ages: 'Adolescents',
            gender: 'Males Only',
            specialPopulations: []
        },
        structure: {
            lengthOfStay: '12-18 months',
            capacity: '',
            staffRatio: '',
            groupSize: ''
        },
        admissions: {
            insurance: ['Most Major Insurers'],
            privatePay: true,
            requirements: []
        },
        contact: {
            phone: '801.369.0238',
            email: 'ptaylor@livestronghouse.com',
            contactPerson: 'Tiffany, Director of Admissions',
            address: '195 25th Street, Suite 300, Ogden, UT 84401'
        },
        website: 'www.inbalanceacademy.com',
        quality: {
            accreditations: [],
            memberships: []
        }
    }
];

// Save to localStorage for persistence
try {
    localStorage.setItem('careconnect_programs', JSON.stringify(window.programsData));
    console.log(`[Programs] Loaded ${window.programsData.length} programs into storage`);
} catch (e) {
    console.warn('[Programs] Could not save to localStorage:', e);
}

    
    // ============= SESSION MANAGER =============
    // session-manager.js - HIPAA-compliant session management for clinical workflow
// No PHI is persisted - all data clears when session ends

class SessionManager {
    constructor() {
        this.currentSession = null;
        this.sessionTimer = null;
        this.WARNING_TIME = 25 * 60 * 1000; // 25 minutes
        this.TIMEOUT_TIME = 30 * 60 * 1000; // 30 minutes
        this.initializeSession();
    }
    
    initializeSession() {
        // Check for existing session
        const existingSession = sessionStorage.getItem('clinical_session');
        if (existingSession) {
            this.currentSession = JSON.parse(existingSession);
            this.resumeSession();
        }
    }
    
    createNewSession(clinicianName = '') {
        const sessionId = this.generateSessionId();
        
        this.currentSession = {
            sessionId: sessionId,
            date: new Date().toISOString(),
            clinician: clinicianName,
            startTime: Date.now(),
            criteria: {
                age: '',
                ageGroup: '',
                primaryConcern: '',
                secondaryConcerns: [],
                levelOfCare: '',
                insurance: '',
                geographic: '',
                specialNeeds: []
            },
            programsViewed: [],
            programsCompared: [],
            programsSelected: [],
            documents: [],
            notes: '',
            lastActivity: Date.now()
        };
        
        this.saveSession();
        this.startSessionTimer();
        this.displaySessionHeader();
        
        return this.currentSession;
    }
    
    generateSessionId() {
        // Generate HIPAA-compliant ID (no PHI)
        const prefix = 'CC';
        const year = new Date().getFullYear();
        const randomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
        const timestamp = Date.now().toString(36).substring(-4).toUpperCase();
        
        return `${prefix}-${year}-${randomCode}${timestamp}`;
    }
    
    updateCriteria(criteria) {
        if (!this.currentSession) return;
        
        this.currentSession.criteria = {
            ...this.currentSession.criteria,
            ...criteria
        };
        
        this.currentSession.lastActivity = Date.now();
        this.saveSession();
    }
    
    addProgramViewed(programId) {
        if (!this.currentSession) return;
        
        if (!this.currentSession.programsViewed.includes(programId)) {
            this.currentSession.programsViewed.push(programId);
            this.currentSession.lastActivity = Date.now();
            this.saveSession();
        }
    }
    
    addProgramToCompare(programId) {
        if (!this.currentSession) return;
        
        if (!this.currentSession.programsCompared.includes(programId)) {
            this.currentSession.programsCompared.push(programId);
            this.currentSession.lastActivity = Date.now();
            this.saveSession();
        }
    }
    
    selectProgram(programId) {
        if (!this.currentSession) return;
        
        if (!this.currentSession.programsSelected.includes(programId)) {
            this.currentSession.programsSelected.push(programId);
            this.currentSession.lastActivity = Date.now();
            this.saveSession();
        }
    }
    
    addDocument(documentInfo) {
        if (!this.currentSession) return;
        
        this.currentSession.documents.push({
            type: documentInfo.type,
            timestamp: Date.now(),
            programs: documentInfo.programs || []
        });
        
        this.currentSession.lastActivity = Date.now();
        this.saveSession();
    }
    
    saveSession() {
        if (this.currentSession) {
            // Only save to sessionStorage (clears when browser closes)
            sessionStorage.setItem('clinical_session', JSON.stringify(this.currentSession));
        }
    }
    
    startSessionTimer() {
        // Clear any existing timer
        this.clearSessionTimer();
        
        // Warning at 25 minutes
        setTimeout(() => {
            this.showSessionWarning();
        }, this.WARNING_TIME);
        
        // Auto-end session at 30 minutes
        this.sessionTimer = setTimeout(() => {
            this.endSession(true);
        }, this.TIMEOUT_TIME);
    }
    
    clearSessionTimer() {
        if (this.sessionTimer) {
            clearTimeout(this.sessionTimer);
            this.sessionTimer = null;
        }
    }
    
    showSessionWarning() {
        const modal = document.createElement('div');
        modal.className = 'session-warning-modal';
        modal.innerHTML = `
            <div class="session-warning-content">
                <h3>‚ö†Ô∏è Session Timeout Warning</h3>
                <p>Your session will expire in 5 minutes.</p>
                <p>Please save any documents you need before the session ends.</p>
                <div class="session-warning-actions">
                    <button onclick="sessionManager.extendSession()" class="btn btn-primary">
                        Extend Session (30 min)
                    </button>
                    <button onclick="sessionManager.endSession()" class="btn btn-secondary">
                        End Session Now
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Auto-remove warning after 30 seconds
        setTimeout(() => {
            modal.remove();
        }, 30000);
    }
    
    extendSession() {
        this.currentSession.lastActivity = Date.now();
        this.saveSession();
        this.startSessionTimer();
        
        // Remove warning modal if present
        const modal = document.querySelector('.session-warning-modal');
        if (modal) modal.remove();
        
        this.showNotification('Session extended for 30 minutes', 'success');
    }
    
    resumeSession() {
        // Check if session is still valid (less than 30 min old)
        const sessionAge = Date.now() - this.currentSession.lastActivity;
        
        if (sessionAge > this.TIMEOUT_TIME) {
            this.endSession(true);
            return false;
        }
        
        // Resume timer with remaining time
        const remainingTime = this.TIMEOUT_TIME - sessionAge;
        this.sessionTimer = setTimeout(() => {
            this.endSession(true);
        }, remainingTime);
        
        this.displaySessionHeader();
        return true;
    }
    
    endSession(timeout = false) {
        if (this.currentSession) {
            // Generate session summary
            const summary = this.generateSessionSummary();
            
            if (!timeout && summary.hasUnsavedWork) {
                if (!confirm('You have unsaved work. Are you sure you want to end this session?')) {
                    return;
                }
            }
            
            // Clear all session data
            sessionStorage.removeItem('clinical_session');
            this.currentSession = null;
            this.clearSessionTimer();
            
            // Clear any temporary UI elements
            this.clearSessionUI();
            
            // Show completion message
            if (timeout) {
                this.showNotification('Session expired. All temporary data has been cleared.', 'warning');
            } else {
                this.showNotification('Session ended. All temporary data has been cleared.', 'info');
            }
            
            // Redirect to start page
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    }
    
    generateSessionSummary() {
        if (!this.currentSession) return null;
        
        const duration = Date.now() - this.currentSession.startTime;
        const minutes = Math.floor(duration / 60000);
        
        return {
            sessionId: this.currentSession.sessionId,
            duration: `${minutes} minutes`,
            programsViewed: this.currentSession.programsViewed.length,
            programsCompared: this.currentSession.programsCompared.length,
            programsSelected: this.currentSession.programsSelected.length,
            documentsGenerated: this.currentSession.documents.length,
            hasUnsavedWork: this.currentSession.documents.length > 0 && 
                           this.currentSession.documents.some(d => !d.exported)
        };
    }
    
    displaySessionHeader() {
        if (!this.currentSession) return;
        
        const header = document.getElementById('session-header');
        if (header) {
            const elapsed = Math.floor((Date.now() - this.currentSession.startTime) / 60000);
            
            header.innerHTML = `
                <div class="session-info">
                    <span class="session-id">Session: ${this.currentSession.sessionId}</span>
                    <span class="session-clinician">${this.currentSession.clinician || 'Clinician'}</span>
                    <span class="session-timer">${elapsed} min</span>
                    <button class="btn-end-session" onclick="sessionManager.endSession()">
                        End Session
                    </button>
                </div>
                <div class="session-warning">
                    ‚ö†Ô∏è Session data is temporary and will be cleared when you close this tab
                </div>
            `;
        }
    }
    
    clearSessionUI() {
        // Clear all temporary UI elements
        const sessionElements = document.querySelectorAll('[data-session-temp]');
        sessionElements.forEach(el => {
            el.value = '';
            el.textContent = '';
        });
        
        // Clear comparison selections
        const compareCheckboxes = document.querySelectorAll('.compare-checkbox');
        compareCheckboxes.forEach(cb => cb.checked = false);
        
        // Hide session-dependent sections
        const sessionSections = document.querySelectorAll('.session-only');
        sessionSections.forEach(section => section.style.display = 'none');
    }
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    exportSessionData() {
        if (!this.currentSession) return null;
        
        // Create a safe export without any PHI
        const exportData = {
            sessionId: this.currentSession.sessionId,
            date: this.currentSession.date,
            programsReviewed: this.currentSession.programsViewed,
            programsCompared: this.currentSession.programsCompared,
            selectedPrograms: this.currentSession.programsSelected,
            criteria: {
                levelOfCare: this.currentSession.criteria.levelOfCare,
                ageGroup: this.currentSession.criteria.ageGroup,
                primaryConcern: this.currentSession.criteria.primaryConcern
            }
        };
        
        return exportData;
    }
}

// Initialize session manager globally
window.sessionManager = new SessionManager();

    
    // ============= LEARNING MODULES =============
    // learning-modules.js - Interactive Learning Modules for CareConnect Pro

class LearningModules {
    constructor() {
        this.modules = {
            'levels-of-care': {
                id: 'levels-of-care',
                title: 'Understanding Levels of Care',
                duration: '30 min',
                description: 'Learn when to recommend each level of treatment',
                icon: 'üè•',
                lessons: [
                    {
                        id: 'intro',
                        title: 'Introduction to Levels of Care',
                        type: 'interactive',
                        content: this.getLevelsIntroContent()
                    },
                    {
                        id: 'matching',
                        title: 'Matching Patients to Levels',
                        type: 'exercise',
                        content: this.getLevelsMatchingExercise()
                    },
                    {
                        id: 'case-studies',
                        title: 'Real Case Studies',
                        type: 'cases',
                        content: this.getLevelsCaseStudies()
                    },
                    {
                        id: 'quiz',
                        title: 'Knowledge Check',
                        type: 'quiz',
                        content: this.getLevelsQuiz()
                    }
                ],
                progress: 0,
                completed: false,
                certificate: null
            },
            'reading-profiles': {
                id: 'reading-profiles',
                title: 'Reading Program Profiles',
                duration: '25 min',
                description: 'Master the art of analyzing treatment programs',
                icon: 'üìã',
                lessons: [
                    {
                        id: 'anatomy',
                        title: 'Anatomy of a Program',
                        type: 'interactive',
                        content: this.getProfileAnatomyContent()
                    },
                    {
                        id: 'red-flags',
                        title: 'Red Flags vs Green Flags',
                        type: 'exercise',
                        content: this.getRedFlagsExercise()
                    },
                    {
                        id: 'insurance',
                        title: 'Insurance Decoder',
                        type: 'reference',
                        content: this.getInsuranceDecoderContent()
                    },
                    {
                        id: 'assessment',
                        title: 'Profile Assessment',
                        type: 'quiz',
                        content: this.getProfileQuiz()
                    }
                ],
                progress: 0,
                completed: false,
                certificate: null
            },
            'family-communication': {
                id: 'family-communication',
                title: 'Family Communication',
                duration: '35 min',
                description: 'Build confidence in family conversations',
                icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                lessons: [
                    {
                        id: 'styles',
                        title: 'Communication Styles',
                        type: 'roleplay',
                        content: this.getCommunicationStylesContent()
                    },
                    {
                        id: 'difficult',
                        title: 'Difficult Conversations',
                        type: 'scenarios',
                        content: this.getDifficultConversationsContent()
                    },
                    {
                        id: 'cultural',
                        title: 'Cultural Sensitivity',
                        type: 'interactive',
                        content: this.getCulturalSensitivityContent()
                    },
                    {
                        id: 'practice',
                        title: 'Practice Lab',
                        type: 'exercise',
                        content: this.getFamilyPracticeLab()
                    }
                ],
                progress: 0,
                completed: false,
                certificate: null
            },
            'documentation': {
                id: 'documentation',
                title: 'Documentation Mastery',
                duration: '20 min',
                description: 'Write professional clinical documents efficiently',
                icon: 'üìù',
                lessons: [
                    {
                        id: 'writing',
                        title: 'Clinical Writing Lab',
                        type: 'exercise',
                        content: this.getClinicalWritingLab()
                    },
                    {
                        id: 'templates',
                        title: 'Template Workshop',
                        type: 'interactive',
                        content: this.getTemplateWorkshop()
                    },
                    {
                        id: 'speed',
                        title: 'Speed Documentation',
                        type: 'timed',
                        content: this.getSpeedDocumentation()
                    }
                ],
                progress: 0,
                completed: false,
                certificate: null
            },
            'advanced-matching': {
                id: 'advanced-matching',
                title: 'Advanced Matching',
                duration: '40 min',
                description: 'Handle complex cases with confidence',
                icon: 'üéØ',
                lessons: [
                    {
                        id: 'complex',
                        title: 'Complex Cases',
                        type: 'cases',
                        content: this.getComplexCasesContent()
                    },
                    {
                        id: 'financial',
                        title: 'Financial Planning',
                        type: 'calculator',
                        content: this.getFinancialPlanningContent()
                    },
                    {
                        id: 'relationships',
                        title: 'Building Relationships',
                        type: 'guide',
                        content: this.getRelationshipBuildingContent()
                    }
                ],
                progress: 0,
                completed: false,
                certificate: null
            }
        };
        
        this.currentModule = null;
        this.currentLesson = null;
        this.userProgress = this.loadProgress();
    }
    
    // Module 1: Levels of Care Content
    getLevelsIntroContent() {
        return {
            title: 'Understanding the Continuum of Care',
            sections: [
                {
                    type: 'visual-hierarchy',
                    title: 'Treatment Intensity Ladder',
                    levels: [
                        {
                            name: 'Medical Detox',
                            intensity: 100,
                            description: '24/7 medical supervision for withdrawal',
                            whenToUse: 'Active substance use with physical dependence',
                            duration: '3-7 days',
                            cost: '$$
</html>

                        },
                        {
                            name: 'Residential Treatment',
                            intensity: 90,
                            description: '24/7 therapeutic environment',
                            whenToUse: 'Severe symptoms, unsafe home environment',
                            duration: '30-90 days',
                            cost: '$$'
                        },
                        {
                            name: 'Partial Hospitalization (PHP)',
                            intensity: 70,
                            description: '6+ hours/day, 5 days/week',
                            whenToUse: 'High needs but stable living situation',
                            duration: '2-4 weeks',
                            cost: '$
</html>

                        },
                        {
                            name: 'Intensive Outpatient (IOP)',
                            intensity: 50,
                            description: '3+ hours/day, 3-5 days/week',
                            whenToUse: 'Moderate symptoms, can maintain daily life',
                            duration: '6-12 weeks',
                            cost: '$'
                        },
                        {
                            name: 'Outpatient',
                            intensity: 20,
                            description: 'Weekly individual/group therapy',
                            whenToUse: 'Mild symptoms, strong support system',
                            duration: 'Ongoing',
                            cost: '
</html>

                        }
                    ]
                },
                {
                    type: 'interactive-decision-tree',
                    title: 'Which Level of Care?',
                    startQuestion: 'Is the patient currently using substances?',
                    tree: {
                        yes: {
                            question: 'Risk of dangerous withdrawal?',
                            yes: { recommendation: 'Medical Detox ‚Üí Residential' },
                            no: {
                                question: 'Safe living environment?',
                                yes: { recommendation: 'IOP or PHP' },
                                no: { recommendation: 'Residential Treatment' }
                            }
                        },
                        no: {
                            question: 'Previous treatment attempts?',
                            yes: {
                                question: 'Successful with outpatient?',
                                yes: { recommendation: 'Continue Outpatient' },
                                no: { recommendation: 'Consider higher level (PHP/Residential)' }
                            },
                            no: { recommendation: 'Start with IOP, assess progress' }
                        }
                    }
                }
            ],
            interactiveElements: [
                {
                    type: 'hover-definitions',
                    terms: {
                        'PHP': 'Partial Hospitalization Program - Day treatment with evening return home',
                        'IOP': 'Intensive Outpatient Program - Several hours multiple days per week',
                        'MAT': 'Medication-Assisted Treatment - Medications to support recovery',
                        'ASAM': 'American Society of Addiction Medicine - Sets criteria for levels'
                    }
                }
            ]
        };
    }
    
    getLevelsMatchingExercise() {
        return {
            title: 'Match Patients to Appropriate Levels',
            instructions: 'Drag each patient scenario to the most appropriate level of care',
            scenarios: [
                {
                    id: 'patient1',
                    name: 'Sarah, 16',
                    description: 'First suicide attempt, stable home, parents engaged',
                    correctLevel: 'IOP',
                    feedback: 'Good choice! IOP provides intensive support while maintaining school.'
                },
                {
                    id: 'patient2',
                    name: 'Mike, 17',
                    description: 'Daily marijuana use, expelled from school, parent conflict',
                    correctLevel: 'Residential',
                    feedback: 'Correct! Residential provides structure and removes from negative environment.'
                },
                {
                    id: 'patient3',
                    name: 'Emma, 15',
                    description: 'Anxiety, self-harm thoughts, supportive family',
                    correctLevel: 'PHP',
                    feedback: 'Excellent! PHP gives daily support with evening family time.'
                },
                {
                    id: 'patient4',
                    name: 'James, 18',
                    description: 'Heroin use, homeless, multiple overdoses',
                    correctLevel: 'Detox',
                    feedback: 'Critical choice! Medical detox is essential for safety, then residential.'
                }
            ],
            levels: ['Detox', 'Residential', 'PHP', 'IOP', 'Outpatient']
        };
    }
    
    getLevelsCaseStudies() {
        return {
            title: 'Real-World Case Studies',
            cases: [
                {
                    title: 'The Resistant Teen',
                    patient: 'Alex, 15, mandated by court after DUI',
                    initialPlan: 'Parents wanted outpatient only',
                    challenge: 'Continued use, lying about attendance',
                    intervention: 'Escalated to IOP with random drug testing',
                    outcome: '6 months sober, returned to school',
                    lesson: 'Sometimes starting lower and escalating is necessary for buy-in'
                },
                {
                    title: 'The High Achiever',
                    patient: 'Jordan, 17, straight-A student with hidden addiction',
                    initialPlan: 'Residential recommended',
                    challenge: 'Family worried about college applications',
                    intervention: 'PHP with academic support, then IOP',
                    outcome: 'Maintained grades, got into first-choice college',
                    lesson: 'Balance treatment needs with life goals'
                },
                {
                    title: 'The Repeat Visitor',
                    patient: 'Casey, 16, third treatment attempt',
                    initialPlan: 'Same residential program',
                    challenge: 'Previous programs didn\'t address trauma',
                    intervention: 'Trauma-focused residential with longer stay',
                    outcome: '18 months sober, first successful completion',
                    lesson: 'Address underlying issues, not just symptoms'
                }
            ]
        };
    }
    
    getLevelsQuiz() {
        return {
            title: 'Levels of Care Knowledge Check',
            passingScore: 80,
            questions: [
                {
                    question: 'Which level provides 24/7 medical supervision?',
                    options: ['IOP', 'PHP', 'Medical Detox', 'Outpatient'],
                    correct: 2,
                    explanation: 'Medical detox provides round-the-clock medical monitoring for safe withdrawal.'
                },
                {
                    question: 'PHP typically involves how many hours per day?',
                    options: ['1-2 hours', '3-4 hours', '6+ hours', '24 hours'],
                    correct: 2,
                    explanation: 'PHP (Partial Hospitalization) is 6+ hours daily, 5 days a week.'
                },
                {
                    question: 'Best level for stable home but high clinical needs?',
                    options: ['Residential', 'PHP', 'Outpatient', 'Sober Living'],
                    correct: 1,
                    explanation: 'PHP provides intensive daily treatment while allowing evening family time.'
                },
                {
                    question: 'When should you consider residential treatment?',
                    options: [
                        'Mild anxiety only',
                        'Unsafe home environment',
                        'Working full-time',
                        'First therapy attempt'
                    ],
                    correct: 1,
                    explanation: 'Residential is crucial when the home environment undermines recovery.'
                },
                {
                    question: 'IOP is typically how many days per week?',
                    options: ['1 day', '2 days', '3-5 days', '7 days'],
                    correct: 2,
                    explanation: 'IOP runs 3-5 days per week, usually 3-4 hours per session.'
                },
                {
                    question: 'Which factor most influences level of care?',
                    options: ['Age', 'Insurance', 'Safety', 'Preference'],
                    correct: 2,
                    explanation: 'Safety is paramount - both physical safety and risk of harm.'
                },
                {
                    question: 'Appropriate step-down from residential?',
                    options: ['Discharge', 'PHP or IOP', 'Inpatient', 'Nothing'],
                    correct: 1,
                    explanation: 'PHP or IOP provides continued support while transitioning home.'
                },
                {
                    question: 'Red flag requiring immediate higher care?',
                    options: [
                        'Missing one session',
                        'Active suicidal ideation',
                        'Family conflict',
                        'School stress'
                    ],
                    correct: 1,
                    explanation: 'Active suicidal ideation requires immediate intensive intervention.'
                },
                {
                    question: 'Best for maintaining school/work?',
                    options: ['Residential', 'PHP', 'IOP', 'Detox'],
                    correct: 2,
                    explanation: 'IOP\'s evening schedule allows for daytime responsibilities.'
                },
                {
                    question: 'Insurance typically covers residential for?',
                    options: ['7 days', '14-30 days', '6 months', '1 year'],
                    correct: 1,
                    explanation: 'Most insurance covers 14-30 days initially, with possible extensions.'
                }
            ]
        };
    }
    
    // Module 2: Reading Profiles Content
    getProfileAnatomyContent() {
        return {
            title: 'Anatomy of a Program Profile',
            interactiveProfile: {
                sections: [
                    {
                        id: 'header',
                        label: 'Program Identity',
                        lookFor: ['Accreditations', 'Years in operation', 'Specializations'],
                        redFlags: ['No accreditation', 'Brand new', 'Vague descriptions'],
                        greenFlags: ['CARF/Joint Commission', '10+ years', 'Clear specialty']
                    },
                    {
                        id: 'clinical',
                        label: 'Clinical Program',
                        lookFor: ['Evidence-based practices', 'Staff credentials', 'Therapy hours'],
                        redFlags: ['No licensed staff', 'Unclear modalities', 'Low therapy hours'],
                        greenFlags: ['DBT/CBT certified', 'MD/PhD on staff', '20+ hours/week']
                    },
                    {
                        id: 'population',
                        label: 'Who They Serve',
                        lookFor: ['Age ranges', 'Specialties', 'Exclusions'],
                        redFlags: ['Too broad', 'No exclusion criteria', 'Mismatched'],
                        greenFlags: ['Specific population', 'Clear criteria', 'Expertise match']
                    },
                    {
                        id: 'outcomes',
                        label: 'Success Metrics',
                        lookFor: ['Completion rates', 'Follow-up data', 'Satisfaction scores'],
                        redFlags: ['No data', 'Only testimonials', 'Vague claims'],
                        greenFlags: ['Published outcomes', '70%+ completion', 'Third-party data']
                    }
                ],
                hiddenGems: [
                    'Family involvement level',
                    'Aftercare support duration',
                    'Staff-to-patient ratios',
                    'Typical length of stay',
                    'Discharge planning process'
                ]
            }
        };
    }
    
    getRedFlagsExercise() {
        return {
            title: 'Spot the Red and Green Flags',
            scenarios: [
                {
                    text: 'We accept all insurance and guarantee results!',
                    type: 'red',
                    explanation: 'No program can guarantee results, and "all insurance" is unlikely.'
                },
                {
                    text: 'Our clinical director has 20 years experience and publishes research.',
                    type: 'green',
                    explanation: 'Experience plus academic involvement shows expertise.'
                },
                {
                    text: 'We use a proprietary treatment method not found anywhere else.',
                    type: 'red',
                    explanation: 'Unproven methods without evidence are concerning.'
                },
                {
                    text: 'Average length of stay is determined by clinical need, not insurance.',
                    type: 'green',
                    explanation: 'Clinical decisions should drive treatment, not just coverage.'
                },
                {
                    text: 'We don\'t allow any family contact for the first 30 days.',
                    type: 'red',
                    explanation: 'Excessive isolation from family is often counterproductive.'
                }
            ]
        };
    }
    
    getInsuranceDecoderContent() {
        return {
            title: 'Insurance Terms Decoded',
            terms: {
                'Single Case Agreement': 'Negotiated rate for specific patient when out-of-network',
                'Prior Authorization': 'Insurance approval needed before admission',
                'Medical Necessity': 'Clinical justification required for coverage',
                'Concurrent Review': 'Ongoing approval process during treatment',
                'Out-of-Network Benefits': 'Coverage for non-contracted providers',
                'Deductible': 'Amount patient pays before insurance starts',
                'Coinsurance': 'Percentage patient pays after deductible',
                'Out-of-Pocket Maximum': 'Most patient will pay in a year'
            },
            questionsToAsk: [
                'Do you have a single case agreement with [Insurance]?',
                'What\'s the typical length of stay approved?',
                'How often are concurrent reviews?',
                'What happens if insurance denies extension?',
                'Do you offer financial assistance?',
                'Can you help with insurance appeals?'
            ],
            verificationChecklist: [
                'Get patient\'s member ID and group number',
                'Call insurance behavioral health line',
                'Verify deductible and out-of-pocket status',
                'Confirm level of care coverage',
                'Ask about preauthorization requirements',
                'Get reference number for the call',
                'Document everything in writing'
            ]
        };
    }
    
    getProfileQuiz() {
        return {
            title: 'Program Profile Assessment',
            task: 'Review these 3 programs and match the best one to the patient',
            patient: {
                age: 16,
                diagnosis: 'Depression, anxiety, cannabis use',
                insurance: 'BCBS PPO',
                needs: 'Trauma-informed care, family involvement',
                location: 'Prefer within 100 miles'
            },
            programs: [
                {
                    name: 'Sunrise Recovery',
                    highlights: 'Substance focus, 12-step, adult program',
                    match: false,
                    reason: 'Adult program, not trauma-informed'
                },
                {
                    name: 'Healing Hearts',
                    highlights: 'Adolescent, trauma-certified, family program, BCBS',
                    match: true,
                    reason: 'Perfect match for all criteria'
                },
                {
                    name: 'Mountain View',
                    highlights: 'Wilderness therapy, 6 months minimum, cash only',
                    match: false,
                    reason: 'No insurance, too long'
                }
            ]
        };
    }
    
    // Module 3: Family Communication Content
    getCommunicationStylesContent() {
        return {
            title: 'Adapting Your Communication Style',
            styles: [
                {
                    type: 'Anxious Family',
                    characteristics: ['Many questions', 'Needs reassurance', 'Catastrophizing'],
                    approach: [
                        'Provide detailed information',
                        'Regular check-ins',
                        'Written summaries',
                        'Patience with repetition'
                    ],
                    sample: 'I understand this feels overwhelming. Let\'s go through each option step by step...'
                },
                {
                    type: 'Resistant Family',
                    characteristics: ['Minimizing problems', 'Blame others', 'Angry'],
                    approach: [
                        'Validate feelings first',
                        'Use motivational interviewing',
                        'Focus on youth\'s needs',
                        'Small steps'
                    ],
                    sample: 'You know your child best. What changes have you noticed that concern you?'
                },
                {
                    type: 'Overwhelmed Family',
                    characteristics: ['Crisis mode', 'Multiple stressors', 'Decision paralysis'],
                    approach: [
                        'Simplify choices',
                        'Prioritize urgent needs',
                        'Offer concrete next steps',
                        'Connect to resources'
                    ],
                    sample: 'Let\'s focus on the most important step right now, then build from there.'
                }
            ],
            rolePlayScenarios: [
                {
                    title: 'The Angry Father',
                    setup: 'Dad says: "This is ridiculous! He just needs discipline!"',
                    goodResponse: 'I hear your frustration. You want what\'s best for your son. Discipline is important, and he also needs clinical support for the underlying issues.',
                    badResponse: 'You\'re wrong. This is a medical condition.',
                    learning: 'Validate before educating'
                }
            ]
        };
    }
    
    getDifficultConversationsContent() {
        return {
            title: 'Navigating Difficult Conversations',
            scenarios: [
                {
                    situation: 'Program is full',
                    familyReaction: 'But you said this was perfect!',
                    response: {
                        acknowledge: 'I know this is disappointing',
                        action: 'Let\'s get on the waitlist and identify alternatives',
                        followUp: 'I\'ll call weekly for updates'
                    }
                },
                {
                    situation: 'Insurance denied',
                    familyReaction: 'We can\'t afford private pay!',
                    response: {
                        acknowledge: 'This is incredibly stressful',
                        action: 'We can appeal, seek single case agreement, or explore other programs',
                        followUp: 'I\'ll help with the appeal letter'
                    }
                },
                {
                    situation: 'Family disagrees with recommendation',
                    familyReaction: 'Residential is too extreme!',
                    response: {
                        acknowledge: 'It does feel like a big step',
                        action: 'Let\'s discuss your concerns and look at all options',
                        followUp: 'We can start with IOP and reassess'
                    }
                }
            ]
        };
    }
    
    getCulturalSensitivityContent() {
        return {
            title: 'Cultural Considerations in Treatment Planning',
            dimensions: [
                {
                    aspect: 'Language',
                    considerations: [
                        'Therapy in native language',
                        'Translated materials',
                        'Interpreter services',
                        'Bilingual staff preference'
                    ]
                },
                {
                    aspect: 'Religion/Spirituality',
                    considerations: [
                        'Faith-based vs secular programs',
                        'Dietary restrictions',
                        'Prayer/worship accommodations',
                        'Holiday observances'
                    ]
                },
                {
                    aspect: 'Family Structure',
                    considerations: [
                        'Extended family involvement',
                        'Decision-making hierarchy',
                        'Gender preferences for providers',
                        'Collective vs individual focus'
                    ]
                },
                {
                    aspect: 'LGBTQ+ Affirmation',
                    considerations: [
                        'Affirming policies',
                        'Trained staff',
                        'Peer support',
                        'Safety concerns'
                    ]
                }
            ],
            interactiveMap: {
                instructions: 'Click each region to see cultural considerations',
                regions: {
                    'Latino/Hispanic': ['Family-centered', 'Respect for elders', 'Spirituality important'],
                    'Asian/Pacific Islander': ['Saving face', 'Academic pressure', 'Holistic health'],
                    'African American': ['Church involvement', 'Historical mistrust', 'Extended family'],
                    'Native American': ['Tribal connections', 'Traditional healing', 'Historical trauma'],
                    'Middle Eastern': ['Gender considerations', 'Religious observance', 'Privacy concerns']
                }
            }
        };
    }
    
    getFamilyPracticeLab() {
        return {
            title: 'Practice Your Presentation Skills',
            exercises: [
                {
                    type: 'script-builder',
                    task: 'Create your opening for a family meeting',
                    template: [
                        'Thank you for...',
                        'Today we\'ll discuss...',
                        'My role is to...',
                        'Questions are welcome...'
                    ]
                },
                {
                    type: 'self-assessment',
                    criteria: [
                        'Spoke clearly and slowly',
                        'Used plain language',
                        'Showed empathy',
                        'Invited questions',
                        'Provided written summary'
                    ]
                }
            ]
        };
    }
    
    // Module 4: Documentation Content
    getClinicalWritingLab() {
        return {
            title: 'Transform Casual to Clinical',
            exercises: [
                {
                    casual: 'Kid has problems with drugs and fighting',
                    clinical: 'Adolescent presents with substance use disorder and conduct issues',
                    practice: 'Transform: Teen is really depressed and cuts herself'
                },
                {
                    casual: 'Family is a mess',
                    clinical: 'Family system exhibits dysfunction requiring therapeutic intervention',
                    practice: 'Transform: Parents fight all the time'
                }
            ],
            insurancePhrasing: {
                good: [
                    'Medical necessity established',
                    'Meets criteria for',
                    'Clinically appropriate',
                    'Evidence-based intervention'
                ],
                avoid: [
                    'Might benefit from',
                    'Could try',
                    'Family wants',
                    'Seems like'
                ]
            }
        };
    }
    
    getTemplateWorkshop() {
        return {
            title: 'Build Your Template Library',
            templates: {
                opening: [
                    'Following comprehensive assessment...',
                    'Based on clinical presentation...',
                    'Per evaluation conducted on [DATE]...'
                ],
                recommendations: [
                    'Recommended level of care: [LEVEL] based on...',
                    'Clinical indicators support...',
                    'Treatment goals include...'
                ],
                closing: [
                    'Prognosis with treatment is favorable',
                    'Family engagement will be critical',
                    'Recommend reassessment in [TIME]'
                ]
            }
        };
    }
    
    getSpeedDocumentation() {
        return {
            title: 'Speed Documentation Challenge',
            exercises: [
                {
                    type: 'timed-writing',
                    task: 'Write discharge summary in 10 minutes',
                    timer: 600,
                    checklist: [
                        'Diagnosis',
                        'Treatment provided',
                        'Progress made',
                        'Recommendations',
                        'Follow-up plan'
                    ]
                }
            ],
            shortcuts: {
                'Ctrl+1': 'Insert diagnosis',
                'Ctrl+2': 'Insert recommendation',
                'Ctrl+3': 'Insert closing',
                'Tab': 'Next field',
                'F2': 'Spell check'
            }
        };
    }
    
    // Module 5: Advanced Content
    getComplexCasesContent() {
        return {
            title: 'Managing Complex Cases',
            cases: [
                {
                    type: 'Dual Diagnosis',
                    considerations: [
                        'Integrated treatment essential',
                        'Psychiatric stability first',
                        'Medication management',
                        'Higher level initially'
                    ]
                },
                {
                    type: 'Trauma + Substance',
                    considerations: [
                        'Trauma-informed required',
                        'EMDR/CPT trained staff',
                        'Safety planning',
                        'Longer treatment'
                    ]
                },
                {
                    type: 'LGBTQ+ Youth',
                    considerations: [
                        'Affirming environment',
                        'Peer support crucial',
                        'Family acceptance work',
                        'Safety from discrimination'
                    ]
                }
            ]
        };
    }
    
    getFinancialPlanningContent() {
        return {
            title: 'Financial Planning Tools',
            calculator: {
                inputs: ['Daily rate', 'Length of stay', 'Insurance coverage %', 'Deductible'],
                outputs: ['Total cost', 'Insurance pays', 'Family responsibility', 'Payment plan options']
            },
            resources: [
                'Scholarship programs',
                'Sliding scale options',
                'Crowdfunding platforms',
                'Payment plan negotiation',
                'Tax deductions'
            ]
        };
    }
    
    getRelationshipBuildingContent() {
        return {
            title: 'Building Your Referral Network',
            strategies: [
                'Regular check-ins with admissions',
                'Visit programs quarterly',
                'Attend their events',
                'Share success stories',
                'Provide detailed referrals',
                'Follow up on placements'
            ],
            benefits: [
                'Priority admission',
                'Flexible payment terms',
                'Extra support for your clients',
                'Direct clinical communication',
                'Scholarship opportunities'
            ]
        };
    }
    
    // Core Learning Functions
    startModule(moduleId) {
        this.currentModule = this.modules[moduleId];
        this.currentLesson = 0;
        return this.getCurrentLesson();
    }
    
    getCurrentLesson() {
        if (!this.currentModule) return null;
        return this.currentModule.lessons[this.currentLesson];
    }
    
    nextLesson() {
        if (!this.currentModule) return null;
        
        this.currentLesson++;
        if (this.currentLesson >= this.currentModule.lessons.length) {
            this.completeModule();
            return null;
        }
        
        return this.getCurrentLesson();
    }
    
    completeModule() {
        if (!this.currentModule) return;
        
        this.currentModule.completed = true;
        this.currentModule.progress = 100;
        this.currentModule.certificate = this.generateCertificate();
        
        this.saveProgress();
        this.unlockAchievement('module-complete', this.currentModule.id);
        
        return {
            message: `Congratulations! You've completed ${this.currentModule.title}!`,
            certificate: this.currentModule.certificate,
            nextModule: this.getNextModule()
        };
    }
    
    generateCertificate() {
        return {
            id: `cert-${Date.now()}`,
            module: this.currentModule.title,
            completedDate: new Date().toISOString(),
            score: this.currentModule.quizScore || 100,
            clinicianName: this.userProgress.name || 'Clinician'
        };
    }
    
    getNextModule() {
        const moduleIds = Object.keys(this.modules);
        const currentIndex = moduleIds.indexOf(this.currentModule.id);
        
        if (currentIndex < moduleIds.length - 1) {
            return moduleIds[currentIndex + 1];
        }
        
        return null;
    }
    
    saveProgress() {
        const progress = {
            modules: {},
            achievements: this.userProgress.achievements || [],
            totalTime: this.userProgress.totalTime || 0,
            lastAccessed: new Date().toISOString()
        };
        
        Object.keys(this.modules).forEach(id => {
            progress.modules[id] = {
                progress: this.modules[id].progress,
                completed: this.modules[id].completed,
                certificate: this.modules[id].certificate
            };
        });
        
        localStorage.setItem('careconnect_learning_progress', JSON.stringify(progress));
    }
    
    loadProgress() {
        const saved = localStorage.getItem('careconnect_learning_progress');
        if (saved) {
            const progress = JSON.parse(saved);
            
            // Apply saved progress to modules
            Object.keys(progress.modules).forEach(id => {
                if (this.modules[id]) {
                    this.modules[id].progress = progress.modules[id].progress;
                    this.modules[id].completed = progress.modules[id].completed;
                    this.modules[id].certificate = progress.modules[id].certificate;
                }
            });
            
            return progress;
        }
        
        return {
            modules: {},
            achievements: [],
            totalTime: 0
        };
    }
    
    unlockAchievement(type, detail) {
        const achievement = {
            type,
            detail,
            unlockedAt: new Date().toISOString(),
            icon: this.getAchievementIcon(type)
        };
        
        if (!this.userProgress.achievements) {
            this.userProgress.achievements = [];
        }
        
        this.userProgress.achievements.push(achievement);
        this.saveProgress();
        
        return achievement;
    }
    
    getAchievementIcon(type) {
        const icons = {
            'module-complete': 'üèÜ',
            'first-week': 'üåü',
            'speed-demon': '‚ö°',
            'perfect-score': 'üíØ',
            'helping-hand': 'ü§ù'
        };
        
        return icons[type] || 'üéØ';
    }
    
    // Quiz Handling
    submitQuizAnswer(questionIndex, answerIndex) {
        const quiz = this.getCurrentLesson().content;
        const question = quiz.questions[questionIndex];
        
        const isCorrect = answerIndex === question.correct;
        
        if (!this.currentModule.quizAnswers) {
            this.currentModule.quizAnswers = [];
        }
        
        this.currentModule.quizAnswers[questionIndex] = {
            answered: answerIndex,
            correct: isCorrect
        };
        
        return {
            correct: isCorrect,
            explanation: question.explanation
        };
    }
    
    calculateQuizScore() {
        if (!this.currentModule.quizAnswers) return 0;
        
        const correct = this.currentModule.quizAnswers.filter(a => a.correct).length;
        const total = this.currentModule.quizAnswers.length;
        
        return Math.round((correct / total) * 100);
    }
    
    // Interactive Exercise Handling
    checkExerciseAnswer(exerciseId, answer) {
        // Implementation depends on exercise type
        // Returns feedback object
        return {
            correct: true,
            feedback: 'Great work!',
            nextStep: 'Continue to next exercise'
        };
    }
    
    // Get module statistics
    getModuleStats() {
        const stats = {
            totalModules: Object.keys(this.modules).length,
            completedModules: 0,
            inProgressModules: 0,
            totalProgress: 0
        };
        
        Object.values(this.modules).forEach(module => {
            if (module.completed) {
                stats.completedModules++;
            } else if (module.progress > 0) {
                stats.inProgressModules++;
            }
            stats.totalProgress += module.progress;
        });
        
        stats.averageProgress = Math.round(stats.totalProgress / stats.totalModules);
        
        return stats;
    }
}

// Initialize learning modules globally
window.learningModules = new LearningModules();

    
    // ============= MODULE VIEWER =============
    // module-viewer.js - Interactive Module Viewer and Learning Experience

class ModuleViewer {
    constructor() {
        this.currentModule = null;
        this.currentLesson = 0;
        this.lessonProgress = {};
        this.quizAnswers = {};
    }
    
    openModule(moduleId) {
        const module = window.learningModules.modules[moduleId];
        if (!module) return;
        
        this.currentModule = module;
        this.currentLesson = 0;
        this.showModuleInterface();
    }
    
    showModuleInterface() {
        const container = document.querySelector('.main-content');
        
        const moduleHTML = `
            <div class="module-viewer">
                <div class="module-viewer-header">
                    <button class="btn-back" onclick="moduleViewer.closeModule()">
                        ‚Üê Back to Learning Center
                    </button>
                    <div class="module-viewer-progress">
                        Lesson ${this.currentLesson + 1} of ${this.currentModule.lessons.length}
                    </div>
                </div>
                
                <div class="module-viewer-content">
                    <div class="lesson-sidebar">
                        ${this.renderLessonsList()}
                    </div>
                    
                    <div class="lesson-main">
                        ${this.renderCurrentLesson()}
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = moduleHTML;
        this.initializeInteractiveElements();
    }
    
    renderLessonsList() {
        return `
            <div class="lessons-list">
                <h3 class="module-title-sidebar">
                    <span class="module-icon">${this.currentModule.icon}</span>
                    ${this.currentModule.title}
                </h3>
                <div class="module-duration">${this.currentModule.duration} total</div>
                
                <div class="lessons">
                    ${this.currentModule.lessons.map((lesson, index) => `
                        <div class="lesson-item ${index === this.currentLesson ? 'active' : ''} ${this.lessonProgress[lesson.id] ? 'completed' : ''}"
                             onclick="moduleViewer.goToLesson(${index})">
                            <div class="lesson-number">${index + 1}</div>
                            <div class="lesson-info">
                                <div class="lesson-title">${lesson.title}</div>
                                <div class="lesson-type">${this.getLessonTypeLabel(lesson.type)}</div>
                            </div>
                            ${this.lessonProgress[lesson.id] ? '<div class="lesson-check">‚úì</div>' : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    renderCurrentLesson() {
        const lesson = this.currentModule.lessons[this.currentLesson];
        
        let content = '';
        
        switch(lesson.type) {
            case 'interactive':
                content = this.renderInteractiveLesson(lesson);
                break;
            case 'exercise':
                content = this.renderExerciseLesson(lesson);
                break;
            case 'quiz':
                content = this.renderQuizLesson(lesson);
                break;
            case 'cases':
                content = this.renderCaseStudyLesson(lesson);
                break;
            case 'roleplay':
                content = this.renderRoleplayLesson(lesson);
                break;
            case 'scenarios':
                content = this.renderScenariosLesson(lesson);
                break;
            default:
                content = this.renderDefaultLesson(lesson);
        }
        
        return `
            <div class="lesson-content">
                <h2 class="lesson-main-title">${lesson.title}</h2>
                ${content}
                
                <div class="lesson-navigation">
                    ${this.currentLesson > 0 ? `
                        <button class="btn btn-secondary" onclick="moduleViewer.previousLesson()">
                            ‚Üê Previous
                        </button>
                    ` : '<div></div>'}
                    
                    ${this.currentLesson < this.currentModule.lessons.length - 1 ? `
                        <button class="btn btn-primary" onclick="moduleViewer.nextLesson()">
                            Next Lesson ‚Üí
                        </button>
                    ` : `
                        <button class="btn btn-success" onclick="moduleViewer.completeModule()">
                            Complete Module! üéâ
                        </button>
                    `}
                </div>
            </div>
        `;
    }
    
    renderInteractiveLesson(lesson) {
        if (lesson.content.sections) {
            return this.renderVisualHierarchy(lesson.content);
        }
        
        return `
            <div class="interactive-lesson">
                <p>Interactive content for: ${lesson.title}</p>
            </div>
        `;
    }
    
    renderVisualHierarchy(content) {
        if (!content.sections || content.sections.length === 0) return '';
        
        const levelData = content.sections[0];
        if (!levelData.levels) return '';
        
        return `
            <div class="visual-hierarchy">
                <h3>${levelData.title}</h3>
                <div class="treatment-ladder">
                    ${levelData.levels.map(level => `
                        <div class="ladder-level" data-intensity="${level.intensity}">
                            <div class="level-header">
                                <h4>${level.name}</h4>
                                <span class="intensity-badge">Intensity: ${level.intensity}%</span>
                            </div>
                            <div class="level-body">
                                <p class="level-description">${level.description}</p>
                                <div class="level-details">
                                    <div class="detail-item">
                                        <strong>When to Use:</strong> ${level.whenToUse}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Duration:</strong> ${level.duration}
                                    </div>
                                    <div class="detail-item">
                                        <strong>Cost:</strong> ${level.cost}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    renderExerciseLesson(lesson) {
        const content = lesson.content;
        
        if (content.scenarios) {
            return `
                <div class="matching-exercise">
                    <h3>${content.title}</h3>
                    <p class="instructions">${content.instructions}</p>
                    
                    <div class="drag-drop-exercise">
                        <div class="scenarios-list">
                            ${content.scenarios.map(scenario => `
                                <div class="scenario-card draggable" data-id="${scenario.id}">
                                    <strong>${scenario.name}</strong>
                                    <p>${scenario.description}</p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="drop-zones">
                            ${content.levels.map(level => `
                                <div class="drop-zone" data-level="${level}">
                                    <h4>${level}</h4>
                                    <div class="drop-area">Drop patient here</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="moduleViewer.checkMatching()">
                        Check My Answers
                    </button>
                </div>
            `;
        }
        
        return '<div>Exercise content</div>';
    }
    
    renderQuizLesson(lesson) {
        const quiz = lesson.content;
        
        return `
            <div class="quiz-lesson">
                <h3>${quiz.title}</h3>
                <p class="quiz-info">Pass with ${quiz.passingScore}% or higher</p>
                
                <div class="quiz-questions">
                    ${quiz.questions.map((q, index) => `
                        <div class="quiz-question" data-question="${index}">
                            <div class="question-header">
                                <span class="question-number">Question ${index + 1}</span>
                            </div>
                            <div class="question-text">${q.question}</div>
                            <div class="question-options">
                                ${q.options.map((option, optIndex) => `
                                    <label class="quiz-option">
                                        <input type="radio" 
                                               name="quiz_${index}" 
                                               value="${optIndex}"
                                               onchange="moduleViewer.answerQuestion(${index}, ${optIndex})">
                                        <span>${option}</span>
                                    </label>
                                `).join('')}
                            </div>
                            <div class="question-feedback" id="feedback_${index}" style="display: none;"></div>
                        </div>
                    `).join('')}
                </div>
                
                <button class="btn btn-primary" onclick="moduleViewer.submitQuiz()" id="submitQuizBtn">
                    Submit Quiz
                </button>
                
                <div id="quizResults" style="display: none;"></div>
            </div>
        `;
    }
    
    renderCaseStudyLesson(lesson) {
        const cases = lesson.content.cases || [];
        
        return `
            <div class="case-study-lesson">
                <h3>${lesson.content.title}</h3>
                
                ${cases.map((caseStudy, index) => `
                    <div class="case-study-card">
                        <h4 class="case-title">Case ${index + 1}: ${caseStudy.title}</h4>
                        
                        <div class="case-section">
                            <strong>Patient:</strong> ${caseStudy.patient}
                        </div>
                        
                        <div class="case-section">
                            <strong>Initial Plan:</strong> ${caseStudy.initialPlan}
                        </div>
                        
                        <div class="case-section challenge">
                            <strong>Challenge:</strong> ${caseStudy.challenge}
                        </div>
                        
                        <div class="case-section intervention">
                            <strong>Intervention:</strong> ${caseStudy.intervention}
                        </div>
                        
                        <div class="case-section outcome">
                            <strong>Outcome:</strong> ${caseStudy.outcome}
                        </div>
                        
                        <div class="case-lesson">
                            üí° <strong>Key Lesson:</strong> ${caseStudy.lesson}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    renderRoleplayLesson(lesson) {
        return `
            <div class="roleplay-lesson">
                <h3>${lesson.content.title}</h3>
                <p>Practice different communication styles</p>
                
                ${(lesson.content.styles || []).map(style => `
                    <div class="communication-style">
                        <h4>${style.type}</h4>
                        <div class="style-characteristics">
                            <strong>Characteristics:</strong>
                            <ul>
                                ${style.characteristics.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="style-approach">
                            <strong>Your Approach:</strong>
                            <ul>
                                ${style.approach.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="style-sample">
                            <strong>Example:</strong>
                            <div class="sample-text">"${style.sample}"</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    renderScenariosLesson(lesson) {
        return `
            <div class="scenarios-lesson">
                <h3>${lesson.content.title}</h3>
                
                ${(lesson.content.scenarios || []).map(scenario => `
                    <div class="scenario-card">
                        <h4 class="scenario-situation">${scenario.situation}</h4>
                        <div class="scenario-reaction">
                            <strong>Family Says:</strong> "${scenario.familyReaction}"
                        </div>
                        <div class="scenario-response">
                            <strong>Your Response:</strong>
                            <ol>
                                <li><strong>Acknowledge:</strong> "${scenario.response.acknowledge}"</li>
                                <li><strong>Action:</strong> "${scenario.response.action}"</li>
                                <li><strong>Follow-up:</strong> "${scenario.response.followUp}"</li>
                            </ol>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    renderDefaultLesson(lesson) {
        return `
            <div class="default-lesson">
                <p>Content for ${lesson.title}</p>
            </div>
        `;
    }
    
    getLessonTypeLabel(type) {
        const labels = {
            'interactive': 'üéÆ Interactive',
            'exercise': '‚úèÔ∏è Exercise',
            'quiz': 'üìù Quiz',
            'cases': 'üìö Case Studies',
            'roleplay': 'üé≠ Role Play',
            'scenarios': 'üí¨ Scenarios',
            'reference': 'üìñ Reference'
        };
        
        return labels[type] || type;
    }
    
    initializeInteractiveElements() {
        // Initialize drag and drop
        this.initializeDragDrop();
        
        // Initialize hover tooltips
        this.initializeTooltips();
        
        // Initialize animations
        this.initializeAnimations();
    }
    
    initializeDragDrop() {
        const draggables = document.querySelectorAll('.draggable');
        const dropZones = document.querySelectorAll('.drop-zone');
        
        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', draggable.dataset.id);
                draggable.classList.add('dragging');
            });
            
            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
            });
        });
        
        dropZones.forEach(zone => {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                
                const scenarioId = e.dataTransfer.getData('text/plain');
                const dropArea = zone.querySelector('.drop-area');
                dropArea.textContent = scenarioId;
                dropArea.dataset.scenarioId = scenarioId;
            });
        });
    }
    
    initializeTooltips() {
        // Add hover tooltips for terms
        document.querySelectorAll('[data-tooltip]').forEach(element => {
            element.addEventListener('mouseenter', (e) => {
                this.showTooltip(e.target, e.target.dataset.tooltip);
            });
            
            element.addEventListener('mouseleave', () => {
                this.hideTooltip();
            });
        });
    }
    
    initializeAnimations() {
        // Stagger animations for lesson items
        const items = document.querySelectorAll('.lesson-item');
        items.forEach((item, index) => {
            item.style.animationDelay = `${index * 0.1}s`;
            item.classList.add('fade-in');
        });
    }
    
    nextLesson() {
        // Mark current lesson complete
        const currentLessonId = this.currentModule.lessons[this.currentLesson].id;
        this.lessonProgress[currentLessonId] = true;
        
        if (this.currentLesson < this.currentModule.lessons.length - 1) {
            this.currentLesson++;
            this.showModuleInterface();
            
            // Smooth scroll to top
            document.querySelector('.lesson-main').scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
    
    previousLesson() {
        if (this.currentLesson > 0) {
            this.currentLesson--;
            this.showModuleInterface();
        }
    }
    
    goToLesson(index) {
        this.currentLesson = index;
        this.showModuleInterface();
    }
    
    answerQuestion(questionIndex, answerIndex) {
        if (!this.quizAnswers[this.currentModule.id]) {
            this.quizAnswers[this.currentModule.id] = {};
        }
        
        this.quizAnswers[this.currentModule.id][questionIndex] = answerIndex;
    }
    
    submitQuiz() {
        const quiz = this.currentModule.lessons[this.currentLesson].content;
        const answers = this.quizAnswers[this.currentModule.id] || {};
        
        let correct = 0;
        let total = quiz.questions.length;
        
        // Check answers and show feedback
        quiz.questions.forEach((question, index) => {
            const userAnswer = answers[index];
            const isCorrect = userAnswer === question.correct;
            
            if (isCorrect) correct++;
            
            // Show feedback for each question
            const feedback = document.getElementById(`feedback_${index}`);
            if (feedback) {
                feedback.style.display = 'block';
                feedback.className = `question-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
                feedback.innerHTML = `
                    <strong>${isCorrect ? '‚úÖ Correct!' : '‚ùå Incorrect'}</strong>
                    <p>${question.explanation}</p>
                `;
            }
        });
        
        const score = Math.round((correct / total) * 100);
        const passed = score >= quiz.passingScore;
        
        // Show results
        const resultsDiv = document.getElementById('quizResults');
        resultsDiv.style.display = 'block';
        resultsDiv.className = `quiz-results ${passed ? 'passed' : 'failed'}`;
        resultsDiv.innerHTML = `
            <div class="results-header">
                <h3>${passed ? 'üéâ Congratulations!' : 'üìö Keep Learning!'}</h3>
                <div class="results-score">Score: ${score}%</div>
            </div>
            <p>${passed ? 
                'You passed! Great job mastering this material!' :
                `You scored ${score}%. Review the material and try again to pass (${quiz.passingScore}% needed).`
            }</p>
            ${passed ? `
                <button class="btn btn-success" onclick="moduleViewer.nextLesson()">
                    Continue to Next Lesson ‚Üí
                </button>
            ` : `
                <button class="btn btn-primary" onclick="moduleViewer.retakeQuiz()">
                    Review & Retake Quiz
                </button>
            `}
        `;
        
        // Hide submit button
        document.getElementById('submitQuizBtn').style.display = 'none';
    }
    
    retakeQuiz() {
        // Clear answers
        this.quizAnswers[this.currentModule.id] = {};
        
        // Reset quiz display
        document.querySelectorAll('.question-feedback').forEach(f => f.style.display = 'none');
        document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
        document.getElementById('quizResults').style.display = 'none';
        document.getElementById('submitQuizBtn').style.display = 'block';
    }
    
    checkMatching() {
        // Check drag-and-drop matching exercise
        const dropZones = document.querySelectorAll('.drop-zone');
        const lesson = this.currentModule.lessons[this.currentLesson];
        const scenarios = lesson.content.scenarios;
        
        let allCorrect = true;
        
        dropZones.forEach(zone => {
            const dropArea = zone.querySelector('.drop-area');
            const scenarioId = dropArea.dataset.scenarioId;
            const level = zone.dataset.level;
            
            if (!scenarioId) return;
            
            const scenario = scenarios.find(s => s.id === scenarioId);
            const isCorrect = scenario && scenario.correctLevel === level;
            
            if (!isCorrect) allCorrect = false;
            
            // Show feedback
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = `drop-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            feedbackDiv.textContent = isCorrect ? 
                `‚úÖ ${scenario.feedback}` : 
                `‚ùå Not quite. ${scenario.name} needs ${scenario.correctLevel}`;
            
            zone.appendChild(feedbackDiv);
        });
        
        if (allCorrect) {
            this.showSuccess('Perfect! You matched all scenarios correctly! üéâ');
        }
    }
    
    completeModule() {
        // Mark module as complete
        this.currentModule.completed = true;
        this.currentModule.progress = 100;
        
        // Generate certificate
        const certificate = this.generateCertificate();
        
        // Show completion celebration
        this.showModuleCompletion(certificate);
        
        // Update progress
        if (window.feedbackSystem) {
            window.feedbackSystem.updateStats('modulesCompleted');
        }
        
        // Save progress
        this.saveModuleProgress();
    }
    
    generateCertificate() {
        return {
            moduleName: this.currentModule.title,
            completedDate: new Date().toLocaleDateString(),
            clinicianName: window.currentUser?.name || 'Clinician',
            certificateId: `CERT-${Date.now()}`
        };
    }
    
    showModuleCompletion(certificate) {
        const container = document.querySelector('.main-content');
        
        container.innerHTML = `
            <div class="module-completion">
                <div class="completion-animation">üéâ</div>
                <h2>Module Complete!</h2>
                <h3>${this.currentModule.title}</h3>
                
                <div class="completion-stats">
                    <div class="completion-stat">
                        <span class="stat-label">Time Invested</span>
                        <span class="stat-value">${this.currentModule.duration}</span>
                    </div>
                    <div class="completion-stat">
                        <span class="stat-label">Lessons Completed</span>
                        <span class="stat-value">${this.currentModule.lessons.length}</span>
                    </div>
                    <div class="completion-stat">
                        <span class="stat-label">Knowledge Gained</span>
                        <span class="stat-value">Expert Level</span>
                    </div>
                </div>
                
                <div class="certificate-preview">
                    <h4>üèÜ Certificate of Completion</h4>
                    <p>${certificate.clinicianName}</p>
                    <p>${certificate.moduleName}</p>
                    <p>${certificate.completedDate}</p>
                </div>
                
                <div class="completion-actions">
                    <button class="btn btn-secondary" onclick="moduleViewer.closeModule()">
                        Back to Learning Center
                    </button>
                    <button class="btn btn-primary" onclick="moduleViewer.nextModule()">
                        Next Module ‚Üí
                    </button>
                </div>
            </div>
        `;
    }
    
    nextModule() {
        // Find next incomplete module
        const moduleIds = Object.keys(window.learningModules.modules);
        const currentIndex = moduleIds.indexOf(this.currentModule.id);
        
        for (let i = currentIndex + 1; i < moduleIds.length; i++) {
            const nextMod = window.learningModules.modules[moduleIds[i]];
            if (!nextMod.completed) {
                this.openModule(moduleIds[i]);
                return;
            }
        }
        
        // All modules complete!
        this.showAllModulesComplete();
    }
    
    showAllModulesComplete() {
        const container = document.querySelector('.main-content');
        
        container.innerHTML = `
            <div class="all-complete">
                <div class="completion-animation">üëë</div>
                <h2>All Modules Complete!</h2>
                <h3>You're now a CareConnect Expert!</h3>
                
                <p>You've mastered all 5 learning modules. Your families are lucky to have such a dedicated professional!</p>
                
                <button class="btn btn-primary" onclick="switchView('profile')">
                    Start Planning! ‚Üí
                </button>
            </div>
        `;
    }
    
    closeModule() {
        switchView('learn');
    }
    
    saveModuleProgress() {
        // Save to localStorage
        const progress = {
            moduleId: this.currentModule.id,
            progress: this.currentModule.progress,
            completed: this.currentModule.completed,
            lessonProgress: this.lessonProgress
        };
        
        localStorage.setItem(`module_progress_${this.currentModule.id}`, JSON.stringify(progress));
    }
    
    showSuccess(message) {
        const notification = document.createElement('div');
        notification.className = 'success-notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 3000);
    }
    
    showTooltip(element, text) {
        // Implementation for tooltips
    }
    
    hideTooltip() {
        // Implementation for hiding tooltips
    }
}

// Initialize module viewer globally
window.moduleViewer = new ModuleViewer();

    
    // ============= WORKFLOW ENGINE =============
    // workflow-engine.js - Guided Workflow Engine for CareConnect Pro

class WorkflowEngine {
    constructor() {
        this.steps = [
            {
                id: 'profile',
                name: 'Client Profile',
                description: 'Build client profile',
                icon: 'üë§',
                completed: false,
                active: true,
                data: {}
            },
            {
                id: 'explore',
                name: 'Explore Programs',
                description: 'Find the right fit',
                icon: 'üîç',
                completed: false,
                active: false,
                data: {}
            },
            {
                id: 'compare',
                name: 'Compare Options',
                description: 'Side-by-side analysis',
                icon: '‚öñÔ∏è',
                completed: false,
                active: false,
                data: {}
            },
            {
                id: 'document',
                name: 'Create Documents',
                description: 'Professional plans',
                icon: 'üìù',
                completed: false,
                active: false,
                data: {}
            },
            {
                id: 'package',
                name: 'Package & Share',
                description: 'Complete discharge packet',
                icon: 'üì¶',
                completed: false,
                active: false,
                data: {}
            }
        ];
        
        this.currentStep = 0;
        this.clientProfile = {};
        this.selectedPrograms = [];
        this.comparisonResults = null;
        this.documents = [];
        this.packet = null;
        
        this.smartPrompts = new SmartPrompts();
        this.progressTracker = new ProgressTracker();
    }
    
    // Step 1: Client Profile Builder
    startClientProfile() {
        this.setActiveStep('profile');
        
        return {
            title: 'Let\'s Build Your Client\'s Profile',
            subtitle: 'This helps us find the perfect program match',
            form: {
                sections: [
                    {
                        title: 'Basic Information',
                        fields: [
                            {
                                id: 'age',
                                label: 'Age',
                                type: 'number',
                                required: true,
                                min: 12,
                                max: 25,
                                onChange: (value) => this.smartPrompts.ageChanged(value)
                            },
                            {
                                id: 'gender',
                                label: 'Gender',
                                type: 'select',
                                options: ['Male', 'Female', 'Non-binary', 'Prefer not to say'],
                                required: true
                            },
                            {
                                id: 'location',
                                label: 'Preferred Location',
                                type: 'text',
                                placeholder: 'City, State or "Anywhere"',
                                helper: 'How far are they willing to travel?'
                            }
                        ]
                    },
                    {
                        title: 'Clinical Needs',
                        fields: [
                            {
                                id: 'primaryIssue',
                                label: 'Primary Concern',
                                type: 'select',
                                options: [
                                    'Substance Use',
                                    'Mental Health',
                                    'Dual Diagnosis',
                                    'Behavioral Issues',
                                    'Trauma',
                                    'Eating Disorder'
                                ],
                                required: true,
                                onChange: (value) => this.smartPrompts.primaryIssueSelected(value)
                            },
                            {
                                id: 'secondaryIssues',
                                label: 'Secondary Concerns',
                                type: 'multiselect',
                                options: [
                                    'Anxiety',
                                    'Depression',
                                    'ADHD',
                                    'Self-Harm',
                                    'Family Conflict',
                                    'School Refusal',
                                    'Gaming Addiction'
                                ]
                            },
                            {
                                id: 'previousTreatment',
                                label: 'Previous Treatment?',
                                type: 'radio',
                                options: ['None', 'Outpatient', 'IOP/PHP', 'Residential'],
                                onChange: (value) => this.smartPrompts.previousTreatmentSelected(value)
                            }
                        ]
                    },
                    {
                        title: 'Insurance & Budget',
                        fields: [
                            {
                                id: 'insurance',
                                label: 'Insurance Provider',
                                type: 'select',
                                options: [
                                    'BCBS',
                                    'Aetna',
                                    'Cigna',
                                    'United',
                                    'Medicaid',
                                    'Medicare',
                                    'Private Pay',
                                    'Other'
                                ],
                                required: true,
                                onChange: (value) => this.smartPrompts.insuranceSelected(value)
                            },
                            {
                                id: 'budget',
                                label: 'Budget Flexibility',
                                type: 'select',
                                options: [
                                    'Insurance Only',
                                    'Some Out-of-Pocket OK',
                                    'Flexible Budget',
                                    'Cost Not a Factor'
                                ]
                            }
                        ]
                    },
                    {
                        title: 'Special Considerations',
                        fields: [
                            {
                                id: 'specialNeeds',
                                label: 'Any Special Needs?',
                                type: 'checkboxes',
                                options: [
                                    'LGBTQ+ Affirming',
                                    'Faith-Based Preferred',
                                    'Secular Only',
                                    'Spanish Speaking',
                                    'Medical Issues',
                                    'Legal Involvement',
                                    'Adoption/Foster Care'
                                ]
                            },
                            {
                                id: 'urgency',
                                label: 'How Urgent?',
                                type: 'select',
                                options: [
                                    'ASAP - Crisis',
                                    'Within 1 Week',
                                    'Within 2 Weeks',
                                    'Within Month',
                                    'Planning Ahead'
                                ],
                                onChange: (value) => this.smartPrompts.urgencySelected(value)
                            }
                        ]
                    }
                ]
            },
            smartSuggestions: []
        };
    }
    
    saveClientProfile(data) {
        this.clientProfile = data;
        this.steps[0].completed = true;
        this.steps[0].data = data;
        
        // Generate smart recommendations
        const recommendations = this.generateRecommendations(data);
        
        this.progressTracker.profileCompleted();
        
        return {
            success: true,
            message: 'Great! Profile saved. Let\'s find some programs!',
            recommendations,
            nextStep: 'explore'
        };
    }
    
    // Step 2: Smart Program Discovery
    startProgramExploration() {
        this.setActiveStep('explore');
        
        const filters = this.generateSmartFilters();
        const suggestions = this.generateProgramSuggestions();
        
        return {
            title: 'Explore Treatment Programs',
            subtitle: `Based on ${this.clientProfile.age} year old with ${this.clientProfile.primaryIssue}`,
            filters,
            suggestions,
            tips: [
                'Programs highlighted in green are best matches',
                'Click the star to save favorites',
                'Hover over badges for explanations'
            ]
        };
    }
    
    generateSmartFilters() {
        const filters = {
            mustHave: [],
            niceToHave: [],
            avoid: []
        };
        
        // Smart filter generation based on profile
        if (this.clientProfile.primaryIssue === 'Substance Use') {
            filters.mustHave.push('Substance Use Treatment');
            if (this.clientProfile.age < 18) {
                filters.mustHave.push('Adolescent Program');
            }
        }
        
        if (this.clientProfile.specialNeeds?.includes('LGBTQ+ Affirming')) {
            filters.mustHave.push('LGBTQ+ Affirming');
        }
        
        if (this.clientProfile.insurance === 'Medicaid') {
            filters.mustHave.push('Accepts Medicaid');
        }
        
        if (this.clientProfile.urgency === 'ASAP - Crisis') {
            filters.niceToHave.push('Immediate Availability');
        }
        
        return filters;
    }
    
    generateProgramSuggestions() {
        return [
            {
                reason: 'Similar successful placements',
                programs: this.findSimilarSuccessfulPrograms()
            },
            {
                reason: 'Specializes in primary concern',
                programs: this.findSpecializedPrograms()
            },
            {
                reason: 'Insurance pre-approved',
                programs: this.findInsuranceApprovedPrograms()
            }
        ];
    }
    
    selectProgram(programId) {
        const program = this.getProgramById(programId);
        
        if (!this.selectedPrograms.find(p => p.id === programId)) {
            this.selectedPrograms.push(program);
            
            const feedback = this.smartPrompts.programSelected(program, this.selectedPrograms.length);
            
            return {
                success: true,
                message: feedback.message,
                tip: feedback.tip,
                selectedCount: this.selectedPrograms.length,
                readyToCompare: this.selectedPrograms.length >= 2
            };
        }
        
        return {
            success: false,
            message: 'Program already selected'
        };
    }
    
    // Step 3: Interactive Comparison
    startComparison() {
        if (this.selectedPrograms.length < 2) {
            return {
                error: true,
                message: 'Please select at least 2 programs to compare'
            };
        }
        
        this.setActiveStep('compare');
        
        const matrix = this.buildComparisonMatrix();
        const insights = this.generateComparisonInsights();
        
        return {
            title: 'Compare Your Top Programs',
            subtitle: 'Let\'s find the best fit for your client',
            programs: this.selectedPrograms,
            matrix,
            insights,
            decisionTools: {
                prosConsList: this.generateProsConsList(),
                questionsToAsk: this.generateQuestionsToAsk(),
                familyPresentation: this.prepareFamilyPresentation()
            }
        };
    }
    
    buildComparisonMatrix() {
        const criteria = [
            'Level of Care',
            'Specializations',
            'Age Range',
            'Gender',
            'Insurance',
            'Location',
            'Length of Stay',
            'Family Program',
            'Accreditations',
            'Success Rate'
        ];
        
        const matrix = {};
        
        criteria.forEach(criterion => {
            matrix[criterion] = {};
            this.selectedPrograms.forEach(program => {
                const value = this.getProgramValue(program, criterion);
                const rating = this.rateProgramCriterion(program, criterion, this.clientProfile);
                
                matrix[criterion][program.id] = {
                    value,
                    rating, // 'excellent', 'good', 'neutral', 'concern'
                    explanation: this.explainRating(criterion, rating)
                };
            });
        });
        
        return matrix;
    }
    
    generateComparisonInsights() {
        const insights = [];
        
        // Best overall match
        const bestMatch = this.findBestMatch();
        insights.push({
            type: 'best-match',
            program: bestMatch.program,
            reason: bestMatch.reason,
            confidence: bestMatch.confidence
        });
        
        // Key differences
        const differences = this.findKeyDifferences();
        insights.push({
            type: 'differences',
            title: 'Key Differences to Consider',
            points: differences
        });
        
        // Questions for family
        insights.push({
            type: 'questions',
            title: 'Discuss with Family',
            questions: [
                'Which location works best for visits?',
                'Is the length of stay manageable?',
                'Do the specializations match your priorities?'
            ]
        });
        
        return insights;
    }
    
    // Step 4: Document Creation Studio
    startDocumentCreation() {
        this.setActiveStep('document');
        
        const templates = this.getDocumentTemplates();
        const wizard = this.createDocumentWizard();
        
        return {
            title: 'Create Professional Documents',
            subtitle: 'Let\'s document your recommendations',
            templates,
            wizard,
            smartContent: {
                suggestions: this.generateContentSuggestions(),
                insurancePhrasing: this.getInsurancePhrasing(),
                examples: this.getDocumentExamples()
            }
        };
    }
    
    createDocumentWizard() {
        return {
            steps: [
                {
                    title: 'Choose Document Type',
                    options: [
                        {
                            id: 'aftercare-options',
                            name: 'Aftercare Options',
                            description: 'Present multiple program options',
                            time: '10 minutes',
                            icon: 'üìã'
                        },
                        {
                            id: 'aftercare-plan',
                            name: 'Aftercare Plan',
                            description: 'Detailed plan with selected program',
                            time: '15 minutes',
                            icon: 'üìù'
                        },
                        {
                            id: 'discharge-packet',
                            name: 'Discharge Packet',
                            description: 'Complete packet with all materials',
                            time: '5 minutes',
                            icon: 'üì¶'
                        }
                    ]
                },
                {
                    title: 'Customize Content',
                    fields: [
                        {
                            id: 'tone',
                            label: 'Document Tone',
                            options: ['Clinical', 'Family-Friendly', 'Insurance-Focused']
                        },
                        {
                            id: 'sections',
                            label: 'Include Sections',
                            options: [
                                'Executive Summary',
                                'Clinical Rationale',
                                'Program Details',
                                'Financial Information',
                                'Next Steps'
                            ]
                        }
                    ]
                },
                {
                    title: 'Review & Edit',
                    preview: true,
                    editableFields: true,
                    suggestions: true
                }
            ]
        };
    }
    
    generateDocument(type, options) {
        const document = {
            id: `doc-${Date.now()}`,
            type,
            createdAt: new Date().toISOString(),
            clientProfile: this.clientProfile,
            programs: this.selectedPrograms,
            content: ''
        };
        
        // Generate content based on type
        switch(type) {
            case 'aftercare-options':
                document.content = this.generateAftercareOptions(options);
                break;
            case 'aftercare-plan':
                document.content = this.generateAftercarePlan(options);
                break;
            case 'discharge-packet':
                document.content = this.generateDischargePacket(options);
                break;
        }
        
        this.documents.push(document);
        this.steps[3].completed = true;
        
        return {
            success: true,
            document,
            message: 'Document created successfully!',
            preview: document.content.substring(0, 500) + '...'
        };
    }
    
    // Step 5: Package & Share Center
    startPackaging() {
        this.setActiveStep('package');
        
        return {
            title: 'Package Your Discharge Materials',
            subtitle: 'Everything the family needs in one place',
            components: {
                required: [
                    {
                        id: 'aftercare-plan',
                        name: 'Aftercare Plan',
                        status: this.documents.find(d => d.type === 'aftercare-plan') ? 'ready' : 'missing'
                    },
                    {
                        id: 'program-info',
                        name: 'Program Information',
                        status: 'ready'
                    }
                ],
                optional: [
                    {
                        id: 'insurance-auth',
                        name: 'Insurance Authorization',
                        status: 'optional'
                    },
                    {
                        id: 'family-education',
                        name: 'Family Education Materials',
                        status: 'optional'
                    },
                    {
                        id: 'consent-forms',
                        name: 'Consent Forms',
                        status: 'optional'
                    }
                ]
            },
            exportOptions: [
                {
                    format: 'pdf',
                    name: 'PDF Package',
                    description: 'Print-ready format',
                    icon: 'üìÑ'
                },
                {
                    format: 'email',
                    name: 'Email Package',
                    description: 'Send directly to family',
                    icon: 'üìß'
                },
                {
                    format: 'portal',
                    name: 'Family Portal',
                    description: 'Secure online access',
                    icon: 'üîí'
                }
            ]
        };
    }
    
    createPacket(components, format) {
        this.packet = {
            id: `packet-${Date.now()}`,
            createdAt: new Date().toISOString(),
            components,
            format,
            clientProfile: this.clientProfile
        };
        
        this.steps[4].completed = true;
        
        // Celebrate completion!
        const celebration = {
            title: 'üéâ Discharge Packet Complete!',
            message: 'You\'ve created a comprehensive aftercare plan!',
            stats: {
                programsReviewed: this.selectedPrograms.length,
                documentsCreated: this.documents.length,
                timeSpent: this.progressTracker.getTotalTime()
            },
            encouragement: this.getCompletionMessage()
        };
        
        return {
            success: true,
            packet: this.packet,
            celebration,
            nextActions: [
                'Share with family',
                'Schedule follow-up',
                'Start new case'
            ]
        };
    }
    
    // Helper Functions
    setActiveStep(stepId) {
        this.steps.forEach(step => {
            step.active = step.id === stepId;
        });
        
        this.currentStep = this.steps.findIndex(s => s.id === stepId);
    }
    
    getProgramById(id) {
        // Get from programs database
        return window.programsData?.find(p => p.id === id);
    }
    
    getProgramValue(program, criterion) {
        const mapping = {
            'Level of Care': program.clinical?.levelsOfCare?.join(', '),
            'Specializations': program.clinical?.specializations?.join(', '),
            'Age Range': program.population?.ages,
            'Gender': program.population?.gender,
            'Insurance': program.admissions?.insurance?.join(', '),
            'Location': `${program.location?.city}, ${program.location?.state}`,
            'Length of Stay': program.structure?.lengthOfStay,
            'Family Program': program.family?.involvement ? 'Yes' : 'Limited',
            'Accreditations': program.quality?.accreditations?.join(', '),
            'Success Rate': program.quality?.successRate || 'Not reported'
        };
        
        return mapping[criterion] || 'Not specified';
    }
    
    rateProgramCriterion(program, criterion, profile) {
        // Smart rating logic based on client profile match
        // Returns: 'excellent', 'good', 'neutral', 'concern'
        
        // Simplified example
        if (criterion === 'Age Range') {
            const programAges = program.population?.ages;
            const clientAge = profile.age;
            
            if (programAges?.includes(clientAge.toString())) {
                return 'excellent';
            }
        }
        
        return 'neutral';
    }
    
    explainRating(criterion, rating) {
        const explanations = {
            excellent: `Perfect match for ${criterion}`,
            good: `Good fit for ${criterion}`,
            neutral: `Acceptable for ${criterion}`,
            concern: `May need to discuss ${criterion}`
        };
        
        return explanations[rating];
    }
    
    findBestMatch() {
        // Algorithm to find best program match
        let bestMatch = null;
        let highestScore = 0;
        
        this.selectedPrograms.forEach(program => {
            const score = this.calculateMatchScore(program, this.clientProfile);
            if (score > highestScore) {
                highestScore = score;
                bestMatch = program;
            }
        });
        
        return {
            program: bestMatch,
            reason: 'Best overall match for clinical needs and preferences',
            confidence: highestScore
        };
    }
    
    calculateMatchScore(program, profile) {
        let score = 0;
        
        // Scoring logic based on profile match
        // Simplified example
        if (program.clinical?.primaryFocus === profile.primaryIssue) {
            score += 30;
        }
        
        if (program.population?.ages?.includes(profile.age.toString())) {
            score += 20;
        }
        
        if (program.admissions?.insurance?.includes(profile.insurance)) {
            score += 25;
        }
        
        return score;
    }
    
    findKeyDifferences() {
        const differences = [];
        
        // Compare programs to find notable differences
        if (this.selectedPrograms.length >= 2) {
            const program1 = this.selectedPrograms[0];
            const program2 = this.selectedPrograms[1];
            
            if (program1.clinical?.levelsOfCare[0] !== program2.clinical?.levelsOfCare[0]) {
                differences.push('Different levels of care offered');
            }
            
            if (program1.location?.state !== program2.location?.state) {
                differences.push('Different geographic locations');
            }
        }
        
        return differences;
    }
    
    findSimilarSuccessfulPrograms() {
        // Find programs similar to past successful placements
        return [];
    }
    
    findSpecializedPrograms() {
        // Find programs specializing in client's primary issue
        return window.programsData?.filter(p => 
            p.clinical?.primaryFocus === this.clientProfile.primaryIssue
        ).slice(0, 3) || [];
    }
    
    findInsuranceApprovedPrograms() {
        // Find programs accepting client's insurance
        return window.programsData?.filter(p => 
            p.admissions?.insurance?.includes(this.clientProfile.insurance)
        ).slice(0, 3) || [];
    }
    
    generateProsConsList() {
        const prosCons = {};
        
        this.selectedPrograms.forEach(program => {
            prosCons[program.id] = {
                pros: [],
                cons: []
            };
            
            // Generate pros
            if (program.clinical?.primaryFocus === this.clientProfile.primaryIssue) {
                prosCons[program.id].pros.push('Specializes in primary concern');
            }
            
            // Generate cons
            if (!program.admissions?.insurance?.includes(this.clientProfile.insurance)) {
                prosCons[program.id].cons.push('May need to verify insurance');
            }
        });
        
        return prosCons;
    }
    
    generateQuestionsToAsk() {
        return [
            'What is your current availability?',
            'Can you describe a typical day?',
            'How do you involve families?',
            'What happens after discharge?',
            'Can you work with our insurance?'
        ];
    }
    
    prepareFamilyPresentation() {
        return {
            format: 'simple-comparison',
            includePhotos: true,
            highlightDifferences: true,
            focusOnPositives: true
        };
    }
    
    generateContentSuggestions() {
        return [
            'Mention the trauma-informed approach',
            'Highlight the family program',
            'Include success rates if available',
            'Note the accreditations'
        ];
    }
    
    getInsurancePhrasing() {
        return {
            recommended: [
                'Medical necessity established based on...',
                'Meets criteria for level of care...',
                'Clinical indicators support...'
            ],
            avoid: [
                'Family preference',
                'Might help',
                'Could benefit'
            ]
        };
    }
    
    getDocumentExamples() {
        return [
            {
                type: 'opening',
                text: 'Following comprehensive assessment on [DATE], the following aftercare recommendations are presented...'
            },
            {
                type: 'clinical-rationale',
                text: 'Based on presenting symptoms of [SYMPTOMS] and diagnosis of [DIAGNOSIS], residential treatment is clinically indicated...'
            }
        ];
    }
    
    generateAftercareOptions(options) {
        // Generate aftercare options document content
        return `Aftercare Options for ${this.clientProfile.age} year old...`;
    }
    
    generateAftercarePlan(options) {
        // Generate aftercare plan document content
        return `Comprehensive Aftercare Plan...`;
    }
    
    generateDischargePacket(options) {
        // Generate discharge packet content
        return `Discharge Packet Contents...`;
    }
    
    getCompletionMessage() {
        const messages = [
            'Outstanding work! This family is in great hands.',
            'You\'ve created a thorough, professional plan!',
            'Another family helped! You\'re making a difference.',
            'Excellent job! Your attention to detail shows.'
        ];
        
        return messages[Math.floor(Math.random() * messages.length)];
    }
}

// Smart Prompts System
class SmartPrompts {
    ageChanged(age) {
        if (age < 14) {
            return {
                prompt: 'Young adolescent programs often focus on family involvement',
                suggestion: 'Consider programs with strong family therapy components'
            };
        } else if (age >= 18) {
            return {
                prompt: 'Young adult programs offer more independence',
                suggestion: 'Look for programs with life skills training'
            };
        }
    }
    
    primaryIssueSelected(issue) {
        const prompts = {
            'Substance Use': {
                prompt: 'Substance use often requires higher level initially',
                suggestion: 'Consider residential or PHP to start'
            },
            'Mental Health': {
                prompt: 'Mental health can often be treated outpatient',
                suggestion: 'IOP might be sufficient with good support'
            },
            'Dual Diagnosis': {
                prompt: 'Dual diagnosis needs integrated treatment',
                suggestion: 'Look for programs treating both simultaneously'
            },
            'Trauma': {
                prompt: 'Trauma requires specialized approaches',
                suggestion: 'Seek trauma-informed programs with EMDR/CPT'
            }
        };
        
        return prompts[issue] || {};
    }
    
    previousTreatmentSelected(treatment) {
        if (treatment === 'Residential') {
            return {
                prompt: 'Previous residential suggests need for different approach',
                suggestion: 'Consider different program or longer stay'
            };
        } else if (treatment === 'None') {
            return {
                prompt: 'First treatment attempt - set realistic expectations',
                suggestion: 'Start with appropriate level, can adjust if needed'
            };
        }
    }
    
    insuranceSelected(insurance) {
        const tips = {
            'Medicaid': 'Medicaid has limited options but good coverage',
            'Private Pay': 'Private pay opens all options',
            'BCBS': 'BCBS typically has good mental health coverage'
        };
        
        return {
            prompt: tips[insurance] || 'Verify coverage before admission',
            suggestion: 'Call insurance to confirm benefits'
        };
    }
    
    urgencySelected(urgency) {
        if (urgency === 'ASAP - Crisis') {
            return {
                prompt: 'Crisis situation - prioritize immediate availability',
                suggestion: 'Focus on programs with immediate openings',
                alert: true
            };
        }
    }
    
    programSelected(program, count) {
        const messages = [
            { message: 'Great choice!', tip: 'This program has excellent reviews' },
            { message: 'Nice selection!', tip: `You now have ${count} programs selected` },
            { message: 'Good find!', tip: 'Ready to compare when you have 2+' }
        ];
        
        return messages[Math.min(count - 1, messages.length - 1)];
    }
}

// Progress Tracker
class ProgressTracker {
    constructor() {
        this.startTime = Date.now();
        this.milestones = [];
    }
    
    profileCompleted() {
        this.addMilestone('profile-complete');
    }
    
    addMilestone(type) {
        this.milestones.push({
            type,
            timestamp: Date.now()
        });
    }
    
    getTotalTime() {
        const elapsed = Date.now() - this.startTime;
        const minutes = Math.floor(elapsed / 60000);
        return `${minutes} minutes`;
    }
}

// Initialize workflow engine globally
window.workflowEngine = new WorkflowEngine();

    
    // ============= FEEDBACK SYSTEM =============
    // feedback-system.js - Smart Feedback and Encouragement System

class FeedbackSystem {
    constructor() {
        this.userStats = this.loadUserStats();
        this.achievements = new AchievementSystem();
        this.encourager = new EncouragementEngine();
        this.tips = new ContextualTips();
        this.celebrations = new CelebrationManager();
    }
    
    // User Statistics Tracking
    loadUserStats() {
        const saved = localStorage.getItem('careconnect_user_stats');
        if (saved) {
            return JSON.parse(saved);
        }
        
        return {
            casesCompleted: 0,
            familiesHelped: 0,
            programsReviewed: 0,
            documentsCreated: 0,
            modulesCompleted: 0,
            totalTime: 0,
            streak: 0,
            lastLogin: null,
            startDate: new Date().toISOString()
        };
    }
    
    saveUserStats() {
        localStorage.setItem('careconnect_user_stats', JSON.stringify(this.userStats));
    }
    
    updateStats(type, value = 1) {
        if (this.userStats[type] !== undefined) {
            this.userStats[type] += value;
            this.saveUserStats();
            
            // Check for achievements
            this.checkAchievements(type, this.userStats[type]);
            
            // Generate encouragement
            return this.encourager.getEncouragement(type, this.userStats[type]);
        }
    }
    
    checkAchievements(type, value) {
        const achieved = this.achievements.check(type, value);
        if (achieved) {
            this.celebrations.celebrate(achieved);
        }
    }
    
    // Daily Welcome Messages
    getDailyWelcome(userName) {
        const hour = new Date().getHours();
        const stats = this.userStats;
        
        let greeting = '';
        let motivation = '';
        
        // Time-based greeting
        if (hour < 12) {
            greeting = `Good morning, ${userName}! ‚òÄÔ∏è`;
        } else if (hour < 17) {
            greeting = `Good afternoon, ${userName}! üå§Ô∏è`;
        } else {
            greeting = `Good evening, ${userName}! üåô`;
        }
        
        // Personalized motivation based on stats
        if (stats.streak > 0) {
            motivation = `You're on a ${stats.streak} day streak! Keep it going!`;
        } else if (stats.casesCompleted === 0) {
            motivation = `Ready to help your first family? Let's get started!`;
        } else if (stats.casesCompleted % 10 === 0) {
            motivation = `Wow! ${stats.casesCompleted} cases completed! You're a superstar!`;
        } else {
            const motivations = [
                `You've helped ${stats.familiesHelped} families find hope!`,
                `${stats.programsReviewed} programs reviewed - you know your stuff!`,
                `Another day, another opportunity to change lives!`,
                `Your expertise is making a real difference!`,
                `Let's help more families today!`
            ];
            motivation = motivations[Math.floor(Math.random() * motivations.length)];
        }
        
        return {
            greeting,
            motivation,
            todayGoals: this.generateDailyGoals(),
            tip: this.tips.getDailyTip()
        };
    }
    
    generateDailyGoals() {
        const goals = [];
        
        if (this.userStats.modulesCompleted < 5) {
            goals.push({
                icon: 'üìö',
                text: 'Complete a learning module',
                progress: `${this.userStats.modulesCompleted}/5`
            });
        }
        
        goals.push({
            icon: 'üë®‚Äçüë©‚Äçüëß',
            text: 'Help 3 families today',
            progress: `0/3`
        });
        
        goals.push({
            icon: '‚è±Ô∏è',
            text: 'Complete a case in under 30 min',
            progress: 'Not started'
        });
        
        return goals;
    }
    
    // Contextual Feedback During Workflow
    getWorkflowFeedback(step, action, context) {
        const feedback = {
            message: '',
            tip: '',
            encouragement: '',
            warning: ''
        };
        
        switch(step) {
            case 'profile':
                feedback.message = this.getProfileFeedback(action, context);
                break;
            case 'explore':
                feedback.message = this.getExploreFeedback(action, context);
                break;
            case 'compare':
                feedback.message = this.getCompareFeedback(action, context);
                break;
            case 'document':
                feedback.message = this.getDocumentFeedback(action, context);
                break;
            case 'package':
                feedback.message = this.getPackageFeedback(action, context);
                break;
        }
        
        // Add contextual tip
        feedback.tip = this.tips.getContextualTip(step, action);
        
        // Add encouragement if milestone
        if (this.isMilestone(step, action, context)) {
            feedback.encouragement = this.encourager.getMilestoneMessage(step);
        }
        
        // Add warning if needed
        feedback.warning = this.getWarningIfNeeded(step, action, context);
        
        return feedback;
    }
    
    getProfileFeedback(action, context) {
        const messages = {
            'age-entered': context.age < 14 ? 
                'Young client - family involvement will be crucial' :
                context.age > 18 ? 
                'Young adult - consider programs with life skills' :
                'Good age for many program options',
            'insurance-selected': context.insurance === 'Medicaid' ?
                'Medicaid accepted by select programs - I\'ll filter for you' :
                'Good insurance coverage - many options available',
            'urgency-high': '‚ö†Ô∏è Crisis situation noted - prioritizing immediate availability',
            'profile-complete': '‚úÖ Excellent profile! Now let\'s find the perfect programs!'
        };
        
        return messages[action] || '';
    }
    
    getExploreFeedback(action, context) {
        const messages = {
            'program-selected': [
                'Great choice! This program has excellent outcomes.',
                'Nice find! Adding to your comparison list.',
                'Good eye! This matches the client profile well.',
                'Excellent! One more and you can compare.'
            ][Math.floor(Math.random() * 4)],
            'filter-applied': `Showing ${context.count} programs matching your criteria`,
            'search-performed': context.results === 0 ?
                'No exact matches - try adjusting filters' :
                `Found ${context.results} programs matching "${context.query}"`
        };
        
        return messages[action] || '';
    }
    
    getCompareFeedback(action, context) {
        const messages = {
            'comparison-started': 'Let\'s analyze these programs side-by-side',
            'best-match-identified': `${context.program} appears to be the strongest match!`,
            'concern-noted': 'Good catch - this difference is important to discuss with family',
            'notes-added': 'Notes saved - these will appear in your documentation'
        };
        
        return messages[action] || '';
    }
    
    getDocumentFeedback(action, context) {
        const messages = {
            'template-selected': 'Good choice - this template works well for insurance',
            'section-completed': `${context.sections}/${context.total} sections complete`,
            'insurance-language': 'üí° Using insurance-friendly language increases approval rates',
            'document-complete': 'üìÑ Professional document ready for review!'
        };
        
        return messages[action] || '';
    }
    
    getPackageFeedback(action, context) {
        const messages = {
            'component-added': `Added ${context.component} to packet`,
            'packet-complete': 'üéâ Discharge packet complete and ready to share!',
            'exported': `Successfully exported as ${context.format}`,
            'shared': 'Sent to family - you\'ll get a read receipt'
        };
        
        return messages[action] || '';
    }
    
    isMilestone(step, action, context) {
        const milestones = {
            'profile': ['profile-complete'],
            'explore': ['5-programs-selected', '10-programs-reviewed'],
            'compare': ['comparison-complete', 'decision-made'],
            'document': ['first-document', 'document-complete'],
            'package': ['packet-complete', 'case-closed']
        };
        
        return milestones[step]?.includes(action);
    }
    
    getWarningIfNeeded(step, action, context) {
        // Check for potential issues
        if (step === 'explore' && context.insurance === 'Medicaid' && context.programsFound === 0) {
            return '‚ö†Ô∏è Limited Medicaid options - consider expanding search area';
        }
        
        if (step === 'compare' && context.priceVariance > 10000) {
            return '‚ö†Ô∏è Significant price difference - discuss budget with family';
        }
        
        if (step === 'document' && !context.insuranceVerified) {
            return '‚ö†Ô∏è Remember to verify insurance coverage before finalizing';
        }
        
        return '';
    }
}

// Achievement System
class AchievementSystem {
    constructor() {
        this.achievements = {
            // Cases
            'first-case': { threshold: 1, icon: 'üéØ', title: 'First Case Complete!' },
            'case-5': { threshold: 5, icon: '‚≠ê', title: '5 Cases Complete!' },
            'case-10': { threshold: 10, icon: 'üåü', title: '10 Cases - On Fire!' },
            'case-25': { threshold: 25, icon: 'üí´', title: '25 Cases - Expert!' },
            'case-50': { threshold: 50, icon: 'üèÜ', title: '50 Cases - Master!' },
            'case-100': { threshold: 100, icon: 'üëë', title: '100 Cases - Legend!' },
            
            // Speed
            'speed-demon': { type: 'time', threshold: 30, icon: '‚ö°', title: 'Speed Demon - Case in 30min!' },
            'quick-doc': { type: 'time', threshold: 10, icon: 'üìù', title: 'Quick Doc - Document in 10min!' },
            
            // Learning
            'module-1': { type: 'module', icon: 'üìö', title: 'First Module Complete!' },
            'all-modules': { type: 'module', threshold: 5, icon: 'üéì', title: 'Learning Master!' },
            
            // Streaks
            'streak-3': { type: 'streak', threshold: 3, icon: 'üî•', title: '3 Day Streak!' },
            'streak-7': { type: 'streak', threshold: 7, icon: 'üî•', title: 'Week Streak!' },
            'streak-30': { type: 'streak', threshold: 30, icon: 'üî•', title: 'Month Streak!' },
            
            // Special
            'night-owl': { type: 'special', icon: 'ü¶â', title: 'Night Owl - Working Late!' },
            'early-bird': { type: 'special', icon: 'üê¶', title: 'Early Bird - Morning Productivity!' },
            'weekend-warrior': { type: 'special', icon: '‚öîÔ∏è', title: 'Weekend Warrior!' },
            'perfect-match': { type: 'special', icon: 'üíØ', title: 'Perfect Match - 100% Family Satisfaction!' }
        };
        
        this.userAchievements = this.loadAchievements();
    }
    
    loadAchievements() {
        const saved = localStorage.getItem('careconnect_achievements');
        return saved ? JSON.parse(saved) : [];
    }
    
    saveAchievements() {
        localStorage.setItem('careconnect_achievements', JSON.stringify(this.userAchievements));
    }
    
    check(type, value) {
        const newAchievements = [];
        
        Object.keys(this.achievements).forEach(key => {
            const achievement = this.achievements[key];
            
            // Check if already earned
            if (this.userAchievements.find(a => a.key === key)) {
                return;
            }
            
            // Check if earned now
            if (type === 'casesCompleted' && key.startsWith('case-') && value >= achievement.threshold) {
                newAchievements.push({ key, ...achievement, earnedAt: new Date().toISOString() });
            }
            
            if (type === 'streak' && achievement.type === 'streak' && value >= achievement.threshold) {
                newAchievements.push({ key, ...achievement, earnedAt: new Date().toISOString() });
            }
            
            // Check special achievements
            const hour = new Date().getHours();
            if (key === 'night-owl' && hour >= 22) {
                newAchievements.push({ key, ...achievement, earnedAt: new Date().toISOString() });
            }
            
            if (key === 'early-bird' && hour <= 6) {
                newAchievements.push({ key, ...achievement, earnedAt: new Date().toISOString() });
            }
            
            const day = new Date().getDay();
            if (key === 'weekend-warrior' && (day === 0 || day === 6)) {
                newAchievements.push({ key, ...achievement, earnedAt: new Date().toISOString() });
            }
        });
        
        if (newAchievements.length > 0) {
            this.userAchievements.push(...newAchievements);
            this.saveAchievements();
            return newAchievements;
        }
        
        return null;
    }
    
    getProgress() {
        const total = Object.keys(this.achievements).length;
        const earned = this.userAchievements.length;
        
        return {
            earned,
            total,
            percentage: Math.round((earned / total) * 100),
            recent: this.userAchievements.slice(-3),
            nextMilestone: this.getNextMilestone()
        };
    }
    
    getNextMilestone() {
        // Find next case milestone
        const caseAchievements = Object.keys(this.achievements)
            .filter(k => k.startsWith('case-'))
            .map(k => ({ key: k, ...this.achievements[k] }))
            .filter(a => !this.userAchievements.find(ua => ua.key === a.key))
            .sort((a, b) => a.threshold - b.threshold);
        
        return caseAchievements[0] || null;
    }
}

// Encouragement Engine
class EncouragementEngine {
    constructor() {
        this.messages = {
            casesCompleted: [
                'Another family helped! You\'re amazing!',
                'Case closed! Your expertise shines through!',
                'Fantastic work! That family is in great hands!',
                'You\'re on fire! Keep helping families!'
            ],
            programsReviewed: [
                'Thorough research! Families appreciate this!',
                'You really know your programs!',
                'Great exploration! The perfect match is close!',
                'Your attention to detail is impressive!'
            ],
            documentsCreated: [
                'Professional documentation complete!',
                'Clear, concise, and clinical - perfect!',
                'This document will really help the family!',
                'Your writing skills are top-notch!'
            ],
            modulesCompleted: [
                'Knowledge gained! You\'re growing!',
                'Module mastered! Apply this knowledge!',
                'Learning complete! You\'re even better now!',
                'Expertise level up! Well done!'
            ]
        };
        
        this.milestoneMessages = {
            profile: 'Profile complete! You\'re organized and ready!',
            explore: 'Great exploration! You\'ve found excellent options!',
            compare: 'Thoughtful comparison! The best choice is clear!',
            document: 'Documentation perfect! Professional and thorough!',
            package: 'Package complete! This family is all set!'
        };
    }
    
    getEncouragement(type, value) {
        const messages = this.messages[type];
        if (!messages) return '';
        
        // Add variety
        const index = value % messages.length;
        return messages[index];
    }
    
    getMilestoneMessage(step) {
        return this.milestoneMessages[step] || 'Great progress!';
    }
    
    getRandomMotivation() {
        const motivations = [
            'You\'re making a real difference!',
            'Families are lucky to have you!',
            'Your dedication is inspiring!',
            'Keep up the amazing work!',
            'You\'re a true professional!',
            'Your expertise shows!',
            'Excellent judgment!',
            'You\'ve got this!',
            'Impressive work!',
            'Outstanding effort!'
        ];
        
        return motivations[Math.floor(Math.random() * motivations.length)];
    }
}

// Contextual Tips System
class ContextualTips {
    constructor() {
        this.tips = {
            profile: [
                'Tip: Capture as much detail as possible for better matches',
                'Tip: Previous treatment history helps identify what didn\'t work',
                'Tip: Insurance verification saves time later',
                'Tip: Special needs ensure appropriate placement'
            ],
            explore: [
                'Tip: Star your favorites for easy comparison',
                'Tip: Read reviews from other clinicians',
                'Tip: Check admission requirements early',
                'Tip: Note waitlist status for planning'
            ],
            compare: [
                'Tip: Focus on clinical fit over amenities',
                'Tip: Consider family visit logistics',
                'Tip: Verify insurance coverage for each',
                'Tip: Note any exclusion criteria'
            ],
            document: [
                'Tip: Use clinical language for insurance',
                'Tip: Be specific about medical necessity',
                'Tip: Include diagnosis codes when possible',
                'Tip: Avoid guarantees or promises'
            ],
            package: [
                'Tip: Review everything before sending',
                'Tip: Include contact information',
                'Tip: Add a personal note to family',
                'Tip: Save a copy for records'
            ]
        };
        
        this.dailyTips = [
            'Did you know? Programs often have scholarships available - always ask!',
            'Pro tip: Building relationships with admissions helps future placements',
            'Remember: Family involvement is the #1 predictor of success',
            'Insight: Morning admissions calls often get faster responses',
            'Tip: Keep notes on each program\'s strengths for future reference'
        ];
    }
    
    getContextualTip(step, action) {
        const stepTips = this.tips[step];
        if (!stepTips) return '';
        
        // Rotate through tips
        const index = Math.floor(Math.random() * stepTips.length);
        return stepTips[index];
    }
    
    getDailyTip() {
        const today = new Date().getDay();
        return this.dailyTips[today % this.dailyTips.length];
    }
}

// Celebration Manager
class CelebrationManager {
    celebrate(achievements) {
        if (!achievements || achievements.length === 0) return;
        
        const achievement = achievements[0]; // Show first one
        
        // Create celebration notification
        this.showCelebration(achievement);
        
        // Add confetti for major achievements
        if (achievement.key.includes('100') || achievement.key.includes('master')) {
            this.showConfetti();
        }
        
        // Play sound (if enabled)
        this.playSound();
    }
    
    showCelebration(achievement) {
        const celebration = {
            icon: achievement.icon,
            title: achievement.title,
            message: 'Congratulations! You\'ve earned a new achievement!',
            timestamp: new Date().toISOString()
        };
        
        // Trigger UI celebration
        if (window.showAchievement) {
            window.showAchievement(celebration);
        }
        
        return celebration;
    }
    
    showConfetti() {
        // Trigger confetti animation
        if (window.confetti) {
            window.confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }
    }
    
    playSound() {
        // Play achievement sound if enabled
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZijYIG2m98OScTgwOUann7blmFgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
        audio.volume = 0.3;
        audio.play().catch(() => {}); // Ignore if audio fails
    }
}

// Initialize feedback system globally
window.feedbackSystem = new FeedbackSystem();

    
    // ============= COMPARISON MATRIX =============
    // comparison-matrix.js - Advanced program comparison tool for clinical decision-making

class ComparisonMatrix {
    constructor() {
        this.selectedPrograms = [];
        this.maxPrograms = 4;
        this.comparisonCategories = {
            'Clinical Services': [
                'levelsOfCare',
                'primaryFocus',
                'specializations',
                'evidenceBasedTherapies',
                'experientialTherapies',
                'holisticTherapies'
            ],
            'Population': [
                'agesServed',
                'gender',
                'specialPopulations'
            ],
            'Program Structure': [
                'programLength',
                'capacity',
                'staffRatio',
                'groupSize'
            ],
            'Medical & Psychiatric': [
                'medicalServices',
                'psychiatricServices',
                'medicationManagement',
                'detoxServices'
            ],
            'Family Program': [
                'familyTherapy',
                'familyEducation',
                'familyVisitation'
            ],
            'Academic/Vocational': [
                'academicSupport',
                'vocationalTraining',
                'collegePrep'
            ],
            'Admissions & Insurance': [
                'insuranceAccepted',
                'privatePayOptions',
                'financialAssistance',
                'admissionRequirements'
            ],
            'Accreditations & Quality': [
                'accreditations',
                'memberships',
                'successMetrics'
            ],
            'Amenities & Environment': [
                'setting',
                'facilities',
                'roomTypes',
                'recreation'
            ],
            'Aftercare & Support': [
                'aftercareServices',
                'alumniProgram',
                'transitionSupport'
            ]
        };
    }
    
    addProgram(programId) {
        if (this.selectedPrograms.length >= this.maxPrograms) {
            this.showNotification(`Maximum ${this.maxPrograms} programs can be compared at once`, 'warning');
            return false;
        }
        
        if (!this.selectedPrograms.includes(programId)) {
            this.selectedPrograms.push(programId);
            this.updateComparisonView();
            
            // Track in session
            if (window.sessionManager) {
                window.sessionManager.addProgramToCompare(programId);
            }
            
            return true;
        }
        
        return false;
    }
    
    removeProgram(programId) {
        const index = this.selectedPrograms.indexOf(programId);
        if (index > -1) {
            this.selectedPrograms.splice(index, 1);
            this.updateComparisonView();
        }
    }
    
    clearComparison() {
        this.selectedPrograms = [];
        this.updateComparisonView();
    }
    
    generateComparisonMatrix() {
        if (this.selectedPrograms.length < 2) {
            return null;
        }
        
        const programs = this.selectedPrograms.map(id => this.getProgramData(id));
        const matrix = document.createElement('div');
        matrix.className = 'comparison-matrix';
        
        // Header with program names
        const header = this.createMatrixHeader(programs);
        matrix.appendChild(header);
        
        // Category sections
        Object.entries(this.comparisonCategories).forEach(([category, fields]) => {
            const section = this.createCategorySection(category, fields, programs);
            matrix.appendChild(section);
        });
        
        // Action buttons
        const actions = this.createMatrixActions();
        matrix.appendChild(actions);
        
        return matrix;
    }
    
    createMatrixHeader(programs) {
        const header = document.createElement('div');
        header.className = 'matrix-header';
        
        header.innerHTML = `
            <div class="matrix-row header-row">
                <div class="matrix-cell category-header">
                    <h3>Comparison Criteria</h3>
                </div>
                ${programs.map(program => `
                    <div class="matrix-cell program-header">
                        <h4>${program.name}</h4>
                        <p class="program-location">${program.location.city}, ${program.location.state}</p>
                        <button class="btn-remove-program" data-program-id="${program.id}">
                            Remove
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
        
        // Add remove handlers
        header.querySelectorAll('.btn-remove-program').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.removeProgram(e.target.dataset.programId);
            });
        });
        
        return header;
    }
    
    createCategorySection(categoryName, fields, programs) {
        const section = document.createElement('div');
        section.className = 'matrix-category';
        
        // Category title
        const title = document.createElement('div');
        title.className = 'matrix-category-title';
        title.innerHTML = `<h4>${categoryName}</h4>`;
        section.appendChild(title);
        
        // Field rows
        fields.forEach(field => {
            const row = this.createFieldRow(field, programs);
            section.appendChild(row);
        });
        
        return section;
    }
    
    createFieldRow(fieldName, programs) {
        const row = document.createElement('div');
        row.className = 'matrix-row';
        
        // Field label
        const labelCell = document.createElement('div');
        labelCell.className = 'matrix-cell field-label';
        labelCell.textContent = this.formatFieldName(fieldName);
        row.appendChild(labelCell);
        
        // Program values
        programs.forEach(program => {
            const valueCell = document.createElement('div');
            valueCell.className = 'matrix-cell field-value';
            
            const value = this.getFieldValue(program, fieldName);
            const formattedValue = this.formatFieldValue(fieldName, value);
            
            // Highlight differences
            if (this.isDifferent(fieldName, programs)) {
                valueCell.classList.add('different');
            }
            
            // Special formatting for certain fields
            if (fieldName === 'insuranceAccepted' && Array.isArray(value)) {
                valueCell.innerHTML = this.formatInsuranceList(value);
            } else if (Array.isArray(value)) {
                valueCell.innerHTML = this.formatArrayValue(value);
            } else if (typeof value === 'boolean') {
                valueCell.innerHTML = this.formatBooleanValue(value);
            } else {
                valueCell.textContent = formattedValue || 'Not specified';
            }
            
            row.appendChild(valueCell);
        });
        
        return row;
    }
    
    getFieldValue(program, fieldName) {
        // Navigate nested object structure
        const fieldMap = {
            'levelsOfCare': program.clinical?.levelsOfCare,
            'primaryFocus': program.clinical?.primaryFocus,
            'specializations': program.clinical?.specializations,
            'evidenceBasedTherapies': program.clinical?.modalities?.evidenceBased,
            'experientialTherapies': program.clinical?.modalities?.experiential,
            'holisticTherapies': program.clinical?.modalities?.holistic,
            'agesServed': program.population?.ages,
            'gender': program.population?.gender,
            'specialPopulations': program.population?.specialPopulations,
            'programLength': program.structure?.lengthOfStay,
            'capacity': program.structure?.capacity,
            'staffRatio': program.structure?.staffRatio,
            'groupSize': program.structure?.groupSize,
            'medicalServices': program.medical?.services,
            'psychiatricServices': program.medical?.psychiatric,
            'medicationManagement': program.medical?.medicationManagement,
            'detoxServices': program.medical?.detox,
            'familyTherapy': program.family?.therapy,
            'familyEducation': program.family?.education,
            'familyVisitation': program.family?.visitation,
            'academicSupport': program.education?.academic,
            'vocationalTraining': program.education?.vocational,
            'collegePrep': program.education?.collegePrep,
            'insuranceAccepted': program.admissions?.insurance,
            'privatePayOptions': program.admissions?.privatePay,
            'financialAssistance': program.admissions?.financialAid,
            'admissionRequirements': program.admissions?.requirements,
            'accreditations': program.quality?.accreditations,
            'memberships': program.quality?.memberships,
            'successMetrics': program.quality?.outcomes,
            'setting': program.environment?.setting,
            'facilities': program.environment?.facilities,
            'roomTypes': program.environment?.roomTypes,
            'recreation': program.environment?.recreation,
            'aftercareServices': program.aftercare?.services,
            'alumniProgram': program.aftercare?.alumni,
            'transitionSupport': program.aftercare?.transition
        };
        
        return fieldMap[fieldName];
    }
    
    formatFieldName(fieldName) {
        // Convert camelCase to readable text
        return fieldName
            .replace(/([A-Z])/g, ' $1')
            .replace(/^./, str => str.toUpperCase())
            .trim();
    }
    
    formatFieldValue(fieldName, value) {
        if (value === null || value === undefined) {
            return 'Not specified';
        }
        
        if (Array.isArray(value)) {
            return value.length > 0 ? value.join(', ') : 'None specified';
        }
        
        if (typeof value === 'boolean') {
            return value ? 'Yes' : 'No';
        }
        
        return value.toString();
    }
    
    formatInsuranceList(insuranceArray) {
        if (!insuranceArray || insuranceArray.length === 0) {
            return '<span class="no-insurance">No insurance information</span>';
        }
        
        const majorInsurers = ['BCBS', 'Aetna', 'Cigna', 'United', 'Anthem', 'Humana'];
        const hasMajor = insuranceArray.some(ins => 
            majorInsurers.some(major => ins.includes(major))
        );
        
        return `
            <div class="insurance-list">
                ${hasMajor ? '<span class="has-major">‚úì Major insurers</span>' : ''}
                <ul>
                    ${insuranceArray.map(ins => `<li>${ins}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    formatArrayValue(array) {
        if (!array || array.length === 0) {
            return '<span class="empty-value">None specified</span>';
        }
        
        if (array.length > 3) {
            return `
                <div class="array-value">
                    <span class="count">${array.length} items</span>
                    <ul class="compact-list">
                        ${array.slice(0, 3).map(item => `<li>${item}</li>`).join('')}
                        <li class="more">...and ${array.length - 3} more</li>
                    </ul>
                </div>
            `;
        }
        
        return `
            <ul class="compact-list">
                ${array.map(item => `<li>${item}</li>`).join('')}
            </ul>
        `;
    }
    
    formatBooleanValue(value) {
        if (value) {
            return '<span class="boolean-yes">‚úì Yes</span>';
        }
        return '<span class="boolean-no">‚úó No</span>';
    }
    
    isDifferent(fieldName, programs) {
        const values = programs.map(p => this.getFieldValue(p, fieldName));
        
        // Handle array comparison
        if (Array.isArray(values[0])) {
            return !values.every(v => 
                JSON.stringify(v?.sort()) === JSON.stringify(values[0]?.sort())
            );
        }
        
        // Simple value comparison
        return !values.every(v => v === values[0]);
    }
    
    createMatrixActions() {
        const actions = document.createElement('div');
        actions.className = 'matrix-actions';
        
        actions.innerHTML = `
            <button class="btn btn-primary" onclick="comparisonMatrix.exportComparison()">
                Export Comparison (PDF)
            </button>
            <button class="btn btn-secondary" onclick="comparisonMatrix.printComparison()">
                Print Comparison
            </button>
            <button class="btn btn-secondary" onclick="comparisonMatrix.saveAsTemplate()">
                Save as Template
            </button>
            <button class="btn btn-tertiary" onclick="comparisonMatrix.clearComparison()">
                Clear Comparison
            </button>
        `;
        
        return actions;
    }
    
    exportComparison() {
        // Generate PDF export
        const matrix = this.generateComparisonMatrix();
        if (!matrix) {
            this.showNotification('Please select at least 2 programs to compare', 'warning');
            return;
        }
        
        // Create print-friendly version
        const printContent = this.createPrintVersion(matrix);
        
        // Generate PDF using browser print
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Program Comparison - ${new Date().toLocaleDateString()}</title>
                <style>
                    ${this.getPrintStyles()}
                </style>
            </head>
            <body>
                ${printContent}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.print();
    }
    
    printComparison() {
        window.print();
    }
    
    saveAsTemplate() {
        // Save current comparison criteria as a template
        const template = {
            name: prompt('Enter template name:'),
            date: new Date().toISOString(),
            programs: this.selectedPrograms,
            criteria: Object.keys(this.comparisonCategories)
        };
        
        if (template.name) {
            const templates = JSON.parse(localStorage.getItem('comparisonTemplates') || '[]');
            templates.push(template);
            localStorage.setItem('comparisonTemplates', JSON.stringify(templates));
            
            this.showNotification('Template saved successfully', 'success');
        }
    }
    
    getProgramData(programId) {
        // Get program data from the main programs array
        // This would connect to your existing program database
        return window.programsData?.find(p => p.id === programId) || {};
    }
    
    updateComparisonView() {
        const container = document.getElementById('comparison-container');
        if (!container) return;
        
        if (this.selectedPrograms.length === 0) {
            container.innerHTML = `
                <div class="comparison-empty">
                    <p>Select 2-4 programs to compare</p>
                </div>
            `;
        } else if (this.selectedPrograms.length === 1) {
            container.innerHTML = `
                <div class="comparison-waiting">
                    <p>1 program selected. Select at least 1 more to compare.</p>
                </div>
            `;
        } else {
            const matrix = this.generateComparisonMatrix();
            container.innerHTML = '';
            container.appendChild(matrix);
        }
    }
    
    getPrintStyles() {
        return `
            body { font-family: Arial, sans-serif; }
            .matrix-header { background: #f0f0f0; font-weight: bold; }
            .matrix-row { display: flex; border-bottom: 1px solid #ddd; }
            .matrix-cell { flex: 1; padding: 8px; }
            .matrix-category-title { background: #e0e0e0; padding: 5px; margin-top: 10px; }
            .different { background: #fff3cd; }
            @media print {
                .btn { display: none; }
                .matrix-actions { display: none; }
            }
        `;
    }
    
    createPrintVersion(matrix) {
        const clone = matrix.cloneNode(true);
        // Remove buttons and interactive elements
        clone.querySelectorAll('button').forEach(btn => btn.remove());
        return clone.outerHTML;
    }
    
    showNotification(message, type) {
        // Use session manager's notification if available
        if (window.sessionManager) {
            window.sessionManager.showNotification(message, type);
        } else {
            alert(message);
        }
    }
}

// Initialize comparison matrix globally
window.comparisonMatrix = new ComparisonMatrix();

    
    // ============= DOCUMENT GENERATOR =============
    // document-generator.js - Professional document generation for aftercare planning

class DocumentGenerator {
    constructor() {
        this.templates = {
            aftercareOptions: this.getAftercareOptionsTemplate(),
            aftercarePlan: this.getAftercarePlanTemplate(),
            dischargePacket: this.getDischargePacketTemplate()
        };
        
        this.documentQueue = [];
    }
    
    // ============= AFTERCARE OPTIONS DOCUMENT =============
    
    generateAftercareOptions(programs, sessionData = null) {
        if (!programs || programs.length === 0) {
            throw new Error('No programs selected for aftercare options document');
        }
        
        const document = {
            type: 'aftercareOptions',
            timestamp: new Date().toISOString(),
            sessionId: sessionData?.sessionId || 'DIRECT',
            content: this.buildAftercareOptionsContent(programs, sessionData)
        };
        
        // Track in session if available
        if (window.sessionManager) {
            window.sessionManager.addDocument({
                type: 'aftercareOptions',
                programs: programs.map(p => p.id)
            });
        }
        
        return document;
    }
    
    buildAftercareOptionsContent(programs, sessionData) {
        const date = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        let content = `
            <div class="document aftercare-options">
                <div class="document-header">
                    <h1>Aftercare Treatment Options</h1>
                    <div class="document-meta">
                        <p>Date: ${date}</p>
                        ${sessionData?.sessionId ? `<p>Session ID: ${sessionData.sessionId}</p>` : ''}
                        ${sessionData?.clinician ? `<p>Prepared by: ${sessionData.clinician}</p>` : ''}
                    </div>
                </div>
                
                <div class="document-intro">
                    <p>The following treatment programs have been identified as potential aftercare options based on the clinical assessment and treatment needs discussed.</p>
                </div>
                
                <div class="programs-section">
        `;
        
        programs.forEach((program, index) => {
            content += this.generateProgramSection(program, index + 1);
        });
        
        content += `
                </div>
                
                <div class="document-footer">
                    <h3>Next Steps</h3>
                    <ol>
                        <li>Review each program option carefully</li>
                        <li>Contact admissions departments for availability and specific questions</li>
                        <li>Verify insurance coverage and financial arrangements</li>
                        <li>Schedule tours or virtual visits when possible</li>
                        <li>Discuss options with your treatment team and family</li>
                    </ol>
                    
                    <div class="disclaimer">
                        <p><strong>Important Note:</strong> This document provides general information about treatment programs. 
                        Admission decisions are made by individual programs based on their assessment of clinical appropriateness 
                        and availability. Insurance coverage should be verified directly with your insurance provider and the 
                        treatment program.</p>
                    </div>
                </div>
            </div>
        `;
        
        return content;
    }
    
    generateProgramSection(program, number) {
        return `
            <div class="program-option">
                <h2>Option ${number}: ${program.name}</h2>
                
                <div class="program-overview">
                    <div class="program-location">
                        <strong>Location:</strong> ${program.location?.city || ''}, ${program.location?.state || ''}
                        ${program.location?.distance ? `(${program.location.distance} miles)` : ''}
                    </div>
                    
                    <div class="program-contact">
                        <strong>Contact:</strong>
                        ${program.contact?.phone ? `Phone: ${program.contact.phone}` : ''}
                        ${program.contact?.email ? `| Email: ${program.contact.email}` : ''}
                        ${program.website ? `<br>Website: ${program.website}` : ''}
                    </div>
                </div>
                
                <div class="clinical-services">
                    <h3>Clinical Services</h3>
                    
                    <div class="levels-of-care">
                        <strong>Levels of Care:</strong>
                        <ul>
                            ${(program.clinical?.levelsOfCare || []).map(level => 
                                `<li>${level}</li>`
                            ).join('')}
                        </ul>
                    </div>
                    
                    ${program.clinical?.primaryFocus ? `
                        <div class="primary-focus">
                            <strong>Primary Focus:</strong> ${program.clinical.primaryFocus}
                        </div>
                    ` : ''}
                    
                    ${program.clinical?.specializations?.length > 0 ? `
                        <div class="specializations">
                            <strong>Specializations:</strong>
                            ${program.clinical.specializations.join(', ')}
                        </div>
                    ` : ''}
                    
                    <div class="therapeutic-modalities">
                        <strong>Therapeutic Approaches:</strong>
                        <ul>
                            ${(program.clinical?.modalities?.evidenceBased || []).map(therapy => 
                                `<li>${therapy} (Evidence-Based)</li>`
                            ).join('')}
                            ${(program.clinical?.modalities?.experiential || []).map(therapy => 
                                `<li>${therapy} (Experiential)</li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
                
                <div class="program-details">
                    <h3>Program Details</h3>
                    
                    <div class="population">
                        <strong>Population Served:</strong>
                        ${program.population?.ages || 'All ages'}
                        ${program.population?.gender ? `| ${program.population.gender}` : ''}
                    </div>
                    
                    ${program.structure?.lengthOfStay ? `
                        <div class="length-of-stay">
                            <strong>Typical Length of Stay:</strong> ${program.structure.lengthOfStay}
                        </div>
                    ` : ''}
                    
                    ${program.family?.involvement ? `
                        <div class="family-program">
                            <strong>Family Involvement:</strong> ${program.family.involvement}
                        </div>
                    ` : ''}
                </div>
                
                <div class="admissions-insurance">
                    <h3>Admissions & Insurance</h3>
                    
                    ${program.admissions?.insurance?.length > 0 ? `
                        <div class="insurance">
                            <strong>Insurance Accepted:</strong>
                            ${program.admissions.insurance.join(', ')}
                        </div>
                    ` : ''}
                    
                    ${program.admissions?.requirements?.length > 0 ? `
                        <div class="requirements">
                            <strong>Admission Requirements:</strong>
                            <ul>
                                ${program.admissions.requirements.map(req => 
                                    `<li>${req}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
                
                ${program.quality?.accreditations?.length > 0 ? `
                    <div class="accreditations">
                        <strong>Accreditations:</strong> ${program.quality.accreditations.join(', ')}
                    </div>
                ` : ''}
                
                ${program.notes ? `
                    <div class="clinical-notes">
                        <strong>Clinical Notes:</strong> ${program.notes}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // ============= AFTERCARE PLAN DOCUMENT =============
    
    generateAftercarePlan(selectedProgram, transitionPlan, sessionData = null) {
        if (!selectedProgram) {
            throw new Error('No program selected for aftercare plan');
        }
        
        const document = {
            type: 'aftercarePlan',
            timestamp: new Date().toISOString(),
            sessionId: sessionData?.sessionId || 'DIRECT',
            content: this.buildAftercarePlanContent(selectedProgram, transitionPlan, sessionData)
        };
        
        // Track in session
        if (window.sessionManager) {
            window.sessionManager.addDocument({
                type: 'aftercarePlan',
                programs: [selectedProgram.id]
            });
        }
        
        return document;
    }
    
    buildAftercarePlanContent(program, plan, sessionData) {
        const date = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        return `
            <div class="document aftercare-plan">
                <div class="document-header">
                    <h1>Aftercare Treatment Plan</h1>
                    <div class="document-meta">
                        <p>Date: ${date}</p>
                        ${sessionData?.sessionId ? `<p>Session ID: ${sessionData.sessionId}</p>` : ''}
                        ${sessionData?.clinician ? `<p>Prepared by: ${sessionData.clinician}</p>` : ''}
                    </div>
                </div>
                
                <div class="selected-program">
                    <h2>Recommended Program</h2>
                    <div class="program-info">
                        <h3>${program.name}</h3>
                        <p>${program.location?.city}, ${program.location?.state}</p>
                        <p>Contact: ${program.contact?.phone || ''}</p>
                    </div>
                </div>
                
                <div class="transition-timeline">
                    <h2>Transition Timeline</h2>
                    <table class="timeline-table">
                        <tr>
                            <th>Phase</th>
                            <th>Timeline</th>
                            <th>Actions</th>
                        </tr>
                        <tr>
                            <td>Pre-Admission</td>
                            <td>${plan?.preAdmissionDate || '[To be determined]'}</td>
                            <td>
                                <ul>
                                    <li>Complete admission paperwork</li>
                                    <li>Insurance verification</li>
                                    <li>Medical clearance if required</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>Admission</td>
                            <td>${plan?.admissionDate || '[To be determined]'}</td>
                            <td>
                                <ul>
                                    <li>Intake assessment</li>
                                    <li>Orientation to program</li>
                                    <li>Initial treatment planning</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>Active Treatment</td>
                            <td>${plan?.treatmentDuration || program.structure?.lengthOfStay || '[Variable]'}</td>
                            <td>
                                <ul>
                                    <li>Participate in all program components</li>
                                    <li>Regular family involvement</li>
                                    <li>Progress monitoring</li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>Discharge Planning</td>
                            <td>${plan?.dischargePlanning || '2-4 weeks before completion'}</td>
                            <td>
                                <ul>
                                    <li>Aftercare planning</li>
                                    <li>Coordinate continuing care</li>
                                    <li>Establish support systems</li>
                                </ul>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div class="treatment-goals">
                    <h2>Treatment Goals</h2>
                    <ol>
                        ${(plan?.goals || [
                            'Stabilization and safety',
                            'Development of coping skills',
                            'Address underlying issues',
                            'Family healing and education',
                            'Relapse prevention planning',
                            'Transition to lower level of care'
                        ]).map(goal => `<li>${goal}</li>`).join('')}
                    </ol>
                </div>
                
                <div class="clinical-recommendations">
                    <h2>Clinical Recommendations</h2>
                    <ul>
                        <li><strong>Level of Care:</strong> ${program.clinical?.levelsOfCare?.[0] || 'As determined by assessment'}</li>
                        <li><strong>Primary Focus:</strong> ${program.clinical?.primaryFocus || 'Comprehensive treatment'}</li>
                        <li><strong>Therapeutic Modalities:</strong> ${(program.clinical?.modalities?.evidenceBased || []).join(', ') || 'Multi-modal approach'}</li>
                        <li><strong>Family Involvement:</strong> ${program.family?.involvement || 'Encouraged'}</li>
                    </ul>
                </div>
                
                <div class="follow-up">
                    <h2>Follow-Up Care</h2>
                    <p>Upon completion of the program, the following continuing care is recommended:</p>
                    <ul>
                        <li>Outpatient therapy (individual and/or group)</li>
                        <li>Psychiatric services as needed</li>
                        <li>Support group participation</li>
                        <li>Family therapy continuation</li>
                        <li>Academic/vocational support</li>
                        <li>Alumni program participation</li>
                    </ul>
                </div>
                
                <div class="signatures">
                    <h2>Acknowledgment</h2>
                    <p>This aftercare plan has been reviewed and discussed with all relevant parties.</p>
                    <div class="signature-lines">
                        <div class="signature-line">
                            <p>_______________________________</p>
                            <p>Patient/Guardian Signature</p>
                            <p>Date: _______________</p>
                        </div>
                        <div class="signature-line">
                            <p>_______________________________</p>
                            <p>Clinician Signature</p>
                            <p>Date: _______________</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ============= DISCHARGE PACKET COMPILER =============
    
    compileDischargePacket(components, sessionData = null) {
        const packet = {
            type: 'dischargePacket',
            timestamp: new Date().toISOString(),
            sessionId: sessionData?.sessionId || 'DIRECT',
            components: components,
            content: this.buildDischargePacket(components, sessionData)
        };
        
        // Track in session
        if (window.sessionManager) {
            window.sessionManager.addDocument({
                type: 'dischargePacket',
                components: components.map(c => c.type)
            });
        }
        
        return packet;
    }
    
    buildDischargePacket(components, sessionData) {
        const date = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        let content = `
            <div class="document discharge-packet">
                <div class="cover-page">
                    <h1>Discharge Documentation Packet</h1>
                    <div class="packet-meta">
                        <p>Prepared: ${date}</p>
                        ${sessionData?.sessionId ? `<p>Session ID: ${sessionData.sessionId}</p>` : ''}
                        ${sessionData?.clinician ? `<p>Clinician: ${sessionData.clinician}</p>` : ''}
                    </div>
                    
                    <div class="table-of-contents">
                        <h2>Contents</h2>
                        <ol>
                            ${components.map(component => 
                                `<li>${this.getComponentTitle(component.type)}</li>`
                            ).join('')}
                        </ol>
                    </div>
                </div>
                
                <div class="page-break"></div>
        `;
        
        // Add each component
        components.forEach(component => {
            content += component.content;
            content += '<div class="page-break"></div>';
        });
        
        content += `
            </div>
        `;
        
        return content;
    }
    
    getComponentTitle(type) {
        const titles = {
            'aftercareOptions': 'Aftercare Treatment Options',
            'aftercarePlan': 'Aftercare Treatment Plan',
            'insuranceAuth': 'Insurance Authorization Request',
            'clinicalSummary': 'Clinical Summary',
            'familyEducation': 'Family Education Materials',
            'programBrochures': 'Program Information',
            'consentForms': 'Consent Forms',
            'medicationList': 'Current Medications',
            'emergencyContacts': 'Emergency Contact Information'
        };
        
        return titles[type] || type;
    }
    
    // ============= EXPORT FUNCTIONS =============
    
    exportAsPDF(document) {
        // Create a new window for printing
        const printWindow = window.open('', '_blank');
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${document.type} - ${new Date().toLocaleDateString()}</title>
                <style>
                    ${this.getPrintStyles()}
                </style>
            </head>
            <body>
                ${document.content}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Auto-print after load
        printWindow.onload = function() {
            printWindow.print();
        };
    }
    
    exportAsWord(document) {
        // Create a blob with Word-compatible HTML
        const html = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                  xmlns:w='urn:schemas-microsoft-com:office:word' 
                  xmlns='http://www.w3.org/TR/REC-html40'>
            <head>
                <meta charset='utf-8'>
                <title>${document.type}</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    h1 { font-size: 24pt; }
                    h2 { font-size: 18pt; }
                    h3 { font-size: 14pt; }
                    .page-break { page-break-before: always; }
                </style>
            </head>
            <body>
                ${document.content}
            </body>
            </html>
        `;
        
        const blob = new Blob([html], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `${document.type}_${new Date().getTime()}.doc`;
        link.click();
        
        URL.revokeObjectURL(url);
    }
    
    getPrintStyles() {
        return `
            @page {
                size: letter;
                margin: 1in;
            }
            
            body {
                font-family: 'Times New Roman', serif;
                font-size: 12pt;
                line-height: 1.5;
                color: #000;
            }
            
            h1 {
                font-size: 24pt;
                margin-bottom: 12pt;
                text-align: center;
            }
            
            h2 {
                font-size: 18pt;
                margin-top: 18pt;
                margin-bottom: 12pt;
                border-bottom: 2px solid #000;
            }
            
            h3 {
                font-size: 14pt;
                margin-top: 12pt;
                margin-bottom: 8pt;
                font-weight: bold;
            }
            
            .document-header {
                border-bottom: 3px solid #000;
                padding-bottom: 12pt;
                margin-bottom: 24pt;
            }
            
            .document-meta {
                text-align: right;
                font-size: 10pt;
            }
            
            .program-option {
                page-break-inside: avoid;
                margin-bottom: 24pt;
                border: 1px solid #ccc;
                padding: 12pt;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 12pt 0;
            }
            
            th, td {
                border: 1px solid #000;
                padding: 8pt;
                text-align: left;
            }
            
            th {
                background-color: #f0f0f0;
                font-weight: bold;
            }
            
            .signature-lines {
                display: flex;
                justify-content: space-between;
                margin-top: 48pt;
            }
            
            .signature-line {
                width: 45%;
                text-align: center;
            }
            
            @media print {
                .no-print {
                    display: none;
                }
            }
        `;
    }
    
    // ============= TEMPLATE MANAGEMENT =============
    
    getAftercareOptionsTemplate() {
        return {
            sections: [
                'header',
                'introduction',
                'programOptions',
                'nextSteps',
                'disclaimer'
            ],
            requiredFields: [
                'programs',
                'date'
            ]
        };
    }
    
    getAftercarePlanTemplate() {
        return {
            sections: [
                'header',
                'selectedProgram',
                'transitionTimeline',
                'treatmentGoals',
                'clinicalRecommendations',
                'followUpCare',
                'signatures'
            ],
            requiredFields: [
                'program',
                'date'
            ]
        };
    }
    
    getDischargePacketTemplate() {
        return {
            sections: [
                'coverPage',
                'tableOfContents',
                'components'
            ],
            requiredFields: [
                'components',
                'date'
            ]
        };
    }
}

// Initialize document generator globally
window.documentGenerator = new DocumentGenerator();

    
    console.log('[CareConnect] ‚úÖ All systems loaded and ready!');
    
})();

</script>
</body>
</html>
