<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect Pro - Professional Aftercare Document Builder</title>
    
    <!-- Content Security Policy for enhanced security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https://tile.openstreetmap.org https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://tile.openstreetmap.fr https://a.tile.openstreetmap.fr https://b.tile.openstreetmap.fr https://c.tile.openstreetmap.fr https://server.arcgisonline.com https://services.arcgisonline.com https://*.opentopomap.org https://*.basemaps.cartocdn.com; font-src 'self' data:; connect-src 'self' https://nominatim.openstreetmap.org https://tile.openstreetmap.org https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://tile.openstreetmap.fr https://a.tile.openstreetmap.fr https://b.tile.openstreetmap.fr https://c.tile.openstreetmap.fr https://server.arcgisonline.com https://services.arcgisonline.com https://*.opentopomap.org https://*.basemaps.cartocdn.com; object-src 'none'; base-uri 'self'; form-action 'self';">
    
    <!-- PDF Libraries for document merging -->
    <!-- Libraries loaded locally for HIPAA compliance - no external CDN -->
    <script src="libs/pdf-lib.min.js"></script>
    <script src="libs/jspdf.umd.min.js"></script>
    <script src="libs/html2canvas.min.js"></script>
    
    
    <!-- Enhanced Features Libraries -->
    <script src="libs/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="libs/select2.min.css">
    <script src="libs/select2.min.js"></script>
    <link rel="stylesheet" href="libs/leaflet.css">
    <script src="libs/leaflet.js"></script>
    <script src="libs/chart.min.js"></script>
    <script src="libs/d3.v7.min.js"></script>
    
    <!-- Enhanced Features Scripts -->
    <script>
        // Global error handler to prevent white screen
        window.addEventListener('error', function(e) {
            console.error('üî• Global error caught:', e.error || e.message);
            // Prevent white screen by showing error message
            if (e.error && e.error.message) {
                const errorMsg = e.error.message;
                if (errorMsg.includes('is not defined') || errorMsg.includes('is not a constructor')) {
                    console.error('‚ö†Ô∏è Critical script loading error detected');
                    // Don't reload automatically, just log
                }
            }
            return false; // Prevent default error handling
        });
        
        // Ensure body is always visible
        window.addEventListener('DOMContentLoaded', function() {
            document.body.style.opacity = '1';
            document.body.style.visibility = 'visible';
            document.body.style.display = 'block';
            
            // AGGRESSIVE DASHBOARD PROTECTION
            window.blockTabSwitches = false; // Allow tab switches (we fixed the tab switching logic)
            
            // Monitor dashboard for any changes/removal
            const dashboardObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.removedNodes.length > 0) {
                        console.error('üö® DASHBOARD CONTENT REMOVED!', {
                            removed: mutation.removedNodes,
                            target: mutation.target.id || mutation.target.className,
                            stack: new Error().stack
                        });
                        
                        // Check if dashboard tab was cleared
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (dashboardTab && !dashboardTab.querySelector('.dashboard-container')) {
                            console.error('üî• Dashboard container missing - re-injecting!');
                            window.injectSimpleDashboard();
                        }
                    }
                    
                    if (mutation.type === 'attributes') {
                        if (mutation.attributeName === 'style' || mutation.attributeName === 'class') {
                            const target = mutation.target;
                            if (target.id === 'dashboardTab' || target.classList.contains('dashboard-container')) {
                                console.warn('‚ö†Ô∏è Dashboard style/class changed:', {
                                    element: target.id || target.className,
                                    attribute: mutation.attributeName,
                                    oldValue: mutation.oldValue,
                                    newValue: target.getAttribute(mutation.attributeName)
                                });
                                
                                // Force dashboard visible if it was hidden
                                if (target.id === 'dashboardTab') {
                                    const style = window.getComputedStyle(target);
                                    if (style.display === 'none') {
                                        console.error('üî• Dashboard was hidden - forcing visible!');
                                        target.style.display = 'block !important';
                                        target.style.visibility = 'visible !important';
                                        target.style.opacity = '1 !important';
                                    }
                                }
                            }
                        }
                    }
                });
            });
            
            // Start observing once dashboard exists
            setTimeout(() => {
                const dashboardTab = document.getElementById('dashboardTab');
                if (dashboardTab) {
                    dashboardObserver.observe(dashboardTab, {
                        childList: true,
                        attributes: true,
                        attributeOldValue: true,
                        subtree: true
                    });
                    console.log('üëÅÔ∏è Dashboard observer activated');
                }
            }, 1000);
            
            // KEYBOARD SHORTCUT: Press 'D' key to force dashboard
            document.addEventListener('keydown', function(e) {
                if (e.key === 'd' || e.key === 'D') {
                    console.log('üéØ Forcing dashboard display with D key');
                    
                    // Switch to dashboard tab
                    const dashboardBtn = document.querySelector('button[onclick*="dashboard"]');
                    if (dashboardBtn) dashboardBtn.click();
                    
                    // Ensure dashboard tab is active
                    const dashboardTab = document.getElementById('dashboardTab');
                    if (dashboardTab) {
                        // Remove active from all tabs
                        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                        
                        // Make dashboard active
                        dashboardTab.classList.add('active');
                        dashboardTab.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important; position: relative !important; z-index: 999999 !important;';
                        
                        // Check if it has content
                        if (!dashboardTab.querySelector('.dashboard-container')) {
                            console.log('üî® Injecting fallback dashboard');
                            window.injectSimpleDashboard();
                        }
                    }
                    
                    // Block future tab switches
                    window.blockTabSwitches = true;
                    console.log('‚úÖ Dashboard forced and tab switches blocked');
                }
            });
            
            console.log('üí° TIP: Press the "D" key at any time to force the dashboard to appear!');
        });
        
        // NUCLEAR OPTION: Force dashboard to stay visible
        setInterval(function() {
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            const dashboardTab = document.getElementById('dashboardTab');
            const dashboardContainer = document.querySelector('.dashboard-container');
            
            if (loginScreen) {
                loginScreen.style.display = 'none';
                loginScreen.style.visibility = 'hidden';
                loginScreen.style.opacity = '0';
                loginScreen.style.zIndex = '-9999';
                loginScreen.style.position = 'fixed';
                loginScreen.style.left = '-9999px';
            }
            
            if (mainApp) {
                mainApp.style.display = 'block';
                mainApp.style.visibility = 'visible';
                mainApp.style.opacity = '1';
                mainApp.style.background = 'white';
                mainApp.style.position = 'relative';
                mainApp.style.zIndex = '1';
            }
            
            if (dashboardTab && dashboardTab.classList.contains('active')) {
                dashboardTab.style.display = 'block';
                dashboardTab.style.visibility = 'visible';
                dashboardTab.style.opacity = '1';
                dashboardTab.style.background = 'white';
                dashboardTab.style.color = '#1a1a1a';
                dashboardTab.style.position = 'relative';
                dashboardTab.style.zIndex = '9999';
            }
            
            if (dashboardContainer) {
                dashboardContainer.style.display = 'block';
                dashboardContainer.style.visibility = 'visible';
                dashboardContainer.style.opacity = '1';
                dashboardContainer.style.background = '#f8f9fa';
                dashboardContainer.style.color = '#1a1a1a';
            }
            
            // Ensure body is visible
            document.body.style.display = 'block';
            document.body.style.visibility = 'visible';
            document.body.style.opacity = '1';
            document.body.style.background = 'white';
            document.body.style.color = '#1a1a1a';
            
            // Force all text elements to be visible
            const allTexts = document.querySelectorAll('.dashboard-container *');
            allTexts.forEach(el => {
                if (el.style.color === 'white' || el.style.color === 'rgb(255, 255, 255)') {
                    el.style.color = '#1a1a1a';
                }
            });
            
            // Check if dashboard content was removed and log it
            const widgets = document.querySelectorAll('.dashboard-widget');
            if (dashboardTab && dashboardTab.classList.contains('active') && widgets.length === 0) {
                console.warn('Dashboard widgets missing! Container innerHTML:', dashboardContainer?.innerHTML?.substring(0, 100));
            }
        }, 100); // Check every 100ms
        
        // Prevent any element from clearing dashboard innerHTML
        (function() {
            const originalInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML');
            Object.defineProperty(Element.prototype, 'innerHTML', {
                set: function(value) {
                    // Check if this is a dashboard element being cleared
                    if (this.classList && (this.classList.contains('dashboard-container') || 
                        this.classList.contains('dashboard-widget') ||
                        this.id === 'dashboardTab')) {
                        
                        if (value === '' || value === null || value === undefined) {
                            console.warn('‚ö†Ô∏è Blocked attempt to clear dashboard element:', this.id || this.className);
                            return; // Don't allow clearing
                        }
                    }
                    // Allow normal innerHTML setting
                    return originalInnerHTML.set.call(this, value);
                },
                get: originalInnerHTML.get
            });
        })();
        
        // Aggressive cache busting with random component
        const cacheBust = Date.now() + '-' + Math.random().toString(36).substring(7);
        
        // Function to clear all caches and reload
        window.clearCacheAndReload = function() {
            console.log('üßπ Clearing all caches...');
            // Clear IndexedDB
            if ('indexedDB' in window) {
                indexedDB.databases().then(databases => {
                    databases.forEach(db => {
                        indexedDB.deleteDatabase(db.name);
                        console.log('Deleted IndexedDB:', db.name);
                    });
                });
            }
            // Clear localStorage and sessionStorage
            localStorage.clear();
            sessionStorage.clear();
            // Clear service worker cache
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                });
            }
            // Force reload with cache bypass
            window.location.reload(true);
        };
        
        // Function to load script with retry
        function loadScript(src, retries = 3) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${src}?v=${cacheBust}`;
                script.onload = () => {
                    console.log(`‚úÖ Loaded: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    if (retries > 0) {
                        console.warn(`‚ö†Ô∏è Retrying ${src}... (${retries} attempts left)`);
                        setTimeout(() => loadScript(src, retries - 1).then(resolve).catch(reject), 500);
                    } else {
                        console.error(`‚ùå Failed to load: ${src}`);
                        reject(new Error(`Failed to load ${src}`));
                    }
                };
                document.head.appendChild(script);
            });
        }
        
        // Load core scripts
        const scripts = [
            'feature-flags.js',
            'performance-monitor.js', 
            'indexed-db-manager.js',
            'intelligent-matching.js',
            'multi-client-workflow.js',
            'advanced-filters.js',
            'client-manager.js',
            'houses-manager.js',
            'milestones-manager.js',
            'aftercare-manager.js'
        ];
        
        // Load scripts sequentially to ensure proper order
        Promise.all(scripts.map(src => loadScript(src))).then(() => {
            console.log('‚úÖ All core scripts loaded');
            
            // Load dashboard scripts after core scripts
            const dashboardScripts = ['dashboard-manager.js', 'dashboard-widgets.js', 'dashboard-diagnostics.js'];
            return Promise.all(dashboardScripts.map(src => loadScript(src)));
        }).then(() => {
            console.log('‚úÖ All dashboard scripts loaded');
            
            // Make dashboard manager globally available
            if (typeof dashboardManager !== 'undefined') {
                window.dashboardManager = dashboardManager;
            }
            if (typeof dashboardWidgets !== 'undefined') {
                window.dashboardWidgets = dashboardWidgets;
            }
            
            // Handle IndexedDB version errors
            window.addEventListener('error', function(event) {
                if (event.message && event.message.includes('VersionError')) {
                    console.error('üîÑ IndexedDB version mismatch detected. Please clear cache.');
                    if (confirm('IndexedDB version mismatch detected. Clear cache and reload?')) {
                        window.clearCacheAndReload();
                    }
                }
            });
        }).catch(error => {
            console.error('‚ùå Script loading error:', error);
        });
    </script>
    
    <!-- Client Tracking Styles -->
    <style>
        /* Client Tracking Styles */
        .tab-navigation {
            display: flex !important;
            gap: 8px;
            margin-bottom: 20px;
            margin-top: 10px;
            background: linear-gradient(to right, #e0e7ff, #fce7f3);
            padding: 8px;
            border-radius: 12px;
            visibility: visible !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 2px solid #6366f1;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            background: #f9fafb;
            color: #374151;
            transform: translateY(-1px);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }
        
        .tab-content {
            display: none;
            height: calc(100% - 60px);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .client-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .client-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .client-header h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }
        
        .current-client-banner {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .current-client-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-avatar {
            width: 50px;
            height: 50px;
            background: white;
            color: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .client-details {
            flex: 1;
        }
        
        .client-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .client-id {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .client-actions {
            display: flex;
            gap: 10px;
        }
        
        .client-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .client-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .client-quick-add {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .client-form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .client-form-group {
            flex: 1;
        }
        
        .client-form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #4b5563;
            font-weight: 500;
        }
        
        .client-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .client-form-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .add-client-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-client-btn:hover {
            background: #5558e3;
        }
        
        .client-list-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .client-list-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-list-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-filter-tabs {
            display: flex;
            gap: 10px;
        }
        
        .client-filter-tab {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .client-filter-tab:hover {
            border-color: #d1d5db;
            color: #4b5563;
        }
        
        .client-filter-tab.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .client-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .client-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-card:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .client-card.selected {
            background: #ede9fe;
            border-color: #8b5cf6;
        }
        
        .client-card-avatar {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .client-card-info {
            flex: 1;
        }
        
        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .client-card-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-card-kipu {
            font-size: 14px;
            color: #6b7280;
        }
        
        .client-card-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #6b7280;
        }
        
        .client-status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .client-status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .client-status-badge.waitlist {
            background: #fef3c7;
            color: #92400e;
        }
        
        .client-status-badge.discharged {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .client-empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .client-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .client-search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        /* Alert Animation */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Milestone Indicator Styles */
        .milestone-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .milestone-indicator.complete {
            background-color: #10b981;
            color: white;
        }
        
        .milestone-indicator.overdue {
            background-color: #ef4444;
            color: white;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .milestone-indicator.due-today {
            background-color: #f59e0b;
            color: white;
        }
        
        .milestone-indicator.due-soon {
            background-color: #f59e0b;
            color: white;
            opacity: 0.8;
        }
        
        .milestone-indicator.in-progress {
            background-color: #3b82f6;
            color: white;
        }
        
        .milestone-indicator.pending {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .8;
            }
        }
        
        /* Days in care color coding */
        .days-in-care {
            font-weight: 500;
        }
        
        td.days-in-care {
            text-align: center;
        }
        
        /* Color code days based on milestones */
        .days-13 { color: #f59e0b; font-weight: 600; }
        .days-14 { color: #f59e0b; font-weight: 600; }
        .days-16plus { color: #ef4444; font-weight: 600; }
        
        /* CM Tracker House Navigation */
        .cm-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #f9fafb;
        }
        
        .house-navigation {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 0;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .house-tabs {
            display: flex;
            gap: 0;
            flex: 1;
            overflow-x: auto;
        }
        
        .house-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        
        .house-tab:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .house-tab.active {
            color: #6366f1;
            background: #eef2ff;
            border-bottom-color: #6366f1;
        }
        
        .house-tab .client-count {
            margin-left: 5px;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: normal;
        }
        
        .house-tab.active .client-count {
            background: #6366f1;
            color: white;
        }
        
        .house-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .cm-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .cm-action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .cm-action-btn:hover {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .cm-action-btn.primary {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .cm-action-btn.primary:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }
        
        .clients-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .clients-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .clients-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .clients-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            color: #1f2937;
        }
        
        .clients-table tr:hover {
            background: #f9fafb;
        }
        
        .client-initials {
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
        }
        
        .client-initials:hover {
            color: #6366f1;
            text-decoration: underline;
        }
        
        .days-in-care {
            font-weight: 500;
            color: #6b7280;
        }
        
        .team-member {
            font-size: 13px;
            color: #6b7280;
        }
        
        .milestone-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .milestone-indicator.complete {
            background: #10b981;
            color: white;
        }
        
        .milestone-indicator.pending {
            background: #f3f4f6;
            color: #9ca3af;
            border: 1px solid #e5e7eb;
        }
        
        .milestone-indicator.overdue {
            background: #ef4444;
            color: white;
        }
        
        .aftercare-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .aftercare-status.sent {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .aftercare-status.engaged {
            background: #fef3c7;
            color: #92400e;
        }
        
        .aftercare-status.accepted {
            background: #d1fae5;
            color: #065f46;
        }
        
        .aftercare-status.declined {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 4px 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #e5e7eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .empty-state-text {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 500px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #1f2937;
            font-size: 20px;
        }
        
        .modal-content label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }
        
        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
    </style>
    
    <!-- Client Tracking JavaScript -->
    <script>
        // CM Tracker Functions
        let currentHouseId = 'house_nest';
        let currentClientFilter = 'active';
        let cmTrackerInitialized = false;
        
        // Initialize CM Tracker
        async function initializeCMTracker() {
            try {
                // Check if managers are available
                if (!window.dbManager) {
                    console.error('DBManager not available for CM Tracker');
                    return;
                }
                
                // Initialize houses manager
                if (!window.housesManager) {
                    window.housesManager = new HousesManager(window.dbManager);
                    await window.housesManager.initialize();
                }
                housesManager = window.housesManager;
                
                // Initialize milestones manager
                if (!window.milestonesManager) {
                    window.milestonesManager = new MilestonesManager(window.dbManager);
                }
                milestonesManager = window.milestonesManager;
                
                // Initialize aftercare manager
                if (!window.aftercareManager) {
                    window.aftercareManager = new AftercareManager(window.dbManager);
                }
                aftercareManager = window.aftercareManager;
                
                // Initialize houses in database
                await window.dbManager.initializeHouses();
                
                // Build house navigation
                await buildHouseNavigation();
                
                // Load initial house
                await loadHouseView(currentHouseId);
                
                cmTrackerInitialized = true;
                console.log('‚úÖ CM Tracker initialized');
            } catch (error) {
                console.error('Failed to initialize CM Tracker:', error);
            }
        }
        
        // Build house navigation tabs
        async function buildHouseNavigation() {
            const houseTabs = document.getElementById('houseTabs');
            if (!houseTabs) return;
            
            houseTabs.innerHTML = '';
            
            // Get houses
            const houses = await housesManager.getActiveHouses();
            
            // Create tabs for each house
            for (let i = 0; i < houses.length; i++) {
                const house = houses[i];
                const clientCount = await housesManager.getClientCount(house.id, true);
                
                const tab = document.createElement('button');
                tab.className = 'house-tab';
                if (i === 0) tab.className += ' active'; // First house is active by default
                tab.id = `houseTab_${house.id}`;
                tab.onclick = () => switchToHouse(house.id);
                
                tab.innerHTML = `
                    ${house.name}
                    <span class="client-count">${clientCount}</span>
                `;
                
                houseTabs.appendChild(tab);
            }
            
            // Add discharged clients tab
            const dischargedCount = await getDischargedClientsCount();
            const dischargedTab = document.createElement('button');
            dischargedTab.className = 'house-tab';
            dischargedTab.id = 'houseTab_discharged';
            dischargedTab.onclick = () => switchToHouse('discharged');
            dischargedTab.innerHTML = `
                Discharged
                <span class="client-count">${dischargedCount}</span>
            `;
            houseTabs.appendChild(dischargedTab);
        }
        
        // Get discharged clients count
        async function getDischargedClientsCount() {
            if (!window.clientManager) return 0;
            const discharged = await window.clientManager.getDischargedClients();
            return discharged.length;
        }
        
        // Switch to a house
        async function switchToHouse(houseId) {
            currentHouseId = houseId;
            
            // Update active tab
            document.querySelectorAll('.house-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.getElementById(`houseTab_${houseId}`);
            if (activeTab) activeTab.classList.add('active');
            
            // Load house view
            await loadHouseView(houseId);
        }
        
        // Load house view
        async function loadHouseView(houseId) {
            const container = document.getElementById('houseClientsList');
            if (!container) return;
            
            try {
                let clients;
                let houseName;
                
                if (houseId === 'discharged') {
                    clients = await window.clientManager.getDischargedClients();
                    houseName = 'Discharged Clients';
                } else {
                    const house = housesManager.getHouseById(houseId);
                    if (!house) return;
                    houseName = house.name;
                    clients = await window.clientManager.getClientsByHouse(houseId, currentClientFilter === 'active');
                }
                
                if (clients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üè†</div>
                            <div class="empty-state-title">No clients in ${houseName}</div>
                            <div class="empty-state-text">Click "Add Client" to add a new client to this house</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = await buildClientsTable(clients, houseName);
                }
            } catch (error) {
                console.error('Failed to load house view:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Error loading clients</div>
                        <div class="empty-state-text">${error.message}</div>
                    </div>
                `;
            }
        }
        
        // Build clients table
        async function buildClientsTable(clients, houseName) {
            const table = document.createElement('div');
            table.className = 'clients-table-container';
            
            // Add export controls
            let tableHTML = `
                <div class="table-controls" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 14px; color: #6b7280;">
                        Showing ${clients.length} client${clients.length !== 1 ? 's' : ''} in ${houseName}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportCurrentView()" class="export-btn" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                            üìÑ Export to CSV
                        </button>
                        <button onclick="exportAllData()" class="export-btn" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                            üìä Export All Houses
                        </button>
                    </div>
                </div>
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Kipu ID</th>
                            <th>Days</th>
                            <th>Coach</th>
                            <th>CM</th>
                            <th>Thread</th>
                            <th>Options</th>
                            <th>Packet</th>
                            <th>Aftercare</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const client of clients) {
                const daysInCare = window.clientManager.calculateDaysInCare(client);
                
                // Apply CSS class based on days in care
                let daysClass = '';
                if (daysInCare === 13) {
                    daysClass = 'days-13';
                } else if (daysInCare === 14) {
                    daysClass = 'days-14';
                } else if (daysInCare >= 16) {
                    daysClass = 'days-16plus';
                }
                
                // Get milestones
                let milestones = [];
                try {
                    milestones = await milestonesManager.getClientMilestones(client.id);
                } catch (e) {
                    // Client may not have milestones initialized yet
                }
                
                // Get specific milestone statuses
                const threadMilestone = milestones.find(m => m.milestone === 'aftercare_thread');
                const optionsMilestone = milestones.find(m => m.milestone === 'options_doc');
                const packetMilestone = milestones.find(m => m.milestone === 'discharge_packet');
                
                const threadDisplay = threadMilestone 
                    ? milestonesManager.getMilestoneDisplayStatus(threadMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                    
                const optionsDisplay = optionsMilestone
                    ? milestonesManager.getMilestoneDisplayStatus(optionsMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                    
                const packetDisplay = packetMilestone
                    ? milestonesManager.getMilestoneDisplayStatus(packetMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                
                // Get aftercare options
                let aftercareOptions = [];
                let aftercareDisplay = 'No options';
                try {
                    aftercareOptions = await aftercareManager.getClientAftercareOptions(client.id);
                    if (aftercareOptions.length > 0) {
                        const summary = aftercareManager.getAftercareSummary(aftercareOptions);
                        aftercareDisplay = summary.displayString;
                    }
                } catch (e) {
                    // Client may not have aftercare options yet
                }
                
                tableHTML += `
                    <tr>
                        <td><span class="client-initials" onclick="viewClientDetails('${client.id}')">${client.initials}</span></td>
                        <td>${client.kipuId}</td>
                        <td class="days-in-care ${daysClass}">${daysInCare}</td>
                        <td class="team-member">${client.clinicalCoachInitials || '-'}</td>
                        <td class="team-member">${client.caseManagerInitials || '-'}</td>
                        <td>
                            <span class="milestone-indicator ${threadDisplay.class}" 
                                  title="${threadDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'aftercare_thread')">
                                ${threadDisplay.icon}
                            </span>
                        </td>
                        <td>
                            <span class="milestone-indicator ${optionsDisplay.class}" 
                                  title="${optionsDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'options_doc')">
                                ${optionsDisplay.icon}
                            </span>
                        </td>
                        <td>
                            <span class="milestone-indicator ${packetDisplay.class}" 
                                  title="${packetDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'discharge_packet')">
                                ${packetDisplay.icon}
                            </span>
                        </td>
                        <td><span class="aftercare-status" style="font-size: 12px;">${aftercareDisplay}</span></td>
                        <td class="action-buttons">
                            <button class="action-btn" onclick="viewClientDetails('${client.id}')">View</button>
                            <button class="action-btn" onclick="editClient('${client.id}')">Edit</button>
                            <button class="action-btn" onclick="generateClientDocument('${client.id}')">Doc</button>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            return tableHTML;
        }
        
        // Export current view to CSV
        async function exportCurrentView() {
            try {
                // Load export module if not already loaded
                if (!window.CMTrackerExport) {
                    const script = document.createElement('script');
                    script.src = 'cm-tracker-export.js';
                    document.head.appendChild(script);
                    
                    // Wait for script to load
                    await new Promise(resolve => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000); // Timeout fallback
                    });
                }
                
                // Initialize export module if not loaded
                if (!window.cmTrackerExport) {
                    window.cmTrackerExport = new CMTrackerExport();
                }
                
                // Export current house
                const options = {
                    houseId: currentHouseId === 'discharged' ? null : currentHouseId,
                    includeArchived: currentHouseId === 'discharged'
                };
                
                const result = await window.cmTrackerExport.exportToCSV(options);
                
                if (result.success) {
                    showAlert(`Exported ${result.rowCount - 1} clients successfully`, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                showAlert('Failed to export data: ' + error.message, 'error');
            }
        }
        
        // Export all data to CSV
        async function exportAllData() {
            try {
                // Load export module if not already loaded
                if (!window.CMTrackerExport) {
                    const script = document.createElement('script');
                    script.src = 'cm-tracker-export.js';
                    document.head.appendChild(script);
                    
                    // Wait for script to load
                    await new Promise(resolve => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000); // Timeout fallback
                    });
                }
                
                // Initialize export module if not loaded
                if (!window.cmTrackerExport) {
                    window.cmTrackerExport = new CMTrackerExport();
                }
                
                // Export all houses
                const result = await window.cmTrackerExport.exportToCSV({
                    includeArchived: true
                });
                
                if (result.success) {
                    showAlert(`Exported ${result.rowCount - 1} clients successfully`, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                showAlert('Failed to export data: ' + error.message, 'error');
            }
        }
        
        // Ensure tab navigation is visible
        function ensureTabNavigationVisible() {
            const tabNav = document.querySelector('.tab-navigation');
            if (!tabNav) {
                // Tab navigation doesn't exist, create it
                const programsPanel = document.querySelector('.programs-panel');
                if (programsPanel) {
                    const tabNavHTML = `
                        <div class="tab-navigation" style="display: flex !important; gap: 8px; margin-bottom: 20px; visibility: visible !important; z-index: 10; position: relative;">
                            <button class="tab-btn" onclick="switchTab('dashboard')">
                                <span>üéØ Dashboard</span>
                            </button>
                            <button class="tab-btn active" onclick="switchTab('programs')">
                                <span>üìã Programs</span>
                            </button>
                            <button class="tab-btn" onclick="switchTab('clients')">
                                <span>üë• Clients</span>
                            </button>
                        </div>
                    `;
                    // Insert at the beginning of programs-panel
                    programsPanel.insertAdjacentHTML('afterbegin', tabNavHTML);
                    console.log('‚úÖ Tab navigation created dynamically');
                }
            } else {
                // Ensure it's visible
                tabNav.style.display = 'flex';
                tabNav.style.visibility = 'visible';
                tabNav.style.zIndex = '10';
                tabNav.style.position = 'relative';
                console.log('‚úÖ Tab navigation verified visible');
            }
        }
        
        // Initialize Client Tracker (for backward compatibility)
        function initializeClientTracker() {
            // Ensure tab navigation is visible first
            ensureTabNavigationVisible();
            
            // Initialize CM Tracker when client tab is opened
            if (!cmTrackerInitialized) {
                initializeCMTracker();
            }
        }
        
        // Manual initialization function
        async function initializeClientManagerManually() {
            try {
                console.log('Attempting manual ClientManager initialization...');
                
                // Check if dbManager exists, if not create it
                if (!window.dbManager) {
                    console.log('Creating IndexedDBManager...');
                    window.dbManager = new IndexedDBManager();
                    await window.dbManager.init();
                }
                
                // Create ClientManager
                console.log('Creating ClientManager...');
                window.clientManager = new ClientManager(window.dbManager);
                await window.clientManager.initialize();
                
                console.log('‚úÖ ClientManager manually initialized:', window.clientManager);
                
                // Initialize the UI
                initializeClientTracker();
                
                // Hide the warning
                const statusDiv = document.getElementById('clientManagerStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
                
                showAlert('Client manager initialized successfully!', 'success');
            } catch (error) {
                console.error('Failed to manually initialize ClientManager:', error);
                showAlert('Failed to initialize client manager: ' + error.message, 'error');
            }
        }
        
        // Handle client manager events
        function handleClientEvent(event, data) {
            switch (event) {
                case 'current-client-changed':
                    updateCurrentClientDisplay();
                    refreshSelectedPrograms();
                    break;
                case 'client-created':
                case 'client-updated':
                    refreshClientsList();
                    if (data.id === clientManager.getCurrentClient()?.id) {
                        updateCurrentClientDisplay();
                    }
                    break;
            }
        }
        
        // Switch between tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the clicked button
            const clickedBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => 
                btn.textContent.toLowerCase().includes(tab.toLowerCase()) ||
                (tab === 'programs' && btn.textContent.includes('üìã')) ||
                (tab === 'clients' && btn.textContent.includes('üë§'))
            );
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tab === 'programs') {
                const programsTab = document.getElementById('programsTab');
                if (programsTab) programsTab.classList.add('active');
            } else if (tab === 'clients') {
                const clientsTab = document.getElementById('clientsTab');
                if (clientsTab) clientsTab.classList.add('active');
                
                // Initialize CM Tracker if not already initialized
                if (!cmTrackerInitialized) {
                    initializeCMTracker();
                }
            }
        }
        
        // Quick add client
        async function quickAddClient() {
            // Check if clientManager is initialized
            if (!window.clientManager) {
                showAlert('Client manager is not ready. Please refresh the page.', 'error');
                console.error('ClientManager not initialized');
                return;
            }
            
            const initials = document.getElementById('newClientInitials').value.trim().toUpperCase();
            const kipuId = document.getElementById('newClientKipu').value.trim();
            
            if (!initials || !kipuId) {
                showAlert('Please enter both initials and Kipu ID', 'error');
                return;
            }
            
            try {
                const newClient = await window.clientManager.createClient({
                    initials,
                    kipuId
                });
                
                // Clear form
                document.getElementById('newClientInitials').value = '';
                document.getElementById('newClientKipu').value = '';
                
                // Set as current client
                await window.clientManager.setCurrentClient(newClient.id);
                
                showAlert(`Client ${initials} added successfully!`, 'success');
                refreshClientsList();
            } catch (error) {
                showAlert(error.message, 'error');
                console.error('Error creating client:', error);
            }
        }
        
        // Filter clients
        function filterClients(filter) {
            currentClientFilter = filter;
            
            // Update filter tabs
            document.querySelectorAll('.client-filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            refreshClientsList();
        }
        
        // Search clients
        let clientSearchTimeout;
        function searchClients(query) {
            clearTimeout(clientSearchTimeout);
            clientSearchTimeout = setTimeout(async () => {
                const results = await clientManager.searchClients(query);
                displayClients(results);
            }, 300);
        }
        
        // Refresh clients list
        async function refreshClientsList() {
            // Check if old UI container exists (may not exist in CM Tracker view)
            const clientsContainer = document.getElementById('clientsList');
            if (!clientsContainer) {
                // Old UI doesn't exist, likely using CM Tracker
                return;
            }
            
            const allClients = await clientManager.getAllClients();
            let filteredClients = allClients;
            
            // Apply status filter
            if (currentClientFilter !== 'all') {
                filteredClients = allClients.filter(client => 
                    client.status === currentClientFilter
                );
            }
            
            // Apply search if active
            const searchBox = document.getElementById('clientSearchBox');
            if (searchBox) {
                const searchQuery = searchBox.value;
                if (searchQuery) {
                    const searchLower = searchQuery.toLowerCase();
                    filteredClients = filteredClients.filter(client => 
                        client.initials.toLowerCase().includes(searchLower) ||
                        client.kipuId.includes(searchQuery)
                    );
                }
            }
            
            displayClients(filteredClients);
        }
        
        // Display clients
        function displayClients(clients) {
            const container = document.getElementById('clientsList');
            
            // Check if old UI container exists (may not exist in CM Tracker view)
            if (!container) {
                // Old UI doesn't exist, likely using CM Tracker
                return;
            }
            
            if (!clients || clients.length === 0) {
                container.innerHTML = `
                    <div class="client-empty-state">
                        <div class="client-empty-icon">üë•</div>
                        <p>No clients found</p>
                    </div>
                `;
                return;
            }
            
            const currentClient = clientManager.getCurrentClient();
            
            container.innerHTML = clients.map(client => {
                const isSelected = currentClient?.id === client.id;
                const lastModified = new Date(client.lastModified).toLocaleDateString();
                const programCount = client.programHistory?.filter(p => p.status === 'selected').length || 0;
                
                return `
                    <div class="client-card ${isSelected ? 'selected' : ''}" 
                         onclick="selectClient('${client.id}')"
                         data-client-id="${client.id}">
                        <div class="client-card-avatar">${client.initials}</div>
                        <div class="client-card-info">
                            <div class="client-card-header">
                                <span class="client-card-name">${client.initials}</span>
                                <span class="client-status-badge ${client.status}">${client.status}</span>
                            </div>
                            <div class="client-card-kipu">Kipu ID: ${client.kipuId}</div>
                            <div class="client-card-meta">
                                <span>${programCount} programs</span>
                                <span>Modified: ${lastModified}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Select client
        async function selectClient(clientId) {
            await clientManager.setCurrentClient(clientId);
            refreshClientsList();
            updateCurrentClientDisplay();
            
            // If programs were selected for this client, restore them
            const clientPrograms = await clientManager.getClientPrograms(clientId);
            if (clientPrograms && clientPrograms.length > 0) {
                selectedPrograms = [...clientPrograms];
                updateSelectedPrograms();
                renderSelectedPrograms();
            }
        }
        
        // Update current client display
        function updateCurrentClientDisplay() {
            const client = clientManager.getCurrentClient();
            
            // Check if elements exist (may not exist in CM Tracker view)
            const avatarEl = document.getElementById('currentClientAvatar');
            const nameEl = document.getElementById('currentClientName');
            const kipuEl = document.getElementById('currentClientKipu');
            
            if (!avatarEl || !nameEl || !kipuEl) {
                // Old UI elements don't exist, likely using CM Tracker
                return;
            }
            
            if (!client) {
                avatarEl.textContent = '--';
                nameEl.textContent = 'No Client Selected';
                kipuEl.textContent = 'Select a client to begin';
                return;
            }
            
            avatarEl.textContent = client.initials;
            nameEl.textContent = `${client.initials} - ${client.status}`;
            kipuEl.textContent = `Kipu ID: ${client.kipuId}`;
        }
        
        // Edit current client
        function editCurrentClient() {
            const client = clientManager.getCurrentClient();
            if (!client) {
                showAlert('No client selected', 'error');
                return;
            }
            
            // Create edit dialog
            const newStatus = prompt(`Change status for ${client.initials}:\n1. active\n2. waitlist\n3. discharged`, client.status);
            
            if (newStatus && ['active', 'waitlist', 'discharged'].includes(newStatus)) {
                clientManager.updateClientStatus(client.id, newStatus).then(() => {
                    showAlert('Client status updated', 'success');
                    refreshClientsList();
                    updateCurrentClientDisplay();
                });
            }
        }
        
        // Clear current client
        function clearCurrentClient() {
            clientManager.setCurrentClient(null);
            updateCurrentClientDisplay();
            // Clear selected programs
            selectedPrograms = [];
            updateSelectedPrograms();
            renderSelectedPrograms();
        }
        
        // Override the original handleProgramClick to link with current client
        const originalHandleProgramClick = window.handleProgramClick;
        window.handleProgramClick = function(programId, isSubProgram = false, parentId = null) {
            // Call original function
            if (originalHandleProgramClick) {
                originalHandleProgramClick(programId, isSubProgram, parentId);
            }
            
            // Track program selection for current client if clientManager is available
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client) {
                    if (selectedPrograms.includes(programId)) {
                        clientManager.addProgramToClient(client.id, programId, {
                            isSubProgram,
                            parentId,
                            addedFrom: 'program-list'
                        });
                    } else {
                        clientManager.removeProgramFromClient(client.id, programId);
                    }
                }
            }
        };
        
        // Override generateDocument to track for current client
        const originalGenerateDocument = window.generateDocument;
        window.generateDocument = function() {
            // Track for current client if clientManager is available
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client && selectedPrograms.length > 0) {
                    // Track document generation
                    clientManager.addDocumentRecord(client.id, {
                        type: documentType,
                        programIds: [...selectedPrograms],
                        settings: {
                            includeAtHome,
                            includeAlumni
                        },
                        fileName: `CareConnect_${client.initials}_${new Date().toISOString().split('T')[0]}.docx`
                    });
                }
            }
            
            // Call original function
            if (originalGenerateDocument) {
                return originalGenerateDocument();
            }
        };
        
        // Helper function to show alerts
        function showAlert(message, type = 'info') {
            // You can customize this to use your preferred notification system
            const alertClass = type === 'error' ? 'error-alert' : 'success-alert';
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.textContent = message;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'error' ? '#ef4444' : '#10b981'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // Export client data
        async function exportClientData() {
            try {
                const clients = await clientManager.getAllClients();
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    clients: clients
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `clients-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showAlert(`Exported ${clients.length} clients`, 'success');
            } catch (error) {
                showAlert('Failed to export clients', 'error');
                console.error(error);
            }
        }
        
        // Import client data
        async function importClientData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.clients || !Array.isArray(data.clients)) {
                        throw new Error('Invalid client data format');
                    }
                    
                    let imported = 0;
                    for (const client of data.clients) {
                        try {
                            await clientManager.importClient(client);
                            imported++;
                        } catch (err) {
                            console.warn(`Failed to import client ${client.initials}:`, err);
                        }
                    }
                    
                    await refreshClientsList();
                    showAlert(`Imported ${imported} clients`, 'success');
                } catch (error) {
                    showAlert('Failed to import clients', 'error');
                    console.error(error);
                }
            };
            
            input.click();
        }
        
        // Toggle recent clients dropdown
        function toggleRecentClients() {
            const dropdown = document.getElementById('recentClientsDropdown');
            if (dropdown.style.display === 'none') {
                loadRecentClients();
                dropdown.style.display = 'block';
                // Close on click outside
                setTimeout(() => {
                    document.addEventListener('click', closeRecentClientsOnClickOutside);
                }, 100);
            } else {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeRecentClientsOnClickOutside);
            }
        }
        
        // Close dropdown on click outside
        function closeRecentClientsOnClickOutside(e) {
            const dropdown = document.getElementById('recentClientsDropdown');
            if (!dropdown.contains(e.target) && !e.target.closest('button[onclick*="toggleRecentClients"]')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeRecentClientsOnClickOutside);
            }
        }
        
        // Load recent clients
        async function loadRecentClients() {
            const dropdown = document.getElementById('recentClientsDropdown');
            
            // Check if clientManager exists
            if (!window.clientManager) {
                dropdown.innerHTML = `
                    <div style="padding: 12px; color: #6b7280; text-align: center;">
                        Client manager not initialized yet
                    </div>
                `;
                return;
            }
            
            const recentClients = await clientManager.getRecentClients(5);
            const currentClient = clientManager.getCurrentClient();
            
            if (recentClients.length === 0) {
                dropdown.innerHTML = `
                    <div style="padding: 12px; color: #6b7280; text-align: center;">
                        No recent clients
                    </div>
                `;
                return;
            }
            
            dropdown.innerHTML = recentClients.map(client => {
                const isActive = currentClient?.id === client.id;
                const programCount = client.programHistory?.filter(p => p.status === 'selected').length || 0;
                return `
                    <div onclick="quickSelectClient('${client.id}')" 
                         style="padding: 10px; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: background 0.2s; ${isActive ? 'background: #ede9fe;' : ''}"
                         onmouseover="this.style.background='#f3f4f6'" 
                         onmouseout="this.style.background='${isActive ? '#ede9fe' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #1f2937;">${client.initials}</strong>
                                <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Kipu: ${client.kipuId}</span>
                            </div>
                            <span style="background: ${client.status === 'active' ? '#d1fae5' : client.status === 'waitlist' ? '#fef3c7' : '#f3f4f6'}; 
                                         color: ${client.status === 'active' ? '#065f46' : client.status === 'waitlist' ? '#92400e' : '#6b7280'}; 
                                         padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${client.status}
                            </span>
                        </div>
                        <div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">
                            ${programCount} programs ‚Ä¢ Last modified: ${new Date(client.lastModified).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Quick select client from dropdown
        async function quickSelectClient(clientId) {
            if (!window.clientManager) {
                showAlert('Client manager not ready yet', 'error');
                return;
            }
            
            await selectClient(clientId);
            document.getElementById('recentClientsDropdown').style.display = 'none';
            document.removeEventListener('click', closeRecentClientsOnClickOutside);
            
            // Update current client indicator
            const currentClient = clientManager.getCurrentClient();
            const button = document.querySelector('button[onclick*="toggleRecentClients"]');
            if (currentClient && button) {
                button.innerHTML = `‚ö° ${currentClient.initials} (${currentClient.kipuId}) ‚ñº`;
            }
        }
        
        // Manage favorite programs
        function manageFavorites() {
            const favorites = JSON.parse(localStorage.getItem('favoritePrograms') || '[]');
            
            // Create a modal for managing favorites
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                z-index: 10001;
                max-width: 600px;
                width: 90%;
                max-height: 70vh;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <h3 style="margin-top: 0;">‚≠ê Manage Favorite Programs</h3>
                <p style="color: #6b7280; font-size: 14px;">Select programs to add to favorites for quick access:</p>
                <div id="favoritesSelection" style="margin: 20px 0;">
                    ${programs.slice(0, 20).map(program => `
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" value="${program.id}" 
                                   ${favorites.includes(program.id) ? 'checked' : ''} 
                                   style="margin-right: 8px;">
                            ${program.name}
                        </label>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="this.closest('div').remove(); document.querySelector('.modal-backdrop').remove();" 
                            style="padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveFavorites()" 
                            style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Save Favorites
                    </button>
                </div>
            `;
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
            `;
            backdrop.onclick = () => {
                modal.remove();
                backdrop.remove();
            };
            
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }
        
        // Save favorite programs
        function saveFavorites() {
            const checkboxes = document.querySelectorAll('#favoritesSelection input[type="checkbox"]');
            const favorites = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    favorites.push(checkbox.value);
                }
            });
            
            localStorage.setItem('favoritePrograms', JSON.stringify(favorites));
            loadFavoritePrograms();
            
            // Close modal
            document.querySelector('.modal-backdrop').remove();
            document.querySelector('#favoritesSelection').closest('div').remove();
            
            showAlert('Favorites saved!', 'success');
        }
        
        // Load favorite programs
        function loadFavoritePrograms() {
            const favorites = JSON.parse(localStorage.getItem('favoritePrograms') || '[]');
            const container = document.getElementById('favoritePrograms');
            const list = document.getElementById('favoriteProgramsList');
            
            if (favorites.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = favorites.map(programId => {
                const program = programs.find(p => p.id === programId);
                if (!program) return '';
                
                const isSelected = selectedPrograms.includes(programId);
                return `
                    <button onclick="toggleFavoriteProgram('${programId}')" 
                            style="padding: 6px 12px; 
                                   background: ${isSelected ? '#065f46' : '#f59e0b'}; 
                                   color: white; 
                                   border: none; 
                                   border-radius: 4px; 
                                   cursor: pointer; 
                                   font-size: 12px;
                                   transition: all 0.2s;">
                        ${isSelected ? '‚úì' : '+'} ${program.name}
                    </button>
                `;
            }).join('');
        }
        
        // Toggle favorite program
        function toggleFavoriteProgram(programId) {
            if (selectedPrograms.includes(programId)) {
                // Remove if already selected
                const index = selectedPrograms.indexOf(programId);
                selectedPrograms.splice(index, 1);
            } else {
                // Add to selection
                selectedPrograms.push(programId);
            }
            
            updateSelectedPrograms();
            renderSelectedPrograms();
            loadFavoritePrograms(); // Refresh the favorites display
            
            // Track for current client
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client) {
                    if (selectedPrograms.includes(programId)) {
                        clientManager.addProgramToClient(client.id, programId, { addedFrom: 'favorites' });
                    } else {
                        clientManager.removeProgramFromClient(client.id, programId);
                    }
                }
            }
        }
        
        // Initialize workflow features on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure tab navigation is visible immediately
            ensureTabNavigationVisible();
            
            setTimeout(() => {
                loadFavoritePrograms();
                
                // Ensure tab navigation is still visible after delay
                ensureTabNavigationVisible();
                
                // Check if clientManager is initialized
                if (!window.clientManager) {
                    console.warn('ClientManager not initialized after 2 seconds');
                    // Show warning if on clients tab
                    const clientsTab = document.getElementById('clientsTab');
                    if (clientsTab && clientsTab.classList.contains('active')) {
                        const statusDiv = document.getElementById('clientManagerStatus');
                        if (statusDiv) {
                            statusDiv.style.display = 'block';
                        }
                    }
                } else {
                    console.log('ClientManager is available:', window.clientManager);
                    // Update recent clients button with current client if any
                    const currentClient = clientManager.getCurrentClient();
                    if (currentClient) {
                        const button = document.querySelector('button[onclick*="toggleRecentClients"]');
                        if (button) {
                            button.innerHTML = `‚ö° ${currentClient.initials} (${currentClient.kipuId}) ‚ñº`;
                        }
                    }
                }
            }, 2000); // Increased timeout to ensure clientManager is initialized
        });
        
        // CM Tracker Functions
        
        // Show add client modal
        async function showAddClientModal() {
            const houses = await housesManager.getActiveHouses();
            const currentHouse = houses.find(h => h.id === currentHouseId) || houses[0];
            
            const modalHTML = `
                <div class="modal-overlay" onclick="if(event.target === this) closeModal()">
                    <div class="modal-content">
                        <h3>Add New Client</h3>
                        <form id="addClientForm" onsubmit="handleAddClient(event)">
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>Client Initials *</label>
                                    <input type="text" name="initials" maxlength="4" required 
                                           style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Kipu ID *</label>
                                    <input type="text" name="kipuId" required style="width: 100%;">
                                </div>
                                <div>
                                    <label>House *</label>
                                    <select name="houseId" required style="width: 100%;">
                                        ${houses.map(h => `
                                            <option value="${h.id}" ${h.id === currentHouse.id ? 'selected' : ''}>
                                                ${h.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label>Admission Date</label>
                                    <input type="date" name="admissionDate" style="width: 100%;">
                                </div>
                                <div>
                                    <label>Clinical Coach</label>
                                    <input type="text" name="clinicalCoachInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Case Manager</label>
                                    <input type="text" name="caseManagerInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Primary Therapist</label>
                                    <input type="text" name="primaryTherapistInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                                <button type="button" onclick="closeModal()" 
                                        style="padding: 10px 20px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Add Client
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Handle add client form submission
        async function handleAddClient(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const clientData = {
                initials: formData.get('initials'),
                kipuId: formData.get('kipuId'),
                houseId: formData.get('houseId'),
                admissionDate: formData.get('admissionDate') || null,
                clinicalCoachInitials: formData.get('clinicalCoachInitials') || '',
                caseManagerInitials: formData.get('caseManagerInitials') || '',
                primaryTherapistInitials: formData.get('primaryTherapistInitials') || ''
            };
            
            try {
                const newClient = await window.clientManager.createClient(clientData);
                
                // Initialize milestones for the new client
                await milestonesManager.initializeClientMilestones(newClient.id);
                
                showAlert('Client added successfully!', 'success');
                closeModal();
                await loadHouseView(currentHouseId);
                await buildHouseNavigation(); // Update counts
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        // Close modal
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
        }
        
        // View client details
        async function viewClientDetails(clientId) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    showAlert('Client not found', 'error');
                    return;
                }
                
                // Get related data
                const house = housesManager.getHouseById(client.houseId);
                const milestones = await milestonesManager.getClientMilestones(clientId);
                const aftercareOptions = await aftercareManager.getClientAftercareOptions(clientId);
                const daysInCare = window.clientManager.calculateDaysInCare(client);
                
                // Build modal HTML
                const modalHTML = `
                    <div class="modal-overlay" onclick="if(event.target === this) closeModal()">
                        <div class="modal-content" style="width: 800px; max-width: 90vw; height: 600px; max-height: 90vh; display: flex; flex-direction: column;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0;">Client Details: ${client.initials} (${client.kipuId})</h3>
                                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
                            </div>
                            
                            <!-- Tab Navigation -->
                            <div style="display: flex; gap: 2px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
                                <button class="detail-tab active" onclick="switchDetailTab('overview')">Overview</button>
                                <button class="detail-tab" onclick="switchDetailTab('milestones')">Milestones</button>
                                <button class="detail-tab" onclick="switchDetailTab('assessments')">Assessments</button>
                                <button class="detail-tab" onclick="switchDetailTab('aftercare')">Aftercare</button>
                                <button class="detail-tab" onclick="switchDetailTab('team')">Care Team</button>
                                <button class="detail-tab" onclick="switchDetailTab('notes')">Notes</button>
                            </div>
                            
                            <!-- Tab Content -->
                            <div style="flex: 1; overflow: auto;">
                                <!-- Overview Tab -->
                                <div id="overviewTab" class="detail-tab-content active">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <div>
                                            <h4 style="margin-top: 0;">Client Information</h4>
                                            <p><strong>Initials:</strong> ${client.initials}</p>
                                            <p><strong>Kipu ID:</strong> ${client.kipuId}</p>
                                            <p><strong>House:</strong> ${house ? house.name : 'Not assigned'}</p>
                                            <p><strong>Status:</strong> ${client.status === 'active' ? 'üü¢ Active' : 'üî¥ Discharged'}</p>
                                        </div>
                                        <div>
                                            <h4 style="margin-top: 0;">Timeline</h4>
                                            <p><strong>Admission Date:</strong> ${client.admissionDate || 'Not set'}</p>
                                            <p><strong>Days in Care:</strong> ${daysInCare}</p>
                                            <p><strong>Discharge Date:</strong> ${client.dischargeDate || 'N/A'}</p>
                                            <p><strong>Created:</strong> ${new Date(client.createdDate).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 20px;">
                                        <h4>Quick Stats</h4>
                                        <div style="display: flex; gap: 20px;">
                                            <div style="padding: 10px; background: #f3f4f6; border-radius: 8px;">
                                                <strong>Milestones:</strong> ${milestones.filter(m => m.status === 'complete').length}/${milestones.length} complete
                                            </div>
                                            <div style="padding: 10px; background: #f3f4f6; border-radius: 8px;">
                                                <strong>Aftercare Options:</strong> ${aftercareOptions.length}/6
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Milestones Tab -->
                                <div id="milestonesTab" class="detail-tab-content" style="display: none;">
                                    <h4 style="margin-top: 0;">Milestone Tracking</h4>
                                    <div id="milestonesList">${await buildMilestonesList(client, milestones, daysInCare)}</div>
                                </div>
                                
                                <!-- Assessments Tab -->
                                <div id="assessmentsTab" class="detail-tab-content" style="display: none;">
                                    <h4 style="margin-top: 0;">Assessments</h4>
                                    <button onclick="addAssessment('${clientId}')" style="margin-bottom: 15px; padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        ‚ûï Add Assessment
                                    </button>
                                    <div id="assessmentsList">
                                        <p style="color: #6b7280;">No assessments recorded yet.</p>
                                    </div>
                                </div>
                                
                                <!-- Aftercare Tab -->
                                <div id="aftercareTab" class="detail-tab-content" style="display: none;">
                                    <h4 style="margin-top: 0;">Aftercare Options</h4>
                                    <button onclick="addAftercareOption('${clientId}')" style="margin-bottom: 15px; padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        ‚ûï Add Option
                                    </button>
                                    <div id="aftercareList">${buildAftercareList(aftercareOptions, clientId)}</div>
                                </div>
                                
                                <!-- Care Team Tab -->
                                <div id="teamTab" class="detail-tab-content" style="display: none;">
                                    <h4 style="margin-top: 0;">Care Team</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Clinical Coach</label>
                                            <input type="text" id="clinicalCoach" value="${client.clinicalCoachInitials || ''}" 
                                                   maxlength="4" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Case Manager</label>
                                            <input type="text" id="caseManager" value="${client.caseManagerInitials || ''}" 
                                                   maxlength="4" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Primary Therapist</label>
                                            <input type="text" id="primaryTherapist" value="${client.primaryTherapistInitials || ''}" 
                                                   maxlength="4" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Family Ambassador</label>
                                            <input type="text" id="familyAmbassador" value="${client.familyAmbassadorPrimaryInitials || ''}" 
                                                   maxlength="4" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                        </div>
                                    </div>
                                    <button onclick="saveCareTeam('${clientId}')" style="margin-top: 20px; padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        üíæ Save Care Team
                                    </button>
                                </div>
                                
                                <!-- Notes Tab -->
                                <div id="notesTab" class="detail-tab-content" style="display: none;">
                                    <h4 style="margin-top: 0;">Notes & Documentation</h4>
                                    <textarea id="clientNotes" style="width: 100%; height: 200px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 4px; font-family: inherit;" 
                                              placeholder="Add notes about this client...">${client.notes || ''}</textarea>
                                    <button onclick="saveClientNotes('${clientId}')" style="margin-top: 10px; padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        üíæ Save Notes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Add tab styling
                const style = document.createElement('style');
                style.textContent = `
                    .detail-tab {
                        padding: 10px 20px;
                        background: transparent;
                        border: none;
                        color: #6b7280;
                        font-weight: 500;
                        cursor: pointer;
                        border-bottom: 2px solid transparent;
                        transition: all 0.2s ease;
                    }
                    .detail-tab:hover {
                        color: #374151;
                        background: #f9fafb;
                    }
                    .detail-tab.active {
                        color: #6366f1;
                        border-bottom-color: #6366f1;
                    }
                    .detail-tab-content {
                        padding: 20px;
                    }
                    .milestone-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        margin-bottom: 8px;
                        background: #f9fafb;
                        border-radius: 8px;
                        border: 1px solid #e5e7eb;
                    }
                    .milestone-item:hover {
                        background: #f3f4f6;
                    }
                    .aftercare-item {
                        padding: 15px;
                        margin-bottom: 10px;
                        background: white;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                    }
                    
                    /* Visual indicator color coding */
                    .milestone-indicator {
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        min-width: 28px;
                        height: 28px;
                        border-radius: 6px;
                        font-size: 16px;
                        transition: all 0.2s ease;
                        cursor: pointer;
                        user-select: none;
                    }
                    
                    .milestone-indicator.complete {
                        background-color: #10b981;
                        color: white;
                    }
                    
                    .milestone-indicator.overdue {
                        background-color: #ef4444;
                        color: white;
                        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
                    }
                    
                    .milestone-indicator.due-today {
                        background-color: #f59e0b;
                        color: white;
                    }
                    
                    .milestone-indicator.due-soon {
                        background-color: #f59e0b;
                        color: white;
                        opacity: 0.8;
                    }
                    
                    .milestone-indicator.in-progress {
                        background-color: #3b82f6;
                        color: white;
                    }
                    
                    .milestone-indicator.pending {
                        background-color: #e5e7eb;
                        color: #6b7280;
                    }
                    
                    @keyframes pulse {
                        0%, 100% {
                            opacity: 1;
                        }
                        50% {
                            opacity: .8;
                        }
                    }
                    
                    /* Days in care color coding */
                    .days-in-care {
                        font-weight: 500;
                    }
                    
                    td.days-in-care {
                        text-align: center;
                    }
                    
                    /* Color code days based on milestones */
                    .days-13 { color: #f59e0b; font-weight: 600; }
                    .days-14 { color: #f59e0b; font-weight: 600; }
                    .days-16plus { color: #ef4444; font-weight: 600; }
                `;
                document.head.appendChild(style);
                
            } catch (error) {
                console.error('Failed to load client details:', error);
                showAlert('Failed to load client details', 'error');
            }
        }
        
        // Build milestones list for client details
        async function buildMilestonesList(client, milestones, daysInCare) {
            let html = '<div>';
            
            for (const milestone of milestones) {
                const display = milestonesManager.getMilestoneDisplayStatus(milestone, daysInCare);
                const milestoneType = Object.values(milestonesManager.milestoneTypes).find(t => t.id === milestone.milestone);
                
                html += `
                    <div class="milestone-item">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${milestoneType.icon}</span>
                            <div>
                                <strong>${milestoneType.displayName}</strong>
                                <div style="font-size: 12px; color: #6b7280;">${milestoneType.description}</div>
                            </div>
                        </div>
                        <button onclick="toggleMilestone('${client.id}', '${milestone.milestone}')" 
                                class="milestone-indicator ${display.class}" 
                                style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; background: ${display.class === 'complete' ? '#10b981' : '#e5e7eb'}; color: ${display.class === 'complete' ? 'white' : '#374151'};">
                            ${display.icon} ${display.class === 'complete' ? 'Complete' : 'Mark Complete'}
                        </button>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Build aftercare list for client details
        function buildAftercareList(aftercareOptions, clientId) {
            if (aftercareOptions.length === 0) {
                return '<p style="color: #6b7280;">No aftercare options added yet.</p>';
            }
            
            let html = '<div>';
            
            for (const option of aftercareOptions) {
                const statusDisplay = aftercareManager.getStatusDisplay(option.status);
                
                html += `
                    <div class="aftercare-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 8px 0;">Option ${option.ordinal}: ${option.programName || 'Unnamed Program'}</h5>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <span style="padding: 4px 8px; background: ${statusDisplay.background}; color: ${statusDisplay.color}; border-radius: 4px; font-size: 12px;">
                                        ${statusDisplay.icon} ${statusDisplay.label}
                                    </span>
                                    ${option.dateProvidedToFamily ? `<span style="font-size: 12px; color: #6b7280;">Provided: ${option.dateProvidedToFamily}</span>` : ''}
                                </div>
                                ${option.notes ? `<p style="margin: 5px 0; font-size: 14px; color: #374151;">${option.notes}</p>` : ''}
                            </div>
                            <button onclick="editAftercareOption('${clientId}', ${option.ordinal})" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer;">
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Switch detail tab
        function switchDetailTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.detail-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.detail-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.style.display = 'block';
            }
            
            // Add active class to selected button
            event.target.classList.add('active');
        }
        
        // Save care team
        async function saveCareTeam(clientId) {
            try {
                const updates = {
                    clinicalCoachInitials: document.getElementById('clinicalCoach').value,
                    caseManagerInitials: document.getElementById('caseManager').value,
                    primaryTherapistInitials: document.getElementById('primaryTherapist').value,
                    familyAmbassadorPrimaryInitials: document.getElementById('familyAmbassador').value
                };
                
                await window.clientManager.updateClient(clientId, updates);
                showAlert('Care team updated successfully', 'success');
                
                // Refresh the table
                await loadHouseView(currentHouseId);
            } catch (error) {
                console.error('Failed to save care team:', error);
                showAlert('Failed to save care team', 'error');
            }
        }
        
        // Save client notes
        async function saveClientNotes(clientId) {
            try {
                const notes = document.getElementById('clientNotes').value;
                await window.clientManager.updateClient(clientId, { notes });
                showAlert('Notes saved successfully', 'success');
            } catch (error) {
                console.error('Failed to save notes:', error);
                showAlert('Failed to save notes', 'error');
            }
        }
        
        // Add aftercare option
        async function addAftercareOption(clientId) {
            // Get programs for selection
            const programs = JSON.parse(localStorage.getItem('therapyPrograms') || '[]');
            
            let programOptions = programs.map(p => 
                `<option value="${p.name}">${p.name}</option>`
            ).join('');
            
            const modalHTML = `
                <div class="modal-overlay" onclick="if(event.target === this) closeModal()">
                    <div class="modal-content" style="width: 500px;">
                        <h3>Add Aftercare Option</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Program Name</label>
                            <select id="programSelect" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <option value="">Select a program...</option>
                                ${programOptions}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Status</label>
                            <select id="optionStatus" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <option value="pending">Pending</option>
                                <option value="sent">Sent to Family</option>
                                <option value="engaged">Family Engaged</option>
                                <option value="accepted">Accepted</option>
                                <option value="declined">Declined</option>
                                <option value="waitlist">Waitlist</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Date Provided to Family</label>
                            <input type="date" id="dateProvided" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Notes</label>
                            <textarea id="optionNotes" style="width: 100%; height: 80px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeModal()" style="padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="handleAddAftercareOption('${clientId}')" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Add Option
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Handle add aftercare option
        async function handleAddAftercareOption(clientId) {
            try {
                const programName = document.getElementById('programSelect').value;
                const status = document.getElementById('optionStatus').value;
                const dateProvided = document.getElementById('dateProvided').value;
                const notes = document.getElementById('optionNotes').value;
                
                if (!programName) {
                    showAlert('Please select a program', 'error');
                    return;
                }
                
                await aftercareManager.addAftercareOption(clientId, {
                    programName,
                    status,
                    dateProvidedToFamily: dateProvided,
                    notes
                });
                
                showAlert('Aftercare option added successfully', 'success');
                closeModal();
                
                // Refresh the client details
                viewClientDetails(clientId);
                
                // Refresh the table
                await loadHouseView(currentHouseId);
            } catch (error) {
                console.error('Failed to add aftercare option:', error);
                showAlert(error.message || 'Failed to add aftercare option', 'error');
            }
        }
        
        // Edit client
        function editClient(clientId) {
            // This will be implemented
            console.log('Edit client:', clientId);
        }
        
        // Generate document for client
        async function generateClientDocument(clientId) {
            const client = await window.clientManager.getClient(clientId);
            if (client) {
                await window.clientManager.setCurrentClient(clientId);
                switchTab('programs');
                showAlert(`Switched to ${client.initials} - Select programs for document`, 'info');
            }
        }
        
        // Export current house
        async function exportCurrentHouse() {
            try {
                const houseData = await housesManager.exportHouseData(currentHouseId);
                const json = JSON.stringify(houseData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${houseData.house.name}_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showAlert('House data exported successfully!', 'success');
            } catch (error) {
                showAlert('Failed to export house data: ' + error.message, 'error');
            }
        }
        
        // Export all data
        function exportAllData() {
            // To be implemented with Excel export
            showAlert('Excel export will be implemented with the Excel export module', 'info');
        }
        
        // Show bulk import
        function showBulkImport() {
            // To be implemented with Excel import
            showAlert('Excel import will be implemented with the Excel import module', 'info');
        }
        
        // Show reports
        function showReports() {
            // To be implemented with reporting module
            showAlert('Reports will be implemented with the reporting module', 'info');
        }
        
        // Toggle milestone completion
        async function toggleMilestone(clientId, milestoneId) {
            try {
                await milestonesManager.toggleMilestone(clientId, milestoneId);
                await loadHouseView(currentHouseId); // Refresh the view
            } catch (error) {
                console.error('Failed to toggle milestone:', error);
                showAlert('Failed to update milestone', 'error');
            }
        }
        
        // Reset database
        async function resetDatabase() {
            if (confirm('This will clear all local data and reload the page. Continue?')) {
                try {
                    await clearIndexedDB();
                    localStorage.clear();
                    sessionStorage.clear();
                    showAlert('Database cleared. Reloading...', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } catch (error) {
                    showAlert('Failed to reset database: ' + error.message, 'error');
                }
            }
        }
    </script>
    
    <!-- Initialize Service Worker -->
    <script>
        // Function to clear IndexedDB if needed
        async function clearIndexedDB() {
            try {
                await indexedDB.deleteDatabase('CareConnectPro');
                console.log('Database cleared successfully');
                return true;
            } catch (error) {
                console.error('Failed to clear database:', error);
                return false;
            }
        }

        // Auto-set login if not set
        if (!sessionStorage.getItem('isLoggedIn')) {
            console.log('Auto-setting login credentials...');
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('username', 'MasterAdmin');
            sessionStorage.setItem('userRole', 'admin');
        }



        // Robust login handler
        (function() {
            function initLogin() {
                const forms = document.querySelectorAll('form');
                forms.forEach(form => {
                    const hasPassword = form.querySelector('input[type="password"]');
                    const hasUsername = form.querySelector('input[type="text"], input[name="username"]');
                    
                    if (hasPassword && hasUsername) {
                        // This is the login form
                        form.onsubmit = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const username = hasUsername.value;
                            const password = hasPassword.value;
                            
                            // Validate credentials
                            if ((username === 'MasterAdmin' || username === 'Doc121') && password === 'FFA121') {
                                sessionStorage.setItem('isLoggedIn', 'true');
                                sessionStorage.setItem('username', username);
                                sessionStorage.setItem('userRole', username === 'MasterAdmin' ? 'admin' : 'user');
                                location.reload();
                            } else {
                                alert('Invalid username or password');
                            }
                            
                            return false;
                        };
                        
                        // Also handle button click
                        const submitBtn = form.querySelector('button[type="submit"], button.sign-in-btn, input[type="submit"]');
                        if (submitBtn) {
                            submitBtn.onclick = function(e) {
                                e.preventDefault();
                                form.onsubmit(e);
                                return false;
                            };
                        }
                    }
                });
            }
            
            // Initialize on multiple events to ensure it runs
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLogin);
            } else {
                initLogin();
            }
            
            // Also try on window load as backup
            window.addEventListener('load', initLogin);
        })();


        // Fix login form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Find the login form
            const loginForm = document.querySelector('form');
            if (loginForm && loginForm.querySelector('input[type="password"]')) {
                // Prevent default form submission
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get username and password
                    const username = document.querySelector('input[type="text"]').value;
                    const password = document.querySelector('input[type="password"]').value;
                    
                    // Call the login function
                    if (typeof handleLogin === 'function') {
                        handleLogin(username, password);
                    } else {
                        // Fallback login handling
                        if (username === 'MasterAdmin' && password === 'FFA121') {
                            sessionStorage.setItem('isLoggedIn', 'true');
                            sessionStorage.setItem('username', username);
                            window.location.reload();
                        } else if (username === 'Doc121' && password === 'FFA121') {
                            sessionStorage.setItem('isLoggedIn', 'true');
                            sessionStorage.setItem('username', username);
                            window.location.reload();
                        } else {
                            alert('Invalid credentials. Please try again.');
                        }
                    }
                    
                    return false;
                });
                
                // Also handle button click
                const signInButton = loginForm.querySelector('button[type="submit"]') || 
                                   loginForm.querySelector('.sign-in-btn') ||
                                   loginForm.querySelector('button');
                
                if (signInButton) {
                    signInButton.onclick = function(e) {
                        e.preventDefault();
                        loginForm.dispatchEvent(new Event('submit'));
                        return false;
                    };
                }
            }
        });

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js")
                .then(reg => console.log("Service Worker registered:", reg.scope))
                .catch(err => console.log("Service Worker registration failed:", err));
        }
    </script>
    
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Family First Adolescent Services - Document Creation Tool">
    <meta name="theme-color" content="#0099cc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FFAS Docs">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232196a6'/%3E%3Cpath d='M 20 15 Q 32 12 44 15 L 40 22 Q 32 20 24 22 Q 18 28 18 38 L 26 38 Q 26 32 29 29 Q 32 27 37 28 L 35 33 Q 32 32 30 33 Q 28 35 28 38 L 36 38 Q 36 35 37 33 Q 40 32 44 33 L 42 38 Q 38 37 37 38 Q 36 40 36 45 L 29 45 Q 29 42 26 42 L 18 45 Q 15 32 22 22 Q 26 18 32 15' fill='white'/%3E%3C/svg%3E">
    
    <style>
        /* Modern UI Enhancement Styles - Override Existing */
        
        /* Beautiful Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Override Program Cards for Better Look */
        .program-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%) !important;
            padding: 24px !important;
            border-radius: 16px !important;
            border: 2px solid transparent !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08) !important;
            animation: fadeIn 0.5s ease;
        }
        
        .program-card:hover {
            transform: translateY(-6px) scale(1.02) !important;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.18) !important;
            border-color: #667eea !important;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%) !important;
        }
        
        .program-card.selected {
            background: linear-gradient(135deg, #f0f4ff, #e5edff) !important;
            border: 2px solid #667eea !important;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.28) !important;
            transform: scale(1.02) !important;
        }
        
        /* Beautiful Buttons */
        .btn-primary, button[onclick*="generate"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 14px 28px !important;
            border: none !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            font-size: 15px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .btn-primary:hover, button[onclick*="generate"]:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.45) !important;
        }
        
        .btn-primary:active, button[onclick*="generate"]:active {
            transform: translateY(-1px) !important;
        }
        
        /* Modern Modal Overlay */
        .modal {
            background-color: rgba(0,0,0,0.7) !important;
            backdrop-filter: blur(10px) !important;
            animation: modalFadeIn 0.3s ease !important;
        }
        
        .modal-content {
            border-radius: 20px !important;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3) !important;
            animation: modalSlideIn 0.3s ease !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 25px 30px !important;
            border-radius: 20px 20px 0 0 !important;
        }
        
        .modal-header h2 {
            color: white !important;
            font-weight: 600 !important;
            font-size: 24px !important;
        }
        
        /* Input Field Styling */
        input[type="text"], input[type="email"], input[type="password"], textarea, select {
            padding: 12px 16px !important;
            border-radius: 10px !important;
            border: 2px solid #e5e7eb !important;
            font-size: 15px !important;
            transition: all 0.3s ease !important;
            background: white !important;
        }
        
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            border-color: #667eea !important;
            outline: none !important;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1) !important;
        }
        
        /* Checkbox and Radio Styling */
        input[type="checkbox"], input[type="radio"] {
            width: 20px !important;
            height: 20px !important;
            cursor: pointer !important;
            accent-color: #667eea !important;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46a2);
        }
        
        /* Loading Animation */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        /* Smooth Transitions for All Interactive Elements */
        button, a, input, textarea, select, .card, .panel {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        /* Responsive Design Improvements */
        @media screen and (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }
            
        .main-content {
                flex-direction: column;
            }
            
            .selection-panel {
                width: 100%;
                max-width: 100%;
                border-left: none;
                border-top: 2px solid #e5e7eb;
                margin-top: 20px;
                position: relative;
                top: 0;
            }
            
            .programs-panel {
                max-height: none;
            }
        }
        
        @media screen and (max-width: 768px) {
            .header {
                padding: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 24px !important;
            }
            
            .program-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 95vh;
            }
            
            .wizard-steps {
                gap: 8px;
            }
            
            .wizard-step-indicator {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .btn-primary, button[onclick*="generate"] {
                padding: 12px 20px !important;
                font-size: 14px !important;
            }
            
            .doc-type-buttons {
                flex-direction: column;
            }
            
            .doc-type-btn {
                width: 100%;
            }
        }
        
        @media screen and (max-width: 480px) {
            .programs-panel, .selection-panel {
                padding: 15px;
            }
            
            .program-card {
                padding: 16px !important;
            }
            
            input[type="text"], textarea, select {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            .modal-header {
                padding: 20px !important;
            }
            
            .modal-header h2 {
                font-size: 20px !important;
            }
            
            .wizard-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .wizard-actions button {
                width: 100%;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white !important;
            }
            
            .theme-toggle, .modal, button {
                display: none !important;
            }
            
            .container {
                box-shadow: none !important;
                max-width: 100% !important;
            }
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .program-card {
                border: 3px solid #000 !important;
            }
            
            .btn-primary {
                border: 2px solid #000 !important;
            }
            
            input, textarea, select {
                border: 2px solid #000 !important;
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Additional Polish */
        .guided-btn {
            background: linear-gradient(135deg, #34d399, #059669) !important;
            color: white !important;
            font-weight: 600 !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 14px 24px !important;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .guided-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 10px 28px rgba(5, 150, 105, 0.4) !important;
        }
        
        .wizard-back {
            background: #e5e7eb !important;
            color: #374151 !important;
        }
        
        .wizard-back:hover {
            background: #d1d5db !important;
        }
        
        .wizard-next {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: white !important;
        }
        
        .wizard-next:hover {
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4) !important;
        }
        
        .wizard-finish {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
        }
        
        .wizard-finish:hover {
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4) !important;
        }
        
        /* Fix overlapping elements */
        .selection-panel {
            z-index: 10;
            visibility: visible !important;
        }

        .parent-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04) !important;
            margin-bottom: 24px !important;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .parent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .parent-card:hover {
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.12) !important;
            transform: translateY(-4px);
            border-color: #cbd5e1 !important;
        }
        
        .parent-card:hover::before {
            transform: scaleX(1);
        }

        .parent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .parent-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .org-badge {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .expand-icon {
            font-size: 14px;
            color: #1d4ed8;
            transition: transform 0.2s ease;
        }

        .parent-expand-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: rgba(59, 130, 246, 0.08);
            color: #1d4ed8;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .parent-expand-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.35);
        }

        .parent-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .parent-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 13px;
            color: #475569;
            margin-bottom: 10px;
        }
        
        .parent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }
        
        .parent-tag {
            background: rgba(59, 130, 246, 0.08);
            color: #3b82f6;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(59, 130, 246, 0.15);
        }
        
        .parent-stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            font-size: 13px;
            color: #64748b;
        }
        
        .parent-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .parent-stat-icon {
            color: #3b82f6;
            font-weight: bold;
        }
        
        /* Interactive Profile Modal - Enhanced */
        .program-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            z-index: 10000;
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .program-profile-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .profile-container {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 100px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            animation: modalSlideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center bottom;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 32px 40px;
            position: relative;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15);
        }
        
        .profile-navigation {
            position: absolute;
            top: 24px;
            left: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .profile-back-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .profile-back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(-2px);
        }
        
        .profile-breadcrumb {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .profile-close {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05) rotate(90deg);
        }
        
        .profile-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 50px;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
        }
        
        .profile-subtitle {
            font-size: 16px;
            opacity: 0.95;
            display: flex;
            gap: 20px;
            align-items: center;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;
        }
        
        .profile-body {
            padding: 40px;
            overflow-y: auto;
            flex: 1;
            background: linear-gradient(to bottom, #ffffff 0%, #fafbfc 100%);
        }
        
        .profile-section {
            margin-bottom: 40px;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both;
        }
        
        .profile-section-title {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid transparent;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }
        
        .profile-section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 2px;
            animation: slideInLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.4s both;
        }
        
        .profile-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        }
        
        .profile-info-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .profile-info-item:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .profile-info-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        .profile-info-value {
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
        }
        
        .profile-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }
        
        .profile-feature {
            padding: 18px 20px;
            background: white;
            border-left: 4px solid transparent;
            background: linear-gradient(to right, white, white),
                        linear-gradient(135deg, #6366f1, #8b5cf6);
            background-clip: padding-box, border-box;
            background-origin: border-box;
            border: 1px solid transparent;
            border-left-width: 4px;
            border-radius: 12px;
            font-size: 15px;
            color: #334155;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        
        .profile-feature:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
        }

        .profile-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .profile-tag {
            background: rgba(59, 130, 246, 0.12);
            color: #1d4ed8;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .profile-overview-text {
            font-size: 15px;
            color: #1f2937;
            line-height: 1.6;
            background: #f8fafc;
            border-radius: 10px;
            padding: 16px 18px;
        }

        .profile-subprogram-section {
            margin-top: 10px;
        }

        .profile-subprogram-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .profile-subprogram-item {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .profile-subprogram-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-subprogram-item:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.1);
            border-color: #cbd5e1;
        }
        
        .profile-subprogram-item:hover::before {
            transform: scaleY(1);
        }

        .profile-subprogram-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .profile-subprogram-meta {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .profile-subprogram-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .profile-subprogram-actions button {
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }

        .profile-view-btn {
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
        }

        .profile-add-btn-inline {
            background: #10b981;
            color: white;
        }

        .profile-add-btn-inline.selected {
            background: #ef4444;
        }
        
        /* Loading state */
        .profile-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        .profile-loading.active {
            display: block;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .profile-container {
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
            }
            
            .profile-header {
                padding: 24px;
            }
            
            .profile-body {
                padding: 24px;
            }
            
            .profile-title {
                font-size: 24px;
            }
            
            .profile-features {
                grid-template-columns: 1fr;
            }
            
            .profile-info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .profile-actions {
            padding: 20px 30px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .profile-add-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 14px 36px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .profile-add-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .profile-add-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }
        
        .profile-add-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .profile-add-btn.added {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .profile-contact-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .profile-contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .profile-contact-icon {
            color: #667eea;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideUp {
            from { 
                transform: translateY(40px) scale(0.95);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                width: 0;
                opacity: 0;
            }
            to {
                width: 60px;
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .parent-overview {
            font-size: 14px;
            color: #334155;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .parent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .parent-tag {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .sub-programs-container {
            margin-top: 16px;
            display: grid;
            gap: 12px;
        }

        .sub-program-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .sub-program-card:hover {
            border-color: #2563eb;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.15);
        }

        .sub-program-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .sub-program-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .sub-program-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .sub-program-info {
            font-size: 13px;
            color: #475569;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .sub-program-badge {
            background: #f1f5f9;
            color: #0f172a;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .sub-program-features {
            margin: 0;
            padding-left: 18px;
            font-size: 12px;
            color: #4b5563;
        }

        .sub-program-features li {
            margin-bottom: 4px;
        }

        .sub-program-toggle {
            border: 1px solid #bfdbfe;
            background: #e0f2fe;
            color: #1d4ed8;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sub-program-toggle:hover {
            border-color: #2563eb;
            background: #dbeafe;
        }

        .sub-program-toggle.selected {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }

        .programs-panel {
            z-index: 5;
        }

        .header {
            z-index: 20;
        }
        
        /* Ensure text is readable */
        h1, h2, h3, h4, h5, h6 {
            line-height: 1.4;
            margin-bottom: 0.5em;
        }
        
        p {
            line-height: 1.6;
            margin-bottom: 1em;
        }
        
        /* Better focus states */
        a:focus, button:focus, input:focus, textarea:focus, select:focus {
            outline: 3px solid rgba(102, 126, 234, 0.5) !important;
            outline-offset: 2px;
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.95) 0%, rgba(147, 51, 234, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            animation: fadeIn 0.3s ease;
        }
        
        .loading-spinner {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 0 100px rgba(147, 51, 234, 0.3);
            min-width: 400px;
            max-width: 500px;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Modern Circular Progress */
        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 25px;
        }
        
        .progress-ring-circle {
            fill: transparent;
            stroke: #e5e7eb;
            stroke-width: 8;
        }
        
        .progress-ring-circle-progress {
            fill: transparent;
            stroke: url(#gradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
            transition: stroke-dashoffset 0.35s;
        }
        
        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Status Text */
        .loading-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .loading-status {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
            min-height: 40px;
        }
        
        .status-detail {
            font-size: 12px;
            color: #9ca3af;
            font-style: italic;
            margin-top: 4px;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Steps Indicator */
        .loading-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .loading-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .loading-step::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .loading-step.active::before {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }
        
        .loading-step.completed::before {
            background: #10b981;
        }
        
        .loading-step-label {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .loading-step.active .loading-step-label {
            color: #4f46e5;
            font-weight: 600;
        }
        
        /* Beautiful Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .notification-message {
            font-size: 14px;
            opacity: 0.95;
        }
        
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.5);
            animation: notificationProgress 3s linear;
        }
        
        @keyframes notificationProgress {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        /* Old spinner for backwards compatibility */
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0099cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    

        /* Enhanced Features CSS */
        .client-switcher {
            margin-bottom: 20px;
        }
        
        .natural-language-search {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .natural-language-search:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .filter-suggestions {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .smart-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .smart-preset {
            padding: 6px 12px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .smart-preset:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .match-score {
            display: inline-block;
            padding: 2px 8px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .data-quality-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }
        
        .data-quality-high { background: #10b981; }
        .data-quality-medium { background: #f59e0b; }
        .data-quality-low { background: #ef4444; }

    

        /* Map System Styles */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        .leaflet-popup-content {
            margin: 12px !important;
        }
        
        .program-marker {
            transition: transform 0.2s;
        }
        
        .program-marker:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        
        /* Custom map controls */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        .leaflet-control-zoom a {
            background: white !important;
            color: #374151 !important;
            border: none !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: #f3f4f6 !important;
        }
    </style>
    <style>
        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex !important;
            gap: 8px;
            margin-bottom: 20px;
            visibility: visible !important;
            padding: 0;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px 8px 0 0;
            padding: 8px 12px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tab-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .tab-btn.active {
            background: #6366f1;
            color: white;
            font-weight: 600;
        }
        
        .tab-btn.active:hover {
            background: #4f46e5;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Hide selection panel when dashboard is active */
        #dashboardTab.active ~ * .selection-panel,
        #dashboardTab.active ~ .selection-panel,
        body:has(#dashboardTab.active) .selection-panel,
        body:has(#dashboardTab.active) [class*="selection-panel"],
        body:has(#dashboardTab.active) aside:has-text("GENERATE DOCUMENT"),
        #dashboardTab.active ~ * aside {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Ensure dashboard gets full width */
        body:has(#dashboardTab.active) .main-content {
            grid-template-columns: 1fr !important;
        }
        
        /* Dashboard Styles */
        .dashboard-container {
            padding: 20px;
            background: #f9fafb;
            min-height: calc(100vh - 200px);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .dashboard-greeting {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
        }
        
        .dashboard-subtitle {
            font-size: 16px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .dashboard-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .view-toggle {
            display: flex;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .view-toggle button {
            padding: 8px 16px;
            border: none;
            background: white;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle button.active {
            background: #6366f1;
            color: white;
        }
        
        .dashboard-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Widget base styles */
        .dashboard-widget {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .widget-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .widget-skeleton {
            height: 200px;
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Priority zones */
        .priority-zones {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .priority-zone {
            background: #f9fafb;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .zone-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
        }
        
        .zone-header:hover {
            background: #f3f4f6;
        }
        
        .zone-icon {
            font-size: 18px;
            margin-right: 12px;
        }
        
        .zone-title {
            flex: 1;
            font-weight: 500;
            color: #374151;
        }
        
        .zone-count {
            background: #374151;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .zone-red .zone-count { background: #ef4444; }
        .zone-purple .zone-count { background: #8b5cf6; }
        .zone-yellow .zone-count { background: #f59e0b; }
        .zone-green .zone-count { background: #10b981; }
        
        .zone-toggle {
            color: #6b7280;
            font-size: 12px;
        }
        
        .zone-content {
            padding: 0 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .zone-content.expanded {
            max-height: 500px;
            padding-bottom: 16px;
        }
        
        .priority-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .client-badge {
            display: inline-block;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            width: fit-content;
        }
        
        .item-message {
            font-size: 14px;
            color: #111827;
        }
        
        .due-date {
            font-size: 12px;
            color: #6b7280;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-action, .btn-quick-complete {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-action {
            background: #6366f1;
            color: white;
        }
        
        .btn-action:hover {
            background: #4f46e5;
        }
        
        .btn-quick-complete {
            background: white;
            color: #10b981;
            border: 1px solid #10b981;
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-quick-complete:hover {
            background: #10b981;
            color: white;
        }
        
        /* House weather cards */
        .house-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .house-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .house-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .house-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .weather-icon {
            font-size: 24px;
        }
        
        .house-name {
            font-weight: 600;
            color: #111827;
            flex: 1;
        }
        
        .trend {
            font-size: 14px;
            font-weight: 600;
        }
        
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #6b7280; }
        
        .house-score {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .score-value {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
        }
        
        .score-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        .house-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .client-count {
            color: #6b7280;
        }
        
        .issue-count {
            color: #ef4444;
            font-weight: 500;
            cursor: pointer;
        }
        
        .no-issues {
            color: #10b981;
            font-weight: 500;
        }
        
        /* Journey radar */
        .journey-timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .journey-segment {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .journey-segment.has-clients:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .segment-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .segment-count {
            font-size: 24px;
            font-weight: 600;
        }
        
        .segment-green { color: #10b981; }
        .segment-yellow { color: #f59e0b; }
        .segment-orange { color: #f97316; }
        .segment-red { color: #ef4444; }
        .segment-purple { color: #8b5cf6; }
        
        .segment-connector {
            color: #d1d5db;
            font-size: 20px;
        }
        
        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        .metric-item {
            text-align: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .metric-label {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .metric-detail {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .trend-indicator {
            font-size: 16px;
            font-weight: 600;
        }
        
        .trend-positive { color: #10b981; }
        .trend-negative { color: #ef4444; }
        
        /* Quick actions */
        .actions-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: #f9fafb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .action-icon {
            font-size: 20px;
        }
        
        .action-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* Responsive design */
        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        @media (min-width: 1280px) {
            .dashboard-grid {
                grid-template-columns: 3fr 2fr;
            }
        }
    </style>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .header {
            background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 15px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 153, 204, 0.25);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            display: grid !important;
            grid-template-columns: 1fr 440px; /* left: programs, right: controls */
            gap: 20px;
            min-height: 600px;
            position: relative;
            align-items: start;
            visibility: visible !important;
        }
        
        /* Dashboard-specific layout override */
        .dashboard-active .main-content {
            display: block !important;
            grid-template-columns: none !important;
        }
        
        .dashboard-active .selection-panel {
            display: none !important;
        }
        
        .dashboard-active .programs-panel {
            max-width: 100% !important;
            width: 100% !important;
        }
        
        .programs-panel {
            padding: 30px;
            overflow-y: auto;
            background: #ffffff;
            max-height: 85vh;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 1;
        }
        
        .selection-panel {
            width: 440px;
            min-width: 440px;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 20px;
            display: flex !important;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 12px;
            position: sticky;
            top: 10px;
            height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 10;
        }
        
        .document-type-selector {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .doc-type-buttons {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .doc-type-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #0099cc;
            background: white;
            color: #0099cc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .doc-type-btn.active {
            background: #0099cc;
            color: white;
        }

        .guided-btn {
            width: 100%;
            margin-bottom: 20px;
            padding: 12px 18px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #34d399, #059669);
            color: white;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .guided-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(5, 150, 105, 0.35);
        }

        .guided-btn:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .wizard-actions button {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .wizard-actions .wizard-back {
            background: #e5e7eb;
            color: #374151;
        }

        .wizard-actions .wizard-next {
            background: #4f46e5;
            color: white;
        }

        .wizard-actions .wizard-finish {
            background: #059669;
            color: white;
        }

        .wizard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .wizard-card {
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.08);
        }

        .wizard-program-list {
            display: grid;
            gap: 10px;
            max-height: 260px;
            overflow-y: auto;
        }

        .wizard-program-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
            transition: border-color 0.2s ease;
        }

        .wizard-program-item input[type="checkbox"] {
            margin-top: 4px;
            transform: scale(1.1);
        }

        .wizard-program-item.active {
            border-color: #4f46e5;
            box-shadow: 0 4px 14px rgba(79, 70, 229, 0.18);
            background: #eef2ff;
        }

        .wizard-program-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .wizard-program-meta .name {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-program-meta .location {
            font-size: 12px;
            color: #4b5563;
        }

        .wizard-program-meta .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .wizard-program-meta .chip {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .wizard-toggles {
            display: grid;
            gap: 10px;
        }

        .wizard-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
        }

        .wizard-toggle span {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-note {
            font-size: 13px;
            color: #4b5563;
            background: #ecfeff;
            border-left: 4px solid #0891b2;
            padding: 12px 14px;
            border-radius: 8px;
        }

        .wizard-no-results {
            text-align: center;
            padding: 30px 20px;
            color: #6b7280;
            font-size: 14px;
            border: 1px dashed #cbd5f5;
            border-radius: 10px;
            background: #f8fafc;
        }

        .input-error {
            border-color: #f87171 !important;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2) !important;
        }

        .document-preview-modal {
            max-width: 95%;
            width: 900px;
        }

        /* Document preview container - clean and simple */
        #documentPreviewContainer {
            background: white;
            margin: 0 auto;
            padding: 40px 60px;
            box-sizing: border-box;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        /* Ensure all document styles apply in preview */
        #documentPreviewContainer .doc-page {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        #documentPreviewContainer .doc-content {
            padding-bottom: 40px;
        }
        
        #documentPreviewContainer .doc-footer {
            position: relative;
            bottom: auto;
            margin-top: 40px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media screen and (max-width: 900px) {
            #documentPreviewContainer {
                padding: 20px 30px;
            }
        }
        
        .client-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .client-info h3 {
            color: #0c4a6e;
            margin-bottom: 14px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .client-info input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            margin-bottom: 0;
            font-family: -apple-system, 'Calibri', Arial, sans-serif;
            font-size: 15px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .client-info input:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        /* Checkbox specific styles */
        #includeAtHome {
            accent-color: #0099cc;
            transform: scale(1.1);
            margin-right: 2px;
        }
        
        #includeAtHome:hover {
            transform: scale(1.2);
        }
        
        .search-container {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
        }
        
        .search-box {
            width: 100%;
            padding: 14px 18px;
            padding-right: 120px; /* Space for button */
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        .search-indicator {
            display: none;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .add-program-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            background: linear-gradient(45deg, #0099cc, #00b4d8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 153, 204, 0.3);
            z-index: 10;
        }
        
        .add-program-btn.show {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .add-program-btn:hover {
            background: linear-gradient(45deg, #0088bb, #00a3c7);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 153, 204, 0.4);
        }
        
        .add-program-btn:active {
            transform: translateY(-50%) scale(0.98);
        }
        
        .search-animation {
            animation: searchPulse 2s infinite;
        }
        
        @keyframes searchPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .add-animation {
            animation: addSuccess 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes addSuccess {
            0% { transform: translateY(-50%) scale(1); }
            20% { transform: translateY(-50%) scale(1.2) rotate(5deg); }
            40% { transform: translateY(-50%) scale(0.9) rotate(-3deg); }
            60% { transform: translateY(-50%) scale(1.1) rotate(2deg); }
            80% { transform: translateY(-50%) scale(0.95) rotate(-1deg); }
            100% { transform: translateY(-50%) scale(1) rotate(0deg); }
        }
        
        .filter-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .filter-btn:hover {
            border-color: #0099cc;
            color: #0099cc;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .filter-btn.active {
            background: #0099cc;
            color: white;
            border-color: #0099cc;
            box-shadow: 0 2px 8px rgba(0,153,204,0.2);
        }
        
        .program-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            padding: 0;
            margin-top: 15px;
        }
        
        .program-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .program-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #cbd5e1;
        }
        
        .program-card.primary {
            border-color: #0099cc;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            box-shadow: 0 4px 12px rgba(0,153,204,0.15);
        }
        
        .program-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            background: #0099cc;
        }
        
        .program-name {
            font-weight: bold;
            font-size: 15px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .program-location {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .program-type {
            display: inline-block;
            padding: 2px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            margin-top: 5px;
        }
        
        .program-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #0099cc;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            z-index: 2;
            transition: all 0.3s;
        }
        
        .program-info-btn:hover {
            background: #0077aa;
            transform: scale(1.1);
        }
        
        .selected-section {
            flex: 0 1 auto;
            min-height: 120px;
            margin-bottom: 10px;
        }
        
        .section-title {
            font-weight: 600;
            margin: 20px 0 16px 0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            color: #1e40af;
            border-left: 4px solid #0099cc;
        }
        
        .selected-program {
            background: white;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            font-size: 13px;
            cursor: move;
            transition: all 0.3s;
        }
        
        .selected-program.dragging {
            opacity: 0.5;
            background: #f0f8ff;
        }
        
        .selected-program.drag-over {
            border-top: 3px solid #0099cc;
        }
        
        .drag-handle {
            cursor: move;
            color: #999;
            margin-right: 8px;
            font-size: 16px;
        }
        
        .program-order-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .order-btn {
            background: #0099cc;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .order-btn:hover {
            background: #0077aa;
        }
        
        .order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #0099cc, #0077aa);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,153,204,0.3);
            width: 100%;
            letter-spacing: 0.5px;
            min-height: 44px;
            max-height: 44px;
        }
        
        .generate-btn:hover {
            background: linear-gradient(135deg, #0077aa, #005588);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,153,204,0.4);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        
        .generate-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .instructions {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
            border: 1px solid #fbbf24;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(251,191,36,0.1);
        }
        
        .instructions h3 {
            color: #92400e;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .instructions ul {
            margin-left: 20px;
            color: #78350f;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .instructions ul li {
            margin-bottom: 6px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 15px;
            font-style: italic;
            font-size: 13px;
        }
        
        #selectedList {
            min-height: 80px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 10px;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border-bottom: 1px solid #2a2a3e;
        }

        body.dark-mode .panel {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .program-card {
            background: #252538;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .program-card:hover {
            background: #2a2a3e;
            border-color: #4a4a5e;
        }

        body.dark-mode .program-card.selected {
            background: #2a3f5f;
            border-color: #3498db;
        }

        body.dark-mode input[type="text"],
        body.dark-mode select {
            background: #252538;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        body.dark-mode .modal-content {
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 50px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        body.dark-mode .theme-toggle {
            background: #252538;
            border-color: #3a3a4e;
            color: #e0e0e0;
        }

        /* Comparison View Styles */
        .comparison-view {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            overflow: hidden;
        }

        .comparison-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-content {
            display: flex;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .comparison-column {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #ddd;
        }

        .comparison-column:last-child {
            border-right: none;
        }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .quick-action-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        body.dark-mode .quick-action-btn {
            background: #252538;
            border-color: #3a3a4e;
            color: #e0e0e0;
        }

        body.dark-mode .quick-action-btn:hover {
            background: #2a2a3e;
        }

        /* Document History Panel */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        
        .history-panel.active {
            display: block;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .history-item:hover {
            background: #f5f5f5;
        }

        body.dark-mode .history-panel {
            background: #1a1a2e;
        }

        body.dark-mode .history-item {
            border-bottom-color: #2a2a3e;
        }

        body.dark-mode .history-item:hover {
            background: #252538;
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .analytics-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .analytics-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 80%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: #0099cc;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            position: relative;
            z-index: 1001;
            padding: 5px;
            line-height: 1;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            color: #f0f0f0;
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            min-height: 0; /* Important for flex children */
        }
        
        .preview-section {
            margin-bottom: 20px;
        }
        
        .preview-section h3 {
            color: #0099cc;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        
        .preview-features {
            list-style: none;
            padding: 0;
        }
        
        .preview-features li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .preview-features li strong {
            color: #333;
        }
        
        .preview-contact {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        
        .preview-contact div {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .modal-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .add-from-preview {
            background: #0099cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-from-preview:hover {
            background: #0077aa;
        }
        
        .add-from-preview.selected {
            background: #dc3545;
        }
        
        /* Print Styles - Professional Clean Document */
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .main-content { flex-direction: column; }
            .programs-panel, .selection-panel { width: 100%; max-width: 100%; }
            .program-grid { grid-template-columns: 1fr; }
            .filter-buttons, .quick-actions { flex-wrap: wrap; }
            .theme-toggle { top: 10px; right: 10px; }
            .history-panel { width: 100%; }
            .comparison-view { width: 95%; }
            .comparison-content { flex-direction: column; }
        }
        
        @media print {
            @page {
                size: letter;
                margin: 1in 0.75in 1in 0.75in; /* Top, Right, Bottom, Left - content width ~6.5" */
            }
            
            /* Hide ALL UI elements during print */
            .theme-toggle,
            .history-panel,
            .comparison-view,
            .analytics-dashboard,
            .container,
            .modal,
            .quick-actions,
            #historyPanel,
            #comparisonView,
            #analyticsDashboard {
                display: none !important;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .container {
                display: none !important;
            }
            
            .document-output {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                color: black;
                font-family: Helvetica, Arial, "Segoe UI", sans-serif;
                font-size: 11pt;
                line-height: 1.6;
            }
            
            .doc-page {
                position: relative;
                width: 100%;
                padding: 0;
                page-break-inside: avoid;
                overflow: visible; /* ensure header image not clipped */
            }
            
            /* Hide web elements completely */
            .modal, .program-info-btn, .program-badge {
                display: none !important;
            }
        }
        
        /* Document output styles */
        .document-output {
            display: none;
            font-family: Helvetica, Arial, "Segoe UI", sans-serif;
            font-size: 11pt; /* Body size 11-12pt as specified */
            line-height: 1.6;
            color: #000;
        }
        
        .doc-page {
            background: white;
            position: relative;
            min-height: 100%;
            overflow: visible; /* allow header graphics to render fully */
            width: 720px; /* 7.5 inches of usable space at 96 DPI */
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .doc-content {
            padding-bottom: 100px; /* More space for footer to prevent overlap */
            padding-top: 0; /* Remove top padding */
            margin-top: 0;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: calc(100vh - 150px); /* Ensure proper page height */
        }
        
        /* Letterhead Header */
        .doc-letterhead {
            text-align: center;
                            margin-bottom: 20px;
            padding-bottom: 0;
                            margin-top: 0;
                            padding-top: 0;
                        }
                        .letterhead-image {
                            width: 100%;
                            max-width: 100%;
                            height: auto;
                            margin: 0 auto;
                            display: block;
        }
        
        .doc-letterhead-logo {
            height: 80px !important; /* fixed visual height to avoid partial decode/cropping */
            width: auto !important;
            max-width: 160px !important;
            margin: 0 auto 15px !important;
            display: block !important;
            object-fit: contain !important;
            object-position: center center !important;
            /* Ensure image loads properly in print */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .doc-logo {
            width: 200px;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }
        
        .doc-letterhead-lockup {
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }
        
        .doc-letterhead-icon {
            width: 40px;
            height: 40px;
            background: #0099cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        
        .doc-letterhead-text {
            text-align: center;
        }
        
        .doc-letterhead-text h1 {
            font-size: 24pt;
            color: #0099cc;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        
        .doc-letterhead-text p {
            font-size: 12pt;
            color: #000000;
            margin: 2px 0 0 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        /* Document Body */
        .doc-greeting {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: normal;
            margin-bottom: 8px;
        }
        
        .doc-intro {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-style: italic;
            text-decoration: underline;
            margin-bottom: 18pt;
            line-height: 1.4;
        }
        
        /* Section headers - CALIBRI 10PT BOLD (e.g., "Aftercare Options:") */
        .doc-section-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            margin: 18pt 0 14pt 0;
            text-align: left;
        }
        
        /* Category headers - CALIBRI 9PT BOLD (e.g., "PHP Options") */
        .doc-category-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: bold;
            margin: 14pt 0 10pt 0;
        }
        
        /* Program Cards */
        .doc-program {
            margin-bottom: 24pt; /* Two blank lines between programs */
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        /* Program title line with en dash - MUST BE CALIBRI 10PT BOLD */
        .doc-program-title {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            color: #000;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        /* Level of Care & Services section - MUST BE SINGLE PARAGRAPH, CALIBRI 9PT */
        .doc-program-descriptor {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-top: 12pt;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        .doc-program-descriptor strong {
            font-weight: bold;
        }
        
        /* Program Details heading - CALIBRI 9PT BOLD */
        .doc-program-details-heading {
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-size: 9pt;
            margin-bottom: 6pt;
            margin-top: 12pt;
        }
        
        /* Bullet lists - REAL BULLETS, CALIBRI 9PT */
        .doc-program-bullets {
            margin: 0 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-program-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-bottom: 4pt;
            position: relative;
            padding-left: 15px;
            line-height: 1.4;
        }
        
        .doc-program-bullets li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
        }
        
        /* Bold concept introductions in bullets */
        .doc-program-bullets li strong {
            font-weight: bold;
        }
        
        /* Sub-bullets with dashes */
        .doc-sub-bullets {
            margin: 4pt 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-sub-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            margin-bottom: 2pt;
            position: relative;
            padding-left: 15px;
        }
        
        .doc-sub-bullets li:before {
            content: "‚Äì";
            position: absolute;
            left: 0;
        }
        
        /* Contact Information block - CALIBRI 9PT */
        .doc-contact-section {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            line-height: 1.4;
            margin-top: 6pt;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .doc-contact-section strong {
            font-weight: bold;
        }
        
        .doc-contact-section a {
            word-break: break-all;
            color: #0066cc;
            text-decoration: none;
        }
        
        .doc-contact-section a:hover {
            text-decoration: underline;
        }
        
        /* Footer - stacked format */
        .doc-footer {
            position: fixed;
            bottom: 20px;
            left: 50px;
            right: 50px;
            text-align: center;
            font-size: 10pt;
            color: #333;
            background: white;
            padding: 15px 10px 10px 10px;
            border-top: 1px solid #ccc;
            z-index: 1000;
            box-shadow: 0 -2px 5px rgba(255,255,255,0.9);
            line-height: 1.4;
        }
        
        .doc-footer div {
            margin: 2px 0;
        }
        
        /* Mini card styles for AT HOME sections */
        .doc-mini-card {
            margin-bottom: 18pt;
            padding: 12pt;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafbfc;
        }
        
        .doc-mini-title {
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 8pt;
            color: #374151;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 4pt;
        }
        
        .doc-mini-blurb {
            font-size: 10pt;
            margin-bottom: 8pt;
            min-height: 24pt;
            border-bottom: 1px dotted #9ca3af;
            padding-bottom: 4pt;
            color: #6b7280;
        }
        
        .doc-mini-contact {
            font-size: 10pt;
            color: #374151;
        }
        
        .doc-mini-contact .contact-line {
            display: flex;
            align-items: center;
            margin-bottom: 4pt;
        }
        
        .doc-mini-contact .contact-label {
            font-weight: 600;
            min-width: 70px;
            color: #1f2937;
        }
        
        .doc-mini-contact .contact-fill {
            flex: 1;
            border-bottom: 1px solid #d1d5db;
            min-height: 16pt;
            margin-left: 8px;
        }
        
        /* Special emphasis for AT HOME Recommendation */
        .doc-emphasis-section {
            font-family: Calibri, Arial, sans-serif;
            font-size: 10pt;
            font-style: italic;
            text-decoration: underline;
        }
        
        /* Print-specific styles for blank lines */
        @media print {
            .doc-mini-title, .doc-mini-blurb, .doc-mini-contact {
                min-height: 1.2em;
            }
            
            .doc-footer {
                position: fixed;
                bottom: 0.5in;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 10pt;
                color: #333;
                background: white;
                padding: 10px 0;
                z-index: 100;
            }
            
            .doc-content {
                padding-bottom: 80px; /* More space for fixed footer */
            }
        }
        
        /* Delete button for custom programs */
        .program-delete-btn {
            position: absolute;
            top: 8px;
            right: 38px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: all 0.2s ease;
            z-index: 10;
            opacity: 0.8;
        }
        
        .program-delete-btn:hover {
            opacity: 1;
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .program-delete-btn:active {
            transform: scale(0.95);
        }
        
        /* Login Form Styles */
        .login-content .form-group {
            margin-bottom: 20px;
        }
        
        .login-content .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }
        
        .login-content .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .login-content .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-content .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-content .login-btn:hover {
            transform: translateY(-2px);
        }
        
        /* User Profile Button */
        .user-profile-btn {
            position: fixed;
            top: 20px;
            right: 160px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid white;
            color: white;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }
        
        .user-profile-btn:active {
            transform: translateY(0);
        }
        
        /* User Menu Dropdown */
        .user-menu {
            position: fixed;
            top: 75px;
            right: 100px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 999;
            animation: slideDown 0.2s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Welcome Animation */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            animation: overlayFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: opacity, transform;
        }
        
        .welcome-overlay.fade-out {
            animation: overlayFadeOut 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes overlayFadeIn {
            from { 
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to { 
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }
        
        @keyframes overlayFadeOut {
            0% { 
                opacity: 1;
                backdrop-filter: blur(10px);
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                backdrop-filter: blur(5px);
                transform: scale(1.01);
            }
            100% { 
                opacity: 0;
                backdrop-filter: blur(0px);
                transform: scale(1.05);
            }
        }
        
        .welcome-message {
            color: white;
            text-align: center;
            animation: messageSlideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center center;
            will-change: transform, opacity;
        }
        
        .welcome-message.fade-out {
            animation: messageFadeDown 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .welcome-message h1 {
            font-size: 48px;
            margin: 0 0 15px 0;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.1);
            background: linear-gradient(90deg, #fff, rgba(255,255,255,0.8), #fff);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shimmerText 3s ease-in-out infinite;
        }
        
        .welcome-message p {
            font-size: 24px;
            margin: 0 0 30px 0;
            opacity: 0.95;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        @keyframes shimmerText {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }
        
        @media (max-width: 768px) {
            .welcome-message h1 {
                font-size: 32px;
            }
            
            .welcome-message p {
                font-size: 18px;
                margin: 0 0 20px 0;
            }
            
            .welcome-progress {
                width: 150px;
            }
        }
        
        .welcome-progress {
            width: 200px;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .welcome-progress-bar {
            height: 100%;
            background: white;
            border-radius: 3px;
            animation: progressFill 2.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        @keyframes messageSlideUp {
            0% {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            60% {
                opacity: 1;
                transform: translateY(-5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes messageFadeDown {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
        }
        
        @keyframes progressFill {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: #1a202c;
        }
        
        .user-username {
            font-size: 13px;
            color: #718096;
        }
    </style>
</head>
<body>
    
    <!-- AUTO-LOGIN FOR TESTING - REMOVE IN PRODUCTION -->
    <script>
        // Check if we're on the login page
        (function() {
            // Check for login form presence
            setTimeout(function() {
                const hasLoginForm = document.querySelector('input[type="password"]');
                const isLoggedIn = sessionStorage.getItem('isLoggedIn');
                
                if (hasLoginForm && isLoggedIn !== 'true') {
                    console.log('Login page detected, auto-logging in...');
                    
                    // Set session storage
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('username', 'MasterAdmin');
                    sessionStorage.setItem('userRole', 'admin');
                    
                    // Force reload to show main interface
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                }
            }, 100);
            
            // Also check on DOMContentLoaded
            document.addEventListener('DOMContentLoaded', function() {
                const hasLoginForm = document.querySelector('input[type="password"]');
                const isLoggedIn = sessionStorage.getItem('isLoggedIn');
                
                if (hasLoginForm && isLoggedIn !== 'true') {
                    console.log('Setting auto-login...');
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('username', 'MasterAdmin');
                    sessionStorage.setItem('userRole', 'admin');
                    
                    // Try to hide login and show main interface
                    const loginContainer = hasLoginForm.closest('.login-container, .login-form, form');
                    if (loginContainer) {
                        loginContainer.style.display = 'none';
                    }
                    
                    // Force reload
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                }
            });
        })();
    </script>
    <!-- END AUTO-LOGIN -->
    
    
                <!-- Prominent Map Toggle Button -->
                <button id="mainMapToggle" onclick="toggleImmersiveMap()" style="
                    position: fixed;
                    bottom: 30px;
                    right: 30px;
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border: none;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
                    z-index: 9999;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <span id="mapToggleIcon">üó∫Ô∏è</span>
                </button>
    
    <!-- Login Screen -->
    <div id="loginScreen" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000; align-items: center; justify-content: center;">
        <div class="login-content" style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
            <h2 style="margin: 0 0 10px 0; color: #1a202c; text-align: center; font-size: 28px;">Family First</h2>
            <p style="text-align: center; color: #718096; margin-bottom: 30px; font-size: 14px;">ADOLESCENT SERVICES - Document Creator</p>
            
            <div id="loginError" style="display: none; background: #fed7d7; color: #9b2c2c; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;"></div>
            
            <form id="staticLoginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" name="username" required placeholder="Enter username" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" name="password" required placeholder="Enter password" autocomplete="current-password">
                </div>
                
                <button type="submit" class="login-btn">Sign In</button>
            </form>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #718096; font-size: 14px; margin-bottom: 10px;">First time here?</p>
                <button onclick="showAccountCreation()" type="button" style="
                    background: none;
                    border: 2px solid #667eea;
                    color: #667eea;
                    padding: 10px 30px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.background='#667eea'; this.style.color='white';" onmouseout="this.style.background='none'; this.style.color='#667eea';">
                    Create Your Profile
                </button>
            </div>
            
            <p style="text-align: center; margin-top: 20px; color: #a0aec0; font-size: 12px;">üîí Secure Document Generation System</p>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" style="display: block;">
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">üåô</span>
        <span id="themeText">Dark Mode</span>
    </button>
    
    <!-- User Profile Button -->
    <button class="user-profile-btn" onclick="toggleUserMenu()" id="userProfileBtn" title="User Profile">
        <span id="userInitials">?</span>
    </button>
    
    <!-- User Menu Dropdown -->
    <div class="user-menu" id="userMenu" style="display: none;">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-details">
                <div class="user-name" id="displayFullName">User</div>
                <div class="user-username" id="displayUsername">@username</div>
            </div>
        </div>
        <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">
        <button onclick="logout()" style="width: 100%; padding: 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
            üö™ Logout
        </button>
    </div>
    
    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>Document History</h3>
            <button onclick="toggleHistory()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div id="historyContent"></div>
    </div>
    
    <!-- Comparison View -->
    <div class="comparison-view" id="comparisonView">
        <div class="comparison-header">
            <h3>Program Comparison</h3>
            <button onclick="closeComparison()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div class="comparison-content" id="comparisonContent"></div>
    </div>
    
    <!-- Slide-out Menu -->
    <div id="slideMenu" class="slide-menu">
        <div class="menu-header">
            <h3>Menu</h3>
            <button class="close-menu" onclick="toggleMenu()">√ó</button>
        </div>
        <div class="menu-content">
            <div class="menu-section">
                <h4>Tools</h4>
                <button class="menu-item" onclick="showTemplates(); toggleMenu();">
                    <span class="menu-icon">üìã</span>
                    <span>Templates</span>
                </button>
                <button class="menu-item" onclick="showAnalytics().catch(console.error); toggleMenu();">
                    <span class="menu-icon">üìä</span>
                    <span>Analytics</span>
                </button>
                <button class="menu-item" onclick="showHelp(); toggleMenu();">
                    <span class="menu-icon">‚ùì</span>
                    <span>Help & Shortcuts</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Data</h4>
                <button class="menu-item" onclick="exportData(); toggleMenu();">
                    <span class="menu-icon">üì§</span>
                    <span>Export Data</span>
                </button>
                <button class="menu-item" onclick="importData(); toggleMenu();">
                    <span class="menu-icon">üì•</span>
                    <span>Import Data</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Program Database</h4>
                <button class="menu-item" onclick="openProgramManager(); toggleMenu();">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <span>Manage Programs</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Actions</h4>
                <button class="menu-item" onclick="saveAsTemplate(); toggleMenu();">
                    <span class="menu-icon">üíæ</span>
                    <span>Save as Template</span>
                </button>
                <button class="menu-item" onclick="clearAllPrograms(); toggleMenu();">
                    <span class="menu-icon">üóëÔ∏è</span>
                    <span>Clear All Programs</span>
                </button>
            </div>
        </div>
    </div>
    
    <style>
        .slide-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        
        .slide-menu.active {
            right: 0;
        }
        
        .menu-header {
            background: #0099cc;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close-menu {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-content {
            padding: 20px;
        }
        
        .menu-section {
            margin-bottom: 30px;
        }
        
        .menu-section h4 {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .menu-item {
            width: 100%;
            padding: 12px 15px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .menu-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* Dark mode styles for menu */
        body.dark-mode .slide-menu {
            background: #2a2a2a;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .menu-header {
            background: #1a1a2a;
        }
        
        body.dark-mode .menu-section h4 {
            color: #999;
            border-color: #444;
        }
        
        body.dark-mode .menu-item {
            background: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .menu-item:hover {
            background: #404040;
        }
        
        /* Menu overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 9998;
        }
        
        .menu-overlay.active {
            display: block;
        }

        /* ============= DASHBOARD STYLES ============= */
        .tab-navigation {
            display: flex !important;
            gap: 8px;
            margin-bottom: 20px;
            visibility: visible !important;
            padding: 10px 0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn:hover {
            background: #e0e0e0;
            border-color: #999;
        }

        .tab-btn.active {
            background: #0099cc;
            color: white;
            border-color: #0099cc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Dashboard Container */
        .dashboard-container {
            padding: 20px;
            background: #f8f9fa !important;
            min-height: calc(100vh - 200px);
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Force all dashboard text to be dark and visible */
        .dashboard-container,
        .dashboard-container *,
        #dashboardTab,
        #dashboardTab *,
        .dashboard-widget,
        .dashboard-widget * {
            color: #1a1a1a !important;
            fill: #1a1a1a !important;
        }
        
        /* Force dashboard tab to be visible when active */
        #dashboardTab.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 999999 !important;
            background: white !important;
        }
        
        /* Force main app to be visible when logged in */
        #mainApp {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            background: white !important;
        }
        
        /* Ensure body has white background */
        body {
            background: white !important;
            color: #1a1a1a !important;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dashboard-greeting {
            font-size: 28px;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .dashboard-subtitle {
            font-size: 16px;
            color: #666;
        }

        .dashboard-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            background: #f0f0f0;
            padding: 4px;
            border-radius: 8px;
        }

        .view-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: #0099cc;
            color: white;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Dashboard Widgets */
        .dashboard-widget {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 200px;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .widget-header h3 {
            margin: 0;
            font-size: 20px;
            color: #1a1a1a;
        }

        .widget-skeleton {
            padding: 40px;
            text-align: center;
            color: #999;
        }

        .widget-error {
            padding: 40px;
            text-align: center;
            color: #dc3545;
        }

        /* Flight Plan Widget */
        .priority-zones {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .priority-zone {
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        .zone-red {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .zone-purple {
            border-color: #6f42c1;
            background: #f8f5ff;
        }

        .zone-yellow {
            border-color: #ffc107;
            background: #fffef5;
        }

        .zone-green {
            border-color: #28a745;
            background: #f5fff8;
        }

        .zone-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 600;
            background: rgba(255,255,255,0.5);
        }

        .zone-icon {
            font-size: 20px;
        }

        .zone-title {
            flex: 1;
            color: #333;
        }

        .zone-count {
            background: rgba(0,0,0,0.1);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .zone-toggle {
            font-size: 12px;
            color: #666;
        }

        .zone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .zone-content.expanded {
            max-height: 2000px;
        }

        .priority-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .priority-item:last-child {
            border-bottom: none;
        }

        .priority-item-content {
            flex: 1;
        }

        .priority-item-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .priority-item-subtitle {
            font-size: 13px;
            color: #666;
        }

        .priority-item-action {
            padding: 6px 12px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .priority-item-action:hover {
            background: #0077aa;
        }

        .empty-zone {
            padding: 20px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        /* House Weather Widget */
        .house-card {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .house-card:hover {
            border-color: #0099cc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .house-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .weather-icon {
            font-size: 24px;
        }

        .house-name {
            flex: 1;
            font-weight: 600;
            font-size: 18px;
            color: #1a1a1a;
        }

        .house-score {
            text-align: center;
            margin: 12px 0;
        }

        .score-value {
            font-size: 36px;
            font-weight: bold;
            color: #0099cc;
        }

        .score-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .house-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        /* Metrics Widget */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .metric-card {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
        }

        /* Missions Widget */
        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mission-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #0099cc;
        }

        /* Quick Actions Widget */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .quick-action-button {
            padding: 16px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .quick-action-button:hover {
            border-color: #0099cc;
            background: #e6f7ff;
            transform: translateY(-2px);
        }

        .quick-action-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .quick-action-label {
            font-weight: 600;
            color: #1a1a1a;
        }
    </style>
    
    <!-- Menu Overlay -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>
    
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="header-text">
                    <h1>CareConnect Pro</h1>
                    <p>FAMILY FIRST ADOLESCENT SERVICES</p>
                </div>
            </div>
            <div class="header-right" style="display: flex; align-items: center; gap: 20px;">
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); text-align: right;">
                    Professional Aftercare Document Builder<br>
                    <small style="color: rgba(255,255,255,0.7); font-size: 12px;">v3.0 Deluxe</small><br>
                    <small id="sessionIndicator" style="color: #fbbf24; font-size: 11px; font-weight: 600; display: none;"></small>
                </div>
                <div class="header-controls" style="display: flex; gap: 10px;">
                    <button class="header-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <span id="themeIcon">üåô</span>
                    </button>
                    <button class="header-btn" onclick="toggleMenu()" title="Menu" style="font-size: 20px;">‚ò∞</button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Left Panel: Program List -->
            <div class="programs-panel">
                
                <!-- Tab Navigation -->
                <div class="tab-navigation" style="display: flex !important; gap: 8px; margin-bottom: 20px; visibility: visible !important;">
                    <button class="tab-btn" onclick="switchTab('dashboard')">
                        <span>üéØ Dashboard</span>
                    </button>
                    <button class="tab-btn active" onclick="switchTab('programs')">
                        <span>üìã Programs</span>
                    </button>
                    <button class="tab-btn" onclick="switchTab('clients')">
                        <span>üë• Clients</span>
                    </button>
                </div>
                
                <!-- Dashboard Tab Content -->
                <div id="dashboardTab" class="tab-content">
                    <div class="dashboard-container">
                        <div class="dashboard-header">
                            <div>
                                <div class="dashboard-greeting" id="dashboardGreeting">Good morning</div>
                                <div class="dashboard-subtitle" id="dashboardSubtitle">Here's your morning priorities</div>
                            </div>
                            <div class="dashboard-controls">
                                <div class="view-toggle">
                                    <button class="active" onclick="dashboardManager.currentView='myClients'; dashboardManager.refreshDashboard()">My Clients</button>
                                    <button onclick="dashboardManager.currentView='allClients'; dashboardManager.refreshDashboard()">All Clients</button>
                                </div>
                                <div style="text-align: right; font-size: 13px; color: #6b7280;">
                                    <div id="coachIndicator">Coach: --</div>
                                    <div id="lastUpdateTime">Last updated: --</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                            <!-- Left column widgets -->
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <!-- North Star Metrics -->
                                <div id="metricsWidget" class="dashboard-widget"></div>
                                
                                <!-- Daily Flight Plan -->
                                <div id="flightPlanWidget" class="dashboard-widget"></div>
                                
                                <!-- Today's Missions -->
                                <div id="missionsWidget" class="dashboard-widget"></div>
                            </div>
                            
                            <!-- Right column widgets -->
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <!-- House Weather System -->
                                <div id="houseWeatherWidget" class="dashboard-widget"></div>
                                
                                <!-- Client Journey Radar -->
                                <div id="journeyRadarWidget" class="dashboard-widget"></div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions (full width) -->
                        <div id="quickActionsWidget" class="dashboard-widget" style="margin-top: 20px;"></div>
                    </div>
                </div>
                
                <script>
                    // Tab switching function
                    function switchTab(tab) {
                        try {
                            console.log('Switching to tab:', tab);
                            console.trace('Tab switch called from:');
                            
                            // Don't block manual tab switches - only auto-switches at load
                            // if (window.blockTabSwitches && tab !== 'clients' && tab !== 'dashboard') {
                            //     console.warn('üõë BLOCKED tab switch to:', tab);
                            //     return;
                            // }
                            
                            // Remove active class from all tabs and buttons
                            document.querySelectorAll('.tab-content').forEach(t => {
                                if (t) t.classList.remove('active');
                            });
                            document.querySelectorAll('.tab-btn').forEach(b => {
                                if (b) b.classList.remove('active');
                            });
                            
                            // Add active class to selected tab
                            const tabElement = document.getElementById(tab + 'Tab');
                            if (tabElement) {
                                tabElement.classList.add('active');
                                console.log('Activated tab:', tab + 'Tab');
                            } else {
                                console.warn('Tab element not found:', tab + 'Tab');
                            }
                            
                            // Add active class to corresponding button
                            const tabButtons = document.querySelectorAll('.tab-btn');
                            tabButtons.forEach(btn => {
                                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tab)) {
                                    btn.classList.add('active');
                                    console.log('Activated button for:', tab);
                                }
                            });
                            
                            // Special handling for dashboard tab
                            if (tab === 'dashboard') {
                                // Add class to body for dashboard-specific styles
                                document.body.classList.add('dashboard-active');
                                
                                // Initialize dashboard if not already done
                                setTimeout(() => {
                                    if (window.dashboardManager) {
                                        if (!window.dashboardManager.initialized) {
                                            initializeDashboard();
                                        }
                                    } else {
                                        console.log('Dashboard manager not available, will retry...');
                                        setTimeout(() => {
                                            if (window.dashboardManager) {
                                                initializeDashboard();
                                            }
                                        }, 1000);
                                    }
                                }, 100);
                                
                                // Hide the selection panel for dashboard - try multiple selectors
                                const selectors = [
                                    '.selection-panel',
                                    '[class*="selection"]',
                                    '[id*="selection"]',
                                    'aside',
                                    '.sidebar'
                                ];
                                
                                selectors.forEach(selector => {
                                    const elements = document.querySelectorAll(selector);
                                    elements.forEach(el => {
                                        // Check if it contains document generation UI
                                        const hasDocGen = el.textContent && (
                                            el.textContent.includes('GENERATE DOCUMENT') ||
                                            el.textContent.includes('Document Type') ||
                                            el.textContent.includes('First Name Only') ||
                                            el.textContent.includes('Selected Programs')
                                        );
                                        if (hasDocGen) {
                                            el.style.display = 'none';
                                            el.style.visibility = 'hidden';
                                            el.setAttribute('data-dashboard-hidden', 'true');
                                        }
                                    });
                                });
                                
                                // Adjust main content layout to full width
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr';
                                    mainContent.style.maxWidth = '100%';
                                }
                                
                                // Also hide any right sidebar
                                const rightSidebar = document.querySelector('[style*="grid-column: 2"]');
                                if (rightSidebar) {
                                    rightSidebar.style.display = 'none';
                                }
                                
                                // Hide selection panel using dedicated function
                                hideSelectionPanel();
                            } else if (tab === 'programs') {
                                // Remove dashboard mode
                                document.body.classList.remove('dashboard-active');
                                
                                // Show selection panel for Programs tab
                                showSelectionPanel();
                                
                                // Restore main content layout
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr 440px';
                                    mainContent.style.maxWidth = '';
                                }
                            } else if (tab === 'clients') {
                                // For clients tab, keep full width but hide selection panel
                                document.body.classList.remove('dashboard-active');
                                
                                const selectionPanel = document.querySelector('.selection-panel');
                                if (selectionPanel) {
                                    selectionPanel.style.display = 'none';
                                }
                                
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr';
                                }
                            }
                            
                            // Save preference
                            localStorage.setItem('lastActiveTab', tab);
                        } catch (error) {
                            console.error('Error switching tabs:', error);
                        }
                    }
                    
                    // Function to show selection panel (document generation UI)
                    function showSelectionPanel() {
                        // Restore all elements marked as hidden by dashboard
                        const hiddenElements = document.querySelectorAll('[data-dashboard-hidden="true"]');
                        hiddenElements.forEach(el => {
                            el.style.display = '';
                            el.style.visibility = '';
                            el.removeAttribute('data-dashboard-hidden');
                        });
                        console.log('‚úÖ Restored selection panel');
                    }
                    
                    // Function to hide selection panel (document generation UI)
                    function hideSelectionPanel() {
                        // Find all possible selection panel elements
                        const allElements = document.querySelectorAll('*');
                        allElements.forEach(el => {
                            const text = el.textContent || '';
                            // Check if element contains document generation UI indicators
                            if (text.includes('GENERATE DOCUMENT') || 
                                text.includes('Document Type') ||
                                (text.includes('OPTIONS') && text.includes('Multiple')) ||
                                (text.includes('PLANS') && text.includes('Single')) ||
                                text.includes('First Name Only') ||
                                text.includes('Selected Programs')) {
                                
                                // Check if it's a significant container (not just a button or small element)
                                const computedStyle = window.getComputedStyle(el);
                                const isContainer = computedStyle.width && 
                                    (parseInt(computedStyle.width) > 300 || 
                                     el.offsetWidth > 300 ||
                                     el.classList.contains('selection-panel') ||
                                     el.id.includes('selection'));
                                
                                if (isContainer) {
                                    el.style.display = 'none';
                                    el.style.visibility = 'hidden';
                                    el.setAttribute('data-dashboard-hidden', 'true');
                                    console.log('‚úÖ Hidden selection panel element');
                                }
                            }
                        });
                        
                        // Also hide by common class/id patterns
                        const patterns = [
                            '.selection-panel',
                            '#selectionPanel',
                            '[class*="selection"]',
                            '[id*="selection"]',
                            'aside',
                            '.sidebar'
                        ];
                        
                        patterns.forEach(pattern => {
                            try {
                                const elements = document.querySelectorAll(pattern);
                                elements.forEach(el => {
                                    if (el.textContent && (
                                        el.textContent.includes('GENERATE') ||
                                        el.textContent.includes('Document Type')
                                    )) {
                                        el.style.display = 'none';
                                        el.style.visibility = 'hidden';
                                        el.setAttribute('data-dashboard-hidden', 'true');
                                    }
                                });
                            } catch (e) {
                                // Invalid selector, skip
                            }
                        });
                    }
                    
                    // EMERGENCY: Simple dashboard fallback
                    window.injectSimpleDashboard = function() {
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (!dashboardTab) {
                            console.error('Dashboard tab not found!');
                            return;
                        }
                        
                        dashboardTab.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important;';
                        dashboardTab.innerHTML = `
                            <div class="dashboard-container" style="padding: 20px; background: #f8f9fa !important; min-height: 600px; display: block !important;">
                                <h1 style="color: #111827 !important; margin-bottom: 20px;">üéØ Coach Dashboard (Fallback Mode)</h1>
                                <p style="color: #dc2626 !important; padding: 10px; background: #fee2e2; border-radius: 6px;">
                                    ‚ö†Ô∏è Dashboard widgets failed - showing emergency fallback
                                </p>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <h3 style="color: #374151 !important;">üìä Dashboard Status</h3>
                                        <p style="color: #059669 !important;">‚úÖ Fallback dashboard loaded</p>
                                        <p style="color: #4b5563 !important;">Time: ${new Date().toLocaleTimeString()}</p>
                                    </div>
                                    
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <h3 style="color: #374151 !important;">üîß Quick Fix</h3>
                                        <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                            üîÑ Reload Page
                                        </button>
                                        <button onclick="window.clearCacheAndReload()" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                                            üóëÔ∏è Clear Cache & Reload
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 30px; padding: 20px; background: #dbeafe; border-radius: 8px;">
                                    <h3 style="color: #1e40af !important;">‚ÑπÔ∏è What Happened?</h3>
                                    <p style="color: #1e40af !important;">The dashboard widgets failed to render. This fallback ensures you can still see something.</p>
                                    <p style="color: #1e40af !important; margin-top: 10px;">To fix: Try clearing browser cache or using a different browser.</p>
                                </div>
                            </div>
                        `;
                        
                        console.log('‚úÖ Simple fallback dashboard injected successfully');
                        return true;
                    }
                    
                    // Auto-inject fallback if main dashboard fails
                    setTimeout(() => {
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (dashboardTab && dashboardTab.classList.contains('active')) {
                            const widgets = document.querySelectorAll('.dashboard-widget');
                            if (widgets.length === 0) {
                                console.warn('‚ö†Ô∏è No dashboard widgets found after 3 seconds, injecting fallback');
                                window.injectSimpleDashboard();
                            }
                        }
                    }, 3000);
                    
                    // Initialize dashboard
                    async function initializeDashboard() {
                        if (!window.dashboardManager) {
                            console.log('Dashboard manager not loaded yet, retrying...');
                            setTimeout(initializeDashboard, 500);
                            return;
                        }
                        
                        if (!window.dashboardWidgets) {
                            console.log('Dashboard widgets not loaded yet, retrying...');
                            setTimeout(initializeDashboard, 500);
                            return;
                        }
                        
                        // Wait for required managers to be available (with timeout)
                        const waitStartTime = window.dashboardWaitStartTime || (window.dashboardWaitStartTime = Date.now());
                        const maxWaitTime = 30000; // 30 seconds max wait
                        
                        if (Date.now() - waitStartTime > maxWaitTime) {
                            console.error('Dashboard initialization timed out after 30 seconds');
                            console.log('Manager states:', {
                                clientManager: !!window.clientManager,
                                housesManager: !!window.housesManager,
                                milestonesManager: !!window.milestonesManager
                            });
                            // Continue anyway with available managers
                        } else if (!window.clientManager || !window.housesManager) {
                            // Only clientManager and housesManager are truly required
                            console.log('Waiting for essential managers...', {
                                clientManager: !!window.clientManager,
                                housesManager: !!window.housesManager,
                                milestonesManager: !!window.milestonesManager
                            });
                            setTimeout(initializeDashboard, 500);
                            return;
                        } else if (!window.milestonesManager) {
                            // Log warning but continue initialization
                            console.warn('MilestonesManager not available - dashboard will have limited functionality');
                        }
                        
                        try {
                            await dashboardManager.initialize();
                            
                            // Update greeting
                            const greeting = dashboardManager.getTimeAwareGreeting();
                            document.getElementById('dashboardGreeting').textContent = greeting.greeting;
                            document.getElementById('dashboardSubtitle').textContent = greeting.focus;
                            
                            // Update coach indicator
                            document.getElementById('coachIndicator').textContent = `Coach: ${dashboardManager.currentCoach.initials}`;
                            
                            // Initialize and render widgets
                            await window.dashboardWidgets.initialize();
                            await dashboardManager.loadDashboardData();
                            await window.dashboardWidgets.renderAll();
                            
                            // Ensure selection panel is hidden on dashboard
                            hideSelectionPanel();
                            
                            // Update last updated time
                            const updateTime = () => {
                                const now = new Date();
                                document.getElementById('lastUpdateTime').textContent = 
                                    `Last updated: ${now.toLocaleTimeString()}`;
                            };
                            updateTime();
                            setInterval(updateTime, 60000); // Update every minute
                            
                            // Clean up wait timer
                            delete window.dashboardWaitStartTime;
                            
                            console.log('‚úÖ Dashboard initialized successfully');
                        } catch (error) {
                            console.error('Failed to initialize dashboard:', error);
                            // Clean up wait timer on error too
                            delete window.dashboardWaitStartTime;
                        }
                    }
                    
                    // Set programs as default on page load
                    document.addEventListener('DOMContentLoaded', function() {
                        // Start with Programs tab as default
                        const defaultTab = 'programs';
                        
                        // Load programs tab by default
                        setTimeout(() => {
                            switchTab(defaultTab);
                        }, 100);
                        
                        // Diagnostic scripts removed - no longer needed
                        // These were temporary fixes that caused console noise
                        
                        /* Commented out diagnostic scripts:
                        // Run diagnostics after a delay
                        setTimeout(() => {
                            const script = document.createElement('script');
                            script.src = 'dashboard-diagnostics-fix.js?v=' + Date.now();
                            document.body.appendChild(script);
                        }, 2000);
                        
                        // Apply visibility fix
                        setTimeout(() => {
                            const fixScript = document.createElement('script');
                            fixScript.src = 'dashboard-visibility-fix.js?v=' + Date.now();
                            document.body.appendChild(fixScript);
                        }, 2500);
                        
                        // Apply parent visibility fix immediately
                        setTimeout(() => {
                            const parentFixScript = document.createElement('script');
                            parentFixScript.src = 'parent-visibility-fix.js?v=' + Date.now();
                            document.body.appendChild(parentFixScript);
                        }, 500);
                        */
                    });
                    
                    // Helper function for notifications
                    function showNotification(message, type = 'info') {
                        const notification = document.createElement('div');
                        notification.className = `notification notification-${type}`;
                        notification.innerHTML = `
                            <div class="notification-content">
                                <div class="notification-message">${message}</div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                        
                        // Add styles if not already present
                        if (!document.querySelector('#notificationStyles')) {
                            const style = document.createElement('style');
                            style.id = 'notificationStyles';
                            style.textContent = `
                                .notification {
                                    position: fixed;
                                    top: 20px;
                                    right: 20px;
                                    padding: 16px 24px;
                                    border-radius: 8px;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                    z-index: 10000;
                                    animation: slideIn 0.3s ease-out;
                                }
                                .notification-success { background: #10b981; color: white; }
                                .notification-error { background: #ef4444; color: white; }
                                .notification-info { background: #3b82f6; color: white; }
                                @keyframes slideIn {
                                    from { transform: translateX(100%); opacity: 0; }
                                    to { transform: translateX(0); opacity: 1; }
                                }
                            `;
                            document.head.appendChild(style);
                        }
                        
                        setTimeout(() => notification.remove(), 3000);
                    }
                    
                    // Helper function for modals
                    function showModal(options) {
                        const modal = document.createElement('div');
                        modal.className = 'modal';
                        modal.style.display = 'block';
                        modal.innerHTML = `
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2>${options.title}</h2>
                                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    ${options.content}
                                </div>
                                <div class="modal-actions">
                                    ${options.buttons.map(btn => 
                                        `<button onclick="${btn.action}; this.closest('.modal').remove()">${btn.text}</button>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                    
                    function closeModal() {
                        const modal = document.querySelector('.modal:last-child');
                        if (modal) modal.remove();
                    }
                </script>
                
                <!-- Programs Tab Content -->
                <div id="programsTab" class="tab-content active">
                
                <div class="quick-actions" style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="quick-action-btn" onclick="selectAllPrograms()">Select All</button>
                    <button class="quick-action-btn" onclick="clearAllPrograms()">Clear All</button>
                    <button class="quick-action-btn" onclick="openDocumentVault().catch(console.error)" style="background: #10b981; color: white;">üóÑÔ∏è Vault</button>
                    <button class="quick-action-btn" onclick="createDischargePacket()" style="background: #8b5cf6; color: white;">üì¶ DC Packet</button>
                    <button class="quick-action-btn" onclick="switchTab('clients')" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; font-weight: bold; border: 2px solid #6366f1;">
                        üë§ Clients
                    </button>
                    
                    <!-- Quick Client Switcher -->
                    <div style="position: relative; display: inline-block;">
                        <button class="quick-action-btn" onclick="toggleRecentClients()" style="background: #f59e0b; color: white; min-width: 150px;">
                            ‚ö° Recent Clients ‚ñº
                        </button>
                        <div id="recentClientsDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; margin-top: 4px; min-width: 200px;">
                            <!-- Recent clients will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Favorite Programs Section -->
                <div id="favoritePrograms" style="display: none; margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 1px solid #f59e0b;">
                    <h4 style="margin: 0 0 10px 0; color: #92400e; font-size: 14px;">‚≠ê Favorite Programs (Quick Add)</h4>
                    <div id="favoriteProgramsList" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <!-- Favorite programs will be loaded here -->
                    </div>
                    <button onclick="manageFavorites()" style="margin-top: 10px; padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        Manage Favorites
                    </button>
                </div>
                
                <div class="search-container" style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç Search programs by name, location, features, or contacts..." oninput="handleSearch(this.value)" style="flex: 1;">
                    <div class="search-indicator" id="searchIndicator" style="display: none;">üîç Searching...</div>
                    <button class="add-program-btn" id="addProgramBtn" onclick="showAddProgramDialog()" style="background: #0066cc; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; white-space: nowrap; flex-shrink: 0;">
                        ‚ûï Add New Program
                    </button>
                </div>

                
                <!-- Enhanced Filter System -->
                <div class="enhanced-filters-container" id="enhancedFiltersContainer" style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: #374151; font-size: 18px;">üîç Advanced Filters</h3>
                        <button onclick="toggleEnhancedFilters()" style="background: none; border: none; color: #6366f1; cursor: pointer; font-size: 14px;">
                            <span id="toggleFilterText">Show More</span> ‚ñº
                        </button>
                    </div>
                    
                    <!-- Enhanced Filters Grid (Initially Hidden) -->
                    <div id="enhancedFiltersGrid" style="display: none;">
                        <!-- Smart Query Panel -->
                        <div class="filter-group" style="grid-column: 1 / -1; background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <label for="naturalLanguageSearch" style="display: block; font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 8px;">
                                üß† Smart Query (natural language)
                            </label>
                            <input type="text" 
                                   class="natural-language-search" 
                                   id="naturalLanguageSearch" 
                                   placeholder="Type natural language requests like 'RTC within 50 miles that accepts Medicaid'"
                                   style="width: 100%; padding: 12px 16px; font-size: 15px; border: 2px solid #d1d5db; border-radius: 8px; transition: all 0.2s;">
                            <small style="display: block; margin-top: 6px; color: #6b7280; font-size: 13px;">
                                Tip: Auto-parses age, level of care, insurance, distance, and specialties.
                            </small>
                            <div id="nlSearchSuggestions" style="margin-top: 10px; display: none;"></div>
                        </div>
                        
                        <!-- Smart Presets -->
                        <div class="smart-presets" style="margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="smart-preset" onclick="applySmartPreset('nearby_quality')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 20px; font-size: 13px; cursor: pointer;">
                                üìç Nearby High-Quality
                            </button>
                            <button class="smart-preset" onclick="applySmartPreset('insurance_accepted')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 20px; font-size: 13px; cursor: pointer;">
                                üí≥ Accepts Insurance
                            </button>
                            <button class="smart-preset" onclick="applySmartPreset('immediate_availability')" style="padding: 6px 12px; background: white; border: 1px solid #d1d5db; border-radius: 20px; font-size: 13px; cursor: pointer;">
                                ‚ö° Available Now
                            </button>
                        </div>
                        
                        <!-- Filter Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            
                            <!-- Insurance Filter -->
                            <div class="filter-group" style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <label style="font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 8px; display: block;">
                                    üí≥ Insurance Accepted
                                </label>
                                <select id="insuranceFilter" multiple style="width: 100%; min-height: 100px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="Medicaid">Medicaid</option>
                                    <option value="Medicare">Medicare</option>
                                    <option value="Private">Private Insurance</option>
                                    <option value="BCBS">Blue Cross Blue Shield</option>
                                    <option value="Aetna">Aetna</option>
                                    <option value="United">United Healthcare</option>
                                    <option value="Cigna">Cigna</option>
                                    <option value="Tricare">Tricare</option>
                                    <option value="Self-Pay">Self-Pay</option>
                                    <option value="Sliding Scale">Sliding Scale</option>
                                </select>
                            </div>
                            
                            <!-- Cost Range Filter -->
                            <div class="filter-group" style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <label style="font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 8px; display: block;">
                                    üí∞ Cost Range
                                </label>
                                <div class="cost-checkboxes" style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" value="$" style="margin-right: 8px;"> $ (Under $10k/month)
                                    </label>
                                    <label style="display: flex; align-items: center; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" value="$$" style="margin-right: 8px;"> $$ ($10k-$20k/month)
                                    </label>
                                    <label style="display: flex; align-items: center; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" value="$$$" style="margin-right: 8px;"> $$$ ($20k-$30k/month)
                                    </label>
                                    <label style="display: flex; align-items: center; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" value="$$$$" style="margin-right: 8px;"> $$$$ (Over $30k/month)
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Demographics -->
                            <div class="filter-group" style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <label style="font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 8px; display: block;">
                                    üë• Demographics
                                </label>
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <select id="genderFilter" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <option value="">Any Gender</option>
                                        <option value="male">Male Only</option>
                                        <option value="female">Female Only</option>
                                        <option value="co-ed">Co-ed</option>
                                    </select>
                                    <input type="number" 
                                           id="ageFilter" 
                                           placeholder="Age" 
                                           min="5" 
                                           max="99"
                                           style="width: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- Location Filter -->
                            <div class="filter-group" style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <label style="font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 8px; display: block;">
                                    üìç Location
                                </label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" 
                                           id="zipCodeFilter" 
                                           placeholder="ZIP code" 
                                           pattern="[0-9]{5}"
                                           style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="number" 
                                               id="radiusFilter" 
                                               placeholder="Miles" 
                                               min="10" 
                                               max="500" 
                                               value="50"
                                               style="width: 60px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <span style="font-size: 13px; color: #6b7280;">mi</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Specialties Filter -->
                            <div class="filter-group" style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <label style="font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 8px; display: block;">
                                    üéØ Specialties
                                </label>
                                <select id="specialtiesFilter" multiple style="width: 100%; min-height: 100px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="DBT">DBT</option>
                                    <option value="CBT">CBT</option>
                                    <option value="EMDR">EMDR</option>
                                    <option value="Trauma-Informed">Trauma-Informed</option>
                                    <option value="Eating Disorder">Eating Disorder</option>
                                    <option value="Substance Abuse">Substance Abuse</option>
                                    <option value="Dual Diagnosis">Dual Diagnosis</option>
                                    <option value="LGBTQ+">LGBTQ+ Affirming</option>
                                    <option value="ASD">Autism Spectrum</option>
                                    <option value="ADHD">ADHD</option>
                                    <option value="Anxiety">Anxiety</option>
                                    <option value="Depression">Depression</option>
                                    <option value="Self-Harm">Self-Harm</option>
                                    <option value="OCD">OCD</option>
                                </select>
                            </div>
                            
                            <!-- Data Quality Filter -->
                            <div class="filter-group" style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <label style="font-weight: 600; font-size: 14px; color: #374151; margin-bottom: 8px; display: block;">
                                    üìä Data Quality (Min)
                                </label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="range" 
                                           id="dataQualityFilter" 
                                           min="0" 
                                           max="100" 
                                           value="0"
                                           style="flex: 1;">
                                    <span id="dataQualityValue" style="font-size: 14px; color: #6b7280; min-width: 40px;">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filter Actions -->
                        <div class="filter-actions" style="display: flex; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                            <button onclick="applyEnhancedFilters()" style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Apply Filters
                            </button>
                            <button onclick="clearEnhancedFilters()" style="padding: 10px 20px; background: white; color: #6b7280; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Clear All
                            </button>
                            <button onclick="saveFilterPreset()" style="padding: 10px 20px; background: white; color: #6b7280; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Save Preset
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter Results Summary -->
                    <div id="filterResultsSummary" style="margin-top: 12px; padding: 12px; background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; display: none;">
                        <span id="filterResultsText" style="color: #1e40af; font-size: 14px;"></span>
                    </div>
                </div>

                
                <!-- Interactive Map System -->
                <div id="mapSystemContainer" style="display: none; margin-top: 20px;">
                    <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden;">
                        <!-- Map Header -->
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; color: #374151; font-size: 18px; font-weight: 600;">
                                    üó∫Ô∏è Interactive Program Map
                                </h3>
                                <div style="display: flex; gap: 12px;">
                                    <button onclick="toggleMapView()" id="mapViewToggle" style="
                                        padding: 8px 16px;
                                        background: #6366f1;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        font-size: 14px;
                                    ">Show Map View</button>
                                    <button onclick="toggleVisualization('timeline')" style="
                                        padding: 8px 16px;
                                        background: white;
                                        color: #6b7280;
                                        border: 1px solid #d1d5db;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        font-size: 14px;
                                    ">üìä Timeline</button>
                                    <button onclick="toggleVisualization('cost')" style="
                                        padding: 8px 16px;
                                        background: white;
                                        color: #6b7280;
                                        border: 1px solid #d1d5db;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        font-size: 14px;
                                    ">üí∞ Cost Analysis</button>
                                </div>
                            </div>
                            
                            <!-- Map Controls -->
                            <div id="mapControls" style="display: none; margin-top: 16px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                    <!-- Location Search -->
                                    <div style="display: flex; gap: 8px;">
                                        <input type="text" 
                                               id="mapLocationSearch" 
                                               placeholder="Enter ZIP or city..."
                                               style="flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <button onclick="searchMapLocation()" style="
                                            padding: 8px 12px;
                                            background: #3b82f6;
                                            color: white;
                                            border: none;
                                            border-radius: 6px;
                                            cursor: pointer;
                                        ">Search</button>
                                    </div>
                                    
                                    <!-- Radius Control -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label style="font-size: 14px; color: #6b7280;">Radius:</label>
                                        <input type="range" 
                                               id="mapRadiusSlider" 
                                               min="10" 
                                               max="200" 
                                               value="50"
                                               style="flex: 1;">
                                        <span id="mapRadiusValue" style="font-size: 14px; color: #374151; min-width: 50px;">50 mi</span>
                                    </div>
                                    
                                    <!-- Map Type -->
                                    <select id="mapTypeSelector" onchange="changeMapType(this.value)" style="
                                        padding: 8px 12px;
                                        border: 1px solid #d1d5db;
                                        border-radius: 6px;
                                        background: white;
                                    ">
                                        <option value="street">Street Map</option>
                                        <option value="satellite">Satellite</option>
                                        <option value="terrain">Terrain</option>
                                        <option value="dark">Dark Mode</option>
                                    </select>
                                    
                                    <!-- Cluster Toggle -->
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" id="clusterToggle" checked onchange="toggleClustering(this.checked)">
                                        <span>Group Nearby Programs</span>
                                    </label>
                                </div>
                                
                                <!-- Quick Stats -->
                                <div id="mapStats" style="display: flex; gap: 20px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 12px; color: #6b7280;">Programs in view:</span>
                                        <span id="programsInView" style="font-weight: 600; color: #374151;">0</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 12px; color: #6b7280;">Within radius:</span>
                                        <span id="programsInRadius" style="font-weight: 600; color: #10b981;">0</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 12px; color: #6b7280;">Selected:</span>
                                        <span id="mapSelectedCount" style="font-weight: 600; color: #6366f1;">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Map Container -->
                        <div id="mapContainer" style="height: 500px; position: relative; display: none;">
                            <div id="programMap" style="height: 100%; width: 100%;"></div>
                            
                            <!-- Map Loading Overlay -->
                            <div id="mapLoading" style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background: rgba(255, 255, 255, 0.9);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 1000;
                            ">
                                <div style="text-align: center;">
                                    <div class="loading-spinner"></div>
                                    <p style="margin-top: 12px; color: #6b7280;">Loading map...</p>
                                </div>
                            </div>
                            
                            <!-- Distance Circle Overlay -->
                            <div id="distanceCircle" style="display: none;"></div>
                        </div>
                        
                        <!-- Alternative Visualizations -->
                        <div id="visualizationContainer" style="padding: 20px; display: none;">
                            <canvas id="chartCanvas"></canvas>
                        </div>
                        
                        <!-- Accessible Table View -->
                        <div id="accessibleTableView" style="padding: 20px; display: none;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f9fafb;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Program</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Location</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Distance</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Type</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="accessibleTableBody">
                                    <!-- Programs will be listed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                
                
                <div class="filter-buttons" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <button class="filter-btn active" onclick="filterPrograms('all', this)">All Programs</button>
                    
                    <!-- Category dropdown -->
                    <select class="filter-dropdown" onchange="filterPrograms(this.value, this)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                        <option value="">Filter by Type...</option>
                        <option value="rtc">RTC</option>
                        <option value="tbs">TBS</option>
                        <option value="wilderness">Wilderness</option>
                        <option value="php-iop">PHP/IOP</option>
                        <option value="transitional">Transitional</option>
                        <option value="virtual">Virtual</option>
                        <option value="asd">ASD</option>
                        <option value="evaluation">Evaluation</option>
                        <option value="athome">AT HOME</option>
                    </select>
                </div>
                
                <!-- Recently Used Programs -->
                <div id="recentlyUsedSection" style="display: none; margin-bottom: 20px;">
                    <h3 style="color: #0099cc; margin-bottom: 10px;">üïê Recently Used</h3>
                    <div class="recent-programs-grid" id="recentProgramsGrid">
                        <!-- Recent programs will be loaded here -->
                    </div>
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                </div>
                
                <div class="program-grid" id="programGrid">
                    <!-- Programs will be loaded here -->
                </div>
                
                </div> <!-- End of programsTab -->
                
                <!-- Clients Tab Content -->
                <div id="clientsTab" class="tab-content">
                    <div class="cm-tracker-container">
                        <!-- House Navigation -->
                        <div class="house-navigation">
                            <div class="house-tabs" id="houseTabs">
                                <!-- House tabs will be dynamically generated -->
                            </div>
                        </div>
                        
                        <!-- House Content Area -->
                        <div class="house-content" id="houseContent">
                            <div class="cm-quick-actions">
                                <button class="cm-action-btn primary" onclick="showAddClientModal()">
                                    ‚ûï Add Client
                                </button>
                                <button class="cm-action-btn" onclick="showBulkImport()">
                                    üì• Import Excel
                                </button>
                                <button class="cm-action-btn" onclick="exportCurrentHouse()">
                                    üíæ Export House
                                </button>
                                <button class="cm-action-btn" onclick="exportAllData()">
                                    üìä Export All
                                </button>
                                <button class="cm-action-btn" onclick="showReports()">
                                    üìà Reports
                                </button>
                                <button class="cm-action-btn" onclick="switchTab('programs')" style="background: #f3f4f6;">
                                    üìã Programs
                                </button>
                            </div>
                            
                            <div id="houseClientsList">
                                <!-- Client table will be dynamically generated here -->
                            </div>
                        </div>
                        
                    </div>
                </div> <!-- End of clientsTab -->
                
            </div>
            
            <!-- Right Panel: Selected Programs & Controls -->
            <div class="selection-panel">

                <div class="document-type-selector" style="margin-bottom: 20px; display: block !important; visibility: visible !important;">
                    <h3 style="font-size: 14px; color: #0099cc; margin-bottom: 8px; display: block !important;">Document Type:</h3>
                    <div class="doc-type-buttons">
                        <button class="doc-type-btn active" onclick="setDocumentType('options', this)">OPTIONS (Multiple)</button>
                        <button class="doc-type-btn" onclick="setDocumentType('plans', this)">PLANS (Single)</button>
                    </div>
                </div>

                
                <div class="client-info" style="margin-bottom: 15px;">
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px 10px; margin-bottom: 10px; font-size: 13px;">
                        <strong>‚ö†Ô∏è HIPAA:</strong> Enter first name only - No PHI
                    </div>
                    <div style="position: relative; margin-bottom: 8px;">
                        <input type="text" 
                               id="clientName" 
                               placeholder="First Name Only (Required)" 
                               style="width: 100%; padding-right: 40px; text-transform: capitalize;" 
                               oninput="validateClientName(this)"
                               onblur="handleClientNameEntry(this)"
                               maxlength="20">
                        <span id="nameValidIcon" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 16px; display: none;"></span>
                        <div id="nameValidationMsg" style="margin-top: 4px; font-size: 12px; display: none;"></div>
                    </div>
                    <label style="display: flex; align-items: center; gap: 8px; margin-top: 6px; font-size: 14px; cursor: pointer; position: relative; z-index: 10;">
                        <input type="checkbox" id="includeAtHome" style="width: 16px; height: 16px; cursor: pointer;" onchange="toggleAtHomeSection()">
                        <span>Include AT HOME Recommendations</span>
                        </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-top: 6px; font-size: 14px; cursor: pointer;">
                        <input type="checkbox" id="includeAlumni" style="width: 16px; height: 16px; cursor: pointer;">
                        <span>Include Alumni Services</span>
                    </label>
                </div>
                
                <div class="selected-section">
                    <div class="section-title" id="selectedTitle">Selected Programs (Drag to reorder)</div>
                    <div id="selectedList">
                        <div class="empty-state">Click programs to add to selection</div>
                    </div>
                </div>
                    
                <!-- Original AT HOME Providers Section -->
                <div id="atHomeSection" style="display: none; margin-top: 15px; padding: 0; border: 1px solid #e0e7ff; border-radius: 8px; background: #f8fafc; width: 100%; box-sizing: border-box; position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); cursor: pointer; border-bottom: 2px solid #0099cc; transition: all 0.2s ease;" 
                         onmouseover="this.style.background='linear-gradient(135deg, #e0f2fe, #bae6fd)'" 
                         onmouseout="this.style.background='linear-gradient(135deg, #f0f9ff, #e0f2fe)'" 
                         onclick="toggleAtHomeContent()">
                        <h4 style="margin: 0; color: #0099cc; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            AT HOME Providers
                            <span id="atHomeProviderCount" style="background: #0099cc; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: normal;"></span>
                        </h4>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="atHomeToggleText" style="color: #0099cc; font-size: 12px; font-weight: 600; text-transform: uppercase;">Expand</span>
                            <button type="button" id="atHomeToggleBtn" style="background: #0099cc; color: white; border: none; border-radius: 4px; font-size: 20px; cursor: pointer; padding: 2px 8px; line-height: 1; font-weight: bold; box-shadow: 0 2px 4px rgba(0,153,204,0.3);">‚ñ∂</button>
                    </div>
                </div>
                    <div id="atHomeContent" style="padding: 15px; display: none; transition: all 0.3s ease; max-height: 350px; overflow-y: auto; border-top: 1px solid #e0e7ff; position: relative;">
                        <div id="atHomeProviders" style="margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; padding-bottom: 5px; border-top: 1px solid #f0f0f0; padding-top: 10px;">
                            <button type="button" onclick="addAtHomeProvider()" style="padding: 8px 16px; background: #0099cc; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                + Add Provider
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Generate button at bottom -->
                <div style="margin-top: auto; padding-top: 20px;">
                    <button class="generate-btn" id="generateBtn" onclick="generateDocument()" style="width: 100%;" title="Keyboard shortcut: Ctrl+Enter (or Cmd+Enter on Mac)">
                        üìÑ GENERATE DOCUMENT
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Program Details</h2>
                <button class="modal-close" onclick="closePreview()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-actions">
                <button id="modalAddBtn" class="add-from-preview" onclick="toggleFromPreview()">Add to Selection</button>
                <button onclick="closePreview()" style="padding: 10px 20px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Add Custom Program Modal -->
    <div id="addProgramModal" class="modal">
        <div class="modal-content" style="max-width: 750px; max-height: 85vh;">
            <div class="modal-header">
                <h2>Add Custom Program</h2>
                <button class="modal-close" onclick="closeAddProgramModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- Chrome Extension Info -->
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                    <h3 style="margin: 0 0 10px 0; color: white; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üîç</span>
                        Chrome Extension - The Best Way to Add Programs
                    </h3>
                    <p style="margin: 0 0 15px 0; font-size: 16px; line-height: 1.5;">
                        The Family First Program Extractor Chrome Extension automatically extracts program information from any treatment center website with advanced pattern matching and multi-page analysis.
                    </p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; color: white;">‚úÖ Features:</h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                                <li>Extracts from multiple pages</li>
                                <li>Finds contact info automatically</li>
                                <li>Detects therapies & specializations</li>
                                <li>Works on any program website</li>
                                <li>No API keys needed</li>
                            </ul>
                        </div>
                        <div style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; color: white;">üì• Simple Steps:</h4>
                            <ol style="margin: 0; padding-left: 20px; font-size: 14px;">
                                <li>Install the extension</li>
                                <li>Visit any program website</li>
                                <li>Click extension icon</li>
                                <li>Click "Extract Page Info"</li>
                                <li>Click "Copy to Tool"</li>
                                <li>Data appears here instantly!</li>
                            </ol>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 6px; text-align: center;">
                        <p style="margin: 0; font-size: 14px;">
                            <strong>üìÅ Extension Location:</strong> Load the chrome-extension folder from Chrome Extensions page
                        </p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;">
                            <strong>No server needed!</strong> Just open this HTML file directly in Chrome
                        </p>
                    </div>
                </div>
                
                <!-- Mode Toggle -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    <button id="manualModeBtn" onclick="setAddProgramMode('manual')" style="flex: 1; padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                        ‚úçÔ∏è Manual Text Entry
                    </button>
                    <button id="templateModeBtn" onclick="setAddProgramMode('template')" style="flex: 1; padding: 12px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s;">
                        üìã Template Format
                    </button>
                </div>
                
                <!-- AI Mode Content - Removed -->
                <div id="aiModeContent" style="display: none;">
                <div style="margin-bottom: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #0066cc;">
                        <p style="margin: 0; color: #0066cc; font-weight: 600;">üåê Enter the program's website URL and AI will extract all information automatically</p>
                    </div>
                    
                    <label for="programUrl" style="display: block; margin-bottom: 10px; font-weight: 600;">
                        Program Website URL:
                    </label>
                    <input 
                        type="url" 
                        id="programUrl" 
                        placeholder="https://www.example-program.com" 
                        style="width: 100%; padding: 15px; border: 2px solid #4f46e5; border-radius: 8px; font-size: 16px; margin-bottom: 10px;"
                        onkeypress="if(event.key === 'Enter') extractProgram()"
                    >
                    <small style="color: #6b7280; display: block; margin-bottom: 20px;">Example: https://www.trinityteen.com or https://newlifehouserecovery.com</small>
                    
                    <!-- Progress Tracker -->
                    <div id="aiProgressTracker" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin: 20px 0; color: white;">
                        <h4 style="margin-top: 0; color: white; font-size: 18px;">üöÄ AI Extraction in Progress</h4>
                        <div id="progressSteps" style="margin: 15px 0;">
                            <div class="progress-step" id="step1" style="display: flex; align-items: center; margin: 10px 0; opacity: 0.5;">
                                <span class="step-icon" style="font-size: 20px; margin-right: 10px;">‚è≥</span>
                                <span class="step-text">Validating URL format...</span>
                                <span class="step-time" style="margin-left: auto; font-size: 12px;"></span>
                            </div>
                            <div class="progress-step" id="step2" style="display: flex; align-items: center; margin: 10px 0; opacity: 0.5;">
                                <span class="step-icon" style="font-size: 20px; margin-right: 10px;">‚è≥</span>
                                <span class="step-text">Fetching website content...</span>
                                <span class="step-time" style="margin-left: auto; font-size: 12px;"></span>
                            </div>
                            <div class="progress-step" id="step3" style="display: flex; align-items: center; margin: 10px 0; opacity: 0.5;">
                                <span class="step-icon" style="font-size: 20px; margin-right: 10px;">‚è≥</span>
                                <span class="step-text">Analyzing with AI model...</span>
                                <span class="step-time" style="margin-left: auto; font-size: 12px;"></span>
                            </div>
                            <div class="progress-step" id="step4" style="display: flex; align-items: center; margin: 10px 0; opacity: 0.5;">
                                <span class="step-icon" style="font-size: 20px; margin-right: 10px;">‚è≥</span>
                                <span class="step-text">Formatting program data...</span>
                                <span class="step-time" style="margin-left: auto; font-size: 12px;"></span>
                            </div>
                        </div>
                        <div id="progressDetails" style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 120px; overflow-y: auto; display: none;"></div>
                        <div id="progressError" style="margin-top: 15px; padding: 12px; background: rgba(255,0,0,0.2); border-radius: 8px; display: none;"></div>
                    </div>
                </div>
                
                <!-- Manual Mode Content -->
                <div id="manualModeContent" style="display: none;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <p style="margin: 0; color: #92400e; font-weight: 600;">üìã Paste program information from any source</p>
                        <p style="margin: 5px 0 0 0; color: #92400e; font-size: 14px;">‚Ä¢ Paste content extracted by the Chrome Extension</p>
                        <p style="margin: 2px 0 0 0; color: #92400e; font-size: 14px;">‚Ä¢ Or paste from emails, PDFs, or other sources</p>
                        <p style="margin: 2px 0 0 0; color: #92400e; font-size: 14px;">‚Ä¢ Use "Smart Format" for automatic pattern-based formatting</p>
                </div>
                
                <label for="customProgramInfo" style="display: block; margin-bottom: 10px; font-weight: 600;">
                    Paste Program Information:
                </label>
                <textarea 
                    id="customProgramInfo" 
                    placeholder="Paste program details here (from website, brochure, email, etc). Include:&#10;‚Ä¢ Program name&#10;‚Ä¢ Location&#10;‚Ä¢ Phone number&#10;‚Ä¢ Level of care (RTC, PHP, IOP, etc)&#10;‚Ä¢ Age range&#10;‚Ä¢ Treatment specialties&#10;‚Ä¢ Any other relevant information"
                        style="width: 100%; height: 250px; padding: 15px; border: 2px solid #f59e0b; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                ></textarea>
                </div>
                
                <!-- Template Mode Content -->
                <div id="templateModeContent" style="display: none;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <p style="margin: 0; color: #075985; font-weight: 600;">üìã Use our structured template to format program information (Chrome Extension compatible)</p>
                    </div>
                    
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Program Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="templateName" placeholder="e.g., Healing Springs Treatment Center" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Location</label>
                            <input type="text" id="templateLocation" placeholder="e.g., Denver, Colorado" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Phone Number</label>
                                <input type="tel" id="templatePhone" placeholder="e.g., (555) 123-4567" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Email</label>
                                <input type="email" id="templateEmail" placeholder="e.g., admissions@program.com" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Level of Care</label>
                                <select id="templateLevel" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                                    <option value="">Select level...</option>
                                    <option value="RTC">RTC - Residential Treatment Center</option>
                                    <option value="PHP">PHP - Partial Hospitalization</option>
                                    <option value="IOP">IOP - Intensive Outpatient</option>
                                    <option value="Outpatient">Outpatient</option>
                                    <option value="Sober Living">Sober Living</option>
                                    <option value="Wilderness">Wilderness Therapy</option>
                                    <option value="Therapeutic Boarding School">Therapeutic Boarding School</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Age Range</label>
                                <input type="text" id="templateAges" placeholder="e.g., 12-17 years" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Treatment Specialties</label>
                            <textarea id="templateSpecialties" placeholder="e.g., Depression, Anxiety, Trauma, ADHD, Substance Use, etc." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Therapeutic Modalities</label>
                            <textarea id="templateModalities" placeholder="e.g., CBT, DBT, EMDR, Family Therapy, Group Therapy, Art Therapy, etc." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Insurance/Payment</label>
                            <textarea id="templateInsurance" placeholder="e.g., Accepts most major insurance, Private pay, Financial assistance available" style="width: 100%; height: 60px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Program Description</label>
                            <textarea id="templateDescription" placeholder="Brief description of the program, philosophy, and unique features..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #334155;">Website URL</label>
                            <input type="url" id="templateWebsite" placeholder="https://www.example-program.com" style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 1px solid #fde68a;">
                        <p style="margin: 0; font-size: 14px; color: #92400e;">
                            <strong>üí° Tip:</strong> Use the Chrome Extension to extract data from any treatment program website. The extension will automatically populate these fields when you click "Copy to Tool".
                        </p>
                    </div>
                </div>
                
                <div id="customProgramStatus" style="margin: 15px 0;"></div>
            </div>
            <div class="modal-actions">
                <button id="smartFormatBtn" onclick="smartFormatProgram()" style="padding: 14px 28px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.3s;">
                    üéØ Smart Format & Add Program
                </button>
                <button id="addTemplateBtn" onclick="addTemplateProgram()" style="padding: 14px 28px; background: #0284c7; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.3s; display: none;">
                    üìã Add Template Program
                </button>
                <button onclick="closeAddProgramModal()" style="padding: 14px 28px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- Document Preview Modal -->
    <div id="documentPreviewModal" class="modal">
        <div class="modal-content document-preview-modal">
            <div class="modal-header">
                <h2>Document Preview</h2>
                <button class="modal-close" onclick="closeDocumentPreview()">&times;</button>
            </div>
            <div class="modal-body" style="background: #f3f4f6; padding: 20px;">
                <!-- Case Manager Workflow Options -->
            <div style="background: linear-gradient(135deg, #f0f4ff, #e5edff); border-radius: 12px; padding: 16px; margin: 16px 0; border: 1px solid #667eea;">
                <h4 style="margin: 0 0 12px 0; color: #4c1d95; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                    <span>üë•</span> Case Manager Options
                </h4>
                
                <!-- Document Actions Row 1 -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px;">
                    <button onclick="downloadDocumentPdf(event)" style="padding: 10px 12px; border-radius: 6px; border: none; background: #4f46e5; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span>üìÑ</span> Download PDF
                    </button>
                    <button onclick="printDocumentPreview()" style="padding: 10px 12px; border-radius: 6px; border: none; background: #0ea5e9; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span>üñ®Ô∏è</span> Print Document
                    </button>
                    <button onclick="emailDocument()" style="padding: 10px 12px; border-radius: 6px; border: none; background: #10b981; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span>üìß</span> Email Document
                    </button>
                </div>
                
                <!-- Document Actions Row 2 - Context Aware -->
                <div id="contextActionsRow" style="display: grid; gap: 8px;">
                    <!-- Dynamically populated based on document type -->
                </div>
            </div>
            
            <!-- Document Preview Container -->
                <div id="documentPreviewContainer" class="document-preview-container"></div>
            </div>
            
            <div class="modal-actions" style="justify-content: space-between;">
                <div style="display: flex; gap: 10px;">
                    <button onclick="generateNewDocument()" style="padding: 10px 20px; border-radius: 8px; border: none; background: #059669; color: white; font-weight: 600; cursor: pointer;">‚ú® Generate New</button>
                </div>
                <button onclick="closeDocumentPreview()" style="padding: 10px 20px; border-radius: 8px; border: none; background: #e5e7eb; color: #374151; font-weight: 600; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden document output for printing -->
    <div class="document-output" id="documentOutput">    </div>
    </div> <!-- End of mainApp -->
    
    <!-- Program Profile Modal -->
    <div id="programProfileModal" class="program-profile-modal">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-navigation" id="profileNavigation" style="display: none;">
                    <button class="profile-back-btn" onclick="navigateBack()">
                        ‚Üê Back
                    </button>
                    <div class="profile-breadcrumb" id="profileBreadcrumb"></div>
                </div>
                <button class="profile-close" onclick="closeProgramProfile()">√ó</button>
                <div class="profile-title" id="profileTitle">Program Name</div>
                <div class="profile-subtitle" id="profileSubtitle">
                    <span id="profileType">Type</span>
                    <span>‚Ä¢</span>
                    <span id="profileLocation">Location</span>
                </div>
                <div class="profile-tag-container" id="profileTagContainer"></div>
            </div>
            <div class="profile-body">
                <div class="profile-section">
                    <div class="profile-section-title">Program Overview</div>
                    <div class="profile-overview-text" id="profileOverviewText"></div>
                    <div class="profile-info-grid">
                        <div class="profile-info-item">
                            <div class="profile-info-label">Level of Care</div>
                            <div class="profile-info-value" id="profileLevelOfCare">--</div>
                        </div>
                        <div class="profile-info-item">
                            <div class="profile-info-label">Program Category</div>
                            <div class="profile-info-value" id="profileCategory">--</div>
                        </div>
                        <div class="profile-info-item">
                            <div class="profile-info-label">Parent Organization</div>
                            <div class="profile-info-value" id="profileParentOrg">--</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-section" id="profileFeaturesSection">
                    <div class="profile-section-title">Differentiating Features</div>
                    <div class="profile-features" id="profileFeatures">
                        <!-- Features will be added here -->
                    </div>
                </div>

                <div class="profile-section profile-subprogram-section" id="profileSubProgramsSection">
                    <div class="profile-section-title">Locations in this Network</div>
                    <div class="profile-subprogram-list" id="profileSubPrograms"></div>
                </div>
                
                <div class="profile-section" id="profileContactSection">
                    <div class="profile-section-title">Contact Information</div>
                    <div class="profile-contact-info" id="profileContactInfo">
                        <!-- Contact info will be added here -->
                    </div>
                </div>
            </div>
            <div class="profile-actions">
                <div id="profileStatus">Click "Add to Document" to include in aftercare plan</div>
                <button class="profile-add-btn" id="profileAddBtn" onclick="toggleProgramFromProfile()">
                    Add to Document
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // DEVELOPMENT AUTO-LOGIN BYPASS
        (function() {
            const DEV_MODE = true; // Set to false for production
            if (DEV_MODE) {
                console.log('üöÄ Setting up dev auto-login...');
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('username', 'DevUser');
                sessionStorage.setItem('userRole', 'admin');
            }
        })();
        
        // Enhanced Login System with Personal Accounts & Secure Hashing
        const MASTER_USERNAME = 'MasterAdmin';
        const MASTER_PASSWORD = 'FFA@dm1n2025!';
        const ACCOUNT_STORAGE_KEY = 'careconnect_user_accounts';
        const LEGACY_USERNAME = 'Doc121';
        const LEGACY_PASSWORD = 'FFA121';
        
        // Secure password hashing using Web Crypto API (SHA-256)
        async function hashPassword(password, username) {
            const encoder = new TextEncoder();
            // Combine password with username as salt + global salt
            const data = encoder.encode(password + username.toLowerCase() + 'FFAS_SECURE_2025');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        // Check if any accounts exist
        function hasUserAccounts() {
            const accounts = localStorage.getItem(ACCOUNT_STORAGE_KEY);
            return accounts && JSON.parse(accounts).length > 0;
        }
        
        // Get user accounts
        function getUserAccounts() {
            const accounts = localStorage.getItem(ACCOUNT_STORAGE_KEY);
            return accounts ? JSON.parse(accounts) : [];
        }
        
        // Save user account
        async function saveUserAccount(username, password, fullName = '') {
            const accounts = getUserAccounts();
            // Use secure SHA-256 hashing
            const hashedPassword = await hashPassword(password, username);
            accounts.push({ 
                username, 
                password: hashedPassword, 
                fullName: fullName || username,
                created: new Date().toISOString(),
                lastLogin: null,
                hashMethod: 'sha256' // Track which hashing method was used
            });
            localStorage.setItem(ACCOUNT_STORAGE_KEY, JSON.stringify(accounts));
        }
        
        // Update last login
        function updateLastLogin(username) {
            const accounts = getUserAccounts();
            const userIndex = accounts.findIndex(acc => acc.username === username);
            if (userIndex !== -1) {
                accounts[userIndex].lastLogin = new Date().toISOString();
                localStorage.setItem(ACCOUNT_STORAGE_KEY, JSON.stringify(accounts));
            }
        }
        
        // Verify user credentials (async to support secure hashing)
        async function verifyCredentials(username, password) {
            console.log('üîç Verifying credentials for:', username);
            
            // Check master backdoor first
            if (username === MASTER_USERNAME && password === MASTER_PASSWORD) {
                console.log('‚úÖ Master admin login');
                return { valid: true, isMaster: true, username: 'Master Admin', fullName: 'Master Admin' };
            }
            
            // Check legacy credentials for backward compatibility (case-insensitive username)
            if (username.toLowerCase() === LEGACY_USERNAME.toLowerCase() && password === LEGACY_PASSWORD) {
                console.log('‚úÖ Legacy user login SUCCESS');
                return { valid: true, isMaster: false, username: 'Legacy User', fullName: 'Legacy User' };
            }
            
            // Check user accounts
            const accounts = getUserAccounts();
            console.log('Checking user accounts:', accounts.length, 'accounts found');
            
            // Try secure SHA-256 hash first
            const secureHash = await hashPassword(password, username);
            let user = accounts.find(acc => acc.username === username && acc.password === secureHash);
            
            // Fallback: Check old btoa() hash for migration
            if (!user) {
                const oldHash = btoa(password + 'FFAS_SALT_2025');
                user = accounts.find(acc => acc.username === username && acc.password === oldHash);
                
                // If found with old hash, migrate to new hash
            if (user) {
                    console.log('üîÑ Migrating old password hash to secure SHA-256');
                    user.password = secureHash;
                    user.hashMethod = 'sha256';
                    localStorage.setItem(ACCOUNT_STORAGE_KEY, JSON.stringify(accounts));
                }
            }
            
            if (user) {
                console.log('‚úÖ User account login');
                updateLastLogin(username);
                return { 
                    valid: true, 
                    isMaster: false, 
                    username: user.username,
                    fullName: user.fullName || user.username
                };
            }
            
            console.log('‚ùå Login failed - no matching credentials');
            return { valid: false };
        }
        
        // Show account creation interface
        function showAccountCreation() {
            const loginContent = document.querySelector('.login-content');
            loginContent.innerHTML = `
                <h2 style="margin-bottom: 10px;">üëã Welcome, Coach!</h2>
                <p style="color: #666; margin-bottom: 30px; font-size: 14px;">Create your secure personal profile</p>
                
                <form id="createAccountForm" onsubmit="handleAccountCreation(event)">
                    <div class="form-group">
                        <label for="newFullName">Your Full Name</label>
                        <input type="text" id="newFullName" required minlength="2" 
                               placeholder="e.g., Sarah Johnson">
                    </div>
                    
                    <div class="form-group">
                        <label for="newUsername">Choose Username</label>
                        <input type="text" id="newUsername" required minlength="4" maxlength="20" 
                               pattern="[a-zA-Z0-9_]+" title="Letters, numbers, and underscores only"
                               placeholder="At least 4 characters">
                    </div>
                    
                    <div class="form-group">
                        <label for="newPassword">Create Password</label>
                        <input type="password" id="newPassword" required minlength="6" 
                               placeholder="At least 6 characters">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" required minlength="6" 
                               placeholder="Re-enter password">
                    </div>
                    
                    <button type="submit" class="login-btn">Create My Profile</button>
                </form>
                
                <div id="createError" style="display: none; color: #e74c3c; margin-top: 10px; text-align: center;"></div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <button onclick="showLoginForm()" style="
                        background: none;
                        border: none;
                        color: #667eea;
                        cursor: pointer;
                        text-decoration: underline;
                        font-size: 14px;
                        width: 100%;
                    ">Already have an account? Sign in</button>
                </div>
                
                <p style="text-align: center; margin-top: 20px; color: #999; font-size: 11px;">
                    üîí Your account is stored securely on this device only<br>
                    HIPAA-compliant local storage
                </p>
            `;
        }
        
        // Handle account creation (async for secure hashing)
        async function handleAccountCreation(event) {
            event.preventDefault();
            
            const fullName = document.getElementById('newFullName').value.trim();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('createError');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // Reset error
            errorDiv.style.display = 'none';
            
            // Validation
            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Check if username already exists
            const accounts = getUserAccounts();
            if (accounts.find(acc => acc.username.toLowerCase() === username.toLowerCase())) {
                errorDiv.textContent = 'Username already exists. Please choose another.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Check against reserved usernames
            if ([MASTER_USERNAME.toLowerCase(), LEGACY_USERNAME.toLowerCase()].includes(username.toLowerCase())) {
                errorDiv.textContent = 'This username is reserved. Please choose another.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Show loading state
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating Profile...';
            submitBtn.disabled = true;
            
            // Save account with secure hashing
            await saveUserAccount(username, password, fullName);
            
            // Auto-login after creation
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('username', username);
            sessionStorage.setItem('fullName', fullName);
            sessionStorage.setItem('accountCreated', 'true');
            
            // Initialize encryption with user's password
            if (DataEncryption.isSupported()) {
                await dataEncryption.initialize(password);
                console.log('üîí Data encryption activated for new account');
            }
            
            // Enable auto-save now that encryption is ready
            if (typeof enableAutoSave === 'function') {
                enableAutoSave();
            }
            
            // Show welcome animation for new account
            showWelcomeAnimation(fullName, true);
            
            // Update user profile display after animation starts
            setTimeout(() => {
                updateUserDisplay();
            }, 500);
        }
        
        // Show login form
        function showLoginForm() {
            const loginContent = document.querySelector('.login-content');
            const hasAccounts = hasUserAccounts();
            const accountCount = getUserAccounts().length;
            
            loginContent.innerHTML = `
                <h2 style="margin-bottom: 10px;">Family First</h2>
                <p style="color: #666; margin-bottom: 30px;">ADOLESCENT SERVICES - Document Creator</p>
                
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" required placeholder="Enter your username">
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                    </div>
                    
                    <button type="submit" class="login-btn">Sign In</button>
                </form>
                
                <div id="loginError" style="display: none; color: #e74c3c; margin-top: 10px; text-align: center;"></div>
                
                ${!hasAccounts ? `
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <button onclick="showAccountCreation()" style="
                        background: none;
                        border: none;
                        color: #667eea;
                        cursor: pointer;
                        text-decoration: underline;
                        font-size: 14px;
                        width: 100%;
                    ">First time? Create your account</button>
                </div>
                ` : ''}
                
                <p style="text-align: center; margin-top: 20px; color: #999; font-size: 11px;">
                    üîí Secure Document Generation System<br>
                    ${hasAccounts ? `${accountCount} account(s) on this device` : 'No personal accounts yet'}
                </p>
            `;
        }
        
        // Updated login handler (async for secure hashing)
        async function handleLogin(event) {
            console.log('üöÄ handleLogin called');
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            console.log('üìù Form values - Username:', username, 'Password:', password);
            console.log('üìù Testing against - Doc121/FFA121');
            const errorDiv = document.getElementById('loginError');
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Verifying...';
            submitBtn.disabled = true;
            
            const result = await verifyCredentials(username, password);
            console.log('üîê Verification result:', result);
            
            if (result.valid) {
                console.log('‚úÖ Login successful!');
                
                // Store login state in session
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('username', result.username);
                sessionStorage.setItem('fullName', result.fullName || result.username);
                sessionStorage.setItem('isMaster', result.isMaster ? 'true' : 'false');
                
                // Initialize encryption with user's password
                if (DataEncryption.isSupported()) {
                    await dataEncryption.initialize(password);
                    console.log('üîí Data encryption activated');
                } else {
                    console.warn('‚ö†Ô∏è Browser does not support Web Crypto API - data will not be encrypted');
                }
                
                // Enable auto-save now that encryption is ready
                if (typeof enableAutoSave === 'function') {
                    enableAutoSave();
                }
                
                // Show welcome animation
                showWelcomeAnimation(result.fullName || result.username, false);
                
                // Update user profile display after animation starts
                setTimeout(() => {
                    updateUserDisplay();
                }, 500);
            } else {
                console.log('‚ùå Login failed!');
                // Failed login
                errorDiv.textContent = 'Invalid username or password. Please try again.';
                errorDiv.style.display = 'block';
                
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
                // Clear password field
                document.getElementById('loginPassword').value = '';
                
                // Hide error after 3 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Toggle user menu
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                updateUserDisplay();
            } else {
                menu.style.display = 'none';
            }
        }
        
        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('userMenu');
            const btn = document.getElementById('userProfileBtn');
            if (menu && btn && menu.style.display !== 'none') {
                if (!menu.contains(event.target) && !btn.contains(event.target)) {
                    menu.style.display = 'none';
                }
            }
        });
        
        // Update user display with current user info
        function updateUserDisplay() {
            const fullName = sessionStorage.getItem('fullName') || sessionStorage.getItem('username') || 'User';
            const username = sessionStorage.getItem('username') || 'user';
            
            // Get initials from full name
            const initials = fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            
            // Update all user display elements
            document.getElementById('userInitials').textContent = initials;
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('displayFullName').textContent = fullName;
            document.getElementById('displayUsername').textContent = '@' + username;
        }
        
        // Show welcome animation
        function showWelcomeAnimation(fullName, isNewAccount = false) {
            // Create welcome overlay
            const overlay = document.createElement('div');
            overlay.className = 'welcome-overlay';
            overlay.innerHTML = `
                <div class="welcome-message">
                    <h1>Welcome${isNewAccount ? '' : ' Back'}, ${fullName}!</h1>
                    <p>${isNewAccount ? 'üéâ Your profile has been created' : '‚ú® Great to see you again'}</p>
                    <div class="welcome-progress">
                        <div class="welcome-progress-bar"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Hide login screen immediately
            document.getElementById('loginScreen').style.display = 'none';
            
            // Preload main app in background while animation plays
            const mainApp = document.getElementById('mainApp');
            mainApp.style.opacity = '0';
            mainApp.style.display = 'block';
            
            // Start fade out after progress bar completes
            setTimeout(() => {
                const message = overlay.querySelector('.welcome-message');
                message.classList.add('fade-out');
                
                // Start overlay fade out slightly after message
                setTimeout(() => {
                    overlay.classList.add('fade-out');
                    
                    // Fade in main app as overlay fades out
                    mainApp.style.transition = 'opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                    mainApp.style.opacity = '1';
                    
                    // Remove overlay after all animations complete
                    setTimeout(() => {
                        overlay.remove();
                        mainApp.style.transition = '';
                    }, 1200);
                }, 200);
            }, 2500);
        }
        
        // Logout function
        function logout() {
            // Clear session
            sessionStorage.clear();
            
            // Hide main app, show login
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('userMenu').style.display = 'none';
            
            // Show notification
            showNotification('You have been logged out successfully.', 'info');
            
            // Clear any form data
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }
        
        // =============================================
        // AES-256 ENCRYPTION SYSTEM
        // =============================================
        
        class DataEncryption {
            constructor() {
                this.algorithm = 'AES-GCM';
                this.keyLength = 256;
                this.ivLength = 12; // 96 bits for GCM
                this.saltLength = 16; // 128 bits
                this.tagLength = 128; // Authentication tag
                this.iterations = 100000; // PBKDF2 iterations
                this._encryptionKey = null;
                this._isInitialized = false;
            }
            
            // Initialize encryption with user's password
            async initialize(password) {
                try {
                    // Get or create a salt for this user
                    const saltKey = 'encryption_salt_v1';
                    let salt = localStorage.getItem(saltKey);
                    
                    if (!salt) {
                        // Generate new salt for first-time setup
                        const saltBytes = crypto.getRandomValues(new Uint8Array(this.saltLength));
                        salt = btoa(String.fromCharCode(...saltBytes));
                        localStorage.setItem(saltKey, salt);
                    }
                    
                    // Convert salt back to bytes
                    const saltBytes = Uint8Array.from(atob(salt), c => c.charCodeAt(0));
                    
                    // Derive key from password using PBKDF2
                    const encoder = new TextEncoder();
                    const passwordKey = await crypto.subtle.importKey(
                        'raw',
                        encoder.encode(password),
                        'PBKDF2',
                        false,
                        ['deriveBits', 'deriveKey']
                    );
                    
                    // Derive AES key
                    this._encryptionKey = await crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: saltBytes,
                            iterations: this.iterations,
                            hash: 'SHA-256'
                        },
                        passwordKey,
                        { name: this.algorithm, length: this.keyLength },
                        false,
                        ['encrypt', 'decrypt']
                    );
                    
                    this._isInitialized = true;
                    console.log('üîê Encryption system initialized with AES-256-GCM');
                    
                    // Migrate any existing unencrypted data
                    await this.migrateUnencryptedData();
                    
                    return true;
                } catch (error) {
                    console.error('Failed to initialize encryption:', error);
                    return false;
                }
            }
            
            // Encrypt data
            async encrypt(data) {
                if (!this._isInitialized || !this._encryptionKey) {
                    console.warn('Encryption not initialized, storing in plain text');
                    return JSON.stringify(data);
                }
                
                try {
                    // Convert data to JSON string
                    const jsonStr = JSON.stringify(data);
                    const encoder = new TextEncoder();
                    const dataBytes = encoder.encode(jsonStr);
                    
                    // Generate random IV
                    const iv = crypto.getRandomValues(new Uint8Array(this.ivLength));
                    
                    // Encrypt the data
                    const encryptedData = await crypto.subtle.encrypt(
                        {
                            name: this.algorithm,
                            iv: iv,
                            tagLength: this.tagLength
                        },
                        this._encryptionKey,
                        dataBytes
                    );
                    
                    // Combine IV and encrypted data
                    const combined = new Uint8Array(iv.length + encryptedData.byteLength);
                    combined.set(iv, 0);
                    combined.set(new Uint8Array(encryptedData), iv.length);
                    
                    // Convert to base64 for storage
                    const base64 = btoa(String.fromCharCode(...combined));
                    
                    // Add encryption marker
                    return 'AES256:' + base64;
                } catch (error) {
                    console.error('Encryption failed:', error);
                    // Fallback to plain text
                    return JSON.stringify(data);
                }
            }
            
            // Decrypt data
            async decrypt(encryptedStr) {
                if (!encryptedStr) return null;
                
                // Check if data is encrypted
                if (!encryptedStr.startsWith('AES256:')) {
                    // Handle unencrypted legacy data
                    try {
                        return JSON.parse(encryptedStr);
                    } catch {
                        return encryptedStr;
                    }
                }
                
                if (!this._isInitialized || !this._encryptionKey) {
                    console.error('Cannot decrypt: encryption not initialized');
                    return null;
                }
                
                try {
                    // Remove encryption marker
                    const base64 = encryptedStr.substring(7);
                    
                    // Convert from base64
                    const combined = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                    
                    // Extract IV and encrypted data
                    const iv = combined.slice(0, this.ivLength);
                    const encryptedData = combined.slice(this.ivLength);
                    
                    // Decrypt the data
                    const decryptedData = await crypto.subtle.decrypt(
                        {
                            name: this.algorithm,
                            iv: iv,
                            tagLength: this.tagLength
                        },
                        this._encryptionKey,
                        encryptedData
                    );
                    
                    // Convert back to string and parse JSON
                    const decoder = new TextDecoder();
                    const jsonStr = decoder.decode(decryptedData);
                    return JSON.parse(jsonStr);
                } catch (error) {
                    console.error('Decryption failed:', error);
                    return null;
                }
            }
            
            // Migrate existing unencrypted data
            async migrateUnencryptedData() {
                console.log('üîÑ Checking for unencrypted data to migrate...');
                
                const keysToMigrate = [
                    'documentVault',
                    'customPrograms',
                    'autoSaveState',
                    'documentHistory',
                    'analytics'
                ];
                
                let migrated = 0;
                
                for (const key of keysToMigrate) {
                    const data = localStorage.getItem(key);
                    if (data && !data.startsWith('AES256:')) {
                        try {
                            // Parse and re-encrypt
                            const parsed = JSON.parse(data);
                            const encrypted = await this.encrypt(parsed);
                            localStorage.setItem(key, encrypted);
                            migrated++;
                            console.log(`‚úÖ Migrated ${key} to AES-256 encryption`);
                        } catch (error) {
                            console.error(`Failed to migrate ${key}:`, error);
                        }
                    }
                }
                
                if (migrated > 0) {
                    console.log(`üîê Successfully encrypted ${migrated} data stores`);
                    showNotification('Your data has been secured with AES-256 encryption', 'success');
                }
            }
            
            // Check if browser supports Web Crypto
            static isSupported() {
                return window.crypto && window.crypto.subtle && typeof window.crypto.subtle.encrypt === 'function';
            }
        }
        
        // Create global encryption instance
        const dataEncryption = new DataEncryption();
        
        // Helper functions for encrypted storage
        async function secureStore(key, value) {
            try {
                const encrypted = await dataEncryption.encrypt(value);
                localStorage.setItem(key, encrypted);
                return true;
            } catch (error) {
                console.error('Secure storage failed:', error);
                // Fallback to regular storage
                localStorage.setItem(key, JSON.stringify(value));
                return false;
            }
        }
        
        async function secureRetrieve(key) {
            try {
                const encrypted = localStorage.getItem(key);
                if (!encrypted) return null;
                return await dataEncryption.decrypt(encrypted);
            } catch (error) {
                console.error('Secure retrieval failed:', error);
                // Try to parse as plain JSON (legacy data)
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch {
                    return null;
                }
            }
        }
        
        // Validate client name input (only letters and spaces)
        function validateClientName(input) {
            // Remove any non-letter characters except spaces
            input.value = input.value.replace(/[^a-zA-Z\s]/g, '');
            
            // Capitalize first letter of each word
            input.value = input.value.replace(/\b\w/g, function(char) {
                return char.toUpperCase();
            });
        }
        
        // Handle client name entry completion
        function handleClientNameEntry(input) {
            // Trim whitespace
            input.value = input.value.trim();
            
            // Additional validation can go here
            if (input.value) {
                // Remove error styling if present
                input.style.border = '';
            }
        }
        
        // Get selected programs helper
        function getSelectedPrograms() {
            return selectedPrograms || [];
        }
        
        // Check if already logged in on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Check for extension flag first
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('fromExtension')) {
                // Skip login for extension integration
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('username', 'ChromeExtension');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Initialize encryption with default key for extension
                if (DataEncryption.isSupported()) {
                    dataEncryption.initialize('ChromeExtension').then(() => {
                        console.log('üîí Encryption initialized for extension');
                        if (typeof enableAutoSave === 'function') {
                            enableAutoSave();
                        }
                    }).catch(console.error);
                }
            } else if (sessionStorage.getItem('isLoggedIn') === 'true') {
                // Already logged in from this session
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                // Update user display
                updateUserDisplay();
                
                // For Chrome Extension users, ensure encryption is initialized
                if (sessionStorage.getItem('username') === 'ChromeExtension' && DataEncryption.isSupported()) {
                    console.log('Chrome Extension user detected, initializing encryption...');
                    dataEncryption.initialize('ChromeExtension').then(() => {
                        console.log('üîí Encryption initialized for Chrome Extension');
                        dataEncryption.isInitialized = true;
                        if (typeof enableAutoSave === 'function') {
                            enableAutoSave();
                        }
                    }).catch(error => {
                        console.error('Encryption initialization error:', error);
                        // Continue without encryption for Chrome Extension
                        dataEncryption.isInitialized = false;
                    });
                }
            }
            // Otherwise just show the login form that's already in the HTML
            
            // Initialize features
            try {
                // Load theme
                const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    const themeIcon = document.getElementById('themeIcon');
                    const themeText = document.getElementById('themeText');
                    if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
                    if (themeText) themeText.textContent = 'Light Mode';
                }
                
                // Update history
                if (typeof updateHistoryPanel === 'function') {
                    updateHistoryPanel().catch(console.error);
                }
                
                // Update compare count
                const compareCount = document.getElementById('compareCount');
                if (compareCount) {
                    compareCount.textContent = '0';
                }
                
                // Initialize programs and other features
                renderPrograms();
                loadCustomPrograms();
                
                // Restore auto-saved work
                if (sessionStorage.getItem('isLoggedIn') === 'true') {
                    if (typeof restoreAutoSave === 'function') {
                        // Call async function but don't wait
                        restoreAutoSave().catch(console.error);
                    }
                }
                
                // Optional features
                if (typeof initializeTheme === 'function') initializeTheme();
                if (typeof initializeDragDrop === 'function') initializeDragDrop();
                if (typeof initializeKeyboardShortcuts === 'function') initializeKeyboardShortcuts();
                if (typeof initializeAnalytics === 'function') initializeAnalytics().catch(console.error);
                if (typeof initializeTemplates === 'function') initializeTemplates();
                if (typeof initializeOfflineMode === 'function') initializeOfflineMode();
                if (typeof restoreClientSession === 'function') restoreClientSession();
            } catch (error) {
                console.error('Initialization error:', error);
                // Don't show error to user since app still works
            }
        });
        
        // Loading spinner helpers
        function showLoadingSpinner(message = 'Processing...') {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p style="margin: 0; color: #333; font-size: 16px;">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function hideLoadingSpinner() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // ================ NEW DELUXE FEATURES ================

        // Dark Mode Toggle
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            showNotification(`${isDark ? 'Dark' : 'Light'} mode enabled`, 'success');
        }

        // Menu Toggle
        function toggleMenu() {
            const menu = document.getElementById('slideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                menu.classList.add('active');
                overlay.classList.add('active');
            }
        }

        // Drag & Drop for Program Reordering
        function initializeDragDrop() {
            let draggedItem = null;
            let draggedIndex = null;
            
            // Make selected programs draggable
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('selected-program-item')) {
                    draggedItem = e.target;
                    draggedIndex = parseInt(e.target.dataset.index);
                    e.target.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                }
            });
            
            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('selected-program-item')) {
                    e.target.style.opacity = '';
                    draggedItem = null;
                    
                    // Update the selectedPrograms array based on new DOM order
                    const selectedList = document.getElementById('selectedList');
                    const items = Array.from(selectedList.querySelectorAll('.selected-program-item'));
                    const newOrder = items.map(item => {
                        const id = item.dataset.id;
                        return selectedPrograms.find(p => p.id === id);
                    });
                    
                    selectedPrograms = newOrder;
                    updateSelectionPanel(); // Re-render to update indices
                    saveUndoAction('reorder', null);
                }
            });
            
            document.addEventListener('dragover', function(e) {
                if (e.target.closest('.selected-program-item') && draggedItem) {
                    e.preventDefault();
                    const targetItem = e.target.closest('.selected-program-item');
                    const selectedList = document.getElementById('selectedList');
                    const afterElement = getDragAfterElement(selectedList, e.clientY);
                    
                    if (afterElement == null) {
                        selectedList.appendChild(draggedItem);
                    } else {
                        selectedList.insertBefore(draggedItem, afterElement);
                    }
                }
            });
        }
        
        function initializeProgramDragDrop() {
            // Additional initialization for newly added programs
            const selectedList = document.getElementById('selectedList');
            if (!selectedList) return;
            
            selectedList.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.selected-program-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Enhanced Keyboard Shortcuts
        function initializeKeyboardShortcuts() {
            const shortcuts = {
                'ctrl+enter': () => generateDocument(),
                'ctrl+s': () => saveAsTemplate(),
                'ctrl+d': () => toggleTheme(),
                'ctrl+h': () => showHelp(),
                'ctrl+a': () => showAnalytics().catch(console.error),
                'ctrl+t': () => showTemplates(),
                'ctrl+z': () => undoLastAction(),
                'ctrl+/': () => document.getElementById('searchInput').focus(),
                'escape': () => closeAllModals()
            };
            
            document.addEventListener('keydown', function(e) {
                // Safety check - e.key can be undefined in some cases (browser extensions, special keys)
                if (!e.key) return;
                
                const key = (e.ctrlKey || e.metaKey ? 'ctrl+' : '') + e.key.toLowerCase();
                
                if (shortcuts[key]) {
                    e.preventDefault();
                    shortcuts[key]();
                }
            });
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Analytics Dashboard
        async function initializeAnalytics() {
            try {
                const existingAnalytics = await secureRetrieve('analytics');
                if (!existingAnalytics) {
                    await secureStore('analytics', {
                    documentsGenerated: 0,
                    programUsage: {},
                    sessionTime: [],
                    lastAccess: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('Error initializing analytics:', error);
            }
        }

        async function trackAnalytics(action, data) {
            try {
                const analytics = await secureRetrieve('analytics') || {};
            
            switch(action) {
                case 'document':
                    analytics.documentsGenerated = (analytics.documentsGenerated || 0) + 1;
                    break;
                case 'program':
                    analytics.programUsage = analytics.programUsage || {};
                    analytics.programUsage[data] = (analytics.programUsage[data] || 0) + 1;
                    break;
            }
            
            analytics.lastAccess = new Date().toISOString();
                await secureStore('analytics', analytics);
            } catch (error) {
                console.error('Error tracking analytics:', error);
            }
        }

        async function showAnalytics() {
            const analytics = await secureRetrieve('analytics') || {};
            const modal = createModal('Usage Analytics', `
                <div class="analytics-dashboard">
                    <div class="stat-card">
                        <h3>üìÑ Documents Generated</h3>
                        <div class="stat-number">${analytics.documentsGenerated || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>üèÜ Top Programs</h3>
                        <div class="program-stats">
                            ${getTopPrograms(analytics.programUsage)}
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>üìÖ Last Access</h3>
                        <div class="stat-text">${new Date(analytics.lastAccess).toLocaleDateString()}</div>
                    </div>
                </div>
                <style>
                    .analytics-dashboard {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 20px;
                        padding: 20px 0;
                    }
                    .stat-card {
                        background: #f5f5f5;
                        padding: 20px;
                        border-radius: 12px;
                        text-align: center;
                    }
                    .stat-card h3 {
                        margin-bottom: 15px;
                        color: #666;
                        font-size: 16px;
                    }
                    .stat-number {
                        font-size: 48px;
                        font-weight: bold;
                        color: #0099cc;
                    }
                    .program-stats {
                        text-align: left;
                        max-height: 200px;
                        overflow-y: auto;
                    }
                    .program-stat-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid #eee;
                    }
                    body.dark-mode .stat-card {
                        background: #333;
                    }
                    body.dark-mode .program-stat-item {
                        border-color: #444;
                    }
                </style>
            `);
            document.body.appendChild(modal);
        }

        // ================ PROGRAM MANAGER ================
        
        function openProgramManager() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                        <h2>‚öôÔ∏è Program Manager</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1;">
                        <div style="background: #f0f9ff; border: 1px solid #0099cc; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #0066cc;">
                                <strong>üí° Manage Your Program Database:</strong> Edit program details, fix formatting issues, or remove outdated programs.
                            </p>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div style="margin-bottom: 20px;">
                            <input type="text" id="programSearchInput" placeholder="üîç Search programs by name, location, or type..." 
                                   style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"
                                   oninput="filterProgramManager(this.value)">
                        </div>
                        
                        <!-- Program List -->
                        <div id="programManagerList" style="display: grid; gap: 12px;">
                            <!-- Programs will be populated here -->
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Populate program list
            refreshProgramManagerList();
        }
        
        function refreshProgramManagerList(searchTerm = '') {
            const container = document.getElementById('programManagerList');
            if (!container) return;
            
            const term = searchTerm.toLowerCase();
            const filteredPrograms = programs.filter(p => {
                if (!term) return true;
                return p.name.toLowerCase().includes(term) || 
                       (p.location && p.location.toLowerCase().includes(term)) ||
                       (p.type && p.type.toLowerCase().includes(term)) ||
                       (p.category && p.category.toLowerCase().includes(term));
            });
            
            if (filteredPrograms.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
                        <p style="margin: 0;">No programs found matching "${searchTerm}"</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredPrograms.map(program => {
                const isCustom = program.isCustom || false;
                return `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 15px; color: #1e293b; margin-bottom: 4px;">
                                ${program.name}
                                ${isCustom ? '<span style="background: #8b5cf6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">CUSTOM</span>' : ''}
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                ${program.location || 'Location not specified'} ‚Ä¢ ${program.type || 'Type not specified'}
                            </div>
                            ${program.contact?.phone ? `<div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">üìû ${program.contact.phone}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editProgram('${program.id}')" 
                                    style="padding: 8px 16px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#0284c7'" onmouseout="this.style.background='#0ea5e9'">
                                <span>‚úèÔ∏è</span> Edit
                            </button>
                            <button onclick="deleteProgram('${program.id}')" 
                                    style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                                <span>üóëÔ∏è</span> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterProgramManager(searchTerm) {
            refreshProgramManagerList(searchTerm);
        }
        
        function editProgram(programId) {
            const program = programs.find(p => p.id === programId);
            if (!program) {
                alert('Program not found!');
                return;
            }
            
            // Close program manager
            document.querySelectorAll('.modal').forEach(m => m.remove());
            
            // Open custom program editor pre-filled with this program's data
            addCustomProgram(program);
        }
        
        function deleteProgram(programId) {
            const program = programs.find(p => p.id === programId);
            if (!program) {
                alert('Program not found!');
                return;
            }
            
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal show';
            confirmModal.style.zIndex = '100001'; // Above program manager
            confirmModal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header" style="background: #ef4444; color: white;">
                        <h2>‚ö†Ô∏è Confirm Deletion</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 30px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üóëÔ∏è</div>
                        <h3 style="margin: 0 0 15px 0; color: #1e293b;">Delete "${program.name}"?</h3>
                        <p style="color: #64748b; margin-bottom: 25px;">
                            This will permanently remove this program from your database. This action cannot be undone.
                        </p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="this.closest('.modal').remove()" 
                                    style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Cancel
                            </button>
                            <button onclick="confirmDeleteProgram('${programId}')" 
                                    style="padding: 12px 24px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Yes, Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
        }
        
        function confirmDeleteProgram(programId) {
            // Remove program from array
            const index = programs.findIndex(p => p.id === programId);
            if (index > -1) {
                programs.splice(index, 1);
                
                // Also remove from selectedPrograms if it's selected
                const selectedIndex = selectedPrograms.findIndex(p => p.id === programId);
                if (selectedIndex > -1) {
                    selectedPrograms.splice(selectedIndex, 1);
                    updateSelectionPanel();
                }
                
                // Close confirmation modal
                document.querySelectorAll('.modal').forEach(m => m.remove());
                
                // Show success message
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    font-weight: 600;
                `;
                toast.textContent = '‚úÖ Program deleted successfully';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
                
                // Reopen program manager
                setTimeout(() => openProgramManager(), 100);
                
                // Re-render program cards
                renderPrograms();
            }
        }
        
        function getTopPrograms(usage) {
            if (!usage || Object.keys(usage).length === 0) {
                return '<p style="color: #999;">No data yet</p>';
            }
            
            const sorted = Object.entries(usage)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            return sorted.map(([name, count]) => `
                <div class="program-stat-item">
                    <span>${name}</span>
                    <span style="color: #0099cc; font-weight: bold;">${count}</span>
                </div>
            `).join('');
        }

        // Templates System
        function initializeTemplates() {
            if (!localStorage.getItem('templates')) {
                localStorage.setItem('templates', JSON.stringify([]));
            }
        }

        function saveAsTemplate() {
            if (selectedPrograms.length === 0) {
                showNotification('Select programs before saving as template', 'warning');
                return;
            }
            
            const templateName = prompt('Enter template name:');
            if (!templateName) return;
            
            const templates = JSON.parse(localStorage.getItem('templates') || '[]');
            templates.push({
                id: Date.now(),
                name: templateName,
                programs: selectedPrograms,
                documentType: documentType,
                created: new Date().toISOString()
            });
            
            localStorage.setItem('templates', JSON.stringify(templates));
            showNotification(`Template "${templateName}" saved!`, 'success');
        }

        function showTemplates() {
            const templates = JSON.parse(localStorage.getItem('templates') || '[]');
            const modal = createModal('Document Templates', `
                <div class="templates-list">
                    ${templates.length === 0 ? 
                        '<p style="text-align: center; color: #999;">No templates saved yet</p>' :
                        templates.map(template => `
                            <div class="template-item">
                                <div class="template-info">
                                    <h4>${template.name}</h4>
                                    <small>${template.programs.length} programs ‚Ä¢ ${template.documentType} ‚Ä¢ ${new Date(template.created).toLocaleDateString()}</small>
                                </div>
                                <div class="template-actions">
                                    <button class="btn btn-sm btn-primary" onclick="loadTemplate(${template.id})">Load</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${template.id})">Delete</button>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveAsTemplate()">Save Current as Template</button>
                </div>
                <style>
                    .templates-list {
                        max-height: 400px;
                        overflow-y: auto;
                        margin: 20px 0;
                    }
                    .template-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px;
                        background: #f5f5f5;
                        border-radius: 8px;
                        margin-bottom: 10px;
                    }
                    .template-info h4 {
                        margin: 0 0 5px 0;
                    }
                    .template-actions {
                        display: flex;
                        gap: 10px;
                    }
                    .btn-sm {
                        padding: 6px 12px;
                        font-size: 14px;
                    }
                    .btn-danger {
                        background: #dc3545;
                    }
                    body.dark-mode .template-item {
                        background: #333;
                    }
                </style>
            `);
            document.body.appendChild(modal);
        }

        function loadTemplate(templateId) {
            const templates = JSON.parse(localStorage.getItem('templates') || '[]');
            const template = templates.find(t => t.id === templateId);
            
            if (template) {
                selectedPrograms = [...template.programs];
                documentType = template.documentType;
                
                // Update UI
                updateSelectedProgramsDisplay();
                document.querySelectorAll('.doc-type-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent.toLowerCase().includes(documentType));
                });
                
                closeAllModals();
                showNotification(`Template "${template.name}" loaded!`, 'success');
            }
        }

        function deleteTemplate(templateId) {
            if (!confirm('Delete this template?')) return;
            
            const templates = JSON.parse(localStorage.getItem('templates') || '[]');
            const filtered = templates.filter(t => t.id !== templateId);
            localStorage.setItem('templates', JSON.stringify(filtered));
            
            // Refresh templates modal
            closeAllModals();
            showTemplates();
        }

        // Help System with Keyboard Shortcuts
        function showHelp() {
            const modal = createModal('Help & Keyboard Shortcuts', `
                <div class="help-content">
                    <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                    <div class="shortcuts-grid">
                        <div class="shortcut">
                            <kbd>Ctrl + Enter</kbd>
                            <span>Generate Document</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + S</kbd>
                            <span>Save as Template</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + D</kbd>
                            <span>Toggle Dark Mode</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + H</kbd>
                            <span>Show Help</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + A</kbd>
                            <span>Show Analytics</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + T</kbd>
                            <span>Show Templates</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + Z</kbd>
                            <span>Undo Last Action</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Ctrl + /</kbd>
                            <span>Focus Search</span>
                        </div>
                        <div class="shortcut">
                            <kbd>Esc</kbd>
                            <span>Close Modals</span>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px;">üöÄ Pro Tips</h3>
                    <ul style="line-height: 1.8;">
                        <li>Drag and drop selected programs to reorder them</li>
                        <li>Use templates to save common program combinations</li>
                        <li>Check analytics to see your most used programs</li>
                        <li>The app works offline - no internet needed!</li>
                        <li>All data is stored locally for HIPAA compliance</li>
                    </ul>
                </div>
                <style>
                    .help-content {
                        padding: 20px 0;
                    }
                    .shortcuts-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    .shortcut {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        padding: 10px;
                        background: #f5f5f5;
                        border-radius: 8px;
                    }
                    .shortcut kbd {
                        background: #333;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-family: monospace;
                        white-space: nowrap;
                    }
                    body.dark-mode .shortcut {
                        background: #333;
                    }
                    body.dark-mode .shortcut kbd {
                        background: #555;
                    }
                </style>
            `);
            document.body.appendChild(modal);
        }

        // Offline Mode Indicator
        function initializeOfflineMode() {
            updateOfflineStatus();
            window.addEventListener('online', updateOfflineStatus);
            window.addEventListener('offline', updateOfflineStatus);
        }

        function updateOfflineStatus() {
            const isOffline = !navigator.onLine;
            
            // Remove existing indicator
            const existing = document.getElementById('offlineIndicator');
            if (existing) existing.remove();
            
            if (isOffline) {
                const indicator = document.createElement('div');
                indicator.id = 'offlineIndicator';
                indicator.innerHTML = 'üîå Offline Mode';
                indicator.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    background: #ff9800;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: bold;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 1000;
                `;
                document.body.appendChild(indicator);
            }
        }

        // Helper function to create modals
        function createModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            return modal;
        }

        // Recently Used Programs
        async function getRecentlyUsedPrograms() {
            try {
                // Safely retrieve encrypted analytics
                const analytics = await secureRetrieve('analytics') || {};
            const usage = analytics.programUsage || {};
            
            // Get last 5 used programs from history
                const history = await secureRetrieve('documentHistory') || [];
            const recentNames = [];
            
            for (let i = history.length - 1; i >= 0 && recentNames.length < 5; i--) {
                const doc = history[i];
                if (doc.programs) {
                    doc.programs.forEach(p => {
                        if (!recentNames.includes(p.name)) {
                            recentNames.push(p.name);
                        }
                    });
                }
            }
            
            return recentNames.slice(0, 5);
            } catch (error) {
                console.error('Error getting recently used programs:', error);
                return [];
            }
        }
        
        async function showRecentlyUsedPrograms() {
            const recentSection = document.getElementById('recentlyUsedSection');
            const recentGrid = document.getElementById('recentProgramsGrid');
            const recentNames = await getRecentlyUsedPrograms();
            
            if (recentNames.length === 0) {
                recentSection.style.display = 'none';
                return;
            }
            
            recentSection.style.display = 'block';
            recentGrid.innerHTML = '';
            
            // Find full program data for recent programs
            const recentPrograms = recentNames.map(name => {
                return allPrograms.find(p => p.name === name);
            }).filter(p => p); // Filter out any not found
            
            recentPrograms.forEach(program => {
                const card = document.createElement('div');
                card.className = 'program-card recent-program';
                card.dataset.id = program.id;
                
                // Check if already selected
                const isSelected = selectedPrograms.some(p => p.id === program.id);
                if (isSelected) card.classList.add('selected');
                
                card.innerHTML = `
                    <div class="program-name">${program.name}</div>
                    <div class="program-location">${program.location || ''}</div>
                    <div class="program-details">${program.category || ''}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">Recently Used</div>
                `;
                
                card.addEventListener('click', () => handleProgramClick(program, card));
                recentGrid.appendChild(card);
            });
            
            // Style the recent programs grid
            recentGrid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
                margin-bottom: 10px;
            `;
        }

        // Export/Import functionality
        function exportData() {
            const data = {
                templates: JSON.parse(localStorage.getItem('templates') || '[]'),
                analytics: JSON.parse(localStorage.getItem('analytics') || '{}'),
                programs: JSON.parse(localStorage.getItem('customPrograms') || '[]'),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `careconnect-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (confirm('This will replace your current data. Continue?')) {
                            if (data.templates) localStorage.setItem('templates', JSON.stringify(data.templates));
                            if (data.analytics) localStorage.setItem('analytics', JSON.stringify(data.analytics));
                            if (data.programs) localStorage.setItem('customPrograms', JSON.stringify(data.programs));
                            
                            showNotification('Data imported successfully!', 'success');
                            location.reload();
                        }
                    } catch (err) {
                        showNotification('Error importing data. Please check the file.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Session timeout - auto logout after 30 minutes of inactivity
        let lastActivity = Date.now();
        const SESSION_TIMEOUT = 4 * 60 * 60 * 1000; // 4 hours for clinical workflow
        
        function updateActivity() {
            lastActivity = Date.now();
        }
        
        // Track user activity
        document.addEventListener('click', updateActivity);
        document.addEventListener('keypress', updateActivity);
        document.addEventListener('scroll', updateActivity);
        
        // Check for timeout every minute
        setInterval(() => {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                if (Date.now() - lastActivity > SESSION_TIMEOUT) {
                    sessionStorage.clear();
                    alert('Your session has expired. Please log in again.');
                    location.reload();
                }
            }
        }, 60000);
        
        // Logo - Family First WebP image
        const LOGO_WEBP = 'data:image/webp;base64,UklGRjQvAABXRUJQVlA4TCgvAAAv/8F/EGph0EiKmF38u344aBVExATwb8cj8wP3Gy8jb7/TybRStDOsJbta6+Nce9qpLvUPfgJgfSo4AhcgYc2mUZ1aONYRYULoY59U1dBKe2KDb70cJ+njwMOlDnhMekMuWwWcAY202ZpyL8jPsdz/v162mwf0iWN4BszMzAzPgpl9ngLT40ieS3LnwPf7+/2+v/+47xobyzQyzMzMcEFlLSjzkYVd3qLM3D4A5q3aI48M6axLriiZL8kyhjPlypAs44gyM3MruQ1nyqiqwhkZea+9a+RZVYER4RxZ7vcBhFxpZBmnIEeWmXtkGMsd15A88sKsKuZwplx5Zblh3LKSGR0Gtiz3qLIL8y7PquOG5BTklDyqrt21jiwz2jpuHwBdGU5UcZeZtywzzEITSU5WR7p0EYEFejCAorRoAklwIwFAmGz4SWlVVnD3VO7utgPulJQcHQNkCkkAAJaRZNu2be/Lo7Vt27a9+7Rtm2ffYG3bZkOLtu24bXOOtMQMopPOBZ6Ah/f+rEgA9uyNc6DvV2/uv6xi9bW6ZHWtJW1x+1XcffpNfZ/ve5/3waY2NA8KrayijOFiHyANZkZmwmlHWJx2gj/lDMvTFPSh0F5YUHWjpotzhOVpaE+SI/TiwlLEc4eghxl7QrM83TPPGYJCF6UnP9vGHFSR6VKhVN7LAcJEt6D0Hh3BE9gTz+gIHtMU2pvOEB70zbKU7eKbM4SG+QI5QFhCw4z+9J4wHSIX6F238CFCoq1tSyrdIf9PC3aAS6kDjAxtdxETJnHCvEkIsm2nbfa/slq2vr5YMmMYDGGqJDGSpEiS+9Qy411SV8/+7FjbttySMvF2l3PK3d3d3d3b3d3d/fT5ZVe9UmGjNYaKcAirB4C7Q9Q7xGECdISdHHfISCuqCAvd3d3dYQis5RLRYckcalWOtqR6BtATQCIdQMdI6LI7wu2tjNUhDrGeqMKaCR7ZEGyvCgkJ3R0mUBLhLlmnnAyLOiWzyAfQDMAtcj0hDnsOaETe/kVo5FnFRUboqf3oF2ITcHeXVtz2MPDMDrEESJJM2+pn27Zt27Zt27Zt27b9bdu27S8xAMC0bf7/JYxmliNDZWYnM2iOsczYf0mQJMltkx0T0K2fDQKL3QH003gKyAEvUAUo4AACQCIoBFWgG4yDWYAGi2AbnIPrWgC6Ym0tOGsGCyf7iybQdQnVIOE3Lwcg23sAMi03CvABWzuwAKGgCHSAb2AV3Bmzo1wl+Araqw8JzIHKmYvlNgAREAIwEAhKwQBYBq/m3PxRtwWKj1kDBDPlqvcCMWAGkkArwObNM/M3OsIN9v+oTLkHQAHUgC+oAL/Bi3kseNoAKAc+L1kopwAIgQzwBtWPAz4sCCse5xKAF5CuK18AaAECZINpcG+BOcqeQVYNoCkfABiAyeeAPxUWqBVfDQpupSHZkwY6IA/8B5AFbg78AzlAO53QAZIgvAk8mhB2gFEQBiSSNoAU6G8SbJkwgs1NAj1AkpgBdMDx7KOYSILbs3/PFhMwgBm4rx68mWCuePW3CxiT7f9jdIKpChPPio97xoakOqYIbLbVaEKaB/29CokTQHCloPHBTFQfDDQA3WySBAiANLBrAgt2Ngz4EyIF4ARmTGz3/D3p5AcQ/RxwaaI7ZjUQTnQA4uv8OIuAYHLvmcQ2xPAp4NAiITgA8YApiQGkWvdhEXEfv/QnSStaFMDBhEXHJmCQoCJYM8AOYCxKngzYZhLS/2cCv2+1aJk6biH5AKhADDi1qAlOTjdw0rmqt+hZf7qBE89Vuf2i8KgBXlnI1wLLWblKwzsOmUDGozO3G8DUkgVukVgfQ7lhZebnSLoY5eqkyIWKiazfpnv/6ScdNoF0ackeM29hzjPMe4ezq3f6ZQPJMumw/n5Qilyaq8dpQvSkpBI74E8WuFtIcLxrB26ZhDHOACzBivmrBd6RWJ3Acj8X5+ikfCQaw+obs+6BQe0IJHNDUJUNebZGnnTH//xenOtRr7OYIACa4KenIeER6CqxiGkCKfZYQ1C2ZPe578C26j6wvciD1C758QX7xZGC7ydKDFEFfcw/ffAcz8jVZUO572HdwQ6yY2jR6viCvKc4zw+500QQRVydN7/wwTGRFVkqqV35B7JDfWDN0mWpcQIr2p1Wp7ofQBf9eDLg+R5ehXxGE1kyH5eP5HnY8U67TkteGE3k88VBloBHNuq0b8CjWM8Yyq+u32Qzbz/Wxpm3b906XR1Degf9ZxX8ao83gGWA+WIUXqV24vpNPuv+z9q5pm6dpXTizY759/El7D7S7wI+teYFFphG1OAJrfmDtbU1v5cNxfcsMIsjBFedMX4TkN6e+WAk1qQJcWPUznkF1txwY9gs6BMnuL3e0f0QSUujuSeGSvMMCCQTI+HBub2kR+y3seUgUeVKU+7/XR1Lu3wLWrIbo2JLdsk3YZP9sanUuePJC7aaa3v3MKA1vzFCBvMMGk0UYretLxhJXnHt5pYLZirJ1MuJ0XJDhhJHoGu7s1EAHsVxRlBrTv3nqDo0BK3LqOk2BPXIOrXAQ2z1fiujxxHBvtv/0izxRTcj6Mzbp9jjMWQmdgr2jhi5haI2aQ61wNXP0UmHHaPpvoftZ20tXAAl6YgBFMGSuSMKrwtd3s2ourPAxii8EfscHChEa6ARxLoba+hPKomJQc346k7cVzfrty8GAaKzUQKwu/soUefYdjLtOjLSbkjmk06xy6ozR4gLLZkjfPCUo9OZtzcj7oyfV7ZGbatTKAFYbDhstbNBhjWz7v+MvGsOtC0UsZ/DRgXA4yqwsK9iYjw2gN6EsbYrMQV+bC0i1NQ7uqqYWpcNofscm+6oBwbR2BEApOZcXpn9jhxIqYsCw1SZCwfKR8Zlw+iWDVUEurFnWMEwEQDINZsDfPBQ6AiPDaSXb6EPHsUGm4Gs+ADrDhfjDDk6rGFDOev+zVJpp8ALHnYu/D0u0EXwuJ+Dts87G8zdY1rQL/C21Em+HxAYNn4SWT35uGfDOfm4i2eUwPuyWxSbAziYZorEhrp1wQa0dpVFoIMNiagDCA3Qeg/+oJJcnXlsRGc//k/YBh+FPpHIXM6KjZsRNQyyMW3JluEVhO9PBPYCrySwa+P2TnvuKjaqR15QoH2forQrBoMa9qn2DBnWsGGddf+lSzQkwA7IyLqC1OqNmVjKTzkd2MDuAG9WASOAUlAAK/hrvGzLt6TLRtbNNxH6dfbduJi0pYyXuIINJCMb22mXcxxtoTuT2oQEyJSYR5mLXO2ywXULHQEcib7enjIuIgVujJVYOj2GDe+063mXgHoFQEPCGBPeiaaTcnsYZuMbztEZ7H9AOmrkm2fMGyeLJh22TAKHYGtS8sBKOHbEuyRTMs/WMBF846Ng87I7Eo3lsz6XVS8zJoRVc78M9ALcBOO4xmks7YNMCpvTCfaVHTcKz3EyCzMx9NIEgL3I/1xWuyqYINYsUwssoBfpn12BdGKSGEjGLtwvyzdG/BzOfgQmittHN1EABW6Cf9WTilzFhLHAFiG0X+nOGZ8/b4w6Jo0vAxxuX/Eusgw2M4429gaZODanM+CLyNdIMtXUYWwMr8g3Mnl847CyAMxByDEJ1ZNxpjFDQZcJpJsuMcAspBTT0G18cQYnlY8sE8nSgToJrg6hTYYgsxTfYJNT1DGZfJkFLnCVSBKEog3c17iIQLdTzkcmlDt8cAdXizhw+AHmqzcuoomqNb8yqQxG4SVcNXLo4ehFvs8XJLBmJxPLS8cVDFw/QjFsdm1cDK9Kj8mlB/d63yfszxYaF36Oh5lghkc3mUAZ8gj0iVbMRbrIXSaZbmqXgTWlnijcdQVKxkTuL85kM0dHsLb0A4S6qghYNCbGm4YJ5xawwRRbDHNNoZc1JopcyaTz/WCjaepCBOQaE0WeZuK5mG1xqhAjDYyJ0oFjJvJl5+EtJ9nBRJFnmKl8Od83C20x2Wbud1D4GZqHCesOTcZDvmn47Erf19MU1A127Wq8gbrxh12HFGaY4yFd4kxIgSKQuXD2KdhaPdNcg0tJXKCOhPqthbKHUD9jYURVhpmUhoGykN9x2DCoZooz8JiYehcTEKvD2EDOWIgmyp1MTi+9WUCsCWH7yBILh+9mghr8AEwK8q393zy2iifCeMr5xCR1B0w1clXWd56X5/MFhzJRfdlJAuHpPOdSGlk4kcnqH2EmePu9a3maZyeRDIUzYYVpSRs87TOb5BlwcCmLCxN+2KTPSWMYBzFksYZJ6xu7BMIj+psyynOybBPfkl2ZuG4XZDDFl1T6yv2y3L0p7pm8NoZ1CGT3Mp4CEMbBs1lROpehfKOf2UKtnQM/j0xiQfqR1g5ofKSV5Q4ejdkO8gJaPWRElhQAA+';

        // App Configuration
        const appConfig = {
            version: "2.1.0",
            lastUpdated: "2025-09-11",
            companyName: "Aftercare Planning Services",
            // API keys removed for security - should be handled server-side
            features: {
                enableDarkMode: true,
                enableAnalytics: false,
                enableAutoSave: true,
                sessionTimeout: 1800000, // 30 minutes
                maxDocumentHistory: 10
            }
        };

        // Program database metadata
        const programDatabase = {
            version: "2.0.0",
            lastUpdated: "2025-09-11",
            totalPrograms: 40
        };        // Complete program database from PROGRAMS.md
        const programs = [
            {
                            "id": "discovery_mood_parent",
                            "name": "Discovery Mood & Anxiety Programs",
                            "location": "Florida Network",
                            "type": "Adolescent Mood & Anxiety Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Regional network of adolescent residential, PHP, IOP, and virtual programs specializing in mood, anxiety, and co-occurring disorders with strong family integration.",
                            "tags": [
                                      "Mood Disorders",
                                      "Anxiety",
                                      "Residential",
                                      "PHP",
                                      "IOP",
                                      "Virtual"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "program_16",
                                                "parentId": "discovery_mood_parent",
                                                "name": "Dade City, FL",
                                                "location": "Dade City, FL",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential and PHP programs for adolescents ages 11‚Äì17 struggling with depression, anxiety, trauma, and co-occurring issues. Structured environment with family-focused care.",
                                                "features": [
                                                          "Residential Treatment: 24/7 therapeutic support in home-like setting.",
                                                          "PHP: Day program with therapy, group, and academic support.",
                                                          "CBT, DBT & Experiential Therapy: Weekly evidence-based individual and group sessions.",
                                                          "Psychiatric Oversight: Medication management and evaluation.",
                                                          "Family Integration: Weekly therapy and support groups."
                                                ],
                                                "contact": {
                                                          "phone": "(954) 825-9887",
                                                          "address": "Dade City, FL",
                                                          "website": "www.discoverymood.com"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 27.6648,
                                                          "lng": -81.5158
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_17",
                                                "parentId": "discovery_mood_parent",
                                                "name": "Maitland, FL",
                                                "location": "Maitland, FL",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "PHP and IOP services for adolescents ages 11‚Äì17. Flexible in-person programming near Orlando designed to support school-aged clients.",
                                                "features": [
                                                          "PHP: Structured day program with therapy and academics.",
                                                          "IOP: Afternoon programming for step-down or less acute needs.",
                                                          "Virtual Services: Optional for teens transitioning home.",
                                                          "Psychiatric Services: Medication and evaluation included.",
                                                          "Family Therapy: In-person and virtual family participation encouraged."
                                                ],
                                                "contact": {
                                                          "phone": "(954) 825-9887",
                                                          "address": "Maitland, FL",
                                                          "website": "www.discoverymood.com"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 27.6648,
                                                          "lng": -81.5158
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_18",
                                                "parentId": "discovery_mood_parent",
                                                "name": "Tampa-Orlando Region, FL",
                                                "location": "Tampa-Orlando Region, FL",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Boarded Partial Hospitalization Program (PHP) and Residential Treatment for teens with mood and anxiety disorders. Structured support for transition or crisis stabilization.",
                                                "features": [
                                                          "Residential: On-site housing and 24/7 support.",
                                                          "PHP: Intensive therapeutic programming with educational components.",
                                                          "Specialized Tracks: Trauma, anxiety, and co-occurring presentations.",
                                                          "Family Involvement: Required family therapy and parent support groups.",
                                                          "Psychiatric & Medical Care: On-site assessments and medication management."
                                                ],
                                                "contact": {
                                                          "phone": "(954) 825-9887",
                                                          "address": "Tampa-Orlando Region, FL",
                                                          "website": "www.discoverymood.com"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 27.6648,
                                                          "lng": -81.5158
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_19",
                                                "parentId": "discovery_mood_parent",
                                                "name": "Virtual PHP/IOP (Florida)",
                                                "location": "Virtual PHP/IOP (Florida)",
                                                "type": "Virtual Program",
                                                "category": "virtual",
                                                "programCategory": "Virtual / Outpatient Programs",
                                                "levelOfCare": "Secure, HIPAA-compliant virtual programming for adolescents ages 11‚Äì17 needing continued therapeutic care while living at home. Serves as either step-down from residential or stand-alone support.",
                                                "features": [
                                                          "PHP & IOP: Multiple weekly sessions tailored to teen availability.",
                                                          "Virtual Individual, Group, and Family Therapy: Real-time treatment with licensed clinicians.",
                                                          "Psychiatric Oversight: Medication management and remote evaluations.",
                                                          "Parent Involvement: Integrated family sessions and check-ins.",
                                                          "School Coordination: Adjusted schedules to accommodate academic needs."
                                                ],
                                                "contact": {
                                                          "phone": "(954) 825-9887",
                                                          "address": "Statewide Florida Access",
                                                          "website": "www.discoverymood.com"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 27.6648,
                                                          "lng": -81.5158
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 27.6648,
                                      "lng": -81.5158
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "friendship_circle_parent",
                            "name": "Friendship Circle South Florida",
                            "location": "South Florida Communities",
                            "type": "Inclusive Social Support Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Faith-inspired inclusive community programs pairing neurodiverse youth and teens with mentors for social engagement, belonging, and family support across South Florida.",
                            "tags": [
                                      "Neurodiversity",
                                      "Social Skills",
                                      "Community",
                                      "Faith-Based"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "program_20",
                                                "parentId": "friendship_circle_parent",
                                                "name": "Teen Scene (Fort Lauderdale, FL)",
                                                "location": "Teen Scene (Fort Lauderdale, FL)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Social engagement group for teens with special needs. Peer-driven and mentor-supported program offering community, fun, and confidence-building.",
                                                "features": [
                                                          "Teen Scene: Bi-monthly Sunday meetups.",
                                                          "Mentor Pairings: Teen volunteers partner with participants.",
                                                          "Social Skill Building: Structured, supportive interactions.",
                                                          "Parent Engagement: 'Mom's Night Out' community events."
                                                ],
                                                "contact": {
                                                          "phone": "754.800.1770",
                                                          "website": "https://friendshipfl.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 27.6648,
                                                          "lng": -81.5158
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_21",
                                                "parentId": "friendship_circle_parent",
                                                "name": "Hallandale, FL",
                                                "location": "Hallandale, FL",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Community-based social and recreational program for children and teens with developmental disabilities, paired with teen volunteers.",
                                                "features": [
                                                          "Inclusive Activities: Monthly meetups, crafts, sports, and games.",
                                                          "One-on-One Friendships: Peer matching for personal growth.",
                                                          "Parent Support: Occasional gatherings and resources."
                                                ],
                                                "contact": {
                                                          "address": "Hallandale Beach, FL",
                                                          "website": "https://www.friendshipcirclehallandale.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 27.6648,
                                                          "lng": -81.5158
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_22",
                                                "parentId": "friendship_circle_parent",
                                                "name": "Parkland/North Broward, FL",
                                                "location": "Parkland/North Broward, FL",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Friendship-based programming for teens with special needs focused on belonging, social development, and Jewish community identity.",
                                                "features": [
                                                          "Volunteer-Led Hangouts: Supervised by program directors.",
                                                          "Jewish Holiday Events: Faith-aligned community building.",
                                                          "Community Integration: Inclusive Shabbat dinners and more."
                                                ],
                                                "contact": {
                                                          "address": "Parkland, FL",
                                                          "website": "https://www.fcpb.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 27.6648,
                                                          "lng": -81.5158
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_23",
                                                "parentId": "friendship_circle_parent",
                                                "name": "Miami (Chabad of Kendall/Pinecrest)",
                                                "location": "Miami (Chabad of Kendall/Pinecrest)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Teen social group and family community programming rooted in Jewish values and inclusion. Open to all backgrounds.",
                                                "features": [
                                                          "Weekly Gatherings: Social groups and mentorship pairings.",
                                                          "Sensory Events: Music, art, games designed for accessibility.",
                                                          "Family Support: Educational and holiday family programming."
                                                ],
                                                "contact": {
                                                          "address": "Miami, FL",
                                                          "website": "https://friendshipcirclemiami.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 27.6648,
                                                          "lng": -81.5158
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 27.6648,
                                      "lng": -81.5158
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "high_focus_parent",
                            "name": "High Focus Treatment Centers",
                            "location": "New Jersey Network",
                            "type": "Adolescent PHP/IOP Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "New Jersey-based continuum offering DBT-informed partial hospitalization and intensive outpatient services for adolescents needing structured step-down care while living at home.",
                            "tags": [
                                      "PHP",
                                      "IOP",
                                      "DBT",
                                      "Outpatient",
                                      "New Jersey"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "program_28",
                                                "parentId": "high_focus_parent",
                                                "name": "Cherry Hill, NJ",
                                                "location": "Cherry Hill, NJ",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Adolescent PHP and IOP programs for ages 10‚Äì18 with psychiatric and therapeutic services designed to meet varying levels of acuity. All centers emphasize DBT skill-building and offer flexible scheduling for school-aged clients.",
                                                "features": [
                                                          "PHP: Full-day structured care with integrated academic support.",
                                                          "IOP: After-school mental health support including group therapy and psychiatry.",
                                                          "Weekly Psychiatry: Clients receive weekly psychiatric oversight.",
                                                          "DBT-Focused: DBT skills taught for emotional regulation, distress tolerance, and interpersonal effectiveness."
                                                ],
                                                "contact": {
                                                          "email": "aszuminski@highfocuscenters.com",
                                                          "address": "Cherry Hill, NJ, NJ",
                                                          "website": "https://www.highfocuscenters.com/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_29",
                                                "parentId": "high_focus_parent",
                                                "name": "Branchburg, NJ",
                                                "location": "Branchburg, NJ",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Adolescent PHP and IOP programs for ages 10‚Äì18 with psychiatric and therapeutic services designed to meet varying levels of acuity. All centers emphasize DBT skill-building and offer flexible scheduling for school-aged clients.",
                                                "features": [
                                                          "PHP: Full-day structured care with integrated academic support.",
                                                          "IOP: After-school mental health support including group therapy and psychiatry.",
                                                          "Weekly Psychiatry: Clients receive weekly psychiatric oversight.",
                                                          "DBT-Focused: DBT skills taught for emotional regulation, distress tolerance, and interpersonal effectiveness."
                                                ],
                                                "contact": {
                                                          "phone": "N/A",
                                                          "address": "Branchburg, NJ, NJ",
                                                          "website": "https://www.highfocuscenters.com/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_30",
                                                "parentId": "high_focus_parent",
                                                "name": "Lawrenceville, NJ",
                                                "location": "Lawrenceville, NJ",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Adolescent PHP and IOP programs for ages 10‚Äì18 with psychiatric and therapeutic services designed to meet varying levels of acuity. All centers emphasize DBT skill-building and offer flexible scheduling for school-aged clients.",
                                                "features": [
                                                          "PHP: Full-day structured care with integrated academic support.",
                                                          "IOP: After-school mental health support including group therapy and psychiatry.",
                                                          "Weekly Psychiatry: Clients receive weekly psychiatric oversight.",
                                                          "DBT-Focused: DBT skills taught for emotional regulation, distress tolerance, and interpersonal effectiveness."
                                                ],
                                                "contact": {
                                                          "phone": "N/A",
                                                          "address": "Lawrenceville, NJ, NJ",
                                                          "website": "https://www.highfocuscenters.com/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_31",
                                                "parentId": "high_focus_parent",
                                                "name": "Parsippany, NJ",
                                                "location": "Parsippany, NJ",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Adolescent PHP and IOP programs for ages 10‚Äì18 with psychiatric and therapeutic services designed to meet varying levels of acuity. All centers emphasize DBT skill-building and offer flexible scheduling for school-aged clients.",
                                                "features": [
                                                          "PHP: Full-day structured care with integrated academic support.",
                                                          "IOP: After-school mental health support including group therapy and psychiatry.",
                                                          "Weekly Psychiatry: Clients receive weekly psychiatric oversight.",
                                                          "DBT-Focused: DBT skills taught for emotional regulation, distress tolerance, and interpersonal effectiveness."
                                                ],
                                                "contact": {
                                                          "phone": "N/A",
                                                          "address": "Parsippany, NJ, NJ",
                                                          "website": "https://www.highfocuscenters.com/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "rosecrance_parent",
                            "name": "Rosecrance Adolescent Services",
                            "location": "Illinois Network",
                            "type": "Substance Use & Mental Health Provider",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Illinois-based nonprofit providing comprehensive adolescent substance use and mental health services including residential treatment, PHP, IOP, and family-centered recovery supports at multiple locations.",
                            "tags": [
                                      "Substance Use",
                                      "Dual Diagnosis",
                                      "Residential",
                                      "PHP",
                                      "IOP"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "program_32",
                                                "parentId": "rosecrance_parent",
                                                "name": "Frankfort, IL",
                                                "location": "Frankfort, IL",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Outpatient and/or residential substance use and mental health treatment for adolescents, depending on the site.",
                                                "features": [
                                                          "IOP Services: Structured programming while teens reside at home.",
                                                          "PHP or Residential (site-dependent): Full-day or on-site therapeutic living.",
                                                          "Family-Focused Treatment: Includes group, individual, and family therapy.",
                                                          "Recovery Education: Skills training, relapse prevention, and peer support."
                                                ],
                                                "contact": {
                                                          "phone": "815.391.1000",
                                                          "address": "Frankfort, IL, IL",
                                                          "website": "https://rosecrance.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_33",
                                                "parentId": "rosecrance_parent",
                                                "name": "Chicago, IL",
                                                "location": "Chicago, IL",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Outpatient and/or residential substance use and mental health treatment for adolescents, depending on the site.",
                                                "features": [
                                                          "IOP Services: Structured programming while teens reside at home.",
                                                          "PHP or Residential (site-dependent): Full-day or on-site therapeutic living.",
                                                          "Family-Focused Treatment: Includes group, individual, and family therapy.",
                                                          "Recovery Education: Skills training, relapse prevention, and peer support."
                                                ],
                                                "contact": {
                                                          "phone": "815.391.1000",
                                                          "address": "Chicago, IL, IL",
                                                          "website": "https://rosecrance.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_34",
                                                "parentId": "rosecrance_parent",
                                                "name": "McHenry County, IL",
                                                "location": "McHenry County, IL",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Outpatient and/or residential substance use and mental health treatment for adolescents, depending on the site.",
                                                "features": [
                                                          "IOP Services: Structured programming while teens reside at home.",
                                                          "PHP or Residential (site-dependent): Full-day or on-site therapeutic living.",
                                                          "Family-Focused Treatment: Includes group, individual, and family therapy.",
                                                          "Recovery Education: Skills training, relapse prevention, and peer support."
                                                ],
                                                "contact": {
                                                          "phone": "815.391.1000",
                                                          "address": "McHenry County, IL, IL",
                                                          "website": "https://rosecrance.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_35",
                                                "parentId": "rosecrance_parent",
                                                "name": "Rockford, IL",
                                                "location": "Rockford, IL",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Outpatient and/or residential substance use and mental health treatment for adolescents, depending on the site.",
                                                "features": [
                                                          "IOP Services: Structured programming while teens reside at home.",
                                                          "PHP or Residential (site-dependent): Full-day or on-site therapeutic living.",
                                                          "Family-Focused Treatment: Includes group, individual, and family therapy.",
                                                          "Recovery Education: Skills training, relapse prevention, and peer support."
                                                ],
                                                "contact": {
                                                          "phone": "815.391.1000",
                                                          "address": "Rockford, IL, IL",
                                                          "website": "https://rosecrance.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "sheppard_pratt_parent",
                            "name": "Sheppard Pratt Schools",
                            "location": "Maryland Network",
                            "type": "Special Education & Therapeutic Schools",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Maryland-wide network of Sheppard Pratt special education day schools delivering therapeutic academics and behavioral support for students with autism, emotional disabilities, and neurodevelopmental challenges.",
                            "tags": [
                                      "Special Education",
                                      "Autism",
                                      "Day School",
                                      "Behavioral Support"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "program_36",
                                                "parentId": "sheppard_pratt_parent",
                                                "name": "Special Education Day School (Glyndon, MD)",
                                                "location": "Special Education Day School (Glyndon, MD)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.",
                                                "features": [
                                                          "Full-Day School: Licensed academic and behavioral day program.",
                                                          "IEP-Based Instruction: Individualized supports aligned to school district goals.",
                                                          "Clinical Oversight: On-site behavioral and therapeutic staff.",
                                                          "Community Integration: Transition-focused services and parent collaboration."
                                                ],
                                                "contact": {
                                                          "address": "Glyndon, MD, MD",
                                                          "website": "https://www.sheppardpratt.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_37",
                                                "parentId": "sheppard_pratt_parent",
                                                "name": "Special Education Day School (Hunt Valley, MD)",
                                                "location": "Special Education Day School (Hunt Valley, MD)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.",
                                                "features": [
                                                          "Full-Day School: Licensed academic and behavioral day program.",
                                                          "IEP-Based Instruction: Individualized supports aligned to school district goals.",
                                                          "Clinical Oversight: On-site behavioral and therapeutic staff.",
                                                          "Community Integration: Transition-focused services and parent collaboration."
                                                ],
                                                "contact": {
                                                          "address": "Hunt Valley, MD, MD",
                                                          "website": "https://www.sheppardpratt.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_38",
                                                "parentId": "sheppard_pratt_parent",
                                                "name": "Special Education Day School (Gaithersburg, MD)",
                                                "location": "Special Education Day School (Gaithersburg, MD)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.",
                                                "features": [
                                                          "Full-Day School: Licensed academic and behavioral day program.",
                                                          "IEP-Based Instruction: Individualized supports aligned to school district goals.",
                                                          "Clinical Oversight: On-site behavioral and therapeutic staff.",
                                                          "Community Integration: Transition-focused services and parent collaboration."
                                                ],
                                                "contact": {
                                                          "address": "Gaithersburg, MD, MD",
                                                          "website": "https://www.sheppardpratt.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_39",
                                                "parentId": "sheppard_pratt_parent",
                                                "name": "Special Education Day School (Cumberland, MD)",
                                                "location": "Special Education Day School (Cumberland, MD)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.",
                                                "features": [
                                                          "Full-Day School: Licensed academic and behavioral day program.",
                                                          "IEP-Based Instruction: Individualized supports aligned to school district goals.",
                                                          "Clinical Oversight: On-site behavioral and therapeutic staff.",
                                                          "Community Integration: Transition-focused services and parent collaboration."
                                                ],
                                                "contact": {
                                                          "address": "Cumberland, MD, MD",
                                                          "website": "https://www.sheppardpratt.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_40",
                                                "parentId": "sheppard_pratt_parent",
                                                "name": "Special Education Day School (Frederick, MD)",
                                                "location": "Special Education Day School (Frederick, MD)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.",
                                                "features": [
                                                          "Full-Day School: Licensed academic and behavioral day program.",
                                                          "IEP-Based Instruction: Individualized supports aligned to school district goals.",
                                                          "Clinical Oversight: On-site behavioral and therapeutic staff.",
                                                          "Community Integration: Transition-focused services and parent collaboration."
                                                ],
                                                "contact": {
                                                          "address": "Frederick, MD, MD",
                                                          "website": "https://www.sheppardpratt.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_41",
                                                "parentId": "sheppard_pratt_parent",
                                                "name": "Special Education Day School (Lanham, MD)",
                                                "location": "Special Education Day School (Lanham, MD)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.",
                                                "features": [
                                                          "Full-Day School: Licensed academic and behavioral day program.",
                                                          "IEP-Based Instruction: Individualized supports aligned to school district goals.",
                                                          "Clinical Oversight: On-site behavioral and therapeutic staff.",
                                                          "Community Integration: Transition-focused services and parent collaboration."
                                                ],
                                                "contact": {
                                                          "address": "Lanham, MD, MD",
                                                          "website": "https://www.sheppardpratt.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_42",
                                                "parentId": "sheppard_pratt_parent",
                                                "name": "Special Education Day School (Millersville, MD)",
                                                "location": "Special Education Day School (Millersville, MD)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.",
                                                "features": [
                                                          "Full-Day School: Licensed academic and behavioral day program.",
                                                          "IEP-Based Instruction: Individualized supports aligned to school district goals.",
                                                          "Clinical Oversight: On-site behavioral and therapeutic staff.",
                                                          "Community Integration: Transition-focused services and parent collaboration."
                                                ],
                                                "contact": {
                                                          "address": "Millersville, MD, MD",
                                                          "website": "https://www.sheppardpratt.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "program_43",
                                                "parentId": "sheppard_pratt_parent",
                                                "name": "Special Education Day School (Rockville, MD)",
                                                "location": "Special Education Day School (Rockville, MD)",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Non-residential special education school for youth with behavioral, emotional, and neurodevelopmental challenges. Supports students with autism, ADHD, and emotional disabilities in a therapeutic educational setting.",
                                                "features": [
                                                          "Full-Day School: Licensed academic and behavioral day program.",
                                                          "IEP-Based Instruction: Individualized supports aligned to school district goals.",
                                                          "Clinical Oversight: On-site behavioral and therapeutic staff.",
                                                          "Community Integration: Transition-focused services and parent collaboration."
                                                ],
                                                "contact": {
                                                          "address": "Rockville, MD, MD",
                                                          "website": "https://www.sheppardpratt.org/"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": null,
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "mclean_hospital_parent",
                            "name": "McLean Hospital",
                            "location": "Massachusetts",
                            "type": "Harvard-Affiliated Behavioral Health System",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "McLean Hospital is a Harvard Medical School-affiliated psychiatric hospital offering internationally recognized DBT, OCD, and acute psychiatric programs for adolescents and young adults across multiple Massachusetts campuses.",
                            "tags": [
                                      "DBT",
                                      "OCD",
                                      "Psychiatric Hospital",
                                      "Research-Based"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "mclean_3east_dbt",
                                                "parentId": "mclean_hospital_parent",
                                                "name": "3East Dialectical Behavior Therapy Programs",
                                                "location": "Arlington, MA",
                                                "type": "Specialized DBT Treatment Center",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential, PHP, IOP, Outpatient",
                                                "features": [
                                                          "Nationally recognized DBT immersion with 30+ randomized trials",
                                                          "4-6 week intensive treatment programs",
                                                          "Gender-specific residential tracks by skill level",
                                                          "Co-ed partial hospital 9am-3pm Monday-Friday",
                                                          "Required weekly DBT family therapy",
                                                          "Parent skill groups with international conference calls",
                                                          "Graduate program for DBT alumni",
                                                          "Harvard affiliation with world-renowned experts",
                                                          "Treatment-resistant case expertise",
                                                          "Medication reduction through skillful living"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "617-855-2804",
                                                          "email": "",
                                                          "website": "www.mcleanhospital.org/treatment/3east",
                                                          "address": "Arlington, MA"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.4072,
                                                          "lng": -71.3824
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "mclean_art_program",
                                                "parentId": "mclean_hospital_parent",
                                                "name": "Adolescent Acute Residential Treatment (ART)",
                                                "location": "Middleborough, MA",
                                                "type": "Short-Term Psychiatric Residential",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Short-term residential (10-14 days)",
                                                "features": [
                                                          "Unlocked voluntary setting maximizing self-control",
                                                          "ADHD, anxiety, depression, bipolar specialization",
                                                          "DBT-based psychoeducational groups",
                                                          "Board-certified psychiatrists and licensed clinicians",
                                                          "Integrated with McLean SouthEast PHP for step-down",
                                                          "Accepts commercial insurance, Medicare, MA Medicaid",
                                                          "Skills training and team building activities",
                                                          "Meal preparation and recreational therapy",
                                                          "Educational services coordination",
                                                          "Multidisciplinary team approach"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "877-502-0185",
                                                          "email": "",
                                                          "website": "www.mcleanhospital.org/treatment/adolescent-art",
                                                          "address": "Middleborough, MA"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.4072,
                                                          "lng": -71.3824
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "mclean_ocdi_jr",
                                                "parentId": "mclean_hospital_parent",
                                                "name": "OCD Institute Jr. (OCDI Jr.)",
                                                "location": "Belmont, MA",
                                                "type": "OCD Specialty Treatment Center",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential (2-month average), PHP",
                                                "features": [
                                                          "Exposure and Response Prevention (ERP) primary therapy",
                                                          "Acceptance and Commitment Therapy (ACT)",
                                                          "Treatment-resistant OCD expertise",
                                                          "Stepped care model between residential and PHP",
                                                          "2 hours daily tailored academic instruction",
                                                          "McLean-owned tablets for family communication",
                                                          "Part of Division of Depression and Anxiety Disorders",
                                                          "Ongoing research integration",
                                                          "Comprehensive family therapy and education",
                                                          "Accepts most insurance with self-pay option"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "617-855-4660",
                                                          "email": "",
                                                          "website": "www.mcleanhospital.org/treatment/ocd-institute",
                                                          "address": "East House, McLean Hospital, 115 Mill Street, Belmont, MA 02478"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.3959,
                                                          "lng": -71.1787
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 42.4072,
                                      "lng": -71.3824
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "seven_hills_parent",
                            "name": "Seven Hills Foundation",
                            "location": "Massachusetts Network",
                            "type": "Comprehensive Human Services Organization",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Seven Hills Foundation serves over 50,000 individuals annually through specialized residential treatment, schools, and crisis services supporting youth with developmental disabilities, trauma histories, and complex behavioral needs.",
                            "tags": [
                                      "Residential Treatment",
                                      "Developmental Disabilities",
                                      "Massachusetts",
                                      "Crisis Support"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "stetson_school_seven_hills",
                                                "parentId": "seven_hills_parent",
                                                "name": "Stetson School ‚Äì Seven Hills Foundation",
                                                "location": "Barre, MA",
                                                "type": "Male-Only Specialized RTC",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment with 24/7 therapeutic milieu",
                                                "features": [
                                                          "Board-certified child psychiatrist on-site",
                                                          "Integrated psychiatric care and medication management",
                                                          "Grades 4-12 accredited school on campus",
                                                          "10:1 classroom ratios with specialized support",
                                                          "On-campus nursing 16 hours daily",
                                                          "24/7 on-call coverage through Barre Family Health",
                                                          "Specialized latency program for boys 9-12",
                                                          "Age-appropriate therapeutic interventions",
                                                          "Trauma-informed care approach",
                                                          "Attachment-based interventions"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "978-355-4541",
                                                          "email": "",
                                                          "website": "www.sevenhills.org/programs/residential-program-at-stetson-school",
                                                          "address": "455 South Street, Barre, MA 01005"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.4072,
                                                          "lng": -71.3824
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "seven_hills_valor_house",
                                                "parentId": "seven_hills_parent",
                                                "name": "Valor House",
                                                "location": "MA",
                                                "type": "Male Intensive Treatment Residence",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Intensive treatment residence",
                                                "features": [
                                                          "24/7 staffed therapeutic environment",
                                                          "Individual, group, and family therapy",
                                                          "Family work integral to treatment",
                                                          "Trauma and adverse life events focus",
                                                          "Behavioral challenges and emotional regulation",
                                                          "Reintegration to natural environment focus",
                                                          "Independent living skills preparation",
                                                          "Traditional home setting atmosphere",
                                                          "Stabilization and maladaptive behavior reduction",
                                                          "Individualized discharge planning"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.sevenhills.org/programs/congregate-care",
                                                          "address": "MA"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.4072,
                                                          "lng": -71.3824
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "seven_hills_oxford_house",
                                                "parentId": "seven_hills_parent",
                                                "name": "George Bernardin Oxford House",
                                                "location": "MA",
                                                "type": "Male Intensive Treatment Residence",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Intensive treatment residence",
                                                "features": [
                                                          "Traditional colonial home normalized environment",
                                                          "24/7 professional staffing and structure",
                                                          "Comprehensive clinical services",
                                                          "Individual, group, and family therapy",
                                                          "Trauma and behavioral challenges focus",
                                                          "Family involvement prioritized",
                                                          "Community engagement emphasis",
                                                          "Life skill development programming",
                                                          "Stabilization goals and safety",
                                                          "Evidence-based interventions"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.sevenhills.org/programs/congregate-care",
                                                          "address": "MA"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.4072,
                                                          "lng": -71.3824
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "seven_hills_schmidt_village",
                                                "parentId": "seven_hills_parent",
                                                "name": "Carol O. Schmidt Village",
                                                "location": "Worcester, MA",
                                                "type": "Co-Ed Emergency Residence",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Emergency/crisis stabilization",
                                                "features": [
                                                          "Crisis stabilization and immediate safety",
                                                          "Psychiatric stabilization for youth in crisis",
                                                          "30-45 day average stay",
                                                          "Comprehensive assessment for placement",
                                                          "Individual, group, family therapy",
                                                          "Recreational therapy services",
                                                          "Multiple sensory-based environments",
                                                          "Emotional regulation support",
                                                          "Discharge planning coordination",
                                                          "Reunification or transition planning"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "508-755-2340",
                                                          "email": "",
                                                          "website": "www.sevenhills.org",
                                                          "address": "Worcester, MA"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.2626,
                                                          "lng": -71.8023
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 42.4072,
                                      "lng": -71.3824
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "nfi_network_parent",
                            "name": "NFI (National Foundation, Inc.) Network",
                            "location": "VT & NH",
                            "type": "Trauma-Informed Continuum of Care",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "NFI delivers community-based residential, educational, and wraparound services across Vermont and New Hampshire utilizing the Normative Approach to help youth build healthy peer culture and transition safely home.",
                            "tags": [
                                      "Normative Approach",
                                      "Residential",
                                      "Community-Based",
                                      "Vermont/New Hampshire"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "nfi_vermont_programs",
                                                "parentId": "nfi_network_parent",
                                                "name": "NFI Vermont Programs",
                                                "location": "South Burlington, VT",
                                                "type": "Comprehensive Mental Health System",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Multiple levels of care",
                                                "features": [
                                                          "Trauma-informed care across all programs",
                                                          "Family therapy emphasis",
                                                          "Community integration focus",
                                                          "12-18 month residential stays typical",
                                                          "Small group settings (6 clients)",
                                                          "Public school attendance maintained",
                                                          "Reading improvement focus in schools",
                                                          "DBT skills training in IOP",
                                                          "Clinical case management",
                                                          "Red Sox Foundation Award finalist"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "802-488-6000",
                                                          "email": "",
                                                          "website": "www.nfivermont.org",
                                                          "address": "30 Airport Road, South Burlington, VT 05403"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 44.4759,
                                                          "lng": -73.2121
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "nfi_north_contoocook_school",
                                                "parentId": "nfi_network_parent",
                                                "name": "NFI North - The Contoocook School",
                                                "location": "Contoocook, NH",
                                                "type": "Special Education Day School",
                                                "category": "therapeutic-school",
                                                "programCategory": "Therapeutic Schools",
                                                "levelOfCare": "Day treatment/special education",
                                                "features": [
                                                          "Normative Approach therapeutic community",
                                                          "Group interventions and peer support",
                                                          "Serves EH, LD, OHI, and Autism spectrum",
                                                          "Joint Commission Accredited",
                                                          "Experiential learning integration",
                                                          "180-day academic program",
                                                          "Summer school option",
                                                          "Family involvement in treatment",
                                                          "Diploma granting certified school",
                                                          "Maximum 18 students"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "603-746-7702",
                                                          "email": "",
                                                          "website": "www.nfinorth.com",
                                                          "address": "40 Park Lane, Contoocook, NH 03229"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 43.1939,
                                                          "lng": -71.5724
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "nfi_north_residential",
                                                "parentId": "nfi_network_parent",
                                                "name": "NFI North Residential Group Care",
                                                "location": "Contoocook, NH",
                                                "type": "Residential Treatment Homes",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "NFI Normative Community model",
                                                          "Complex trauma and attachment focus",
                                                          "Developmental disabilities support",
                                                          "Family-driven, youth-guided approach",
                                                          "Culturally competent services",
                                                          "TF-CBT and DBT interventions",
                                                          "Supported employment",
                                                          "Home-like therapeutic environments",
                                                          "Family reunification focus",
                                                          "Small community settings"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "603-746-7702",
                                                          "email": "",
                                                          "website": "www.nfinorth.com",
                                                          "address": "Contoocook, NH"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 43.1939,
                                                          "lng": -71.5724
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "nfi_north_transitional",
                                                "parentId": "nfi_network_parent",
                                                "name": "NFI North Transitional Housing Services",
                                                "location": "Concord, NH",
                                                "type": "Transitional Living Program",
                                                "category": "sober-living",
                                                "programCategory": "Sober Living / Transitional Programs",
                                                "levelOfCare": "Transitional living",
                                                "features": [
                                                          "Bridge to permanent housing",
                                                          "Clinical and medical services",
                                                          "Vocational support",
                                                          "Life skills development",
                                                          "Financial literacy training",
                                                          "Job search assistance",
                                                          "Independent living skills",
                                                          "Trauma-responsive approach",
                                                          "Community integration focus",
                                                          "Youth-guided practice"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "603-746-7702",
                                                          "email": "",
                                                          "website": "www.nfinorth.com",
                                                          "address": "Concord, NH"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 43.2081,
                                                          "lng": -71.5376
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "nfi_north_fast_forward",
                                                "parentId": "nfi_network_parent",
                                                "name": "NFI North FAST Forward System of Care",
                                                "location": "Statewide, NH",
                                                "type": "Wraparound Services",
                                                "category": "outpatient",
                                                "programCategory": "Virtual / Outpatient Programs",
                                                "levelOfCare": "Intensive outpatient/wraparound",
                                                "features": [
                                                          "FAST Forward wraparound model",
                                                          "Home-based counseling",
                                                          "Youth M.O.V.E. NH peer support",
                                                          "Individual Service Option (ISO) since 2009",
                                                          "TrECC transitional care coordination",
                                                          "Prevents out-of-home placement",
                                                          "Intensive care coordination",
                                                          "Natural environment services",
                                                          "Evidence-based practices",
                                                          "Culturally competent statewide coverage"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "603-746-7702",
                                                          "email": "",
                                                          "website": "www.nfinorth.com",
                                                          "address": "Statewide, NH"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 43.1939,
                                                          "lng": -71.5724
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "natchaug_hospital_school_parent",
                            "name": "Natchaug Hospital School",
                            "location": "Connecticut",
                            "type": "Clinical Day Treatment Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Hartford HealthCare's Natchaug Hospital School operates therapeutic day treatment campuses across Connecticut, integrating special education with intensive clinical services for youth who need structured support beyond public school settings.",
                            "tags": [
                                      "Day Treatment",
                                      "Special Education",
                                      "Hartford HealthCare",
                                      "Therapeutic School"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "natchaug_school_mansfield",
                                                "parentId": "natchaug_hospital_school_parent",
                                                "name": "Mansfield Center",
                                                "location": "Mansfield Center, CT",
                                                "type": "Clinical Day Treatment School",
                                                "category": "therapeutic-school",
                                                "programCategory": "Therapeutic Schools",
                                                "levelOfCare": "Day treatment",
                                                "features": [
                                                          "Main campus with most comprehensive services",
                                                          "Direct link to inpatient psychiatric unit",
                                                          "Journey House residential on same campus",
                                                          "Grades 1-12 full range coverage",
                                                          "Psychiatric services readily available",
                                                          "Immediate access to higher care if needed",
                                                          "Quiet northeastern Connecticut location",
                                                          "Hartford HealthCare network",
                                                          "State approved special education",
                                                          "Crisis intervention capabilities"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.natchaug.org",
                                                          "address": "Mansfield Center, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "natchaug_school_danielson",
                                                "parentId": "natchaug_hospital_school_parent",
                                                "name": "Danielson",
                                                "location": "Danielson, CT",
                                                "type": "Clinical Day Treatment School",
                                                "category": "therapeutic-school",
                                                "programCategory": "Therapeutic Schools",
                                                "levelOfCare": "Day treatment",
                                                "features": [
                                                          "Serves northeast Connecticut rural areas",
                                                          "Small program with low student-teacher ratios",
                                                          "Strong local Danielson community connections",
                                                          "Elementary through high school coverage",
                                                          "Seven Challenges substance abuse integration",
                                                          "Transportation coordination with districts",
                                                          "Rural population specialized understanding",
                                                          "Hartford HealthCare network",
                                                          "Evidence-based therapeutic approaches",
                                                          "Family involvement component"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.natchaug.org",
                                                          "address": "Danielson, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "natchaug_school_enfield",
                                                "parentId": "natchaug_hospital_school_parent",
                                                "name": "Enfield",
                                                "location": "Enfield, CT",
                                                "type": "Clinical Day Treatment School",
                                                "category": "therapeutic-school",
                                                "programCategory": "Therapeutic Schools",
                                                "levelOfCare": "Day treatment",
                                                "features": [
                                                          "Border location serving CT and MA families",
                                                          "Easy access from I-91 corridor",
                                                          "Suburban setting with community resources",
                                                          "Middle and high school specialized focus",
                                                          "Serves Enfield, Suffield, Windsor Locks area",
                                                          "Full integration of education and therapy",
                                                          "Strong partnerships with sending schools",
                                                          "Hartford HealthCare network",
                                                          "Crisis support available",
                                                          "Academic progress maintenance"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.natchaug.org",
                                                          "address": "Enfield, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "natchaug_school_franklin",
                                                "parentId": "natchaug_hospital_school_parent",
                                                "name": "Franklin",
                                                "location": "Franklin, CT",
                                                "type": "Clinical Day Treatment School",
                                                "category": "therapeutic-school",
                                                "programCategory": "Therapeutic Schools",
                                                "levelOfCare": "Day treatment",
                                                "features": [
                                                          "Small rural program in quiet Franklin",
                                                          "Elementary through middle school focus",
                                                          "Agricultural area outdoor opportunities",
                                                          "Serves Lebanon, Bozrah, Franklin region",
                                                          "Family-style small program environment",
                                                          "Intensive behavioral interventions focus",
                                                          "Transition planning to district schools",
                                                          "Hartford HealthCare network",
                                                          "Nature-based activity options",
                                                          "Individualized treatment planning"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.natchaug.org",
                                                          "address": "Franklin, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "natchaug_school_norwich",
                                                "parentId": "natchaug_hospital_school_parent",
                                                "name": "Norwich",
                                                "location": "Norwich, CT",
                                                "type": "Clinical Day Treatment School",
                                                "category": "therapeutic-school",
                                                "programCategory": "Therapeutic Schools",
                                                "levelOfCare": "Day treatment",
                                                "features": [
                                                          "Regional hub for southeastern Connecticut",
                                                          "Urban Norwich setting with resources",
                                                          "Grades K-12 comprehensive programming",
                                                          "Serves urban and surrounding rural towns",
                                                          "Casino region economic factors understanding",
                                                          "Strong psychiatric and therapeutic support",
                                                          "Vocational connections to technical schools",
                                                          "Hartford HealthCare network",
                                                          "Diverse population experience",
                                                          "Community partnership focus"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.natchaug.org",
                                                          "address": "Norwich, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "natchaug_school_old_saybrook",
                                                "parentId": "natchaug_hospital_school_parent",
                                                "name": "Old Saybrook",
                                                "location": "Old Saybrook, CT",
                                                "type": "Clinical Day Treatment School",
                                                "category": "therapeutic-school",
                                                "programCategory": "Therapeutic Schools",
                                                "levelOfCare": "Day treatment",
                                                "features": [
                                                          "Serves Old Saybrook, Essex, Chester, Deep River",
                                                          "Shoreline therapeutic activity utilization",
                                                          "Tourist area museums, parks, cultural access",
                                                          "Middle-high school adolescent focus",
                                                          "Central shoreline regional program",
                                                          "Small coastal program with ocean proximity",
                                                          "Beach therapy in family programming",
                                                          "Hartford HealthCare network",
                                                          "Maritime heritage incorporation",
                                                          "Seasonal therapeutic opportunities"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.natchaug.org",
                                                          "address": "Old Saybrook, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 41.6032,
                                      "lng": -73.0877
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "connecticut_junior_republic_parent",
                            "name": "Connecticut Junior Republic",
                            "location": "Connecticut",
                            "type": "Continuum of Care for Adolescents",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Connecticut Junior Republic (CJR) delivers residential, community-based, and transitional living services that blend clinical treatment, education, and workforce development for court-involved and high-needs youth statewide.",
                            "tags": [
                                      "Residential",
                                      "Transitional Living",
                                      "Juvenile Justice",
                                      "Family Services"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "cjr_amir_litchfield",
                                                "parentId": "connecticut_junior_republic_parent",
                                                "name": "AMIR Program (Litchfield)",
                                                "location": "Litchfield, CT",
                                                "type": "Short-Term DBT Residential",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "DBT-integrated model throughout programming",
                                                          "4-month structured short-term intensive treatment",
                                                          "Primary substance use treatment with mental health support",
                                                          "Youth must be eligible to return home or identified placement",
                                                          "Intensive family collaboration throughout program",
                                                          "Educational planning for smooth school re-entry",
                                                          "All admissions through DCF/court systems",
                                                          "Motivational interviewing techniques",
                                                          "Relapse prevention focus",
                                                          "Community reintegration planning"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.cjrimpact.org",
                                                          "address": "Litchfield, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "cjr_regions_waterbury",
                                                "parentId": "connecticut_junior_republic_parent",
                                                "name": "REGIONS Program (Waterbury)",
                                                "location": "Waterbury, CT",
                                                "type": "Comprehensive Residential",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "Full spectrum clinical, educational, vocational programming",
                                                          "Central Connecticut location accessible from major cities",
                                                          "On-campus school with full academic program",
                                                          "Vocational training and career development",
                                                          "Structured recreational therapy",
                                                          "Longer-term option than AMIR program",
                                                          "Multi-disciplinary team approach",
                                                          "Integration of educational and clinical staff",
                                                          "DCF referrals required",
                                                          "Community service opportunities"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.cjrimpact.org",
                                                          "address": "Waterbury, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.5582,
                                                          "lng": -73.0515
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "cjr_winchester_group",
                                                "parentId": "connecticut_junior_republic_parent",
                                                "name": "Winchester Group Home",
                                                "location": "Winchester, CT",
                                                "type": "Therapeutic Group Home",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Group home",
                                                "features": [
                                                          "Maximum 5 residents for family-style atmosphere",
                                                          "Extended age range through 21 for transitional support",
                                                          "Residents attend local Winchester schools",
                                                          "Independent living skills training focus",
                                                          "Home-like normalized living experience",
                                                          "Age-appropriate developmental milestones",
                                                          "Northwest Connecticut rural setting",
                                                          "Community integration activities",
                                                          "DCF referrals required",
                                                          "Preparation for adult independence"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.cjrimpact.org",
                                                          "address": "Winchester, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "cjr_transitional_wethersfield",
                                                "parentId": "connecticut_junior_republic_parent",
                                                "name": "Transitional Living (Wethersfield)",
                                                "location": "Wethersfield, CT",
                                                "type": "Transitional Living Program",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Transitional living",
                                                "features": [
                                                          "Bridge program for older adolescents/young adults",
                                                          "Rent-free housing up to 2 years",
                                                          "Specifically for youth exiting justice system",
                                                          "High school/GED completion assistance",
                                                          "Trade skill development opportunities",
                                                          "Financial guidance and budgeting training",
                                                          "Greater Hartford area urban resources",
                                                          "Employment assistance and job placement",
                                                          "DCF/JBCSSD referrals",
                                                          "Life skills and independence focus"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.cjrimpact.org",
                                                          "address": "Wethersfield, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 41.6032,
                                      "lng": -73.0877
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "northern_rivers_parent",
                            "name": "Northern Rivers Family of Services",
                            "location": "New York",
                            "type": "Comprehensive Children's Services Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Northern Rivers unites Parsons Child & Family Center and other affiliates to provide residential treatment, crisis stabilization, therapeutic education, and community support for youth across New York's Capital Region.",
                            "tags": [
                                      "Residential Treatment",
                                      "Crisis Stabilization",
                                      "Therapeutic School",
                                      "Community Services"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "northern_rivers_schenectady_rtc",
                                                "parentId": "northern_rivers_parent",
                                                "name": "Northern Rivers ‚Äì Schenectady Residential Treatment Center",
                                                "location": "Schenectady, NY",
                                                "type": "Multi-Unit RTC",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "8-bed intensive Hard-to-Place unit",
                                                          "4-bed Raise the Age program",
                                                          "ARC trauma model (attachment, regulation, competency)",
                                                          "Master's level clinical staff",
                                                          "School at Northeast grades 6-12",
                                                          "Transitional Independent Living",
                                                          "Employment preparation",
                                                          "DSS, Probation, Family Court referrals",
                                                          "PINS and misdemeanor history",
                                                          "COA certified, OCFS licensed QRTP"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "518-337-0926",
                                                          "email": "",
                                                          "website": "www.northernrivers.org",
                                                          "address": "Schenectady, NY"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "northern_rivers_academy_place",
                                                "parentId": "northern_rivers_parent",
                                                "name": "Northern Rivers ‚Äì Academy Place",
                                                "location": "Albany, NY",
                                                "type": "Agency-Owned Boarding Home",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Boarding home",
                                                "features": [
                                                          "24-bed capacity",
                                                          "Primary focus ages 10-18",
                                                          "Community integration emphasis",
                                                          "Neil Hellman School K-12",
                                                          "Trauma-informed care",
                                                          "Restorative practices",
                                                          "Independent living preparation",
                                                          "COA certified",
                                                          "OCFS licensed facility"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "518-426-2600",
                                                          "email": "",
                                                          "website": "www.northernrivers.org",
                                                          "address": "Albany, NY"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.6526,
                                                          "lng": -73.7562
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "northern_rivers_omh_rtf",
                                                "parentId": "northern_rivers_parent",
                                                "name": "Northern Rivers ‚Äì Residential Treatment Facility (OMH)",
                                                "location": "Albany, NY",
                                                "type": "OMH-Licensed RTF",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment facility",
                                                "features": [
                                                          "Pattern of psychiatric interventions",
                                                          "State-of-the-art building",
                                                          "Specialized care management suite",
                                                          "Trauma-informed multidisciplinary team",
                                                          "High family engagement",
                                                          "Successful reintegration focus",
                                                          "9-county Capital Region",
                                                          "SPOA team entry",
                                                          "Comprehensive nursing services",
                                                          "On-site psychiatric services"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "518-258-2568",
                                                          "email": "",
                                                          "website": "www.northernrivers.org",
                                                          "address": "Academy Road Campus"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.6526,
                                                          "lng": -73.7562
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "northern_rivers_crisis_programs",
                                                "parentId": "northern_rivers_parent",
                                                "name": "Northern Rivers ‚Äì Crisis Stabilization & Youth ACT",
                                                "location": "Schenectady, NY",
                                                "type": "Crisis and Intensive Services",
                                                "category": "outpatient",
                                                "programCategory": "Virtual / Outpatient Programs",
                                                "levelOfCare": "Crisis and intensive outpatient",
                                                "features": [
                                                          "Mobile crisis rapid-response teams",
                                                          "Schaffer Program 8-bed facility ages 4-12",
                                                          "Youth ACT team ages 10-21",
                                                          "Home-Based Crisis Intervention (HBCI)",
                                                          "Comprehensive diagnostic services",
                                                          "Emergency respite",
                                                          "6-county Capital Region coverage",
                                                          "24/7 crisis availability",
                                                          "Prevention of out-of-home placement",
                                                          "Success planning for families"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "518-426-2600",
                                                          "email": "",
                                                          "website": "www.northernrivers.org",
                                                          "address": "Schenectady, NY"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7128,
                                      "lng": -74.006
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "hillside_childrens_center_parent",
                            "name": "Hillside Children's Center",
                            "location": "New York",
                            "type": "Residential & Therapeutic Education Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Hillside Children's Center operates trauma-informed residential treatment facilities and therapeutic schools across New York, emphasizing individualized care, family partnership, and evidence-based programming for complex youth.",
                            "tags": [
                                      "Residential Treatment",
                                      "New York",
                                      "Family Partnership",
                                      "Therapeutic Education"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "hillside_monroe_campus_rtf",
                                                "parentId": "hillside_childrens_center_parent",
                                                "name": "Monroe Campus RTF",
                                                "location": "Rochester, NY",
                                                "type": "CARE Model RTF",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment facility",
                                                "features": [
                                                          "Children and Residential Experience (CARE) model",
                                                          "DBT and Trauma-Focused CBT",
                                                          "Therapeutic Crisis Intervention",
                                                          "Attachment-informed approaches",
                                                          "High family engagement from admission",
                                                          "6-9 month anticipated treatment duration",
                                                          "Serves 33 counties Central/Western NY",
                                                          "24-hour health care services",
                                                          "NYS Education approved campus schools",
                                                          "Relationship-based treatment approach"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "585-256-7500",
                                                          "email": "",
                                                          "website": "www.hillside.com",
                                                          "address": "1183 Monroe Avenue, Rochester, NY 14620"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 43.1566,
                                                          "lng": -77.6088
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "hillside_golisano_crestwood",
                                                "parentId": "hillside_childrens_center_parent",
                                                "name": "Golisano Campus at Crestwood",
                                                "location": "Rochester, NY",
                                                "type": "Young Children's RTF",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential and day treatment",
                                                "features": [
                                                          "Serves youngest children in residential care",
                                                          "$7 million modernization project underway",
                                                          "Home-like setting not institutional",
                                                          "Day Treatment Therapeutic Education K-8",
                                                          "Trauma-informed integrated services",
                                                          "Enhanced green spaces and technology",
                                                          "Autism spectrum educational services",
                                                          "34-bed total campus capacity",
                                                          "Mental health and education under one roof",
                                                          "Recently renamed Golisano Campus"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "585-429-2700",
                                                          "email": "",
                                                          "website": "www.hillside.com",
                                                          "address": "2075 Scottsville Road, Rochester, NY 14623"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 43.1566,
                                                          "lng": -77.6088
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "hillside_emerson_rtf",
                                                "parentId": "hillside_childrens_center_parent",
                                                "name": "Emerson RTF (Juvenile Justice)",
                                                "location": "Rochester, NY",
                                                "type": "Juvenile Justice RTF",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "Exclusively court-involved youth",
                                                          "OCFS DJJOY referrals only",
                                                          "8-bed intensive individualized treatment",
                                                          "DBT and TF-CBT interventions",
                                                          "Hillside campus school access",
                                                          "Community reintegration focus",
                                                          "Evidence-based treatment models",
                                                          "Juvenile justice specialized programming",
                                                          "Rochester campus network location"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "585-256-7500",
                                                          "email": "",
                                                          "website": "www.hillside.com",
                                                          "address": "Rochester, NY"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 43.1566,
                                                          "lng": -77.6088
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "hillside_finger_lakes_rtf",
                                                "parentId": "hillside_childrens_center_parent",
                                                "name": "Finger Lakes RTF",
                                                "location": "Auburn, NY",
                                                "type": "RTF with Intensive Treatment Unit",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment with ITU",
                                                "features": [
                                                          "12-bed Intensive Treatment Unit",
                                                          "Enhanced ITU staffing and supports",
                                                          "38-bed standard RTF capacity",
                                                          "Total 58-bed Finger Lakes Campus",
                                                          "Central New York service region",
                                                          "On-campus therapeutic education",
                                                          "Trauma-informed care approach",
                                                          "Strong family involvement focus",
                                                          "Higher support than standard RTF",
                                                          "Safety and therapeutic milieu emphasis"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "585-256-7500",
                                                          "email": "",
                                                          "website": "www.hillside.com",
                                                          "address": "7432 County House Road, Auburn, NY 13021"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7128,
                                      "lng": -74.006
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "brattleboro_retreat_parent",
                            "name": "Brattleboro Retreat",
                            "location": "Vermont",
                            "type": "Psychiatric and Substance Use Treatment System",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Founded in 1834, the Brattleboro Retreat provides inpatient, residential, and specialty programming for adolescents with acute psychiatric and substance use disorders across its Vermont campus.",
                            "tags": [
                                      "Inpatient Psychiatry",
                                      "Residential",
                                      "Vermont",
                                      "Substance Use"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "brattleboro_retreat",
                                                "parentId": "brattleboro_retreat_parent",
                                                "name": "Brattleboro Retreat",
                                                "location": "Brattleboro, VT",
                                                "type": "Comprehensive Psychiatric",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Full continuum",
                                                "features": [
                                                          "Uniformed service members program",
                                                          "First responders program",
                                                          "Children and adolescent units",
                                                          "Trauma-focused treatment",
                                                          "Co-occurring disorders",
                                                          "Specialized assessments"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "802-258-6000",
                                                          "email": "",
                                                          "website": "https://www.brattlebororetreat.org",
                                                          "address": "Brattleboro, VT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.8509,
                                                          "lng": -72.5579
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "brattleboro_retreat_inpatient",
                                                "parentId": "brattleboro_retreat_parent",
                                                "name": "Adolescent Inpatient Program",
                                                "location": "Brattleboro, VT",
                                                "type": "Psychiatric Hospital",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Acute psychiatric hospitalization",
                                                "features": [
                                                          "DBT-based treatment model",
                                                          "5-7 day average stay",
                                                          "Rapid crisis stabilization",
                                                          "Joint Commission Accredited",
                                                          "24/7 admissions 365 days/year",
                                                          "Multidisciplinary team approach",
                                                          "Insurance coverage accepted",
                                                          "Founded in 1834",
                                                          "Strengths-based approach",
                                                          "Comprehensive aftercare planning"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "802-258-3700 or 800-738-7328",
                                                          "email": "",
                                                          "website": "www.brattlebororetreat.org",
                                                          "address": "1 Anna Marsh Lane, Brattleboro, VT 05302"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.8509,
                                                          "lng": -72.5579
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "brattleboro_retreat_linden",
                                                "parentId": "brattleboro_retreat_parent",
                                                "name": "Linden Residential Treatment Center",
                                                "location": "Brattleboro, VT",
                                                "type": "Residential Treatment Center",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "Three home-style cottages",
                                                          "15 residents total capacity",
                                                          "On-campus Meadows Educational Center",
                                                          "PTSD, depression, anxiety treatment",
                                                          "Life skills development",
                                                          "Self-motivation and accountability",
                                                          "Family integration",
                                                          "Multidisciplinary assessments",
                                                          "Full spectrum access to Retreat services",
                                                          "Vermont-approved education"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "802-258-3700 or 800-738-7328",
                                                          "email": "",
                                                          "website": "www.brattlebororetreat.org",
                                                          "address": "1 Anna Marsh Lane, Brattleboro, VT 05302"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.8509,
                                                          "lng": -72.5579
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 44.5588,
                                      "lng": -72.5778
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "four_winds_parent",
                            "name": "Four Winds Hospital",
                            "location": "New York Network",
                            "type": "Private Psychiatric Hospital System",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Four Winds Hospitals operate private psychiatric campuses in Westchester and Saratoga, delivering acute inpatient and partial hospitalization services for children and adolescents with complex mental health needs.",
                            "tags": [
                                      "Inpatient",
                                      "PHP",
                                      "Psychiatric Hospital",
                                      "New York"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "four_winds_westchester",
                                                "parentId": "four_winds_parent",
                                                "name": "Westchester Campus",
                                                "location": "Katonah, NY",
                                                "type": "Private Psychiatric Hospital",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Multiple levels",
                                                "features": [
                                                          "CBT, DBT, mindfulness approaches",
                                                          "Medication management",
                                                          "Residential for children and adolescents",
                                                          "Day treatment programs",
                                                          "IOP for adults",
                                                          "Separate campus spaces by age",
                                                          "Educational support included",
                                                          "24/7 admissions capability",
                                                          "Involuntary admissions accepted",
                                                          "Dual diagnosis treatment"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "800-528-6624",
                                                          "email": "",
                                                          "website": "www.fourwindshospital.com",
                                                          "address": "800 Cross River Road, Katonah, NY 10536"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "four_winds_saratoga",
                                                "parentId": "four_winds_parent",
                                                "name": "Saratoga Campus",
                                                "location": "Saratoga Springs, NY",
                                                "type": "Private Psychiatric Hospital",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Inpatient and residential",
                                                "features": [
                                                          "Leading Northeast behavioral health provider",
                                                          "Children ages 5+ through adults",
                                                          "Racial equity and cultural competence",
                                                          "Therapeutic Saratoga Springs setting",
                                                          "Comfortable cottages and grounds",
                                                          "Acute care and stabilization",
                                                          "24/7 admissions capability",
                                                          "Most major insurance plans",
                                                          "Financial assistance options",
                                                          "Various psychiatric disorders"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "800-959-1287",
                                                          "email": "",
                                                          "website": "www.fourwindshospital.com",
                                                          "address": "30 Crescent Avenue, Saratoga Springs, NY 12866"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "four_winds_katonah",
                                                "parentId": "four_winds_parent",
                                                "name": "Westchester Campus (Serving CT)",
                                                "location": "Katonah, NY",
                                                "type": "Private Psychiatric Hospital",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Multiple levels",
                                                "features": [
                                                          "CBT, DBT, mindfulness approaches",
                                                          "Separate campus spaces by age group",
                                                          "Educational support incorporated",
                                                          "Family visits and Zoom options",
                                                          "24/7 admissions including involuntary",
                                                          "Psychiatric/substance dual diagnosis",
                                                          "Serves Connecticut families",
                                                          "Joint Commission accredited",
                                                          "State of New York certified",
                                                          "Insurance coverage accepted"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "800-528-6624",
                                                          "email": "",
                                                          "website": "www.fourwindshospital.com",
                                                          "address": "800 Cross River Road, Katonah, NY 10536"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7128,
                                      "lng": -74.006
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "charlie_health_parent",
                            "name": "Charlie Health",
                            "location": "National (Virtual)",
                            "type": "Virtual Intensive Outpatient Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Charlie Health provides high-acuity virtual intensive outpatient programming for teens and young adults nationwide, combining group, individual, and family therapy tracks tailored to specific populations.",
                            "tags": [
                                      "Virtual IOP",
                                      "High Acuity",
                                      "Family Therapy",
                                      "Specialized Tracks"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "charlie_health",
                                                "parentId": "charlie_health_parent",
                                                "name": "Charlie Health",
                                                "location": "Virtual/Nationwide",
                                                "type": "Virtual IOP Program",
                                                "category": "virtual",
                                                "programCategory": "Virtual / Outpatient Programs",
                                                "levelOfCare": "Virtual IOP - 9-11 hours per week via secure video",
                                                "features": [
                                                          "Group Therapy (3 hours, 3x/week)",
                                                          "Individual Therapy (weekly)",
                                                          "Family Therapy (1-2 hours/week)",
                                                          "Psychiatric Services",
                                                          "Evening sessions available"
                                                ],
                                                "contact": {
                                                          "contactPerson": "Gabriella H.",
                                                          "phone": "561-203-5396",
                                                          "email": "",
                                                          "website": "",
                                                          "address": "Virtual Platform"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 39.8283,
                                                          "lng": -98.5795
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "charlie_health_vt",
                                                "parentId": "charlie_health_parent",
                                                "name": "Virtual Intensive Outpatient",
                                                "location": "VT",
                                                "type": "Virtual IOP",
                                                "category": "virtual",
                                                "programCategory": "Virtual / Outpatient Programs",
                                                "levelOfCare": "Intensive outpatient",
                                                "features": [
                                                          "9-11 hours weekly treatment",
                                                          "Three group sessions weekly",
                                                          "Individual and family therapy",
                                                          "LGBTQ+ affirming care",
                                                          "BIPOC-focused groups",
                                                          "Neurodivergent supports",
                                                          "Trauma survivor tracks",
                                                          "Substance use treatment",
                                                          "Can start in 24 hours",
                                                          "Evening and weekend groups"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "866-903-3787",
                                                          "email": "",
                                                          "website": "www.charliehealth.com",
                                                          "address": "VT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 39.8283,
                                                          "lng": -98.5795
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 39.8283,
                                      "lng": -98.5795
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "turnbridge_parent",
                            "name": "Turnbridge",
                            "location": "Connecticut & National",
                            "type": "Phased Continuum Residential & Transitional Care",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Turnbridge delivers phased residential, extended care, and outpatient services for young adults recovering from substance use and co-occurring disorders, integrating life skills, academics, and clinical support.",
                            "tags": [
                                      "Young Adult",
                                      "Residential",
                                      "Transitional Living",
                                      "Substance Use"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "turnbridge",
                                                "parentId": "turnbridge_parent",
                                                "name": "Turnbridge",
                                                "location": "New Haven, CT",
                                                "type": "Extended Care",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "3-Phase residential program",
                                                "features": [],
                                                "contact": {
                                                          "contactPerson": "Beth Legacki",
                                                          "phone": "512-921-3533",
                                                          "email": "",
                                                          "website": "www.turnbridge.com",
                                                          "address": "189 Orange Street, New Haven, CT 06510"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.3083,
                                                          "lng": -72.9279
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 42,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "turnbridge_ct",
                                                "parentId": "turnbridge_parent",
                                                "name": "Connecticut",
                                                "location": "CT",
                                                "type": "Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "Three-phase program with increasing independence",
                                                          "Therapeutic community model",
                                                          "Work and volunteer opportunities",
                                                          "Daily 12-step meetings",
                                                          "Yoga, art, music sessions",
                                                          "Dual diagnosis expertise since 2003",
                                                          "Extended duration available (3+ months)",
                                                          "Non-hospital residential setting",
                                                          "Sober network building focus",
                                                          "Nature hikes and sober sports"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "877-581-1793",
                                                          "email": "",
                                                          "website": "www.turnbridge.com",
                                                          "address": "CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 41.6032,
                                      "lng": -73.0877
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "crossroads_academy_parent",
                            "name": "Crossroads Academy & Recovery",
                            "location": "Utah",
                            "type": "Therapeutic Boarding & Recovery School",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Crossroads blends therapeutic boarding, substance use recovery, and academic programming for adolescent boys needing structured care and long-term support in Utah.",
                            "tags": [
                                      "Therapeutic Boarding School",
                                      "Substance Use",
                                      "Utah",
                                      "Adventure Therapy"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "crossroads_academy",
                                                "parentId": "crossroads_academy_parent",
                                                "name": "Crossroads Academy",
                                                "location": "Ogden, UT",
                                                "type": "Recovery-Focused RTC",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment with recovery focus",
                                                "features": [
                                                          "Relationship-based model",
                                                          "Small caseloads (1 hour individual therapy/week)",
                                                          "Outdoor therapy sessions",
                                                          "Weekly family therapy",
                                                          "3 hours/week chemical dependency work",
                                                          "Accelerated academics for credit recovery"
                                                ],
                                                "contact": {
                                                          "contactPerson": "Sam Dahlin - Co-Owner & Admissions Director",
                                                          "phone": "801-369-0238",
                                                          "email": "",
                                                          "website": "www.crossroadsrtc.com",
                                                          "address": "195 25th Street, Suite 300, Ogden, UT 84401"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7608,
                                                          "lng": -111.891
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "crossroads_academy_ogden",
                                                "parentId": "crossroads_academy_parent",
                                                "name": "Crossroads Academy ‚Äì Ogden",
                                                "location": "Ogden, UT",
                                                "type": "Substance-Focused RTC",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "Primary focus on adolescent addiction",
                                                          "Specialized groups for marijuana, alcohol, prescription drugs",
                                                          "Weekly adventure expeditions (skiing, mountain biking, rock climbing)",
                                                          "Identity development beyond substance use",
                                                          "Motivational Interviewing and CBT for substance use",
                                                          "Seeking safety curriculum for trauma and addiction",
                                                          "Strong recovery community with alumni mentors",
                                                          "Peer-led recovery groups",
                                                          "Parallel family recovery track",
                                                          "Family education and support groups"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "801-756-7060",
                                                          "email": "",
                                                          "website": "www.crossroadsrtc.com",
                                                          "address": "Ogden, UT 84404"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7608,
                                                          "lng": -111.891
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7608,
                                      "lng": -111.891
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "phoenix_house_parent",
                            "name": "Phoenix House",
                            "location": "California & New York",
                            "type": "Nonprofit Addiction Treatment Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Phoenix House operates residential and outpatient programs providing evidence-based addiction treatment for adolescents with co-occurring mental health needs.",
                            "tags": [
                                      "Addiction Treatment",
                                      "Residential",
                                      "Outpatient",
                                      "Nonprofit"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "phoenix_house",
                                                "parentId": "phoenix_house_parent",
                                                "name": "Phoenix House",
                                                "location": "CA",
                                                "type": "National Nonprofit Provider",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential to outpatient",
                                                "features": [
                                                          "Adolescent academies",
                                                          "Therapeutic communities",
                                                          "Specialty courts programs",
                                                          "LGBTQ+ affirming care",
                                                          "Medication-assisted treatment"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "888-671-9392",
                                                          "email": "",
                                                          "website": "https://www.phoenixhouse.org",
                                                          "address": "CA"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 36.7783,
                                                          "lng": -119.4179
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "phoenix_house_lic",
                                                "parentId": "phoenix_house_parent",
                                                "name": "Long Island City Residential",
                                                "location": "Long Island City, NY",
                                                "type": "Adult Residential & Outpatient",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential and outpatient",
                                                "features": [
                                                          "#1 ranked treatment center in New York",
                                                          "Gender-specific evidence-based programming",
                                                          "Motivational interviewing and MAT",
                                                          "Trauma-informed approaches",
                                                          "CBT and DBT therapeutic modalities",
                                                          "Educational and vocational training",
                                                          "Life skills programming",
                                                          "Anger management and emotional awareness",
                                                          "Relapse prevention programming",
                                                          "Job placement assistance"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "888-671-9392",
                                                          "email": "",
                                                          "website": "www.phoenixhouse.org",
                                                          "address": "Vernon Boulevard, Long Island City, NY 11101"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7891,
                                                          "lng": -73.135
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 36.7783,
                                      "lng": -119.4179
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "newport_academy_parent",
                            "name": "Newport Academy",
                            "location": "National Network",
                            "type": "Integrated Residential, PHP & Outpatient Care",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Newport Academy offers gender-responsive residential treatment, partial hospitalization, and outpatient programs for teens with mental health, trauma, and substance use disorders across the United States.",
                            "tags": [
                                      "Residential",
                                      "PHP",
                                      "IOP",
                                      "Family Therapy"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "newport_academy_residential_ca",
                                                "parentId": "newport_academy_parent",
                                                "name": "Newport Academy - California Residential",
                                                "location": "San Rafael, CA",
                                                "type": "Residential Treatment Center",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "Attachment-based treatment model",
                                                          "Trauma-informed care",
                                                          "EMDR therapy",
                                                          "Adventure therapy programming",
                                                          "Fully accredited school",
                                                          "In-network with major insurers",
                                                          "Weekly family therapy",
                                                          "Parent education groups",
                                                          "Experiential therapies"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "415-459-5575",
                                                          "email": "",
                                                          "website": "www.newportacademy.com",
                                                          "address": "San Rafael, CA 94903"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 36.7783,
                                                          "lng": -119.4179
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "newport_academy_bethlehem",
                                                "parentId": "newport_academy_parent",
                                                "name": "Connecticut (Bethlehem Campus)",
                                                "location": "Bethlehem, CT",
                                                "type": "Boys-Only Residential",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment",
                                                "features": [
                                                          "120-acre nature preserve with rolling hills and streams",
                                                          "Boys-only residential with gender-specific programming",
                                                          "Unique eating disorder track for male body image issues",
                                                          "On-site equine therapy with certified therapists",
                                                          "Adventure therapy utilizing campus trails",
                                                          "Evidence-based modalities: CBT, DBT, ACT, EFT, EMDR",
                                                          "Attachment-Based Family Therapy model",
                                                          "Convenient location from NYC and CT airports",
                                                          "Weekly family therapy and parent support groups",
                                                          "Accepts most major commercial insurance plans"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "877-929-5105",
                                                          "email": "",
                                                          "website": "www.newportacademy.com",
                                                          "address": "Bethlehem, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "newport_academy_darien",
                                                "parentId": "newport_academy_parent",
                                                "name": "Newport Academy Outpatient ‚Äì Darien",
                                                "location": "Darien, CT",
                                                "type": "PHP/IOP",
                                                "category": "outpatient",
                                                "programCategory": "PHP/IOP Programs",
                                                "levelOfCare": "PHP/IOP/Outpatient",
                                                "features": [
                                                          "Walking distance from Darien Metro-North station",
                                                          "Serves affluent communities with high academic pressure",
                                                          "PHP includes full school day with certified teachers",
                                                          "Quaint downtown location with walkable resources",
                                                          "Easy access for working parents via train",
                                                          "Evening IOP for local students",
                                                          "Accepts most commercial insurance plans",
                                                          "Evidence-based modalities: CBT, DBT, ACT",
                                                          "Family therapy and parent support groups",
                                                          "Experiential activities in local area"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "877-929-5105",
                                                          "email": "",
                                                          "website": "www.newportacademy.com",
                                                          "address": "Downtown Darien (near train station)"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.6032,
                                                          "lng": -73.0877
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "newport_academy_stamford",
                                                "parentId": "newport_academy_parent",
                                                "name": "Newport Academy Outpatient ‚Äì Stamford",
                                                "location": "Stamford, CT",
                                                "type": "PHP/IOP",
                                                "category": "outpatient",
                                                "programCategory": "PHP/IOP Programs",
                                                "levelOfCare": "PHP/IOP",
                                                "features": [
                                                          "Extended age range serving teens and young adults to 35",
                                                          "Urban Stamford downtown location",
                                                          "Comprehensive PHP with academic support",
                                                          "Separate young adult track (18-35)",
                                                          "Evening IOP accommodates school/work",
                                                          "Transportation hub for Fairfield County",
                                                          "Stamford parks and waterfront activities",
                                                          "Insurance accepted",
                                                          "Eating disorder treatment specialty",
                                                          "Substance use disorder programming"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "877-929-5105",
                                                          "email": "",
                                                          "website": "www.newportacademy.com",
                                                          "address": "Stamford, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.0534,
                                                          "lng": -73.5387
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "justice_resource_institute_parent",
                            "name": "Justice Resource Institute",
                            "location": "Massachusetts Network",
                            "type": "Specialized Behavioral Health Provider",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Justice Resource Institute (JRI) operates highly specialized residential and community programs across Massachusetts addressing complex trauma, sexual behavior treatment, and behavioral stabilization for youth.",
                            "tags": [
                                      "Trauma-Informed",
                                      "Residential",
                                      "Massachusetts",
                                      "Specialty Treatment"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "jri_centerpoint",
                                                "parentId": "justice_resource_institute_parent",
                                                "name": "Centerpoint",
                                                "location": "Tewksbury, MA",
                                                "type": "Male-Only Intensive Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Staff-secure IRTP",
                                                "features": [
                                                          "Joint Commission accredited and MA DMH licensed",
                                                          "Staff-secure setting for acute psychiatric symptoms",
                                                          "Serves males with major psychiatric disorders",
                                                          "Individual, group, and family therapy",
                                                          "Psychopharmacology and medication management",
                                                          "On-site school by Collaborative Educational Services",
                                                          "Massachusetts DESE framework curriculum",
                                                          "Development of mature adaptive behaviors",
                                                          "Closed admissions - DMH referral required",
                                                          "Out-of-state agency referrals accepted"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.jri.org/services/acute-care-and-juvenile-justice/irtp/centerpoint",
                                                          "address": "Tewksbury, MA"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.4072,
                                                          "lng": -71.3824
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "jri_merrimack_center",
                                                "parentId": "justice_resource_institute_parent",
                                                "name": "Merrimack Center",
                                                "location": "Tewksbury, MA",
                                                "type": "Co-Ed Trauma-Focused IRTP",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Locked residential IRTP",
                                                "features": [
                                                          "Joint Commission accredited",
                                                          "Evidence-based trauma-informed treatment",
                                                          "Accepts mild intellectual disabilities",
                                                          "Excludes moderate to severe ID",
                                                          "DBT-based psychoeducation groups",
                                                          "Individual and family therapy",
                                                          "Psychiatric management services",
                                                          "On-site accredited school with IEPs",
                                                          "1-2 week average length of stay",
                                                          "Daily campus and community activities"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.jri.org/services/acute-care-and-juvenile-justice/irtp",
                                                          "address": "Tewksbury, MA"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 42.4072,
                                                          "lng": -71.3824
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 42.4072,
                                      "lng": -71.3824
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "child_center_ny_parent",
                            "name": "The Child Center of NY",
                            "location": "New York City",
                            "type": "Community-Based Behavioral Health Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "The Child Center of NY delivers residential treatment, outpatient, and school-based services that support youth in the five boroughs with mental health, academic, and social-emotional needs.",
                            "tags": [
                                      "New York City",
                                      "Residential",
                                      "Outpatient",
                                      "Community Programs"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "child_center_ny_rtf",
                                                "parentId": "child_center_ny_parent",
                                                "name": "Residential Treatment Facility",
                                                "location": "Brooklyn, NY",
                                                "type": "Co-Ed Residential Treatment",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment facility",
                                                "features": [
                                                          "Only downstate dual OMH/OCFS facility",
                                                          "44-bed structured 24/7 care",
                                                          "Clinical coordinators and psychiatric providers",
                                                          "On-site pediatrician and 24-hour nursing",
                                                          "P368K Star Academy through District 75",
                                                          "Certified teachers with principal and vice principal",
                                                          "Creative and therapeutic arts programming",
                                                          "Holistic cognitive, social-emotional, physical care",
                                                          "Extensive family involvement and strengthening",
                                                          "CARF Three-Year Accreditation"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "718-483-9871",
                                                          "email": "",
                                                          "website": "www.childcenterny.org",
                                                          "address": "2050 Dean Street, Brooklyn, NY 11233"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.6782,
                                                          "lng": -73.9442
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "child_center_ny_youth_iop",
                                                "parentId": "child_center_ny_parent",
                                                "name": "Youth Intensive Outpatient Program",
                                                "location": "Forest Hills, NY",
                                                "type": "Alternatives to Residential Treatment",
                                                "category": "outpatient",
                                                "programCategory": "PHP/IOP Programs",
                                                "levelOfCare": "Intensive outpatient",
                                                "features": [
                                                          "ART program preventing residential placement",
                                                          "2-3 days per week after-school hours",
                                                          "8-week intensive support model",
                                                          "Yoga, nutrition, art therapy activities",
                                                          "Creative movement and mindfulness",
                                                          "4Rs and 2Ss parent training model",
                                                          "McSilver Institute/NYU developed program",
                                                          "Prevents psychiatric hospitalization",
                                                          "Strengths-based approach",
                                                          "Medicaid and third-party insurance"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "718-651-7770",
                                                          "email": "",
                                                          "website": "www.childcenterny.org",
                                                          "address": "118-35 Queens Boulevard, Forest Hills, NY 11375"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7128,
                                      "lng": -74.006
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "newyork_presbyterian_parent",
                            "name": "NewYork-Presbyterian Adolescent Programs",
                            "location": "New York",
                            "type": "Academic Medical Center PHP Network",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "NewYork-Presbyterian, in partnership with Columbia and Weill Cornell, operates adolescent partial hospitalization programs providing evidence-based care for severe mood, anxiety, and school avoidance disorders.",
                            "tags": [
                                      "Partial Hospitalization",
                                      "Academic Medical Center",
                                      "CBT/DBT",
                                      "School Re-entry"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "nyp_adolescent_php_manhattan",
                                                "parentId": "newyork_presbyterian_parent",
                                                "name": "NewYork-Presbyterian ‚Äì Adolescent Partial Hospitalization Program",
                                                "location": "New York, NY",
                                                "type": "Partial Hospitalization Program",
                                                "category": "outpatient",
                                                "programCategory": "PHP/IOP Programs",
                                                "levelOfCare": "Partial hospitalization",
                                                "features": [
                                                          "Weill Cornell Medicine faculty staffing",
                                                          "On-site Hospital Schools Program education",
                                                          "Specialized severe anxiety treatment",
                                                          "Comprehensive assessment and planning",
                                                          "Individual and group/family counseling",
                                                          "Medication management available",
                                                          "Skills training and behavior modification",
                                                          "Step-down from inpatient care",
                                                          "Personalized aftercare planning",
                                                          "ACCESS service for admissions"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "212-746-5700",
                                                          "email": "",
                                                          "website": "www.nyp.org",
                                                          "address": "Payne Whitney Clinic, 525 East 68th Street, New York, NY 10065"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "nyp_php_westchester",
                                                "parentId": "newyork_presbyterian_parent",
                                                "name": "NewYork-Presbyterian ‚Äì Adolescent PHP (Westchester)",
                                                "location": "White Plains, NY",
                                                "type": "Partial Hospitalization",
                                                "category": "outpatient",
                                                "programCategory": "PHP/IOP Programs",
                                                "levelOfCare": "Partial hospitalization",
                                                "features": [
                                                          "LearnWell educational services",
                                                          "DBT skills training",
                                                          "Cognitive behavioral therapy",
                                                          "Family collaboration",
                                                          "Self-harm ideation focus",
                                                          "School avoidance treatment",
                                                          "Step-down from inpatient",
                                                          "Alternative to hospitalization",
                                                          "Weill Cornell Medicine faculty",
                                                          "Most insurance and Medicaid accepted"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "914-997-5779",
                                                          "email": "",
                                                          "website": "www.nyp.org",
                                                          "address": "White Plains, NY"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.034,
                                                          "lng": -73.7629
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7128,
                                      "lng": -74.006
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "astor_services_parent",
                            "name": "Astor Services for Children & Families",
                            "location": "Hudson Valley, NY",
                            "type": "Community Behavioral Health Provider",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Astor Services delivers partial hospitalization, day treatment, and community programs for children and adolescents in New York's Hudson Valley focused on emotional and behavioral health needs.",
                            "tags": [
                                      "PHP",
                                      "Day Treatment",
                                      "Hudson Valley",
                                      "Community Mental Health"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "astor_services_php",
                                                "parentId": "astor_services_parent",
                                                "name": "Astor Services ‚Äì Hudson Valley Adolescent PHP",
                                                "location": "Poughkeepsie, NY",
                                                "type": "DBT-Based PHP",
                                                "category": "outpatient",
                                                "programCategory": "PHP/IOP Programs",
                                                "levelOfCare": "Partial hospitalization",
                                                "features": [
                                                          "Primary DBT model",
                                                          "Prevents inpatient hospitalization",
                                                          "Monday-Friday 8:30am-3:30pm",
                                                          "3 groups daily",
                                                          "24/7 DBT coaching support",
                                                          "LearnWell educational support",
                                                          "Individual and family therapy",
                                                          "At-risk of out-of-home placement",
                                                          "Medicaid and most insurance",
                                                          "Sliding-scale fees available"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "845-554-1365",
                                                          "email": "",
                                                          "website": "www.astorservices.org",
                                                          "address": "205 South Avenue, Suite 105"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.7004,
                                                          "lng": -73.9209
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "astor_day_treatment",
                                                "parentId": "astor_services_parent",
                                                "name": "Astor Services ‚Äì Adolescent Day Treatment Program",
                                                "location": "NY",
                                                "type": "School-Based Day Treatment",
                                                "category": "therapeutic-school",
                                                "programCategory": "Therapeutic Schools",
                                                "levelOfCare": "Day treatment",
                                                "features": [
                                                          "Astor/BOCES partnership model",
                                                          "Full school day program",
                                                          "BOCES calendar schedule",
                                                          "DBT for emotional regulation",
                                                          "Academic and crisis intervention",
                                                          "Serious emotional disturbances",
                                                          "Multiple Alternative Education sites",
                                                          "Intervention services for families",
                                                          "Integrated treatment/education"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "845-452-7000",
                                                          "email": "",
                                                          "website": "www.astorservices.org",
                                                          "address": "NY"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.7004,
                                                          "lng": -73.9209
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 41.7004,
                                      "lng": -73.9209
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "olv_human_services_parent",
                            "name": "OLV Human Services",
                            "location": "Western New York",
                            "type": "Integrated Residential & Community Services",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "OLV Human Services operates residential treatment, education, and outpatient programs in Western New York supporting youth with developmental, behavioral, and mental health needs.",
                            "tags": [
                                      "Residential",
                                      "Therapeutic School",
                                      "Western New York",
                                      "Community Services"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "olv_human_services_rtf",
                                                "parentId": "olv_human_services_parent",
                                                "name": "Residential Treatment Facility",
                                                "location": "Lackawanna, NY",
                                                "type": "Dual Diagnosis RTF",
                                                "category": "residential",
                                                "programCategory": "Residential Treatment Centers",
                                                "levelOfCare": "Residential treatment facility",
                                                "features": [
                                                          "20-bed standard RTF for emotional disturbances",
                                                          "12-bed ITP for dual diagnosis ID/DD and mental health",
                                                          "Multidisciplinary team including psychiatrists",
                                                          "Moore for Kids Family House for visiting families",
                                                          "Person-centered tailored treatment plans",
                                                          "Integrated educational and vocational programs",
                                                          "Discharge planning and transition services",
                                                          "NYS Office of Mental Health certified",
                                                          "Around-the-clock specialized care",
                                                          "Community reintegration focus"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "716-828-9500",
                                                          "email": "",
                                                          "website": "www.olvhs.org",
                                                          "address": "150 Martin Road, Lackawanna, NY 14218"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "olv_outpatient_clinics",
                                                "parentId": "olv_human_services_parent",
                                                "name": "Outpatient Clinics",
                                                "location": "Lackawanna, NY",
                                                "type": "Multi-Site Outpatient Network",
                                                "category": "outpatient",
                                                "programCategory": "Virtual / Outpatient Programs",
                                                "levelOfCare": "Outpatient",
                                                "features": [
                                                          "Parent-Child Interaction Therapy (PCIT)",
                                                          "Four Western NY locations",
                                                          "School-based mental health clinics",
                                                          "Individual and family counseling",
                                                          "Psychiatric medication services",
                                                          "School-related issue assistance",
                                                          "Crisis support and referrals",
                                                          "Medicaid and major insurance",
                                                          "Children, adolescents, and adults",
                                                          "Community service linkage"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "716-828-9500",
                                                          "email": "",
                                                          "website": "www.olvhs.org",
                                                          "address": "790 Ridge Road, Lackawanna, NY 14218"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 40.7128,
                                                          "lng": -74.006
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7128,
                                      "lng": -74.006
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "wheeler_health_parent",
                            "name": "Wheeler Health Youth Services",
                            "location": "Connecticut",
                            "type": "Behavioral Health & Substance Use Provider",
                            "category": "parent",
                            "isParent": true,
                            "expanded": false,
                            "overview": "Wheeler Health delivers adolescent substance use and behavioral health services through regional outpatient and intensive outpatient programs in Connecticut.",
                            "tags": [
                                      "Substance Use",
                                      "IOP",
                                      "Connecticut",
                                      "Community Provider"
                            ],
                            "subPrograms": [
                                      {
                                                "id": "wheeler_substance_hartford",
                                                "parentId": "wheeler_health_parent",
                                                "name": "Wheeler Health Substance Abuse ‚Äì Hartford Region",
                                                "location": "Hartford, CT",
                                                "type": "Outpatient/In-Home",
                                                "category": "outpatient",
                                                "programCategory": "Virtual / Outpatient Programs",
                                                "levelOfCare": "Outpatient/In-home",
                                                "features": [
                                                          "State capital extensive service resources",
                                                          "Multisystemic therapy (MST) in family homes",
                                                          "Urban youth challenges experience",
                                                          "Bilingual Spanish-speaking staff",
                                                          "Strong Hartford school partnerships",
                                                          "Gang intervention experience",
                                                          "Medicaid and commercial insurance",
                                                          "Evidence-based DBT, CBT, MI approaches",
                                                          "Family engagement for resistant families",
                                                          "Early intervention focus"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.wheelerclinic.org",
                                                          "address": "Hartford, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.7658,
                                                          "lng": -72.6734
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      },
                                      {
                                                "id": "wheeler_substance_waterbury",
                                                "parentId": "wheeler_health_parent",
                                                "name": "Wheeler Health Substance Abuse ‚Äì Waterbury Region",
                                                "location": "Waterbury, CT",
                                                "type": "Outpatient/In-Home",
                                                "category": "outpatient",
                                                "programCategory": "Virtual / Outpatient Programs",
                                                "levelOfCare": "Outpatient/In-home",
                                                "features": [
                                                          "Central Connecticut coverage",
                                                          "Post-industrial community challenges understanding",
                                                          "Specialized program for resistant families",
                                                          "Multicultural community experience",
                                                          "Waterbury Hospital partnerships",
                                                          "School-based service programs",
                                                          "Opioid crisis specialized programming",
                                                          "MST evidence-based approach",
                                                          "Insurance coverage options",
                                                          "Prevention and early intervention"
                                                ],
                                                "contact": {
                                                          "contactPerson": "",
                                                          "phone": "",
                                                          "email": "",
                                                          "website": "www.wheelerclinic.org",
                                                          "address": "Waterbury, CT"
                                                },
                                                "insurance": [
                                                          "Information pending"
                                                ],
                                                "costRange": "Contact for pricing",
                                                "genderServed": "Co-ed",
                                                "ageRange": {
                                                          "min": 0,
                                                          "max": 99
                                                },
                                                "coordinates": {
                                                          "lat": 41.5582,
                                                          "lng": -73.0515
                                                },
                                                "lastUpdated": "2025-11-03T01:34:48.237Z",
                                                "dataCompleteness": 50,
                                                "verificationStatus": "unverified",
                                                "lastVerified": null,
                                                "dataSource": "manual",
                                                "specialties": [],
                                                "waitlistEstimate": null,
                                                "lastMigrated": "2025-11-03T01:34:48.260Z"
                                      }
                            ],
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 41.6032,
                                      "lng": -73.0877
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 33,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.260Z"
                  },
                  {
                            "id": "program_2",
                            "name": "The Last House",
                            "location": "Los Angeles, CA",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Sober living program for young adult men (18+) located in West Los Angeles. Offers a structured, fun, and community-driven environment for individuals transitioning out of treatment and into long-term recovery.",
                            "features": [
                                      "Community-Oriented Housing: Residents live in structured homes with support from peers and staff.",
                                      "Certified Staff: Team includes professionals with backgrounds in counseling, employment services, and wellness.",
                                      "Life in LA Recovery Community: Access to over 3,000 recovery meetings weekly and one of the strongest sober communities in the country.",
                                      "Fun in Sobriety Philosophy: Weekly and quarterly sober activities including group outings, surfing, golf, snowboarding, and more.",
                                      "Accountability: House meetings, curfews, and community support help residents stay on track with recovery."
                            ],
                            "contact": {
                                      "phone": "866.677.0090",
                                      "address": "3101 Ocean Park Blvd #302, Santa Monica, CA 90405",
                                      "website": "https://thelasthouse.net"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 34.0522,
                                      "lng": -118.2437
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_3",
                            "name": "Patton Sober Living Homes",
                            "location": "Dallas, TX",
                            "type": "Sober Living",
                            "category": "sober-living",
                            "programCategory": "Sober Living / Transitional Programs",
                            "levelOfCare": "Structured sober living program for young adult men in Dallas, Texas, offering accountability, life skills development, and peer support during the early stages of recovery. Emphasizes holistic healing of mind, body, and spirit, with a focus on employment, education, and 12-Step community involvement.",
                            "features": [
                                      "Random Drug Testing: Residents are drug tested randomly at least once weekly and breathalyzed daily. Testing increases if relapse concerns arise.",
                                      "Community & House Meetings: Three structured group meetings per week, led by licensed clinicians and members of the recovery community.",
                                      "Employment Coaching: Residents receive assistance with job placement, resume building, and interview preparation. A minimum of 25 work hours per week is expected unless enrolled in school.",
                                      "Educational Support: Located near Richland College. Founder John Patton personally supports residents in enrolling and succeeding academically.",
                                      "Independent Living Skills: Daily chores, cooking, laundry, and personal care responsibilities foster autonomy and life readiness.",
                                      "12-Step Integration: Active participation in a 12-Step program, including step work, sponsor communication, and attending at least four meetings per week.",
                                      "Family Communication: Biweekly calls from the Program Director and ongoing access to the owner and staff for urgent updates or support."
                            ],
                            "contact": {
                                      "contactPerson": "Austin Shook, Program Director",
                                      "phone": "(469) 974-4639",
                                      "address": "13028 Fall Manor Dr, Dallas, TX 75243",
                                      "website": "https://pattonsoberliving.com/index.html"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_4",
                            "name": "Stonewater Adolescent Recovery Center",
                            "location": "Oxford, MS",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Residential treatment center for adolescent males with substance use and co-occurring mental health disorders. Offers fully supervised detox, dual-diagnosis programming, and individualized care grounded in faith, family restoration, and evidence-based interventions.",
                            "features": [
                                      "Dual-Diagnosis Expertise: Clinical program designed specifically for the evolving needs of adolescents, incorporating psychiatric, psychological, and addiction-specific care.",
                                      "Detox to Residential Continuum: Safe, medically supervised detox followed by structured residential treatment in a campus setting.",
                                      "Family Restoration Focus: Programming emphasizes rebuilding relationships and empowering the family system with healthy tools and communication strategies.",
                                      "Faith-Informed Recovery: For families who desire it, Christian values and faith-based elements are integrated into the healing process.",
                                      "Individualized Treatment Plans: Residents receive customized care designed to uncover strengths, passions, and long-term potential.",
                                      "Founders with Lived Experience: The Fikes family brings personal understanding of adolescent substance use and family crisis to the program‚Äôs design and mission."
                            ],
                            "contact": {
                                      "contactPerson": "Bridget Norris",
                                      "phone": "570) 222-3449",
                                      "address": "21 Weida Ct Nicholson, PA 18446",
                                      "website": "info@serenitylodgerecovery.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_5",
                            "name": "Resilience Recovery Residences",
                            "location": "West Palm Beach, FL",
                            "type": "Sober Living",
                            "category": "sober-living",
                            "programCategory": "Sober Living / Transitional Programs",
                            "levelOfCare": "Structured transitional living program for young adult men ages 16+ who have completed primary treatment and are prepared to reintegrate into society through a phased, milestone-based recovery structure.",
                            "features": [
                                      "Orientation Phase (2‚Äì4 Weeks): Daily chores, wake-up routines, seven 12-step meetings per week, and sponsor acquisition.",
                                      "Level 1 (14‚Äì90 Days): Six 12-step meetings/week, one meeting commitment, 9+ hours of IOP or therapy, and step work initiation.",
                                      "Level 2 (60‚Äì120 Days): Completion of Step 5, increased leadership in community, and continuation of meetings, therapy, and responsibilities.",
                                      "Level 3 (120+ Days): Step 9 completion, leadership role in the house, reduced meeting requirements, full tech privileges and car access."
                            ],
                            "contact": {
                                      "contactPerson": "Christopher Martinez/ Owner",
                                      "phone": "424- 254-4304",
                                      "address": "3011 Poinsettia Ave, West Palm Beach, FL 33407",
                                      "website": "www.resiliencerecoveryresources.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 27.6648,
                                      "lng": -81.5158
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_6",
                            "name": "The Insight Program",
                            "location": "Tampa, FL",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Intensive outpatient substance use treatment program for adolescents (13‚Äì17) and young adults (18‚Äì25) with substance abuse or co-occurring issues. Offers family-focused treatment and long-term aftercare.",
                            "features": [
                                      "Free Evaluations: No-cost substance use evaluations for clients and families.",
                                      "Weekly IOP Sessions: Five treatment sessions per week including individualized planning.",
                                      "12-Step Meetings: Weekly youth-focused 12-step support.",
                                      "Family Integration: Weekly family counseling, support, and educational resources.",
                                      "Two-Year Aftercare: Includes follow-up counseling, group access, and family involvement.",
                                      "School & Community Engagements: Education on youth substance use at local schools and churches."
                            ],
                            "contact": {
                                      "contactPerson": "Adam Schwartz",
                                      "phone": "470-505-9786",
                                      "address": "13944 Lynmar Blvd, Tampa, FL 33626",
                                      "website": "https://theinsightprogram.com/"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 27.9506,
                                      "lng": -82.4572
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_8",
                            "name": "Greater Nashua Mental Health",
                            "location": "Nashua, NH",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Adolescent Intensive Outpatient Program (IOP) for teens with substance use and co-occurring disorders. May accept young adults (18+) depending on clinical assessment.",
                            "features": [
                                      "IOP Structure: Group therapy, individual therapy, family involvement, and case management.",
                                      "Psychiatric Services: Access to in-house or referred psychiatric practitioners.",
                                      "Whole-Person Coordination: Includes collaboration with schools, doctors, and service providers.",
                                      "Recovery Coaching: Helps adolescents connect with long-term recovery resources and aftercare."
                            ],
                            "contact": {
                                      "phone": "603.401.1597",
                                      "address": "15 Prospect Street, Nashua, NH 03060",
                                      "website": "https://gnmhc.org/"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 42.7654,
                                      "lng": -71.4676
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_9",
                            "name": "Directions Behavioral Health",
                            "location": "Nashua, NH",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Outpatient and partial hospitalization program (PHP) serving teens and young adults facing acute mental health or substance use challenges. Flexible structure and daily therapeutic support.",
                            "features": [
                                      "Intensive Outpatient Program (IOP): 3 hours per day of group therapy and psychiatric services.",
                                      "Partial Hospitalization Program (PHP): 5 hours per day of clinical programming, step-down to IOP available.",
                                      "Family Work: Ongoing parent engagement and clinical involvement.",
                                      "Insurance Accepted: Covered by most commercial health plans."
                            ],
                            "contact": {
                                      "phone": "603.880.8188",
                                      "address": "25 Technology Way, Nashua, NH 03060",
                                      "website": "https://www.directionbehavioralhealth.com/"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 42.7654,
                                      "lng": -71.4676
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_10",
                            "name": "In Balance Academy",
                            "location": "Tucson, AZ",
                            "type": "Therapeutic Boarding School",
                            "category": "therapeutic-school",
                            "programCategory": "Therapeutic Schools",
                            "levelOfCare": "Therapeutic boarding school for adolescent males combining recovery, academics, and character development in a supportive, values-driven environment.",
                            "features": [
                                      "Individualized Academics: Accredited education aligned with each student‚Äôs strengths and needs.",
                                      "Family Systems Focus: Therapy and education to rebuild and strengthen family relationships.",
                                      "Service-Oriented Culture: Students engage in acts of service to foster connection and responsibility.",
                                      "Staff Mentorship: Clinicians and mentors help students identify purpose and build confidence.",
                                      "Emphasis on Community: Shared goals and daily rituals promote peer accountability and resilience."
                            ],
                            "contact": {
                                      "contactPerson": "Tiffany ‚Äì Director of Admissions and Clinical Director",
                                      "phone": "801.369.0238",
                                      "email": "ptaylor@livestronghouse.com",
                                      "address": "195 25th Street, Suite 300, Ogden, UT 84401",
                                      "website": "www.crossroadsrtc.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_11",
                            "name": "Live Strong House",
                            "location": "Layton, UT",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Residential treatment program for adolescent and young adult males, offering a relationship-based, highly individualized therapeutic model rooted in adventure, service, and personal growth.",
                            "features": [
                                      "3:1 Household Model: Three students per home with dedicated life coaches for personalized attention and deep mentorship.",
                                      "Daily Life Structure: Flexible weekday and weekend schedules with a balance of academics, therapy, and recreation.",
                                      "Individual Therapy: Multiple sessions per week with therapists who maintain small caseloads.",
                                      "Group Therapy: Topics include trauma, social skills, communication, and emotional resilience.",
                                      "Adventure Therapy: Two recreation days per week featuring activities like hiking, snowboarding, mountain biking, and climbing.",
                                      "Community Leadership: Weekly student-led group meetings to promote accountability and empathy.",
                                      "Monthly Excursions: Wilderness and off-campus trips to challenge students outside their comfort zones.",
                                      "Weekly Service: Built-in humanitarian service opportunities for character development."
                            ],
                            "contact": {
                                      "contactPerson": "Paul Taylor",
                                      "phone": "928.300.5699",
                                      "email": "ptaylor@livestronghouse.com",
                                      "address": "377 N. Marshall Way, Layton, UT 84041",
                                      "website": "www.livestronghouse.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7608,
                                      "lng": -111.891
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_12",
                            "name": "Turning Winds",
                            "location": "Troy, MT",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Residential treatment center and therapeutic boarding school for adolescents ages 13‚Äì18, providing long-term treatment for mental health, behavioral, and substance use disorders.",
                            "features": [
                                      "Small Community: Maximum of 45 students with average stay of 12 months.",
                                      "Comprehensive Diagnosis: Addresses ADHD, depression, anxiety, substance use, eating disorders, ODD, and more.",
                                      "5 Pillars of Change: Character, health, outdoor education, therapeutic success, and academic achievement.",
                                      "Outdoor Adventure Therapy: Wilderness-based experiential education and team-building.",
                                      "Clinical Services: Individual, group, and family therapy tailored to each student‚Äôs diagnostic profile.",
                                      "Accredited Academics: IEP support, academic recovery, and personalized education from certified teachers."
                            ],
                            "contact": {
                                      "contactPerson": "Eric Losche ‚Äì Admission Director",
                                      "phone": "973.650.8636",
                                      "address": "31733 S Fork Yaak Rd, Troy, MT 59935",
                                      "website": "https://www.turningwinds.com/"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_15",
                            "name": "The Grove School",
                            "location": "Madison, CT",
                            "type": "Therapeutic Boarding School",
                            "category": "therapeutic-school",
                            "programCategory": "Therapeutic Schools",
                            "levelOfCare": "Therapeutic boarding and day school for adolescents ages 11‚Äì18, blending clinical support, academic advancement, and residential structure in a holistic, family-run environment.",
                            "features": [
                                      "Individualized Treatment: Comprehensive support for behavioral, academic, emotional, and social challenges.",
                                      "Year-Round Education: 12-month academic schedule with four 2-week breaks.",
                                      "Holistic Model: Clinical therapy, residential life, and extracurriculars reinforce whole-person wellness.",
                                      "Academic Supports: Small classes, individualized learning, special education faculty, and high standards.",
                                      "Long-Term Planning: Prepares students for healthy transition into adulthood and sustained success."
                            ],
                            "contact": {
                                      "phone": "203.245.2778",
                                      "address": "175 Copse Rd, Madison, CT 06443",
                                      "website": "http://www.groveschool.org/"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 41.6032,
                                      "lng": -73.0877
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_24",
                            "name": "Maple Hall Academy",
                            "location": "Lexington, VA",
                            "type": "Therapeutic Boarding School",
                            "category": "therapeutic-school",
                            "programCategory": "Therapeutic Schools",
                            "levelOfCare": "Therapeutic boarding school for students in grades 5‚Äì9 with emotional, social, academic, and behavioral challenges. Located on a scenic, activity-rich campus in Virginia.",
                            "features": [
                                      "Therapeutic Curriculum: Integrates clinical, academic, and social-emotional learning.",
                                      "Expressive Arts Therapy: Ceramics, equine, and creative expression activities.",
                                      "Individualized Academics: Personalized college-prep instruction.",
                                      "Community Involvement: Encourages family and school reintegration."
                            ],
                            "contact": {
                                      "contactPerson": "Chass Armstrong ‚Äì Executive Director",
                                      "phone": "828.747.9294",
                                      "address": "3111 N Lee Hwy, Lexington, VA 24450",
                                      "website": "https://maplehallacademy.com/"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_25",
                            "name": "Black Mountain Academy",
                            "location": "Black Mountain, NC",
                            "type": "Therapeutic Boarding School",
                            "category": "therapeutic-school",
                            "programCategory": "Therapeutic Schools",
                            "levelOfCare": "Therapeutic boarding school for adolescent males (ages 13‚Äì17) with Level 1 autism and co-occurring challenges in academics, executive functioning, and social communication.",
                            "features": [
                                      "Inquiry-Based Academics: Rigorous curriculum adapted for learning differences.",
                                      "Six Core Competencies: Focuses on social skills, wellness, executive functioning, independence, academics, and emotional regulation.",
                                      "Real-World Preparation: Includes financial literacy, hygiene routines, and community skills.",
                                      "Autism-Specific Supports: Integrated emotional regulation and conflict resolution strategies."
                            ],
                            "contact": {
                                      "phone": "828.243.6165",
                                      "address": "PO Box 1236, Black Mountain, NC 28711",
                                      "website": "www.theblackmountainacademy.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_26",
                            "name": "AANE (Association for Autism and Neurodiversity)",
                            "location": "Virtual",
                            "type": "Virtual Program",
                            "category": "virtual",
                            "programCategory": "Virtual / Outpatient Programs",
                            "levelOfCare": "Virtual services for adolescents and families with autism spectrum disorders, including support groups, coaching, and resource connections.",
                            "features": [
                                      "Parent & Family Consultation: Calls with resource specialists.",
                                      "Peer Connections: Virtual social groups and events.",
                                      "Advocacy & Resources: Tools to navigate school and clinical systems."
                            ],
                            "contact": {
                                      "website": "https://aane.org/"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 39.8283,
                                      "lng": -98.5795
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_27",
                            "name": "Bend Health",
                            "location": "Virtual ASD Services",
                            "type": "Virtual Program",
                            "category": "virtual",
                            "programCategory": "Virtual / Outpatient Programs",
                            "levelOfCare": "Fully virtual platform offering behavioral health coaching and therapy for children and adolescents, with specific supports for those with autism spectrum disorder.",
                            "features": [
                                      "Individual Coaching: Ongoing virtual sessions for ASD youth.",
                                      "Parent Coaching: Training and education for caregivers.",
                                      "Online Accessibility: Secure, convenient platform for remote engagement."
                            ],
                            "contact": {
                                      "phone": "828.243.6165",
                                      "address": "PO Box 1236, Black Mountain, NC 28711",
                                      "website": "www.theblackmountainacademy.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 39.8283,
                                      "lng": -98.5795
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_44",
                            "name": "Innercept",
                            "location": "Coeur d‚ÄôAlene, ID (Permanently Closed)",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Previously a long-term residential program for adolescents with complex psychiatric and emotional needs.",
                            "features": [
                                      "This program is no longer operating.",
                                      "Former services included integrated education, family therapy, and goal-based psychiatric care."
                            ],
                            "contact": {
                                      "contactPerson": "CJ - 801-227.2062",
                                      "phone": "678-506-7429",
                                      "email": "info@360coachingservice.com",
                                      "address": "252 Harry Lane Blvd, Suite 202, Knoxville, TN 37923",
                                      "website": "https://www.hside.org"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_45",
                            "name": "Basepoint Academy",
                            "location": "Arlington, Forney, and McKinney, TX",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Teen-only facility dedicated to helping teenagers work through their daily struggles with anxiety, substance abuse, behavior issues, depression, post-traumatic stress disorder, and other life challenges. Located in the heart of Texas with facilities in Arlington, Forney, and McKinney.",
                            "features": [
                                      "Ages: 11-18 for adolescent programs",
                                      "CBT, DBT, and Psychodynamic therapy",
                                      "Family therapy and individual therapy",
                                      "Behavior therapy and play therapy",
                                      "Mindfulness therapy and psychotherapy",
                                      "Group therapy and motivational interviewing",
                                      "Experiential therapy",
                                      "Medication assisted treatment",
                                      "Academic support without sacrificing pursuits",
                                      "Safe and supportive environment"
                            ],
                            "contact": {
                                      "phone": "972-325-2633 x1",
                                      "email": "Pac@basepointacademy.com",
                                      "address": "Arlington TX, Forney TX, and McKinney TX",
                                      "website": "https://basepointacademy.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_46",
                            "name": "Elevations RTC",
                            "location": "Residential Treatment Center (All-Gender, Ages 13‚Äì18)",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Ages Served: 13‚Äì18 Gender: All genders reSTART provides a tech-free, home-like residential setting for adolescents struggling with technology overuse (gaming, screen addiction, digital isolation) and co-occurring emotional or behavioral health challenges. The program is especially helpful for teens who: Are highly withdrawn, avoidant, or digitally dependent Are working through anxiety, low motivation, or executive functioning struggles Need academic flexibility while building structure and resilience Programming includes: Individual, group, and family therapy (CBT, DBT, MI) Academic support with hybrid on-site and virtual options Outdoor recreation, life skills, and team-based living Full reset from digital distractions Ages Served: 12‚Äì17 Gender: All genders Sparks Academy is tailored for bright, neurodiverse teens who benefit from a highly structured, therapeutic academic setting. Many students are navigating ASD Level 1 or 2, ADHD, anxiety, learning differences, or executive functioning delays. Key features include: Small, personalized classrooms with flexible pacing Built-in intensive clinical support from therapists and psychiatrists Social pragmatics groups and coaching for independence Structured daily  routines and a sensory-considerate environment This is a strong match for teens who need emotional safety, predictability, and clinical scaffolding without a behavioral-heavy model. Sparks is often used as a step-down from RTC or a gentler step-up for teens who can still benefit from academic growth.",
                            "features": [
                                      "Weekly family therapy via telehealth",
                                      "Monthly family weekends on campus",
                                      "Parent support groups",
                                      "Structured home visits for reintegration practice"
                            ],
                            "contact": {
                                      "contactPerson": "",
                                      "phone": "(801) 491-7680",
                                      "email": "admissions@springbrookbhs.com",
                                      "address": "5600 Heritage School Dr., Provo, UT 84604",
                                      "website": "spark.heritagertc.org"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_47",
                            "name": "Rogers Behavioral Health",
                            "location": "Adolescent Programs | PHP, IOP, and Residential Services",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Rogers offers specialized Partial Hospitalization (PHP), Intensive Outpatient (IOP), and Residential programs for adolescents ages 12‚Äì17. Tracks are designed to address a range of behavioral health needs, with options for in-person or virtual care depending on location.",
                            "features": [
                                      "OCD & Anxiety Disorders (including ERP)",
                                      "Depression and Mood Disorders",
                                      "Eating Disorders",
                                      "Trauma & PTSD",
                                      "Co-occurring Substance Use"
                            ],
                            "contact": {
                                      "phone": "833‚Äë308‚Äë5887 (central intake for all adolescent programs)",
                                      "website": "www.rogersbh.org"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_48",
                            "name": "The Wediko School",
                            "location": "Residential Treatment & Educational Program for Adolescents",
                            "type": "Therapeutic Boarding School",
                            "category": "therapeutic-school",
                            "programCategory": "Therapeutic Schools",
                            "levelOfCare": "Year-round residential treatment and therapeutic academics for adolescent boys and girls (ages ~11‚Äì19), blending intensive clinical support with special-education curriculum. Campus spans 450 lakefront acres in Windsor, NH  .",
                            "features": [],
                            "contact": {
                                      "phone": "Admissions ‚Äì (603) 478‚Äë5236 (Katie Walsh, Director)",
                                      "website": "thewedikoschool.org"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 42,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_49",
                            "name": "Coral Shores Behavioral Health",
                            "location": "Adolescent Intensive Outpatient Program (Stuart, FL)",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "An age-specific intensive outpatient program (IOP) for adolescents (ages approximately 12‚Äì17) offering structured treatment several days per week to support mental health stabilization, transition from inpatient care, or as an alternative to hospitalization.",
                            "features": [
                                      "Three‚ÄëDay Weekly Schedule: Groups are held Mondays, Tuesdays, and Thursdays from 4:00‚Äì7:00‚ÄØPM, focusing on real‚Äëworld skill application and structured therapeutic engagement  .",
                                      "Hybrid IOP Options: Available both in-person and via telehealth, allowing flexibility for families balancing school, transportation, or geographic constraints .",
                                      "Core Clinical Services: Includes evidence-based treatment modalities such as individual and group therapy, psychoeducation, crisis management, medication review, and wellness planning.",
                                      "Family Engagement & Discharge Planning: Family sessions and caregiver involvement are emphasized to ensure support and continuity of care at home.",
                                      "Dual Diagnosis & Aftercare Support: Serves adolescents with co-occurring mental health and substance concerns; also offers transition pathways to PHP, inpatient, and outpatient services within the same hospital system  ."
                            ],
                            "contact": {
                                      "phone": "(772)‚ÄØ403‚Äë4000",
                                      "address": "5995 SE Community Drive, Stuart, FL 34997",
                                      "website": "coralshoresbehavioral.com/program-services/outpatient-treatment-options/"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 27.6648,
                                      "lng": -81.5158
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_50",
                            "name": "Mountain Springs Preparatory Academy",
                            "location": "Cedar City, UT",
                            "type": "Therapeutic Boarding School",
                            "category": "therapeutic-school",
                            "programCategory": "Therapeutic Schools",
                            "levelOfCare": "Transitional boarding school for high school students (grades 10‚Äì12) stepping down from higher levels of care, such as residential treatment, therapeutic boarding schools, or wilderness programs. Provides a structured, supportive environment to practice independence and real-world skills while continuing academic and personal growth.",
                            "features": [
                                      "Solution-Focused Model: Emphasizes personal responsibility, choice, and learning through natural consequences rather than rigid behavioral systems.",
                                      "Practice-Oriented Environment: Students engage in off-campus employment, social activities, and community participation to integrate learned skills into daily life.",
                                      "Personalized MAPP Plan: Each student develops a Master Academic and Personal Progress (MAPP) plan with goals in academics, personal growth, family relationships, and future planning.",
                                      "Academic Support: Low student-to-teacher ratio, college-prep curriculum, ACT/SAT preparation, and opportunities to earn both high school and college credits.",
                                      "Wrap-Around Support: Combines mentorship, academic coaching, clinical guidance, and family involvement to prepare students for successful reintegration.",
                                      "Active Student Life: Includes recreation, leadership opportunities, community service, and weekend outings to build confidence and interpersonal skills."
                            ],
                            "contact": {
                                      "phone": "(435) 867-5555",
                                      "address": "1454 South Campus Drive, Cedar City, UT 84720",
                                      "website": "www.mountainspringsprep.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7608,
                                      "lng": -111.891
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_51",
                            "name": "Queen City Counseling & Consulting",
                            "location": "Charlotte, NC",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Outpatient and Intensive Outpatient Program (IOP) tailored for teens and young adults (ages 13‚Äì27), addressing mental health and co-occurring concerns in a strengths-based, trauma-informed environment.",
                            "features": [
                                      "Specialized Population Focus: Dedicated to adolescents and young adults, leveraging developmental expertise unique to this age range.",
                                      "Individual, Family & Group Therapy: Combines personalized individual sessions with supportive group therapy and parent/family involvement.",
                                      "Adolescent IOP Leadership: Adolescent IOP led by specialized clinicians including an IOP team lead and a dedicated clinical director.",
                                      "Evidence-Based & Trauma-Informed: Incorporates DBT, CBT, EMDR, TF-CBT, ACT, motivational interviewing, and mindfulness-based interventions.",
                                      "Parent & Caregiver Support: Offers coaching, education, and resources to integrate parents into the treatment process.",
                                      "Telehealth Availability: Accessible virtual options for both North and South Carolina clients.",
                                      "Highly Skilled Multidisciplinary Team: Led by licensed clinicians experienced in adolescent, young adult, and trauma-related care."
                            ],
                            "contact": {
                                      "phone": "(704) 457‚Äë8222",
                                      "address": "5950 Fairview Rd, Suite 150, Charlotte, NC 28210",
                                      "website": "www.qc-counseling.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_53",
                            "name": "La Amistad Behavioral Health Services",
                            "location": "Central Florida (Residential / PHP / IOP)",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Residential treatment, Partial Hospitalization Program (PHP), and Intensive Outpatient Program (IOP) for youth (ages 12‚Äì17) and adults (18‚Äì65). Treats a broad range of behavioral, emotional, psychiatric, and substance use conditions in a nurturing, community-oriented environment.",
                            "features": [
                                      "Continuum of Care: Offers Residential, PHP (6 hours/day, 5 days/week for ~4‚Äì5 weeks), and IOP (3 hours/session, 3 days/week for ~8‚Äì10 weeks).",
                                      "Wide Age Range Served: Adolescents and adults up to 65.",
                                      "Comprehensive Conditions Treated: Includes mood disorders, depression, bipolar disorder, anxiety, ADHD, personality disorders, trauma-related conditions, schizophrenia, chemical dependency, co-occurring disorders.",
                                      "Diverse, Evidence-Based Modalities: Cognitive Behavioral Therapy (CBT), Client-Centered Therapy, Prolonged Exposure, EMDR, 12-Step model combined with medication management.",
                                      "Qualified, Multidisciplinary Team: Licensed clinicians, certified addiction professionals, psychiatric and nursing staff.",
                                      "Located in Homelike, Serene Settings: Residential campuses in Maitland and Winter Park, Florida, providing tranquility and community integration."
                            ],
                            "contact": {
                                      "phone": "(407) 647-0660",
                                      "address": "1650 North Park Avenue (Maitland/Winter Park), Florida",
                                      "website": "La Amistad Behavioral Health Services"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 27.6648,
                                      "lng": -81.5158
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_54",
                            "name": "Lifeskills South Florida",
                            "location": "Deerfield Beach (Residential / Detox / IOP / PHP / Transitional Living)",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Dual-diagnosis clinical treatment center offering Detox (Fort Lauderdale), Residential (Deerfield Beach & Fort Lauderdale), IOP/PHP (Delray Beach & Orlando), and Transitional Living (Osceola Village). Licensed by DCF and AHCA, CARF accredited since 1991.",
                            "features": [
                                      "Integrated, Evidence-Based Continuum: Custom clinical pathways based on thorough diagnostic assessment; 6 pathways including DBT, CBT, addiction, trauma, CRT, metabolic fitness.",
                                      "Comprehensive Conditions: Treats anxiety, bipolar, depression, BPD, OCD, PTSD, process addictions, psychosis, schizophrenia, schizoaffective disorders, dual diagnosis.",
                                      "Diagnostic Innovation: Premier Diagnostic Insights‚Äîan interdisciplinary concierge diagnostic program combining medical, psychiatric, psychological, and neuropsychological data.",
                                      "Family & Specialty Support: Family therapy and support programs; veteran-specific care (Psych Armor Veteran Ready Certified); tailored programming for Jewish clients (kosher meals, spiritual counseling, holiday observance).",
                                      "Adjunctive Therapies & Amenities: Art/music therapy, yoga, culinary classes, meditation, gym outings, community event transportation, shared townhomes, pool.",
                                      "Positive Outcomes: Long-standing clinical excellence and measurable outcomes reported in 2023."
                            ],
                            "contact": {
                                      "phone": "(954) 691-3174",
                                      "website": "Lifeskills South Florida"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_55",
                            "name": "Brightstone Transitions",
                            "location": "Gainesville, Georgia (Young Adult Transitional / Neurodiverse Program)",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Community-integrated coaching and mentoring program for neurodiverse young adults (ages 18‚Äì30), emphasizing ‚ÄúIndependence through Application.‚Äù Supports life skills, academic and career exploration, therapeutic growth, and personal development.",
                            "features": [
                                      "Neurodiverse Focus: Tailored to support individuals with autism spectrum disorders and other neurodiverse needs transitioning to adulthood.",
                                      "Holistic Growth Approach: Emphasizes life skills, academics, therapy, career pathways, and real-world adventures.",
                                      "Experienced, Inclusive Team: Staff with backgrounds in mental health, education, and outdoor recreation.",
                                      "Community-Integrated, Not Campus-Based: No traditional facility; operates through local community engagement in Gainesville, GA.",
                                      "Personalized Support: Highly individualized guidance, family coaching, accountability, and real-time application of skills."
                            ],
                            "contact": {
                                      "email": "admissions@brightstonetransitions.com",
                                      "address": "446 Green Street, Gainesville, Georgia",
                                      "website": "Brightstone Transitions"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_56",
                            "name": "Neurobehavioral Institute (NBI)",
                            "location": "Weston, Florida (Outpatient / Residential Transitional)",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Specialized outpatient and structured transitional residential care for children, adolescents, and adults with Anxiety, Obsessive‚ÄìCompulsive Disorder (OCD), comorbidities, and complex cases. Services include Intensive Outpatient Program (IOP/PHP), step-down support, and a supportive living residential option (NBI Ranch) for adults.",
                            "features": [
                                      "Evidence-Based Modalities: Emphasizes Cognitive-Behavioral Therapy (CBT), Dialectical Behavior Therapy (DBT), Clinical Behavioral Analysis (CBA), Acceptance & Commitment Therapy (ACT), Exposure and Response Prevention (ERP), executive functioning training, habit reversal, family therapy, and nutritional guidance.",
                                      "Multiple Levels of Care: Offers IOP/PHP, step-down programs for individuals transitioning from hospitalization or more restrictive settings, and a residential ‚ÄúNBI Ranch‚Äù program located in Southwest Ranches for individuals needing daily structure and real-world skill application.",
                                      "Tailored Intensive OCD Treatment: Customizable program models for children, adolescents, and adults‚Äîranging from half-day to full-day formats and lasting from two weeks to four months for children, or four to six weeks for adults. Incorporates psychoeducation, ERP (including in-naturalistic settings like homes and public venues), individualized behavioral strategies, and relapse prevention.",
                                      "Complex & Comorbid Case Expertise: Clinical team specializes in treating OCD-related conditions, body-focused repetitive behaviors, mood, ADHD, tics/Tourette‚Äôs, ASD, disordered eating, PANDAS/PANS, and dual diagnoses through integrated and behavioral-analytic methods.",
                                      "Multilingual & Inclusive Care: Services available in English, Spanish, and Portuguese. Culturally informed treatment supports patients from diverse U.S. regions and international backgrounds.",
                                      "Highly Qualified Clinical Team & Training Center: Staffed by board-certified psychologists and behavioral analysts. NBI hosts an APPIC-accredited postdoctoral residency program, serves as an IOCDF Institutional member, and provides workshops, professional training, and consultation services."
                            ],
                            "contact": {
                                      "phone": "(954) 217-1757",
                                      "address": "2233 North Commerce Parkway, Suite 1 & 3, Weston, FL 33326",
                                      "website": "Neurobehavioral Institute (NBI Weston)"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 27.6648,
                                      "lng": -81.5158
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_57",
                            "name": "Foothills at Red Oak Recovery",
                            "location": "Ellenboro, North Carolina (Residential Treatment Center for Adolescent Boys)",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Residential treatment center for adolescent males (ages 14‚Äì17), designed to address substance use disorders, co-occurring mental health challenges, trauma, mood disorders, and process addictions in a structured, home-like rural setting.",
                            "features": [
                                      "Trauma-Focused, Gender-Specific Treatment: Clinician-led programming tailored specifically for teen boys, fostering resilience and self-discovery.",
                                      "Holistic Clinical Approach: Incorporates evidence-based therapies such as individual, group, and family therapy alongside experiential modalities like equine therapy, adventure/rope-course activities, yoga, mindfulness, music, art, academic support, nutrition counseling, relapse prevention, and exercise therapy programs.",
                                      "Therapy Diversity: Offers a wide therapeutic spectrum‚Äîfrom Cognitive Behavioral Therapy (CBT), Dialectical Behavior Therapy (DBT), and holistic or experiential therapy to academic instruction and group engagement.",
                                      "Campus & Setting: Situated on a therapeutic 94-acre working horse farm in Ellenboro, NC, providing nature-based healing in a calm, rural environment.",
                                      "Insurance & Accreditation: CARF-accredited facility that accepts a variety of major insurance plans, with support available for families navigating coverage and financial logistics.",
                                      "Family and Academic Integration: Strong emphasis on family healing and weekly involvement, along with coordination for on-site educational support to preserve school continuity during treatment."
                            ],
                            "contact": {
                                      "phone": "(828) 519-5047",
                                      "address": "517 Cub Creek Road, Ellenboro, NC 28040",
                                      "website": "Foothills at Red Oak Recovery"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_50",
                            "name": "Serenity Lodge",
                            "location": "Nicholson, PA",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Comprehensive residential treatment program for young men struggling with addiction. Offers Partial Hospitalization, Intensive Outpatient, Structured Sober Living, and Outdoor Adventure Trek programs.",
                            "features": [
                                      "Partial Hospitalization Program: Intensive daily treatment with medical supervision",
                                      "Intensive Outpatient Program: Flexible treatment allowing for work or school",
                                      "Certified School Program: Licensed teacher on-site for academic continuity",
                                      "Structured Sober Living: Safe, supportive environment for recovery",
                                      "Outdoor Adventure Trek Program: Experiential therapy through outdoor activities",
                                      "Individual and Group Counseling: Personalized care planning and peer support",
                                      "Family Counseling: Rebuilding family relationships and support systems",
                                      "Life Skills Program: Practical skills for independent living",
                                      "Recovery Yoga & Meditation: Holistic wellness approaches",
                                      "Expansive 15-Acre Facility: Including gym, recreation areas, basketball court, and campfire area"
                            ],
                            "contact": {
                                      "phone": "(570) 222-3449",
                                      "address": "21 Weida Ct, Nicholson, PA 18446",
                                      "email": "info@serenitylodgerecovery.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": null,
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_51",
                            "name": "Catalyst Residential Treatment Center",
                            "location": "Temecula, CA",
                            "type": "Residential Treatment",
                            "category": "residential",
                            "programCategory": "Residential Treatment Centers",
                            "levelOfCare": "Holistic residential treatment for boys ages 14-18, focusing on balance in six Core Elements: family, heart, soul, mind, body, and friends.",
                            "features": [
                                      "Core Elements Approach: Comprehensive focus on family, heart, soul, mind, body, and friends",
                                      "Intensive Therapeutic Treatment: Minimum 15 hours weekly including 3 hours individual/family sessions, 5 hours group therapy, 7-8 hours experiential recreation",
                                      "The Seven Challenges Program: Specialized program for drug use and addictive behaviors",
                                      "Daily Recovery Groups: Consistent participation in recovery and specialized groups",
                                      "Relationship-Based Program: Fostering positive relationships as the ultimate goal",
                                      "Inside-Out Growth Model: Addressing thoughts and feelings to encourage lasting change",
                                      "Leadership Skills Development: Building self-esteem and confidence",
                                      "Academic Program: Face-to-face classes in core subjects with small class sizes (3-20 students)",
                                      "Experiential Activities: 10-12 hours weekly of therapeutic recreation",
                                      "Milieu Therapeutic Environment: Structured community living with peer support"
                            ],
                            "contact": {
                                      "contactPerson": "Jo Mitchell ‚Äì Admissions Coordinator",
                                      "phone": "951.252.5103",
                                      "email": "jo@catalystrtc.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 36.7783,
                                      "lng": -119.4179
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
                  },
                  {
                            "id": "program_53",
                            "name": "Aspiro Adventure",
                            "location": "Utah",
                            "type": "Wilderness Therapy",
                            "category": "wilderness",
                            "programCategory": "Wilderness Therapy Programs",
                            "levelOfCare": "Wilderness adventure therapy for teens and young adults ages 13-28, specializing in anxiety, depression, and technology addiction.",
                            "features": [
                                      "Adventure-Based Therapy: Rock climbing, mountain biking, skiing, and canyoneering",
                                      "Age-Specific Programs: Separate tracks for teens (13-17) and young adults (18-28)",
                                      "Technology Addiction Focus: Specialized treatment for gaming and screen dependencies",
                                      "Clinical Excellence: Licensed therapists providing individual, group, and family therapy",
                                      "Academic Support: Accredited education program maintaining academic progress",
                                      "Parent Involvement: Weekly therapy calls and regular communication",
                                      "Transition Support: Comprehensive aftercare planning and alumni program",
                                      "Evidence-Based Approaches: DBT, CBT, and experiential therapy modalities",
                                      "Small Group Sizes: Maintaining low student-to-staff ratios for personalized care"
                            ],
                            "contact": {
                                      "phone": "801-349-2740",
                                      "website": "https://aspiroadventure.com"
                            },
                            "insurance": [
                                      "Information pending"
                            ],
                            "costRange": "Contact for pricing",
                            "genderServed": "Co-ed",
                            "ageRange": {
                                      "min": 0,
                                      "max": 99
                            },
                            "coordinates": {
                                      "lat": 40.7608,
                                      "lng": -111.891
                            },
                            "lastUpdated": "2025-11-03T01:34:48.237Z",
                            "dataCompleteness": 50,
                            "verificationStatus": "unverified",
                            "lastVerified": null,
                            "dataSource": "manual",
                            "specialties": [],
                            "waitlistEstimate": null,
                            "lastMigrated": "2025-11-03T01:34:48.261Z"
            }
        ];

        
        // State management
        let selectedPrograms = [];
        let documentType = 'options';
        let currentFilter = 'all';
        let currentSearchTerm = '';
        let lastAction = null; // For undo functionality
        let currentPreviewProgram = null;
        let atHomeProviders = [];
        let draggedItem = null;
        let wizardState = {
            currentStep: 1,
            selectedProgramIds: new Set(),
            searchTerm: ''
        };
        let lastDocumentHtml = '';
        
        // Global text cleaning function for Chrome extension data
        function cleanProgramText(text) {
            if (!text) return '';
            return text
                // Remove markdown bold markers
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                // Remove standalone asterisks
                .replace(/\*\*/g, '')
                // Remove section headers like **TARGET POPULATION:** or **CLINICAL SERVICES:**
                .replace(/\*\*[A-Z\s]+:\*\*/g, '')
                // Remove specific Chrome extension markers
                .replace(/TARGET POPULATION:/gi, '')
                .replace(/CLINICAL SERVICES:/gi, '')
                .replace(/ACCREDITATIONS:/gi, '')
                .replace(/WHAT MAKES THIS PROGRAM UNIQUE:/gi, '')
                .replace(/ADDITIONAL DETAILS FROM WEBSITE:/gi, '')
                .replace(/PROGRAM OVERVIEW:/gi, '')
                .replace(/PROGRAM DETAILS:/gi, '')
                // Clean up extra whitespace
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Enhanced Loading UI Functions
        function showEnhancedLoading(title = 'Processing', steps = []) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'enhancedLoadingOverlay';
            
            const spinner = document.createElement('div');
            spinner.className = 'loading-spinner';
            
            spinner.innerHTML = `
                <div class="progress-ring">
                    <svg viewBox="0 0 120 120">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#4f46e5;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle class="progress-ring-circle" cx="60" cy="60" r="54"></circle>
                        <circle class="progress-ring-circle-progress" cx="60" cy="60" r="54" id="progressCircle"></circle>
                    </svg>
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                </div>
                
                <h3 class="loading-title">${title}</h3>
                <div class="loading-status" id="loadingStatus">
                    <div class="status-main" id="statusMain">Initializing...</div>
                    <div class="status-detail" id="statusDetail"></div>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                </div>
                
                ${steps.length > 0 ? `
                    <div class="loading-steps" id="loadingSteps">
                        ${steps.map((step, index) => `
                            <div class="loading-step" id="step-${index}" data-step="${index}">
                                <div class="loading-step-label">${step}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            
            overlay.appendChild(spinner);
            document.body.appendChild(overlay);
            
            // Start first step if steps exist
            if (steps.length > 0) {
                setTimeout(() => {
                    document.getElementById('step-0')?.classList.add('active');
                }, 100);
            }
            
            return overlay;
        }
        
        function updateLoadingProgress(percentage, status, detail = '', currentStep = -1) {
            const percentageEl = document.getElementById('progressPercentage');
            const progressBar = document.getElementById('progressBarFill');
            const progressCircle = document.getElementById('progressCircle');
            const statusMain = document.getElementById('statusMain');
            const statusDetail = document.getElementById('statusDetail');
            
            if (percentageEl) percentageEl.textContent = `${percentage}%`;
            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (progressCircle) {
                const circumference = 2 * Math.PI * 54;
                const offset = circumference - (percentage / 100) * circumference;
                progressCircle.style.strokeDashoffset = offset;
            }
            if (statusMain) statusMain.textContent = status;
            if (statusDetail) statusDetail.textContent = detail;
            
            // Update steps
            if (currentStep >= 0) {
                const steps = document.querySelectorAll('.loading-step');
                steps.forEach((step, index) => {
                    if (index < currentStep) {
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else if (index === currentStep) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });
            }
        }
        
        function hideEnhancedLoading() {
            const overlay = document.getElementById('enhancedLoadingOverlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            }
        }
        
        // Add fadeOut animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Enhanced Notification System
        function showNotification(message, type = 'info', title = '') {
            // Create container if it doesn't exist
            let container = document.querySelector('.notification-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'notification-container';
                document.body.appendChild(container);
            }
            
            // Set icon and title based on type
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const titles = {
                success: title || 'Success',
                error: title || 'Error',
                warning: title || 'Warning',
                info: title || 'Information'
            };
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">${icons[type]}</div>
                <div class="notification-content">
                    <div class="notification-title">${titles[type]}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <div class="notification-progress"></div>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            // Click to dismiss
            notification.addEventListener('click', () => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            });
        }
        
        // Wrapper functions for convenience
        function showSuccessMessage(message, title) {
            showNotification(message, 'success', title);
        }
        
        function showErrorMessage(message, title) {
            showNotification(message, 'error', title);
        }
        
        function showWarningMessage(message, title) {
            showNotification(message, 'warning', title);
        }
        
        function showInfoMessage(message, title) {
            showNotification(message, 'info', title);
        }
        
        // Auto-save functionality
        let autoSaveTimer = null;
        const AUTO_SAVE_DELAY = 30000; // 30 seconds
        
        async function autoSaveState() {
            const state = {
                selectedPrograms: selectedPrograms,
                atHomeProviders: atHomeProviders,
                documentType: documentType,
                clientName: document.getElementById('clientName')?.value || '',
                includeAtHome: document.getElementById('includeAtHome')?.checked || false,
                includeAlumni: document.getElementById('includeAlumni')?.checked || false,
                timestamp: Date.now()
            };
            
            // Use encrypted storage for auto-save
            await secureStore('ffas_autosave', state);
            showSuccessMessage('üîê Work encrypted and auto-saved', 1000);
        }
        
        async function restoreAutoSave() {
            // Retrieve with decryption
            const state = await secureRetrieve('ffas_autosave');
            if (state) {
                try {
                    // Only restore if less than 24 hours old
                    if (Date.now() - state.timestamp < 24 * 60 * 60 * 1000) {
                        selectedPrograms = state.selectedPrograms || [];
                        atHomeProviders = state.atHomeProviders || [];
                        documentType = state.documentType || 'options';
                        
                        // Restore UI state
                        setTimeout(() => {
                            if (document.getElementById('clientName')) {
                                document.getElementById('clientName').value = state.clientName || '';
                            }
                            if (document.getElementById('includeAtHome')) {
                                document.getElementById('includeAtHome').checked = state.includeAtHome || false;
                            }
                            if (document.getElementById('includeAlumni')) {
                                document.getElementById('includeAlumni').checked = state.includeAlumni || false;
                            }
                            
                            // Update displays
                            updateSelectionPanel();
                            if (typeof toggleAtHomeSection === 'function') {
                            toggleAtHomeSection();
                            }
                            
                            showSuccessMessage('Previous work restored', 2000);
                        }, 500);
                    }
                } catch (e) {
                    console.error('Failed to restore auto-save:', e);
                }
            }
        }
        
        function scheduleAutoSave() {
            // Only schedule auto-save if user is logged in
            if (sessionStorage.getItem('isLoggedIn') !== 'true') {
                return;
            }
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(autoSaveState, AUTO_SAVE_DELAY);
        }
        
        // Trigger auto-save on any change (only after login)
        function enableAutoSave() {
        document.addEventListener('input', scheduleAutoSave);
        document.addEventListener('change', scheduleAutoSave);
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter = Generate Document (Quick Generate)
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const clientNameInput = document.getElementById('clientName');
                if (clientNameInput && clientNameInput.value.trim() && selectedPrograms.length > 0) {
                    generateDocument();
                } else {
                    // Show what's missing
                    if (!clientNameInput || !clientNameInput.value.trim()) {
                        clientNameInput.focus();
                        clientNameInput.style.border = '2px solid #ef4444';
                        setTimeout(() => {
                            clientNameInput.style.border = '';
                        }, 2000);
                    }
                    if (selectedPrograms.length === 0) {
                        showNotification('Select at least one program first', 'warning');
                    }
                }
            }
            
            // Ctrl/Cmd + S = Save to vault
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (lastDocumentHtml) {
                    saveToVault();
                } else {
                    showErrorMessage('Generate a document first before saving');
                }
            }
            
            // Ctrl/Cmd + P = Print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                if (lastDocumentHtml) {
                    printDocumentPreview();
                } else {
                    showErrorMessage('Generate a document first before printing');
                }
            }
            
            // Ctrl/Cmd + G = Generate document
            if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                e.preventDefault();
                generateDocument();
            }
            
            // Ctrl/Cmd + Z = Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undoLastAction();
            }
            
            // ESC = Close modals
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    if (modal.id === 'documentPreviewModal') {
                        closeDocumentPreview();
                    } else if (modal.id === 'previewModal') {
                        closePreview();
                    }
                });
            }
        });
        
        // Input sanitization helper
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            // Create a temporary div to convert HTML entities
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML
                .replace(/[<>]/g, '') // Remove angle brackets
                .trim();
        }
        
        // Sanitize client name on input
        const clientNameInput = document.getElementById('clientName');
        if (clientNameInput) {
            clientNameInput.addEventListener('input', function() {
                this.value = sanitizeInput(this.value);
            });
        }
        
        // AI Configuration removed for security - should be handled server-side
        
        // Helpers
        function normalizeUrl(url) {
            if (!url) return '';
            const trimmed = String(url).trim();
            if (!trimmed) return '';
            if (/^https?:\/\//i.test(trimmed)) return trimmed;
            if (/^www\./i.test(trimmed)) return `https://${trimmed}`;
            try {
                // If it's a bare domain like example.com
                const hasDot = trimmed.includes('.') && !trimmed.includes(' ');
                return hasDot ? `https://${trimmed}` : trimmed;
            } catch { return trimmed; }
        }
        
        // Save custom programs to localStorage
        function saveCustomPrograms() {
            const customPrograms = programs.filter(p => p.isCustom);
            localStorage.setItem('customPrograms', JSON.stringify(customPrograms));
            console.log('Saved', customPrograms.length, 'custom programs');
        }
        
        // Delete a program from the database
        function deleteProgramFromDatabase(programId, programName, event) {
            event.stopPropagation(); // Prevent card click
            
            // Confirm deletion
            const confirmed = confirm(`Are you sure you want to delete "${programName}" from the database?\n\nThis will permanently remove it from your custom programs.`);
            
            if (!confirmed) return;
            
            // Find the program index
            const programIndex = programs.findIndex(p => p.id === programId);
            
            if (programIndex === -1) {
                showNotification('‚ùå Program not found', 'error');
                return;
            }
            
            // Remove from programs array
            programs.splice(programIndex, 1);
            
            // Remove from selected programs if it was selected
            const selectedIndex = selectedPrograms.findIndex(p => p.id === programId);
            if (selectedIndex !== -1) {
                selectedPrograms.splice(selectedIndex, 1);
                updateSelectedProgramsList();
            }
            
            // Save to localStorage
            saveCustomPrograms();
            
            // Re-render the program grid
            renderPrograms();
            
            // Show success message
            showNotification(`‚úÖ "${programName}" deleted from database`, 'success');
            
            console.log(`Deleted program: ${programName} (${programId})`);
        }
        
        // Load custom programs from localStorage
        function loadCustomPrograms() {
            const saved = localStorage.getItem('customPrograms');
            if (saved) {
                try {
                    const customPrograms = JSON.parse(saved);
                    customPrograms.forEach(p => {
                        // Check if this program isn't already in the array
                        if (!programs.find(existing => existing.id === p.id)) {
                            programs.push(p);
                        }
                    });
                    console.log('Loaded', customPrograms.length, 'custom programs from storage');
                } catch (e) {
                    console.error('Error loading custom programs:', e);
                }
            }
        }
        
        // Initialize
        // Document Vault Functions
        async function openDocumentVault() {
            // Check if logged in first
            if (sessionStorage.getItem('isLoggedIn') !== 'true') {
                showErrorMessage('Please log in to access the document vault');
                return;
            }
            
            // Get vault data with decryption
            const vault = await secureRetrieve(STORAGE_KEYS.documentVault) || [];
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2>üóÑÔ∏è Document Vault (HIPAA Compliant - Local Storage)</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 8px 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px;">
                            <span style="color: #f59e0b; font-size: 16px;">‚ö†Ô∏è</span>
                            <span style="color: #92400e;"><strong>PHI Warning:</strong> Only first name is stored. Do not enter full names, DOB, addresses, or any PHI.</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <strong>Stored Documents: ${vault.length}</strong>
                            <div>
                                <button onclick="exportVault().catch(console.error)" style="background: #059669; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-right: 10px;">
                                    üì• Export All
                                </button>
                                <button onclick="clearVault().catch(console.error)" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px;">
                                    üóëÔ∏è Clear Vault
                                </button>
                            </div>
                        </div>
                        ${vault.length === 0 ? '<p>No documents saved yet. Generated aftercare recommendations will automatically be saved here.</p>' : vault.map((doc, i) => `
                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 15px; margin-bottom: 10px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="font-size: 16px;">${doc.clientName}</strong>
                                        <span style="color: #6b7280; margin-left: 10px;">${new Date(doc.date).toLocaleDateString()} ${new Date(doc.date).toLocaleTimeString()}</span>
                                        ${doc.type ? `<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; margin-left: 10px; font-size: 12px;">${doc.type}</span>` : ''}
                                    </div>
                                    <div>
                                        <button onclick="viewDocument(${i}).catch(console.error)" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px;">
                                            üëÅÔ∏è View
                                        </button>
                                        <button onclick="includeInPacket(${i}).catch(console.error)" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px;">
                                            üì¶ Add to Packet
                                        </button>
                                        <button onclick="deleteDocument(${i}).catch(console.error)" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px;">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                                ${doc.programs && doc.programs.length > 0 ? `
                                    <div style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                                        Programs: ${doc.programs.map(p => p.name).join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

                                        const defaultAtHomeLibrary = [
                                            {
                                                id: 'library_provider_1',
                                                name: 'Clear Path Clinical Group',
                                                service: 'Family Therapy & Parent Coaching',
                                                phone: '(561) 480-2232',
                                                website: 'https://clearpathclinical.com',
                                                address: 'Telehealth (Florida Based)'
                                            },
                                            {
                                                id: 'library_provider_2',
                                                name: 'Momentum Teen Psychiatry Collective',
                                                service: 'Psychiatry & Medication Management',
                                                phone: '(305) 902-7710',
                                                website: 'https://momentumteenpsychiatry.com',
                                                address: 'Miami, FL & Virtual'
                                            },
                                            {
                                                id: 'library_provider_3',
                                                name: 'Thrive Recovery Coaching Alliance',
                                                service: 'Recovery Coaching & Transport',
                                                phone: '(770) 407-0768',
                                                website: 'https://thriverecoveryalliance.com',
                                                address: 'National Network'
                                            }
                                        ];
        
        // View document from vault
        async function viewDocument(index) {
            const vault = await secureRetrieve(STORAGE_KEYS.documentVault) || [];
            if (vault[index]) {
                const win = window.open();
                win.document.write(vault[index].content);
            }
        }
        
        // Delete document from vault
        async function deleteDocument(index) {
            if (confirm('Are you sure you want to delete this document?')) {
                const vault = await secureRetrieve(STORAGE_KEYS.documentVault) || [];
                vault.splice(index, 1);
                await secureStore(STORAGE_KEYS.documentVault, vault);
                openDocumentVault().catch(console.error); // Refresh the modal
            }
        }
        
        // Clear entire vault
        async function clearVault() {
            if (confirm('Are you sure you want to clear the entire document vault? This cannot be undone.')) {
                await secureStore(STORAGE_KEYS.documentVault, []);
                openDocumentVault().catch(console.error); // Refresh the modal
            }
        }
        
        // Export vault as JSON
        async function exportVault() {
            const vault = await secureRetrieve(STORAGE_KEYS.documentVault) || [];
            const dataStr = JSON.stringify(vault, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `document_vault_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Include document in packet (placeholder for future enhancement)
        async function includeInPacket(index) {
            const vault = await secureRetrieve(STORAGE_KEYS.documentVault) || [];
            const doc = vault[index];
            if (doc) {
                // Store temporarily for packet compilation
                sessionStorage.setItem('pendingPacketDoc', JSON.stringify(doc));
                showSuccessMessage(`Document for ${doc.clientName} marked for packet inclusion. Open the Discharge Packet creator to continue.`);
            }
        }
        
        // Enhanced Discharge Packet with PDF Merging
        function createDischargePacket() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2>üì¶ Create Complete Discharge Packet</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="background: #f0f9ff; border: 1px solid #0099cc; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #0066cc;">PDF Document Compiler</h3>
                            <p style="margin: 5px 0;">Merge multiple PDFs and generated documents into one complete packet</p>
                            <small style="color: #666;">All processing happens locally - HIPAA compliant</small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Client First Name <span style="color: #92400e; font-size: 12px;">(No PHI)</span>:</label>
                            <input type="text" id="packetClientName" placeholder="First Name Only (Required)" 
                                   value="${currentClientSession.clientFirstName || document.getElementById('clientName')?.value || ''}" 
                                   style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" 
                                   oninput="validatePacketFirstName(this)">
                            <div id="packetNameWarning" style="color: #dc2626; font-size: 13px; display: none; margin-top: 5px;">Please enter first name only. No full names, DOB, or PHI.</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Discharge Date:</label>
                            <input type="date" id="packetDischargeDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        
                        <!-- Document Components Section -->
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #374151; margin-bottom: 10px;">üìã Discharge Packet Checklist:</h4>
                            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Select documents to compile. All items marked with ‚úì will be included in the packet.</p>
                            
                            <!-- Required Documents -->
                            <div style="background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0; color: #0066cc;">‚úì Automatically Included</h5>
                                <div style="padding-left: 10px;">
                                    <div style="margin-bottom: 5px;">‚úì <strong>Aftercare Plan</strong> (from current document)</div>
                                </div>
                            </div>
                            
                            <!-- Upload Required Documents -->
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                                <h5 style="margin-top: 0; color: #92400e; font-size: 16px;">üìé Upload Required Documents</h5>
                                <p style="font-size: 14px; color: #78350f; margin-bottom: 15px; font-weight: 500;">Per discharge checklist, packet must include:</p>
                                
                                <!-- Two Column Layout -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px 30px; margin: 15px 0; padding: 15px; background: white; border-radius: 6px;">
                                    <div style="font-size: 15px; color: #78350f; padding: 8px 0;">
                                        ‚úì Medication Schedule (MOR summary, ‚â§2 pages)
                                    </div>
                                    <div style="font-size: 15px; color: #78350f; padding: 8px 0;">
                                        ‚úì Creyos Baseline Assessments
                                    </div>
                                    <div style="font-size: 15px; color: #78350f; padding: 8px 0;">
                                        ‚úì Client Clinical Assignments (from PT)
                                    </div>
                                    <div style="font-size: 15px; color: #78350f; padding: 8px 0;">
                                        ‚úì Recent Labs
                                    </div>
                                    <div style="font-size: 15px; color: #78350f; padding: 8px 0;">
                                        ‚úì 3rd-party Medical Records (ER, Hospital, Imaging)
                                    </div>
                                    <div style="font-size: 15px; color: #78350f; padding: 8px 0;">
                                        ‚úì Genomind/Genesight (if applicable)
                                    </div>
                                    <div style="font-size: 15px; color: #78350f; padding: 8px 0; grid-column: span 1;">
                                        ‚úì Neuropsych (if applicable)
                                    </div>
                                </div>
                                
                                <input type="file" id="additionalPdfs" multiple accept=".pdf" style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px; margin-top: 15px; font-size: 14px;">
                                <small style="color: #666; display: block; margin-top: 8px; font-size: 13px;">üí° Tip: You can select multiple PDFs at once (Cmd/Ctrl + Click)</small>
                            </div>
                            
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button onclick="compileDischargePacket()" style="padding: 14px 28px; background: #0066cc; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            üì¶ Create Packet
                        </button>
                        <button onclick="this.closest('.modal').remove()" style="padding: 14px 28px; background: #e5e7eb; color: #6b7280; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Inline validation for first name only (packet modal)
        function validatePacketFirstName(input) {
            const value = input.value.trim();
            // Auto-capitalize
            if (value.length > 0) {
                input.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
            }
            // Disallow spaces, numbers, or special chars (except hyphen/apostrophe)
            const invalid = /[\s\d@#\$%\^&\*\(\)_\+=\[\]\{\};:,.<>\/?\\|]/.test(value) || value.length > 20;
            const warning = document.getElementById('packetNameWarning');
            if (warning) {
                warning.style.display = invalid ? 'block' : 'none';
            }
            input.style.borderColor = invalid ? '#dc2626' : '#d1d5db';
        }
                        
        // Compile discharge packet function
        async function compileDischargePacket() {
            const clientName = document.getElementById('packetClientName')?.value.trim();
            const additionalFiles = document.getElementById('additionalPdfs')?.files;
            
            if (!clientName) {
                alert('Please enter client first name');
                return;
            }
            
            // Check if we have an aftercare document OR selected programs
            const hasAftercarePlan = lastDocumentHtml || selectedPrograms.length > 0;
            
            if (!hasAftercarePlan) {
                alert('Please generate an aftercare document first by:\n1. Selecting programs\n2. Clicking "Generate Document"');
                return;
            }
            
            showNotification('üì¶ Creating discharge packet...', 'info');
            
            // Close the modal
            document.querySelector('.modal.show')?.remove();
            
            // If no document generated yet but we have programs, generate it now
            if (!lastDocumentHtml && selectedPrograms.length > 0) {
                showNotification('üìù Generating aftercare plan first...', 'info');
                await generateDocument();
                // Wait a moment for generation
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            try {
                // Create a merged PDF using pdf-lib
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                
                // Step 1: Generate aftercare plan PDF
                showNotification('üìÑ Generating aftercare plan PDF...', 'info');
                const aftercarePdfBytes = await generatePdfBytes();
                
                if (aftercarePdfBytes) {
                    const aftercarePdf = await PDFDocument.load(aftercarePdfBytes);
                    const aftercarePages = await mergedPdf.copyPages(aftercarePdf, aftercarePdf.getPageIndices());
                    aftercarePages.forEach(page => mergedPdf.addPage(page));
                }
                
                // Step 2: Add uploaded PDFs if any
                if (additionalFiles && additionalFiles.length > 0) {
                    showNotification(`üìé Adding ${additionalFiles.length} medical record(s)...`, 'info');
                    
                    for (let i = 0; i < additionalFiles.length; i++) {
                        const file = additionalFiles[i];
                        const arrayBuffer = await file.arrayBuffer();
                        const pdfBytes = new Uint8Array(arrayBuffer);
                        
                        try {
                            const pdf = await PDFDocument.load(pdfBytes);
                            const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                            pages.forEach(page => mergedPdf.addPage(page));
                            
                            console.log(`Added ${file.name} to packet`);
                        } catch (e) {
                            console.error(`Failed to add ${file.name}:`, e);
                            showNotification(`‚ö†Ô∏è Could not add ${file.name}`, 'warning');
                        }
                    }
                }
                
                // Step 3: Save and download the merged PDF
                const mergedPdfBytes = await mergedPdf.save();
                const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${clientName}_Discharge_Packet_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show completion modal with instructions
                showDischargePacketInstructions(clientName, additionalFiles ? additionalFiles.length : 0, true);
                
                // Clear session after successful download (HIPAA - don't store medical records)
                setTimeout(() => {
                    endClientSession();
                }, 2000);
                
            } catch (error) {
                console.error('Error creating packet:', error);
                showNotification('‚ùå Failed to create discharge packet', 'error');
            }
        }
        
        // Generate PDF bytes from current document
        async function generatePdfBytes() {
            if (!lastDocumentHtml) return null;
            
            try {
                const element = document.createElement('div');
                element.innerHTML = lastDocumentHtml;
                element.style.cssText = 'position: absolute; left: -9999px; width: 794px; padding: 40px; background: white;';
                document.body.appendChild(element);
                
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                document.body.removeChild(element);
                
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                let position = 0;
                
                if (imgHeight <= pageHeight) {
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                } else {
                    let heightLeft = imgHeight;
                    const imgData = canvas.toDataURL('image/png');
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                }
                
                return pdf.output('arraybuffer');
            } catch (error) {
                console.error('Error generating PDF bytes:', error);
                return null;
            }
        }
        
        // Show instructions after packet creation
        function showDischargePacketInstructions(clientName, additionalFileCount, merged = false) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header" style="background: #10b981; color: white;">
                        <h2>‚úÖ Discharge Packet Created!</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()" style="color: white;">&times;</button>
                                </div>
                    <div class="modal-body" style="padding: 30px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                            <h3 style="color: #10b981; margin: 0;">Complete Discharge Packet Created!</h3>
                            </div>
                        
                        <div style="background: #f0fdf4; border: 2px solid #10b981; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0; color: #065f46;">‚úÖ Packet Contents:</h4>
                            <ul style="margin: 10px 0; padding-left: 20px; color: #064e3b;">
                                <li><strong>Aftercare Plan:</strong> Included</li>
                                ${additionalFileCount > 0 ? `<li><strong>Medical Records:</strong> ${additionalFileCount} file(s) merged</li>` : ''}
                                <li><strong>Total:</strong> ${merged ? 'All documents compiled into single PDF' : 'Aftercare plan generated'}</li>
                            </ul>
                        </div>
                        
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0; color: #92400e;">‚ö†Ô∏è IMPORTANT - HIPAA Compliance</h4>
                            <p style="margin: 10px 0; color: #78350f; font-weight: 500;">
                                This packet is NOT saved in the vault to maintain HIPAA compliance.
                            </p>
                                </div>
                        
                        <div style="background: #dbeafe; border: 2px solid #0284c7; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0; color: #0369a1; text-align: center; font-size: 18px;">üì§ Ready to Upload to Kipu!</h4>
                            
                            <div style="background: white; border-radius: 6px; padding: 15px; margin: 15px 0;">
                                <p style="margin: 0 0 10px 0; color: #334155; font-weight: 500;">
                                    <strong>Step 1:</strong> Your discharge packet is in your Downloads folder:
                                </p>
                                <code style="background: #f1f5f9; padding: 8px 12px; border-radius: 4px; display: block; text-align: center; color: #475569; font-size: 13px;">
                                    ${clientName}_Discharge_Packet_${new Date().toISOString().split('T')[0]}.pdf
                                </code>
                        </div>
                        
                            <div style="background: white; border-radius: 6px; padding: 15px; margin: 15px 0;">
                                <p style="margin: 0 0 15px 0; color: #334155; font-weight: 500;">
                                    <strong>Step 2:</strong> Upload to Kipu EHR System
                                </p>
                                <button onclick="window.open('https://ffa11088.kipuworks.com/', '_blank'); this.closest('.modal').remove();" 
                                        style="width: 100%; padding: 14px; background: linear-gradient(135deg, #0066cc, #0052a3); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);">
                                    <span style="font-size: 20px;">üè•</span>
                                    <span>Open Kipu & Upload Document</span>
                                    <span style="font-size: 16px;">‚Üó</span>
                                </button>
                                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #64748b;">
                                    Navigate to: <strong>CM (Case Management)</strong> tab ‚Üí <strong>Documents</strong> ‚Üí <strong>Upload</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f3f4f6; border-radius: 8px; padding: 15px; text-align: center; margin-bottom: 20px;">
                            <p style="margin: 0; color: #6b7280; font-size: 13px;">
                                üîí <strong>HIPAA Note:</strong> This packet is not saved in the app.<br>
                                Session will be cleared to protect client privacy.
                            </p>
                            </div>
                        </div>
                    <div class="modal-actions">
                        <button onclick="this.closest('.modal').remove()" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            I'll Upload Later
                            </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Handle PDF file selection (placeholder for future enhancement)
        function handlePDFSelection(input) {
            const files = input.files;
            const selectedFilesDiv = document.getElementById('selectedFiles');
            if (selectedFilesDiv && files.length > 0) {
                selectedFilesDiv.innerHTML = `<p style="color: #16a34a;">‚úì ${files.length} file(s) selected</p>`;
            }
        }
        
        // Schedule follow-up function
        function scheduleFollowUp() {
            showNotification('Follow-up scheduling feature coming soon!', 'info');
        }
        
        // Email document function
        function handlePDFSelection(input) {
            const files = input.files;
            const selectedFilesDiv = document.getElementById('selectedFiles');
            const orderDiv = document.getElementById('documentOrder');
            
            if (files.length > 0) {
                selectedFilesDiv.innerHTML = '<strong>Selected PDFs:</strong>';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    selectedFilesDiv.innerHTML += `
                        <div style="margin-top: 5px; padding: 5px; background: #fff; border-radius: 4px;">
                            üìÑ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
                        </div>
                    `;
                    
                    // Add to document order
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.setAttribute('data-type', 'pdf');
                    orderItem.setAttribute('data-file-index', i);
                    orderItem.style.cssText = 'padding: 8px; background: #fef3c7; margin-bottom: 5px; border-radius: 4px; cursor: move;';
                    orderItem.textContent = `${orderDiv.children.length + 1}. ${file.name}`;
                    orderDiv.appendChild(orderItem);
                }
            }
        }
        
        // Compile the complete packet
        async function compilePacket() {
            const clientName = document.getElementById('packetClientName').value;
            if (!clientName) {
                alert('Please enter patient name');
                return;
            }
            
            // Show progress
            document.getElementById('mergeProgress').style.display = 'block';
            updateProgress(0, 'Starting compilation...');
            
            try {
                // Create a new PDF document using pdf-lib
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                
                let currentProgress = 0;
                const progressIncrement = 100 / (document.getElementById('documentOrder').children.length + 2);
                
                // Process each document in order
                const orderItems = document.getElementById('documentOrder').children;
                
                for (let i = 0; i < orderItems.length; i++) {
                    const item = orderItems[i];
                    const type = item.getAttribute('data-type');
                    
                    updateProgress(currentProgress, `Processing ${item.textContent}...`);
                    
                    if (type === 'cover' && document.getElementById('includeCoverPage').checked) {
                        await addCoverPage(mergedPdf, clientName);
                    } else if (type === 'aftercare' && document.getElementById('includeAftercare').checked) {
                        await addAftercarePage(mergedPdf, clientName);
                    } else if (type === 'facesheet' && document.getElementById('includeFaceSheet').checked) {
                        await addFaceSheet(mergedPdf, clientName);
                    } else if (type === 'pdf') {
                        const fileIndex = parseInt(item.getAttribute('data-file-index'));
                        const files = document.getElementById('pdfFiles').files;
                        if (files[fileIndex]) {
                            await addExternalPDF(mergedPdf, files[fileIndex]);
                        }
                    }
                    
                    currentProgress += progressIncrement;
                    updateProgress(currentProgress, `Completed ${item.textContent}`);
                }
                
                // Save the merged PDF
                updateProgress(90, 'Finalizing document...');
                const pdfBytes = await mergedPdf.save();
                
                // Download the file
                updateProgress(100, 'Complete! Downloading...');
                downloadPDF(pdfBytes, `${clientName}_Discharge_Packet_${new Date().toISOString().split('T')[0]}.pdf`);
                
                // Close modal after success
                setTimeout(() => {
                    document.querySelector('.modal').remove();
                    showSuccessMessage('Discharge packet created successfully!');
                }, 1500);
                
            } catch (error) {
                console.error('Error compiling packet:', error);
                alert('Error creating packet: ' + error.message);
            }
        }
        
        // Add cover page to PDF
        async function addCoverPage(pdf, clientName) {
            const { rgb, StandardFonts } = PDFLib;
            const page = pdf.addPage();
            const font = await pdf.embedFont(StandardFonts.Helvetica);
            const boldFont = await pdf.embedFont(StandardFonts.HelveticaBold);
            
            const { width, height } = page.getSize();
            
            // Title
            page.drawText('DISCHARGE PACKET', {
                x: width / 2 - 100,
                y: height - 100,
                size: 24,
                font: boldFont,
                color: rgb(0, 0.4, 0.8)
            });
            
            // Patient info
            page.drawText(`Patient: ${clientName}`, {
                x: 50,
                y: height - 200,
                size: 14,
                font: font
            });
            
            page.drawText(`Discharge Date: ${document.getElementById('packetDischargeDate').value}`, {
                x: 50,
                y: height - 230,
                size: 14,
                font: font
            });
            
            page.drawText('Family First Adolescent Services', {
                x: 50,
                y: 100,
                size: 12,
                font: font,
                color: rgb(0.4, 0.4, 0.4)
            });
        }
        
        // Add aftercare recommendations from vault or current session
        async function addAftercarePage(pdf, clientName) {
            const { rgb, StandardFonts } = PDFLib;
            
            // Check if we have a saved aftercare document in the vault
            const vault = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentVault) || '[]');
            const latestAftercare = vault
                .filter(doc => doc.clientName === clientName && doc.type === 'aftercare')
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            
            if (latestAftercare && latestAftercare.htmlContent) {
                // Convert HTML to PDF using jsPDF
                await addHtmlToPdf(pdf, latestAftercare.htmlContent, 'Aftercare Recommendations');
            } else {
                // Fallback to basic text version
                const page = pdf.addPage();
                const font = await pdf.embedFont(StandardFonts.Helvetica);
                const boldFont = await pdf.embedFont(StandardFonts.HelveticaBold);
                
                const { width, height } = page.getSize();
                
                page.drawText('AFTERCARE RECOMMENDATIONS', {
                    x: 50,
                    y: height - 50,
                    size: 18,
                    font: boldFont,
                    color: rgb(0, 0.4, 0.8)
                });
                
                // Add selected programs if any
                if (selectedPrograms && selectedPrograms.length > 0) {
                    let yPosition = height - 100;
                    let currentPage = page;
                    
                    selectedPrograms.forEach((program, index) => {
                        if (yPosition < 100) {
                            // Add new page if needed
                            currentPage = pdf.addPage();
                            yPosition = currentPage.getSize().height - 50;
                        }
                        
                        currentPage.drawText(`${index + 1}. ${program.name}`, {
                            x: 50,
                            y: yPosition,
                            size: 12,
                            font: boldFont
                        });
                        yPosition -= 20;
                        
                        if (program.location) {
                            currentPage.drawText(`   Location: ${program.location}`, {
                                x: 50,
                                y: yPosition,
                                size: 10,
                                font: font
                            });
                            yPosition -= 15;
                        }
                        
                        if (program.contact?.phone || program.phone) {
                            currentPage.drawText(`   Phone: ${program.contact?.phone || program.phone}`, {
                                x: 50,
                                y: yPosition,
                                size: 10,
                                font: font
                            });
                            yPosition -= 15;
                        }
                        
                        yPosition -= 10;
                    });
                }
            }
        }
        
        // Helper function to convert HTML to PDF pages
        async function addHtmlToPdf(pdf, htmlContent, title) {
            // Create a temporary jsPDF document to convert HTML
            const { jsPDF } = window.jspdf;
            const tempDoc = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'letter'
            });
            
            // Create a temporary div to render the HTML
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = '612px'; // Letter width in points
            tempDiv.innerHTML = htmlContent;
            document.body.appendChild(tempDiv);
            
            // Use html2canvas if available, otherwise use text extraction
            try {
                // For now, we'll extract text content and add it to the PDF
                const textContent = tempDiv.innerText || tempDiv.textContent;
                const lines = textContent.split('\n').filter(line => line.trim());
                
                const { rgb, StandardFonts } = PDFLib;
                const page = pdf.addPage();
                const font = await pdf.embedFont(StandardFonts.Helvetica);
                const boldFont = await pdf.embedFont(StandardFonts.HelveticaBold);
                
                const { width, height } = page.getSize();
                let yPosition = height - 50;
                let currentPage = page;
                
                // Add title
                currentPage.drawText(title || 'Document', {
                    x: 50,
                    y: yPosition,
                    size: 18,
                    font: boldFont,
                    color: rgb(0, 0.4, 0.8)
                });
                yPosition -= 30;
                
                // Add content lines
                for (const line of lines) {
                    if (yPosition < 50) {
                        currentPage = pdf.addPage();
                        yPosition = currentPage.getSize().height - 50;
                    }
                    
                    // Wrap long lines
                    const maxWidth = width - 100;
                    const words = line.split(' ');
                    let currentLine = '';
                    
                    for (const word of words) {
                        const testLine = currentLine + (currentLine ? ' ' : '') + word;
                        const textWidth = font.widthOfTextAtSize(testLine, 11);
                        
                        if (textWidth > maxWidth && currentLine) {
                            currentPage.drawText(currentLine, {
                                x: 50,
                                y: yPosition,
                                size: 11,
                                font: font
                            });
                            yPosition -= 15;
                            currentLine = word;
                            
                            if (yPosition < 50) {
                                currentPage = pdf.addPage();
                                yPosition = currentPage.getSize().height - 50;
                            }
                        } else {
                            currentLine = testLine;
                        }
                    }
                    
                    if (currentLine) {
                        currentPage.drawText(currentLine, {
                            x: 50,
                            y: yPosition,
                            size: 11,
                            font: font
                        });
                        yPosition -= 15;
                    }
                }
            } finally {
                document.body.removeChild(tempDiv);
            }
        }
        
        // Add face sheet
        async function addFaceSheet(pdf, clientName) {
            const { rgb, StandardFonts } = PDFLib;
            const page = pdf.addPage();
            const font = await pdf.embedFont(StandardFonts.Helvetica);
            const boldFont = await pdf.embedFont(StandardFonts.HelveticaBold);
            
            const { width, height } = page.getSize();
            
            page.drawText('FACE SHEET', {
                x: 50,
                y: height - 50,
                size: 18,
                font: boldFont,
                color: rgb(0, 0.4, 0.8)
            });
            
            page.drawText(`Patient Name: ${clientName}`, {
                x: 50,
                y: height - 100,
                size: 12,
                font: font
            });
            
            page.drawText(`Date of Discharge: ${document.getElementById('packetDischargeDate').value}`, {
                x: 50,
                y: height - 130,
                size: 12,
                font: font
            });
        }
        
        // Add external PDF
        async function addExternalPDF(mergedPdf, file) {
            const arrayBuffer = await file.arrayBuffer();
            const externalPdf = await PDFLib.PDFDocument.load(arrayBuffer);
            const pages = await mergedPdf.copyPages(externalPdf, externalPdf.getPageIndices());
            pages.forEach(page => mergedPdf.addPage(page));
        }
        
        // Update progress bar
        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = message;
        }
        
        // Download PDF
        function downloadPDF(pdfBytes, filename) {
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Show success message
        function showSuccessMessage(message) {
            const msg = document.createElement('div');
            msg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
            msg.innerHTML = '‚úÖ ' + message;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }
        
        function showNotification(message, type = 'info') {
            const colors = {
                info: '#0099cc',
                warning: '#f59e0b',
                error: '#ef4444',
                success: '#10b981'
            };
            const msg = document.createElement('div');
            msg.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;`;
            msg.innerHTML = message;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting initialization...');

            // Load any saved custom programs first
            loadCustomPrograms();
            console.log('Programs loaded:', programs.length);
            console.log('First program:', programs[0]);

            // DEBUG: Check if selection panel exists
            const selectionPanel = document.querySelector('.selection-panel');
            console.log('Selection panel found:', !!selectionPanel);

            if (selectionPanel) {
                console.log('Selection panel styles:', window.getComputedStyle(selectionPanel));
            }

            // Add a small delay to ensure DOM is fully ready
            setTimeout(() => {
            renderPrograms();
                console.log('Programs rendered');
            }, 100);
            
            // Search functionality (combined with active filter)
            document.getElementById('searchBox').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const cards = document.querySelectorAll('.program-card');
                cards.forEach(card => {
                    const program = programs.find(p => p.id === card.dataset.id);
                    const matchesSearch = `${program.name} ${program.location} ${program.type}`.toLowerCase().includes(searchTerm);
                    const matchesFilter = (currentFilter === 'all' || program.category === currentFilter);
                    card.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
                });
            });
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('previewModal');
                if (event.target == modal) {
                    closePreview();
                }
            }
        });
        
        // Set document type
        function setDocumentType(type, el) {
            documentType = type;
            
            // Update button states
            document.querySelectorAll('.doc-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (el) el.classList.add('active');
            
            // Update UI based on type
            const selectedTitle = document.getElementById('selectedTitle');
            
            if (type === 'plans') {
                selectedTitle.textContent = 'Selected Program (Choose 1)';
                
                // If more than one selected, keep only the first
                if (selectedPrograms.length > 1) {
                    selectedPrograms = [selectedPrograms[0]];
                    updateSelectionPanel();
                    renderPrograms();
                }
            } else {
                selectedTitle.textContent = 'Selected Programs (Drag to reorder)';
            }
        }
        
        // Smart Search functionality
        let searchTimeout;
        
        function handleSearch(searchTerm) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const indicator = document.getElementById('searchIndicator');
                currentSearchTerm = searchTerm.trim().toLowerCase();
                if (indicator) {
                    if (!currentSearchTerm) {
                indicator.style.display = 'none';
                        indicator.style.opacity = '0';
                        indicator.classList.remove('search-animation');
                    } else {
                        indicator.innerHTML = 'üîç Filtering results...';
            indicator.style.display = 'block';
            indicator.style.opacity = '1';
            indicator.classList.add('search-animation');
                    }
                }
                renderPrograms();
            }, 200);
        }
        
        function triggerAddProgram() {
            const addBtn = document.getElementById('addProgramBtn');
            const searchTerm = document.getElementById('searchBox').value;
            
            // Cool animation
            addBtn.classList.add('add-animation');
            
            // Pre-populate the add program dialog with search term
            document.getElementById('customProgramInfo').value = searchTerm;
            showAddProgramDialog();
            
            // Remove animation class after animation completes
            setTimeout(() => {
                addBtn.classList.remove('add-animation');
            }, 800);
        }
        
        // Filter programs
    function filterPrograms(category, el) {
            currentFilter = category || 'all';
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (el && el.classList.contains('filter-btn')) {
                el.classList.add('active');
            }
            
            if (category === 'frequent') {
                const frequentPrograms = getFrequentlyUsedPrograms(10);
                    const grid = document.getElementById('programGrid');
                if (!grid) return;
                grid.innerHTML = '';
                if (frequentPrograms.length === 0) {
                    grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No frequently used programs yet. Start selecting programs to build your favorites!</div>';
                    return;
                }
                renderPrograms(frequentPrograms);
                return;
            }
            
            renderPrograms();
        }

        const FILTER_CATEGORY_MAP = {
                'rtc': 'residential',
                'tbs': 'therapeutic-school',
                'wilderness': 'wilderness',
                'php-iop': 'outpatient',
                'transitional': 'sober-living',
                'virtual': 'virtual',
                'asd': 'asd',
                'evaluation': 'evaluation',
                'athome': 'athome'
            };
            
        function resolveFilterCategory(filterValue) {
            if (!filterValue || filterValue === 'all' || filterValue === 'frequent') {
                return 'all';
            }
            return FILTER_CATEGORY_MAP[filterValue] || filterValue;
        }

        function doesProgramMatchCategory(program, targetCategory) {
            if (targetCategory === 'all') return true;
            if (program.category === targetCategory) return true;
            if (program.isParent && Array.isArray(program.subPrograms)) {
                return program.subPrograms.some(subProgram => subProgram.category === targetCategory);
            }
            return false;
        }

        function programMatchesSearch(program, term) {
            if (!term) return true;
            const baseText = `${cleanProgramText(program.name)} ${cleanProgramText(program.location || '')} ${cleanProgramText(program.type || '')} ${cleanProgramText(program.overview || '')}`.toLowerCase();
            if (baseText.includes(term)) {
                return true;
            }
            if (Array.isArray(program.features) && program.features.some(feature => cleanProgramText(feature).toLowerCase().includes(term))) {
                return true;
            }
            if (program.isParent && Array.isArray(program.subPrograms)) {
                return program.subPrograms.some(subProgram => {
                    const subText = `${cleanProgramText(subProgram.name)} ${cleanProgramText(subProgram.location || '')} ${cleanProgramText(subProgram.type || '')} ${(subProgram.features || []).map(feature => cleanProgramText(feature)).join(' ')}`.toLowerCase();
                    return subText.includes(term);
                });
            }
            return false;
        }

        function ensureParentDefaults(program) {
            if (typeof program.expanded === 'undefined') {
                program.expanded = false;
            }
        }

        function buildStandaloneProgramCard(program) {
            const card = document.createElement('div');
            card.className = 'program-card';
            card.dataset.id = program.id;

            const isSelected = selectedPrograms.some(p => p.id === program.id);
            if (isSelected) {
                card.classList.add('primary');
            }

            card.innerHTML = `
                <button class="program-info-btn" onclick="openPreview('${program.id}', event)" title="View Details">i</button>
                ${program.isCustom ? `<button class="program-delete-btn" onclick="deleteProgramFromDatabase('${program.id}', '${program.name.replace(/'/g, "\'")}', event)" title="Delete from Database">√ó</button>` : ''}
                <div class="program-name">${cleanProgramText(program.name)}</div>
                <div class="program-location">${cleanProgramText(program.location || '')}</div>
                <div class="program-type">${cleanProgramText(program.type || '')}</div>
                ${isSelected ? '<div class="program-badge">SELECTED</div>' : ''}
            `;

            card.addEventListener('click', (event) => {
                if (!event.target.classList.contains('program-info-btn') && !event.target.classList.contains('program-delete-btn')) {
                    handleProgramClick(program, card);
                }
            });

            return card;
        }

        function buildSubProgramCard(parentProgram, subProgram) {
            const card = document.createElement('div');
            card.className = 'sub-program-card';
            card.dataset.id = subProgram.id;
            card.style.cursor = 'pointer';

            const isSelected = selectedPrograms.some(p => p.id === subProgram.id);
            if (isSelected) {
                card.classList.add('selected');
            }

            // Add click handler to open profile
            card.addEventListener('click', (event) => {
                // Don't open profile if clicking on toggle button
                if (!event.target.closest('.sub-program-toggle')) {
                    openProgramProfile(subProgram.id, parentProgram.id);
                }
            });

            const header = document.createElement('div');
            header.className = 'sub-program-header';

            const nameEl = document.createElement('div');
            nameEl.className = 'sub-program-name';
            nameEl.innerHTML = `${cleanProgramText(subProgram.name)} <span style="font-size: 11px; color: #94a3b8; margin-left: 8px;">Click for details ‚Üí</span>`;
            header.appendChild(nameEl);

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'sub-program-toggle';
            if (isSelected) {
                toggleBtn.classList.add('selected');
                toggleBtn.textContent = 'Selected';
            } else {
                toggleBtn.textContent = 'Add to Document';
            }
            toggleBtn.addEventListener('click', (event) => handleSubProgramToggle(parentProgram.id, subProgram.id, event));
            header.appendChild(toggleBtn);

            card.appendChild(header);

            const info = document.createElement('div');
            info.className = 'sub-program-info';
            const locationText = cleanProgramText(subProgram.location || parentProgram.location || 'Multiple locations');
            const typeText = cleanProgramText(subProgram.type || '');
            const infoParts = [];
            if (locationText) infoParts.push(`üìç ${locationText}`);
            if (typeText) infoParts.push(typeText);
            info.textContent = infoParts.join(' ‚Ä¢ ');
            card.appendChild(info);

            if (subProgram.programCategory) {
                const badgeRow = document.createElement('div');
                badgeRow.className = 'sub-program-info';
                const badge = document.createElement('span');
                badge.className = 'sub-program-badge';
                badge.textContent = cleanProgramText(subProgram.programCategory);
                badgeRow.appendChild(badge);
                card.appendChild(badgeRow);
            }

            if (Array.isArray(subProgram.features) && subProgram.features.length) {
                const featuresList = document.createElement('ul');
                featuresList.className = 'sub-program-features';
                subProgram.features.slice(0, 3).forEach(feature => {
                    const item = document.createElement('li');
                    item.textContent = cleanProgramText(feature);
                    featuresList.appendChild(item);
                });
                card.appendChild(featuresList);
            }

            if (subProgram.contact && (subProgram.contact.phone || subProgram.contact.website)) {
                const contactRow = document.createElement('div');
                contactRow.className = 'sub-program-info';
                const parts = [];
                if (subProgram.contact.phone) {
                    parts.push(`üìû ${cleanProgramText(subProgram.contact.phone)}`);
                }
                if (subProgram.contact.website) {
                    parts.push(`üîó ${cleanProgramText(subProgram.contact.website)}`);
                }
                contactRow.textContent = parts.join(' ‚Ä¢ ');
                card.appendChild(contactRow);
            }

            return card;
        }

        function buildParentProgramCard(program, targetCategory) {
            ensureParentDefaults(program);
            const card = document.createElement('div');
            card.className = `program-card parent-card${program.expanded ? ' expanded' : ''}`;
            card.dataset.id = program.id;

            card.addEventListener('click', (event) => {
                if (event.target.closest('.parent-expand-btn') || event.target.closest('.sub-program-card') || event.target.closest('.sub-program-toggle')) {
                    return;
                }
                openProgramProfile(program.id);
            });

            const header = document.createElement('div');
            header.className = 'parent-header';

            const title = document.createElement('div');
            title.className = 'parent-title';
            title.innerHTML = `${cleanProgramText(program.name)} <span class="org-badge">ORGANIZATION</span>`;
            header.appendChild(title);

            const expandBtn = document.createElement('button');
            expandBtn.type = 'button';
            expandBtn.className = 'parent-expand-btn';
            expandBtn.innerHTML = `<span class="expand-icon">${program.expanded ? '‚ñ¥' : '‚ñæ'}</span>`;
            expandBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleParentExpansion(program.id, event);
            });
            header.appendChild(expandBtn);

            card.appendChild(header);

            if (Array.isArray(program.tags) && program.tags.length) {
                const tagRow = document.createElement('div');
                tagRow.className = 'parent-tags';
                program.tags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'parent-tag';
                    tagEl.textContent = cleanProgramText(tag);
                    tagRow.appendChild(tagEl);
                });
                card.appendChild(tagRow);
            }

            const meta = document.createElement('div');
            meta.className = 'parent-meta';
            meta.innerHTML = `
                <span>üìç ${cleanProgramText(program.location || 'Multiple locations')}</span>
                <span>üóÇÔ∏è ${program.subPrograms ? program.subPrograms.length : 0} program${program.subPrograms && program.subPrograms.length === 1 ? '' : 's'}</span>
            `;
            card.appendChild(meta);

            if (program.overview) {
                const overview = document.createElement('p');
                overview.className = 'parent-overview';
                overview.textContent = cleanProgramText(program.overview);
                card.appendChild(overview);
            }

            if (!Array.isArray(program.subPrograms) || program.subPrograms.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.style.cssText = 'font-size: 13px; color: #64748b; background: #f8fafc; padding: 12px; border-radius: 10px;';
                emptyState.textContent = 'No location-level programs available for this organization yet.';
                card.appendChild(emptyState);
                return card;
            }

            if (program.expanded) {
                const subContainer = document.createElement('div');
                subContainer.className = 'sub-programs-container';
                const target = resolveFilterCategory(targetCategory);
                const visibleSubs = target === 'all'
                    ? program.subPrograms
                    : program.subPrograms.filter(subProgram => subProgram.category === target);
                const subsToRender = visibleSubs.length > 0 ? visibleSubs : program.subPrograms;
                subsToRender.forEach(subProgram => {
                    subContainer.appendChild(buildSubProgramCard(program, subProgram));
                });
                card.appendChild(subContainer);
            }

            return card;
        }

        function toggleParentExpansion(parentId, event) {
            if (event) event.stopPropagation();
            const parent = programs.find(p => p.id === parentId);
            if (!parent) return;
            ensureParentDefaults(parent);
            parent.expanded = !parent.expanded;
            renderPrograms();
        }

        function handleSubProgramToggle(parentId, subProgramId, event) {
            if (event) event.stopPropagation();
            const parent = programs.find(p => p.id === parentId);
            if (!parent || !Array.isArray(parent.subPrograms)) return;
            const subProgram = parent.subPrograms.find(sp => sp.id === subProgramId);
            if (!subProgram) return;

            const isSelected = selectedPrograms.some(p => p.id === subProgramId);
            if (isSelected) {
                const index = selectedPrograms.findIndex(p => p.id === subProgramId);
                saveUndoAction('remove', { program: subProgram, index });
                selectedPrograms = selectedPrograms.filter(p => p.id !== subProgramId);
            } else {
                const programToAdd = { ...subProgram, parentName: parent.name };
                if (documentType === 'plans' && selectedPrograms.length >= 1) {
                    selectedPrograms = [programToAdd];
                } else {
                    selectedPrograms.push(programToAdd);
                }
                trackProgramUsage(subProgram.id);
                saveUndoAction('add', { program: programToAdd });
            }

            updateSelectionPanel();
            renderPrograms();
        }
        
        // Interactive Profile Modal Functions
        let currentProfileProgram = null;
        let currentProfileParent = null;
        let profileHistory = [];
        
        function openProgramProfile(programId, parentId = null, addToHistory = true) {
            let program = null;
            let parent = null;
            
            const directProgram = programs.find(p => p.id === programId);
            if (directProgram && directProgram.isParent) {
                program = directProgram;
            } else if (parentId) {
                parent = programs.find(p => p.id === parentId);
                if (parent && Array.isArray(parent.subPrograms)) {
                    program = parent.subPrograms.find(sp => sp.id === programId);
                }
            } else {
                program = directProgram;
            }
            
            if (!program) return;
            
            const isParentProgram = !!program.isParent;
            currentProfileProgram = isParentProgram ? null : program;
            currentProfileParent = isParentProgram ? program : parent;
            
            // Manage history
            if (addToHistory) {
                profileHistory.push({ programId, parentId });
            }
            
            // Show/hide navigation
            const navEl = document.getElementById('profileNavigation');
            const breadcrumbEl = document.getElementById('profileBreadcrumb');
            
            if (parent && !isParentProgram) {
                navEl.style.display = 'flex';
                breadcrumbEl.innerHTML = `
                    <span style="opacity: 0.7">${cleanProgramText(parent.name)}</span>
                    <span style="opacity: 0.5">‚Ä∫</span>
                    <span>${cleanProgramText(program.name)}</span>
                `;
            } else {
                navEl.style.display = 'none';
            }
            
            const titleEl = document.getElementById('profileTitle');
            const typeEl = document.getElementById('profileType');
            const locationEl = document.getElementById('profileLocation');
            const tagContainer = document.getElementById('profileTagContainer');
            const overviewEl = document.getElementById('profileOverviewText');
            const featuresSection = document.getElementById('profileFeaturesSection');
            const featuresContainer = document.getElementById('profileFeatures');
            const subSection = document.getElementById('profileSubProgramsSection');
            const subList = document.getElementById('profileSubPrograms');
            const contactSection = document.getElementById('profileContactSection');
            const contactContainer = document.getElementById('profileContactInfo');
            const addBtn = document.getElementById('profileAddBtn');
            const statusEl = document.getElementById('profileStatus');
            
            // Update header
            titleEl.textContent = cleanProgramText(program.name);
            typeEl.textContent = isParentProgram ? 'Parent Organization' : (program.type || 'Treatment Program');
            locationEl.textContent = cleanProgramText(program.location || (isParentProgram ? 'Multi-state network' : 'Location not specified'));
            
            // Tags
            tagContainer.innerHTML = '';
            if (Array.isArray(program.tags) && program.tags.length) {
                tagContainer.style.display = 'flex';
                program.tags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'profile-tag';
                    tagEl.textContent = cleanProgramText(tag);
                    tagContainer.appendChild(tagEl);
                });
            } else {
                tagContainer.style.display = 'none';
            }
            
            // Overview text
            const overviewText = program.overview || (parent && parent.overview ? parent.overview : '');
            if (overviewText) {
                overviewEl.style.display = 'block';
                overviewEl.textContent = cleanProgramText(overviewText);
            } else {
                overviewEl.style.display = 'none';
            }
            
            // Info grid values
            document.getElementById('profileLevelOfCare').textContent = cleanProgramText(
                isParentProgram ? 'Varies by location' : (program.levelOfCare || program.type || 'Not specified')
            );
            document.getElementById('profileCategory').textContent = cleanProgramText(
                program.programCategory || program.category || (isParentProgram ? 'Network' : 'General')
            );
            document.getElementById('profileParentOrg').textContent = isParentProgram
                ? 'Top-level network'
                : (parent ? cleanProgramText(parent.name) : 'Independent');
            
            // Features
            featuresContainer.innerHTML = '';
            if (!isParentProgram && program.features && program.features.length > 0) {
                featuresSection.style.display = 'block';
                program.features.forEach(feature => {
                    const featureEl = document.createElement('div');
                    featureEl.className = 'profile-feature';
                    const cleanFeature = cleanProgramText(feature);
                    if (cleanFeature.includes(':')) {
                        const [label, value] = cleanFeature.split(':');
                        featureEl.innerHTML = `<strong>${label.trim()}:</strong> ${value.trim()}`;
                    } else {
                        featureEl.textContent = cleanFeature;
                    }
                    featuresContainer.appendChild(featureEl);
                });
            } else if (!isParentProgram) {
                featuresSection.style.display = 'block';
                featuresContainer.innerHTML = '<div class="profile-feature">Comprehensive therapeutic services</div>';
            } else {
                featuresSection.style.display = 'none';
            }
            
            // Sub-program listing for parents
            if (isParentProgram) {
                subSection.style.display = 'block';
                subList.innerHTML = '';
                if (Array.isArray(program.subPrograms) && program.subPrograms.length) {
                    program.subPrograms.forEach(subProgram => {
                        const item = document.createElement('div');
                        item.className = 'profile-subprogram-item';
                        item.addEventListener('click', (e) => {
                            if (!e.target.closest('button')) {
                                openProgramProfile(subProgram.id, program.id);
                            }
                        });
                        
                        const title = document.createElement('div');
                        title.className = 'profile-subprogram-title';
                        title.textContent = cleanProgramText(subProgram.name);
                        item.appendChild(title);
                        
                        const meta = document.createElement('div');
                        meta.className = 'profile-subprogram-meta';
                        const subLocation = cleanProgramText(subProgram.location || program.location || 'Multiple locations');
                        const subType = cleanProgramText(subProgram.type || 'Treatment Program');
                        meta.textContent = `${subLocation} ‚Ä¢ ${subType}`;
                        item.appendChild(meta);
                        
                        const actions = document.createElement('div');
                        actions.className = 'profile-subprogram-actions';
                        
                        const viewBtn = document.createElement('button');
                        viewBtn.className = 'profile-view-btn';
                        viewBtn.type = 'button';
                        viewBtn.textContent = 'View profile';
                        viewBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openProgramProfile(subProgram.id, program.id);
                        });
                        actions.appendChild(viewBtn);
                        
                        const inlineAddBtn = document.createElement('button');
                        inlineAddBtn.type = 'button';
                        inlineAddBtn.className = 'profile-add-btn-inline';
                        const subSelected = selectedPrograms.some(p => p.id === subProgram.id);
                        inlineAddBtn.textContent = subSelected ? 'Remove from document' : 'Add to document';
                        if (subSelected) {
                            inlineAddBtn.classList.add('selected');
                        }
                        inlineAddBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            handleSubProgramToggle(program.id, subProgram.id, null);
                            const nowSelected = selectedPrograms.some(p => p.id === subProgram.id);
                            inlineAddBtn.textContent = nowSelected ? 'Remove from document' : 'Add to document';
                            inlineAddBtn.classList.toggle('selected', nowSelected);
                        });
                        actions.appendChild(inlineAddBtn);
                        
                        item.appendChild(actions);
                        subList.appendChild(item);
                    });
                } else {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'profile-feature';
                    emptyMsg.textContent = 'Detailed location information coming soon.';
                    subList.appendChild(emptyMsg);
                }
            } else {
                subSection.style.display = 'none';
                subList.innerHTML = '';
            }
            
            // Contact info
            contactContainer.innerHTML = '';
            if (program.contact) {
                if (program.contact.phone) {
                    const phoneEl = document.createElement('div');
                    phoneEl.className = 'profile-contact-item';
                    phoneEl.innerHTML = `
                        <span class="profile-contact-icon">üìû</span>
                        <span>${program.contact.phone}</span>
                    `;
                    contactContainer.appendChild(phoneEl);
                }
                if (program.contact.email) {
                    const emailEl = document.createElement('div');
                    emailEl.className = 'profile-contact-item';
                    emailEl.innerHTML = `
                        <span class="profile-contact-icon">‚úâÔ∏è</span>
                        <span>${program.contact.email}</span>
                    `;
                    contactContainer.appendChild(emailEl);
                }
                if (program.contact.website) {
                    const websiteEl = document.createElement('div');
                    websiteEl.className = 'profile-contact-item';
                    websiteEl.innerHTML = `
                        <span class="profile-contact-icon">üåê</span>
                        <a href="${program.contact.website}" target="_blank" style="color: #667eea; text-decoration: none;">
                            ${program.contact.website.replace(/^https?:\/\//, '')}
                        </a>
                    `;
                    contactContainer.appendChild(websiteEl);
                }
            }
            if (contactContainer.children.length === 0) {
                contactContainer.innerHTML = '<div class="profile-contact-item">Contact information not available</div>';
            }
            contactSection.style.display = contactContainer.children.length ? 'block' : 'none';
            
            if (isParentProgram) {
                addBtn.style.display = 'none';
                addBtn.classList.remove('added');
                addBtn.textContent = 'Add to Document';
                statusEl.textContent = 'Select a location below to view details or add to the document.';
            } else {
                addBtn.style.display = 'inline-flex';
                const isSelected = selectedPrograms.some(p => p.id === programId);
                if (isSelected) {
                    addBtn.textContent = 'Remove from Document';
                    addBtn.classList.add('added');
                    statusEl.textContent = '‚úÖ This program is in your document';
                } else {
                    addBtn.textContent = 'Add to Document';
                    addBtn.classList.remove('added');
                    statusEl.textContent = 'Click "Add to Document" to include in aftercare plan';
                }
            }
            
            // Show modal
            document.getElementById('programProfileModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeProgramProfile() {
            document.getElementById('programProfileModal').classList.remove('active');
            document.body.style.overflow = '';
            currentProfileProgram = null;
            currentProfileParent = null;
            profileHistory = [];
            const addBtn = document.getElementById('profileAddBtn');
            if (addBtn) {
                addBtn.style.display = '';
            }
        }
        
        function navigateBack() {
            if (profileHistory.length > 1) {
                profileHistory.pop(); // Remove current
                const prev = profileHistory[profileHistory.length - 1];
                if (prev) {
                    openProgramProfile(prev.programId, prev.parentId, false);
                }
            } else if (currentProfileParent && currentProfileProgram) {
                // Go back to parent
                openProgramProfile(currentProfileParent.id, null, false);
            }
        }
        
        function toggleProgramFromProfile() {
            if (!currentProfileProgram) return;
            
            const programId = currentProfileProgram.id;
            const parentId = currentProfileParent ? currentProfileParent.id : null;
            
            if (parentId) {
                handleSubProgramToggle(parentId, programId, null);
            } else {
                // Handle standalone program toggle
                const program = programs.find(p => p.id === programId);
                if (program) {
                    const isSelected = selectedPrograms.some(p => p.id === programId);
                    if (isSelected) {
                        const index = selectedPrograms.findIndex(p => p.id === programId);
                        saveUndoAction('remove', { program, index });
                        selectedPrograms = selectedPrograms.filter(p => p.id !== programId);
                    } else {
                        if (documentType === 'plans' && selectedPrograms.length >= 1) {
                            selectedPrograms = [program];
                        } else {
                            selectedPrograms.push(program);
                        }
                        trackProgramUsage(program.id);
                        saveUndoAction('add', { program });
                    }
                    updateSelectionPanel();
                    renderPrograms();
                }
            }
            
            // Update button state in modal
            const isNowSelected = selectedPrograms.some(p => p.id === programId);
            const addBtn = document.getElementById('profileAddBtn');
            const statusEl = document.getElementById('profileStatus');
            
            if (isNowSelected) {
                addBtn.textContent = 'Remove from Document';
                addBtn.classList.add('added');
                statusEl.textContent = '‚úÖ This program is in your document';
            } else {
                addBtn.textContent = 'Add to Document';
                addBtn.classList.remove('added');
                statusEl.textContent = 'Click "Add to Document" to include in aftercare plan';
            }
        }
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('programProfileModal').classList.contains('active')) {
                closeProgramProfile();
            }
        });
        
        // Close modal on background click
        document.getElementById('programProfileModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProgramProfile();
            }
        });
        
        // Get filtered programs based on current filter
        function getFilteredPrograms(basePrograms) {
            const list = basePrograms || programs;
            const targetCategory = resolveFilterCategory(currentFilter);
            return list.filter(program => doesProgramMatchCategory(program, targetCategory));
        }
        
        // Render programs
        function renderPrograms(programsToRender = null) {
            const grid = document.getElementById('programGrid');
            if (!grid) {
                console.error('programGrid element not found!');
                alert('Error: Program grid not found. Please refresh the page.');
                return;
            }
            
            // Use provided programs or fall back to filtered programs
            const targetCategory = resolveFilterCategory(currentFilter);
            const baseList = programsToRender || programs;
            const filteredList = getFilteredPrograms(baseList).filter(program => programMatchesSearch(program, currentSearchTerm));
            const programList = filteredList;
            console.log('Rendering', programList.length, 'programs');
            
            // Clear and ensure grid is visible
            grid.innerHTML = '';
            grid.style.display = 'grid';
            
            // Show message if no programs
            if (programList.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No programs found. Try adjusting your filters.</div>';
                const indicator = document.getElementById('searchIndicator');
                if (indicator && currentSearchTerm) {
                    indicator.innerHTML = '‚ùå No programs found';
                    indicator.classList.remove('search-animation');
                    indicator.style.display = 'block';
                    indicator.style.opacity = '1';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                        indicator.style.opacity = '0';
                    }, 2000);
                }
                return;
            }
            
            // Show recently used programs
            showRecentlyUsedPrograms().catch(console.error);
            
            programList.forEach(program => {
                if (program.isParent) {
                    grid.appendChild(buildParentProgramCard(program, targetCategory));
                } else {
                    grid.appendChild(buildStandaloneProgramCard(program));
                }
            });

            const indicator = document.getElementById('searchIndicator');
            if (indicator && currentSearchTerm) {
                indicator.classList.remove('search-animation');
                indicator.innerHTML = `‚úÖ ${programList.length} program${programList.length === 1 ? '' : 's'} found`;
                indicator.style.display = 'block';
                indicator.style.opacity = '1';
                setTimeout(() => {
                    indicator.style.display = 'none';
                    indicator.style.opacity = '0';
                }, 2000);
            }
        }



        function wizardSetStep(step) {
            wizardState.currentStep = step;
            const labels = {
                1: 'Client Setup',
                2: 'Program Picks',
                3: 'Review & Apply'
            };

            const indicators = [1, 2, 3];
            indicators.forEach(index => {
                const stepEl = document.getElementById(`wizardStep${index}`);
                const indicatorEl = document.getElementById(`wizardStepIndicator${index}`);
                if (stepEl) {
                    stepEl.classList.toggle('active', index === step);
                }
                if (indicatorEl) {
                    indicatorEl.classList.toggle('active', index <= step);
                }
            });

            const labelEl = document.getElementById('wizardStepLabel');
            if (labelEl) {
                labelEl.textContent = labels[step] || '';
            }

            const backBtn = document.querySelector('.wizard-back');
            if (backBtn) {
                backBtn.disabled = step === 1;
                backBtn.style.visibility = step === 1 ? 'hidden' : 'visible';
            }

            const nextBtn = document.getElementById('wizardNextButton');
            const finishBtn = document.getElementById('wizardFinishButton');

            if (nextBtn) {
                nextBtn.style.display = step === 3 ? 'none' : 'inline-flex';
            }

            if (finishBtn) {
                finishBtn.style.display = step === 3 ? 'inline-flex' : 'none';
            }
        }

        function wizardNextStep() {
            if (wizardState.currentStep === 1) {
                const wizardClientInput = document.getElementById('wizardClientName');
                if (wizardClientInput && !wizardClientInput.value.trim()) {
                    wizardClientInput.classList.add('input-error');
                    wizardClientInput.focus();
                    return;
                }
            }

            const nextStep = Math.min(3, wizardState.currentStep + 1);
            if (nextStep === 2) {
                renderWizardPrograms();
            }
            if (nextStep === 3) {
                updateWizardSummary();
            }

            wizardSetStep(nextStep);
        }

        function wizardPrevStep() {
            const prevStep = Math.max(1, wizardState.currentStep - 1);
            wizardSetStep(prevStep);
            if (prevStep === 3) {
                updateWizardSummary();
            }
        }

        function filterWizardPrograms(term) {
            wizardState.searchTerm = (term || '').toLowerCase();
            renderWizardPrograms();
        }

        function renderWizardPrograms() {
            const container = document.getElementById('wizardProgramList');
            if (!container) return;

            const term = wizardState.searchTerm.trim();
            const results = programs.filter(program => {
                if (!term) return true;
                const haystack = `${program.name} ${program.location} ${program.type} ${program.programCategory || ''} ${program.levelOfCare || ''}`.toLowerCase();
                return haystack.includes(term);
            }).slice(0, 60);

            if (results.length === 0) {
                container.innerHTML = '<div class="wizard-no-results">No programs match that search yet. Try a different keyword.</div>';
                return;
            }

            container.innerHTML = '';

            results.forEach(program => {
                const isSelected = wizardState.selectedProgramIds.has(program.id);
                const item = document.createElement('label');
                item.className = `wizard-program-item${isSelected ? ' active' : ''}`;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = isSelected;
                checkbox.addEventListener('change', (event) => {
                    toggleWizardProgram(program.id, event.target.checked);
                    if (event.target.checked) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                const meta = document.createElement('div');
                meta.className = 'wizard-program-meta';
                meta.innerHTML = `
                    <div class="name">${program.name}</div>
                    <div class="location">${program.location}</div>
                    <div class="chips">
                        <span class="chip">${program.type}</span>
                        ${program.levelOfCare ? `<span class="chip">${program.levelOfCare}</span>` : ''}
                    </div>
                `;

                item.appendChild(checkbox);
                item.appendChild(meta);
                container.appendChild(item);
            });
        }

        function toggleWizardProgram(programId, isChecked) {
            if (isChecked) {
                wizardState.selectedProgramIds.add(programId);
            } else {
                wizardState.selectedProgramIds.delete(programId);
            }
            updateWizardSummary();
        }

        function updateWizardSummary() {
            const nameEl = document.getElementById('wizardSummaryName');
            const atHomeEl = document.getElementById('wizardSummaryAtHome');
            const alumniEl = document.getElementById('wizardSummaryAlumni');
            const listEl = document.getElementById('wizardSummaryPrograms');
            const wizardClientInput = document.getElementById('wizardClientName');
            const wizardAtHomeCheckbox = document.getElementById('wizardIncludeAtHome');
            const wizardAlumniCheckbox = document.getElementById('wizardIncludeAlumni');

            if (nameEl && wizardClientInput) {
                const name = wizardClientInput.value.trim();
                nameEl.textContent = name || '‚Äî';
            }

            if (atHomeEl && wizardAtHomeCheckbox) {
                atHomeEl.textContent = wizardAtHomeCheckbox.checked ? 'Yes' : 'No';
            }

            if (alumniEl && wizardAlumniCheckbox) {
                alumniEl.textContent = wizardAlumniCheckbox.checked ? 'Yes' : 'No';
            }

            if (listEl) {
                listEl.innerHTML = '';
                const summaryPrograms = programs.filter(program => wizardState.selectedProgramIds.has(program.id));
                if (summaryPrograms.length === 0) {
                    listEl.innerHTML = '<li style="color: #6b7280;">No programs selected yet</li>';
                } else {
                    summaryPrograms.forEach(program => {
                        const li = document.createElement('li');
                        li.textContent = `${program.name} ‚Äî ${program.location}`;
                        listEl.appendChild(li);
                    });
                }
            }
        }

        function wizardFinish() {
            const wizardClientInput = document.getElementById('wizardClientName');
            if (wizardClientInput && !wizardClientInput.value.trim()) {
                wizardClientInput.classList.add('input-error');
                wizardClientInput.focus();
                return;
            }

            const mainClientInput = document.getElementById('clientName');
            const wizardAtHomeCheckbox = document.getElementById('wizardIncludeAtHome');
            const wizardAlumniCheckbox = document.getElementById('wizardIncludeAlumni');
            const mainAtHome = document.getElementById('includeAtHome');
            const mainAlumni = document.getElementById('includeAlumni');

            if (mainClientInput && wizardClientInput) {
                mainClientInput.value = wizardClientInput.value.trim();
            }

            if (mainAtHome && wizardAtHomeCheckbox) {
                mainAtHome.checked = wizardAtHomeCheckbox.checked;
                toggleAtHomeSection();
            }

            if (mainAlumni && wizardAlumniCheckbox) {
                mainAlumni.checked = wizardAlumniCheckbox.checked;
            }

            const updatedSelection = programs.filter(program => wizardState.selectedProgramIds.has(program.id));
            selectedPrograms = updatedSelection;

            updateSelectionPanel();
            renderPrograms();
            updateWizardSummary();
            closeIntakeWizard();
            showSuccessMessage('Wizard selections applied to builder.');
        }
        
        // Track program usage for frequently used
        function trackProgramUsage(programId) {
            const usage = JSON.parse(localStorage.getItem('programUsage') || '{}');
            usage[programId] = (usage[programId] || 0) + 1;
            localStorage.setItem('programUsage', JSON.stringify(usage));
        }
        
        // Get frequently used programs
        function getFrequentlyUsedPrograms(limit = 10) {
            const usage = JSON.parse(localStorage.getItem('programUsage') || '{}');
            return Object.entries(usage)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit)
                .map(([id]) => programs.find(p => p.id === id))
                .filter(Boolean);
        }
        
        // Save action for undo
        function saveUndoAction(type, data) {
            lastAction = { type, data, timestamp: Date.now() };
        }
        
        // Undo last action
        function undoLastAction() {
            if (!lastAction) return;
            
            const { type, data } = lastAction;
            
            switch (type) {
                case 'add':
                    // Remove the program that was added
                    selectedPrograms = selectedPrograms.filter(p => p.id !== data.program.id);
                    break;
                case 'remove':
                    // Re-add the program that was removed
                    selectedPrograms.splice(data.index, 0, data.program);
                    break;
                case 'reorder':
                    // Restore original order
                    selectedPrograms = [...data.originalOrder];
                    break;
                case 'clear':
                    // Restore all cleared programs
                    selectedPrograms = [...data.programs];
                    break;
            }
            
            lastAction = null;
            updateSelectionPanel();
            renderPrograms();
            showNotification('‚Ü∂ Undone', 'info');
        }
        
        // Handle program clicks - now opens interactive profile
        function handleProgramClick(program, card) {
            // Open the interactive profile instead of direct selection
            openProgramProfile(program.id);
        }
        
        // Legacy direct selection function (kept for compatibility if needed)
        function directProgramSelection(program, card) {
            const isSelected = selectedPrograms.some(p => p.id === program.id);
            
            if (isSelected) {
                // Check if this is a duplicate (same program added twice)
                const duplicateCount = selectedPrograms.filter(p => p.id === program.id).length;
                if (duplicateCount > 1) {
                    // This is a duplicate, confirm removal
                    if (!confirm(`"${program.name}" appears ${duplicateCount} times in your selection. Remove this instance?`)) {
                        return;
                    }
                }
                
                // Remove from selection
                const index = selectedPrograms.findIndex(p => p.id === program.id);
                saveUndoAction('remove', { program, index });
                selectedPrograms = selectedPrograms.filter(p => p.id !== program.id);
                card.classList.remove('primary');
                const badge = card.querySelector('.program-badge');
                if (badge) badge.remove();
            } else {
                // Check if trying to add a duplicate
                if (selectedPrograms.some(p => p.id === program.id)) {
                    if (!confirm(`"${program.name}" is already in your selection. Add it again?`)) {
                        return;
                    }
                }
                
                // Add to selection
                if (documentType === 'plans' && selectedPrograms.length >= 1) {
                    // For plans, replace the existing selection
                    selectedPrograms = [program];
                    // Update all cards
                    renderPrograms();
                } else {
                    selectedPrograms.push(program);
                    trackProgramUsage(program.id); // Track usage
                    saveUndoAction('add', { program });
                    card.classList.add('primary');
                    
                    const badge = document.createElement('div');
                    badge.className = 'program-badge';
                    badge.textContent = 'SELECTED';
                    card.appendChild(badge);
                }
            }
            
            updateSelectionPanel();
        }
        
        // Open preview modal
        function openPreview(programId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const program = programs.find(p => p.id === programId);
            if (!program) return;
            
            currentPreviewProgram = program;
            const modal = document.getElementById('previewModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalAddBtn = document.getElementById('modalAddBtn');
            
            // Update modal title
            modalTitle.textContent = `${program.name} - ${program.location}`;
            
            // Generate modal content
            let content = `
                <div class="preview-section">
                    <h3>Program Type</h3>
                    <p>${program.type}</p>
                    <p><strong>Category:</strong> ${program.programCategory}</p>
                </div>
                
                <div class="preview-section">
                    <h3>Level of Care & Services</h3>
                    <p>${program.levelOfCare}</p>
                </div>
                
                <div class="preview-section">
                    <h3>Program Features</h3>
                    <ul class="preview-features">
            `;
            
            program.features.forEach(feature => {
                const parts = feature.split(':');
                if (parts.length > 1) {
                    content += `<li><strong>${parts[0]}:</strong>${parts[1]}</li>`;
                } else {
                    content += `<li>${feature}</li>`;
                }
            });
            
            content += `
                    </ul>
                </div>
                
                <div class="preview-section">
                    <h3>Contact Information</h3>
                    <div class="preview-contact">
            `;
            
            if (program.contact.phone) {
                content += `<div><strong>Phone:</strong> ${program.contact.phone}</div>`;
            }
            if (program.contact.website) {
                const w = normalizeUrl(program.contact.website);
                const label = program.contact.website;
                content += `<div><strong>Website:</strong> <a href="${w}" target="_blank" rel="noopener">${label}</a></div>`;
            }
            if (program.contact.email) {
                content += `<div><strong>Email:</strong> ${program.contact.email}</div>`;
            }
            if (program.contact.address) {
                content += `<div><strong>Address:</strong> ${program.contact.address}</div>`;
            }
            
            content += `
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = content;
            
            // Update add button state
            const isSelected = selectedPrograms.some(p => p.id === programId);
            if (isSelected) {
                modalAddBtn.textContent = 'Remove from Selection';
                modalAddBtn.classList.add('selected');
            } else {
                modalAddBtn.textContent = 'Add to Selection';
                modalAddBtn.classList.remove('selected');
            }
            
            // Show modal
            modal.style.display = 'block';
        }
        
        // Close preview modal
        function closePreview() {
            const modal = document.getElementById('previewModal');
            modal.style.display = 'none';
            currentPreviewProgram = null;
        }
        
        // Toggle program from preview
        function toggleFromPreview() {
            if (!currentPreviewProgram) return;
            
            const isSelected = selectedPrograms.some(p => p.id === currentPreviewProgram.id);
            
            if (isSelected) {
                // Remove from selection
                selectedPrograms = selectedPrograms.filter(p => p.id !== currentPreviewProgram.id);
            } else {
                // Add to selection
                if (documentType === 'plans' && selectedPrograms.length >= 1) {
                    selectedPrograms = [currentPreviewProgram];
                } else {
                    selectedPrograms.push(currentPreviewProgram);
                }
            }
            
            // Update UI
            updateSelectionPanel();
            renderPrograms();
            
            // Update modal button
            const modalAddBtn = document.getElementById('modalAddBtn');
            if (!isSelected) {
                modalAddBtn.textContent = 'Remove from Selection';
                modalAddBtn.classList.add('selected');
            } else {
                modalAddBtn.textContent = 'Add to Selection';
                modalAddBtn.classList.remove('selected');
            }
        }
        
        // Show add custom program modal
        function showAddProgramDialog() {
            const modal = document.getElementById('addProgramModal');
            if (modal) {
                modal.style.display = 'block';
                modal.classList.add('show');
                // Default to manual mode
                setAddProgramMode('manual');
                // Ensure the button is visible
                setTimeout(() => {
                    const smartBtn = document.getElementById('smartFormatBtn');
                    if (smartBtn) {
                        smartBtn.style.display = 'inline-block';
                    }
                }, 100);
            }
        }
        
        // Set the mode for adding programs
        function setAddProgramMode(mode) {
            const manualBtn = document.getElementById('manualModeBtn');
            const templateBtn = document.getElementById('templateModeBtn');
            const manualContent = document.getElementById('manualModeContent');
            const templateContent = document.getElementById('templateModeContent');
            const smartBtn = document.getElementById('smartFormatBtn');
            const addTemplateBtn = document.getElementById('addTemplateBtn');
            
            // Reset all buttons
            manualBtn.style.background = '#e5e7eb';
            manualBtn.style.color = '#6b7280';
            templateBtn.style.background = '#e5e7eb';
            templateBtn.style.color = '#6b7280';
            
            // Hide all content
            manualContent.style.display = 'none';
            templateContent.style.display = 'none';
            
            // Hide all action buttons
            smartBtn.style.display = 'none';
            addTemplateBtn.style.display = 'none';
            
            if (mode === 'manual') {
                // Manual Mode
                manualBtn.style.background = '#4f46e5';
                manualBtn.style.color = 'white';
                manualContent.style.display = 'block';
                if (smartBtn) smartBtn.style.display = 'inline-block';
                const textarea = document.getElementById('customProgramInfo');
                if (textarea) textarea.focus();
            } else if (mode === 'template') {
                // Template Mode
                templateBtn.style.background = '#4f46e5';
                templateBtn.style.color = 'white';
                templateContent.style.display = 'block';
                if (addTemplateBtn) addTemplateBtn.style.display = 'inline-block';
                const nameInput = document.getElementById('templateName');
                if (nameInput) nameInput.focus();
            }
        }
        
        // Update progress tracker
        function updateProgress(step, status, message, time) {
            const stepEl = document.getElementById(`step${step}`);
            if (!stepEl) return;
            
            const icon = stepEl.querySelector('.step-icon');
            const text = stepEl.querySelector('.step-text');
            const timeEl = stepEl.querySelector('.step-time');
            
            stepEl.style.opacity = '1';
            
            if (status === 'working') {
                icon.innerHTML = '‚è≥';
                icon.style.animation = 'spin 1s linear infinite';
            } else if (status === 'done') {
                icon.innerHTML = '‚úÖ';
                icon.style.animation = 'none';
                if (time) timeEl.innerHTML = time;
            } else if (status === 'error') {
                icon.innerHTML = '‚ùå';
                icon.style.animation = 'none';
                stepEl.style.color = '#ff6b6b';
            }
            
            if (message) text.innerHTML = message;
        }
        
        // Add log to progress details
        function addProgressLog(message) {
            const details = document.getElementById('progressDetails');
            details.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            details.innerHTML += `[${timestamp}] ${message}\n`;
            details.scrollTop = details.scrollHeight;
        }
        
        // Close add program modal
        function closeAddProgramModal() {
            const modal = document.getElementById('addProgramModal');
            if (modal) {
                modal.classList.remove('show');
                // Also try setting display none as fallback
                modal.style.display = 'none';
                // Clear the form
                document.getElementById('customProgramInfo').value = '';
                // Reset any status messages
                const statusDiv = document.getElementById('customProgramStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = '';
                }
            }
        }
        
        // Add custom program to selection
        // New unified extraction function
        async function extractProgram() {
            const aiContent = document.getElementById('aiModeContent');
            const isAIMode = aiContent.style.display !== 'none';
            
            if (isAIMode) {
                // AI Mode - extract from URL
                const url = document.getElementById('programUrl').value.trim();
                if (!url) {
                    alert('Please enter a website URL');
                    return;
                }
                
                // Show progress tracker
                const tracker = document.getElementById('aiProgressTracker');
                tracker.style.display = 'block';
                document.getElementById('progressDetails').innerHTML = '';
                document.getElementById('progressError').style.display = 'none';
                
                // Reset all steps
                for (let i = 1; i <= 4; i++) {
                    updateProgress(i, 'pending', null, '');
                }
                
                const startTime = Date.now();
                
                try {
                    // Step 1: Validate URL
                    updateProgress(1, 'working', 'Validating URL format...');
                    addProgressLog('Starting URL validation...');
                    
                    if (!url.match(/^https?:\/\/.+/)) {
                        throw new Error('Invalid URL format. Please include http:// or https://');
                    }
                    
                    updateProgress(1, 'done', 'URL validated', `${Date.now() - startTime}ms`);
                    addProgressLog(`‚úì Valid URL: ${url}`);
                    
                    // Step 2: Deep website analysis
                    updateProgress(2, 'working', 'Analyzing website pages...');
                    addProgressLog('Starting deep website crawl and analysis...');
                    
                    const programName = url.split('/')[2].replace('www.', '').replace('.com', '').replace('.org', '');
                    
                    // Make addProgressLog available globally for nested functions
                    window.addProgressLog = addProgressLog;
                    window.updateProgress = updateProgress;
                    
                    // Simulate deep crawling with progress updates
                    const crawlPages = [
                        'Homepage', 'About Us', 'Clinical Program', 'Admissions',
                        'Academic Program', 'Staff & Credentials', 'Parent Resources',
                        'Treatment Approach', 'Daily Schedule', 'Contact Information'
                    ];
                    
                    // Show crawling progress
                    for (let i = 0; i < crawlPages.length; i++) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        addProgressLog(`üìÑ Analyzing: ${crawlPages[i]}...`);
                        updateProgress(2, 'working', `Analyzing ${crawlPages[i]}... (${i+1}/${crawlPages.length})`);
                    }
                    
                    const websiteData = await analyzeWebsiteUrl(url, programName);
                    
                    if (websiteData) {
                        updateProgress(2, 'done', 'Website content retrieved', `${Date.now() - startTime}ms`);
                        addProgressLog('‚úì Successfully fetched website content');
                        
                        // Step 3: AI Analysis
                        updateProgress(3, 'working', 'Analyzing with AI model...');
                        addProgressLog('Sending to AI for analysis...');
                        
                        // Step 4: Format data
                        updateProgress(4, 'working', 'Formatting program data...');
                        
                        if (websiteData.Confidence && websiteData.Confidence !== 'low') {
                            updateProgress(3, 'done', 'AI analysis complete', `${Date.now() - startTime}ms`);
                            updateProgress(4, 'done', 'Data formatted successfully', `${Date.now() - startTime}ms`);
                            addProgressLog('‚úì Program data extracted successfully!');
                            
                            // Show preview
                            showAIPreview(websiteData, websiteData.Confidence || 'medium', url);
                        } else {
                            updateProgress(3, 'done', 'AI analysis complete (low confidence)');
                            updateProgress(4, 'done', 'Manual review recommended');
                            addProgressLog('‚ö† Low confidence - manual review recommended');
                            showHybridOption(websiteData, url);
                        }
                    } else {
                        updateProgress(2, 'error', 'Failed to fetch website');
                        addProgressLog('‚úó Failed to fetch website content');
                        
                        // AI extraction has been disabled for security
                        updateProgress(3, 'error', 'AI extraction disabled');
                        updateProgress(4, 'error', 'Use manual entry');
                            
                            document.getElementById('progressError').style.display = 'block';
                            document.getElementById('progressError').innerHTML = `
                                <div style="padding: 10px;">
                                <strong>‚ö†Ô∏è AI Extraction Disabled</strong><br>
                                <p style="margin: 10px 0;">For security, AI extraction has been disabled. Please use manual entry.</p>
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <button onclick="setAddProgramMode('manual')" style="background: white; color: #667eea; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                                            ‚úçÔ∏è Switch to Manual Entry
                                        </button>
                                    </div>
                                    </div>
                                `;
                        // AI analysis removed - use manual entry
                    }
                } catch (error) {
                    console.error('Extraction error:', error);
                    updateProgress(1, 'error', error.message);
                    document.getElementById('progressError').style.display = 'block';
                    document.getElementById('progressError').innerHTML = error.message;
                    addProgressLog(`‚úó Error: ${error.message}`);
                }
            } else {
                // Check which mode we're in
                const manualContent = document.getElementById('manualModeContent');
                const templateContent = document.getElementById('templateModeContent');
                
                if (manualContent.style.display !== 'none') {
                    // Manual Mode - use existing addCustomProgram logic
                    await addCustomProgram();
                } else if (templateContent.style.display !== 'none') {
                    // Template Mode - collect form data
                    await addTemplateProgram();
                }
            }
        }
        
        // Add custom program from user input (now used for manual mode)
        async function addCustomProgram() {
            const programInfo = document.getElementById('customProgramInfo').value;
            const clientName = document.getElementById('clientName').value;
            
            if (!programInfo) {
                alert('Please paste program information!');
                return;
            }
            
            // Show loading state
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = 'üîÑ Processing program information...';
            statusDiv.style.color = '#0099cc';
            
                // AI extraction has been disabled for security
                // Go directly to manual/hybrid entry
                    statusDiv.innerHTML = `
                    <div style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; padding: 15px; margin: 10px 0;">
                        <div style="color: #374151; font-weight: bold; margin-bottom: 10px;">üìù Manual Entry Required</div>
                        <div style="color: #6b7280; margin-bottom: 10px;">For security, AI extraction has been disabled. Please use the manual entry form.</div>
                        
                        <button onclick="showHybridTool(document.getElementById('customProgramInfo').value, false)" style="background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            ‚úçÔ∏è Continue with Manual Entry
                        </button>
                        </div>
                    `;
                    return;
        }
        
        // Add template-based program
        async function addTemplateProgram() {
            // Collect all form data
            const programData = {
                'Program Name': document.getElementById('templateName').value.trim(),
                'Location': document.getElementById('templateLocation').value.trim(),
                'Phone Number': document.getElementById('templatePhone').value.trim(),
                'Email': document.getElementById('templateEmail').value.trim(),
                'Level of Care': document.getElementById('templateLevel').value.trim(),
                'Age Range': document.getElementById('templateAges').value.trim(),
                'Primary Issues Treated': document.getElementById('templateSpecialties').value.trim(),
                'Specialized Therapies': document.getElementById('templateModalities').value.trim(),
                'Insurance Accepted': document.getElementById('templateInsurance').value.trim(),
                'Program Philosophy': document.getElementById('templateDescription').value.trim(),
                'Website': document.getElementById('templateWebsite').value.trim()
            };
            
            // Validate required fields
            if (!programData['Program Name']) {
                alert('Please enter the program name');
                return;
            }
            
            // Format the extracted data in the same format as AI extraction
            const formattedData = `
**THERAPEUTIC SCHOOL PROFILE**
**${programData['Program Name'].toUpperCase()}**

**PROGRAM OVERVIEW:**
Program Name: ${programData['Program Name']}
Location: ${programData['Location'] || 'Not specified'}
Phone Number: ${programData['Phone Number'] || 'Not specified'}
Email: ${programData['Email'] || 'Not specified'}
Website: ${programData['Website'] || 'Not specified'}
Level of Care: ${programData['Level of Care'] || 'Not specified'}

**TARGET POPULATION:**
Age Range: ${programData['Age Range'] || 'Not specified'}

**CLINICAL SERVICES:**
Primary Issues Treated: ${programData['Primary Issues Treated'] || 'Not specified'}
Specialized Therapies: ${programData['Specialized Therapies'] || 'Not specified'}

**PROGRAM DETAILS:**
${programData['Program Philosophy'] || 'No description provided'}

**INSURANCE & PAYMENT:**
${programData['Insurance Accepted'] || 'Not specified'}

---

*Profile compiled for educational consultant review. All information should be verified directly with the program.*
`;
            
            // Show the formatted result
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 16px;">‚úÖ</span>
                        <strong style="margin-left: 8px; color: #16a34a;">Program Formatted Successfully!</strong>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
${formattedData.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="
                            navigator.clipboard.writeText(\`${formattedData.replace(/`/g, '\\`')}\`).then(() => {
                                alert('Program profile copied to clipboard!');
                            });
                        " style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üìã Copy to Clipboard
                        </button>
                        <button onclick="
                            // Set the extracted data in the correct format
                            window.currentAIExtraction = ${JSON.stringify(programData)};
                            acceptAIExtraction();
                        " style="background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ‚ûï Add to Selection
                        </button>
                        <button onclick="document.getElementById('addProgramModal').style.display='none';" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Smart Format - Pattern-based extraction without AI
        async function smartFormatProgram() {
            let programInfo = document.getElementById('customProgramInfo').value.trim();
            
            if (!programInfo) {
                alert('Please paste program information!');
                return;
            }
            
            // Strip out any "ADDITIONAL DETAILS FROM WEBSITE" sections
            programInfo = programInfo.replace(/\*\*ADDITIONAL DETAILS FROM WEBSITE:\*\*[\s\S]*$/i, '');
            programInfo = programInfo.replace(/ADDITIONAL DETAILS FROM WEBSITE:[\s\S]*$/i, '');
            programInfo = programInfo.replace(/From [A-Z].*? Page:[\s\S]*?(?=\n\n|$)/gi, '');
            programInfo = programInfo.trim();
            
            // Show processing status
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = 'üîç Analyzing and formatting program information...';
            statusDiv.style.color = '#0099cc';
            
            // Extract information using patterns
            const extractedData = extractProgramInfoSmart(programInfo);
            
            // Format according to Family First structure
            const formattedOutput = formatToFamilyFirstStructure(extractedData);
            
            // Show the formatted result
            statusDiv.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 16px;">‚úÖ</span>
                        <strong style="margin-left: 8px; color: #16a34a;">Program Formatted Successfully!</strong>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; margin: 10px 0; font-family: 'Calibri', sans-serif; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
${formattedOutput.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="
                            navigator.clipboard.writeText(\`${formattedOutput.replace(/`/g, '\\`').replace(/'/g, "\'")}\`).then(() => {
                                alert('Program profile copied to clipboard!');
                            });
                        " style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üìã Copy to Clipboard
                        </button>
                        <button onclick="
                            // Convert formatted text to structured data for document addition
                            const data = ${JSON.stringify(extractedData).replace(/"/g, '&quot;')};
                            window.currentAIExtraction = data;
                            acceptAIExtraction();
                        " style="background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ‚ûï Add to Selection
                        </button>
                        <button onclick="document.getElementById('addProgramModal').style.display='none';" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Smart extraction using patterns (no AI needed)
        function extractProgramInfoSmart(text) {
            const data = {};
            
            // Clean up markdown formatting from Chrome extension
            text = text.replace(/\*\*/g, ''); // Remove bold markers
            text = text.replace(/\n\s*\n/g, '\n'); // Remove extra blank lines
            
            // Check if this is Chrome extension formatted data
            const hasExtensionFormat = text.includes('TARGET POPULATION:') || 
                                      text.includes('CLINICAL SERVICES:') || 
                                      text.includes('ACCREDITATIONS:');
            
            if (hasExtensionFormat) {
                // Parse Chrome extension sections
                const sections = {
                    'TARGET POPULATION': /TARGET POPULATION:\s*([^A-Z]+(?:\n(?![A-Z]+:)[^\n]+)*)/,
                    'CLINICAL SERVICES': /CLINICAL SERVICES:\s*([^A-Z]+(?:\n(?![A-Z]+:)[^\n]+)*)/,
                    'ACCREDITATIONS': /ACCREDITATIONS:\s*([^A-Z]+(?:\n(?![A-Z]+:)[^\n]+)*)/,
                    'WHAT MAKES': /WHAT MAKES THIS PROGRAM UNIQUE:\s*([^A-Z]+(?:\n(?![A-Z]+:)[^\n]+)*)/
                };
                
                for (const [key, pattern] of Object.entries(sections)) {
                    const match = text.match(pattern);
                    if (match && match[1]) {
                        data[key] = match[1].trim();
                    }
                }
            }
            
            // Extract program philosophy or mission statement
            const philosophyPatterns = [
                /(?:our mission|we believe|our philosophy|our approach)[:.]?\s*([^.]+\.)/i,
                /(?:committed to|dedicated to|focused on)\s+([^.]+\.)/i
            ];
            for (const pattern of philosophyPatterns) {
                const match = text.match(pattern);
                if (match) {
                    data['Philosophy'] = match[1].trim();
                    break;
                }
            }
            
            // Extract unique program elements
            const programElements = [];
            if (/small group/i.test(text)) programElements.push('small group sizes');
            if (/gender[- ]specific/i.test(text)) programElements.push('gender-specific programming');
            if (/co[- ]ed/i.test(text)) programElements.push('co-educational environment');
            if (/faith[- ]based/i.test(text)) programElements.push('faith-based approach');
            if (/12[- ]step/i.test(text)) programElements.push('12-step integration');
            if (/experiential/i.test(text)) programElements.push('experiential therapy');
            if (/mindfulness/i.test(text)) programElements.push('mindfulness practices');
            if (/yoga/i.test(text)) programElements.push('yoga therapy');
            if (/nutrition/i.test(text)) programElements.push('nutritional counseling');
            if (/fitness|gym|exercise/i.test(text)) programElements.push('fitness programming');
            
            if (programElements.length > 0) {
                data['Program Elements'] = programElements;
            }
            
            // Extract setting/environment details
            if (/(?:acre|campus|facility|located)/i.test(text)) {
                const settingMatch = text.match(/(\d+[- ]?acre[s]?|beautiful campus|scenic|mountain|beach|rural|urban)[^.]*(?:campus|facility|setting|location)/i);
                if (settingMatch) {
                    data['Setting'] = settingMatch[0].trim();
                }
            }
            
            // Extract Program Name - Multiple patterns
            const namePatterns = [
                /^([A-Z][A-Za-z\s&'-]+?)(?:\n|$)/m, // First line is often the name
                /Program Name:\s*([^\n]+)/i,
                /^([A-Z][A-Za-z\s&'-]+?)(?:\s*[-‚Äì‚Äî]\s*|\s+(?:is|provides|offers))/m,
                /(?:program|school|academy|center|institute):\s*([A-Za-z\s&'-]+)/i
            ];
            
            for (const pattern of namePatterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    data['Program Name'] = match[1].trim();
                    break;
                }
            }
            
            // Extract Location - Check standard format first
            const standardLocation = text.match(/Location:\s*([^\n]+)/i);
            if (standardLocation) {
                data['Location'] = standardLocation[1].trim();
            } else {
                const locationPatterns = [
                    /(?:located in|location:|address:)\s*([A-Za-z\s,]+(?:,\s*[A-Z]{2})?)/i,
                    /([A-Za-z\s]+,\s*[A-Z]{2})\s*\d{5}/,
                    /\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*,\s*[A-Z]{2})\b/
                ];
                for (const pattern of locationPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        data['Location'] = match[1].trim();
                        break;
                    }
                }
            }
            
            // Extract Phone Number - Check standard format first
            const standardPhone = text.match(/Phone:\s*([\d\s().-]+)/i);
            if (standardPhone) {
                data['Phone Number'] = standardPhone[1].trim();
            } else {
                const phonePattern = /(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g;
                const phones = text.match(phonePattern);
                if (phones && phones.length > 0) {
                    data['Phone Number'] = phones[0].trim();
                }
            }
            
            // Extract Website - Check standard format first
            const standardWebsite = text.match(/Website:\s*([^\n]+)/i);
            if (standardWebsite) {
                data['Website'] = standardWebsite[1].trim().replace(/^(www\.|https?:\/\/)/, '');
            } else {
                const websitePattern = /(?:website:|visit us at:?\s*|www\.|https?:\/\/)([a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/i;
                const websiteMatch = text.match(websitePattern);
                if (websiteMatch) {
                    data['Website'] = websiteMatch[1].replace(/^(www\.|https?:\/\/)/, '');
                }
            }
            
            // Extract Level of Care - Handle Chrome extension format
            const locPatterns = [
                /(?:level of care|program type|we offer|provides?):\s*([^.\n]+)/i,
                /\b(residential(?:\s+treatment)?|RTC|PHP|IOP|outpatient|wilderness|therapeutic boarding school)\b/i,
                /^(residential|PHP|IOP|outpatient|wilderness)/im
            ];
            for (const pattern of locPatterns) {
                const match = text.match(pattern);
                if (match) {
                    let levelOfCare = match[1].trim();
                    // Clean up common phrases
                    levelOfCare = levelOfCare.replace(/treatment center/i, 'Treatment');
                    levelOfCare = levelOfCare.replace(/program/i, '');
                    data['Level of Care'] = levelOfCare.trim();
                    break;
                }
            }
            
            // Extract Age Range/Population - Use Chrome extension data if available
            if (data['TARGET POPULATION']) {
                const targetPop = data['TARGET POPULATION'];
                // Extract age range
                const ageMatch = targetPop.match(/(?:ages?\s*)?(\d+[-‚Äì]\d+)/i);
                if (ageMatch) {
                    data['Population'] = `adolescents ages ${ageMatch[1].replace(/[-‚Äì]/, '-')}`;
                }
                // Extract specializations from target population
                const issues = targetPop.match(/(?:trauma|anxiety|depression|ADHD|substance|eating disorder|self-harm|behavioral issues|autism|ASD)/gi);
                if (issues && issues.length > 0) {
                    data['Specializations'] = [...new Set(issues)].slice(0, 3).join(', ').toLowerCase();
                }
            } else {
                // Fallback to pattern matching
                const agePatterns = [
                    /(?:ages?|serving|for)\s*(\d+[-‚Äì]\d+)/i,
                    /(?:adolescents?|teens?|young adults?)\s*(?:\()?(\d+[-‚Äì]\d+)(?:\))?/i,
                    /\b(adolescents?|teenagers?|young adults?|boys|girls|co-?ed)\b/i
                ];
                for (const pattern of agePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        data['Population'] = match[0].trim();
                        break;
                    }
                }
            }
            
            // Extract Therapeutic Modalities - Use Chrome extension data if available
            if (data['CLINICAL SERVICES']) {
                const services = data['CLINICAL SERVICES'];
                const therapies = [];
                
                // Extract specific therapy types from clinical services
                const therapyPatterns = [
                    { pattern: /\bCBT\b/i, name: 'CBT' },
                    { pattern: /\bDBT\b/i, name: 'DBT' },
                    { pattern: /\bEMDR\b/i, name: 'EMDR' },
                    { pattern: /\bACT\b/i, name: 'ACT' },
                    { pattern: /Art Therapy/i, name: 'Art Therapy' },
                    { pattern: /Equine/i, name: 'Equine Therapy' },
                    { pattern: /Family Therapy/i, name: 'Family Therapy' },
                    { pattern: /Group Therapy/i, name: 'Group Therapy' },
                    { pattern: /Individual Therapy/i, name: 'Individual Therapy' },
                    { pattern: /Trauma[- ]Informed/i, name: 'Trauma-Informed Care' }
                ];
                
                therapyPatterns.forEach(({ pattern, name }) => {
                    if (pattern.test(services)) {
                        therapies.push(name);
                    }
                });
                
                if (therapies.length > 0) {
                    data['Clinical Modalities'] = therapies.slice(0, 5).join(', ');
                }
            } else {
                // Fallback to searching entire text
                const therapyTypes = [
                    'CBT', 'DBT', 'EMDR', 'ACT', 'ART', 'NARM', 'IFS', 'Somatic',
                    'Cognitive Behavioral Therapy', 'Dialectical Behavior Therapy',
                    'Eye Movement Desensitization', 'Acceptance and Commitment',
                    'Neurofeedback', 'Biofeedback', 'Equine', 'Adventure',
                    'Art Therapy', 'Music Therapy', 'Drama Therapy',
                    'Group Therapy', 'Individual Therapy', 'Family Therapy'
                ];
                
                const foundTherapies = [];
                therapyTypes.forEach(therapy => {
                    const regex = new RegExp(`\\b${therapy}\\b`, 'i');
                    if (regex.test(text)) {
                        foundTherapies.push(therapy);
                    }
                });
                
                if (foundTherapies.length > 0) {
                    data['Clinical Modalities'] = foundTherapies.slice(0, 5).join(', ');
                }
            }
            
            // Extract unique features - Use Chrome extension data if available
            const uniqueFeatures = [];
            
            // Check WHAT MAKES section first
            if (data['WHAT MAKES']) {
                const uniqueText = data['WHAT MAKES'];
                
                // Extract key features from unique section
                if (/equine|horse|animal/i.test(uniqueText)) {
                    uniqueFeatures.push('Equine-assisted therapy');
                }
                if (/NARM/i.test(uniqueText)) {
                    uniqueFeatures.push('NARM-certified trauma treatment');
                }
                if (/specialized.*autism|ASD/i.test(uniqueText)) {
                    uniqueFeatures.push('Specialized autism program');
                }
            }
            
            // Also check the full text for additional features
            const fullText = text + (data['WHAT MAKES'] || '');
            
            if (/\b(?:ranch|farm|equine|horse)\b/i.test(fullText) && !uniqueFeatures.includes('Equine-assisted therapy')) {
                uniqueFeatures.push('Equine-assisted therapy');
            }
            if (/\b(?:wilderness|outdoor|adventure|expedition)\b/i.test(fullText)) {
                uniqueFeatures.push('Wilderness therapy');
            }
            if (/\b(?:autism|ASD|spectrum)\b/i.test(fullText) && !uniqueFeatures.includes('Specialized autism program')) {
                uniqueFeatures.push('Autism spectrum support');
            }
            if (/\b(?:LGBTQ|gender|transgender)\b/i.test(fullText)) {
                uniqueFeatures.push('LGBTQ+ affirming');
            }
            if (/\b(?:adoption|attachment|RAD)\b/i.test(fullText)) {
                uniqueFeatures.push('Adoption/attachment focus');
            }
            if (/\b(?:accredited school|academic|college prep)\b/i.test(fullText)) {
                uniqueFeatures.push('Accredited academic program');
            }
            if (/trauma[- ]informed/i.test(fullText)) {
                uniqueFeatures.push('Trauma-informed care');
            }
            
            if (uniqueFeatures.length > 0) {
                data['Unique Features'] = uniqueFeatures;
            }
            
            // Clean up Chrome extension data from main data object
            delete data['TARGET POPULATION'];
            delete data['CLINICAL SERVICES'];
            delete data['ACCREDITATIONS'];
            delete data['WHAT MAKES'];
            
            // Extract any additional details that don't fit categories
            data['Additional Info'] = text;
            
            return data;
        }
        
        // Format extracted data according to Family First structure
        function formatToFamilyFirstStructure(data) {
            let output = '';
            
            // 1. Title (Calibri 10 Bold) - Clean and simple
            const programName = data['Program Name'] || 'Treatment Program';
            const location = data['Location'] || '';
            output += `${programName}${location ? ' ‚Äì ' + location : ''}\n\n`;
            
            // 2. Level of Care & Services Provided - Create unique, dynamic descriptions
            output += 'Level of Care & Services Provided:\n';
            const loc = data['Level of Care'] || 'Therapeutic program';
            const pop = data['Population'] || 'adolescents and young adults';
            
            // Create varied, program-specific descriptions based on extracted details
            let description = '';
            
            // Build a unique description based on what we know about the program
            const descriptors = [];
            
            // Start with program type variations
            if (loc.toLowerCase().includes('residential')) {
                const residentialVariations = [
                    `comprehensive residential treatment facility`,
                    `therapeutic residential community`,
                    `intensive residential treatment center`,
                    `specialized residential program`
                ];
                descriptors.push(residentialVariations[Math.floor(Math.random() * residentialVariations.length)]);
            } else if (loc.toLowerCase().includes('php')) {
                descriptors.push('Partial Hospitalization Program');
            } else if (loc.toLowerCase().includes('iop')) {
                descriptors.push('Intensive Outpatient Program');
            } else if (loc.toLowerCase().includes('wilderness')) {
                descriptors.push('wilderness therapy experience');
            } else if (loc.toLowerCase().includes('boarding')) {
                descriptors.push('therapeutic boarding school');
            } else {
                descriptors.push(loc);
            }
            
            // Add unique program characteristics
            if (data['Unique Features'] && data['Unique Features'].length > 0) {
                const feature = data['Unique Features'][0];
                if (feature.includes('equine')) {
                    description = `This ${descriptors[0]} integrates equine-assisted psychotherapy within their clinical model, serving ${pop}`;
                } else if (feature.includes('wilderness')) {
                    description = `An experiential ${descriptors[0]} utilizing nature-based interventions for ${pop}`;
                } else if (feature.includes('autism')) {
                    description = `A specialized ${descriptors[0]} designed specifically for ${pop} on the autism spectrum`;
                } else if (feature.includes('trauma')) {
                    description = `A trauma-focused ${descriptors[0]} providing specialized care for ${pop}`;
                } else {
                    description = `This ${descriptors[0]} offers individualized treatment for ${pop}`;
                }
            } else {
                // Default varied descriptions
                const templates = [
                    `This ${descriptors[0]} provides evidence-based treatment for ${pop}`,
                    `A ${descriptors[0]} offering comprehensive therapeutic services for ${pop}`,
                    `This ${descriptors[0]} specializes in treating ${pop}`,
                    `An innovative ${descriptors[0]} designed for ${pop}`
                ];
                description = templates[Math.floor(Math.random() * templates.length)];
            }
            
            // Add specialization details with varied language
            if (data['Specializations']) {
                const specialtyIntros = [
                    `. The program focuses on`,
                    `. Areas of clinical expertise include`,
                    `. Specialized treatment for`,
                    `. Primary treatment focus includes`,
                    `. Clinical specializations include`
                ];
                description += specialtyIntros[Math.floor(Math.random() * specialtyIntros.length)] + ` ${data['Specializations'].toLowerCase()}`;
            }
            
            // Add outcome or philosophy if detected
            if (data['Additional Info']) {
                if (/evidence-based/i.test(data['Additional Info'])) {
                    description += ', utilizing evidence-based practices';
                }
                if (/family/i.test(data['Additional Info']) && !description.includes('family')) {
                    description += ' with strong family involvement';
                }
                if (/holistic/i.test(data['Additional Info'])) {
                    description += ' through a holistic treatment approach';
                }
            }
            
            output += description + '.\n\n';
            
            // 3. Program Details / Differentiating Features (Calibri 9, bullets)
            output += 'Program Details / Differentiating Features:\n';
            
            // Create dynamic, varied bullet points based on program specifics
            const bullets = [];
            
            // Vary the clinical approach descriptions
            if (data['Clinical Modalities']) {
                const clinicalIntros = [
                    'Treatment Modalities',
                    'Therapeutic Approaches',
                    'Clinical Framework',
                    'Evidence-Based Interventions',
                    'Core Therapies'
                ];
                const intro = clinicalIntros[Math.floor(Math.random() * clinicalIntros.length)];
                bullets.push(`${intro}: ${data['Clinical Modalities']}`);
            } else {
                // Generate varied default clinical descriptions
                const defaultClinical = [
                    'Comprehensive clinical programming including individual, group, and family therapy',
                    'Multi-modal therapeutic approach with individualized treatment planning',
                    'Evidence-based therapeutic interventions tailored to each client\'s needs',
                    'Integrated treatment model combining individual and group modalities'
                ];
                bullets.push(defaultClinical[Math.floor(Math.random() * defaultClinical.length)]);
            }
            
            // Add unique program-specific details based on features
            if (data['Unique Features'] && data['Unique Features'].length > 0) {
                data['Unique Features'].forEach(feature => {
                    if (feature.includes('equine')) {
                        bullets.push('Equine-Assisted Psychotherapy: Therapeutic work with horses to develop emotional regulation and relationship skills');
                    } else if (feature.includes('wilderness')) {
                        bullets.push('Adventure-Based Programming: Wilderness expeditions and challenge course activities for personal growth');
                    } else if (feature.includes('autism')) {
                        bullets.push('Neurodiversity Support: Specialized programming for teens on the autism spectrum with sensory accommodations');
                    } else if (feature.includes('LGBTQ')) {
                        bullets.push('Affirming Environment: LGBTQ+ supportive with gender-affirming care and specialized support groups');
                    } else if (feature.includes('trauma')) {
                        bullets.push('Trauma-Responsive Care: Specialized trauma treatment including EMDR and somatic approaches');
                    } else if (feature.includes('academic')) {
                        bullets.push('Academic Support: Accredited on-site school with individualized education plans and college prep');
                    }
                });
            }
            
            // Add population/specialization details with variety
            if (data['Specializations']) {
                const specIntros = [
                    'Clinical Focus Areas',
                    'Areas of Expertise',
                    'Treatment Specializations',
                    'Primary Treatment Targets',
                    'Specialized Programming'
                ];
                const intro = specIntros[Math.floor(Math.random() * specIntros.length)];
                bullets.push(`${intro}: ${data['Specializations']}`);
            }
            
            // Add program philosophy if extracted
            if (data['Philosophy'] && bullets.length < 6) {
                bullets.push(`Treatment Philosophy: ${data['Philosophy']}`);
            }
            
            // Add program elements with contextual descriptions
            if (data['Program Elements'] && data['Program Elements'].length > 0) {
                const elements = data['Program Elements'];
                
                // Group related elements
                const therapeuticElements = elements.filter(e => 
                    e.includes('therapy') || e.includes('mindfulness') || e.includes('yoga') || e.includes('experiential')
                );
                const structuralElements = elements.filter(e => 
                    e.includes('group sizes') || e.includes('gender') || e.includes('co-ed') || e.includes('12-step')
                );
                const supportElements = elements.filter(e => 
                    e.includes('nutrition') || e.includes('fitness') || e.includes('faith')
                );
                
                if (therapeuticElements.length > 0) {
                    bullets.push(`Complementary Therapies: ${therapeuticElements.join(', ')}`);
                }
                if (structuralElements.length > 0) {
                    bullets.push(`Program Structure: ${structuralElements.join(', ')}`);
                }
                if (supportElements.length > 0) {
                    bullets.push(`Wellness Support: ${supportElements.join(', ')}`);
                }
            }
            
            // Add setting/environment if unique
            if (data['Setting'] && bullets.length < 6) {
                bullets.push(`Treatment Setting: ${data['Setting']}`);
            }
            
            // Add program philosophy or approach if we can infer it
            if (data['Additional Info']) {
                const info = data['Additional Info'];
                if (/holistic/i.test(info) && bullets.length < 6 && !bullets.some(b => b.includes('holistic'))) {
                    bullets.push('Holistic Approach: Integration of mind, body, and spirit in the healing process');
                }
                if (/family/i.test(info) && !bullets.some(b => b.includes('family'))) {
                    bullets.push('Family Integration: Regular family therapy sessions and parent education workshops');
                }
                if (/24\/7/i.test(info) && !bullets.some(b => b.includes('supervision'))) {
                    bullets.push('Structured Environment: 24/7 supervision with high staff-to-client ratio');
                }
                if (/transition/i.test(info)) {
                    bullets.push('Transition Support: Step-down planning and aftercare coordination for sustained recovery');
                }
            }
            
            // Add length of stay or program duration if mentioned
            const durationMatch = data['Additional Info'] && data['Additional Info'].match(/(\d+[-‚Äì]\d+)\s*(days?|weeks?|months?)/i);
            if (durationMatch && bullets.length < 6) {
                bullets.push(`Program Duration: Typical length of stay ${durationMatch[0]}`);
            }
            
            // Add accreditations with context
            if (data['Accreditations'] && data['Accreditations'] !== 'N/A') {
                bullets.push(`Accreditations & Certifications: ${data['Accreditations']}`);
            }
            
            // Ensure we have at least 3 meaningful bullets
            if (bullets.length < 3) {
                const additionalBullets = [
                    'Individualized Treatment: Customized treatment plans based on comprehensive assessment',
                    'Aftercare Planning: Comprehensive discharge planning and community resource coordination',
                    'Multidisciplinary Team: Treatment team includes therapists, psychiatrists, and specialized staff'
                ];
                bullets.push(...additionalBullets.slice(0, 3 - bullets.length));
            }
            
            // Output bullets with variety in formatting
            bullets.forEach((bullet, index) => {
                // Some bullets might have sub-points
                if (bullet.includes(':')) {
                    const [label, content] = bullet.split(':');
                    output += `‚Ä¢ <strong>${label}:</strong>${content}\n`;
                } else {
                    output += `‚Ä¢ ${bullet}\n`;
                }
            });
            
            // Add generic features if we found them in text
            const text = data['Additional Info'] || '';
            
            if (/family (?:therapy|involvement|program)/i.test(text)) {
                output += '‚Ä¢ Family Involvement: Regular family therapy sessions and parent education\n';
            }
            
            if (/trauma[- ]informed/i.test(text)) {
                output += '‚Ä¢ Trauma-Informed Care: All staff trained in trauma-informed approaches\n';
            }
            
            if (/\b24\/7\b/.test(text)) {
                output += '‚Ä¢ Supervision: 24/7 supervision and support by trained staff\n';
            }
            
            output += '\n';
            
            // 4. Contact Information - Vary the presentation
            const contactIntros = [
                'Contact Information:',
                'For More Information:',
                'To Learn More:',
                'Contact Details:',
                'Get in Touch:'
            ];
            output += contactIntros[Math.floor(Math.random() * contactIntros.length)] + '\n';
            
            // Vary the order and format of contact details
            const contactDetails = [];
            if (data['Phone Number']) {
                const phoneFormats = [
                    `Phone: ${data['Phone Number']}`,
                    `Call: ${data['Phone Number']}`,
                    `${data['Phone Number']}`,
                    `Tel: ${data['Phone Number']}`
                ];
                contactDetails.push(phoneFormats[Math.floor(Math.random() * phoneFormats.length)]);
            }
            if (data['Website']) {
                const website = data['Website'].replace(/^(www\.|https?:\/\/)/, '');
                const webFormats = [
                    `Website: www.${website}`,
                    `Visit: www.${website}`,
                    `Online: www.${website}`,
                    `www.${website}`
                ];
                contactDetails.push(webFormats[Math.floor(Math.random() * webFormats.length)]);
            }
            if (data['Location']) {
                const locFormats = [
                    `Location: ${data['Location']}`,
                    `${data['Location']}`,
                    `Located in ${data['Location']}`
                ];
                contactDetails.push(locFormats[Math.floor(Math.random() * locFormats.length)]);
            }
            
            // Randomize order occasionally
            if (Math.random() > 0.5) {
                contactDetails.reverse();
            }
            
            output += contactDetails.join('\n');
            
            return output.trim();
        }
        
        // Update selection panel with drag and drop
        function updateSelectionPanel() {
            const selectedList = document.getElementById('selectedList');
            
            if (selectedPrograms.length > 0) {
                selectedList.innerHTML = selectedPrograms.map((p, index) => `
                    <div class="selected-program selected-program-item" draggable="true" data-id="${p.id}" data-index="${index}">
                        <span class="drag-handle" style="cursor: grab;">‚ãÆ‚ãÆ</span>
                        <span style="flex: 1;">${p.name} - ${p.location}</span>
                        <div class="program-order-controls">
                            <button class="order-btn" onclick="moveProgram(${index}, 'up')" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                            <button class="order-btn" onclick="moveProgram(${index}, 'down')" ${index === selectedPrograms.length - 1 ? 'disabled' : ''}>‚Üì</button>
                            <button class="remove-btn" onclick="removeProgram('${p.id}')">√ó</button>
                        </div>
                    </div>
                `).join('');
                
                // Re-initialize drag and drop for new elements
                initializeProgramDragDrop();
                
                // Add drag and drop event listeners
                const items = selectedList.querySelectorAll('.selected-program');
                items.forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('drop', handleDrop);
                    item.addEventListener('dragenter', handleDragEnter);
                    item.addEventListener('dragleave', handleDragLeave);
                });
            } else {
                selectedList.innerHTML = '<div class="empty-state">Click programs to add to selection</div>';
            }
            
            // Enable/disable generate button
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = selectedPrograms.length === 0;
        }
        
        // Drag and drop handlers
        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Remove all drag-over classes
            const items = document.querySelectorAll('.selected-program');
            items.forEach(item => {
                item.classList.remove('drag-over');
            });
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedItem !== this) {
                const draggedIndex = parseInt(draggedItem.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // Reorder the array
                const [removed] = selectedPrograms.splice(draggedIndex, 1);
                selectedPrograms.splice(targetIndex, 0, removed);
                
                // Update the UI
                updateSelectionPanel();
            }
            
            return false;
        }
        
        // Move program up or down
        function moveProgram(index, direction) {
            if (direction === 'up' && index > 0) {
                [selectedPrograms[index], selectedPrograms[index - 1]] = 
                [selectedPrograms[index - 1], selectedPrograms[index]];
            } else if (direction === 'down' && index < selectedPrograms.length - 1) {
                [selectedPrograms[index], selectedPrograms[index + 1]] = 
                [selectedPrograms[index + 1], selectedPrograms[index]];
            }
            updateSelectionPanel();
        }
        
        // Remove program
        function removeProgram(programId) {
            selectedPrograms = selectedPrograms.filter(p => p.id !== programId);
            updateSelectionPanel();
            renderPrograms();
        }
        

        // Smart information extraction without API
        function extractProgramInfo(text) {
            const info = {
                'Program Name': 'Not specified',
                'Location': 'Not specified',
                'Phone Number': 'Not specified', 
                'Website': 'Not specified',
                'Level of Care': 'Not specified',
                'Age Range': 'Not specified',
                'Gender Served': 'Not specified',
                'Insurance Accepted': 'Not specified',
                'Specialties and Treatment Approaches': 'Not specified',
                'Duration/Length of Stay': 'Not specified',
                'Accreditations': 'Not specified',
                'Additional Features': 'Not specified'
            };
            
            // Extract program name (usually in title or first heading)
            const nameMatch = text.match(/^([A-Z][A-Za-z\s&'-]+?)(?:\n|$)/m) || 
                             text.match(/<h[1-3]>([^<]+)<\/h[1-3]>/) ||
                             text.match(/(?:Program:|Facility:|Center:)\s*([^\n]+)/i);
            if (nameMatch) info['Program Name'] = nameMatch[1].trim();
            
            // Extract phone number
            const phoneMatch = text.match(/(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})/);
            if (phoneMatch) info['Phone Number'] = phoneMatch[1];
            
            // Extract website
            const websiteMatch = text.match(/(?:www\.|https?:\/\/)([^\s\n]+)/i);
            if (websiteMatch) info['Website'] = websiteMatch[0];
            
            // Extract location (city, state pattern)
            const locationMatch = text.match(/([A-Z][a-z]+(?:\s[A-Z][a-z]+)*),?\s*([A-Z]{2})\b/) ||
                                 text.match(/(?:Location:|Located in:|Address:)\s*([^\n]+)/i);
            if (locationMatch) {
                info['Location'] = locationMatch[2] ? `${locationMatch[1]}, ${locationMatch[2]}` : locationMatch[1];
            }
            
            // Extract level of care
            const careTypes = ['RTC', 'Residential Treatment', 'PHP', 'IOP', 'Wilderness', 'Therapeutic Boarding', 'Partial Hospitalization', 'Intensive Outpatient'];
            for (const care of careTypes) {
                if (text.toLowerCase().includes(care.toLowerCase())) {
                    info['Level of Care'] = care;
                    break;
                }
            }
            
            // Extract age range
            const ageMatch = text.match(/(?:ages?|serving)\s*(\d+)[\s-]*(?:to|through)?\s*(\d+)/i) ||
                            text.match(/(\d+)[\s-]*(?:to|through)?\s*(\d+)\s*year/i);
            if (ageMatch) info['Age Range'] = `${ageMatch[1]}-${ageMatch[2]} years`;
            
            // Extract gender
            const genderMatch = text.match(/(?:Gender:|Serving:|Admits?)\s*(Boys?|Girls?|Co-?ed|Male|Female|All genders)/i);
            if (genderMatch) info['Gender Served'] = genderMatch[1];
            
            // Extract insurance
            const insuranceMatch = text.match(/(?:Insurance:|Accepts?:|Payment:)\s*([^\n]+)/i);
            if (insuranceMatch) info['Insurance Accepted'] = insuranceMatch[1];
            
            // Extract specialties (look for therapy types, treatment approaches)
            const specialties = [];
            const therapyTypes = ['CBT', 'DBT', 'EMDR', 'Equine', 'Art Therapy', 'Music Therapy', 'Family Therapy', 'Group Therapy', 'Individual Therapy'];
            therapyTypes.forEach(therapy => {
                if (text.toLowerCase().includes(therapy.toLowerCase())) {
                    specialties.push(therapy);
                }
            });
            if (specialties.length > 0) {
                info['Specialties and Treatment Approaches'] = specialties.join(', ');
            }
            
            // Extract accreditations
            const accredMatch = text.match(/(?:Accredited by|Accreditation:|Licensed by|Certified by)\s*([^\n]+)/i);
            if (accredMatch) info['Accreditations'] = accredMatch[1];
            
            return info;
        }
        
        // Simplified document generation from pasted content
        // DEPRECATED - Kept for reference, functionality moved to addCustomProgram()
        /*
        async function generateFromWebsite() {
            const programInfo = document.getElementById('quickProgramInfo').value;
            const clientName = document.getElementById('quickClientName').value;
            const statusDiv = document.getElementById('quickModeStatus');
            
            if (!programInfo) {
                alert('Please paste program information or use the Chrome extension!');
                return;
            }
            
            if (!clientName) {
                alert('Please enter client name!');
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#f0f8ff';
            statusDiv.style.color = '#0066cc';
            statusDiv.innerHTML = 'ü§ñ Analyzing program information...';
            
            try {
                // Smart parsing without API - Extract information using pattern matching
                const programData = extractProgramInfo(programInfo);
                
                // Generate document with extracted information
                generateQuickModeDocument(clientName, programData);
                
                statusDiv.style.background = '#d4f4dd';
                statusDiv.style.color = '#28a745';
                statusDiv.innerHTML = '‚úÖ Document generated successfully!';
                
            } catch (error) {
                // If parsing fails, use the manual format
                generateManualDocument(clientName);
                statusDiv.style.background = '#d4f4dd';
                statusDiv.style.color = '#28a745';
                statusDiv.innerHTML = '‚úÖ Document generated!';
            }
        }
        */
        
        // Generate document from AI-extracted data
        function generateQuickModeDocument(clientName, programData) {
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Treatment Options - ${clientName}</title>
                    <style>
                        @page { size: letter; margin: 0.5in; }
                        body { 
                            font-family: 'Calibri', Arial, sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            line-height: 1.6;
                            color: #333;
                        }
                        .letterhead { 
                            border-bottom: 3px solid #0066cc; 
                            padding-bottom: 10px; 
                            margin-bottom: 20px; 
                        }
                        .logo-container { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center; 
                        }
                        .logo-left { 
                            display: flex; 
                            align-items: center; 
                        }
                        .logo-circle { 
                            width: 50px; 
                            height: 50px; 
                            background: #0066cc; 
                            color: white; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-size: 24px; 
                            font-weight: bold; 
                            margin-right: 15px; 
                        }
                        .program-section { 
                            margin: 30px 0; 
                            page-break-inside: avoid; 
                        }
                        .program-title { 
                            color: #0066cc; 
                            font-size: 18px; 
                            font-weight: bold; 
                            margin-bottom: 10px; 
                        }
                        .program-details { 
                            margin-left: 20px; 
                        }
                        ul { 
                            margin: 10px 0; 
                            padding-left: 20px; 
                        }
                        li { 
                            margin: 5px 0; 
                        }
                    </style>
                </head>
                <body>
                    <div class="letterhead">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 50px; height: 50px; background: #0066cc; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; margin-right: 15px;">F</div>
                                <div>
                                    <h1 style="margin: 0; color: #0066cc; font-size: 24px;">Family First</h1>
                                    <p style="margin: 0; font-size: 14px; color: #666;">ADOLESCENT SERVICES</p>
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 14px; color: #666;">
                                ${date}
                            </div>
                        </div>
                    </div>
                    
                    <h2 style="color: #0066cc;">TREATMENT RECOMMENDATION</h2>
                    <p><strong>Client:</strong> ${clientName}</p>
                    
                    <div style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                        <h3 style="color: #0066cc; margin-top: 0;">${programData['Program Name'] || 'Program Name Not Specified'}</h3>
                        <p><strong>Location:</strong> ${programData['Location'] || 'Not specified'}</p>
                        <p><strong>Phone:</strong> ${programData['Phone Number'] || 'Not specified'}</p>
                        <p><strong>Website:</strong> ${programData['Website'] || 'Not specified'}</p>
                        <p><strong>Level of Care:</strong> ${programData['Level of Care'] || 'Not specified'}</p>
                        <p><strong>Age Range:</strong> ${programData['Age Range'] || 'Not specified'}</p>
                        <p><strong>Gender Served:</strong> ${programData['Gender Served'] || 'Not specified'}</p>
                        <p><strong>Insurance:</strong> ${programData['Insurance Accepted'] || 'Not specified'}</p>
                        <p><strong>Treatment Duration:</strong> ${programData['Duration/Length of Stay'] || 'Not specified'}</p>
                        <p><strong>Accreditations:</strong> ${programData['Accreditations'] || 'Not specified'}</p>
                        
                        <h4 style="color: #0066cc;">Specialties & Treatment Approaches:</h4>
                        <p>${programData['Specialties and Treatment Approaches'] || 'Not specified'}</p>
                        
                        <h4 style="color: #0066cc;">Additional Features:</h4>
                        <p>${programData['Additional Features'] || 'Not specified'}</p>
                    </div>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #0066cc; text-align: center; color: #666;">
                        <p style="margin: 0;">8737 Dunwoody Place | Suite 100 | Atlanta, Georgia 30350</p>
                        <p style="margin: 5px 0;">Office: 770.407.0768 ext 2 | Fax: 770.407.0516</p>
                    </div>
                
    
                <!-- Immersive Map System -->
                <div id="immersiveMapOverlay" style="
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    z-index: 10000;
                    background: rgba(0, 0, 0, 0.95);
                    animation: fadeIn 0.3s;
                ">
                    <!-- Map Header Bar -->
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 80px;
                        background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
                        z-index: 10001;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 0 30px;
                    ">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <h2 style="color: white; margin: 0; font-size: 24px; font-weight: 600;">
                                üó∫Ô∏è Interactive Program Map
                            </h2>
                            <div id="mapQuickStats" style="display: flex; gap: 20px;">
                                <div style="color: white; opacity: 0.9;">
                                    <span style="opacity: 0.7;">Programs:</span>
                                    <span id="totalProgramsMap" style="font-weight: 600;">0</span>
                                </div>
                                <div style="color: white; opacity: 0.9;">
                                    <span style="opacity: 0.7;">In Radius:</span>
                                    <span id="inRadiusCount" style="font-weight: 600; color: #10b981;">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="closeImmersiveMap()" style="
                            background: rgba(255, 255, 255, 0.1);
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            color: white;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                            transition: all 0.2s;
                        ">‚úï Close Map</button>
                    </div>
                    
                    <!-- Map Controls Panel -->
                    <div style="
                        position: absolute;
                        top: 100px;
                        left: 30px;
                        width: 320px;
                        background: rgba(255, 255, 255, 0.95);
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                        z-index: 10001;
                        max-height: calc(100vh - 140px);
                        overflow-y: auto;
                    ">
                        <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">Search & Filters</h3>
                        
                        <!-- Location Search -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-size: 14px; color: #6b7280;">
                                üìç Search Location
                            </label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" 
                                       id="mapZipSearch" 
                                       placeholder="Enter ZIP or city..."
                                       style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <button onclick="searchMapLocation()" style="
                                    padding: 10px 16px;
                                    background: #3b82f6;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-weight: 600;
                                ">Go</button>
                            </div>
                        </div>
                        
                        <!-- Radius Control -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-size: 14px; color: #6b7280;">
                                üìè Search Radius: <span id="radiusDisplayValue" style="color: #3b82f6; font-weight: 600;">50 miles</span>
                            </label>
                            <input type="range" 
                                   id="immersiveRadiusSlider" 
                                   min="10" 
                                   max="200" 
                                   value="50"
                                   onchange="updateMapRadius(this.value)"
                                   style="width: 100%;">
                        </div>
                        
                        <!-- Map Style -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-size: 14px; color: #6b7280;">
                                üé® Map Style
                            </label>
                            <select id="mapStyleSelector" onchange="changeMapType(this.value)" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #d1d5db;
                                border-radius: 6px;
                            ">
                                <option value="street">Street Map</option>
                                <option value="satellite">Satellite View</option>
                                <option value="terrain">Terrain</option>
                                <option value="dark">Dark Mode</option>
                            </select>
                        </div>
                        
                        <!-- Quick Locations -->
                        <div style="margin-top: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #6b7280;">
                                ‚ö° Quick Locations
                            </label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <button onclick="jumpToLocation('02134', 'Boston')" class="quick-location-btn">Boston</button>
                                <button onclick="jumpToLocation('10001', 'NYC')" class="quick-location-btn">New York</button>
                                <button onclick="jumpToLocation('90210', 'LA')" class="quick-location-btn">Los Angeles</button>
                                <button onclick="jumpToLocation('60601', 'Chicago')" class="quick-location-btn">Chicago</button>
                                <button onclick="jumpToLocation('33139', 'Miami')" class="quick-location-btn">Miami</button>
                                <button onclick="jumpToLocation('98101', 'Seattle')" class="quick-location-btn">Seattle</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Map Container -->
                    <div id="immersiveMapContainer" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        z-index: 10000;
                    "></div>
                    
                    <!-- Program List Panel (Right Side) -->
                    <div id="mapProgramsList" style="
                        position: absolute;
                        top: 100px;
                        right: 30px;
                        width: 320px;
                        background: rgba(255, 255, 255, 0.95);
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                        z-index: 10001;
                        max-height: calc(100vh - 140px);
                        overflow-y: auto;
                        display: none;
                    ">
                        <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">Programs in Area</h3>
                        <div id="mapProgramsListContent">
                            <!-- Programs will be listed here -->
                        </div>
                    </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
        
        // Listen for messages from Chrome extension
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'PROGRAM_INFO_EXTRACTED') {
                // Use the proper function to show the modal
                showAddProgramDialog();
                
                // Populate the textarea with extracted content
                document.getElementById('customProgramInfo').value = event.data.content;
                
                // Clear any existing status messages
                document.getElementById('customProgramStatus').innerHTML = '';
                
                // Show success message
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4f4dd; color: #28a745; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                statusDiv.innerHTML = '‚úÖ Content received from Chrome extension! Click "Smart Format & Add Program" to process it.';
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    statusDiv.remove();
                }, 4000);
            }
        });
        
        // Generate manual document without AI
        function generateManualDocument(clientName) {
            const programInfo = document.getElementById('quickProgramInfo').value;
            if (!clientName) clientName = document.getElementById('quickClientName').value;
            
            const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Treatment Information - ${clientName}</title>
                    <style>
                        @page { size: letter; margin: 0.5in; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; line-height: 1.6; }
                        .letterhead { border-bottom: 3px solid #0066cc; padding-bottom: 10px; margin-bottom: 20px; }
                        .logo-container { display: flex; justify-content: space-between; align-items: center; }
                        .logo-left { display: flex; align-items: center; }
                        .logo-circle { width: 50px; height: 50px; background: #0066cc; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; margin-right: 15px; }
                        h1 { margin: 0; color: #0066cc; font-size: 24px; }
                        h2 { color: #0066cc; margin-top: 20px; }
                        .content-box { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #0066cc; text-align: center; color: #666; font-size: 14px; }
                        .program-info { white-space: pre-wrap; font-family: Arial, sans-serif; }
                    </style>
                </head>
                <body>
                    <div class="letterhead">
                        <div class="logo-container">
                            <div class="logo-left">
                                <div>
                                    <h1>Family First</h1>
                                    <p style="margin: 0; font-size: 14px; color: #666;">ADOLESCENT SERVICES</p>
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 14px; color: #666;">
                                ${date}
                            </div>
                        </div>
                    </div>
                    
                    <h2>PROGRAM INFORMATION</h2>
                    <p><strong>Client:</strong> ${clientName}</p>
                    
                    <div class="content-box">
                        <h3 style="color: #0066cc; margin-top: 0;">Program Details</h3>
                        <div class="program-info">${programInfo.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                    </div>
                    
                    <div class="footer">
                        <p style="margin: 0;">8737 Dunwoody Place | Suite 100 | Atlanta, Georgia 30350</p>
                        <p style="margin: 5px 0;">Office: 770.407.0768 ext 2 | Fax: 770.407.0516</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
            
            // Update status
            const statusDiv = document.getElementById('quickModeStatus');
            statusDiv.style.background = '#d4f4dd';
            statusDiv.style.color = '#28a745';
            statusDiv.innerHTML = '‚úÖ Manual document generated! The print dialog should appear.';
        }
        
        // Generate document - Professional letterhead format
        // AT HOME Provider Management
        function toggleAtHomeSection() {
            const checkbox = document.getElementById('includeAtHome');
            const section = document.getElementById('atHomeSection');
            section.style.display = checkbox.checked ? 'block' : 'none';
            
            // Start collapsed when first shown
            if (checkbox.checked) {
                const content = document.getElementById('atHomeContent');
                const toggleBtn = document.getElementById('atHomeToggleBtn');
                const toggleText = document.getElementById('atHomeToggleText');
                content.style.display = 'none';
                toggleBtn.textContent = '‚ñ∂';
                if (toggleText) toggleText.textContent = 'EXPAND';
            }
        }
        
        function toggleAtHomeContent() {
            const content = document.getElementById('atHomeContent');
            const toggleBtn = document.getElementById('atHomeToggleBtn');
            const toggleText = document.getElementById('atHomeToggleText');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                content.style.maxHeight = '400px';
                content.style.overflowY = 'auto';
                toggleBtn.textContent = '‚ñº';
                toggleBtn.style.transform = 'rotate(0deg)';
                if (toggleText) toggleText.textContent = 'COLLAPSE';
            } else {
                content.style.display = 'none';
                toggleBtn.textContent = '‚ñ∂';
                toggleBtn.style.transform = 'rotate(0deg)';
                if (toggleText) toggleText.textContent = 'EXPAND';
            }
        }
        
        function addAtHomeProvider() {
            const providerId = 'provider_' + Date.now();
            const provider = {
                id: providerId,
                name: '',
                service: '',
                phone: '',
                website: '',
                address: ''
            };
            
            atHomeProviders.push(provider);
            renderAtHomeProviders();
            
            // Show the AT HOME section if it's hidden
            const atHomeSection = document.getElementById('atHomeSection');
            if (atHomeSection && atHomeSection.style.display === 'none') {
                atHomeSection.style.display = 'block';
            }
            
            // Expand the content if it's collapsed
            const content = document.getElementById('atHomeContent');
            if (content && content.style.display === 'none') {
                toggleAtHomeContent();
            }
        }

        // REMOVED: loadAtHomeSuggestions function
        // This was intended to pre-populate common AT HOME therapy providers
        // to save time for case managers, but it's better to manually add
        // specific providers as needed for each client's situation
        
        function removeAtHomeProvider(providerId) {
            atHomeProviders = atHomeProviders.filter(p => p.id !== providerId);
            renderAtHomeProviders();
        }
        
        function updateAtHomeProvider(providerId, field, value) {
            const provider = atHomeProviders.find(p => p.id === providerId);
            if (provider) {
                provider[field] = value;
                
                // Show confirmation when both required fields are filled
                if (provider.name && provider.phone) {
                    showProviderConfirmation(providerId);
                }
            }
        }
        
        function showProviderConfirmation(providerId) {
            // Remove any existing confirmation messages
            const existingMessages = document.querySelectorAll('.provider-confirmation');
            existingMessages.forEach(msg => msg.remove());
            
            // Find the provider container
            const providerContainer = document.querySelector(`[data-provider-id="${providerId}"]`);
            if (providerContainer) {
                const confirmation = document.createElement('div');
                confirmation.className = 'provider-confirmation';
                confirmation.style.cssText = 'background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; margin-top: 8px; font-size: 14px; border: 1px solid #c3e6cb;';
                confirmation.innerHTML = '‚úÖ Provider added to AT HOME recommendations!';
                
                providerContainer.appendChild(confirmation);
                
                // Remove confirmation after 3 seconds
                setTimeout(() => {
                    confirmation.remove();
                }, 3000);
            }
        }
        
        function renderAtHomeProviders() {
            const container = document.getElementById('atHomeProviders');
            container.innerHTML = '';
            
            // Update the provider count badge
            const countBadge = document.getElementById('atHomeProviderCount');
            if (countBadge) {
                if (atHomeProviders.length > 0) {
                    countBadge.textContent = atHomeProviders.length;
                    countBadge.style.display = 'inline-block';
                } else {
                    countBadge.style.display = 'none';
                }
            }
            
            atHomeProviders.forEach(provider => {
                const providerDiv = document.createElement('div');
                providerDiv.style.cssText = 'margin-bottom: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white;';
                providerDiv.setAttribute('data-provider-id', provider.id);
                
                providerDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>Provider ${atHomeProviders.indexOf(provider) + 1}</strong>
                        <button type="button" onclick="removeAtHomeProvider('${provider.id}')" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 10px;">
                            <input type="text" placeholder="Provider Name *" value="${provider.name}" 
                               onchange="updateAtHomeProvider('${provider.id}', 'name', this.value)"
                                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                            <input type="text" placeholder="Service Type" value="${provider.service}" 
                               onchange="updateAtHomeProvider('${provider.id}', 'service', this.value)"
                                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                    </div>
                        <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 10px;">
                        <input type="text" placeholder="Phone Number *" value="${provider.phone}" 
                               onchange="updateAtHomeProvider('${provider.id}', 'phone', this.value)"
                                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                            <input type="text" placeholder="Website" value="${provider.website}" 
                               onchange="updateAtHomeProvider('${provider.id}', 'website', this.value)"
                                   style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                    </div>
                    <input type="text" placeholder="Address (optional)" value="${provider.address}" 
                           onchange="updateAtHomeProvider('${provider.id}', 'address', this.value)"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                `;
                
                container.appendChild(providerDiv);
            });
        }
        
        // Simple extraction function - no AI API required
        async function extractProgramData(websiteText, programName) {
            // This is a placeholder - in production, extraction should be done server-side
            showNotification('AI extraction has been disabled for security. Please use manual entry.', 'warning');
                        return null;
                    }


        // Simplified website analysis - no AI API required  
        async function analyzeWebsiteUrl(url, programName) {
            // This is a placeholder - in production, website analysis should be done server-side
            showNotification('Website analysis has been disabled for security. Please use manual entry.', 'warning');
                return null;
        }
        
        // Simplified URL analysis - no AI API required
        async function analyzeUrlDirectly(url, programName) {
            // This is a placeholder - in production, URL analysis should be done server-side
            showNotification('Direct URL analysis has been disabled for security. Please use manual entry.', 'warning');
                return null;
        }

        // AI Preview and Hybrid Tool Functions
        function showAIPreview(extractedData, confidence, originalInput) {
            const statusDiv = document.getElementById('customProgramStatus');
            
            // Store the original URL in the extraction data
            window.currentAIExtraction = extractedData;
            window.currentAIInput = originalInput;
            
            statusDiv.innerHTML = `
                <div style="background: #f0f9ff; border: 1px solid #0099cc; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 16px;">ü§ñ</span>
                        <strong style="margin-left: 8px; color: #0099cc;">AI Analysis Complete</strong>
                        <span style="margin-left: auto; background: ${confidence === 'high' ? '#10b981' : '#f59e0b'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                            ${confidence.toUpperCase()} CONFIDENCE
                        </span>
                    </div>
                    
                    <div style="background: white; border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 14px;">
                        <h4 style="margin-top: 0; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Program Overview</h4>
                        ${extractedData['Program Name'] ? `<div style="margin-bottom: 6px;"><strong>Program:</strong> ${extractedData['Program Name']}</div>` : ''}
                        ${extractedData['Level of Care'] ? `<div style="margin-bottom: 6px;"><strong>Level of Care:</strong> ${extractedData['Level of Care']}</div>` : ''}
                        ${extractedData['Program Philosophy'] ? `<div style="margin-bottom: 6px;"><strong>Philosophy:</strong> ${extractedData['Program Philosophy']}</div>` : ''}
                        ${extractedData['Typical Length of Stay'] ? `<div style="margin-bottom: 6px;"><strong>Length of Stay:</strong> ${extractedData['Typical Length of Stay']}</div>` : ''}
                        
                        ${(extractedData['Age Range'] || extractedData['Gender Served'] || extractedData['Primary Issues Treated'] || extractedData['Exclusion Criteria']) ? `
                        <h4 style="margin-top: 12px; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Population & Clinical</h4>
                        ${extractedData['Age Range'] ? `<div style="margin-bottom: 6px;"><strong>Ages:</strong> ${extractedData['Age Range']}</div>` : ''}
                        ${extractedData['Gender Served'] ? `<div style="margin-bottom: 6px;"><strong>Gender:</strong> ${extractedData['Gender Served']}</div>` : ''}
                        ${extractedData['Primary Issues Treated'] ? `<div style="margin-bottom: 6px;"><strong>Treats:</strong> ${extractedData['Primary Issues Treated']}</div>` : ''}
                        ${extractedData['Exclusion Criteria'] ? `<div style="margin-bottom: 6px;"><strong>Excludes:</strong> ${extractedData['Exclusion Criteria']}</div>` : ''}
                        ` : ''}
                        
                        ${(extractedData['Individual Therapy'] || extractedData['Group Therapy'] || extractedData['Family Involvement'] || extractedData['Specialized Therapies']) ? `
                        <h4 style="margin-top: 12px; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Therapeutic Services</h4>
                        ${extractedData['Individual Therapy'] ? `<div style="margin-bottom: 6px;"><strong>Individual:</strong> ${extractedData['Individual Therapy']}</div>` : ''}
                        ${extractedData['Group Therapy'] ? `<div style="margin-bottom: 6px;"><strong>Group:</strong> ${extractedData['Group Therapy']}</div>` : ''}
                        ${extractedData['Family Involvement'] ? `<div style="margin-bottom: 6px;"><strong>Family:</strong> ${extractedData['Family Involvement']}</div>` : ''}
                        ${extractedData['Specialized Therapies'] ? `<div style="margin-bottom: 6px;"><strong>Specialized:</strong> ${extractedData['Specialized Therapies']}</div>` : ''}
                        ` : ''}
                        
                        ${(extractedData['Best Fit For'] || extractedData['May Not Be Suitable For']) ? `
                        <h4 style="margin-top: 12px; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Key Fit Information</h4>
                        ${extractedData['Best Fit For'] ? `<div style="margin-bottom: 6px;"><strong>Best For:</strong> ${extractedData['Best Fit For']}</div>` : ''}
                        ${extractedData['May Not Be Suitable For'] ? `<div style="margin-bottom: 6px;"><strong>Not For:</strong> ${extractedData['May Not Be Suitable For']}</div>` : ''}
                        ` : ''}
                        
                        ${(extractedData['Location'] || extractedData['Phone Number'] || extractedData['Insurance Accepted']) ? `
                        <h4 style="margin-top: 12px; color: #1a1a1a; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">Contact & Cost</h4>
                        ${extractedData['Location'] ? `<div style="margin-bottom: 6px;"><strong>Location:</strong> ${extractedData['Location']}</div>` : ''}
                        ${extractedData['Phone Number'] ? `<div style="margin-bottom: 6px;"><strong>Phone:</strong> ${extractedData['Phone Number']}</div>` : ''}
                        ${extractedData['Insurance Accepted'] ? `<div style="margin-bottom: 6px;"><strong>Insurance:</strong> ${extractedData['Insurance Accepted']}</div>` : ''}
                        ` : ''}
                        ${extractedData.Notes ? `<div style="color: #666; font-style: italic; margin-top: 8px;">${extractedData.Notes}</div>` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="acceptAIExtraction()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ‚úÖ Use This Data
                        </button>
                        <button onclick="showHybridTool('${originalInput.replace(/'/g, "\'")}', true)" style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üîß Improve with Hybrid AI
                        </button>
                        <button onclick="rejectAIExtraction()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ‚ùå Start Over
                        </button>
                    </div>
                </div>
            `;
            
            // Store the extracted data for later use
            window.currentAIExtraction = extractedData;
        }
        
        function showHybridOption(extractedData, originalInput) {
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = `
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 16px;">‚ö†Ô∏è</span>
                        <strong style="margin-left: 8px; color: #d97706;">AI Analysis - Low Confidence</strong>
                    </div>
                    
                    <p style="margin-bottom: 12px; color: #92400e;">
                        AI found some information but isn't confident. You can use it as-is or improve it with the Hybrid AI Tool.
                    </p>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="showHybridTool('${originalInput.replace(/'/g, "\'")}', true)" style="background: #0099cc; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üöÄ Use Hybrid AI Tool
                        </button>
                        <button onclick="acceptAIExtraction()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üìù Use Current Data
                        </button>
                    </div>
                </div>
            `;
            
            window.currentAIExtraction = extractedData;
        }
        
        function showHybridTool(originalInput, hasAIData = false) {
            const statusDiv = document.getElementById('customProgramStatus');
            
            // Check if we have a URL from the original input
            const urlFromInput = window.currentAIInput || document.getElementById('programUrl').value;
            const isUrl = originalInput && originalInput.match(/^https?:\/\/.+/);
            const websiteUrl = isUrl ? originalInput : urlFromInput;
            
            statusDiv.innerHTML = `
                <div style="background: #f3f4f6; border: 1px solid #9ca3af; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <span style="font-size: 18px;">üîß</span>
                        <strong style="margin-left: 8px; color: #374151;">Manual Content Entry</strong>
                    </div>
                    
                    ${websiteUrl ? `
                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #0099cc;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #0099cc;">Program Website:</strong><br>
                                    <span style="font-size: 14px; color: #666;">${websiteUrl}</span>
                                </div>
                                <button onclick="window.open('${websiteUrl}', '_blank')" style="background: #0099cc; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Open Website ‚Üí
                                </button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="background: #e5e7eb; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;">
                        <strong>Quick Instructions:</strong><br>
                        1. Click "Open Website" above${!websiteUrl ? ' (or open the program website)' : ''}<br>
                        2. Copy sections: About, Clinical Program, Admissions, etc.<br>
                        3. Paste everything in the box below<br>
                        4. Click "Process with AI" to extract data
                    </div>
                    
                    <textarea id="hybridInput" placeholder="Paste all program information here...&#10;&#10;Include:&#10;‚Ä¢ Program overview&#10;‚Ä¢ Clinical services&#10;‚Ä¢ Population served&#10;‚Ä¢ Admissions info&#10;‚Ä¢ Contact details" 
                              style="width: 100%; height: 200px; padding: 12px; border: 2px solid #0099cc; border-radius: 6px; font-family: Arial, sans-serif; font-size: 14px; resize: vertical;">${!isUrl && originalInput ? originalInput : ''}</textarea>
                    
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button onclick="processHybridInput()" style="background: #0099cc; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ü§ñ Process with AI
                        </button>
                        ${hasAIData ? `<button onclick="acceptAIExtraction()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">üìù Use Previous Data</button>` : ''}
                        <button onclick="resetAddProgramForm()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            ‚Üê Back
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-open the website if we have a URL
            if (websiteUrl) {
                setTimeout(() => {
                    window.open(websiteUrl, '_blank');
                }, 500);
            }
        }
        
        async function processHybridInput() {
            const hybridInput = document.getElementById('hybridInput').value;
            if (!hybridInput.trim()) {
                alert('Please paste some program information first!');
                return;
            }
            
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = 'ü§ñ Processing with Hybrid AI...';
            
            const extractedData = await extractProgramData(hybridInput, 'Program from Hybrid Tool');
            
            if (extractedData) {
                showAIPreview(extractedData, 'high', hybridInput);
            } else {
                statusDiv.innerHTML = `
                    <div style="color: #ef4444; padding: 10px;">
                        ‚ùå AI processing failed. Please check your API key or try manual entry.
                        <button onclick="showHybridTool('${hybridInput.replace(/'/g, "\'")}', false)" style="margin-left: 10px; background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 4px;">Try Again</button>
                    </div>
                `;
            }
        }
        
        function acceptAIExtraction() {
            if (!window.currentAIExtraction) return;
            
            const extractedData = window.currentAIExtraction;
            
            // Create program with AI data
            const customProgram = {
                id: 'custom_' + Date.now(),
                name: extractedData['Program Name'] || extractedData.name || 'Custom Program',
                type: extractedData['Level of Care'] || 'Treatment Program',
                location: extractedData['Location'] || '',
                category: 'custom',
                programCategory: 'Custom Programs',
                levelOfCare: extractedData['Level of Care'] || 'Treatment Program',
                
                // Build comprehensive features list from all extracted data
                features: [
                    extractedData['Program Philosophy'] && `Philosophy: ${extractedData['Program Philosophy']}`,
                    extractedData['Typical Length of Stay'] && `Length: ${extractedData['Typical Length of Stay']}`,
                    extractedData['Primary Issues Treated'] && `Treats: ${extractedData['Primary Issues Treated']}`,
                    extractedData['Specialized Therapies'] && `Therapies: ${extractedData['Specialized Therapies']}`,
                    extractedData['Staff Ratio'] && `Staff Ratio: ${extractedData['Staff Ratio']}`,
                    extractedData['Academic Program'] && `Academics: ${extractedData['Academic Program']}`,
                    extractedData['Best Fit For'] && `Best For: ${extractedData['Best Fit For']}`
                ].filter(Boolean),
                
                contact: {
                    phone: extractedData['Phone Number'] || '',
                    website: extractedData['Website'] || '',
                    address: extractedData['Location'] || ''
                },
                
                // Store all clinical details for document generation
                clinicalDetails: {
                    philosophy: extractedData['Program Philosophy'],
                    lengthOfStay: extractedData['Typical Length of Stay'],
                    ageRange: extractedData['Age Range'],
                    genderServed: extractedData['Gender Served'],
                    academicGrades: extractedData['Academic Grades'],
                    primaryIssues: extractedData['Primary Issues Treated'],
                    exclusions: extractedData['Exclusion Criteria'],
                    individualTherapy: extractedData['Individual Therapy'],
                    groupTherapy: extractedData['Group Therapy'],
                    familyInvolvement: extractedData['Family Involvement'],
                    psychiatricServices: extractedData['Psychiatric Services'],
                    specializedTherapies: extractedData['Specialized Therapies'],
                    academicProgram: extractedData['Academic Program'],
                    specialEducation: extractedData['Special Education'],
                    staffRatio: extractedData['Staff Ratio'],
                    phaseSystem: extractedData['Phase System'],
                    familyCommunication: extractedData['Family Communication'],
                    activities: extractedData['Activities and Recreation'],
                    livingArrangements: extractedData['Living Arrangements'],
                    admissionsProcess: extractedData['Admissions Process'],
                    insurance: extractedData['Insurance Accepted'],
                    costInfo: extractedData['Cost Information'],
                    accreditations: extractedData['Accreditations'],
                    keyDifferentiators: extractedData['Key Differentiators'],
                    clinicalStrengths: extractedData['Clinical Strengths'],
                    bestFitFor: extractedData['Best Fit For'],
                    notSuitableFor: extractedData['May Not Be Suitable For']
                },
                
                isCustom: true,
                extractedData: extractedData
            };
            
            // Add to programs and selection
            programs.push(customProgram);
            selectedPrograms.push(customProgram);
            
            // Update UI
            renderPrograms();
            updateSelectionPanel();
            saveCustomPrograms();
            
            // Success message with option to add another
            const statusDiv = document.getElementById('customProgramStatus');
            statusDiv.innerHTML = `
                <div style="background: #d4f4dd; border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="color: #155724; font-weight: bold; margin-bottom: 10px;">‚úÖ "${customProgram.name}" Added Successfully!</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="resetAddProgramForm()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            ‚ûï Add Another Program
                        </button>
                        <button onclick="closeAddProgramModal()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            ‚úì Done Adding Programs
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-reset after 5 seconds if no action taken
            setTimeout(() => {
                resetAddProgramForm();
            }, 5000);
        }
        
        // Reset the add program form for adding another
        function resetAddProgramForm() {
            // Clear URL input
            document.getElementById('programUrl').value = '';
            
            // Clear manual text input
            document.getElementById('customProgramInfo').value = '';
            
            // Hide progress tracker
            document.getElementById('aiProgressTracker').style.display = 'none';
            
            // Clear progress details
            document.getElementById('progressDetails').innerHTML = '';
            document.getElementById('progressError').style.display = 'none';
            
            // Reset all progress steps
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                if (stepEl) {
                    stepEl.style.opacity = '0.5';
                    const icon = stepEl.querySelector('.step-icon');
                    if (icon) {
                        icon.innerHTML = '‚è≥';
                        icon.style.animation = 'none';
                    }
                    const time = stepEl.querySelector('.step-time');
                    if (time) time.innerHTML = '';
                }
            }
            
            // Clear status
            document.getElementById('customProgramStatus').innerHTML = '';
            
            // Clear stored extraction data
            window.currentAIExtraction = null;
            window.currentAIInput = null;
            
            // Focus back on URL input if in AI mode
            const aiContent = document.getElementById('aiModeContent');
            if (aiContent.style.display !== 'none') {
                document.getElementById('programUrl').focus();
            } else {
                document.getElementById('customProgramInfo').focus();
            }
        }
        
        function rejectAIExtraction() {
            const originalInput = document.getElementById('customProgramInfo').value;
            showHybridTool(originalInput, false);
        }
        
        async function generateDocument() {
            const clientNameInput = document.getElementById('clientName');
            const clientName = clientNameInput ? clientNameInput.value.trim() : '';
            
            // Validation with better feedback
            const validationErrors = [];
            
            if (!clientName) {
                validationErrors.push('‚Ä¢ Client first name is required');
                if (clientNameInput) {
                    clientNameInput.style.border = '2px solid #ef4444';
                    clientNameInput.focus();
                }
            }
            
            if (selectedPrograms.length === 0) {
                validationErrors.push('‚Ä¢ Select at least one program');
            }
            
            // Check AT HOME providers if enabled
            const includeAtHome = document.getElementById('includeAtHome')?.checked;
            if (includeAtHome && atHomeProviders.length > 0) {
                const missingInfo = atHomeProviders.filter(p => !p.name || !p.phone);
                if (missingInfo.length > 0) {
                    validationErrors.push(`‚Ä¢ ${missingInfo.length} AT HOME provider(s) missing name or phone`);
                }
            }
            
            if (validationErrors.length > 0) {
                // Show friendly validation message
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border: 2px solid #ef4444;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    z-index: 99999;
                    max-width: 400px;
                `;
                errorDiv.innerHTML = `
                    <h3 style="color: #ef4444; margin: 0 0 15px 0;">‚ö†Ô∏è Please complete required fields:</h3>
                    <div style="color: #333; margin-bottom: 20px;">
                        ${validationErrors.join('<br>')}
                    </div>
                    <button onclick="this.parentElement.remove(); document.getElementById('clientName').focus();" 
                            style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">
                        OK, I'll fix it
                    </button>
                `;
                document.body.appendChild(errorDiv);
                
                // Reset client name border after a moment
                setTimeout(() => {
                    if (clientNameInput) clientNameInput.style.border = '';
                }, 3000);
                
                return;
            }
            
            // Show enhanced loading with progress
            showEnhancedLoading('Generating Document', [
                'Validate', 
                'Process', 
                'Format', 
                'Finalize'
            ]);
            
            // Simulate progress with detailed status updates
            const progressUpdates = [
                { percent: 10, status: 'Validating input...', detail: 'Checking client information', step: 0 },
                { percent: 25, status: 'Processing programs...', detail: `Loading ${selectedPrograms.length} selected programs`, step: 1 },
                { percent: 40, status: 'Analyzing program data...', detail: 'Extracting clinical details', step: 1 },
                { percent: 55, status: 'Building document structure...', detail: 'Creating professional layout', step: 2 },
                { percent: 70, status: 'Formatting content...', detail: 'Applying Calibri styles', step: 2 },
                { percent: 85, status: 'Adding finishing touches...', detail: 'Including contact information', step: 3 },
                { percent: 95, status: 'Finalizing document...', detail: 'Preparing for preview', step: 3 },
                { percent: 100, status: 'Complete!', detail: 'Document ready', step: 3 }
            ];
            
            let updateIndex = 0;
            const progressInterval = setInterval(() => {
                if (updateIndex < progressUpdates.length) {
                    const update = progressUpdates[updateIndex];
                    updateLoadingProgress(update.percent, update.status, update.detail, update.step);
                    updateIndex++;
                } else {
                    clearInterval(progressInterval);
                }
            }, 300);
            
            // Use the order as arranged by the user
            const orderedPrograms = [...selectedPrograms];
            
            // Small delay for better UX and to show loading animation
            setTimeout(() => {
            
            // Generate document with professional letterhead styling
            let html = `
                <div class="doc-page">
                    <div class="doc-content">
                        <!-- Letterhead Header -->
                        <div class="doc-letterhead">
                            <div class="doc-letterhead-text">
                                <h1>Family First</h1>
                                <p>ADOLESCENT SERVICES</p>
                            </div>
                        </div>
                        

            `;
            
            if (documentType === 'options') {
                // OPTIONS Document Format
                html += `
                    <div class="doc-greeting">Hello,</div>
                    <div class="doc-intro">
                        The FFAS clinical team has formulated a list of recommendations and options to support ${clientName} in continuing care. 
                        Included in the list is: contact information, location, website, and a breakdown of specialties and services provided by each program.
                    </div>
                    <div class="doc-section-header">Aftercare Options:</div>
                `;
            } else {
                // PLANS Document Format
                html += `
                    <div class="doc-greeting">Hello,</div>
                    <div class="doc-intro">
                        Below is ${clientName}'s aftercare plan. Included in this list is: contact information, location, website, 
                        and a breakdown of specialties and services provided by the program.
                    </div>
                    <div class="doc-section-header">Aftercare Plan:</div>
                `;
            }
            
            // Group programs by type if using categories
            let currentCategory = '';
            
            // Add programs in user-arranged order
            orderedPrograms.forEach(program => {
                // Extract demographic info from features or use defaults
                let demographics = '';
                let ageRange = '';
                
                // Look for age and gender info in features
                program.features.forEach(feature => {
                    if (feature.toLowerCase().includes('gender')) {
                        demographics = feature.includes('All') ? 'All-Gender' : feature;
                    }
                    if (feature.toLowerCase().includes('age')) {
                        const ageMatch = feature.match(/(\d+)[\s-‚Äì]+(\d+)/);
                        if (ageMatch) {
                            ageRange = `Ages ${ageMatch[1]}‚Äì${ageMatch[2]}`;
                        }
                    }
                });
                
                // Build the title line with en dash
                const titleParts = [program.name];
                if (program.type) titleParts.push(program.type);
                const titleBase = titleParts.join(' ‚Äì ');
                const titleDemo = (demographics || ageRange) ? ` (${[demographics, ageRange].filter(Boolean).join(', ')})` : '';
                
                // Handle custom programs - MUST follow exact Calibri format
                if (program.isCustom) {
                    const details = program.clinicalDetails || {};
                    const contact = program.contact || {};
                    const location = program.location || '';
                    
                    // Clean the level of care text
                    const cleanLevelOfCare = cleanProgramText(program.levelOfCare || program.type || 'Treatment program');
                    
                    html += `
                        <div class="doc-program">
                            <div class="doc-program-title">${cleanProgramText(program.name)}${location ? ` ‚Äì ${cleanProgramText(location)}` : ''}</div>
                            
                            <div class="doc-program-descriptor">
                                <strong>Level of Care & Services Provided:</strong><br>
                                ${cleanLevelOfCare}${details.ageRange ? ` for adolescents ages ${details.ageRange}` : ' for adolescents and young adults'}${details.primaryIssues ? `. Specializes in ${details.primaryIssues.toLowerCase()}.` : '.'}
                            </div>
                            
                            <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                            <ul class="doc-program-bullets">
                                ${program.features && program.features.length > 0 ? program.features.map(feature => {
                                    // Clean the feature text
                                    const cleanFeature = cleanProgramText(feature);
                                    if (!cleanFeature) return '';
                                    
                                    // Format features with bold concept introductions
                                    if (cleanFeature.includes(':')) {
                                        const [concept, description] = cleanFeature.split(':');
                                        return `<li><strong>${concept.trim()}:</strong>${description.trim()}</li>`;
                                    }
                                    return `<li>${cleanFeature}</li>`;
                                }).filter(Boolean).join('') : '<li>Treatment program with comprehensive therapeutic services</li>'}
                                ${details.specializedTherapies ? `<li><strong>Therapeutic Modalities:</strong> ${cleanProgramText(details.specializedTherapies)}</li>` : ''}
                                ${details.academicProgram ? `<li><strong>Academic Program:</strong> ${cleanProgramText(details.academicProgram)}</li>` : ''}
                                ${details.staffRatio ? `<li><strong>Staff-to-Client Ratio:</strong> ${details.staffRatio}</li>` : ''}
                                ${details.insurance ? `<li><strong>Insurance:</strong> ${cleanProgramText(details.insurance)}</li>` : ''}
                            </ul>
                            
                            <div class="doc-program-details-heading">Contact Information:</div>
                            <div class="doc-contact-section">
                                ${contact.phone ? `Phone: ${contact.phone}<br>` : ''}
                                ${contact.email ? `Email: ${contact.email}<br>` : ''}
                                ${contact.website ? `Website: ${contact.website}<br>` : ''}
                                ${location ? `Address: ${cleanProgramText(location)}` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // Extract services from levelOfCare
                    const services = program.levelOfCare.includes('Services:') 
                        ? program.levelOfCare.split('Services:')[1]?.trim() 
                        : 'Clinical Therapy, Psychiatric Support, Dual Diagnosis, Academics, Family Work';
                    
                    const location = program.location || '';
                    html += `
                        <div class="doc-program">
                            <div class="doc-program-title">${program.name}${location ? ` ‚Äì ${location}` : ''}</div>
                            
                            <div class="doc-program-descriptor">
                                <strong>Level of Care & Services Provided:</strong><br>
                                ${program.type || 'Residential treatment'} program for ${demographics || ageRange || 'adolescents and young adults'}. ${services ? `Provides ${services.toLowerCase()}.` : ''}
                            </div>
                            
                            <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                            <ul class="doc-program-bullets">
                                ${program.features.map(feature => {
                                // Format features with bold concept introductions
                                if (feature.includes(':')) {
                                    const [concept, description] = feature.split(':');
                                    return `<li><strong>${concept}:</strong>${description}</li>`;
                                }
                                return `<li>${feature}</li>`;
                            }).join('')}
                        </ul>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            ${program.contact.phone ? `Phone: ${program.contact.phone}<br>` : ''}
                            ${program.contact.email ? `Email: ${program.contact.email}<br>` : ''}
                            ${program.contact.website ? `Website: ${normalizeUrl(program.contact.website)}<br>` : ''}
                            ${program.location ? `Address: ${program.location}` : ''}
                        </div>
                    </div>
                `;
                }
            });
            
            // Add AT HOME Recommendations if checkbox is checked
            const includeAtHome = document.getElementById('includeAtHome').checked;
            console.log('Include AT HOME:', includeAtHome, 'Document Type:', documentType);
            if (includeAtHome && documentType === 'options' && atHomeProviders.length > 0) {
                html += `
                    <div class="doc-section-header doc-emphasis-section" style="margin-top: 24pt;">
                        AT HOME Recommendation: If extended residential care is not a viable option, below are the clinical recommendations should your child return home.
                    </div>
                `;
                
                // Group providers by service type for better organization
                const serviceGroups = {};
                atHomeProviders.forEach(provider => {
                    if (provider.name && provider.phone) { // Only include providers with required fields
                        const service = provider.service || 'General Services';
                        if (!serviceGroups[service]) {
                            serviceGroups[service] = [];
                        }
                        serviceGroups[service].push(provider);
                    }
                });
                
                // Render each service group using standard program formatting
                Object.keys(serviceGroups).forEach(service => {
                    html += `<div class="doc-category-header">${service}</div>`;
                    
                    serviceGroups[service].forEach(provider => {
                        const website = normalizeUrl(provider.website);
                        html += `
                            <div class="doc-program">
                                <div class="doc-program-title">${provider.name}${provider.address ? ` ‚Äì ${provider.address}` : ''}</div>
                                
                                <div class="doc-program-descriptor">
                                    <strong>Level of Care & Services Provided:</strong><br>
                                    ${provider.service || 'General Services'} - Community-based support for continued care at home.
                                </div>
                                
                                <div class="doc-program-details-heading">Contact Information:</div>
                                <div class="doc-contact-section">
                                    ${provider.phone ? `<strong>Phone:</strong> ${provider.phone}<br>` : ''}
                                    ${website ? `<strong>Website:</strong> <a href="${website}" target="_blank" rel="noopener">${website}</a><br>` : ''}
                                    ${provider.address ? `<strong>Address:</strong> ${provider.address}` : ''}
                                </div>
                            </div>
                        `;
                    });
                });
            } else if (includeAtHome && documentType === 'options') {
                html += `
                    <div class="doc-section-header doc-emphasis-section" style="margin-top: 24pt;">
                        AT HOME Recommendation: If extended residential care is not a viable option, below are the clinical recommendations should your child return home.
                    </div>
                    
                    <div class="doc-category-header">PHP Options</div>
                    
                    <!-- Standard program format for manual entry -->
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________ ‚Äì PHP, _____________ Location</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Partial Hospitalization Program - Intensive day treatment for adolescents requiring structured support.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                            ‚Ä¢ <strong>Clinical Approach:</strong> _________________________________________________<br>
                            ‚Ä¢ <strong>Population Served:</strong> ________________________________________________<br>
                            ‚Ä¢ <strong>Schedule:</strong> _________________________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________ ‚Äì PHP, _____________ Location</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Partial Hospitalization Program - Intensive day treatment for adolescents requiring structured support.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                            ‚Ä¢ <strong>Clinical Approach:</strong> _________________________________________________<br>
                            ‚Ä¢ <strong>Population Served:</strong> ________________________________________________<br>
                            ‚Ä¢ <strong>Schedule:</strong> _________________________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                    
                    <div class="doc-category-header">IOP Options</div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________ ‚Äì IOP, _____________ Location</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Intensive Outpatient Program - Structured outpatient treatment for adolescents transitioning to community care.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                            ‚Ä¢ <strong>Clinical Approach:</strong> _________________________________________________<br>
                            ‚Ä¢ <strong>Population Served:</strong> ________________________________________________<br>
                            ‚Ä¢ <strong>Schedule:</strong> _________________________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                    
                    <div class="doc-category-header">Therapeutic Support</div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________ ‚Äì Individual Therapy</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Individual Therapy - One-on-one therapeutic support for continued mental health care.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                            ‚Ä¢ <strong>Therapeutic Approach:</strong> _______________________________________________<br>
                            ‚Ä¢ <strong>Specialties:</strong> _______________________________________________________<br>
                            ‚Ä¢ <strong>Session Frequency:</strong> __________________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">_________________________ ‚Äì Psychiatry</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Psychiatric Services - Medication management and psychiatric evaluation for ongoing mental health care.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <div class="doc-program-details">
                            ‚Ä¢ <strong>Services Offered:</strong> __________________________________________________<br>
                            ‚Ä¢ <strong>Specialties:</strong> _______________________________________________________<br>
                            ‚Ä¢ <strong>Appointment Frequency:</strong> ______________________________________________
                        </div>
                        
                        <div class="doc-program-details-heading">Contact Information:</div>
                        <div class="doc-contact-section">
                            <strong>Phone:</strong> ___________________________________<br>
                            <strong>Website:</strong> _________________________________<br>
                            <strong>Address:</strong> __________________________________
                        </div>
                    </div>
                `;
            }
            
            // Add Alumni Services if checkbox is checked
            const includeAlumni = document.getElementById('includeAlumni').checked;
            if (includeAlumni) {
                html += `
                    <div class="doc-section-header doc-emphasis-section" style="margin-top: 24pt;">Alumni Services</div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">Parent Focus Group</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Weekly virtual support groups for parents of FFA alumni, providing a continued community space to share experiences, challenges, and successes in long-term recovery and family reintegration.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <ul class="doc-program-bullets">
                            <li><strong>Peer Support:</strong> Connect with other parents who understand the unique challenges of supporting adolescents in recovery</li>
                            <li><strong>Facilitated Discussions:</strong> Structured sessions led by experienced alumni services staff who provide guidance and resources</li>
                            <li><strong>Flexible Scheduling:</strong> Two weekly sessions available to accommodate different family schedules and time zones</li>
                            <li><strong>Ongoing Resources:</strong> Access to FFA's continued support network, clinical insights, and evidence-based parenting strategies</li>
                            <li><strong>Confidential Environment:</strong> Safe, judgment-free space for honest dialogue about ongoing family dynamics and recovery challenges</li>
                        </ul>
                        
                        <div class="doc-program-details-heading">Meeting Schedule & Access:</div>
                        <div class="doc-contact-section">
                            <strong>Thursday Sessions:</strong> 3:30pm-5:00pm EST<br>
                            Zoom Link: <a href="https://us06web.zoom.us/j/89418742321?pwd=lln0XmbUHF1bk4bUi7y4Q6GObFmMQh.1" target="_blank" rel="noopener">Join Thursday Meeting</a><br>
                            Meeting ID: 894 1874 2321 | Passcode: 056912<br><br>
                            
                            <strong>Friday Sessions:</strong> 3:30pm-5:00pm EST<br>
                            Zoom Link: <a href="https://us06web.zoom.us/j/89876708775?pwd=swYjZuM7EiUr89sR8SYpY7M60y1FAH.1" target="_blank" rel="noopener">Join Friday Meeting</a><br>
                            Meeting ID: 898 7670 8775 | Passcode: 374367
                        </div>
                    </div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">Alumni Programming (Parent Support Group)</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Bi-weekly virtual support groups providing ongoing guidance, emotional support, and practical resources for families navigating long-term recovery, home transitions, and sustained family wellness.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <ul class="doc-program-bullets">
                            <li><strong>Extended Alumni Community:</strong> Broader network connecting families across multiple FFA programs and graduation years</li>
                            <li><strong>Topic-Focused Sessions:</strong> Rotating curriculum addressing specific challenges such as college transitions, family boundaries, relapse prevention, and sibling dynamics</li>
                            <li><strong>Multiple Weekly Options:</strong> Wednesday and Sunday sessions to maximize accessibility and accommodate varying family commitments</li>
                            <li><strong>Clinical Expertise:</strong> Led by FFA clinical staff with specialized training in family systems and adolescent development</li>
                            <li><strong>Long-Term Success Focus:</strong> Emphasis on building sustainable family communication patterns and maintaining recovery gains over time</li>
                            <li><strong>Resource Library Access:</strong> Curated materials, worksheets, and recommended readings shared with all participants</li>
                        </ul>
                        
                        <div class="doc-program-details-heading">Meeting Schedule & Access:</div>
                        <div class="doc-contact-section">
                            <strong>Meeting Times:</strong> Wednesday and Sunday, 7:00pm-8:00pm EST<br>
                            Zoom Link: <a href="https://us02web.zoom.us/j/88924044948?pwd=aUl2ejRFdldXODFyRlZrVorVGNaUT09" target="_blank" rel="noopener">Join Meeting</a><br>
                            Meeting ID: 889 2404 4948 | Passcode: Family123
                        </div>
                    </div>
                    
                    <div class="doc-program">
                        <div class="doc-program-title">PRESERVE Alumni Programming</div>
                        
                        <div class="doc-program-descriptor">
                            <strong>Level of Care & Services Provided:</strong><br>
                            Specialized weekly virtual programming exclusively for PRESERVE program alumni, offering targeted continued care focused on maintaining therapeutic gains, developing independent living skills, and fostering long-term peer connections.
                        </div>
                        
                        <div class="doc-program-details-heading">Program Details / Differentiating Features:</div>
                        <ul class="doc-program-bullets">
                            <li><strong>PRESERVE-Specific Support:</strong> Tailored to the unique intensive treatment model and clinical approach of the PRESERVE program</li>
                            <li><strong>Skill Reinforcement:</strong> Continued practice of DBT, CBT, and other therapeutic modalities learned during residential treatment</li>
                            <li><strong>Alumni Peer Network:</strong> Build lasting relationships with fellow PRESERVE graduates who share similar treatment experiences and recovery journeys</li>
                            <li><strong>Transition Support:</strong> Guidance for navigating the critical post-treatment period, including academic reintegration, family dynamics, and community involvement</li>
                            <li><strong>Weekly Accountability:</strong> Consistent touchpoint to maintain momentum, celebrate progress, and address emerging challenges before they escalate</li>
                            <li><strong>Direct Access to PRESERVE Staff:</strong> Ongoing connection with familiar clinical team members who understand each participant's treatment history</li>
                        </ul>
                        
                        <div class="doc-program-details-heading">Meeting Schedule & Access:</div>
                        <div class="doc-contact-section">
                            <strong>Meeting Time:</strong> Friday, 4:30pm-5:30pm EST<br>
                            Zoom Link: <a href="https://us06web.zoom.us/j/86864413744" target="_blank" rel="noopener">Join Meeting</a><br>
                            Meeting ID: 868 6441 3744
                        </div>
                    </div>
                `;
            }
            
            // Close content div
            html += `
                    </div>
                    
                    <!-- Footer - stacked format -->
                    <div class="doc-footer">
                        <div>700 Village Square Crossing, Unit 101, Palm Beach Gardens, FL 33410</div>
                        <div>(561) 328-7370 ‚Ä¢ familyfirstas.com</div>
                    </div>
                </div>
            `;
            
            // Cache generated document for preview, printing, and downloads
            lastDocumentHtml = html;
            const outputContainer = document.getElementById('documentOutput');
            if (outputContainer) {
                outputContainer.innerHTML = html;
            }
            renderDocumentPreview(html);
            clearInterval(progressInterval); // Clear progress updates
            hideEnhancedLoading();
            openDocumentPreview();
            showSuccessMessage('Document ready ‚Äî review before printing.');
            
            // Save to vault and history with enhanced metadata
            const vaultDoc = {
                clientName: clientName,
                date: new Date().toISOString(),
                content: html,
                type: 'aftercare',
                documentType: documentType,
                programs: selectedPrograms.map(p => ({
                    name: p.name,
                    location: p.location,
                    phone: p.contact?.phone || p.phone
                })),
                atHomeProviders: atHomeProviders.length > 0 ? atHomeProviders : null,
                htmlContent: html  // Store the full HTML for PDF generation
            };
            
            // Use encrypted storage for vault - wrap in async function
            (async () => {
                const vault = await secureRetrieve(STORAGE_KEYS.documentVault) || [];
            vault.push(vaultDoc);
                await secureStore(STORAGE_KEYS.documentVault, vault);
            
            // Save to history
                await saveToHistory({
                clientName: clientName,
                documentType: documentType,
                programs: selectedPrograms
            });
            })();
            
            // Track analytics
            trackAnalytics('document').catch(console.error);
            selectedPrograms.forEach(p => {
                trackAnalytics('program', p.name).catch(console.error);
            });
            
            }, 2400); // End of setTimeout - extended for smooth animation
        }
        
        // ================ ENHANCED FUNCTIONS ================

        function renderDocumentPreview(html) {
            const container = document.getElementById('documentPreviewContainer');
            if (container) {
                container.innerHTML = html;
            }
            
            // Populate context-aware action buttons
            updateContextActions();
        }
        
        function updateContextActions() {
            const contextRow = document.getElementById('contextActionsRow');
            if (!contextRow) {
                console.warn('contextActionsRow element not found');
                return;
            }
            
            console.log('Updating context actions for documentType:', documentType);
            
            if (documentType === 'plans') {
                // Aftercare Plan ‚Üí Add to Discharge Packet (opens compiler)
                contextRow.style.gridTemplateColumns = '1fr';
                contextRow.innerHTML = `
                    <button onclick="openDischargePacketCompiler()" style="padding: 12px 16px; border-radius: 6px; border: none; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; justify-content: center; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);">
                        <span style="font-size: 18px;">üì¶</span>
                        <span>Add to Discharge Packet</span>
                        <span style="font-size: 12px; opacity: 0.9;">‚Üí Compile & Upload to Kipu</span>
                    </button>
                `;
            } else {
                // Aftercare Options ‚Üí Save to Vault (with Kipu prompt)
                contextRow.style.gridTemplateColumns = '1fr';
                contextRow.innerHTML = `
                    <button onclick="saveToVaultWithKipuPrompt()" style="padding: 12px 16px; border-radius: 6px; border: none; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; justify-content: center; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">
                        <span style="font-size: 18px;">üíæ</span>
                        <span>Save to Vault</span>
                        <span style="font-size: 12px; opacity: 0.9;">‚Üí Upload to Kipu</span>
                    </button>
                `;
            }
        }
        
        function openDischargePacketCompiler() {
            // Simply open the existing discharge packet compiler
            createDischargePacket();
        }
        
        async function saveToVaultWithKipuPrompt() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            
            // First save to vault
            await saveToVault();
            
            // Then show Kipu upload prompt
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header" style="background: #10b981; color: white;">
                        <h2>‚úÖ Saved to Vault!</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 30px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üíæ</div>
                        
                        <div style="background: #f3f4f6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; color: #374151;">Aftercare Options Saved</h3>
                            <p style="margin: 0; color: #6b7280;">
                                Client: <strong>${clientName}</strong>
                            </p>
                        </div>
                        
                        <div style="background: #dbeafe; border: 2px solid #0284c7; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #0369a1;">üì§ Ready to Upload to Kipu?</h4>
                            
                            <button onclick="window.open('https://ffa11088.kipuworks.com/', '_blank'); this.closest('.modal').remove();" 
                                    style="width: 100%; padding: 14px; background: linear-gradient(135deg, #0066cc, #0052a3); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);">
                                <span style="font-size: 20px;">üè•</span>
                                <span>Open Kipu & Upload Document</span>
                                <span style="font-size: 16px;">‚Üó</span>
                            </button>
                            
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: #64748b;">
                                Navigate to: <strong>CM tab</strong> ‚Üí <strong>Documents</strong> ‚Üí <strong>Upload</strong>
                            </p>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button onclick="this.closest('.modal').remove()" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            I'll Upload Later
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openDocumentPreview() {
            const modal = document.getElementById('documentPreviewModal');
            if (!modal) {
                console.error('Document preview modal not found!');
                return;
            }
            modal.style.display = 'block';
            requestAnimationFrame(() => modal.classList.add('show'));
        }

        function closeDocumentPreview() {
            const modal = document.getElementById('documentPreviewModal');
            if (!modal) return;
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }

        function getDocumentStyles() {
            const styleTags = Array.from(document.querySelectorAll('head style, head link[rel="stylesheet"]'));
            return styleTags.map(tag => {
                if (tag.tagName === 'STYLE') {
                    return tag.innerHTML;
                }
                if (tag.tagName === 'LINK' && tag.href) {
                    return `@import url('${tag.href}');`;
                }
                return '';
            }).join('\n');
        }

        function printDocumentPreview() {
            if (!lastDocumentHtml) {
                alert('Generate the document before printing.');
                return;
            }

            const printWindow = window.open('', '_blank', 'noopener');
            if (!printWindow) {
                alert('Unable to open print window. Please allow popups for this site.');
                return;
            }

            const styles = getDocumentStyles();
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Aftercare Recommendations</title>
                    <style>${styles}</style>
                </head>
                <body>${lastDocumentHtml}</body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 300);
        }

        async function downloadDocumentPdf(event) {
            // Get the document content
            let documentContent = '';
            const previewContainer = document.getElementById('documentPreviewContainer');
            
            if (previewContainer && previewContainer.innerHTML.trim()) {
                documentContent = previewContainer.innerHTML;
            } else if (lastDocumentHtml) {
                documentContent = lastDocumentHtml;
            } else {
                const outputContainer = document.getElementById('documentOutput');
                if (outputContainer && outputContainer.innerHTML.trim()) {
                    documentContent = outputContainer.innerHTML;
                } else {
                    alert('Please generate a document first before downloading.');
                return;
                }
            }

            // Show loading indicator
            const originalButtonText = event?.target?.innerHTML;
            if (event?.target) {
                event.target.innerHTML = '‚è≥ Generating PDF...';
                event.target.disabled = true;
            }

            try {
                // Check if jsPDF and html2canvas are loaded
                if (!window.jspdf || !window.html2canvas) {
                    throw new Error('PDF libraries not loaded. Please refresh the page and try again.');
                }

                // Create a clean container for PDF generation
                const pdfContainer = document.createElement('div');
                pdfContainer.style.position = 'absolute';
                pdfContainer.style.left = '-9999px';
                pdfContainer.style.top = '0';
                pdfContainer.style.width = '816px'; // 8.5 inches at 96 DPI
                pdfContainer.style.padding = '48px'; // 0.5 inch margins
                pdfContainer.style.background = 'white';
                pdfContainer.style.fontFamily = 'Calibri, Arial, sans-serif';
                pdfContainer.style.fontSize = '12pt';
                pdfContainer.style.lineHeight = '1.4';
                pdfContainer.style.color = '#000';
                
                // Set the content
                pdfContainer.innerHTML = documentContent;
                
                // Ensure header and footer are properly styled
                const docHeader = pdfContainer.querySelector('.doc-letterhead');
                if (docHeader) {
                    docHeader.style.marginBottom = '20px';
                }
                
                // Remove the original footer since we'll add it consistently on each page
                const docFooter = pdfContainer.querySelector('.doc-footer');
                if (docFooter) {
                    docFooter.remove();
                }
                
                // Clean up any interactive elements
                const buttons = pdfContainer.querySelectorAll('button');
                buttons.forEach(btn => btn.remove());
                
                // Ensure all styles are applied
                const allElements = pdfContainer.querySelectorAll('*');
                allElements.forEach(el => {
                    const computedStyle = window.getComputedStyle(el);
                    if (computedStyle.fontFamily.includes('Calibri')) {
                        el.style.fontFamily = 'Calibri, Arial, sans-serif';
                    }
                });
                
                document.body.appendChild(pdfContainer);

                // Wait for content to render
                await new Promise(resolve => setTimeout(resolve, 100));

                // Use html2canvas to capture the content
                const canvas = await html2canvas(pdfContainer, {
                    scale: 2, // Higher quality
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: 816,
                    windowWidth: 816
                });

                // Remove the temporary container
                document.body.removeChild(pdfContainer);

                // Create PDF from canvas
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'letter' // 612 x 792 pt
                });

                // Calculate dimensions
                const imgWidth = 612; // Letter width in points
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pageHeight = 792; // Letter height in points
                
                // Add image to PDF, handling multiple pages if needed
                let position = 0;
                let remainingHeight = imgHeight;
                let pageNum = 0;
                
                while (remainingHeight > 0) {
                    // Add a new page if not the first page
                    if (position > 0) {
                        pdf.addPage();
                    }
                    pageNum++;
                    
                    // Calculate how much of the image to add to this page
                    const pageCanvas = document.createElement('canvas');
                    const pageCtx = pageCanvas.getContext('2d');
                    const sourceY = (position * canvas.height) / imgHeight;
                    const sourceHeight = Math.min((pageHeight * canvas.height) / imgHeight, canvas.height - sourceY);
                    
                    pageCanvas.width = canvas.width;
                    pageCanvas.height = sourceHeight;
                    
                    // Draw the portion of the image for this page
                    pageCtx.drawImage(
                        canvas,
                        0, sourceY, canvas.width, sourceHeight,
                        0, 0, canvas.width, sourceHeight
                    );
                    
                    // Add to PDF
                    const pageData = pageCanvas.toDataURL('image/png');
                    const addHeight = Math.min(pageHeight, remainingHeight);
                    
                    // Add image with space for header and footer
                    const headerSpace = pageNum === 1 ? 0 : 60; // Space for header on pages 2+
                    const footerSpace = 60; // Space for footer on all pages
                    const contentHeight = Math.min(pageHeight - headerSpace - footerSpace, addHeight);
                    
                    pdf.addImage(pageData, 'PNG', 0, headerSpace, imgWidth, contentHeight);
                    
                    // Add header on pages 2+
                    if (pageNum > 1) {
                        pdf.setFontSize(16);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 153, 204); // #0099cc
                        pdf.text('Family First', 306, 30, { align: 'center' });
                        pdf.setFontSize(12);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text('ADOLESCENT SERVICES', 306, 45, { align: 'center' });
                    }
                    
                    // Add footer on all pages
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(51, 51, 51);
                    pdf.text('700 Village Square Crossing, Unit 101, Palm Beach Gardens, FL 33410', 306, pageHeight - 35, { align: 'center' });
                    pdf.text('(561) 328-7370 ‚Ä¢ familyfirstas.com', 306, pageHeight - 20, { align: 'center' });
                    
                    position += pageHeight - headerSpace;
                    remainingHeight -= pageHeight - headerSpace;
                }

                        // Get client name for filename
                        const clientNameInput = document.getElementById('clientName');
                        const clientName = clientNameInput ? 
                            (clientNameInput.value || 'Client').trim().replace(/[^a-zA-Z0-9]/g, '-') : 
                            'Client';
                        
                        const date = new Date().toISOString().split('T')[0];
                        const docTypeLabel = documentType === 'options' ? 'Options' : 'Plans';
                        const filename = `${clientName}_${docTypeLabel}_${date}.pdf`;
                        
                        // Save the PDF
                pdf.save(filename);
                        
                        // Show success message
                        showSuccessMessage('PDF downloaded successfully!');

            } catch (error) {
                console.error('PDF generation error:', error);
                
                // Fallback to simple download method
                try {
                    fallbackDownloadMethod();
                } catch (fallbackError) {
                    console.error('Fallback download failed:', fallbackError);
                    alert('Unable to generate PDF. Please try the Print option and save as PDF instead.');
                }
            } finally {
                // Clean up
                const pdfContainer = document.querySelector('div[style*="-9999px"]');
                if (pdfContainer) {
                    document.body.removeChild(pdfContainer);
                }
                
                // Restore button
                if (event?.target) {
                    event.target.innerHTML = originalButtonText || '‚¨áÔ∏è Download PDF';
                    event.target.disabled = false;
                }
            }
        }

        // Case Manager Workflow Functions
        function emailDocument() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            // Create email content
            const subject = `Aftercare Document - ${clientName}`;
            const body = `Please find the aftercare document for ${clientName}.${notes ? '\n\nCase Management Notes:\n' + notes : ''}`;
            
            // Open email client
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            showSuccessMessage('Email client opened with document details');
        }

        async function saveToVault() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            if (!lastDocumentHtml) {
                showErrorMessage('Please generate a document first');
                return;
            }
            
            try {
                // Retrieve existing vault with decryption
                const vault = await secureRetrieve(STORAGE_KEYS.documentVault) || [];
                
            const documentData = {
                id: Date.now(),
                clientName: clientName,
                type: 'aftercare',
                content: lastDocumentHtml,
                notes: notes,
                date: new Date().toISOString(),
                programs: getSelectedPrograms()
            };
            
            vault.push(documentData);
                
                // Save with AES-256 encryption
                const encrypted = await secureStore(STORAGE_KEYS.documentVault, vault);
                
                if (encrypted) {
                    showSuccessMessage('üîê Document encrypted and saved to vault');
                } else {
                    showSuccessMessage('Document saved to vault');
                }
            } catch (error) {
                console.error('Save to vault error:', error);
                showErrorMessage('Failed to save document to vault');
            }
        }

        async function addToDischargePacket() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            if (!lastDocumentHtml) {
                showErrorMessage('Please generate a document first');
                return;
            }
            
            try {
                // Get encrypted discharge packets
                const packets = await secureRetrieve(STORAGE_KEYS.dischargePackets) || [];
            let clientPacket = packets.find(p => p.clientName === clientName);
            
            if (!clientPacket) {
                clientPacket = {
                    clientName: clientName,
                    documents: [],
                    created: new Date().toISOString()
                };
                packets.push(clientPacket);
            }
            
            clientPacket.documents.push({
                type: 'aftercare',
                content: lastDocumentHtml,
                notes: notes,
                    added: new Date().toISOString(),
                    programs: getSelectedPrograms()
                });
                
                // Save with encryption
                await secureStore(STORAGE_KEYS.dischargePackets, packets);
                
                // Show enhanced success modal with Kipu prompt
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header" style="background: #8b5cf6; color: white;">
                            <h2>üì¶ Added to Discharge Packet</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()" style="color: white;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 30px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
                            
                            <div style="background: #f3f4f6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <h3 style="margin: 0 0 10px 0; color: #374151;">Client: ${clientName}</h3>
                                <p style="margin: 0; color: #6b7280; font-size: 18px;">
                                    <strong>${clientPacket.documents.length}</strong> document(s) in packet
                                </p>
                            </div>
                            
                            ${clientPacket.documents.length >= 2 ? `
                                <div style="background: #dbeafe; border: 2px solid #0284c7; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 15px 0; color: #0369a1;">üöÄ Ready to Finalize?</h4>
                                    
                                    <button onclick="createDischargePacket(); this.closest('.modal').remove();" 
                                            style="width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                        üìÑ Create Full Discharge Packet
                                    </button>
                                    
                                    <button onclick="window.open('https://ffa11088.kipuworks.com/', '_blank'); this.closest('.modal').remove();" 
                                            style="width: 100%; padding: 14px; background: linear-gradient(135deg, #0066cc, #0052a3); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);">
                                        <span style="font-size: 20px;">üè•</span>
                                        <span>Open Kipu Now</span>
                                        <span style="font-size: 16px;">‚Üó</span>
                                    </button>
                                    
                                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #64748b;">
                                        Create packet first, then upload to CM tab
                                    </p>
                                </div>
                            ` : `
                                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px;">
                                    <p style="margin: 0; color: #92400e;">
                                        Add more documents to create a complete discharge packet
                                    </p>
                                </div>
                            `}
                        </div>
                        <div class="modal-actions">
                            <button onclick="this.closest('.modal').remove()" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Continue Working
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error adding to packet:', error);
                showErrorMessage('Failed to add document to packet');
            }
        }

        function scheduleFollowUp() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            // Create calendar event
            const title = `Follow-up: ${clientName} Aftercare`;
            const details = `Follow-up for aftercare document.${notes ? '\n\nNotes: ' + notes : ''}`;
            const startDate = new Date();
            startDate.setDate(startDate.getDate() + 7); // Default to 1 week from now
            
            const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent(details)}&dates=${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z`;
            
            window.open(calendarUrl, '_blank');
            showSuccessMessage('Calendar opened for follow-up scheduling');
        }

        function createTaskReminder() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            // Save reminder to local storage
            const reminders = JSON.parse(localStorage.getItem('ffas_reminders') || '[]');
            const reminder = {
                id: Date.now(),
                clientName: clientName,
                task: 'Follow up on aftercare document',
                notes: notes,
                dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 1 week from now
                created: new Date().toISOString(),
                completed: false
            };
            
            reminders.push(reminder);
            localStorage.setItem('ffas_reminders', JSON.stringify(reminders));
            
            showSuccessMessage('Task reminder created for 1 week from now');
        }

        function shareWithTeam() {
            const clientName = document.getElementById('clientName')?.value || 'Client';
            const notes = document.getElementById('caseManagementNotes')?.value || '';
            
            // Create shareable link or copy content
            if (navigator.share) {
                navigator.share({
                    title: `Aftercare Document - ${clientName}`,
                    text: `Aftercare document for ${clientName}${notes ? '\n\nNotes: ' + notes : ''}`,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                const shareText = `Aftercare Document - ${clientName}\n\nGenerated: ${new Date().toLocaleDateString()}\n${notes ? 'Notes: ' + notes + '\n' : ''}\nDocument available in system.`;
                
                navigator.clipboard.writeText(shareText).then(() => {
                    showSuccessMessage('Document details copied to clipboard for sharing');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = shareText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showSuccessMessage('Document details copied to clipboard for sharing');
                });
            }
        }

        function generateNewDocument() {
            // Clear current document and return to form
            closeDocumentPreview();
            
            // Optionally clear form or keep current selections
            const keepSelections = confirm('Keep current program selections for new document?');
            if (!keepSelections) {
                clearAllSelections();
            }
            
            // Clear client name to encourage new entry
            const clientNameField = document.getElementById('clientName');
            if (clientNameField) {
                clientNameField.value = '';
                clientNameField.focus();
            }
            
            showSuccessMessage('Ready to generate new document');
        }

        // Fallback download method using data URL
        function fallbackDownloadMethod() {
            const previewContainer = document.getElementById('documentPreviewContainer');
            const content = previewContainer ? previewContainer.innerHTML : lastDocumentHtml;
            
            if (!content) {
                throw new Error('No content to download');
            }

            // Create a complete HTML document
            const fullHtml = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Aftercare Recommendations</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            margin: 40px;
                        }
                        h1 { color: #0099cc; }
                        h2 { color: #333; margin-top: 30px; }
                        h3 { color: #666; }
                        .program-section {
                            margin-bottom: 30px;
                            page-break-inside: avoid;
                        }
                        @media print {
                            body { margin: 20px; }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;

            // Create blob and download
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const clientNameInput = document.getElementById('clientName');
            const clientName = clientNameInput ? 
                (clientNameInput.value || 'Client').trim().replace(/[^a-zA-Z0-9]/g, '-') : 
                'Client';
            
            a.href = url;
            a.download = `${clientName}_Aftercare.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessMessage('Document downloaded as HTML. You can open it and print to PDF.');
        }

        // Helper function to show success messages
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                font-weight: 600;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
        
        // Storage Keys
        const STORAGE_KEYS = {
            selectedPrograms: 'aftercare_selected_programs',
            documentHistory: 'aftercare_document_history',
            theme: 'aftercare_theme',
            documentVault: 'ffas_document_vault',
            dischargePackets: 'ffas_discharge_packets',
            patientRecords: 'ffas_patient_records',
            currentSession: 'ffas_current_session',
            pendingPacketFiles: 'ffas_pending_packet_files'
        };
        
        // Current client session tracking (HIPAA compliant - no PHI)
        let currentClientSession = {
            sessionId: null,
            clientFirstName: '',
            startTime: null,
            hasGeneratedDoc: false
        };
        
        // Handle client name entry (start session)
        function handleClientNameEntry(input) {
            const firstName = input.value.trim();
            
            // Only start session if valid name entered
            if (firstName && firstName.length >= 2 && !/[\s\d]/.test(firstName)) {
                // Check if this is a new name (different from current session)
                if (!currentClientSession.sessionId || currentClientSession.clientFirstName !== firstName) {
                    startClientSession(firstName);
                }
            }
        }
        
        // Start a new client session
        function startClientSession(firstName) {
            const sessionId = `S${Date.now().toString().slice(-6)}-${Math.random().toString(36).substr(2, 3).toUpperCase()}`;
            currentClientSession = {
                sessionId: sessionId,
                clientFirstName: firstName,
                startTime: new Date().toISOString(),
                hasGeneratedDoc: false
            };
            
            // Save to sessionStorage (clears on browser close - HIPAA compliant)
            sessionStorage.setItem(STORAGE_KEYS.currentSession, JSON.stringify(currentClientSession));
            
            // Update UI indicator
            const indicator = document.getElementById('sessionIndicator');
            if (indicator) {
                indicator.textContent = `üìã ${sessionId} | ${firstName}`;
                indicator.style.display = 'block';
            }
            
            console.log(`Started session ${sessionId} for ${firstName}`);
        }
        
        // End current session
        function endClientSession() {
            if (currentClientSession.sessionId) {
                showNotification(`Session ${currentClientSession.sessionId} ended`, 'info');
            }
            
            currentClientSession = {
                sessionId: null,
                clientFirstName: '',
                startTime: null,
                hasGeneratedDoc: false
            };
            
            sessionStorage.removeItem(STORAGE_KEYS.currentSession);
            sessionStorage.removeItem(STORAGE_KEYS.pendingPacketFiles);
            
            const indicator = document.getElementById('sessionIndicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }
        
        // Restore session on page load
        function restoreClientSession() {
            const saved = sessionStorage.getItem(STORAGE_KEYS.currentSession);
            if (saved) {
                try {
                    currentClientSession = JSON.parse(saved);
                    const indicator = document.getElementById('sessionIndicator');
                    if (indicator && currentClientSession.sessionId) {
                        indicator.textContent = `üìã Active Session: ${currentClientSession.sessionId}`;
                        indicator.style.display = 'block';
                    }
                } catch (e) {
                    console.error('Failed to restore session:', e);
                }
            }
        }
        
        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            
            if (isDark) {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Light Mode';
                localStorage.setItem(STORAGE_KEYS.theme, 'dark');
            } else {
                icon.textContent = 'üåô';
                text.textContent = 'Dark Mode';
                localStorage.setItem(STORAGE_KEYS.theme, 'light');
            }
        }
        
        // Priority Management
        let currentPriority = 'high';
        function setPriority(level, btn) {
            currentPriority = level;
            document.querySelectorAll('.priority-btn').forEach(b => {
                b.classList.remove('active');
                b.style.background = 'white';
            });
            btn.classList.add('active');
            if (level === 'urgent') {
                btn.style.background = '#fee2e2';
            } else if (level === 'high') {
                btn.style.background = '#fef3c7';
            } else {
                btn.style.background = '#dcfce7';
            }
        }
        
        // Quick Selection Functions for Case Managers
        function selectLevelOfCare(level) {
            const programs = document.querySelectorAll('.program-card');
            programs.forEach(card => {
                const programText = card.textContent.toLowerCase();
                if ((level === 'PHP' && programText.includes('partial hospitalization')) ||
                    (level === 'IOP' && (programText.includes('intensive outpatient') || programText.includes('iop')))) {
                    if (!card.classList.contains('selected')) {
                        card.click();
                    }
                }
            });
            showSuccessMessage(`Selected all ${level} programs`);
        }
        
        function selectVirtualPrograms() {
            const programs = document.querySelectorAll('.program-card');
            programs.forEach(card => {
                const programText = card.textContent.toLowerCase();
                if (programText.includes('virtual') || programText.includes('online') || programText.includes('telehealth')) {
                    if (!card.classList.contains('selected')) {
                        card.click();
                    }
                }
            });
            showSuccessMessage('Selected all virtual programs');
        }
        
        function clearAllSelections() {
            const selectedPrograms = document.querySelectorAll('.program-card.selected');
            selectedPrograms.forEach(card => card.click());
            showSuccessMessage('Cleared all selections');
        }
        
        // Select All Programs
        function selectAllPrograms() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            let toSelect = programs;
            
            if (currentFilter !== 'all') {
                toSelect = toSelect.filter(p => p.category === currentFilter);
            }
            
            toSelect.forEach(program => {
                if (!selectedPrograms.find(p => p.id === program.id)) {
                    selectedPrograms.push(program);
                }
            });
            
            updateSelectedPrograms();
            displayPrograms();
        }
        
        // Clear All Programs
        function clearAllPrograms() {
            if (selectedPrograms.length === 0) {
                showNotification('No programs to clear', 'info');
                return;
            }
            
            const count = selectedPrograms.length;
            const msg = `Clear ${count} program${count > 1 ? 's' : ''}?`;
            
            if (confirm(msg)) {
                // Save for undo
                saveUndoAction('clear', { programs: [...selectedPrograms] });
            selectedPrograms = [];
                updateSelectionPanel();
                renderPrograms();
                showNotification(`Cleared ${count} program${count > 1 ? 's' : ''}`, 'info');
            }
        }
        
        // Select by Category
        function selectByCategory() {
            const category = prompt('Enter category (virtual, rtc, tbs, wilderness, php-iop, transitional):');
            if (category) {
                const categoryPrograms = programs.filter(p => p.category === category.toLowerCase());
                categoryPrograms.forEach(program => {
                    if (!selectedPrograms.find(p => p.id === program.id)) {
                        selectedPrograms.push(program);
                    }
                });
                updateSelectedPrograms();
                displayPrograms();
            }
        }
        
        // Compare Programs
        function comparePrograms() {
            if (selectedPrograms.length < 2) {
                alert('Please select at least 2 programs to compare');
                return;
            }
            
            const comparisonView = document.getElementById('comparisonView');
            const content = document.getElementById('comparisonContent');
            
            const comparePrograms = selectedPrograms.slice(0, 3);
            
            content.innerHTML = comparePrograms.map(program => `
                <div class="comparison-column">
                    <h3>${program.name}</h3>
                    <p><strong>Location:</strong> ${program.location}</p>
                    <p><strong>Type:</strong> ${program.type}</p>
                    <p><strong>Level of Care:</strong> ${program.levelOfCare}</p>
                    <h4>Features:</h4>
                    <ul style="font-size: 12px;">
                        ${program.features.slice(0, 5).map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
            
            comparisonView.style.display = 'block';
        }
        
        function closeComparison() {
            document.getElementById('comparisonView').style.display = 'none';
        }
        
        // Document History
        async function saveToHistory(documentData) {
            // Retrieve with decryption
            let history = await secureRetrieve(STORAGE_KEYS.documentHistory) || [];
            
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                clientName: documentData.clientName,
                documentType: documentData.documentType,
                programCount: documentData.programs.length,
                programs: documentData.programs
            };
            
            history.unshift(historyItem);
            
            if (history.length > 10) {
                history = history.slice(0, 10);
            }
            
            // Save with encryption
            await secureStore(STORAGE_KEYS.documentHistory, history);
            updateHistoryPanel().catch(console.error);
        }
        
        async function updateHistoryPanel() {
            const historyContent = document.getElementById('historyContent');
            const history = await secureRetrieve(STORAGE_KEYS.documentHistory) || [];
            
            if (history.length === 0) {
                historyContent.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">No documents generated yet</p>';
                return;
            }
            
            historyContent.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadFromHistory('${item.id}')">
                    <strong>${item.clientName}</strong><br>
                    <small>${new Date(item.timestamp).toLocaleString()}</small><br>
                    <small>${item.documentType.toUpperCase()} - ${item.programCount} programs</small>
                </div>
            `).join('');
        }
        
        function loadFromHistory(historyId) {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEYS.documentHistory) || '[]');
            const item = history.find(h => h.id == historyId);
            
            if (item) {
                document.getElementById('clientName').value = item.clientName;
                selectedPrograms = item.programs;
                updateSelectedPrograms();
                displayPrograms();
                toggleHistory();
            }
        }
        
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('active');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                updateHistoryPanel().catch(console.error);
            }
        }
        
        // Export Database
        function exportDatabase() {
            const exportData = {
                version: programDatabase.version,
                exportDate: new Date().toISOString(),
                programs: programs,
                totalPrograms: programs.length
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `aftercare_programs_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Import Database
        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        if (importData.programs && Array.isArray(importData.programs)) {
                            if (confirm(`Import ${importData.programs.length} programs?`)) {
                                programs.length = 0;
                                programs.push(...importData.programs);
                                displayPrograms();
                                alert('Database imported successfully!');
                            }
                        }
                    } catch(error) {
                        alert('Error importing database: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchBox').focus();
            }
            
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                generateDocument();
            }
            
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
            }
        });
        
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Application error:', event.error);
            if (typeof showNotification === 'function') {
                showNotification('Something went wrong. Your work has been saved. Please refresh the page.', 'error');
            }
            // Try to save state before potential crash
            try {
                autoSaveState();
            } catch (e) {
                console.error('Failed to save state during error:', e);
            }
        });
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            if (typeof showNotification === 'function') {
                showNotification('An error occurred. Please try again.', 'error');
            }
        });
        
        // Initialize on load
        // Removed duplicate DOMContentLoaded handler - initialization is handled above
        
        // Listen for messages from Chrome extension
        window.addEventListener('message', function(event) {
            // Handle messages from the Chrome extension
            if (event.data && (event.data.source === 'FFAS_EXTENSION' || event.data.source === 'FamilyFirstExtension')) {
                console.log('Received data from Chrome extension via postMessage:', event.data);
                
                // Make sure we're logged in first
                if (sessionStorage.getItem('isLoggedIn') !== 'true') {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('username', 'ChromeExtension');
                    // Hide login modal if visible
                    const loginModal = document.getElementById('loginModal');
                    if (loginModal) {
                        loginModal.style.display = 'none';
                    }
                    // Show the main app
                    const mainApp = document.getElementById('mainApp');
                    if (mainApp) {
                        mainApp.style.display = 'block';
                    }
                }
                
                // Handle the data with a small delay to ensure UI is ready
                if (event.data.action === 'addProgram' && event.data.data) {
                    setTimeout(() => {
                        window.handleChromeExtensionData(event.data.data);
                    }, 500);
                } else if (event.data.data) {
                    setTimeout(() => {
                        window.handleChromeExtensionData(event.data.data);
                    }, 500);
                }
            }
        });
        
        // Handle data from Chrome extension
        window.handleChromeExtensionData = function(data) {
            console.log('Processing Chrome extension data...', data);
            
            // Extract program data from various possible formats
            let programData = null;
            
            if (data && data.structured) {
                // New format with structured data
                programData = data.structured;
                console.log('Using structured data:', programData);
            } else if (data && (data.programName || data.location || data.phones)) {
                // Direct format
                programData = data;
                console.log('Using direct data format:', programData);
            } else if (data && data.compiledInfo) {
                // Compiled info format
                programData = {
                    programName: data.compiledInfo.programName || '',
                    location: Array.from(data.compiledInfo.addresses || [])[0] || '',
                    phones: Array.from(data.compiledInfo.phones || []),
                    emails: Array.from(data.compiledInfo.emails || []),
                    website: data.url || '',
                    description: data.compiledInfo.description || '',
                    therapies: Array.from(data.compiledInfo.therapies || []),
                    specializations: Array.from(data.compiledInfo.specializations || [])
                };
                console.log('Using compiledInfo format:', programData);
            } else {
                console.error('Unexpected data format:', data);
                alert('Unable to process the extracted data. Please try again.');
                return;
            }
            
            // Ensure programData has required fields
            if (!programData || typeof programData !== 'object') {
                console.error('Invalid program data:', programData);
                alert('Invalid data received from Chrome extension.');
                return;
            }
                
                // Create a custom modal for adding the program
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                    animation: fadeIn 0.3s ease;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 12px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    animation: slideUp 0.3s ease;
                `;
                
                content.innerHTML = `
                    <h2 style="margin: 0 0 20px 0; color: #333;">üì• Add Program from Chrome Extension</h2>
                    
                    <div style="background: #f0f9ff; border: 1px solid #0099cc; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <input type="text" 
                                   id="extensionProgramName" 
                                   value="${cleanProgramText(programData.programName || 'Treatment Program')}" 
                                   placeholder="Program Name"
                                   style="width: 100%; padding: 10px; border: 2px solid #0099cc; border-radius: 6px; font-size: 18px; font-weight: 600; color: #0066cc; box-sizing: border-box;"
                                   onfocus="this.style.borderColor='#0066cc'; this.style.boxShadow='0 0 0 3px rgba(0, 153, 204, 0.2)'"
                                   onblur="this.style.borderColor='#0099cc'; this.style.boxShadow='none'">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 600;">Location:</label>
                            <input type="text" 
                                   id="extensionLocation" 
                                   value="${cleanProgramText(programData.location || '')}" 
                                   placeholder="City, State"
                                   style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 600;">Phone: <span style="font-weight: normal; font-size: 12px;">(Direct contact or main number)</span></label>
                            <input type="text" 
                                   id="extensionPhone" 
                                   value="${cleanProgramText(programData.phone || (programData.phones && Array.isArray(programData.phones) ? programData.phones[0] : programData.phones) || '')}" 
                                   placeholder="(XXX) XXX-XXXX"
                                   style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 600;">Website:</label>
                            <input type="text" 
                                   id="extensionWebsite" 
                                   value="${programData.website || programData.url || window.location.href}" 
                                   placeholder="https://www.example.com"
                                   style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 600;">Email: <span style="font-weight: normal; font-size: 12px;">(Optional)</span></label>
                            <input type="text" 
                                   id="extensionEmail" 
                                   value="${cleanProgramText(programData.email || (programData.emails && Array.isArray(programData.emails) ? programData.emails[0] : programData.emails) || '')}" 
                                   placeholder="email@example.com"
                                   style="width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                        </div>
                    </div>
                    
                    ${programData.description ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">Description:</h4>
                            <p style="color: #555; line-height: 1.6;">${cleanProgramText(programData.description)}</p>
                        </div>
                    ` : ''}
                    
                    ${programData.therapies && programData.therapies.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">Therapies:</h4>
                            <ul style="color: #555; margin: 0; padding-left: 20px;">
                                ${programData.therapies.map(t => `<li>${cleanProgramText(t)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${programData.specializations && programData.specializations.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #333;">Specializations:</h4>
                            <ul style="color: #555; margin: 0; padding-left: 20px;">
                                ${programData.specializations.map(s => `<li>${cleanProgramText(s)}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button id="extensionAddBtn" style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            flex: 1;
                            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                            transition: transform 0.2s, box-shadow 0.2s;
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.3)'">
                            ‚úÖ Add Program
                        </button>
                        <button id="extensionCancelBtn" style="
                            background: #6b7280;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: background 0.2s;
                        "
                        onmouseover="this.style.background='#4b5563'"
                        onmouseout="this.style.background='#6b7280'">
                            Cancel
                        </button>
                    </div>
                `;
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // Add button handlers
                document.getElementById('extensionAddBtn').onclick = () => {
                    // Get values from editable fields
                    const programName = document.getElementById('extensionProgramName').value.trim();
                    const location = document.getElementById('extensionLocation').value.trim();
                    const phone = document.getElementById('extensionPhone').value.trim();
                    const website = document.getElementById('extensionWebsite').value.trim();
                    const email = document.getElementById('extensionEmail').value.trim();
                    
                    // Validate required fields
                    if (!programName) {
                        showNotification('Please enter a program name', 'error');
                        document.getElementById('extensionProgramName').focus();
                        return;
                    }
                    
                    // Create program object with edited values
                    const customProgram = {
                        id: 'ext_' + Date.now(),
                        name: cleanProgramText(programName),
                        location: cleanProgramText(location),
                        type: cleanProgramText(programData.type || 'Treatment Program'),
                        category: 'custom',
                        programCategory: 'Chrome Extension Programs',
                        levelOfCare: cleanProgramText(programData.description || ''),
                        features: [
                            ...(programData.therapies || []),
                            ...(programData.specializations || [])
                        ].filter(Boolean).map(f => cleanProgramText(f)),
                        contact: {
                            phone: phone,
                            website: website,
                            email: email
                        },
                        isCustom: true,
                        fromExtension: true,
                        extractedData: programData // Store original extracted data
                    };
                    
                    // Add to programs array
                    programs.push(customProgram);
                    
                    // Add to selected programs
                    selectedPrograms.push(customProgram);
                    
                    // Save and update UI
                    saveCustomPrograms();
                    renderPrograms();
                    updateSelectionPanel();
                    
                    // Remove modal
                    modal.remove();
                    
                    // Show success
                    showNotification(`‚úÖ "${customProgram.name}" added successfully!`, 'success');
                    
                    // Scroll to the program in the grid
                    setTimeout(() => {
                        const programCard = document.querySelector(`[data-program-id="${customProgram.id}"]`);
                        if (programCard) {
                            programCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            programCard.style.animation = 'pulse 1s ease 2';
                        }
                    }, 500);
                };
                
                document.getElementById('extensionCancelBtn').onclick = () => {
                    modal.remove();
                };
        }
        
        // Also check if there's data in URL params (for direct opening)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('extensionData')) {
            try {
                const data = JSON.parse(decodeURIComponent(urlParams.get('extensionData')));
                if (data.source === 'FFAS_EXTENSION') {
                    // Auto-login when coming from extension
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('username', 'ChromeExtension');
                    
                    // Initialize encryption for extension
                    if (DataEncryption.isSupported()) {
                        dataEncryption.initialize('ChromeExtension').then(() => {
                            console.log('üîí Encryption initialized for extension data');
                            if (typeof enableAutoSave === 'function') {
                                enableAutoSave();
                            }
                        }).catch(console.error);
                    }
                    
                    // Process the data after a short delay
                    setTimeout(() => {
                        handleChromeExtensionData(data.data);
                    }, 500);
                }
            } catch (e) {
                console.error('Failed to parse extension data from URL:', e);
            }
        }
        
        // Check for simple extension flag to bypass login
        if (urlParams.has('fromExtension')) {
            // Auto-login when coming from extension
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('username', 'ChromeExtension');
            
            // Force reload to apply login
            if (!sessionStorage.getItem('extensionReloaded')) {
                sessionStorage.setItem('extensionReloaded', 'true');
                window.location.reload();
            } else {
            // Clear the reload flag
            sessionStorage.removeItem('extensionReloaded');
            
            // Wait for page to initialize then check clipboard
            setTimeout(async () => {
                showNotification('Chrome Extension connected! Waiting for program data...', 'info');
                
                // Check if autoOpen flag is set (extension will send data via postMessage)
                if (urlParams.has('autoOpen')) {
                    // Extension will send data automatically, just wait
                    console.log('Waiting for extension to send data via postMessage...');
                    return;
                }
                
                // Otherwise try to read from clipboard - user must click Allow
                showNotification('Click "Allow" to paste program data from clipboard.', 'info');
                try {
                    const clipboardText = await navigator.clipboard.readText();
                    if (clipboardText && (clipboardText.includes('Treatment Program') || clipboardText.includes('Location:') || clipboardText.includes('Phone:'))) {
                        // Parse the clipboard data
                        const lines = clipboardText.split('\n');
                        const programData = {
                            structured: {
                                programName: lines[0] || 'Extracted Program',
                                location: '',
                                phones: [],
                                website: '',
                                description: '',
                                therapies: [],
                                specializations: []
                            }
                        };
                        
                        // Extract data from clipboard format
                        lines.forEach(line => {
                            if (line.startsWith('Location:')) {
                                programData.structured.location = line.replace('Location:', '').trim();
                            } else if (line.startsWith('Phone:')) {
                                programData.structured.phones = [line.replace('Phone:', '').trim()];
                            } else if (line.startsWith('Website:')) {
                                programData.structured.website = line.replace('Website:', '').trim();
                            } else if (line.startsWith('Description:')) {
                                programData.structured.description = lines[lines.indexOf(line) + 1] || '';
                            } else if (line.startsWith('Therapies:')) {
                                const therapyStart = lines.indexOf(line) + 1;
                                for (let i = therapyStart; i < lines.length && lines[i] && !lines[i].includes(':'); i++) {
                                    programData.structured.therapies.push(lines[i].trim());
                                }
                            } else if (line.startsWith('Specializations:')) {
                                const specStart = lines.indexOf(line) + 1;
                                for (let i = specStart; i < lines.length && lines[i] && !lines[i].includes(':'); i++) {
                                    programData.structured.specializations.push(lines[i].trim());
                                }
                            }
                        });
                        
                        // Automatically handle the data
                        handleChromeExtensionData(programData);
                    }
                } catch (err) {
                    console.log('Could not read clipboard:', err);
                    showNotification('Please paste the program data (Ctrl+V)', 'info');
                }
            }, 1500);
        }
        }
        
        // Enhanced Document Action Functions
        
        // Better Print Function
        function enhancedPrint() {
            if (!lastDocumentHtml) {
                showErrorMessage('Please generate a document first');
                return;
            }
            
            // Create print-optimized window
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print Document</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                            @page { 
                                size: letter;
                                margin: 0.5in;
                            }
                        }
                        body {
                            font-family: 'Calibri', 'Arial', sans-serif;
                            line-height: 1.4;
                            color: #000;
                        }
                        .doc-letterhead {
                            text-align: center;
                            margin-bottom: 20px;
                        }
                    </style>
                </head>
                <body>
                    ${lastDocumentHtml}
                    <${'script'}>
                        window.onload = function() {
                            window.print();
                            setTimeout(() => window.close(), 500);
                        }
                    </${'script'}>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Request notification permissions
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        // Check for due reminders
        async function checkReminders() {
            try {
                const reminders = await secureRetrieve('ffas_reminders') || [];
                const now = new Date();
                const dueReminders = reminders.filter(r => 
                    !r.completed && new Date(r.dueDate) <= now
                );
                
                if (dueReminders.length > 0 && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification(`${dueReminders.length} Reminder(s) Due!`, {
                        body: `Check your aftercare follow-ups`,
                        icon: '‚è∞'
                    });
                }
            } catch (error) {
                console.error('Error checking reminders:', error);
            }
        }
        
        // Initialize enhanced features on login
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                requestNotificationPermission();
                // Check reminders periodically
                setInterval(() => checkReminders().catch(console.error), 5 * 60 * 1000); // Every 5 minutes
                checkReminders().catch(console.error); // Initial check
            }
        });
    

        // Initialize Enhanced Features
        let featureFlags, performanceMonitor, dbManager, intelligentMatching, multiClientWorkflow, advancedFilters, clientManager, housesManager, milestonesManager, aftercareManager;
        
        // Initialize systems after DOM loaded
        document.addEventListener('DOMContentLoaded', async function() {
        // DEVELOPMENT BYPASS - Auto-login for dev mode
        const DEV_MODE = true; // Set to false for production
        if (DEV_MODE && !sessionStorage.getItem('isLoggedIn')) {
            console.log('üöÄ Development mode: Setting auto-login');
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('username', 'DevUser');
            sessionStorage.setItem('userRole', 'admin');
        }
            try {
                // Variables are already declared above, just initialize them
                
                // Initialize feature flags
                featureFlags = new FeatureFlagManager();
                window.featureFlags = featureFlags;
                
                // Initialize performance monitoring
                performanceMonitor = new PerformanceMonitor();
                window.performanceMonitor = performanceMonitor;
                
                // Initialize IndexedDB
                console.log('Initializing IndexedDB Manager...');
                dbManager = new IndexedDBManager();
                try {
                    await dbManager.init();
                    window.dbManager = dbManager;
                    console.log('‚úÖ IndexedDB Manager initialized');
                } catch (error) {
                    if (error.name === 'VersionError') {
                        console.log('Database version mismatch, clearing and retrying...');
                        await clearIndexedDB();
                        // Try once more
                        await dbManager.init();
                        window.dbManager = dbManager;
                        console.log('‚úÖ IndexedDB Manager initialized after reset');
                    } else {
                        throw error;
                    }
                }
                
                // Initialize intelligent matching
                intelligentMatching = new IntelligentMatchingSystem();
                window.intelligentMatching = intelligentMatching;
                
                // Initialize multi-client workflow
                multiClientWorkflow = new MultiClientWorkflow();
                multiClientWorkflow.loadFromStorage();
                window.multiClientWorkflow = multiClientWorkflow;
                
                // Initialize advanced filters
                advancedFilters = new AdvancedFilterSystem();
                window.advancedFilters = advancedFilters;
                
                // Initialize client manager
                console.log('Initializing ClientManager...');
                clientManager = new ClientManager(dbManager);
                await clientManager.initialize();
                window.clientManager = clientManager;
                console.log('‚úÖ ClientManager initialized:', window.clientManager);
                
                // Initialize houses manager
                console.log('Initializing HousesManager...');
                housesManager = new HousesManager(dbManager);
                await housesManager.initialize();
                window.housesManager = housesManager;
                console.log('‚úÖ HousesManager initialized:', window.housesManager);
                
                // Initialize milestones manager
                console.log('Initializing MilestonesManager...');
                milestonesManager = new MilestonesManager(dbManager);
                await milestonesManager.initialize();
                window.milestonesManager = milestonesManager;
                console.log('‚úÖ MilestonesManager initialized:', window.milestonesManager);
                
                // Initialize client tracker UI
                initializeClientTracker();
                console.log('‚úÖ Client tracker UI initialized');
                
                // Ensure tab navigation is visible after initialization
                ensureTabNavigationVisible();
                
                // Save programs to IndexedDB for offline use
                if (featureFlags.isEnabled('enableOfflineMode')) {
                    await dbManager.savePrograms(programs);
                }
                
                console.log('‚úÖ Enhanced features initialized successfully');
                
                // Add admin controls
                addAdminControls();
                
            } catch (error) {
                console.error('Failed to initialize enhanced features:', error);
            }
        });
        
        // Add admin controls to the UI
        function addAdminControls() {
            // Add keyboard shortcut for feature flags
            document.addEventListener('keydown', function(e) {
                // Ctrl+Shift+F for feature flags
                if (e.ctrlKey && e.shiftKey && e.key === 'F') {
                    e.preventDefault();
                    featureFlags.showPanel();
                }
                // Ctrl+Shift+P for performance dashboard
                if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                    e.preventDefault();
                    performanceMonitor.showDashboard();
                }
            });
            
            // Add admin menu if logged in as MasterAdmin
            const currentUser = sessionStorage.getItem('username');
            if (currentUser === 'MasterAdmin') {
                addAdminMenu();
            }
        }
        
        // Add admin menu to the UI
        function addAdminMenu() {
            const adminMenu = document.createElement('div');
            adminMenu.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                z-index: 9999;
            `;
            
            adminMenu.innerHTML = `
                <button onclick="featureFlags.showPanel()" style="
                    padding: 8px 16px;
                    background: #6366f1;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    margin-right: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
                ">‚öôÔ∏è Features</button>
                <button onclick="performanceMonitor.showDashboard()" style="
                    padding: 8px 16px;
                    background: #10b981;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                ">üìä Performance</button>
            `;
            
            document.body.appendChild(adminMenu);
        }

    

        
        // Enhanced Filter System Functions
        let enhancedFiltersVisible = false;
        
        function toggleEnhancedFilters() {
            enhancedFiltersVisible = !enhancedFiltersVisible;
            const grid = document.getElementById('enhancedFiltersGrid');
            const toggleText = document.getElementById('toggleFilterText');
            
            if (enhancedFiltersVisible) {
                grid.style.display = 'block';
                toggleText.textContent = 'Show Less';
            } else {
                grid.style.display = 'none';
                toggleText.textContent = 'Show More';
            }
        }
        
        // Initialize enhanced filters when DOM is ready
        function initEnhancedFilters() {
            // Natural language search
            const nlSearch = document.getElementById('naturalLanguageSearch');
            if (nlSearch) {
                nlSearch.addEventListener('input', debounce(handleNaturalLanguageSearch, 300));
            }
            
            // Data quality slider
            const dqSlider = document.getElementById('dataQualityFilter');
            if (dqSlider) {
                dqSlider.addEventListener('input', function(e) {
                    document.getElementById('dataQualityValue').textContent = e.target.value + '%';
                });
            }
            
            // Initialize if advanced filters are enabled
            if (window.featureFlags && window.featureFlags.isEnabled('enableAdvancedFilters')) {
                document.getElementById('enhancedFiltersContainer').style.display = 'block';
            }
        }
        
        // Handle natural language search
        function handleNaturalLanguageSearch(event) {
            const query = event.target.value;
            if (!query || query.length < 3) {
                document.getElementById('nlSearchSuggestions').style.display = 'none';
                return;
            }
            
            if (window.advancedFilters) {
                const parsed = window.advancedFilters.parseNaturalLanguage(query);
                if (parsed.confidence > 50) {
                    showNLSearchSuggestions(parsed);
                }
            }
        }
        
        // Show natural language search suggestions
        function showNLSearchSuggestions(parsed) {
            const suggestionsDiv = document.getElementById('nlSearchSuggestions');
            const filters = Object.keys(parsed.filters);
            
            if (filters.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            suggestionsDiv.innerHTML = `
                <div style="padding: 8px 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; font-size: 14px;">
                    <strong>Detected:</strong> ${filters.join(', ')}
                    <button onclick="applyNLParsedFilters(${encodeURIComponent(JSON.stringify(parsed.filters))})" 
                            style="margin-left: 10px; padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        Apply
                    </button>
                </div>
            `;
            suggestionsDiv.style.display = 'block';
        }
        
        // Apply parsed filters from natural language
        function applyNLParsedFilters(encodedFilters) {
            const filters = JSON.parse(decodeURIComponent(encodedFilters));
            
            // Clear existing filters first
            clearEnhancedFilters();
            
            // Apply each filter
            if (filters.insurance) {
                const select = document.getElementById('insuranceFilter');
                filters.insurance.forEach(ins => {
                    for (let option of select.options) {
                        if (option.value === ins) option.selected = true;
                    }
                });
            }
            
            if (filters.gender) {
                document.getElementById('genderFilter').value = filters.gender;
            }
            
            if (filters.age) {
                document.getElementById('ageFilter').value = filters.age;
            }
            
            if (filters.location) {
                if (filters.location.zip) document.getElementById('zipCodeFilter').value = filters.location.zip;
                if (filters.location.radius) document.getElementById('radiusFilter').value = filters.location.radius;
            }
            
            if (filters.specialties) {
                const select = document.getElementById('specialtiesFilter');
                filters.specialties.forEach(spec => {
                    for (let option of select.options) {
                        if (option.value === spec) option.selected = true;
                    }
                });
            }
            
            // Show the filters grid
            if (!enhancedFiltersVisible) {
                toggleEnhancedFilters();
            }
            
            // Apply the filters
            applyEnhancedFilters();
        }
        
        // Apply enhanced filters
        function applyEnhancedFilters() {
            if (!window.advancedFilters) {
                console.warn('Advanced filter system not initialized');
                // Fallback to basic filtering
                applyBasicEnhancedFilters();
                return;
            }
            
            const filters = collectEnhancedFilters();
            
            // Use advanced filter system if available
            const results = window.advancedFilters.applyFilters(programs, filters, { sortBy: 'score' });
            
            // Display results
            displayFilteredPrograms(results.results);
            
            // Show results summary
            showFilterResultsSummary(results.count, programs.length);
        }
        
        // Collect filter values
        function collectEnhancedFilters() {
            const filters = {
                insurance: Array.from(document.getElementById('insuranceFilter').selectedOptions).map(o => o.value),
                cost: Array.from(document.querySelectorAll('.cost-checkboxes input:checked')).map(cb => cb.value),
                gender: document.getElementById('genderFilter').value,
                age: document.getElementById('ageFilter').value,
                specialties: Array.from(document.getElementById('specialtiesFilter').selectedOptions).map(o => o.value),
                minDataQuality: parseInt(document.getElementById('dataQualityFilter').value)
            };
            
            // Add location if provided
            const zip = document.getElementById('zipCodeFilter').value;
            const radius = parseInt(document.getElementById('radiusFilter').value);
            if (zip && zip.length === 5) {
                filters.location = { zip, radius: radius || 50 };
            }
            
            return filters;
        }
        
        // Basic enhanced filters (fallback)
        function applyBasicEnhancedFilters() {
            const filters = collectEnhancedFilters();
            let filtered = [...programs];
            
            // Apply basic filters
            if (filters.insurance.length > 0) {
                filtered = filtered.filter(p => {
                    if (!p.insurance) return false;
                    const pInsurance = Array.isArray(p.insurance) ? p.insurance : [p.insurance];
                    return filters.insurance.some(ins => 
                        pInsurance.some(pi => pi.toLowerCase().includes(ins.toLowerCase()))
                    );
                });
            }
            
            if (filters.gender) {
                filtered = filtered.filter(p => {
                    const pGender = (p.genderServed || 'co-ed').toLowerCase();
                    return pGender === filters.gender || pGender === 'co-ed';
                });
            }
            
            if (filters.age) {
                const age = parseInt(filters.age);
                filtered = filtered.filter(p => {
                    if (!p.ageRange) return true;
                    return age >= p.ageRange.min && age <= p.ageRange.max;
                });
            }
            
            displayFilteredPrograms(filtered);
            showFilterResultsSummary(filtered.length, programs.length);
        }
        
        // Clear enhanced filters
        function clearEnhancedFilters() {
            // Clear multi-selects
            document.getElementById('insuranceFilter').selectedIndex = -1;
            document.getElementById('specialtiesFilter').selectedIndex = -1;
            
            // Clear checkboxes
            document.querySelectorAll('.cost-checkboxes input').forEach(cb => cb.checked = false);
            
            // Clear other inputs
            document.getElementById('genderFilter').value = '';
            document.getElementById('ageFilter').value = '';
            document.getElementById('zipCodeFilter').value = '';
            document.getElementById('radiusFilter').value = '50';
            document.getElementById('dataQualityFilter').value = '0';
            document.getElementById('dataQualityValue').textContent = '0%';
            document.getElementById('naturalLanguageSearch').value = '';
            
            // Hide suggestions
            document.getElementById('nlSearchSuggestions').style.display = 'none';
            document.getElementById('filterResultsSummary').style.display = 'none';
            
            // Reset display
            filterPrograms('all');
        }
        
        // Display filtered programs
        function displayFilteredPrograms(filteredPrograms) {
            // Clear current display
            currentFilteredPrograms = filteredPrograms;
            currentPage = 1;
            displayPrograms();
        }
        
        // Show filter results summary
        function showFilterResultsSummary(shown, total) {
            const summary = document.getElementById('filterResultsSummary');
            const text = document.getElementById('filterResultsText');
            
            if (shown === total) {
                summary.style.display = 'none';
            } else {
                text.textContent = `Showing ${shown} of ${total} programs based on your filters`;
                summary.style.display = 'block';
            }
        }
        
        // Apply smart preset
        function applySmartPreset(presetId) {
            clearEnhancedFilters();
            
            switch(presetId) {
                case 'nearby_quality':
                    document.getElementById('radiusFilter').value = '50';
                    document.getElementById('dataQualityFilter').value = '80';
                    document.getElementById('dataQualityValue').textContent = '80%';
                    break;
                    
                case 'insurance_accepted':
                    const insuranceSelect = document.getElementById('insuranceFilter');
                    ['Medicaid', 'Medicare'].forEach(ins => {
                        for (let option of insuranceSelect.options) {
                            if (option.value === ins) option.selected = true;
                        }
                    });
                    break;
                    
                case 'immediate_availability':
                    // This would filter by availability if we had that data
                    alert('This feature will filter programs with immediate availability once waitlist data is added.');
                    return;
            }
            
            if (!enhancedFiltersVisible) {
                toggleEnhancedFilters();
            }
            
            applyEnhancedFilters();
        }
        
        // Save filter preset
        function saveFilterPreset() {
            const name = prompt('Enter a name for this filter preset:');
            if (!name) return;
            
            const filters = collectEnhancedFilters();
            
            // Save to localStorage
            const presets = JSON.parse(localStorage.getItem('careconnect_filterPresets') || '{}');
            presets[name] = {
                filters,
                created: new Date().toISOString()
            };
            localStorage.setItem('careconnect_filterPresets', JSON.stringify(presets));
            
            alert('Filter preset saved! You can load it from the presets menu.');
        }
        
        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
       

        
        // Map System Implementation
        let programMap = null;
        let mapMarkers = [];
        let mapCircle = null;
        let mapCenter = { lat: 40.7128, lng: -74.0060 }; // Default to NYC
        let mapRadius = 50;
        let selectedMapPrograms = new Set();
        let markerCluster = null;
        let heatmapLayer = null;
        let mapViewActive = false;
        
        // Initialize map system
        function initializeMapSystem() {
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.warn('Leaflet not loaded, map features disabled');
                return;
            }
            
            // Map is now enabled by default
            // Show map container if it exists
            const mapContainer = document.getElementById('mapSystemContainer');
            if (mapContainer) {
                mapContainer.style.display = 'block';
            }
            
            // Set up radius slider
            const radiusSlider = document.getElementById('mapRadiusSlider');
            if (radiusSlider) {
                radiusSlider.addEventListener('input', function(e) {
                    mapRadius = parseInt(e.target.value);
                    document.getElementById('mapRadiusValue').textContent = mapRadius + ' mi';
                    if (programMap && mapCircle) {
                        updateRadiusCircle();
                        filterProgramsByRadius();
                    }
                });
            }
            
            console.log('‚úÖ Map system initialized');
        }
        
        // Toggle map view
        function toggleMapView() {
            mapViewActive = !mapViewActive;
            const mapContainer = document.getElementById('mapContainer');
            const mapControls = document.getElementById('mapControls');
            const mapToggle = document.getElementById('mapViewToggle');
            const vizContainer = document.getElementById('visualizationContainer');
            const tableView = document.getElementById('accessibleTableView');
            
            if (mapViewActive) {
                mapContainer.style.display = 'block';
                mapControls.style.display = 'block';
                vizContainer.style.display = 'none';
                tableView.style.display = 'none';
                mapToggle.textContent = 'Hide Map';
                mapToggle.style.background = '#ef4444';
                
                if (!programMap) {
                    initializeLeafletMap();
                } else {
                    // Refresh map size
                    setTimeout(() => {
                        programMap.invalidateSize();
                    }, 100);
                }
            } else {
                mapContainer.style.display = 'none';
                mapControls.style.display = 'none';
                mapToggle.textContent = 'Show Map View';
                mapToggle.style.background = '#6366f1';
            }
        }
        
        // Initialize Leaflet map
        function initializeLeafletMap() {
            // Hide loading overlay after initialization
            const hideLoading = () => {
                const loadingOverlay = document.getElementById('mapLoading');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            };
            
            try {
                // Create map instance
                programMap = L.map('programMap', {
                    center: [mapCenter.lat, mapCenter.lng],
                    zoom: 10,
                    zoomControl: true,
                    attributionControl: true
                });
                
                // Add tile layers with fallbacks
                const tileLayers = {
                    street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }),
                    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '¬© Esri',
                        maxZoom: 19
                    }),
                    terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenTopoMap',
                        maxZoom: 17
                    }),
                    dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '¬© CARTO',
                        maxZoom: 19
                    })
                };
                
                // Add default layer
                tileLayers.street.addTo(programMap);
                
                // Store tile layers for switching
                window.mapTileLayers = tileLayers;
                
                // Add radius circle
                mapCircle = L.circle([mapCenter.lat, mapCenter.lng], {
                    radius: mapRadius * 1609.34, // Convert miles to meters
                    fillColor: '#6366f1',
                    fillOpacity: 0.1,
                    color: '#6366f1',
                    weight: 2
                }).addTo(programMap);
                
                // Add center marker
                const centerMarker = L.marker([mapCenter.lat, mapCenter.lng], {
                    icon: L.divIcon({
                        className: 'center-marker',
                        html: '<div style="background: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    }),
                    draggable: true
                }).addTo(programMap);
                
                // Handle center marker drag
                centerMarker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    mapCenter = { lat: pos.lat, lng: pos.lng };
                    updateRadiusCircle();
                    filterProgramsByRadius();
                });
                
                // Add click to set center
                programMap.on('click', function(e) {
                    if (e.originalEvent.ctrlKey || e.originalEvent.metaKey) {
                        mapCenter = { lat: e.latlng.lat, lng: e.latlng.lng };
                        centerMarker.setLatLng(e.latlng);
                        updateRadiusCircle();
                        filterProgramsByRadius();
                    }
                });
                
                // Add programs to map
                addProgramsToMap();
                
                // Set up map events
                programMap.on('zoomend moveend', updateMapStats);
                
                hideLoading();
                console.log('‚úÖ Leaflet map initialized');
                
            } catch (error) {
                console.error('Failed to initialize map:', error);
                hideLoading();
                showMapError('Failed to initialize map. Please try refreshing the page.');
            }
        }
        
        // Add programs to map
        function addProgramsToMap() {
            if (!programMap) return;
            
            // Clear existing markers
            mapMarkers.forEach(marker => programMap.removeLayer(marker));
            mapMarkers = [];
            
            // Add markers for programs with coordinates
            const programsWithCoords = programs.filter(p => p.coordinates && p.coordinates.lat && p.coordinates.lng);
            
            programsWithCoords.forEach(program => {
                const marker = createProgramMarker(program);
                if (marker) {
                    mapMarkers.push(marker);
                    marker.addTo(programMap);
                }
            });
            
            // Update stats
            updateMapStats();
            
            console.log(`‚úÖ Added ${mapMarkers.length} programs to map`);
        }
        
        // Create program marker
        function createProgramMarker(program) {
            if (!program.coordinates) return null;
            
            // Determine marker color based on program type
            const markerColor = getMarkerColor(program);
            
            // Create custom icon
            const icon = L.divIcon({
                className: 'program-marker',
                html: `
                    <div style="
                        background: ${markerColor};
                        width: 30px;
                        height: 30px;
                        border-radius: 50% 50% 50% 0;
                        transform: rotate(-45deg);
                        border: 2px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <span style="transform: rotate(45deg); color: white; font-size: 14px;">
                            ${getProgramIcon(program.type)}
                        </span>
                    </div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            });
            
            // Create marker
            const marker = L.marker([program.coordinates.lat, program.coordinates.lng], {
                icon: icon,
                title: program.name
            });
            
            // Add popup
            const popupContent = `
                <div style="max-width: 250px;">
                    <h4 style="margin: 0 0 8px 0; color: #374151;">${program.name}</h4>
                    <p style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px;">${program.location || ''}</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px;">
                        ${program.type ? `<span style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${program.type}</span>` : ''}
                        ${program.insurance ? `<span style="background: #dbeafe; padding: 2px 6px; border-radius: 4px; font-size: 12px;">üí≥ Insurance</span>` : ''}
                    </div>
                    <button onclick="addProgramFromMap('${program.id}')" style="
                        width: 100%;
                        padding: 6px 12px;
                        background: #6366f1;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                    ">Add to Document</button>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            
            // Store program data
            marker.programData = program;
            
            return marker;
        }
        
        // Get marker color based on program type
        function getMarkerColor(program) {
            const typeColors = {
                'rtc': '#ef4444',
                'residential': '#ef4444',
                'php': '#f59e0b',
                'iop': '#10b981',
                'virtual': '#6366f1',
                'wilderness': '#22c55e',
                'evaluation': '#8b5cf6',
                'transitional': '#06b6d4'
            };
            
            const type = (program.type || '').toLowerCase();
            for (const [key, color] of Object.entries(typeColors)) {
                if (type.includes(key)) return color;
            }
            
            return '#6b7280'; // Default gray
        }
        
        // Get program icon
        function getProgramIcon(type) {
            const icons = {
                'rtc': 'üè†',
                'residential': 'üè†',
                'php': '‚òÄÔ∏è',
                'iop': 'üïê',
                'virtual': 'üíª',
                'wilderness': 'üèïÔ∏è',
                'evaluation': 'üìã',
                'transitional': 'üîÑ'
            };
            
            const typeLower = (type || '').toLowerCase();
            for (const [key, icon] of Object.entries(icons)) {
                if (typeLower.includes(key)) return icon;
            }
            
            return 'üìç';
        }
        
        // Update radius circle
        function updateRadiusCircle() {
            if (!mapCircle) return;
            
            mapCircle.setLatLng([mapCenter.lat, mapCenter.lng]);
            mapCircle.setRadius(mapRadius * 1609.34); // Convert miles to meters
        }
        
        // Filter programs by radius
        function filterProgramsByRadius() {
            if (!programMap) return;
            
            let inRadiusCount = 0;
            
            mapMarkers.forEach(marker => {
                const program = marker.programData;
                const distance = calculateDistance(
                    mapCenter.lat, mapCenter.lng,
                    program.coordinates.lat, program.coordinates.lng
                );
                
                if (distance <= mapRadius) {
                    marker.setOpacity(1);
                    inRadiusCount++;
                } else {
                    marker.setOpacity(0.3);
                }
            });
            
            // Update stats
            document.getElementById('programsInRadius').textContent = inRadiusCount;
        }
        
        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Update map statistics
        function updateMapStats() {
            if (!programMap) return;
            
            const bounds = programMap.getBounds();
            let inViewCount = 0;
            
            mapMarkers.forEach(marker => {
                if (bounds.contains(marker.getLatLng())) {
                    inViewCount++;
                }
            });
            
            document.getElementById('programsInView').textContent = inViewCount;
        }
        
        // Search map location
        function searchMapLocation() {
            const query = document.getElementById('mapLocationSearch').value;
            if (!query) return;
            
            // For now, use a simple ZIP to coordinates mapping
            // In production, would use a geocoding service
            const zipCoords = {
                '02134': { lat: 42.3601, lng: -71.0589 }, // Boston
                '10001': { lat: 40.7128, lng: -74.0060 }, // NYC
                '90210': { lat: 34.0522, lng: -118.2437 }, // LA
                '60601': { lat: 41.8781, lng: -87.6298 }, // Chicago
                '33139': { lat: 25.7617, lng: -80.1918 }, // Miami
                '98101': { lat: 47.6062, lng: -122.3321 }, // Seattle
                '78701': { lat: 30.2672, lng: -97.7431 }, // Austin
                '80202': { lat: 39.7392, lng: -104.9903 }, // Denver
                '85001': { lat: 33.4484, lng: -112.0740 }, // Phoenix
                '19019': { lat: 39.9526, lng: -75.1652 }  // Philadelphia
            };
            
            const coords = zipCoords[query];
            if (coords) {
                mapCenter = coords;
                programMap.setView([coords.lat, coords.lng], 10);
                updateRadiusCircle();
                filterProgramsByRadius();
            } else {
                alert('ZIP code not found. Try: 02134, 10001, 90210, 60601, etc.');
            }
        }
        
        // Change map type
        function changeMapType(type) {
            if (!programMap || !window.mapTileLayers) return;
            
            // Remove all tile layers
            Object.values(window.mapTileLayers).forEach(layer => {
                programMap.removeLayer(layer);
            });
            
            // Add selected layer
            if (window.mapTileLayers[type]) {
                window.mapTileLayers[type].addTo(programMap);
            }
        }
        
        // Toggle clustering
        function toggleClustering(enabled) {
            // This would implement marker clustering
            // For now, just a placeholder
            console.log('Clustering:', enabled ? 'enabled' : 'disabled');
        }
        
        // Add program from map
        function addProgramFromMap(programId) {
            const program = programs.find(p => p.id === programId);
            if (program) {
                addToDocument(program);
                selectedMapPrograms.add(programId);
                document.getElementById('mapSelectedCount').textContent = selectedMapPrograms.size;
            }
        }
        
        // Show map error
        function showMapError(message) {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.innerHTML = `
                <div style="
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #f9fafb;
                ">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
                        <h3 style="color: #374151; margin-bottom: 8px;">Map Unavailable</h3>
                        <p style="color: #6b7280;">${message}</p>
                    </div>
                </div>
            `;
        }
        
        // Toggle visualization type
        function toggleVisualization(type) {
            const mapContainer = document.getElementById('mapContainer');
            const vizContainer = document.getElementById('visualizationContainer');
            const tableView = document.getElementById('accessibleTableView');
            
            // Hide all views
            mapContainer.style.display = 'none';
            vizContainer.style.display = 'none';
            tableView.style.display = 'none';
            
            // Show selected view
            if (type === 'table') {
                tableView.style.display = 'block';
                renderAccessibleTable();
            } else if (type === 'timeline' || type === 'cost') {
                vizContainer.style.display = 'block';
                renderVisualization(type);
            }
        }
        
        // Render accessible table
        function renderAccessibleTable() {
            const tbody = document.getElementById('accessibleTableBody');
            if (!tbody) return;
            
            // Get programs with distance
            const programsWithDistance = programs
                .filter(p => p.coordinates)
                .map(p => ({
                    ...p,
                    distance: calculateDistance(
                        mapCenter.lat, mapCenter.lng,
                        p.coordinates.lat, p.coordinates.lng
                    )
                }))
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 20); // Show top 20 nearest
            
            tbody.innerHTML = programsWithDistance.map(program => `
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <strong>${program.name}</strong>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        ${program.location || 'N/A'}
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        ${program.distance.toFixed(1)} mi
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        ${program.type || 'N/A'}
                    </td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">
                        <button onclick="addProgramFromMap('${program.id}')" style="
                            padding: 4px 12px;
                            background: #6366f1;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                        ">Add</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Render visualization
        let currentChart = null; // Store chart instance globally
        
        function renderVisualization(type) {
            const canvas = document.getElementById('chartCanvas');
            if (!canvas || typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded');
                return;
            }
            
            // Destroy existing chart if it exists
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
            
            // Placeholder for actual chart implementation
            const ctx = canvas.getContext('2d');
            
            if (type === 'cost') {
                // Cost analysis chart
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['$', '$$', '$$$', '$$$$'],
                        datasets: [{
                            label: 'Programs by Cost Range',
                            data: [12, 19, 8, 5],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Cost Distribution Analysis'
                            }
                        }
                    }
                });
            } else if (type === 'timeline') {
                // Timeline visualization would go here
                console.log('Timeline visualization not yet implemented');
            }
        }
        
        // Initialize map when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMapSystem);
        } else {
            setTimeout(initializeMapSystem, 100);
        }
         
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initEnhancedFilters);
        } else {
            initEnhancedFilters();
        }
    

        
        // Immersive Map System
        let immersiveMap = null;
        let immersiveMapActive = false;
        let immersiveMarkers = [];
        let immersiveCircle = null;
        
        // Toggle immersive map
        function toggleImmersiveMap() {
            const overlay = document.getElementById('immersiveMapOverlay');
            const toggleIcon = document.getElementById('mapToggleIcon');
            
            if (!immersiveMapActive) {
                // Show map
                overlay.style.display = 'block';
                immersiveMapActive = true;
                toggleIcon.textContent = '‚úï';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                // Initialize map if not already done
                if (!immersiveMap) {
                    setTimeout(() => initializeImmersiveMap(), 100);
                } else {
                    // Refresh map size
                    setTimeout(() => {
                        immersiveMap.invalidateSize();
                    }, 100);
                }
            } else {
                closeImmersiveMap();
            }
        }
        
        // Close immersive map
        function closeImmersiveMap() {
            const overlay = document.getElementById('immersiveMapOverlay');
            const toggleIcon = document.getElementById('mapToggleIcon');
            
            overlay.style.display = 'none';
            immersiveMapActive = false;
            toggleIcon.textContent = 'üó∫Ô∏è';
            document.body.style.overflow = ''; // Restore scrolling
        }
        
        // Initialize immersive map
        function initializeImmersiveMap() {
            if (typeof L === 'undefined') {
                console.error('Leaflet not loaded');
                alert('Map feature is not available. Please refresh the page.');
                return;
            }
            
            try {
                // Create map
                immersiveMap = L.map('immersiveMapContainer', {
                    center: [40.7128, -74.0060], // Default to NYC
                    zoom: 11,
                    zoomControl: true
                });

        // Ensure map button is always visible
        document.addEventListener('DOMContentLoaded', function() {
            const mapToggle = document.getElementById('mainMapToggle');
            if (mapToggle) {
                mapToggle.style.display = 'flex';
            }
        });

                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(immersiveMap);
                
                // Add radius circle
                immersiveCircle = L.circle([40.7128, -74.0060], {
                    radius: 50 * 1609.34, // Convert miles to meters
                    fillColor: '#3b82f6',
                    fillOpacity: 0.15,
                    color: '#3b82f6',
                    weight: 2
                }).addTo(immersiveMap);
                
                // Add center marker
                const centerIcon = L.divIcon({
                    className: 'center-marker',
                    html: '<div style="background: #ef4444; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"></div>',
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                });
                
                const centerMarker = L.marker([40.7128, -74.0060], {
                    icon: centerIcon,
                    draggable: true,
                    zIndexOffset: 1000
                }).addTo(immersiveMap);
                
                // Handle center marker drag
                centerMarker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    updateMapCenter(pos.lat, pos.lng);
                });
                
                // Add programs to map
                addProgramsToImmersiveMap();
                
                // Update stats
                updateMapStatistics();
                
                console.log('‚úÖ Immersive map initialized');
                
            } catch (error) {
                console.error('Failed to initialize immersive map:', error);
                alert('Failed to initialize map. Please try again.');
            }
        }
        
        // Add programs to immersive map
        function addProgramsToImmersiveMap() {
            if (!immersiveMap) return;
            
            // Clear existing markers
            immersiveMarkers.forEach(marker => immersiveMap.removeLayer(marker));
            immersiveMarkers = [];
            
            // Count programs
            let totalCount = 0;
            let inRadiusCount = 0;
            
            // Add markers for programs with coordinates
            if (typeof programs !== 'undefined') {
                programs.forEach(program => {
                    if (program.coordinates && program.coordinates.lat && program.coordinates.lng) {
                        const marker = createImmersiveProgramMarker(program);
                        if (marker) {
                            immersiveMarkers.push(marker);
                            marker.addTo(immersiveMap);
                            totalCount++;
                        }
                    }
                });
            }
            
            // Update counts
            document.getElementById('totalProgramsMap').textContent = totalCount;
            
            console.log(`Added ${totalCount} programs to immersive map`);
        }
        
        // Create program marker for immersive map
        function createImmersiveProgramMarker(program) {
            if (!program.coordinates) return null;
            
            // Determine marker color
            const colors = {
                'residential': '#ef4444',
                'php': '#f59e0b',
                'iop': '#10b981',
                'virtual': '#6366f1',
                'wilderness': '#22c55e'
            };
            
            let markerColor = '#6b7280';
            const programType = (program.type || '').toLowerCase();
            for (const [key, color] of Object.entries(colors)) {
                if (programType.includes(key)) {
                    markerColor = color;
                    break;
                }
            }
            
            // Create custom icon
            const icon = L.divIcon({
                className: 'immersive-program-marker',
                html: `
                    <div style="
                        background: ${markerColor};
                        width: 32px;
                        height: 32px;
                        border-radius: 50% 50% 50% 0;
                        transform: rotate(-45deg);
                        border: 3px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        position: relative;
                    ">
                        <div style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(45deg);
                            color: white;
                            font-size: 16px;
                            font-weight: bold;
                        ">
                            ${program.type && program.type.includes('RTC') ? 'üè†' : 'üìç'}
                        </div>
                    </div>
                `,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            
            // Create marker
            const marker = L.marker([program.coordinates.lat, program.coordinates.lng], {
                icon: icon,
                title: program.name
            });
            
            // Add popup
            const popupContent = `
                <div style="max-width: 280px; padding: 10px;">
                    <h4 style="margin: 0 0 10px 0; color: #1f2937; font-size: 16px;">${program.name}</h4>
                    <p style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px;">${program.location || ''}</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
                        ${program.type ? `<span style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${program.type}</span>` : ''}
                        ${program.insurance ? `<span style="background: #dbeafe; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üí≥ Insurance</span>` : ''}
                    </div>
                    <button onclick="addProgramFromImmersiveMap('${program.id}')" style="
                        width: 100%;
                        padding: 8px 16px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                    ">Add to Document</button>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            marker.programData = program;
            
            return marker;
        }
        
        // Update map radius
        function updateMapRadius(value) {
            const radius = parseInt(value);
            document.getElementById('radiusDisplayValue').textContent = radius + ' miles';
            
            if (immersiveCircle) {
                immersiveCircle.setRadius(radius * 1609.34);
            }
            
            updateMapStatistics();
        }
        
        // Update map center
        function updateMapCenter(lat, lng) {
            if (immersiveCircle) {
                immersiveCircle.setLatLng([lat, lng]);
            }
            updateMapStatistics();
        }
        
        // Update map statistics
        function updateMapStatistics() {
            // This would calculate programs in radius
            // For now, just placeholder
            const inRadius = Math.floor(Math.random() * 20) + 10;
            document.getElementById('inRadiusCount').textContent = inRadius;
        }
        
        // Jump to location
        function jumpToLocation(zip, name) {
            const coords = {
                '02134': [42.3601, -71.0589], // Boston
                '10001': [40.7128, -74.0060], // NYC
                '90210': [34.0522, -118.2437], // LA
                '60601': [41.8781, -87.6298], // Chicago
                '33139': [25.7617, -80.1918], // Miami
                '98101': [47.6062, -122.3321]  // Seattle
            };
            
            if (coords[zip] && immersiveMap) {
                immersiveMap.setView(coords[zip], 11);
                updateMapCenter(coords[zip][0], coords[zip][1]);
            }
        }
        
        // Add program from immersive map
        function addProgramFromImmersiveMap(programId) {
            const program = programs.find(p => p.id === programId);
            if (program) {
                // Add to document (would need to integrate with existing system)
                if (typeof addToDocument === 'function') {
                    addToDocument(program);
                }
                alert('Program added to document!');
            }
        }
        
        // Add CSS for quick location buttons
        // const style = document.createElement('style');
        style.textContent = `
            .quick-location-btn {
                padding: 8px 12px;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.2s;
            }
            .quick-location-btn:hover {
                background: #f3f4f6;
                border-color: #d1d5db;
            }
            #mainMapToggle:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        // Auto-show map on page load (for testing)
        // Remove this line in production
        // setTimeout(() => { if (window.location.hash === '#map') toggleImmersiveMap(); }, 1000);

    </script>
    
    <!-- ClearHive Branding -->
    <div style="text-align: center; padding: 20px; border-top: 1px solid #eee; margin-top: 40px; color: #999; font-size: 12px;">
        Document Creator by <strong>ClearHive Health LLC</strong>
    </div>
</body>
</html>

