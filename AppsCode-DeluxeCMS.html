<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect Pro - Professional Aftercare Document Builder</title>
    
    <!-- Content Security Policy for enhanced security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https://tile.openstreetmap.org https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://tile.openstreetmap.fr https://a.tile.openstreetmap.fr https://b.tile.openstreetmap.fr https://c.tile.openstreetmap.fr https://server.arcgisonline.com https://services.arcgisonline.com https://*.opentopomap.org https://*.basemaps.cartocdn.com; font-src 'self' data:; connect-src 'self' https://nominatim.openstreetmap.org https://tile.openstreetmap.org https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://tile.openstreetmap.fr https://a.tile.openstreetmap.fr https://b.tile.openstreetmap.fr https://c.tile.openstreetmap.fr https://server.arcgisonline.com https://services.arcgisonline.com https://*.opentopomap.org https://*.basemaps.cartocdn.com; object-src 'none'; base-uri 'self'; form-action 'self';">
    
    <!-- PDF Libraries for document merging -->
    <!-- Libraries loaded locally for HIPAA compliance - no external CDN -->
    <script src="libs/pdf-lib.min.js"></script>
    <script src="libs/jspdf.umd.min.js"></script>
    <script src="libs/html2canvas.min.js"></script>
    
    
    <!-- Enhanced Features Libraries -->
    <script src="libs/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="libs/select2.min.css">
    <script src="libs/select2.min.js"></script>
    <link rel="stylesheet" href="libs/leaflet.css">
    <script src="libs/leaflet.js"></script>
    <script src="libs/chart.min.js"></script>
    <script src="libs/d3.v7.min.js"></script>
    
    <!-- Enhanced Features Scripts -->
    <script>
        // Global error handler to prevent white screen
        window.addEventListener('error', function(e) {
            console.error('üî• Global error caught:', e.error || e.message);
            // Prevent white screen by showing error message
            if (e.error && e.error.message) {
                const errorMsg = e.error.message;
                if (errorMsg.includes('is not defined') || errorMsg.includes('is not a constructor')) {
                    console.error('‚ö†Ô∏è Critical script loading error detected');
                    // Don't reload automatically, just log
                }
            }
            return false; // Prevent default error handling
        });
        
        // Ensure body is always visible
        window.addEventListener('DOMContentLoaded', function() {
            document.body.style.opacity = '1';
            document.body.style.visibility = 'visible';
            document.body.style.display = 'block';
            
            // AGGRESSIVE DASHBOARD PROTECTION
            window.blockTabSwitches = false; // Allow tab switches (we fixed the tab switching logic)
            
            // Monitor dashboard for any changes/removal
            const dashboardObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.removedNodes.length > 0) {
                        // Only worry about content removal if dashboard tab is active
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (dashboardTab && dashboardTab.classList.contains('active')) {
                            // Check if dashboard container was actually removed
                            if (!dashboardTab.querySelector('.dashboard-container')) {
                                console.error('üö® DASHBOARD CONTENT REMOVED while active!', {
                                    removed: mutation.removedNodes,
                                    target: mutation.target.id || mutation.target.className
                                });
                                // Try to re-inject
                                if (window.injectSimpleDashboard) {
                                    window.injectSimpleDashboard();
                                }
                                // Re-initialize dashboard
                                if (window.dashboardManager && window.dashboardWidgets) {
                                    setTimeout(() => {
                                        window.dashboardWidgets.renderAll().catch(console.error);
                                    }, 500);
                                }
                            }
                        }
                    }
                    
                    if (mutation.type === 'attributes') {
                        if (mutation.attributeName === 'style' || mutation.attributeName === 'class') {
                            const target = mutation.target;
                            if (target.id === 'dashboardTab') {
                                // Only take action if dashboard tab is supposed to be active
                                const isActive = target.classList.contains('active');
                                const style = window.getComputedStyle(target);
                                
                                // Only log/act if dashboard is being hidden while it should be visible
                                if (isActive && style.display === 'none') {
                                    console.warn('‚ö†Ô∏è Dashboard was hidden while active - forcing visible!');
                                    target.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important; position: relative !important; z-index: 9999 !important;';
                                }
                            }
                        }
                    }
                });
            });
            
            // Start observing once dashboard exists
            setTimeout(() => {
                const dashboardTab = document.getElementById('dashboardTab');
                if (dashboardTab) {
                    dashboardObserver.observe(dashboardTab, {
                        childList: true,
                        attributes: true,
                        attributeOldValue: true,
                        subtree: true
                    });
                    console.log('üëÅÔ∏è Dashboard observer activated');
                }
            }, 1000);
            
            // KEYBOARD SHORTCUT: Press 'D' key to force dashboard
            document.addEventListener('keydown', function(e) {
                if (e.key === 'd' || e.key === 'D') {
                    console.log('üéØ Forcing dashboard display with D key');
                    
                    // Switch to dashboard tab
                    const dashboardBtn = document.querySelector('button[onclick*="dashboard"]');
                    if (dashboardBtn) dashboardBtn.click();
                    
                    // Ensure dashboard tab is active
                    const dashboardTab = document.getElementById('dashboardTab');
                    if (dashboardTab) {
                        // Remove active from all tabs
                        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                        
                        // Make dashboard active
                        dashboardTab.classList.add('active');
                        dashboardTab.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important; position: relative !important; z-index: 999999 !important;';
                        
                        // Check if it has content
                        if (!dashboardTab.querySelector('.dashboard-container')) {
                            console.log('üî® Injecting fallback dashboard');
                            window.injectSimpleDashboard();
                        }
                    }
                    
                    // Block future tab switches
                    window.blockTabSwitches = true;
                    console.log('‚úÖ Dashboard forced and tab switches blocked');
                }
            });
            
            console.log('üí° TIP: Press the "D" key at any time to force the dashboard to appear!');
        });
        
        // NUCLEAR OPTION: Force dashboard to stay visible (GUARDED - only when logged in)
        setInterval(function() {
            // Exit immediately if not logged in - don't interfere with login screen
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) return;
            
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            const dashboardTab = document.getElementById('dashboardTab');
            const dashboardContainer = document.querySelector('.dashboard-container');
            
            // Only manipulate when logged in
            if (loginScreen && isLoggedIn) {
                loginScreen.style.display = 'none';
                loginScreen.style.visibility = 'hidden';
                loginScreen.style.opacity = '0';
                loginScreen.style.zIndex = '-9999';
                loginScreen.style.position = 'fixed';
                loginScreen.style.left = '-9999px';
            }
            
            if (mainApp && isLoggedIn) {
                mainApp.style.display = 'block';
                mainApp.style.visibility = 'visible';
                mainApp.style.opacity = '1';
                mainApp.style.background = 'transparent'; /* Changed from white to show purple gradient */
                mainApp.style.position = 'relative';
                mainApp.style.zIndex = '1';
            }
            
            if (dashboardTab && dashboardTab.classList.contains('active')) {
                dashboardTab.style.display = 'block';
                dashboardTab.style.visibility = 'visible';
                dashboardTab.style.opacity = '1';
                dashboardTab.style.background = 'white';
                dashboardTab.style.color = '#1a1a1a';
                dashboardTab.style.position = 'relative';
                dashboardTab.style.zIndex = '9999';
            }
            
            if (dashboardContainer) {
                dashboardContainer.style.display = 'block';
                dashboardContainer.style.visibility = 'visible';
                dashboardContainer.style.opacity = '1';
                dashboardContainer.style.background = '#f8f9fa';
                dashboardContainer.style.color = '#1a1a1a';
            }
            
            // Ensure body is visible
            document.body.style.display = 'block';
            document.body.style.visibility = 'visible';
            document.body.style.opacity = '1';
            document.body.style.background = 'white';
            document.body.style.color = '#1a1a1a';
            
            // Force all text elements to be visible
            const allTexts = document.querySelectorAll('.dashboard-container *');
            allTexts.forEach(el => {
                if (el.style.color === 'white' || el.style.color === 'rgb(255, 255, 255)') {
                    el.style.color = '#1a1a1a';
                }
            });
            
            // Check if dashboard content was removed and log it
            const widgets = document.querySelectorAll('.dashboard-widget');
            if (dashboardTab && dashboardTab.classList.contains('active') && widgets.length === 0) {
                console.warn('Dashboard widgets missing! Container innerHTML:', dashboardContainer?.innerHTML?.substring(0, 100));
            }
        }, 100); // Check every 100ms
        
        // Prevent any element from clearing dashboard innerHTML
        (function() {
            const originalInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML');
            Object.defineProperty(Element.prototype, 'innerHTML', {
                set: function(value) {
                    // Check if this is a dashboard element being cleared
                    if (this.classList && (this.classList.contains('dashboard-container') || 
                        this.classList.contains('dashboard-widget') ||
                        this.id === 'dashboardTab')) {
                        
                        if (value === '' || value === null || value === undefined) {
                            console.warn('‚ö†Ô∏è Blocked attempt to clear dashboard element:', this.id || this.className);
                            return; // Don't allow clearing
                        }
                    }
                    // Allow normal innerHTML setting
                    return originalInnerHTML.set.call(this, value);
                },
                get: originalInnerHTML.get
            });
        })();
        
        // Aggressive cache busting with random component
        const cacheBust = Date.now() + '-' + Math.random().toString(36).substring(7);
        
        // Function to clear all caches and reload
        window.clearCacheAndReload = function() {
            console.log('üßπ Clearing all caches...');
            // Clear IndexedDB
            if ('indexedDB' in window) {
                indexedDB.databases().then(databases => {
                    databases.forEach(db => {
                        indexedDB.deleteDatabase(db.name);
                        console.log('Deleted IndexedDB:', db.name);
                    });
                });
            }
            // Clear localStorage and sessionStorage
            localStorage.clear();
            sessionStorage.clear();
            // Clear service worker cache
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                });
            }
            // Force reload with cache bypass
            window.location.reload(true);
        };
        
        // Function to load script with retry
        function loadScript(src, retries = 3) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${src}?v=${cacheBust}`;
                script.onload = () => {
                    console.log(`‚úÖ Loaded: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    if (retries > 0) {
                        console.warn(`‚ö†Ô∏è Retrying ${src}... (${retries} attempts left)`);
                        setTimeout(() => loadScript(src, retries - 1).then(resolve).catch(reject), 500);
                    } else {
                        console.error(`‚ùå Failed to load: ${src}`);
                        reject(new Error(`Failed to load ${src}`));
                    }
                };
                document.head.appendChild(script);
            });
        }
        
        // Load core scripts
        const scripts = [
            'feature-flags.js',
            'performance-monitor.js', 
            'indexed-db-manager.js',
            'intelligent-matching.js',
            'multi-client-workflow.js',
            'advanced-filters.js',
            'client-manager.js',
            'tracker-engine.js',
            'morning-review-dashboard.js',
            'tracker-timeline.js',
            'tracker-bulk-update.js',
            'tracker-aftercare-cascade.js',
            'discharge-checklist.js',
            'houses-manager.js',
            'milestones-manager.js',
            'aftercare-manager.js',
            'document-generator.js'
        ];
        
        // Load scripts sequentially to ensure proper order
        Promise.all(scripts.map(src => loadScript(src))).then(() => {
            console.log('‚úÖ All core scripts loaded');
            
            // Load dashboard scripts after core scripts
            const dashboardScripts = ['dashboard-manager.js', 'dashboard-widgets.js', 'dashboard-diagnostics.js'];
            return Promise.all(dashboardScripts.map(src => loadScript(src)));
        }).then(() => {
            console.log('‚úÖ All dashboard scripts loaded');
            
            // Make dashboard manager globally available
            if (typeof dashboardManager !== 'undefined') {
                window.dashboardManager = dashboardManager;
            }
            if (typeof dashboardWidgets !== 'undefined') {
                window.dashboardWidgets = dashboardWidgets;
            }
            
            // Initialize enhanced features now that all scripts are loaded
            initializeEnhancedFeatures();
            
            // Handle IndexedDB version errors
            window.addEventListener('error', function(event) {
                if (event.message && event.message.includes('VersionError')) {
                    console.error('üîÑ IndexedDB version mismatch detected. Please clear cache.');
                    if (confirm('IndexedDB version mismatch detected. Clear cache and reload?')) {
                        window.clearCacheAndReload();
                    }
                }
            });
        }).catch(error => {
            console.error('‚ùå Script loading error:', error);
        });
    </script>
    
    <!-- Client Tracking Styles -->
    <style>
        /* Base Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        /* Client Tracking Styles */
        .tab-navigation {
            display: flex !important;
            gap: 8px;
            margin-bottom: 20px;
            margin-top: 10px;
            background: linear-gradient(to right, #e0e7ff, #fce7f3);
            padding: 8px;
            border-radius: 12px;
            visibility: visible !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 2px solid #6366f1;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            background: #f9fafb;
            color: #374151;
            transform: translateY(-1px);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }
        
        .tab-content {
            display: none;
            height: calc(100% - 60px);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .client-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .client-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .client-header h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }
        
        .current-client-banner {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .current-client-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-avatar {
            width: 50px;
            height: 50px;
            background: white;
            color: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .client-details {
            flex: 1;
        }
        
        .client-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .client-id {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .client-actions {
            display: flex;
            gap: 10px;
        }
        
        .client-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .client-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .client-quick-add {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .client-form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .client-form-group {
            flex: 1;
        }
        
        .client-form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #4b5563;
            font-weight: 500;
        }
        
        .client-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .client-form-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .add-client-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-client-btn:hover {
            background: #5558e3;
        }
        
        .client-list-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .client-list-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-list-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-filter-tabs {
            display: flex;
            gap: 10px;
        }
        
        .client-filter-tab {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .client-filter-tab:hover {
            border-color: #d1d5db;
            color: #4b5563;
        }
        
        .client-filter-tab.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .client-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .client-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-card:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .client-card.selected {
            background: #ede9fe;
            border-color: #8b5cf6;
        }
        
        .client-card-avatar {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .client-card-info {
            flex: 1;
        }
        
        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .client-card-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-card-kipu {
            font-size: 14px;
            color: #6b7280;
        }
        
        .client-card-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #6b7280;
        }
        
        .client-status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .client-status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .client-status-badge.waitlist {
            background: #fef3c7;
            color: #92400e;
        }
        
        .client-status-badge.discharged {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .client-empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .client-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .client-search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        /* Alert Animation */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Milestone Indicator Styles */
        .milestone-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .milestone-indicator.complete {
            background-color: #10b981;
            color: white;
        }
        
        .milestone-indicator.overdue {
            background-color: #ef4444;
            color: white;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .milestone-indicator.due-today {
            background-color: #f59e0b;
            color: white;
        }
        
        .milestone-indicator.due-soon {
            background-color: #f59e0b;
            color: white;
            opacity: 0.8;
        }
        
        .milestone-indicator.in-progress {
            background-color: #3b82f6;
            color: white;
        }
        
        .milestone-indicator.pending {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .8;
            }
        }
        
        /* Days in care color coding */
        .days-in-care {
            font-weight: 500;
        }
        
        td.days-in-care {
            text-align: center;
        }
        
        /* Color code days based on milestones */
        .days-13 { color: #f59e0b; font-weight: 600; }
        .days-14 { color: #f59e0b; font-weight: 600; }
        .days-16plus { color: #ef4444; font-weight: 600; }
        
        /* CM Tracker House Navigation */
        .cm-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #f9fafb;
        }
        
        .house-navigation {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 0;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .house-tabs {
            display: flex;
            gap: 0;
            flex: 1;
            overflow-x: auto;
        }
        
        .house-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        
        .house-tab:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .house-tab.active {
            color: #6366f1;
            background: #eef2ff;
            border-bottom-color: #6366f1;
        }
        
        .house-tab .client-count {
            margin-left: 5px;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: normal;
        }
        
        .house-tab.active .client-count {
            background: #6366f1;
            color: white;
        }
        
        .house-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .cm-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .cm-action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .cm-action-btn:hover {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .cm-action-btn.primary {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .cm-action-btn.primary:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }
        
        .clients-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .clients-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .clients-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .clients-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            color: #1f2937;
        }
        
        .clients-table tr:hover {
            background: #f9fafb;
        }
        
        .client-initials {
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
        }
        
        .client-initials:hover {
            color: #6366f1;
            text-decoration: underline;
        }
        
        .days-in-care {
            font-weight: 500;
            color: #6b7280;
        }
        
        .team-member {
            font-size: 13px;
            color: #6b7280;
        }
        
        .milestone-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .milestone-indicator.complete {
            background: #10b981;
            color: white;
        }
        
        .milestone-indicator.pending {
            background: #f3f4f6;
            color: #9ca3af;
            border: 1px solid #e5e7eb;
        }
        
        .milestone-indicator.overdue {
            background: #ef4444;
            color: white;
        }
        
        .aftercare-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .aftercare-status.sent {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .aftercare-status.engaged {
            background: #fef3c7;
            color: #92400e;
        }
        
        .aftercare-status.accepted {
            background: #d1fae5;
            color: #065f46;
        }
        
        .aftercare-status.declined {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 4px 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #e5e7eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .empty-state-text {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 500px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #1f2937;
            font-size: 20px;
        }
        
        .modal-content label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }
        
        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
    </style>

    <style>
        .programs-docs-loader,
        .programs-docs-error {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(110, 123, 255, 0.2);
            background: rgba(233, 236, 255, 0.55);
            color: #151633;
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .programs-docs-loader .loader-spinner {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid rgba(110, 123, 255, 0.3);
            border-top-color: #6E7BFF;
            animation: programsDocsSpin 0.9s linear infinite;
        }

        .programs-docs-error {
            flex-direction: column;
            align-items: flex-start;
            background: rgba(255, 245, 245, 0.85);
            border: 1px solid rgba(221, 72, 72, 0.35);
        }

        .programs-docs-error h3 {
            margin: 0;
            font-size: 16px;
            color: #b42318;
        }

        .programs-docs-error p {
            margin: 4px 0 12px 0;
            color: #7a271a;
            font-size: 14px;
        }

        .programs-docs-error-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .programs-docs-container {
            min-height: 400px;
        }

        .legacy-programs-wrapper {
            margin-top: 24px;
        }

        .legacy-programs-notice {
            padding: 20px;
            border: 1px dashed rgba(110, 123, 255, 0.35);
            border-radius: 16px;
            background: white;
            color: #48508A;
        }

        .legacy-programs-notice h4 {
            margin: 0 0 8px 0;
            color: #0F1020;
            font-size: 16px;
        }

        .legacy-programs-notice p {
            margin: 0;
            font-size: 14px;
        }

        .legacy-programs-fallback {
            margin-top: 16px;
            border: 1px solid rgba(110, 123, 255, 0.18);
            border-radius: 18px;
            background: rgba(233, 236, 255, 0.25);
            box-shadow: 0 12px 32px rgba(15, 16, 32, 0.08);
            overflow: hidden;
        }

        .legacy-programs-frame {
            width: 100%;
            min-height: 720px;
            border: 0;
            background: white;
        }

        .legacy-programs-disclaimer {
            margin: 0;
            padding: 12px 18px 16px;
            font-size: 13px;
            color: #48508A;
            background: rgba(233, 236, 255, 0.65);
            border-top: 1px solid rgba(110, 123, 255, 0.18);
        }

        body.programs-docs-v2-active .selection-panel {
            display: none !important;
        }

        @keyframes programsDocsSpin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    
    <!-- Client Tracking JavaScript -->
    <script>
        // CM Tracker Functions
        let currentHouseId = 'house_nest';
        let currentClientFilter = 'active';
        let cmTrackerInitialized = false;
        
        // Initialize CM Tracker
        async function initializeCMTracker() {
            try {
                // Check if managers are available
                if (!window.dbManager) {
                    console.error('DBManager not available for CM Tracker');
                    return;
                }
                
                // Initialize houses manager
                if (!window.housesManager) {
                    window.housesManager = new HousesManager(window.dbManager);
                    await window.housesManager.initialize();
                }
                housesManager = window.housesManager;
                
                // Initialize milestones manager
                if (!window.milestonesManager) {
                    window.milestonesManager = new MilestonesManager(window.dbManager);
                }
                milestonesManager = window.milestonesManager;
                
                // Initialize aftercare manager
                if (!window.aftercareManager) {
                    window.aftercareManager = new AftercareManager(window.dbManager);
                }
                aftercareManager = window.aftercareManager;
                
                // Initialize houses in database
                await window.dbManager.initializeHouses();
                
                // Build house navigation
                await buildHouseNavigation();
                
                // Load initial house
                await loadHouseView(currentHouseId);
                
                cmTrackerInitialized = true;
                console.log('‚úÖ CM Tracker initialized');
            } catch (error) {
                console.error('Failed to initialize CM Tracker:', error);
            }
        }
        
        // Build house navigation tabs
        async function buildHouseNavigation() {
            const houseTabs = document.getElementById('houseTabs');
            if (!houseTabs) return;
            
            houseTabs.innerHTML = '';
            
            // Get houses
            const houses = await housesManager.getActiveHouses();
            
            // Create tabs for each house
            for (let i = 0; i < houses.length; i++) {
                const house = houses[i];
                const clientCount = await housesManager.getClientCount(house.id, true);
                
                const tab = document.createElement('button');
                tab.className = 'house-tab';
                if (i === 0) tab.className += ' active'; // First house is active by default
                tab.id = `houseTab_${house.id}`;
                tab.onclick = () => switchToHouse(house.id);
                
                tab.innerHTML = `
                    ${house.name}
                    <span class="client-count">${clientCount}</span>
                `;
                
                houseTabs.appendChild(tab);
            }
            
            // Add discharged clients tab
            const dischargedCount = await getDischargedClientsCount();
            const dischargedTab = document.createElement('button');
            dischargedTab.className = 'house-tab';
            dischargedTab.id = 'houseTab_discharged';
            dischargedTab.onclick = () => switchToHouse('discharged');
            dischargedTab.innerHTML = `
                Discharged
                <span class="client-count">${dischargedCount}</span>
            `;
            houseTabs.appendChild(dischargedTab);
        }
        
        // Get discharged clients count
        async function getDischargedClientsCount() {
            if (!window.clientManager) return 0;
            const discharged = await window.clientManager.getDischargedClients();
            return discharged.length;
        }
        
        // Switch to a house
        async function switchToHouse(houseId) {
            currentHouseId = houseId;
            
            // Update active tab
            document.querySelectorAll('.house-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.getElementById(`houseTab_${houseId}`);
            if (activeTab) activeTab.classList.add('active');
            
            // Load house view
            await loadHouseView(houseId);
        }
        
        // Load house view
        async function loadHouseView(houseId) {
            const container = document.getElementById('houseClientsList');
            if (!container) return;
            
            try {
                let clients;
                let houseName;
                
                if (houseId === 'discharged') {
                    clients = await window.clientManager.getDischargedClients();
                    houseName = 'Discharged Clients';
                } else {
                    const house = housesManager.getHouseById(houseId);
                    if (!house) return;
                    houseName = house.name;
                    clients = await window.clientManager.getClientsByHouse(houseId, currentClientFilter === 'active');
                }
                
                if (clients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üè†</div>
                            <div class="empty-state-title">No clients in ${houseName}</div>
                            <div class="empty-state-text">Click "Add Client" to add a new client to this house</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = await buildClientsTable(clients, houseName);
                }
            } catch (error) {
                console.error('Failed to load house view:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Error loading clients</div>
                        <div class="empty-state-text">${error.message}</div>
                    </div>
                `;
            }
        }
        
        // Build clients table
        async function buildClientsTable(clients, houseName) {
            const table = document.createElement('div');
            table.className = 'clients-table-container';
            
            // Add export controls
            let tableHTML = `
                <div class="table-controls" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 14px; color: #6b7280;">
                        Showing ${clients.length} client${clients.length !== 1 ? 's' : ''} in ${houseName}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportCurrentView()" class="export-btn" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                            üìÑ Export to CSV
                        </button>
                        <button onclick="exportAllData()" class="export-btn" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                            üìä Export All Houses
                        </button>
                    </div>
                </div>
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Kipu ID</th>
                            <th>Days</th>
                            <th>Coach</th>
                            <th>CM</th>
                            <th>Thread</th>
                            <th>Options</th>
                            <th>Packet</th>
                            <th>Aftercare</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const client of clients) {
                const daysInCare = window.clientManager.calculateDaysInCare(client);
                
                // Apply CSS class based on days in care
                let daysClass = '';
                if (daysInCare === 13) {
                    daysClass = 'days-13';
                } else if (daysInCare === 14) {
                    daysClass = 'days-14';
                } else if (daysInCare >= 16) {
                    daysClass = 'days-16plus';
                }
                
                // Get milestones
                let milestones = [];
                try {
                    milestones = await milestonesManager.getClientMilestones(client.id);
                } catch (e) {
                    // Client may not have milestones initialized yet
                }
                
                // Get specific milestone statuses
                const threadMilestone = milestones.find(m => m.milestone === 'aftercare_thread');
                const optionsMilestone = milestones.find(m => m.milestone === 'options_doc');
                const packetMilestone = milestones.find(m => m.milestone === 'discharge_packet');
                
                const threadDisplay = threadMilestone 
                    ? milestonesManager.getMilestoneDisplayStatus(threadMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                    
                const optionsDisplay = optionsMilestone
                    ? milestonesManager.getMilestoneDisplayStatus(optionsMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                    
                const packetDisplay = packetMilestone
                    ? milestonesManager.getMilestoneDisplayStatus(packetMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                
                // Get aftercare options
                let aftercareOptions = [];
                let aftercareDisplay = 'No options';
                try {
                    aftercareOptions = await aftercareManager.getClientAftercareOptions(client.id);
                    if (aftercareOptions.length > 0) {
                        const summary = aftercareManager.getAftercareSummary(aftercareOptions);
                        aftercareDisplay = summary.displayString;
                    }
                } catch (e) {
                    // Client may not have aftercare options yet
                }
                
                tableHTML += `
                    <tr>
                        <td><span class="client-initials" onclick="viewClientDetails('${client.id}')">${client.initials}</span></td>
                        <td>${client.kipuId}</td>
                        <td class="days-in-care ${daysClass}">${daysInCare}</td>
                        <td class="team-member">${client.clinicalCoachInitials || '-'}</td>
                        <td class="team-member">${client.caseManagerInitials || '-'}</td>
                        <td>
                            <span class="milestone-indicator ${threadDisplay.class}" 
                                  title="${threadDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'aftercare_thread')">
                                ${threadDisplay.icon}
                            </span>
                        </td>
                        <td>
                            <span class="milestone-indicator ${optionsDisplay.class}" 
                                  title="${optionsDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'options_doc')">
                                ${optionsDisplay.icon}
                            </span>
                        </td>
                        <td>
                            <span class="milestone-indicator ${packetDisplay.class}" 
                                  title="${packetDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'discharge_packet')">
                                ${packetDisplay.icon}
                            </span>
                        </td>
                        <td><span class="aftercare-status" style="font-size: 12px;">${aftercareDisplay}</span></td>
                        <td class="action-buttons">
                            <button class="action-btn" onclick="viewClientDetails('${client.id}')">View</button>
                            <button class="action-btn" onclick="editClient('${client.id}')">Edit</button>
                            <button class="action-btn" onclick="generateClientDocument('${client.id}')">Doc</button>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            return tableHTML;
        }
        
        // Export current view to CSV
        async function exportCurrentView() {
            try {
                // Load export module if not already loaded
                if (!window.CMTrackerExport) {
                    const script = document.createElement('script');
                    script.src = 'cm-tracker-export.js';
                    document.head.appendChild(script);
                    
                    // Wait for script to load
                    await new Promise(resolve => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000); // Timeout fallback
                    });
                }
                
                // Initialize export module if not loaded
                if (!window.cmTrackerExport) {
                    window.cmTrackerExport = new CMTrackerExport();
                }
                
                // Export current house
                const options = {
                    houseId: currentHouseId === 'discharged' ? null : currentHouseId,
                    includeArchived: currentHouseId === 'discharged'
                };
                
                const result = await window.cmTrackerExport.exportToCSV(options);
                
                if (result.success) {
                    showAlert(`Exported ${result.rowCount - 1} clients successfully`, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                showAlert('Failed to export data: ' + error.message, 'error');
            }
        }
        
        // Export all data to CSV
        async function exportAllData() {
            try {
                // Load export module if not already loaded
                if (!window.CMTrackerExport) {
                    const script = document.createElement('script');
                    script.src = 'cm-tracker-export.js';
                    document.head.appendChild(script);
                    
                    // Wait for script to load
                    await new Promise(resolve => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000); // Timeout fallback
                    });
                }
                
                // Initialize export module if not loaded
                if (!window.cmTrackerExport) {
                    window.cmTrackerExport = new CMTrackerExport();
                }
                
                // Export all houses
                const result = await window.cmTrackerExport.exportToCSV({
                    includeArchived: true
                });
                
                if (result.success) {
                    showAlert(`Exported ${result.rowCount - 1} clients successfully`, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                showAlert('Failed to export data: ' + error.message, 'error');
            }
        }
        
        // Ensure tab navigation is visible
        function ensureTabNavigationVisible() {
            const tabNav = document.querySelector('.tab-navigation');
            if (!tabNav) {
                // Tab navigation doesn't exist, create it
                const programsPanel = document.querySelector('.programs-panel');
                if (programsPanel) {
                    const tabNavHTML = `
                        <div class="tab-navigation" style="display: flex !important; gap: 8px; margin-bottom: 20px; visibility: visible !important; z-index: 10; position: relative;">
                            <button class="tab-btn" data-tab-target="dashboard" onclick="switchTab('dashboard')">
                                <span>üéØ Dashboard</span>
                            </button>
                            <button class="tab-btn active" data-tab-target="programs" onclick="switchTab('programs')">
                                <span>üìë Programs &amp; Docs</span>
                            </button>
                            <button class="tab-btn" data-tab-target="clients" onclick="switchTab('clients')">
                                <span>üë• Clients</span>
                            </button>
                        </div>
                    `;
                    // Insert at the beginning of programs-panel
                    programsPanel.insertAdjacentHTML('afterbegin', tabNavHTML);
                    console.log('‚úÖ Tab navigation created dynamically');
                }
            } else {
                // Ensure it's visible
                tabNav.style.display = 'flex';
                tabNav.style.visibility = 'visible';
                tabNav.style.zIndex = '10';
                tabNav.style.position = 'relative';
                console.log('‚úÖ Tab navigation verified visible');
            }
        }
        
        // Initialize Client Tracker (for backward compatibility)
        function initializeClientTracker() {
            // Ensure tab navigation is visible first
            ensureTabNavigationVisible();
            
            // Initialize CM Tracker when client tab is opened
            if (!cmTrackerInitialized) {
                initializeCMTracker();
            }
        }
        
        // Manual initialization function
        async function initializeClientManagerManually() {
            try {
                console.log('Attempting manual ClientManager initialization...');
                
                // Check if dbManager exists, if not create it
                if (!window.dbManager) {
                    console.log('Creating IndexedDBManager...');
                    window.dbManager = new IndexedDBManager();
                    await window.dbManager.init();
                }
                
                // Create ClientManager
                console.log('Creating ClientManager...');
                window.clientManager = new ClientManager(window.dbManager);
                await window.clientManager.initialize();
                
                console.log('‚úÖ ClientManager manually initialized:', window.clientManager);
                
                // Initialize the UI
                initializeClientTracker();
                
                // Hide the warning
                const statusDiv = document.getElementById('clientManagerStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
                
                showAlert('Client manager initialized successfully!', 'success');
            } catch (error) {
                console.error('Failed to manually initialize ClientManager:', error);
                showAlert('Failed to initialize client manager: ' + error.message, 'error');
            }
        }
        
        // Handle client manager events
        function handleClientEvent(event, data) {
            switch (event) {
                case 'current-client-changed':
                    updateCurrentClientDisplay();
                    refreshSelectedPrograms();
                    break;
                case 'client-created':
                case 'client-updated':
                    refreshClientsList();
                    if (data.id === clientManager.getCurrentClient()?.id) {
                        updateCurrentClientDisplay();
                    }
                    break;
            }
        }
        
        const PROGRAMS_DOCS_MODULE_PATH = 'CareConnect-Pro.html';
        let programsDocsLegacyNoticeShown = false;

        function shouldUseProgramsDocs() {
            try {
                if (window.featureFlags?.isEnabled) {
                    return window.featureFlags.isEnabled('programsV2Core') !== false;
                }
            } catch (error) {
                console.warn('Programs & Docs feature flag unavailable:', error);
            }
            return true;
        }

        async function mountProgramsDocsModule(forceReload = false) {
            const container = document.getElementById('programsDocsContainer');
            const loader = document.getElementById('programsDocsLoader');
            const errorEl = document.getElementById('programsDocsError');

            if (!container || !loader) {
                console.warn('Programs & Docs container missing from shell.');
                return false;
            }

            if (!shouldUseProgramsDocs()) {
                revealLegacyProgramsNotice('feature-disabled');
                return false;
            }

            if (window.__programsDocsMountPromise && !forceReload) {
                return window.__programsDocsMountPromise;
            }

            loader.hidden = false;
            if (errorEl) {
                errorEl.hidden = true;
            }
            container.hidden = true;

            const fetchUrl = forceReload
                ? `${PROGRAMS_DOCS_MODULE_PATH}?cacheBust=${Date.now()}`
                : PROGRAMS_DOCS_MODULE_PATH;

            const mountPromise = (async () => {
                try {
                    const response = await fetch(fetchUrl, { cache: 'no-store' });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const htmlText = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');

                    // Inject styles once
                    doc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                        const href = link.getAttribute('href');
                        if (!href) return;
                        if (document.querySelector(`link[data-programs-docs-style="true"][href="${href}"]`)) {
                            return;
                        }
                        const clone = link.cloneNode(true);
                        clone.dataset.programsDocsStyle = 'true';
                        document.head.appendChild(clone);
                    });

                    window.__programsDocsInlineStyles = window.__programsDocsInlineStyles || new Set();
                    doc.querySelectorAll('style').forEach(styleTag => {
                        const cssText = styleTag.textContent || '';
                        if (window.__programsDocsInlineStyles.has(cssText)) {
                            return;
                        }
                        const clone = styleTag.cloneNode(true);
                        clone.dataset.programsDocsStyle = 'true';
                        clone.dataset.programsDocsInline = 'true';
                        window.__programsDocsInlineStyles.add(cssText);
                        document.head.appendChild(clone);
                    });

                    container.innerHTML = doc.body.innerHTML;
                    container.hidden = false;
                    loader.hidden = true;
                    document.body.classList.add('programs-docs-v2-active');

                    // Execute inline scripts sequentially
                    const scripts = Array.from(doc.querySelectorAll('script'));
                    for (const scriptNode of scripts) {
                        const scriptEl = document.createElement('script');
                        for (const attr of scriptNode.attributes) {
                            scriptEl.setAttribute(attr.name, attr.value);
                        }
                        if (scriptNode.src) {
                            scriptEl.src = scriptNode.src;
                        } else {
                            scriptEl.textContent = scriptNode.textContent;
                        }
                        scriptEl.dataset.programsDocsScript = 'true';
                        container.appendChild(scriptEl);

                        if (scriptEl.src) {
                            await new Promise((resolve, reject) => {
                                scriptEl.onload = resolve;
                                scriptEl.onerror = () => reject(new Error(`Failed to load ${scriptEl.src}`));
                            });
                        }
                    }

                    window.__programsDocsLoaded = true;
                    return true;
                } catch (error) {
                    console.error('Programs & Docs mount failure:', error);
                    loader.hidden = true;
                    if (errorEl) {
                        errorEl.hidden = false;
                        const errorParagraph = errorEl.querySelector('p');
                        if (errorParagraph) {
                            errorParagraph.textContent = `Please retry loading or notify support. (${error.message})`;
                        }
                    }
                    revealLegacyProgramsNotice('load-error');
                    document.body.classList.remove('programs-docs-v2-active');
                    throw error;
                }
            })();

            window.__programsDocsMountPromise = mountPromise;
            return mountPromise;
        }

        function retryProgramsDocsMount() {
            window.__programsDocsMountPromise = null;
            return mountProgramsDocsModule(true).catch(() => {});
        }

        function toggleLegacyPrograms(show) {
            const wrapper = document.getElementById('legacyProgramsWrapper');
            if (!wrapper) return;
            if (show) {
                revealLegacyProgramsNotice('manual-request');
                initializeLegacyProgramsModule();
            } else {
                wrapper.hidden = true;
            }
        }

        function revealLegacyProgramsNotice(reason) {
            const wrapper = document.getElementById('legacyProgramsWrapper');
            const errorEl = document.getElementById('programsDocsError');
            if (!wrapper) return;

            if (!wrapper.dataset.rendered) {
                wrapper.innerHTML = `
                    <div class="legacy-programs-notice">
                        <h4>Legacy Programs experience</h4>
                        <p>The updated Programs &amp; Docs module is currently unavailable (${reason}). Disable the <code>programsV2Core</code> feature flag or contact support for assistance.</p>
                    </div>
                `;
                wrapper.dataset.rendered = 'true';
            }

            wrapper.hidden = false;
            if (errorEl) {
                errorEl.hidden = false;
            }
            programsDocsLegacyNoticeShown = true;
            document.body.classList.remove('programs-docs-v2-active');
            initializeLegacyProgramsModule();
        }

        // Switch between tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the clicked button
            const clickedBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => {
                const target = btn.dataset.tabTarget;
                if (target) {
                    return target === tab;
                }
                return btn.textContent.toLowerCase().includes(tab.toLowerCase());
            });
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tab === 'programs') {
                const programsTab = document.getElementById('programsTab');
                if (programsTab) {
                    programsTab.classList.add('active');
                }
                if (shouldUseProgramsDocs()) {
                    mountProgramsDocsModule().catch(() => {});
                } else if (!window.__legacyProgramsInitialized) {
                    initializeLegacyProgramsModule();
                }
            } else if (tab === 'clients') {
                const clientsTab = document.getElementById('clientsTab');
                if (clientsTab) clientsTab.classList.add('active');
                
                // Initialize CM Tracker if not already initialized
                if (!cmTrackerInitialized) {
                    initializeCMTracker();
                }
            } else if (tab === 'dashboard') {
                const dashboardTab = document.getElementById('dashboardTab');
                if (dashboardTab) dashboardTab.classList.add('active');
            }
        }
        
        // Quick add client
        async function quickAddClient() {
            // Check if clientManager is initialized
            if (!window.clientManager) {
                showAlert('Client manager is not ready. Please refresh the page.', 'error');
                console.error('ClientManager not initialized');
                return;
            }
            
            const initials = document.getElementById('newClientInitials').value.trim().toUpperCase();
            const kipuId = document.getElementById('newClientKipu').value.trim();
            
            if (!initials || !kipuId) {
                showAlert('Please enter both initials and Kipu ID', 'error');
                return;
            }
            
            try {
                const newClient = await window.clientManager.createClient({
                    initials,
                    kipuId
                });
                
                // Clear form
                document.getElementById('newClientInitials').value = '';
                document.getElementById('newClientKipu').value = '';
                
                // Set as current client
                await window.clientManager.setCurrentClient(newClient.id);
                
                showAlert(`Client ${initials} added successfully!`, 'success');
                refreshClientsList();
            } catch (error) {
                showAlert(error.message, 'error');
                console.error('Error creating client:', error);
            }
        }
        
        // Filter clients
        function filterClients(filter) {
            currentClientFilter = filter;
            
            // Update filter tabs
            document.querySelectorAll('.client-filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            refreshClientsList();
        }
        
        // Search clients
        let clientSearchTimeout;
        function searchClients(query) {
            clearTimeout(clientSearchTimeout);
            clientSearchTimeout = setTimeout(async () => {
                const results = await clientManager.searchClients(query);
                displayClients(results);
            }, 300);
        }
        
        // Refresh clients list
        async function refreshClientsList() {
            // Check if old UI container exists (may not exist in CM Tracker view)
            const clientsContainer = document.getElementById('clientsList');
            if (!clientsContainer) {
                // Old UI doesn't exist, likely using CM Tracker
                return;
            }
            
            const allClients = await clientManager.getAllClients();
            let filteredClients = allClients;
            
            // Apply status filter
            if (currentClientFilter !== 'all') {
                filteredClients = allClients.filter(client => 
                    client.status === currentClientFilter
                );
            }
            
            // Apply search if active
            const searchBox = document.getElementById('clientSearchBox');
            if (searchBox) {
                const searchQuery = searchBox.value;
                if (searchQuery) {
                    const searchLower = searchQuery.toLowerCase();
                    filteredClients = filteredClients.filter(client => 
                        client.initials.toLowerCase().includes(searchLower) ||
                        client.kipuId.includes(searchQuery)
                    );
                }
            }
            
            displayClients(filteredClients);
        }
        
        // Display clients
        function displayClients(clients) {
            const container = document.getElementById('clientsList');
            
            // Check if old UI container exists (may not exist in CM Tracker view)
            if (!container) {
                // Old UI doesn't exist, likely using CM Tracker
                return;
            }
            
            if (!clients || clients.length === 0) {
                container.innerHTML = `
                    <div class="client-empty-state">
                        <div class="client-empty-icon">üë•</div>
                        <p>No clients found</p>
                    </div>
                `;
                return;
            }
            
            const currentClient = clientManager.getCurrentClient();
            
            container.innerHTML = clients.map(client => {
                const isSelected = currentClient?.id === client.id;
                const lastModified = new Date(client.lastModified).toLocaleDateString();
                const programCount = client.programHistory?.filter(p => p.status === 'selected').length || 0;
                
                return `
                    <div class="client-card ${isSelected ? 'selected' : ''}" 
                         onclick="selectClient('${client.id}')"
                         data-client-id="${client.id}">
                        <div class="client-card-avatar">${client.initials}</div>
                        <div class="client-card-info">
                            <div class="client-card-header">
                                <span class="client-card-name">${client.initials}</span>
                                <span class="client-status-badge ${client.status}">${client.status}</span>
                            </div>
                            <div class="client-card-kipu">Kipu ID: ${client.kipuId}</div>
                            <div class="client-card-meta">
                                <span>${programCount} programs</span>
                                <span>Modified: ${lastModified}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Select client
        async function selectClient(clientId) {
            await clientManager.setCurrentClient(clientId);
            refreshClientsList();
            updateCurrentClientDisplay();
            
            // If programs were selected for this client, restore them
            const clientPrograms = await clientManager.getClientPrograms(clientId);
            if (clientPrograms && clientPrograms.length > 0) {
                selectedPrograms = [...clientPrograms];
                updateSelectedPrograms();
                renderSelectedPrograms();
            }
        }
        
        // Update current client display
        function updateCurrentClientDisplay() {
            const client = clientManager.getCurrentClient();
            
            // Check if elements exist (may not exist in CM Tracker view)
            const avatarEl = document.getElementById('currentClientAvatar');
            const nameEl = document.getElementById('currentClientName');
            const kipuEl = document.getElementById('currentClientKipu');
            
            if (!avatarEl || !nameEl || !kipuEl) {
                // Old UI elements don't exist, likely using CM Tracker
                return;
            }
            
            if (!client) {
                avatarEl.textContent = '--';
                nameEl.textContent = 'No Client Selected';
                kipuEl.textContent = 'Select a client to begin';
                return;
            }
            
            avatarEl.textContent = client.initials;
            nameEl.textContent = `${client.initials} - ${client.status}`;
            kipuEl.textContent = `Kipu ID: ${client.kipuId}`;
        }
        
        // Edit current client
        function editCurrentClient() {
            const client = clientManager.getCurrentClient();
            if (!client) {
                showAlert('No client selected', 'error');
                return;
            }
            
            // Create edit dialog
            const newStatus = prompt(`Change status for ${client.initials}:\n1. active\n2. waitlist\n3. discharged`, client.status);
            
            if (newStatus && ['active', 'waitlist', 'discharged'].includes(newStatus)) {
                clientManager.updateClientStatus(client.id, newStatus).then(() => {
                    showAlert('Client status updated', 'success');
                    refreshClientsList();
                    updateCurrentClientDisplay();
                });
            }
        }
        
        // Clear current client
        function clearCurrentClient() {
            clientManager.setCurrentClient(null);
            updateCurrentClientDisplay();
            // Clear selected programs
            selectedPrograms = [];
            updateSelectedPrograms();
            renderSelectedPrograms();
        }
        
        // Override the original handleProgramClick to link with current client
        const originalHandleProgramClick = window.handleProgramClick;
        window.handleProgramClick = function(programId, isSubProgram = false, parentId = null) {
            // Call original function
            if (originalHandleProgramClick) {
                originalHandleProgramClick(programId, isSubProgram, parentId);
            }
            
            // Track program selection for current client if clientManager is available
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client) {
                    if (selectedPrograms.includes(programId)) {
                        clientManager.addProgramToClient(client.id, programId, {
                            isSubProgram,
                            parentId,
                            addedFrom: 'program-list'
                        });
                    } else {
                        clientManager.removeProgramFromClient(client.id, programId);
                    }
                }
            }
        };
        
        // Override generateDocument to track for current client
        const originalGenerateDocument = window.generateDocument;
        window.generateDocument = function() {
            // Track for current client if clientManager is available
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client && selectedPrograms.length > 0) {
                    // Track document generation
                    clientManager.addDocumentRecord(client.id, {
                        type: documentType,
                        programIds: [...selectedPrograms],
                        settings: {
                            includeAtHome,
                            includeAlumni
                        },
                        fileName: `CareConnect_${client.initials}_${new Date().toISOString().split('T')[0]}.docx`
                    });
                }
            }
            
            // Call original function
            if (originalGenerateDocument) {
                return originalGenerateDocument();
            }
        };
        
        // Helper function to show alerts
        function showAlert(message, type = 'info') {
            // You can customize this to use your preferred notification system
            const alertClass = type === 'error' ? 'error-alert' : 'success-alert';
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.textContent = message;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'error' ? '#ef4444' : '#10b981'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // Export client data
        async function exportClientData() {
            try {
                const clients = await clientManager.getAllClients();
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    clients: clients
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `clients-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showAlert(`Exported ${clients.length} clients`, 'success');
            } catch (error) {
                showAlert('Failed to export clients', 'error');
                console.error(error);
            }
        }
        
        // Import client data
        async function importClientData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.clients || !Array.isArray(data.clients)) {
                        throw new Error('Invalid client data format');
                    }
                    
                    let imported = 0;
                    for (const client of data.clients) {
                        try {
                            await clientManager.importClient(client);
                            imported++;
                        } catch (err) {
                            console.warn(`Failed to import client ${client.initials}:`, err);
                        }
                    }
                    
                    await refreshClientsList();
                    showAlert(`Imported ${imported} clients`, 'success');
                } catch (error) {
                    showAlert('Failed to import clients', 'error');
                    console.error(error);
                }
            };
            
            input.click();
        }
        
        // Toggle recent clients dropdown
        function toggleRecentClients() {
            const dropdown = document.getElementById('recentClientsDropdown');
            if (dropdown.style.display === 'none') {
                loadRecentClients();
                dropdown.style.display = 'block';
                // Close on click outside
                setTimeout(() => {
                    document.addEventListener('click', closeRecentClientsOnClickOutside);
                }, 100);
            } else {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeRecentClientsOnClickOutside);
            }
        }
        
        // Close dropdown on click outside
        function closeRecentClientsOnClickOutside(e) {
            const dropdown = document.getElementById('recentClientsDropdown');
            if (!dropdown.contains(e.target) && !e.target.closest('button[onclick*="toggleRecentClients"]')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeRecentClientsOnClickOutside);
            }
        }
        
        // Load recent clients
        async function loadRecentClients() {
            const dropdown = document.getElementById('recentClientsDropdown');
            
            // Check if clientManager exists
            if (!window.clientManager) {
                dropdown.innerHTML = `
                    <div style="padding: 12px; color: #6b7280; text-align: center;">
                        Client manager not initialized yet
                    </div>
                `;
                return;
            }
            
            const recentClients = await clientManager.getRecentClients(5);
            const currentClient = clientManager.getCurrentClient();
            
            if (recentClients.length === 0) {
                dropdown.innerHTML = `
                    <div style="padding: 12px; color: #6b7280; text-align: center;">
                        No recent clients
                    </div>
                `;
                return;
            }
            
            dropdown.innerHTML = recentClients.map(client => {
                const isActive = currentClient?.id === client.id;
                const programCount = client.programHistory?.filter(p => p.status === 'selected').length || 0;
                return `
                    <div onclick="quickSelectClient('${client.id}')" 
                         style="padding: 10px; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: background 0.2s; ${isActive ? 'background: #ede9fe;' : ''}"
                         onmouseover="this.style.background='#f3f4f6'" 
                         onmouseout="this.style.background='${isActive ? '#ede9fe' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #1f2937;">${client.initials}</strong>
                                <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Kipu: ${client.kipuId}</span>
                            </div>
                            <span style="background: ${client.status === 'active' ? '#d1fae5' : client.status === 'waitlist' ? '#fef3c7' : '#f3f4f6'}; 
                                         color: ${client.status === 'active' ? '#065f46' : client.status === 'waitlist' ? '#92400e' : '#6b7280'}; 
                                         padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${client.status}
                            </span>
                        </div>
                        <div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">
                            ${programCount} programs ‚Ä¢ Last modified: ${new Date(client.lastModified).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Quick select client from dropdown
        async function quickSelectClient(clientId) {
            if (!window.clientManager) {
                showAlert('Client manager not ready yet', 'error');
                return;
            }
            
            await selectClient(clientId);
            document.getElementById('recentClientsDropdown').style.display = 'none';
            document.removeEventListener('click', closeRecentClientsOnClickOutside);
            
            // Update current client indicator
            const currentClient = clientManager.getCurrentClient();
            const button = document.querySelector('button[onclick*="toggleRecentClients"]');
            if (currentClient && button) {
                button.innerHTML = `‚ö° ${currentClient.initials} (${currentClient.kipuId}) ‚ñº`;
            }
        }
        
        // Manage favorite programs
        function manageFavorites() {
            const favorites = JSON.parse(localStorage.getItem('favoritePrograms') || '[]');
            
            // Create a modal for managing favorites
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                z-index: 10001;
                max-width: 600px;
                width: 90%;
                max-height: 70vh;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <h3 style="margin-top: 0;">‚≠ê Manage Favorite Programs</h3>
                <p style="color: #6b7280; font-size: 14px;">Select programs to add to favorites for quick access:</p>
                <div id="favoritesSelection" style="margin: 20px 0;">
                    ${programs.slice(0, 20).map(program => `
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" value="${program.id}" 
                                   ${favorites.includes(program.id) ? 'checked' : ''} 
                                   style="margin-right: 8px;">
                            ${program.name}
                        </label>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="this.closest('div').remove(); document.querySelector('.modal-backdrop').remove();" 
                            style="padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveFavorites()" 
                            style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Save Favorites
                    </button>
                </div>
            `;
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
            `;
            backdrop.onclick = () => {
                modal.remove();
                backdrop.remove();
            };
            
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }
        
        // Save favorite programs
        function saveFavorites() {
            const checkboxes = document.querySelectorAll('#favoritesSelection input[type="checkbox"]');
            const favorites = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    favorites.push(checkbox.value);
                }
            });
            
            localStorage.setItem('favoritePrograms', JSON.stringify(favorites));
            loadFavoritePrograms();
            
            // Close modal
            document.querySelector('.modal-backdrop').remove();
            document.querySelector('#favoritesSelection').closest('div').remove();
            
            showAlert('Favorites saved!', 'success');
        }
        
        // Load favorite programs
        function loadFavoritePrograms() {
            const favorites = JSON.parse(localStorage.getItem('favoritePrograms') || '[]');
            const container = document.getElementById('favoritePrograms');
            const list = document.getElementById('favoriteProgramsList');
            
            if (favorites.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = favorites.map(programId => {
                const program = programs.find(p => p.id === programId);
                if (!program) return '';
                
                const isSelected = selectedPrograms.includes(programId);
                return `
                    <button onclick="toggleFavoriteProgram('${programId}')" 
                            style="padding: 6px 12px; 
                                   background: ${isSelected ? '#065f46' : '#f59e0b'}; 
                                   color: white; 
                                   border: none; 
                                   border-radius: 4px; 
                                   cursor: pointer; 
                                   font-size: 12px;
                                   transition: all 0.2s;">
                        ${isSelected ? '‚úì' : '+'} ${program.name}
                    </button>
                `;
            }).join('');
        }
        
        // Toggle favorite program
        function toggleFavoriteProgram(programId) {
            if (selectedPrograms.includes(programId)) {
                // Remove if already selected
                const index = selectedPrograms.indexOf(programId);
                selectedPrograms.splice(index, 1);
            } else {
                // Add to selection
                selectedPrograms.push(programId);
            }
            
            updateSelectedPrograms();
            renderSelectedPrograms();
            loadFavoritePrograms(); // Refresh the favorites display
            
            // Track for current client
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client) {
                    if (selectedPrograms.includes(programId)) {
                        clientManager.addProgramToClient(client.id, programId, { addedFrom: 'favorites' });
                    } else {
                        clientManager.removeProgramFromClient(client.id, programId);
                    }
                }
            }
        }
        
        // Initialize workflow features on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure tab navigation is visible immediately
            ensureTabNavigationVisible();
            
            setTimeout(() => {
                loadFavoritePrograms();
                
                // Ensure tab navigation is still visible after delay
                ensureTabNavigationVisible();
                
                // Check if clientManager is initialized
                if (!window.clientManager) {
                    console.warn('ClientManager not initialized after 2 seconds');
                    // Show warning if on clients tab
                    const clientsTab = document.getElementById('clientsTab');
                    if (clientsTab && clientsTab.classList.contains('active')) {
                        const statusDiv = document.getElementById('clientManagerStatus');
                        if (statusDiv) {
                            statusDiv.style.display = 'block';
                        }
                    }
                } else {
                    console.log('ClientManager is available:', window.clientManager);
                    // Update recent clients button with current client if any
                    const currentClient = clientManager.getCurrentClient();
                    if (currentClient) {
                        const button = document.querySelector('button[onclick*="toggleRecentClients"]');
                        if (button) {
                            button.innerHTML = `‚ö° ${currentClient.initials} (${currentClient.kipuId}) ‚ñº`;
                        }
                    }
                }
            }, 2000); // Increased timeout to ensure clientManager is initialized
        });
        
        // CM Tracker Functions
        
        // Show add client modal
        async function showAddClientModal() {
            const houses = await housesManager.getActiveHouses();
            const currentHouse = houses.find(h => h.id === currentHouseId) || houses[0];
            
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <h3>Add New Client</h3>
                        <form id="addClientForm" onsubmit="handleAddClient(event)">
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>Client Initials *</label>
                                    <input type="text" name="initials" maxlength="4" required 
                                           style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Kipu ID *</label>
                                    <input type="text" name="kipuId" required style="width: 100%;">
                                </div>
                                <div>
                                    <label>House *</label>
                                    <select name="houseId" required style="width: 100%;">
                                        ${houses.map(h => `
                                            <option value="${h.id}" ${h.id === currentHouse.id ? 'selected' : ''}>
                                                ${h.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label>Admission Date</label>
                                    <input type="date" name="admissionDate" style="width: 100%;">
                                </div>
                                <div>
                                    <label>Clinical Coach</label>
                                    <input type="text" name="clinicalCoachInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Case Manager</label>
                                    <input type="text" name="caseManagerInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Primary Therapist</label>
                                    <input type="text" name="primaryTherapistInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                                <button type="button" onclick="closeModal()" 
                                        style="padding: 10px 20px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Add Client
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add keyboard listener for ESC key
            document.addEventListener('keydown', handleModalKeydown);
            
            // Fix overlay click handling
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeModal();
                    }
                });
            }
        }
        
        // Handle add client form submission
        async function handleAddClient(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
                const clientData = {
                initials: formData.get('initials'),
                kipuId: formData.get('kipuId'),
                houseId: formData.get('houseId'),
                admissionDate: formData.get('admissionDate') || new Date().toISOString().split('T')[0],  // Default to today if not provided
                clinicalCoachInitials: formData.get('clinicalCoachInitials') || '',
                caseManagerInitials: formData.get('caseManagerInitials') || '',
                primaryTherapistInitials: formData.get('primaryTherapistInitials') || '',
                status: 'active'  // Explicitly set active status
            };
            
            try {
                const newClient = await window.clientManager.createClient(clientData);
                
                // Initialize milestones for the new client
                await milestonesManager.initializeClientMilestones(newClient.id);
                
                showAlert('Client added successfully!', 'success');
                closeModal();
                await loadHouseView(currentHouseId);
                await buildHouseNavigation(); // Update counts
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        // Close modal with cleanup
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                // Remove event listeners
                document.removeEventListener('keydown', handleModalKeydown);
                modal.remove();
            }
        }
        
        // Handle keyboard events for modal
        function handleModalKeydown(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        }
        
        // View client details with modern design
        async function viewClientDetails(clientId) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    showAlert('Client not found', 'error');
                    return;
                }
                
                // Get related data
                const house = housesManager.getHouseById(client.houseId);
                const milestones = await milestonesManager.getClientMilestones(clientId);
                const aftercareOptions = await aftercareManager.getClientAftercareOptions(clientId);
                const daysInCare = window.clientManager.calculateDaysInCare(client);
                const hoursElapsed = window.clientManager.calculateHoursElapsed(client);
                
                console.log('Debug - Days in care calculation:', {
                    clientInitials: client.initials,
                    admissionDate: client.admissionDate, 
                    daysInCare: daysInCare
                });
                
                // Calculate completion percentages based on tracking fields
                const trackingFields = [
                    'needsAssessment', 'healthPhysical', 'aftercareThreadSent',
                    'optionsDocUploaded', 'dischargePacketUploaded', 'referralClosureCorrespondence',
                    'gadCompleted', 'phqCompleted', 'satisfactionSurvey', 
                    'dischargeSummary', 'dischargePlanningNote', 'dischargeASAM'
                ];
                const completed = trackingFields.filter(field => client[field]).length;
                const completionPercentage = trackingFields.length > 0 ? Math.round((completed / trackingFields.length) * 100) : 0;
                
                // Build modal HTML with modern design
                const modalHTML = `
                    <div class="modal-overlay">
                        <div class="modal-content modern-modal">
                            <!-- Header with key metrics -->
                            <div class="modal-header">
                                <div class="modal-header-left">
                                    <h2 class="client-name">${client.initials}</h2>
                                    <span class="client-id">${client.kipuId}</span>
                                    <span class="client-status status-${client.status}">${client.status === 'active' ? '‚óè Active' : '‚óã Discharged'}</span>
                                </div>
                                <div class="modal-header-right">
                                    <div class="metric-card">
                                        <div class="metric-value">${daysInCare || 0}</div>
                                        <div class="metric-label">Days in Care</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value">${completionPercentage || 0}%</div>
                                        <div class="metric-label">Completed</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value">${house ? house.name : 'N/A'}</div>
                                        <div class="metric-label">House</div>
                                    </div>
                                </div>
                                <button class="modal-close" onclick="closeModal()">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="modal-toolbar" style="display:flex; justify-content:flex-end; gap:12px; margin: 12px 0 20px 0;">
                                <button class="primary-action" onclick="generateClientDocument('${clientId}', { focusSearch: true })" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                                    <span>‚ú®</span>
                                    <span>Create Document for ${client.initials}</span>
                                </button>
                            </div>
                            
                            <!-- Main Content Area -->
                            <div class="modal-body">
                                <!-- Sidebar Navigation -->
                                <div class="sidebar-nav">
                                    <button class="nav-item active" onclick="switchDetailSection('tracking', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M9 2L2 7L9 12M2 7H18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>Tracking</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('assessments', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M9 11L3 17L1 15L7 9L9 11ZM16 3L19 6L13 12L11 10L16 3Z" fill="currentColor"/>
                                        </svg>
                                        <span>Assessments</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('aftercare', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18C5.58172 18 2 14.4183 2 10C2 5.58172 5.58172 2 10 2ZM10 5L7 9H9V13L13 9H11V5H10Z" fill="currentColor"/>
                                        </svg>
                                        <span>Aftercare</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('team', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M12 4.354C11.3687 3.72275 10.5687 3.375 9.69995 3.375C8.83119 3.375 8.0312 3.72275 7.39995 4.354C6.7687 4.98525 6.42095 5.78525 6.42095 6.654C6.42095 7.52275 6.7687 8.32275 7.39995 8.954C8.0312 9.58525 8.83119 9.933 9.69995 9.933C10.5687 9.933 11.3687 9.58525 11.9999 8.954C12.6312 8.32275 12.9789 7.52275 12.9789 6.654C12.9789 5.78525 12.6312 4.98525 12 4.354Z" fill="currentColor"/>
                                            <path d="M16.5 14.954C16.5 14.274 16.3679 13.6019 16.1124 12.975C15.857 12.3482 15.4831 11.7786 15.0104 11.2969C14.5376 10.8152 13.975 10.4305 13.3525 10.1636C12.73 9.89666 12.0596 9.75255 11.3789 9.73875C10.8262 10.1458 10.1842 10.4271 9.49997 10.5598C8.81578 10.4271 8.17378 10.1458 7.62108 9.73875C6.94036 9.75255 6.26999 9.89666 5.64749 10.1636C5.025 10.4305 4.46235 10.8152 3.98965 11.2969C3.51695 11.7786 3.14301 12.3482 2.88758 12.975C2.63214 13.6019 2.5 14.274 2.5 14.954V16.563H16.5V14.954Z" fill="currentColor"/>
                                        </svg>
                                        <span>Care Team</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('timeline', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M10 2C14.418 2 18 5.582 18 10S14.418 18 10 18S2 14.418 2 10S5.582 2 10 2ZM10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>Timeline</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('notes', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M4 5C4 4.44772 4.44772 4 5 4H11C11.5523 4 12 4.44772 12 5V16L8 14L4 16V5Z" fill="currentColor"/>
                                        </svg>
                                        <span>Notes</span>
                                    </button>
                                </div>
                            
                                
                                <!-- Content Area -->
                                <div class="content-area">
                                    <!-- Tracking Section -->
                                    <div id="trackingSection" class="section-content active">
                                        ${hoursElapsed < 48 && client.status === 'active' ? `
                                        <!-- 48-hour Admission Countdown -->
                                        <div class="admission-timer ${hoursElapsed >= 36 ? 'timer-urgent' : hoursElapsed >= 24 ? 'timer-warning' : ''}">
                                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" style="margin-right: 8px;">
                                                <path d="M10 2C14.418 2 18 5.582 18 10S14.418 18 10 18S2 14.418 2 10S5.582 2 10 2ZM10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            <span class="timer-text">
                                                <strong>${48 - hoursElapsed} hours remaining</strong> for admission assessments
                                                ${!client.needsAssessment || !client.healthPhysical ? `
                                                    <span class="timer-items">
                                                        ${!client.needsAssessment ? '‚Ä¢ Needs Assessment' : ''}
                                                        ${!client.healthPhysical ? '‚Ä¢ Health & Physical' : ''}
                                                    </span>
                                                ` : ''}
                                            </span>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- Tracking Cards -->
                                        <div class="tracking-grid">
                                            <!-- Admission & Assessment Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìã Admission & Assessment</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item" data-tracking="needs-assessment">
                                                        <input type="checkbox" 
                                                               id="needs-assessment-${clientId}" 
                                                               ${client.needsAssessment ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'needsAssessment', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Needs Assessment</span>
                                                        ${client.needsAssessmentDate ? `<span class="completion-date">${new Date(client.needsAssessmentDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="health-physical">
                                                        <input type="checkbox" 
                                                               id="health-physical-${clientId}" 
                                                               ${client.healthPhysical ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'healthPhysical', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Health & Physical Assessment</span>
                                                        ${client.healthPhysicalDate ? `<span class="completion-date">${new Date(client.healthPhysicalDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Aftercare Planning Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üéØ Aftercare Planning</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item ${daysInCare >= 14 && daysInCare <= 16 ? 'highlight-warning' : daysInCare > 16 ? 'highlight-danger' : ''}" data-tracking="aftercare-thread">
                                                        <input type="checkbox" 
                                                               id="aftercare-thread-${clientId}" 
                                                               ${client.aftercareThreadSent ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'aftercareThreadSent', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Aftercare Planning Thread Sent</span>
                                                        ${daysInCare >= 14 ? `<span class="days-indicator days-${daysInCare}">${daysInCare} days</span>` : ''}
                                                        ${client.aftercareThreadDate ? `<span class="completion-date">${new Date(client.aftercareThreadDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="options-doc">
                                                        <input type="checkbox" 
                                                               id="options-doc-${clientId}" 
                                                               ${client.optionsDocUploaded ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'optionsDocUploaded', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Options Document in Kipu</span>
                                                        ${client.optionsDocUploadedDate ? `<span class="completion-date">${new Date(client.optionsDocUploadedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="discharge-packet">
                                                        <input type="checkbox" 
                                                               id="discharge-packet-${clientId}" 
                                                               ${client.dischargePacketUploaded ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargePacketUploaded', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Discharge Packet in Kipu</span>
                                                        ${client.dischargePacketDate ? `<span class="completion-date">${new Date(client.dischargePacketDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="referral-closure">
                                                        <input type="checkbox" 
                                                               id="referral-closure-${clientId}" 
                                                               ${client.referralClosureCorrespondence ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'referralClosureCorrespondence', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Referral/Closure Correspondence</span>
                                                        ${client.referralClosureDate ? `<span class="completion-date">${new Date(client.referralClosureDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                                
                                                <!-- Aftercare Options Progress Tracking -->
                                                ${client.aftercareOptions && client.aftercareOptions.length > 0 ? `
                                                    <div class="aftercare-options-tracking">
                                                        <h4 style="font-size: 14px; margin: 16px 0 12px 0; font-weight: 600; color: #374151;">
                                                            Aftercare Options Progress
                                                        </h4>
                                                        ${client.aftercareOptions.map(option => `
                                                            <div class="aftercare-option-item">
                                                                <div class="option-header">
                                                                    <span class="option-name">${option.programName}</span>
                                                                    <span class="option-status status-${option.status}">${option.status}</span>
                                                                </div>
                                                                
                                                                <div class="progress-tracker">
                                                                    <div class="progress-step ${option.familyContacted ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'familyContacted', ${!option.familyContacted})">
                                                                        <span class="step-icon">
                                                                            ${option.familyContacted ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                '‚òéÔ∏è'}
                                                                        </span>
                                                                        <span class="step-label">Family Contacted</span>
                                                                    </div>
                                                                    <div class="progress-step ${option.recordsSent ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'recordsSent', ${!option.recordsSent})">
                                                                        <span class="step-icon">
                                                                            ${option.recordsSent ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                'üìÑ'}
                                                                        </span>
                                                                        <span class="step-label">Records Sent</span>
                                                                    </div>
                                                                    <div class="progress-step ${option.assessmentScheduled ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'assessmentScheduled', ${!option.assessmentScheduled})">
                                                                        <span class="step-icon">
                                                                            ${option.assessmentScheduled ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                'üìÖ'}
                                                                        </span>
                                                                        <span class="step-label">Assessment Set</span>
                                                                    </div>
                                                                    <div class="progress-step ${option.accepted ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'accepted', ${!option.accepted})">
                                                                        <span class="step-icon">
                                                                            ${option.accepted ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                '‚úÖ'}
                                                                        </span>
                                                                        <span class="step-label">Accepted</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            
                                            <!-- Clinical Assessments Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìä Clinical Assessments</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item" data-tracking="gad-completed">
                                                        <input type="checkbox" 
                                                               id="gad-completed-${clientId}" 
                                                               ${client.gadCompleted ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'gadCompleted', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">GAD-7 Completed (in Kipu)</span>
                                                        ${client.gadCompletedDate ? `<span class="completion-date">${new Date(client.gadCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="phq-completed">
                                                        <input type="checkbox" 
                                                               id="phq-completed-${clientId}" 
                                                               ${client.phqCompleted ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'phqCompleted', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">PHQ-9 Completed (in Kipu)</span>
                                                        ${client.phqCompletedDate ? `<span class="completion-date">${new Date(client.phqCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="satisfaction-survey">
                                                        <input type="checkbox" 
                                                               id="satisfaction-survey-${clientId}" 
                                                               ${client.satisfactionSurvey ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'satisfactionSurvey', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Satisfaction Survey Completed</span>
                                                        ${client.satisfactionSurveyDate ? `<span class="completion-date">${new Date(client.satisfactionSurveyDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Documentation Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìÑ Documentation</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item" data-tracking="discharge-summary">
                                                        <input type="checkbox" 
                                                               id="discharge-summary-${clientId}" 
                                                               ${client.dischargeSummary ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargeSummary', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Discharge Summary</span>
                                                        ${client.dischargeSummaryDate ? `<span class="completion-date">${new Date(client.dischargeSummaryDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="discharge-planning">
                                                        <input type="checkbox" 
                                                               id="discharge-planning-${clientId}" 
                                                               ${client.dischargePlanningNote ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargePlanningNote', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Final Discharge Planning Note</span>
                                                        ${client.dischargePlanningNoteDate ? `<span class="completion-date">${new Date(client.dischargePlanningNoteDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="discharge-asam">
                                                        <input type="checkbox" 
                                                               id="discharge-asam-${clientId}" 
                                                               ${client.dischargeASAM ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargeASAM', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Discharge ASAM</span>
                                                        ${client.dischargeASAMDate ? `<span class="completion-date">${new Date(client.dischargeASAMDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Assessments Section -->
                                    <div id="assessmentsSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Assessment History</h2>
                                        </div>
                                        <div class="tracking-grid">
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìä Clinical Assessments Status</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item">
                                                        <input type="checkbox" ${client.gadCompleted ? 'checked' : ''} style="pointer-events: none;">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">GAD-7 Completed (in Kipu)</span>
                                                        ${client.gadCompletedDate ? `<span class="completion-date">${new Date(client.gadCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item">
                                                        <input type="checkbox" ${client.phqCompleted ? 'checked' : ''} style="pointer-events: none;">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">PHQ-9 Completed (in Kipu)</span>
                                                        ${client.phqCompletedDate ? `<span class="completion-date">${new Date(client.phqCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item">
                                                        <input type="checkbox" ${client.satisfactionSurvey ? 'checked' : ''} style="pointer-events: none;">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Satisfaction Survey Completed</span>
                                                        ${client.satisfactionSurveyDate ? `<span class="completion-date">${new Date(client.satisfactionSurveyDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìù Notes</h3>
                                                <p style="color: #6b7280; padding: 20px;">All assessments are completed within Kipu. This tracking ensures completion status is documented.</p>
                                            </div>
                                        </div>
                                    </div>
                                
                                    
                                    <!-- Aftercare Section -->
                                    <div id="aftercareSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Aftercare Options</h2>
                                            <button class="btn-primary" onclick="addAftercareOption('${clientId}')">+ Add Option</button>
                                        </div>
                                        <div class="aftercare-grid">
                                            ${buildModernAftercareList(aftercareOptions, clientId)}
                                        </div>
                                    </div>
                                    
                                    <!-- Care Team Section -->
                                    <div id="teamSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Care Team Assignments</h2>
                                        </div>
                                        <div class="team-grid">
                                            <div class="team-member-card">
                                                <div class="member-icon">ü§ù</div>
                                                <label>Case Manager</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="caseManager" 
                                                       value="${client.caseManagerInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'caseManagerInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üè•</div>
                                                <label>Clinical Coach</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="clinicalCoach" 
                                                       value="${client.clinicalCoachInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'clinicalCoachInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üë®‚Äç‚öïÔ∏è</div>
                                                <label>Primary Therapist</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="primaryTherapist" 
                                                       value="${client.primaryTherapistInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'primaryTherapistInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üë•</div>
                                                <label>Primary Family Ambassador</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="familyAmbassador" 
                                                       value="${client.familyAmbassadorPrimaryInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'familyAmbassadorPrimaryInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üë•</div>
                                                <label>Secondary Family Ambassador</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="familyAmbassador2" 
                                                       value="${client.familyAmbassadorSecondaryInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'familyAmbassadorSecondaryInitials', this.value)">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Timeline Section -->
                                    <div id="timelineSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Client Timeline</h2>
                                        </div>
                                        <div class="timeline-container">
                                            ${buildClientTimeline(client, milestones, daysInCare)}
                                        </div>
                                    </div>
                                    
                                    <!-- Notes Section -->
                                    <div id="notesSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Notes & Documentation</h2>
                                        </div>
                                        <div class="notes-container">
                                            <textarea class="notes-textarea" 
                                                      id="clientNotes" 
                                                      placeholder="Add notes about this client..."
                                                      oninput="autoSaveNotes('${clientId}', this.value)">${client.notes || ''}</textarea>
                                            <div class="notes-footer">
                                                <span id="noteSaveStatus" class="save-status">All changes saved</span>
                                                <span class="notes-timestamp">Last updated: ${client.notesUpdatedAt ? new Date(client.notesUpdatedAt).toLocaleString() : 'Never'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Add comprehensive modern styling
                const style = document.createElement('style');
                style.textContent = `
                    /* Modal Base Styles */
                    .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(0, 0, 0, 0.6);
                        backdrop-filter: blur(4px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 999999;
                        cursor: pointer;
                        animation: fadeIn 0.2s ease;
                    }
                    .modal-content {
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
                        cursor: default;
                        overflow: hidden;
                        position: relative;
                    }
                    .modern-modal {
                        width: 1000px;
                        max-width: 95vw;
                        height: 75vh;
                        max-height: 700px;
                        display: flex;
                        flex-direction: column;
                        animation: slideIn 0.3s ease;
                    }
                    
                    /* Modal Header */
                    .modal-header {
                        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                        color: white;
                        padding: 24px;
                        display: flex;
                        align-items: center;
                        gap: 20px;
                        position: relative;
                    }
                    .modal-header-left {
                        flex: 1;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    .client-name {
                        font-size: 22px;
                        font-weight: 700;
                        margin: 0;
                    }
                    .client-id {
                        background: rgba(255,255,255,0.2);
                        padding: 4px 10px;
                        border-radius: 20px;
                        font-size: 13px;
                    }
                    .client-status {
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: 500;
                    }
                    .status-active {
                        background: #10b981;
                        color: white;
                    }
                    .status-discharged {
                        background: #ef4444;
                        color: white;
                    }
                    
                    /* Header Metrics */
                    .modal-header-right {
                        display: flex;
                        gap: 16px;
                    }
                    .metric-card {
                        background: rgba(255,255,255,0.15);
                        backdrop-filter: blur(10px);
                        padding: 12px 20px;
                        border-radius: 12px;
                        text-align: center;
                        min-width: 100px;
                    }
                    .metric-value {
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 4px;
                    }
                    .metric-label {
                        font-size: 12px;
                        opacity: 0.9;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    
                    /* Modal Close Button */
                    .modal-close {
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        color: white;
                    }
                    .modal-close:hover {
                        background: rgba(255,255,255,0.3);
                        transform: scale(1.1);
                    }
                    
                    /* Modal Body */
                    .modal-body {
                        flex: 1;
                        display: flex;
                        overflow: hidden;
                        background: #f8f9fa;
                    }
                    
                    /* Sidebar Navigation */
                    .sidebar-nav {
                        width: 180px;
                        background: white;
                        padding: 12px 6px;
                        border-right: 1px solid #e5e7eb;
                        display: flex;
                        flex-direction: column;
                        gap: 2px;
                    }
                    .nav-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px 12px;
                        border: none;
                        background: transparent;
                        color: #6b7280;
                        font-size: 13px;
                        font-weight: 500;
                        text-align: left;
                        cursor: pointer;
                        border-radius: 6px;
                        transition: all 0.2s ease;
                    }
                    .nav-item:hover {
                        background: #f3f4f6;
                        color: #1f2937;
                    }
                    .nav-item.active {
                        background: #6366f1;
                        color: white;
                    }
                    .nav-icon {
                        width: 20px;
                        height: 20px;
                        flex-shrink: 0;
                    }
                    
                    /* Content Area */
                    .content-area {
                        flex: 1;
                        overflow-y: auto;
                        padding: 24px;
                    }
                    .section-content {
                        display: none;
                    }
                    .section-content.active {
                        display: block;
                        animation: fadeIn 0.3s ease;
                    }
                    .section-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 24px;
                    }
                    .section-header h2 {
                        font-size: 24px;
                        font-weight: 700;
                        color: #1f2937;
                        margin: 0;
                    }
                    
                    /* Tracking Grid */
                    .tracking-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 16px;
                    }
                    .tracking-card {
                        background: white;
                        border-radius: 10px;
                        padding: 16px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
                        transition: all 0.2s ease;
                    }
                    .tracking-card:hover {
                        box-shadow: 0 3px 12px rgba(0,0,0,0.1);
                        transform: translateY(-1px);
                    }
                    
                    /* Admission Timer */
                    .admission-timer {
                        display: flex;
                        align-items: center;
                        background: #fef3c7;
                        border: 2px solid #f59e0b;
                        border-radius: 8px;
                        padding: 12px 16px;
                        margin-bottom: 16px;
                        font-size: 14px;
                        color: #92400e;
                    }
                    .admission-timer.timer-warning {
                        background: #fee2e2;
                        border-color: #ef4444;
                        color: #991b1b;
                    }
                    .admission-timer.timer-urgent {
                        background: #dc2626;
                        border-color: #991b1b;
                        color: white;
                        animation: pulse 2s infinite;
                    }
                    .timer-text {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }
                    .timer-items {
                        font-size: 12px;
                        opacity: 0.9;
                        margin-left: 28px;
                    }
                    
                    /* Aftercare Progress Tracking */
                    .aftercare-options-tracking {
                        margin-top: 16px;
                        border-top: 1px solid #e5e7eb;
                        padding-top: 12px;
                    }
                    .aftercare-option-item {
                        background: #f9fafb;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 12px;
                    }
                    .option-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                    }
                    .option-name {
                        font-weight: 600;
                        font-size: 14px;
                        color: #111827;
                    }
                    .option-status {
                        font-size: 12px;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-weight: 500;
                        text-transform: capitalize;
                    }
                    .status-exploring {
                        background: #dbeafe;
                        color: #1e40af;
                    }
                    .status-in-progress {
                        background: #fef3c7;
                        color: #92400e;
                    }
                    .status-accepted {
                        background: #d1fae5;
                        color: #065f46;
                    }
                    .status-declined {
                        background: #fee2e2;
                        color: #991b1b;
                    }
                    
                    /* Progress Tracker Steps */
                    .progress-tracker {
                        display: flex;
                        gap: 8px;
                        flex-wrap: wrap;
                    }
                    .progress-step {
                        flex: 1;
                        min-width: 100px;
                        background: white;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 8px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 4px;
                    }
                    .progress-step:hover {
                        border-color: #6366f1;
                        background: #eef2ff;
                    }
                    .progress-step.completed {
                        background: #10b981;
                        border-color: #10b981;
                        color: white;
                    }
                    .step-icon {
                        font-size: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: transform 0.2s ease;
                    }
                    
                    .progress-step:hover .step-icon {
                        transform: scale(1.1);
                    }
                    
                    .progress-step.completed .step-icon svg {
                        animation: svgCheckPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                    }
                    
                    @keyframes svgCheckPop {
                        0% {
                            transform: scale(0) rotate(-45deg);
                            opacity: 0;
                        }
                        50% {
                            transform: scale(1.2) rotate(5deg);
                        }
                        100% {
                            transform: scale(1) rotate(0deg);
                            opacity: 1;
                        }
                    }
                    .step-label {
                        font-size: 11px;
                        font-weight: 500;
                    }
                    
                    /* Day indicators */
                    .days-indicator {
                        background: #fbbf24;
                        color: #78350f;
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 11px;
                        font-weight: 600;
                        margin-left: auto;
                    }
                    .days-15, .days-16 {
                        background: #fb923c;
                        color: #7c2d12;
                    }
                    .days-17, .days-18, .days-19, .days-20 {
                        background: #ef4444;
                        color: white;
                    }
                    
                    /* Highlight states */
                    .highlight-warning {
                        background: #fef3c7 !important;
                    }
                    .highlight-danger {
                        background: #fee2e2 !important;
                    }
                    
                    @keyframes pulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.8; }
                        100% { opacity: 1; }
                    }
                    .card-title {
                        font-size: 15px;
                        font-weight: 600;
                        color: #1f2937;
                        margin: 0 0 12px 0;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    
                    /* Checklist Styles */
                    .checklist {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }
                    .checklist-item {
                        display: flex;
                        align-items: center;
                        cursor: pointer;
                        padding: 8px 10px;
                        border-radius: 6px;
                        transition: all 0.2s ease;
                        position: relative;
                        font-size: 13px;
                    }
                    .checklist-item:hover {
                        background: #f9fafb;
                    }
                    .checklist-item.highlight-warning {
                        background: #fef3c7;
                        border: 1px solid #fbbf24;
                    }
                    .checklist-item.highlight-danger {
                        background: #fee2e2;
                        border: 1px solid #ef4444;
                    }
                    .checklist-item input[type="checkbox"] {
                        position: absolute;
                        opacity: 0;
                        cursor: pointer;
                    }
                    
                    .checklist-item input[type="checkbox"][style*="pointer-events: none"] {
                        cursor: default;
                    }
                    .checkbox-custom {
                        width: 24px;
                        height: 24px;
                        border: 2.5px solid #e5e7eb;
                        border-radius: 6px;
                        margin-right: 12px;
                        position: relative;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        flex-shrink: 0;
                        background: white;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                        overflow: hidden;
                    }
                    
                    .checklist-item:hover .checkbox-custom {
                        border-color: #22c55e;
                        transform: scale(1.05);
                        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1),
                                    0 1px 3px rgba(0, 0, 0, 0.1);
                    }
                    
                    .checkbox-custom::before {
                        content: '';
                        position: absolute;
                        top: -1px;
                        left: -1px;
                        right: -1px;
                        bottom: -1px;
                        background: linear-gradient(135deg, #22c55e, #16a34a);
                        transform: scale(0);
                        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        border-radius: 4px;
                    }
                    
                    .checklist-item input:checked ~ .checkbox-custom,
                    .checklist-item input[checked] ~ .checkbox-custom {
                        border-color: transparent;
                        animation: checkPulse 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    }
                    
                    .checklist-item input:checked ~ .checkbox-custom::before,
                    .checklist-item input[checked] ~ .checkbox-custom::before {
                        transform: scale(1);
                    }
                    
                    .checklist-item input:checked ~ .checkbox-custom::after,
                    .checklist-item input[checked] ~ .checkbox-custom::after {
                        content: '';
                        position: absolute;
                        width: 7px;
                        height: 12px;
                        border: solid white;
                        border-width: 0 3px 3px 0;
                        top: 40%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(45deg) scale(1);
                        animation: checkmarkPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                        animation-delay: 0.1s;
                        animation-fill-mode: both;
                        z-index: 2;
                    }
                    
                    @keyframes checkPulse {
                        0% { 
                            transform: scale(1); 
                            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                        }
                        30% { 
                            transform: scale(0.95); 
                            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                        }
                        60% { 
                            transform: scale(1.1); 
                            box-shadow: 0 0 0 8px rgba(34, 197, 94, 0.15),
                                        0 2px 4px rgba(0, 0, 0, 0.1);
                        }
                        100% { 
                            transform: scale(1); 
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                    }
                    
                    @keyframes checkmarkPop {
                        0% {
                            transform: translate(-50%, -50%) rotate(45deg) scale(0);
                            opacity: 0;
                        }
                        50% {
                            transform: translate(-50%, -50%) rotate(45deg) scale(1.3);
                            opacity: 1;
                        }
                        100% {
                            transform: translate(-50%, -50%) rotate(45deg) scale(1);
                            opacity: 1;
                        }
                    }
                    .item-text {
                        flex: 1;
                        color: #374151;
                        font-weight: 500;
                        font-size: 13px;
                    }
                    .checklist-item input:checked ~ .item-text,
                    .checklist-item input[checked] ~ .item-text {
                        color: #6b7280;
                        text-decoration: line-through;
                    }
                    .completion-date {
                        font-size: 11px;
                        color: #9ca3af;
                        margin-left: auto;
                    }
                    .days-indicator {
                        font-size: 12px;
                        font-weight: 600;
                        padding: 2px 8px;
                        border-radius: 12px;
                        margin-left: 8px;
                    }
                    .days-14, .days-15, .days-16 {
                        background: #fef3c7;
                        color: #92400e;
                    }
                    .days-indicator.days-17,
                    .days-indicator.days-18,
                    .days-indicator.days-19,
                    .days-indicator.days-20 {
                        background: #fee2e2;
                        color: #991b1b;
                    }
                    
                    /* Assessment Scores */
                    .assessment-scores {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                        margin-bottom: 16px;
                    }
                    .score-item {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }
                    .score-item label {
                        font-size: 14px;
                        font-weight: 600;
                        color: #374151;
                    }
                    .score-input {
                        padding: 8px 12px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        text-align: center;
                        transition: all 0.2s ease;
                    }
                    .score-input:focus {
                        outline: none;
                        border-color: #6366f1;
                        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                    }
                    
                    /* Team Grid */
                    .team-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 16px;
                    }
                    .team-member-card {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        transition: all 0.2s ease;
                    }
                    .team-member-card:hover {
                        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                        transform: translateY(-2px);
                    }
                    .member-icon {
                        font-size: 32px;
                        margin-bottom: 8px;
                    }
                    .team-member-card label {
                        display: block;
                        font-size: 14px;
                        font-weight: 600;
                        color: #374151;
                        margin-bottom: 8px;
                    }
                    .team-input {
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        text-align: center;
                        font-size: 18px;
                        font-weight: 700;
                        text-transform: uppercase;
                        transition: all 0.2s ease;
                    }
                    .team-input:focus {
                        outline: none;
                        border-color: #6366f1;
                        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                    }
                    
                    /* Notes Section */
                    .notes-container {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                    }
                    .notes-textarea {
                        width: 100%;
                        min-height: 300px;
                        padding: 16px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-family: inherit;
                        font-size: 14px;
                        line-height: 1.5;
                        resize: vertical;
                        transition: all 0.2s ease;
                    }
                    .notes-textarea:focus {
                        outline: none;
                        border-color: #6366f1;
                        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                    }
                    .notes-footer {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 12px;
                    }
                    .save-status {
                        font-size: 12px;
                        color: #10b981;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    }
                    .save-status.saving {
                        color: #6366f1;
                    }
                    .notes-timestamp {
                        font-size: 12px;
                        color: #9ca3af;
                    }
                    
                    /* Buttons */
                    .btn-primary {
                        background: #6366f1;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .btn-primary:hover {
                        background: #4f46e5;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
                    }
                    
                    /* Animations */
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .detail-tab-content {
                        padding: 20px;
                    }
                    .milestone-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        margin-bottom: 8px;
                        background: #f9fafb;
                        border-radius: 8px;
                        border: 1px solid #e5e7eb;
                    }
                    .milestone-item:hover {
                        background: #f3f4f6;
                    }
                    .aftercare-item {
                        padding: 15px;
                        margin-bottom: 10px;
                        background: white;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                    }
                    
                    /* Visual indicator color coding */
                    .milestone-indicator {
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        min-width: 28px;
                        height: 28px;
                        border-radius: 6px;
                        font-size: 16px;
                        transition: all 0.2s ease;
                        cursor: pointer;
                        user-select: none;
                    }
                    
                    .milestone-indicator.complete {
                        background-color: #10b981;
                        color: white;
                    }
                    
                    .milestone-indicator.overdue {
                        background-color: #ef4444;
                        color: white;
                        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
                    }
                    
                    .milestone-indicator.due-today {
                        background-color: #f59e0b;
                        color: white;
                    }
                    
                    .milestone-indicator.due-soon {
                        background-color: #f59e0b;
                        color: white;
                        opacity: 0.8;
                    }
                    
                    .milestone-indicator.in-progress {
                        background-color: #3b82f6;
                        color: white;
                    }
                    
                    .milestone-indicator.pending {
                        background-color: #e5e7eb;
                        color: #6b7280;
                    }
                    
                    @keyframes pulse {
                        0%, 100% {
                            opacity: 1;
                        }
                        50% {
                            opacity: .8;
                        }
                    }
                    
                    /* Days in care color coding */
                    .days-in-care {
                        font-weight: 500;
                    }
                    
                    td.days-in-care {
                        text-align: center;
                    }
                    
                    /* Color code days based on milestones */
                    .days-13 { color: #f59e0b; font-weight: 600; }
                    .days-14 { color: #f59e0b; font-weight: 600; }
                    .days-16plus { color: #ef4444; font-weight: 600; }
                `;
                document.head.appendChild(style);
                
                // Add keyboard listener for ESC key
                document.addEventListener('keydown', handleModalKeydown);
                
                // Fix overlay click handling
                const overlay = document.querySelector('.modal-overlay');
                if (overlay) {
                    overlay.addEventListener('click', function(event) {
                        if (event.target === this) {
                            closeModal();
                        }
                    });
                    
                    // Prevent clicks inside modal from bubbling up
                    const modalContent = overlay.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.addEventListener('click', function(event) {
                            event.stopPropagation();
                        });
                    }
                }
                
            } catch (error) {
                console.error('Failed to load client details:', error);
                showAlert('Failed to load client details', 'error');
            }
        }
        
        // Update tracking field for a client
        async function updateTracking(clientId, field, checked) {
            try {
                const update = {};
                update[field] = checked;
                
                // Add timestamp if checked
                if (checked) {
                    update[field + 'Date'] = new Date().toISOString();
                } else {
                    update[field + 'Date'] = null;
                }
                
                await window.clientManager.updateClient(clientId, update);
                
                // Visual feedback
                const checkbox = document.querySelector(`#${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-${clientId}`);
                if (checkbox) {
                    const label = checkbox.closest('.checklist-item');
                    if (label) {
                        label.style.background = checked ? '#d1fae5' : 'transparent';
                        setTimeout(() => {
                            label.style.background = '';
                        }, 500);
                    }
                }
                
                // Update completion percentage
                updateCompletionPercentage(clientId);
                
                // Show success message
                showAlert(`‚úÖ ${field} ${checked ? 'marked complete' : 'unchecked'}`, 'success');
            } catch (error) {
                console.error('Failed to update tracking:', error);
                showAlert('Failed to update tracking', 'error');
            }
        }
        
        // Update aftercare option progress
        async function updateAftercareProgress(clientId, programId, field, value) {
            try {
                const progressUpdate = {};
                progressUpdate[field] = value;
                
                // Add timestamp for certain fields
                if (value && ['familyContacted', 'recordsSent', 'assessmentScheduled', 'accepted'].includes(field)) {
                    progressUpdate[field + 'Date'] = new Date().toISOString();
                }
                
                // Update status based on progress
                if (field === 'accepted' && value) {
                    progressUpdate.status = 'accepted';
                } else if (field === 'assessmentScheduled' && value) {
                    progressUpdate.status = 'in-progress';
                }
                
                await window.clientManager.updateAftercareProgress(clientId, programId, progressUpdate);
                
                // Reload the section to show updated data
                const client = await window.clientManager.getClient(clientId);
                if (client && client.aftercareOptions) {
                    const aftercareHTML = client.aftercareOptions.map(option => `
                        <div class="aftercare-option-item">
                            <div class="option-header">
                                <span class="option-name">${option.programName}</span>
                                <span class="option-status status-${option.status}">${option.status}</span>
                            </div>
                            
                            <div class="progress-tracker">
                                <div class="progress-step ${option.familyContacted ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'familyContacted', ${!option.familyContacted})">
                                    <span class="step-icon">
                                        ${option.familyContacted ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            '‚òéÔ∏è'}
                                    </span>
                                    <span class="step-label">Family Contacted</span>
                                </div>
                                <div class="progress-step ${option.recordsSent ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'recordsSent', ${!option.recordsSent})">
                                    <span class="step-icon">
                                        ${option.recordsSent ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            'üìÑ'}
                                    </span>
                                    <span class="step-label">Records Sent</span>
                                </div>
                                <div class="progress-step ${option.assessmentScheduled ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'assessmentScheduled', ${!option.assessmentScheduled})">
                                    <span class="step-icon">
                                        ${option.assessmentScheduled ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            'üìÖ'}
                                    </span>
                                    <span class="step-label">Assessment Set</span>
                                </div>
                                <div class="progress-step ${option.accepted ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'accepted', ${!option.accepted})">
                                    <span class="step-icon">
                                        ${option.accepted ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            '‚úÖ'}
                                    </span>
                                    <span class="step-label">Accepted</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Update just the aftercare tracking section
                    const trackingSection = document.querySelector('.aftercare-options-tracking');
                    if (trackingSection) {
                        trackingSection.innerHTML = `
                            <h4 style="font-size: 14px; margin: 16px 0 12px 0; font-weight: 600; color: #374151;">
                                Aftercare Options Progress
                            </h4>
                            ${aftercareHTML}
                        `;
                    }
                }
                
                showAlert(`‚úÖ Updated ${field} for aftercare option`, 'success');
            } catch (error) {
                console.error('Failed to update aftercare progress:', error);
                showAlert('Failed to update aftercare progress', 'error');
            }
        }
        
        // Update completion percentage in the header
        async function updateCompletionPercentage(clientId) {
            const client = await window.clientManager.getClient(clientId);
            if (!client) return;
            
            const trackingFields = [
                'needsAssessment', 'healthPhysical', 'aftercareThreadSent',
                'optionsDocUploaded', 'dischargePacketUploaded', 'referralClosureCorrespondence',
                'gadCompleted', 'phqCompleted', 'satisfactionSurvey', 
                'dischargeSummary', 'dischargePlanningNote', 'dischargeASAM'
            ];
            const completed = trackingFields.filter(field => client[field]).length;
            const completionPercentage = trackingFields.length > 0 ? Math.round((completed / trackingFields.length) * 100) : 0;
            
            // Update the percentage display
            const percentageDisplay = document.querySelector('.metric-value');
            if (percentageDisplay && percentageDisplay.nextElementSibling?.textContent === 'Completed') {
                percentageDisplay.textContent = `${completionPercentage}%`;
            }
        }
        
        // Build milestones list for client details
        async function buildMilestonesList(client, milestones, daysInCare) {
            let html = '<div>';
            
            for (const milestone of milestones) {
                const display = milestonesManager.getMilestoneDisplayStatus(milestone, daysInCare);
                const milestoneType = Object.values(milestonesManager.milestoneTypes).find(t => t.id === milestone.milestone);
                
                html += `
                    <div class="milestone-item">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${milestoneType.icon}</span>
                            <div>
                                <strong>${milestoneType.displayName}</strong>
                                <div style="font-size: 12px; color: #6b7280;">${milestoneType.description}</div>
                            </div>
                        </div>
                        <button onclick="toggleMilestone('${client.id}', '${milestone.milestone}')" 
                                class="milestone-indicator ${display.class}" 
                                style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; background: ${display.class === 'complete' ? '#10b981' : '#e5e7eb'}; color: ${display.class === 'complete' ? 'white' : '#374151'};">
                            ${display.icon} ${display.class === 'complete' ? 'Complete' : 'Mark Complete'}
                        </button>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Build aftercare list for client details
        function buildAftercareList(aftercareOptions, clientId) {
            if (aftercareOptions.length === 0) {
                return '<p style="color: #6b7280;">No aftercare options added yet.</p>';
            }
            
            let html = '<div>';
            
            for (const option of aftercareOptions) {
                const statusDisplay = aftercareManager.getStatusDisplay(option.status);
                
                html += `
                    <div class="aftercare-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 8px 0;">Option ${option.ordinal}: ${option.programName || 'Unnamed Program'}</h5>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <span style="padding: 4px 8px; background: ${statusDisplay.background}; color: ${statusDisplay.color}; border-radius: 4px; font-size: 12px;">
                                        ${statusDisplay.icon} ${statusDisplay.label}
                                    </span>
                                    ${option.dateProvidedToFamily ? `<span style="font-size: 12px; color: #6b7280;">Provided: ${option.dateProvidedToFamily}</span>` : ''}
                                </div>
                                ${option.notes ? `<p style="margin: 5px 0; font-size: 14px; color: #374151;">${option.notes}</p>` : ''}
                            </div>
                            <button onclick="editAftercareOption('${clientId}', ${option.ordinal})" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer;">
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Switch detail section
        function switchDetailSection(sectionName, event) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const sectionElement = document.getElementById(sectionName + 'Section');
            if (sectionElement) {
                sectionElement.classList.add('active');
            }
            
            // Add active class to selected nav item
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If no event, find the nav item by section name and activate it
                const navItem = document.querySelector(`.nav-item[onclick*="${sectionName}"]`);
                if (navItem) navItem.classList.add('active');
            }
        }
        
        // Save care team
        async function saveCareTeam(clientId) {
            try {
                const updates = {
                    clinicalCoachInitials: document.getElementById('clinicalCoach').value,
                    caseManagerInitials: document.getElementById('caseManager').value,
                    primaryTherapistInitials: document.getElementById('primaryTherapist').value,
                    familyAmbassadorPrimaryInitials: document.getElementById('familyAmbassador').value
                };
                
                await window.clientManager.updateClient(clientId, updates);
                showAlert('Care team updated successfully', 'success');
                
                // Refresh the table
                await loadHouseView(currentHouseId);
            } catch (error) {
                console.error('Failed to save care team:', error);
                showAlert('Failed to save care team', 'error');
            }
        }
        
        // Update tracking checkbox
        async function updateTracking(clientId, field, checked) {
            try {
                const updates = { [field]: checked };
                // Add timestamp if checked
                if (checked) {
                    updates[field + 'Date'] = new Date().toISOString();
                }
                
                await window.clientManager.updateClient(clientId, updates);
                
                // Visual feedback
                const checkbox = document.getElementById(`${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-${clientId}`);
                if (checkbox) {
                    const item = checkbox.closest('.checklist-item');
                    if (item) {
                        // Add completion animation
                        item.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            item.style.transform = 'scale(1)';
                        }, 200);
                    }
                }
                
                // Update completion percentage
                updateCompletionPercentage(clientId);
            } catch (error) {
                console.error('Failed to update tracking:', error);
                showAlert('Failed to update tracking', 'error');
                // Revert checkbox
                const checkbox = document.getElementById(`${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-${clientId}`);
                if (checkbox) checkbox.checked = !checked;
            }
        }
        
        // Update score
        async function updateScore(clientId, field, value) {
            try {
                const updates = { [field]: value ? parseInt(value) : null };
                await window.clientManager.updateClient(clientId, updates);
                
                // Visual feedback
                const input = document.getElementById(`${field.replace('Score', '-score')}-${clientId}`);
                if (input) {
                    input.style.borderColor = '#10b981';
                    setTimeout(() => {
                        input.style.borderColor = '#e5e7eb';
                    }, 1000);
                }
            } catch (error) {
                console.error('Failed to update score:', error);
                showAlert('Failed to update score', 'error');
            }
        }
        
        // Update team member
        async function updateTeamMember(clientId, field, value) {
            try {
                const updates = { [field]: value.toUpperCase() };
                await window.clientManager.updateClient(clientId, updates);
                
                // Visual feedback
                const input = event.target;
                if (input) {
                    input.style.borderColor = '#10b981';
                    setTimeout(() => {
                        input.style.borderColor = '#e5e7eb';
                    }, 1000);
                }
            } catch (error) {
                console.error('Failed to update team member:', error);
                showAlert('Failed to update team member', 'error');
            }
        }
        
        // Auto-save notes
        let noteSaveTimeout;
        async function autoSaveNotes(clientId, notes) {
            const statusElement = document.getElementById('noteSaveStatus');
            if (statusElement) {
                statusElement.textContent = 'Saving...';
                statusElement.classList.add('saving');
            }
            
            // Clear previous timeout
            clearTimeout(noteSaveTimeout);
            
            // Set new timeout
            noteSaveTimeout = setTimeout(async () => {
                try {
                    await window.clientManager.updateClient(clientId, { 
                        notes,
                        notesUpdatedAt: new Date().toISOString()
                    });
                    
                    if (statusElement) {
                        statusElement.textContent = 'All changes saved';
                        statusElement.classList.remove('saving');
                    }
                } catch (error) {
                    console.error('Failed to save notes:', error);
                    if (statusElement) {
                        statusElement.textContent = 'Failed to save';
                        statusElement.classList.remove('saving');
                        statusElement.style.color = '#ef4444';
                    }
                }
            }, 1000); // Save after 1 second of no typing
        }
        
        // Update completion percentage
        async function updateCompletionPercentage(clientId) {
            try {
                const client = await window.clientManager.getClient(clientId);
                const trackingFields = [
                    'needsAssessment', 'healthPhysical', 'aftercareThreadSent',
                    'optionsDocUploaded', 'dischargePacketUploaded', 'gadCompleted',
                    'phqCompleted', 'satisfactionSurvey', 'referralClosure', 
                    'dischargeSummary', 'dischargePlanningNote', 'dischargeASAM'
                ];
                
                const completed = trackingFields.filter(field => client[field]).length;
                const percentage = Math.round((completed / trackingFields.length) * 100);
                
                const percentageElement = document.querySelector('.metric-value');
                if (percentageElement) {
                    percentageElement.textContent = percentage + '%';
                    // Add animation
                    percentageElement.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        percentageElement.style.transform = 'scale(1)';
                    }, 300);
                }
            } catch (error) {
                console.error('Failed to update percentage:', error);
            }
        }
        
        // Build assessment history
        async function buildAssessmentHistory(clientId) {
            // This would fetch assessment history from your data source
            // For now, return a placeholder
            return `
                <div class="assessment-placeholder">
                    <p style="color: #6b7280; text-align: center; padding: 40px;">
                        No assessments recorded yet. Click "Add Assessment" to begin.
                    </p>
                </div>
            `;
        }
        
        // Build modern aftercare list
        function buildModernAftercareList(aftercareOptions, clientId) {
            if (!aftercareOptions || aftercareOptions.length === 0) {
                return `
                    <div class="aftercare-placeholder">
                        <p style="color: #6b7280; text-align: center; padding: 40px;">
                            No aftercare options added yet. Click "Add Option" to begin.
                        </p>
                    </div>
                `;
            }
            
            return aftercareOptions.map(option => `
                <div class="aftercare-card">
                    <div class="aftercare-header">
                        <h4>${option.programName}</h4>
                        <span class="aftercare-status status-${option.status}">${option.status}</span>
                    </div>
                    <div class="aftercare-details">
                        ${option.dateProvided ? `<p><strong>Date Provided:</strong> ${new Date(option.dateProvided).toLocaleDateString()}</p>` : ''}
                        ${option.notes ? `<p><strong>Notes:</strong> ${option.notes}</p>` : ''}
                    </div>
                    <button class="btn-secondary" onclick="removeAftercareOption('${clientId}', '${option.id}')">Remove</button>
                </div>
            `).join('');
        }
        
        // Build client timeline
        function buildClientTimeline(client, milestones, daysInCare) {
            const events = [];
            
            // Add admission event
            if (client.admissionDate) {
                events.push({
                    date: new Date(client.admissionDate),
                    type: 'admission',
                    title: 'Admitted',
                    description: `${client.initials} admitted to ${client.houseId || 'facility'}`
                });
            }
            
            // Add tracking events
            const trackingEvents = [
                { field: 'needsAssessmentDate', title: 'Needs Assessment Completed' },
                { field: 'healthPhysicalDate', title: 'Health & Physical Assessment Completed' },
                { field: 'aftercareThreadDate', title: 'Aftercare Planning Thread Sent' },
                { field: 'optionsDocDate', title: 'Options Document Uploaded' },
                { field: 'dischargePacketDate', title: 'Discharge Packet Uploaded' }
            ];
            
            trackingEvents.forEach(event => {
                if (client[event.field]) {
                    events.push({
                        date: new Date(client[event.field]),
                        type: 'tracking',
                        title: event.title
                    });
                }
            });
            
            // Add discharge event
            if (client.dischargeDate) {
                events.push({
                    date: new Date(client.dischargeDate),
                    type: 'discharge',
                    title: 'Discharged',
                    description: `After ${daysInCare} days in care`
                });
            }
            
            // Sort events by date
            events.sort((a, b) => a.date - b.date);
            
            // Build timeline HTML
            return `
                <div class="timeline">
                    ${events.map((event, index) => `
                        <div class="timeline-event ${event.type}">
                            <div class="timeline-date">${event.date.toLocaleDateString()}</div>
                            <div class="timeline-content">
                                <h4>${event.title}</h4>
                                ${event.description ? `<p>${event.description}</p>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Add aftercare option
        async function addAftercareOption(clientId) {
            // Get programs for selection
            const programs = JSON.parse(localStorage.getItem('therapyPrograms') || '[]');
            
            let programOptions = programs.map(p => 
                `<option value="${p.name}">${p.name}</option>`
            ).join('');
            
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal-content" style="width: 500px;">
                        <h3>Add Aftercare Option</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Program Name</label>
                            <select id="programSelect" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <option value="">Select a program...</option>
                                ${programOptions}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Status</label>
                            <select id="optionStatus" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <option value="pending">Pending</option>
                                <option value="sent">Sent to Family</option>
                                <option value="engaged">Family Engaged</option>
                                <option value="accepted">Accepted</option>
                                <option value="declined">Declined</option>
                                <option value="waitlist">Waitlist</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Date Provided to Family</label>
                            <input type="date" id="dateProvided" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Notes</label>
                            <textarea id="optionNotes" style="width: 100%; height: 80px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeModal()" style="padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="handleAddAftercareOption('${clientId}')" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Add Option
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add keyboard listener for ESC key
            document.addEventListener('keydown', handleModalKeydown);
            
            // Fix overlay click handling
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeModal();
                    }
                });
            }
        }
        
        // Handle add aftercare option
        async function handleAddAftercareOption(clientId) {
            try {
                const programName = document.getElementById('programSelect').value;
                const status = document.getElementById('optionStatus').value;
                const dateProvided = document.getElementById('dateProvided').value;
                const notes = document.getElementById('optionNotes').value;
                
                if (!programName) {
                    showAlert('Please select a program', 'error');
                    return;
                }
                
                await aftercareManager.addAftercareOption(clientId, {
                    programName,
                    status,
                    dateProvidedToFamily: dateProvided,
                    notes
                });
                
                showAlert('Aftercare option added successfully', 'success');
                closeModal();
                
                // Refresh the client details
                viewClientDetails(clientId);
                
                // Refresh the table
                await loadHouseView(currentHouseId);
            } catch (error) {
                console.error('Failed to add aftercare option:', error);
                showAlert(error.message || 'Failed to add aftercare option', 'error');
            }
        }
        
        // Edit client
        function editClient(clientId) {
            // This will be implemented
            console.log('Edit client:', clientId);
        }
        
        // Generate document for client
        async function generateClientDocument(clientId, options = {}) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    showAlert('Client not found', 'error');
                    return;
                }

                const contextPayload = {
                    clientId,
                    initials: client.initials || '',
                    kipuId: client.kipuId || null
                };

                window.__pendingProgramsDocsClientContext = contextPayload;

                await mountProgramsDocsModule();

                if (window.CareConnectProgramsDocs?.setClientContext) {
                    await window.CareConnectProgramsDocs.setClientContext(contextPayload);
                }

                window.__pendingProgramsDocsClientContext = null;

                if (window.clientManager?.setCurrentClient) {
                    await window.clientManager.setCurrentClient(clientId);
                }

                sessionStorage.setItem('currentClientId', clientId);
                switchTab('programs');

                if (options.focusSearch && window.CareConnectProgramsDocs?.focusSearch) {
                    window.CareConnectProgramsDocs.focusSearch();
                }

                if (window.CareConnect?.events) {
                    try {
                        window.CareConnect.events.emit('clients:programs-docs-opened', {
                            clientId,
                            initials: client.initials || ''
                        });
                    } catch (eventError) {
                        console.warn('Programs docs open event failed:', eventError);
                    }
                }

                showAlert(`Programs workspace ready for ${client.initials || 'client'}.`, 'success');
            } catch (error) {
                console.error('Failed to open Programs & Docs for client:', error);
                showAlert('Unable to open Programs & Docs. Please try again.', 'error');
            }
        }
        
        // Export current house
        async function exportCurrentHouse() {
            try {
                const houseData = await housesManager.exportHouseData(currentHouseId);
                const json = JSON.stringify(houseData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${houseData.house.name}_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showAlert('House data exported successfully!', 'success');
            } catch (error) {
                showAlert('Failed to export house data: ' + error.message, 'error');
            }
        }
        
        // Export all data
        function exportAllData() {
            // To be implemented with Excel export
            showAlert('Excel export will be implemented with the Excel export module', 'info');
        }
        
        // Show bulk import
        function showBulkImport() {
            // To be implemented with Excel import
            showAlert('Excel import will be implemented with the Excel import module', 'info');
        }
        
        // Show reports
        function showReports() {
            // To be implemented with reporting module
            showAlert('Reports will be implemented with the reporting module', 'info');
        }
        
        // Toggle milestone completion
        async function toggleMilestone(clientId, milestoneId) {
            try {
                await milestonesManager.toggleMilestone(clientId, milestoneId);
                await loadHouseView(currentHouseId); // Refresh the view
            } catch (error) {
                console.error('Failed to toggle milestone:', error);
                showAlert('Failed to update milestone', 'error');
            }
        }
        
        // Reset database
        async function resetDatabase() {
            if (confirm('This will clear all local data and reload the page. Continue?')) {
                try {
                    await clearIndexedDB();
                    localStorage.clear();
                    sessionStorage.clear();
                    showAlert('Database cleared. Reloading...', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } catch (error) {
                    showAlert('Failed to reset database: ' + error.message, 'error');
                }
            }
        }
    </script>
    
    <!-- Initialize Service Worker -->
    <script>
        // Function to clear IndexedDB if needed
        async function clearIndexedDB() {
            try {
                await indexedDB.deleteDatabase('CareConnectPro');
                console.log('Database cleared successfully');
                return true;
            } catch (error) {
                console.error('Failed to clear database:', error);
                return false;
            }
        }

        // Auto-login DISABLED - Show login screen
        // if (!sessionStorage.getItem('isLoggedIn')) {
        //     console.log('Auto-setting login credentials...');
        //     sessionStorage.setItem('isLoggedIn', 'true');
        //     sessionStorage.setItem('username', 'MasterAdmin');
        //     sessionStorage.setItem('userRole', 'admin');
        // }



        // Robust login handler
        (function() {
            function initLogin() {
                const forms = document.querySelectorAll('form');
                forms.forEach(form => {
                    const hasPassword = form.querySelector('input[type="password"]');
                    const hasUsername = form.querySelector('input[type="text"], input[name="username"]');
                    
                    if (hasPassword && hasUsername) {
                        // This is the login form
                        form.onsubmit = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const username = hasUsername.value;
                            const password = hasPassword.value;
                            
                            // Validate credentials - DISABLED (use proper handleLogin function)
                            // if ((username === 'MasterAdmin' || username === 'Doc121') && password === 'FFA121') {
                            //     sessionStorage.setItem('isLoggedIn', 'true');
                            //     sessionStorage.setItem('username', username);
                            //     sessionStorage.setItem('userRole', username === 'MasterAdmin' ? 'admin' : 'user');
                            //     location.reload();
                            // } else {
                            //     alert('Invalid username or password');
                            // }
                            
                            // Use the proper handleLogin function instead
                            if (typeof handleLogin === 'function') {
                                const event = { preventDefault: () => {}, target: form };
                                handleLogin(event);
                            } else {
                                alert('Login system not loaded. Please refresh the page.');
                            }
                            
                            return false;
                        };
                        
                        // Also handle button click
                        const submitBtn = form.querySelector('button[type="submit"], button.sign-in-btn, input[type="submit"]');
                        if (submitBtn) {
                            submitBtn.onclick = function(e) {
                                e.preventDefault();
                                form.onsubmit(e);
                                return false;
                            };
                        }
                    }
                });
            }
            
            // Initialize on multiple events to ensure it runs
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLogin);
            } else {
                initLogin();
            }
            
            // Also try on window load as backup
            window.addEventListener('load', initLogin);
        })();


        // Fix login form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Find the login form
            const loginForm = document.querySelector('form');
            if (loginForm && loginForm.querySelector('input[type="password"]')) {
                // Prevent default form submission
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get username and password
                    const username = document.querySelector('input[type="text"]').value;
                    const password = document.querySelector('input[type="password"]').value;
                    
                    // Call the login function
                    if (typeof handleLogin === 'function') {
                        handleLogin(username, password);
                    } else {
                        // Fallback login handling - DISABLED (use proper handleLogin function)
                        alert('Login system not loaded. Please refresh the page and try again.');
                    }
                    
                    return false;
                });
                
                // Also handle button click
                const signInButton = loginForm.querySelector('button[type="submit"]') || 
                                   loginForm.querySelector('.sign-in-btn') ||
                                   loginForm.querySelector('button');
                
                if (signInButton) {
                    signInButton.onclick = function(e) {
                        e.preventDefault();
                        loginForm.dispatchEvent(new Event('submit'));
                        return false;
                    };
                }
            }
        });

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js")
                .then(reg => console.log("Service Worker registered:", reg.scope))
                .catch(err => console.log("Service Worker registration failed:", err));
        }
    </script>
    
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Family First Adolescent Services - Document Creation Tool">
    <meta name="theme-color" content="#0099cc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FFAS Docs">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232196a6'/%3E%3Cpath d='M 20 15 Q 32 12 44 15 L 40 22 Q 32 20 24 22 Q 18 28 18 38 L 26 38 Q 26 32 29 29 Q 32 27 37 28 L 35 33 Q 32 32 30 33 Q 28 35 28 38 L 36 38 Q 36 35 37 33 Q 40 32 44 33 L 42 38 Q 38 37 37 38 Q 36 40 36 45 L 29 45 Q 29 42 26 42 L 18 45 Q 15 32 22 22 Q 26 18 32 15' fill='white'/%3E%3C/svg%3E">
    
    <style>
        /* Modern UI Enhancement Styles - Override Existing */
        
        /* Beautiful Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Override Program Cards for Better Look */
        .program-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%) !important;
            padding: 24px !important;
            border-radius: 16px !important;
            border: 2px solid transparent !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08) !important;
            animation: fadeIn 0.5s ease;
        }
        
        .program-card:hover {
            transform: translateY(-6px) scale(1.02) !important;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.18) !important;
            border-color: #667eea !important;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%) !important;
        }
        
        .program-card.selected {
            background: linear-gradient(135deg, #f0f4ff, #e5edff) !important;
            border: 2px solid #667eea !important;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.28) !important;
            transform: scale(1.02) !important;
        }
        
        /* Beautiful Buttons */
        .btn-primary, button[onclick*="generate"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 14px 28px !important;
            border: none !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            font-size: 15px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .btn-primary:hover, button[onclick*="generate"]:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.45) !important;
        }
        
        .btn-primary:active, button[onclick*="generate"]:active {
            transform: translateY(-1px) !important;
        }
        
        /* Modern Modal Overlay */
        .modal {
            background-color: rgba(0,0,0,0.7) !important;
            backdrop-filter: blur(10px) !important;
            animation: modalFadeIn 0.3s ease !important;
        }
        
        .modal-content {
            border-radius: 20px !important;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3) !important;
            animation: modalSlideIn 0.3s ease !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 25px 30px !important;
            border-radius: 20px 20px 0 0 !important;
        }
        
        .modal-header h2 {
            color: white !important;
            font-weight: 600 !important;
            font-size: 24px !important;
        }
        
        /* Input Field Styling */
        input[type="text"], input[type="email"], input[type="password"], textarea, select {
            padding: 12px 16px !important;
            border-radius: 10px !important;
            border: 2px solid #e5e7eb !important;
            font-size: 15px !important;
            transition: all 0.3s ease !important;
            background: white !important;
        }
        
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            border-color: #667eea !important;
            outline: none !important;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1) !important;
        }
        
        /* Checkbox and Radio Styling */
        input[type="checkbox"], input[type="radio"] {
            width: 20px !important;
            height: 20px !important;
            cursor: pointer !important;
            accent-color: #667eea !important;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46a2);
        }
        
        /* Loading Animation */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        /* Smooth Transitions for All Interactive Elements */
        button, a, input, textarea, select, .card, .panel {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        /* Responsive Design Improvements */
        @media screen and (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }
            
        .main-content {
                flex-direction: column;
            }
            
            .selection-panel {
                width: 100%;
                max-width: 100%;
                border-left: none;
                border-top: 2px solid #e5e7eb;
                margin-top: 20px;
                position: relative;
                top: 0;
            }
            
            .programs-panel {
                max-height: none;
            }
        }
        
        @media screen and (max-width: 768px) {
            .header {
                padding: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 24px !important;
            }
            
            .program-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 95vh;
            }
            
            .wizard-steps {
                gap: 8px;
            }
            
            .wizard-step-indicator {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .btn-primary, button[onclick*="generate"] {
                padding: 12px 20px !important;
                font-size: 14px !important;
            }
            
            .doc-type-buttons {
                flex-direction: column;
            }
            
            .doc-type-btn {
                width: 100%;
            }
        }
        
        @media screen and (max-width: 480px) {
            .programs-panel, .selection-panel {
                padding: 15px;
            }
            
            .program-card {
                padding: 16px !important;
            }
            
            input[type="text"], textarea, select {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            .modal-header {
                padding: 20px !important;
            }
            
            .modal-header h2 {
                font-size: 20px !important;
            }
            
            .wizard-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .wizard-actions button {
                width: 100%;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white !important;
            }
            
            .theme-toggle, .modal, button {
                display: none !important;
            }
            
            .container {
                box-shadow: none !important;
                max-width: 100% !important;
            }
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .program-card {
                border: 3px solid #000 !important;
            }
            
            .btn-primary {
                border: 2px solid #000 !important;
            }
            
            input, textarea, select {
                border: 2px solid #000 !important;
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Additional Polish */
        .guided-btn {
            background: linear-gradient(135deg, #34d399, #059669) !important;
            color: white !important;
            font-weight: 600 !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 14px 24px !important;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .guided-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 10px 28px rgba(5, 150, 105, 0.4) !important;
        }
        
        .wizard-back {
            background: #e5e7eb !important;
            color: #374151 !important;
        }
        
        .wizard-back:hover {
            background: #d1d5db !important;
        }
        
        .wizard-next {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: white !important;
        }
        
        .wizard-next:hover {
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4) !important;
        }
        
        .wizard-finish {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
        }
        
        .wizard-finish:hover {
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4) !important;
        }
        
        /* Fix overlapping elements */
        .selection-panel {
            z-index: 10;
            visibility: visible !important;
        }

        .parent-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04) !important;
            margin-bottom: 24px !important;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .parent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .parent-card:hover {
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.12) !important;
            transform: translateY(-4px);
            border-color: #cbd5e1 !important;
        }
        
        .parent-card:hover::before {
            transform: scaleX(1);
        }

        .parent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .parent-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .org-badge {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .expand-icon {
            font-size: 14px;
            color: #1d4ed8;
            transition: transform 0.2s ease;
        }

        .parent-expand-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: rgba(59, 130, 246, 0.08);
            color: #1d4ed8;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .parent-expand-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.35);
        }

        .parent-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .parent-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 13px;
            color: #475569;
            margin-bottom: 10px;
        }
        
        .parent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }
        
        .parent-tag {
            background: rgba(59, 130, 246, 0.08);
            color: #3b82f6;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(59, 130, 246, 0.15);
        }
        
        .parent-stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            font-size: 13px;
            color: #64748b;
        }
        
        .parent-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .parent-stat-icon {
            color: #3b82f6;
            font-weight: bold;
        }
        
        /* Interactive Profile Modal - Enhanced */
        .program-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            z-index: 10000;
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .program-profile-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .profile-container {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 100px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            animation: modalSlideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center bottom;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 32px 40px;
            position: relative;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15);
        }
        
        .profile-navigation {
            position: absolute;
            top: 24px;
            left: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .profile-back-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .profile-back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(-2px);
        }
        
        .profile-breadcrumb {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .profile-close {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05) rotate(90deg);
        }
        
        .profile-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 50px;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
        }
        
        .profile-subtitle {
            font-size: 16px;
            opacity: 0.95;
            display: flex;
            gap: 20px;
            align-items: center;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;
        }
        
        .profile-body {
            padding: 40px;
            overflow-y: auto;
            flex: 1;
            background: linear-gradient(to bottom, #ffffff 0%, #fafbfc 100%);
        }
        
        .profile-section {
            margin-bottom: 40px;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both;
        }
        
        .profile-section-title {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid transparent;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }
        
        .profile-section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 2px;
            animation: slideInLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.4s both;
        }
        
        .profile-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        }
        
        .profile-info-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .profile-info-item:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .profile-info-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        .profile-info-value {
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
        }
        
        .profile-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }
        
        .profile-feature {
            padding: 18px 20px;
            background: white;
            border-left: 4px solid transparent;
            background: linear-gradient(to right, white, white),
                        linear-gradient(135deg, #6366f1, #8b5cf6);
            background-clip: padding-box, border-box;
            background-origin: border-box;
            border: 1px solid transparent;
            border-left-width: 4px;
            border-radius: 12px;
            font-size: 15px;
            color: #334155;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        
        .profile-feature:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
        }

        .profile-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .profile-tag {
            background: rgba(59, 130, 246, 0.12);
            color: #1d4ed8;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .profile-overview-text {
            font-size: 15px;
            color: #1f2937;
            line-height: 1.6;
            background: #f8fafc;
            border-radius: 10px;
            padding: 16px 18px;
        }

        .profile-subprogram-section {
            margin-top: 10px;
        }

        .profile-subprogram-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .profile-subprogram-item {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .profile-subprogram-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-subprogram-item:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.1);
            border-color: #cbd5e1;
        }
        
        .profile-subprogram-item:hover::before {
            transform: scaleY(1);
        }

        .profile-subprogram-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .profile-subprogram-meta {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .profile-subprogram-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .profile-subprogram-actions button {
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }

        .profile-view-btn {
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
        }

        .profile-add-btn-inline {
            background: #10b981;
            color: white;
        }

        .profile-add-btn-inline.selected {
            background: #ef4444;
        }
        
        /* Loading state */
        .profile-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        .profile-loading.active {
            display: block;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .profile-container {
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
            }
            
            .profile-header {
                padding: 24px;
            }
            
            .profile-body {
                padding: 24px;
            }
            
            .profile-title {
                font-size: 24px;
            }
            
            .profile-features {
                grid-template-columns: 1fr;
            }
            
            .profile-info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .profile-actions {
            padding: 20px 30px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .profile-add-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 14px 36px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .profile-add-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .profile-add-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }
        
        .profile-add-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .profile-add-btn.added {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .profile-contact-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .profile-contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .profile-contact-icon {
            color: #667eea;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideUp {
            from { 
                transform: translateY(40px) scale(0.95);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                width: 0;
                opacity: 0;
            }
            to {
                width: 60px;
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .parent-overview {
            font-size: 14px;
            color: #334155;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .parent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .parent-tag {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .sub-programs-container {
            margin-top: 16px;
            display: grid;
            gap: 12px;
        }

        .sub-program-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .sub-program-card:hover {
            border-color: #2563eb;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.15);
        }

        .sub-program-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .sub-program-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .sub-program-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .sub-program-info {
            font-size: 13px;
            color: #475569;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .sub-program-badge {
            background: #f1f5f9;
            color: #0f172a;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .sub-program-features {
            margin: 0;
            padding-left: 18px;
            font-size: 12px;
            color: #4b5563;
        }

        .sub-program-features li {
            margin-bottom: 4px;
        }

        .sub-program-toggle {
            border: 1px solid #bfdbfe;
            background: #e0f2fe;
            color: #1d4ed8;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sub-program-toggle:hover {
            border-color: #2563eb;
            background: #dbeafe;
        }

        .sub-program-toggle.selected {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }

        .programs-panel {
            z-index: 5;
        }

        .header {
            z-index: 20;
        }
        
        /* Ensure text is readable */
        h1, h2, h3, h4, h5, h6 {
            line-height: 1.4;
            margin-bottom: 0.5em;
        }
        
        p {
            line-height: 1.6;
            margin-bottom: 1em;
        }
        
        /* Better focus states */
        a:focus, button:focus, input:focus, textarea:focus, select:focus {
            outline: 3px solid rgba(102, 126, 234, 0.5) !important;
            outline-offset: 2px;
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.95) 0%, rgba(147, 51, 234, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            animation: fadeIn 0.3s ease;
        }
        
        .loading-spinner {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 0 100px rgba(147, 51, 234, 0.3);
            min-width: 400px;
            max-width: 500px;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Modern Circular Progress */
        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 25px;
        }
        
        .progress-ring-circle {
            fill: transparent;
            stroke: #e5e7eb;
            stroke-width: 8;
        }
        
        .progress-ring-circle-progress {
            fill: transparent;
            stroke: url(#gradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
            transition: stroke-dashoffset 0.35s;
        }
        
        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Status Text */
        .loading-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .loading-status {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
            min-height: 40px;
        }
        
        .status-detail {
            font-size: 12px;
            color: #9ca3af;
            font-style: italic;
            margin-top: 4px;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Steps Indicator */
        .loading-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .loading-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .loading-step::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .loading-step.active::before {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }
        
        .loading-step.completed::before {
            background: #10b981;
        }
        
        .loading-step-label {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .loading-step.active .loading-step-label {
            color: #4f46e5;
            font-weight: 600;
        }
        
        /* Beautiful Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .notification-message {
            font-size: 14px;
            opacity: 0.95;
        }
        
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.5);
            animation: notificationProgress 3s linear;
        }
        
        @keyframes notificationProgress {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        /* Old spinner for backwards compatibility */
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0099cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    

        /* Enhanced Features CSS */
        .client-switcher {
            margin-bottom: 20px;
        }
        
        .natural-language-search {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .natural-language-search:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .filter-suggestions {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .smart-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .smart-preset {
            padding: 6px 12px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .smart-preset:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .match-score {
            display: inline-block;
            padding: 2px 8px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .data-quality-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }
        
        .data-quality-high { background: #10b981; }
        .data-quality-medium { background: #f59e0b; }
        .data-quality-low { background: #ef4444; }

    

        /* Map System Styles */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        .leaflet-popup-content {
            margin: 12px !important;
        }
        
        .program-marker {
            transition: transform 0.2s;
        }
        
        .program-marker:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        
        /* Custom map controls */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        .leaflet-control-zoom a {
            background: white !important;
            color: #374151 !important;
            border: none !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: #f3f4f6 !important;
        }
    </style>
    <style>
        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex !important;
            gap: 8px;
            margin-bottom: 20px;
            visibility: visible !important;
            padding: 0;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px 8px 0 0;
            padding: 8px 12px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tab-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .tab-btn.active {
            background: #6366f1;
            color: white;
            font-weight: 600;
        }
        
        .tab-btn.active:hover {
            background: #4f46e5;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Hide selection panel when dashboard is active */
        #dashboardTab.active ~ * .selection-panel,
        #dashboardTab.active ~ .selection-panel,
        body:has(#dashboardTab.active) .selection-panel,
        body:has(#dashboardTab.active) [class*="selection-panel"],
        body:has(#dashboardTab.active) aside:has-text("GENERATE DOCUMENT"),
        #dashboardTab.active ~ * aside {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Ensure dashboard gets full width */
        body:has(#dashboardTab.active) .main-content {
            grid-template-columns: 1fr !important;
        }
        
        /* Dashboard Styles */
        .dashboard-container {
            padding: 20px;
            background: #f9fafb;
            min-height: calc(100vh - 200px);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .dashboard-greeting {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
        }
        
        .dashboard-subtitle {
            font-size: 16px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .dashboard-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .view-toggle {
            display: flex;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .view-toggle button {
            padding: 8px 16px;
            border: none;
            background: white;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle button.active {
            background: #6366f1;
            color: white;
        }
        
        .dashboard-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Widget base styles */
        .dashboard-widget {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .widget-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .widget-skeleton {
            height: 200px;
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Priority zones */
        .priority-zones {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .priority-zone {
            background: #f9fafb;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .zone-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
        }
        
        .zone-header:hover {
            background: #f3f4f6;
        }
        
        .zone-icon {
            font-size: 18px;
            margin-right: 12px;
        }
        
        .zone-title {
            flex: 1;
            font-weight: 500;
            color: #374151;
        }
        
        .zone-count {
            background: #374151;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .zone-red .zone-count { background: #ef4444; }
        .zone-purple .zone-count { background: #8b5cf6; }
        .zone-yellow .zone-count { background: #f59e0b; }
        .zone-green .zone-count { background: #10b981; }
        
        .zone-toggle {
            color: #6b7280;
            font-size: 12px;
        }
        
        .zone-content {
            padding: 0 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .zone-content.expanded {
            max-height: 500px;
            padding-bottom: 16px;
        }
        
        .priority-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .client-badge {
            display: inline-block;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            width: fit-content;
        }
        
        .item-message {
            font-size: 14px;
            color: #111827;
        }
        
        .due-date {
            font-size: 12px;
            color: #6b7280;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-action, .btn-quick-complete {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-action {
            background: #6366f1;
            color: white;
        }
        
        .btn-action:hover {
            background: #4f46e5;
        }
        
        .btn-quick-complete {
            background: white;
            color: #10b981;
            border: 1px solid #10b981;
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-quick-complete:hover {
            background: #10b981;
            color: white;
        }
        
        /* House weather cards */
        .house-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .house-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .house-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .house-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .weather-icon {
            font-size: 24px;
        }
        
        .house-name {
            font-weight: 600;
            color: #111827;
            flex: 1;
        }
        
        .trend {
            font-size: 14px;
            font-weight: 600;
        }
        
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #6b7280; }
        
        .house-score {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .score-value {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
        }
        
        .score-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        .house-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .client-count {
            color: #6b7280;
        }
        
        .issue-count {
            color: #ef4444;
            font-weight: 500;
            cursor: pointer;
        }
        
        .no-issues {
            color: #10b981;
            font-weight: 500;
        }
        
        /* Journey radar */
        .journey-timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .journey-segment {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .journey-segment.has-clients:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .segment-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .segment-count {
            font-size: 24px;
            font-weight: 600;
        }
        
        .segment-green { color: #10b981; }
        .segment-yellow { color: #f59e0b; }
        .segment-orange { color: #f97316; }
        .segment-red { color: #ef4444; }
        .segment-purple { color: #8b5cf6; }
        
        .segment-connector {
            color: #d1d5db;
            font-size: 20px;
        }
        
        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        .metric-item {
            text-align: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .metric-label {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .metric-detail {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .trend-indicator {
            font-size: 16px;
            font-weight: 600;
        }
        
        .trend-positive { color: #10b981; }
        .trend-negative { color: #ef4444; }
        
        /* Quick actions */
        .actions-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: #f9fafb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .action-icon {
            font-size: 20px;
        }
        
        .action-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* Responsive design */
        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        @media (min-width: 1280px) {
            .dashboard-grid {
                grid-template-columns: 3fr 2fr;
            }
        }
    </style>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
            background: #f5f6ff;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0.85;
            z-index: -1;
        }

        .container {
            max-width: 1320px;
            margin: 40px auto 60px;
            padding: 26px;
            background: white;
            min-height: calc(100vh - 100px);
            border-radius: 28px;
            box-shadow: 0 25px 60px rgba(102, 126, 234, 0.25);
            overflow: hidden;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .header {
            background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 15px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 153, 204, 0.25);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .demo-btn.active {
            background: #fbbf24;
            color: #1f2937;
            border-color: #f59e0b;
        }
        
        .demo-btn.active:hover {
            background: #f59e0b;
        }
        
        .demo-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #fbbf24;
            color: #1f2937;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
            z-index: 10000;
            display: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
            }
            50% {
                box-shadow: 0 4px 20px rgba(251, 191, 36, 0.8);
            }
            100% {
                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
            }
        }

        .main-content {
            display: grid !important;
            grid-template-columns: 1fr 440px; /* left: programs, right: controls */
            gap: 20px;
            min-height: 600px;
            position: relative;
            align-items: start;
            visibility: visible !important;
        }
        
        /* Dashboard-specific layout override */
        .dashboard-active .main-content {
            display: block !important;
            grid-template-columns: none !important;
        }
        
        .dashboard-active .selection-panel {
            display: none !important;
        }
        
        .dashboard-active .programs-panel {
            max-width: 100% !important;
            width: 100% !important;
        }
        
        .programs-panel {
            padding: 30px;
            overflow-y: auto;
            background: #ffffff;
            max-height: 85vh;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 1;
        }
        
        .selection-panel {
            width: 440px;
            min-width: 440px;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 20px;
            display: none; /* Hidden by default - only show for Programs tab */
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 12px;
            position: sticky;
            top: 10px;
            height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 10;
        }
        
        .document-type-selector {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .doc-type-buttons {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .doc-type-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #0099cc;
            background: white;
            color: #0099cc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .doc-type-btn.active {
            background: #0099cc;
            color: white;
        }

        .guided-btn {
            width: 100%;
            margin-bottom: 20px;
            padding: 12px 18px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #34d399, #059669);
            color: white;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .guided-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(5, 150, 105, 0.35);
        }

        .guided-btn:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .wizard-actions button {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .wizard-actions .wizard-back {
            background: #e5e7eb;
            color: #374151;
        }

        .wizard-actions .wizard-next {
            background: #4f46e5;
            color: white;
        }

        .wizard-actions .wizard-finish {
            background: #059669;
            color: white;
        }

        .wizard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .wizard-card {
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.08);
        }

        .wizard-program-list {
            display: grid;
            gap: 10px;
            max-height: 260px;
            overflow-y: auto;
        }

        .wizard-program-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
            transition: border-color 0.2s ease;
        }

        .wizard-program-item input[type="checkbox"] {
            margin-top: 4px;
            transform: scale(1.1);
        }

        .wizard-program-item.active {
            border-color: #4f46e5;
            box-shadow: 0 4px 14px rgba(79, 70, 229, 0.18);
            background: #eef2ff;
        }

        .wizard-program-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .wizard-program-meta .name {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-program-meta .location {
            font-size: 12px;
            color: #4b5563;
        }

        .wizard-program-meta .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .wizard-program-meta .chip {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .wizard-toggles {
            display: grid;
            gap: 10px;
        }

        .wizard-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
        }

        .wizard-toggle span {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-note {
            font-size: 13px;
            color: #4b5563;
            background: #ecfeff;
            border-left: 4px solid #0891b2;
            padding: 12px 14px;
            border-radius: 8px;
        }

        .wizard-no-results {
            text-align: center;
            padding: 30px 20px;
            color: #6b7280;
            font-size: 14px;
            border: 1px dashed #cbd5f5;
            border-radius: 10px;
            background: #f8fafc;
        }

        .input-error {
            border-color: #f87171 !important;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2) !important;
        }

        .document-preview-modal {
            max-width: 95%;
            width: 900px;
        }

        /* Document preview container - clean and simple */
        #documentPreviewContainer {
            background: white;
            margin: 0 auto;
            padding: 40px 60px;
            box-sizing: border-box;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        /* Ensure all document styles apply in preview */
        #documentPreviewContainer .doc-page {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        #documentPreviewContainer .doc-content {
            padding-bottom: 40px;
        }
        
        #documentPreviewContainer .doc-footer {
            position: relative;
            bottom: auto;
            margin-top: 40px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media screen and (max-width: 900px) {
            #documentPreviewContainer {
                padding: 20px 30px;
            }
        }
        
        .client-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .client-info h3 {
            color: #0c4a6e;
            margin-bottom: 14px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .client-info input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            margin-bottom: 0;
            font-family: -apple-system, 'Calibri', Arial, sans-serif;
            font-size: 15px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .client-info input:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        /* Checkbox specific styles */
        #includeAtHome {
            accent-color: #0099cc;
            transform: scale(1.1);
            margin-right: 2px;
        }
        
        #includeAtHome:hover {
            transform: scale(1.2);
        }
        
        .search-container {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
        }
        
        .search-box {
            width: 100%;
            padding: 14px 18px;
            padding-right: 120px; /* Space for button */
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        .search-indicator {
            display: none;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .add-program-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            background: linear-gradient(45deg, #0099cc, #00b4d8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 153, 204, 0.3);
            z-index: 10;
        }
        
        .add-program-btn.show {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .add-program-btn:hover {
            background: linear-gradient(45deg, #0088bb, #00a3c7);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 153, 204, 0.4);
        }
        
        .add-program-btn:active {
            transform: translateY(-50%) scale(0.98);
        }
        
        .search-animation {
            animation: searchPulse 2s infinite;
        }
        
        @keyframes searchPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .add-animation {
            animation: addSuccess 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes addSuccess {
            0% { transform: translateY(-50%) scale(1); }
            20% { transform: translateY(-50%) scale(1.2) rotate(5deg); }
            40% { transform: translateY(-50%) scale(0.9) rotate(-3deg); }
            60% { transform: translateY(-50%) scale(1.1) rotate(2deg); }
            80% { transform: translateY(-50%) scale(0.95) rotate(-1deg); }
            100% { transform: translateY(-50%) scale(1) rotate(0deg); }
        }
        
        .filter-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .filter-btn:hover {
            border-color: #0099cc;
            color: #0099cc;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .filter-btn.active {
            background: #0099cc;
            color: white;
            border-color: #0099cc;
            box-shadow: 0 2px 8px rgba(0,153,204,0.2);
        }
        
        .program-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            padding: 0;
            margin-top: 15px;
        }
        
        .program-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .program-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #cbd5e1;
        }
        
        .program-card.primary {
            border-color: #0099cc;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            box-shadow: 0 4px 12px rgba(0,153,204,0.15);
        }
        
        .program-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            background: #0099cc;
        }
        
        .program-name {
            font-weight: bold;
            font-size: 15px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .program-location {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .program-type {
            display: inline-block;
            padding: 2px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            margin-top: 5px;
        }
        
        .program-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #0099cc;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            z-index: 2;
            transition: all 0.3s;
        }
        
        .program-info-btn:hover {
            background: #0077aa;
            transform: scale(1.1);
        }
        
        .selected-section {
            flex: 0 1 auto;
            min-height: 120px;
            margin-bottom: 10px;
        }
        
        .section-title {
            font-weight: 600;
            margin: 20px 0 16px 0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            color: #1e40af;
            border-left: 4px solid #0099cc;
        }
        
        .selected-program {
            background: white;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            font-size: 13px;
            cursor: move;
            transition: all 0.3s;
        }
        
        .selected-program.dragging {
            opacity: 0.5;
            background: #f0f8ff;
        }
        
        .selected-program.drag-over {
            border-top: 3px solid #0099cc;
        }
        
        .drag-handle {
            cursor: move;
            color: #999;
            margin-right: 8px;
            font-size: 16px;
        }
        
        .program-order-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .order-btn {
            background: #0099cc;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .order-btn:hover {
            background: #0077aa;
        }
        
        .order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #0099cc, #0077aa);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,153,204,0.3);
            width: 100%;
            letter-spacing: 0.5px;
            min-height: 44px;
            max-height: 44px;
        }
        
        .generate-btn:hover {
            background: linear-gradient(135deg, #0077aa, #005588);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,153,204,0.4);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        
        .generate-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .instructions {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
            border: 1px solid #fbbf24;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(251,191,36,0.1);
        }
        
        .instructions h3 {
            color: #92400e;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .instructions ul {
            margin-left: 20px;
            color: #78350f;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .instructions ul li {
            margin-bottom: 6px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 15px;
            font-style: italic;
            font-size: 13px;
        }
        
        #selectedList {
            min-height: 80px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 10px;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border-bottom: 1px solid #2a2a3e;
        }

        body.dark-mode .panel {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .program-card {
            background: #252538;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .program-card:hover {
            background: #2a2a3e;
            border-color: #4a4a5e;
        }

        body.dark-mode .program-card.selected {
            background: #2a3f5f;
            border-color: #3498db;
        }

        body.dark-mode input[type="text"],
        body.dark-mode select {
            background: #252538;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        body.dark-mode .modal-content {
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 50px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        body.dark-mode .theme-toggle {
            background: #252538;
            border-color: #3a3a4e;
            color: #e0e0e0;
        }

        /* Comparison View Styles */
        .comparison-view {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            overflow: hidden;
        }

        .comparison-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-content {
            display: flex;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .comparison-column {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #ddd;
        }

        .comparison-column:last-child {
            border-right: none;
        }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .quick-action-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        body.dark-mode .quick-action-btn {
            background: #252538;
            border-color: #3a3a4e;
            color: #e0e0e0;
        }

        body.dark-mode .quick-action-btn:hover {
            background: #2a2a3e;
        }

        /* Document History Panel */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        
        .history-panel.active {
            display: block;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .history-item:hover {
            background: #f5f5f5;
        }

        body.dark-mode .history-panel {
            background: #1a1a2e;
        }

        body.dark-mode .history-item {
            border-bottom-color: #2a2a3e;
        }

        body.dark-mode .history-item:hover {
            background: #252538;
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .analytics-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .analytics-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 80%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: #0099cc;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            position: relative;
            z-index: 1001;
            padding: 5px;
            line-height: 1;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            color: #f0f0f0;
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            min-height: 0; /* Important for flex children */
        }
        
        .preview-section {
            margin-bottom: 20px;
        }
        
        .preview-section h3 {
            color: #0099cc;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        
        .preview-features {
            list-style: none;
            padding: 0;
        }
        
        .preview-features li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .preview-features li strong {
            color: #333;
        }
        
        .preview-contact {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        
        .preview-contact div {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .modal-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .add-from-preview {
            background: #0099cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-from-preview:hover {
            background: #0077aa;
        }
        
        .add-from-preview.selected {
            background: #dc3545;
        }
        
        /* Print Styles - Professional Clean Document */
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .main-content { flex-direction: column; }
            .programs-panel, .selection-panel { width: 100%; max-width: 100%; }
            .program-grid { grid-template-columns: 1fr; }
            .filter-buttons, .quick-actions { flex-wrap: wrap; }
            .theme-toggle { top: 10px; right: 10px; }
            .history-panel { width: 100%; }
            .comparison-view { width: 95%; }
            .comparison-content { flex-direction: column; }
        }
        
        @media print {
            @page {
                size: letter;
                margin: 1in 0.75in 1in 0.75in; /* Top, Right, Bottom, Left - content width ~6.5" */
            }
            
            /* Hide ALL UI elements during print */
            .theme-toggle,
            .history-panel,
            .comparison-view,
            .analytics-dashboard,
            .container,
            .modal,
            .quick-actions,
            #historyPanel,
            #comparisonView,
            #analyticsDashboard {
                display: none !important;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .container {
                display: none !important;
            }
            
            .document-output {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                color: black;
                font-family: Helvetica, Arial, "Segoe UI", sans-serif;
                font-size: 11pt;
                line-height: 1.6;
            }
            
            .doc-page {
                position: relative;
                width: 100%;
                padding: 0;
                page-break-inside: avoid;
                overflow: visible; /* ensure header image not clipped */
            }
            
            /* Hide web elements completely */
            .modal, .program-info-btn, .program-badge {
                display: none !important;
            }
        }
        
        /* Document output styles */
        .document-output {
            display: none;
            font-family: Helvetica, Arial, "Segoe UI", sans-serif;
            font-size: 11pt; /* Body size 11-12pt as specified */
            line-height: 1.6;
            color: #000;
        }
        
        .doc-page {
            background: white;
            position: relative;
            min-height: 100%;
            overflow: visible; /* allow header graphics to render fully */
            width: 720px; /* 7.5 inches of usable space at 96 DPI */
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .doc-content {
            padding-bottom: 100px; /* More space for footer to prevent overlap */
            padding-top: 0; /* Remove top padding */
            margin-top: 0;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: calc(100vh - 150px); /* Ensure proper page height */
        }
        
        /* Letterhead Header */
        .doc-letterhead {
            text-align: center;
                            margin-bottom: 20px;
            padding-bottom: 0;
                            margin-top: 0;
                            padding-top: 0;
                        }
                        .letterhead-image {
                            width: 100%;
                            max-width: 100%;
                            height: auto;
                            margin: 0 auto;
                            display: block;
        }
        
        .doc-letterhead-logo {
            height: 80px !important; /* fixed visual height to avoid partial decode/cropping */
            width: auto !important;
            max-width: 160px !important;
            margin: 0 auto 15px !important;
            display: block !important;
            object-fit: contain !important;
            object-position: center center !important;
            /* Ensure image loads properly in print */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .doc-logo {
            width: 200px;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }
        
        .doc-letterhead-lockup {
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }
        
        .doc-letterhead-icon {
            width: 40px;
            height: 40px;
            background: #0099cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        
        .doc-letterhead-text {
            text-align: center;
        }
        
        .doc-letterhead-text h1 {
            font-size: 24pt;
            color: #0099cc;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        
        .doc-letterhead-text p {
            font-size: 12pt;
            color: #000000;
            margin: 2px 0 0 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        /* Document Body */
        .doc-greeting {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: normal;
            margin-bottom: 8px;
        }
        
        .doc-intro {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-style: italic;
            text-decoration: underline;
            margin-bottom: 18pt;
            line-height: 1.4;
        }
        
        /* Section headers - CALIBRI 10PT BOLD (e.g., "Aftercare Options:") */
        .doc-section-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            margin: 18pt 0 14pt 0;
            text-align: left;
        }
        
        /* Category headers - CALIBRI 9PT BOLD (e.g., "PHP Options") */
        .doc-category-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: bold;
            margin: 14pt 0 10pt 0;
        }
        
        /* Program Cards */
        .doc-program {
            margin-bottom: 24pt; /* Two blank lines between programs */
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        /* Program title line with en dash - MUST BE CALIBRI 10PT BOLD */
        .doc-program-title {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            color: #000;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        /* Level of Care & Services section - MUST BE SINGLE PARAGRAPH, CALIBRI 9PT */
        .doc-program-descriptor {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-top: 12pt;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        .doc-program-descriptor strong {
            font-weight: bold;
        }
        
        /* Program Details heading - CALIBRI 9PT BOLD */
        .doc-program-details-heading {
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-size: 9pt;
            margin-bottom: 6pt;
            margin-top: 12pt;
        }
        
        /* Bullet lists - REAL BULLETS, CALIBRI 9PT */
        .doc-program-bullets {
            margin: 0 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-program-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-bottom: 4pt;
            position: relative;
            padding-left: 15px;
            line-height: 1.4;
        }
        
        .doc-program-bullets li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
        }
        
        /* Bold concept introductions in bullets */
        .doc-program-bullets li strong {
            font-weight: bold;
        }
        
        /* Sub-bullets with dashes */
        .doc-sub-bullets {
            margin: 4pt 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-sub-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            margin-bottom: 2pt;
            position: relative;
            padding-left: 15px;
        }
        
        .doc-sub-bullets li:before {
            content: "‚Äì";
            position: absolute;
            left: 0;
        }
        
        /* Contact Information block - CALIBRI 9PT */
        .doc-contact-section {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            line-height: 1.4;
            margin-top: 6pt;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .doc-contact-section strong {
            font-weight: bold;
        }
        
        .doc-contact-section a {
            word-break: break-all;
            color: #0066cc;
            text-decoration: none;
        }
        
        .doc-contact-section a:hover {
            text-decoration: underline;
        }
        
        /* Footer - stacked format */
        .doc-footer {
            position: fixed;
            bottom: 20px;
            left: 50px;
            right: 50px;
            text-align: center;
            font-size: 10pt;
            color: #333;
            background: white;
            padding: 15px 10px 10px 10px;
            border-top: 1px solid #ccc;
            z-index: 1000;
            box-shadow: 0 -2px 5px rgba(255,255,255,0.9);
            line-height: 1.4;
        }
        
        .doc-footer div {
            margin: 2px 0;
        }
        
        /* Mini card styles for AT HOME sections */
        .doc-mini-card {
            margin-bottom: 18pt;
            padding: 12pt;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafbfc;
        }
        
        .doc-mini-title {
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 8pt;
            color: #374151;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 4pt;
        }
        
        .doc-mini-blurb {
            font-size: 10pt;
            margin-bottom: 8pt;
            min-height: 24pt;
            border-bottom: 1px dotted #9ca3af;
            padding-bottom: 4pt;
            color: #6b7280;
        }
        
        .doc-mini-contact {
            font-size: 10pt;
            color: #374151;
        }
        
        .doc-mini-contact .contact-line {
            display: flex;
            align-items: center;
            margin-bottom: 4pt;
        }
        
        .doc-mini-contact .contact-label {
            font-weight: 600;
            min-width: 70px;
            color: #1f2937;
        }
        
        .doc-mini-contact .contact-fill {
            flex: 1;
            border-bottom: 1px solid #d1d5db;
            min-height: 16pt;
            margin-left: 8px;
        }
        
        /* Special emphasis for AT HOME Recommendation */
        .doc-emphasis-section {
            font-family: Calibri, Arial, sans-serif;
            font-size: 10pt;
            font-style: italic;
            text-decoration: underline;
        }
        
        /* Print-specific styles for blank lines */
        @media print {
            .doc-mini-title, .doc-mini-blurb, .doc-mini-contact {
                min-height: 1.2em;
            }
            
            .doc-footer {
                position: fixed;
                bottom: 0.5in;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 10pt;
                color: #333;
                background: white;
                padding: 10px 0;
                z-index: 100;
            }
            
            .doc-content {
                padding-bottom: 80px; /* More space for fixed footer */
            }
        }
        
        /* Delete button for custom programs */
        .program-delete-btn {
            position: absolute;
            top: 8px;
            right: 38px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: all 0.2s ease;
            z-index: 10;
            opacity: 0.8;
        }
        
        .program-delete-btn:hover {
            opacity: 1;
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .program-delete-btn:active {
            transform: scale(0.95);
        }
        
        /* Login Form Styles */
        .login-content .form-group {
            margin-bottom: 20px;
        }
        
        .login-content .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }
        
        .login-content .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .login-content .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-content .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-content .login-btn:hover {
            transform: translateY(-2px);
        }
        
        /* User Profile Button */
        .user-profile-btn {
            position: fixed;
            top: 20px;
            right: 160px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid white;
            color: white;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }
        
        .user-profile-btn:active {
            transform: translateY(0);
        }
        
        /* User Menu Dropdown */
        .user-menu {
            position: fixed;
            top: 75px;
            right: 100px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 999;
            animation: slideDown 0.2s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Welcome Animation */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            animation: overlayFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: opacity, transform;
        }
        
        .welcome-overlay.fade-out {
            animation: overlayFadeOut 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes overlayFadeIn {
            from { 
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to { 
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }
        
        @keyframes overlayFadeOut {
            0% { 
                opacity: 1;
                backdrop-filter: blur(10px);
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                backdrop-filter: blur(5px);
                transform: scale(1.01);
            }
            100% { 
                opacity: 0;
                backdrop-filter: blur(0px);
                transform: scale(1.05);
            }
        }
        
        .welcome-message {
            color: white;
            text-align: center;
            animation: messageSlideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center center;
            will-change: transform, opacity;
        }
        
        .welcome-message.fade-out {
            animation: messageFadeDown 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .welcome-message h1 {
            font-size: 48px;
            margin: 0 0 15px 0;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.1);
            background: linear-gradient(90deg, #fff, rgba(255,255,255,0.8), #fff);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shimmerText 3s ease-in-out infinite;
        }
        
        .welcome-message p {
            font-size: 24px;
            margin: 0 0 30px 0;
            opacity: 0.95;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        @keyframes shimmerText {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }
        
        @media (max-width: 768px) {
            .welcome-message h1 {
                font-size: 32px;
            }
            
            .welcome-message p {
                font-size: 18px;
                margin: 0 0 20px 0;
            }
            
            .welcome-progress {
                width: 150px;
            }
        }
        
        .welcome-progress {
            width: 200px;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .welcome-progress-bar {
            height: 100%;
            background: white;
            border-radius: 3px;
            animation: progressFill 2.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        @keyframes messageSlideUp {
            0% {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            60% {
                opacity: 1;
                transform: translateY(-5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes messageFadeDown {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
        }
        
        @keyframes progressFill {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: #1a202c;
        }
        
        .user-username {
            font-size: 13px;
            color: #718096;
        }
        
        /* Landing Page Responsive Styles */
        @media (min-width: 768px) {
            .landing-left {
                display: block !important;
            }
            .mobile-branding {
                display: none !important;
            }
        }
        
        @media (max-width: 767px) {
            .landing-left {
                display: none !important;
            }
            .mobile-branding {
                display: block !important;
            }
            #loginScreen > div > div:last-child {
                flex: 1 1 100% !important;
                max-width: 100% !important;
            }
        }
        
        /* Enhanced input focus styles for ClearHive branding */
        #loginUsername:focus, #loginPassword:focus {
            outline: none;
            border-color: #0891b2 !important;
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1) !important;
        }
        
        /* Login button hover effect */
        .login-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(8, 145, 178, 0.4) !important;
        }
        
        .login-btn:active {
            transform: translateY(-1px) !important;
                    }
    </style>
</head>
<body>
    
    <!-- AUTO-LOGIN DISABLED FOR PRODUCTION -->
    <script>
        // Disabled: do not auto-login in production
        (function(){ /* intentionally empty */ })();
    </script>
    <!-- END AUTO-LOGIN (DISABLED) -->
    
    
                <!-- Prominent Map Toggle Button -->
                <button id="mainMapToggle" onclick="toggleImmersiveMap()" style="
                    position: fixed;
                    bottom: 30px;
                    right: 30px;
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border: none;
                    color: white;
                    font-size: 24px;
                    cursor: pointer;
                    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
                    z-index: 9999;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <span id="mapToggleIcon">üó∫Ô∏è</span>
                </button>
    
    <!-- Login Screen -->
    <div id="loginScreen" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000; align-items: center; justify-content: center;">
        <div class="login-content" style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
            <h2 style="margin: 0 0 10px 0; color: #1a202c; text-align: center; font-size: 28px;">Family First</h2>
            <p style="text-align: center; color: #718096; margin-bottom: 30px; font-size: 14px;">ADOLESCENT SERVICES - Document Creator</p>
            
            <div id="loginError" style="display: none; background: #fed7d7; color: #9b2c2c; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px;"></div>
            
            <form id="staticLoginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" name="username" required placeholder="Enter username" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" name="password" required placeholder="Enter password" autocomplete="current-password">
                </div>
                
                <button type="submit" class="login-btn">Sign In</button>
            </form>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center;">
                <p style="color: #718096; font-size: 14px; margin-bottom: 10px;">First time here?</p>
                <button onclick="showAccountCreation()" type="button" style="
                    background: none;
                    border: 2px solid #667eea;
                    color: #667eea;
                    padding: 10px 30px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.background='#667eea'; this.style.color='white';" onmouseout="this.style.background='none'; this.style.color='#667eea';">
                    Create Your Profile
                </button>
            </div>
            
            <p style="text-align: center; margin-top: 20px; color: #a0aec0; font-size: 12px;">üîí Secure Document Generation System</p>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" style="display: none;">
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">üåô</span>
        <span id="themeText">Dark Mode</span>
    </button>
    
    <!-- User Profile Button -->
    <button class="user-profile-btn" onclick="toggleUserMenu()" id="userProfileBtn" title="User Profile">
        <span id="userInitials">?</span>
    </button>
    
    <!-- User Menu Dropdown -->
    <div class="user-menu" id="userMenu" style="display: none;">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-details">
                <div class="user-name" id="displayFullName">User</div>
                <div class="user-username" id="displayUsername">@username</div>
            </div>
        </div>
        <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">
        <button onclick="logout()" style="width: 100%; padding: 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
            üö™ Logout
        </button>
    </div>
    
    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>Document History</h3>
            <button onclick="toggleHistory()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div id="historyContent"></div>
    </div>
    
    <!-- Comparison View -->
    <div class="comparison-view" id="comparisonView">
        <div class="comparison-header">
            <h3>Program Comparison</h3>
            <button onclick="closeComparison()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div class="comparison-content" id="comparisonContent"></div>
    </div>
    
    <!-- Slide-out Menu -->
    <div id="slideMenu" class="slide-menu">
        <div class="menu-header">
            <h3>Menu</h3>
            <button class="close-menu" onclick="toggleMenu()">√ó</button>
        </div>
        <div class="menu-content">
            <div class="menu-section">
                <h4>Tools</h4>
                <button class="menu-item" onclick="showTemplates(); toggleMenu();">
                    <span class="menu-icon">üìã</span>
                    <span>Templates</span>
                </button>
                <button class="menu-item" onclick="showAnalytics().catch(console.error); toggleMenu();">
                    <span class="menu-icon">üìä</span>
                    <span>Analytics</span>
                </button>
                <button class="menu-item" onclick="showHelp(); toggleMenu();">
                    <span class="menu-icon">‚ùì</span>
                    <span>Help & Shortcuts</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Data</h4>
                <button class="menu-item" onclick="exportData(); toggleMenu();">
                    <span class="menu-icon">üì§</span>
                    <span>Export Data</span>
                </button>
                <button class="menu-item" onclick="importData(); toggleMenu();">
                    <span class="menu-icon">üì•</span>
                    <span>Import Data</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Program Database</h4>
                <button class="menu-item" onclick="openProgramManager(); toggleMenu();">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <span>Manage Programs</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Actions</h4>
                <button class="menu-item" onclick="saveAsTemplate(); toggleMenu();">
                    <span class="menu-icon">üíæ</span>
                    <span>Save as Template</span>
                </button>
                <button class="menu-item" onclick="clearAllPrograms(); toggleMenu();">
                    <span class="menu-icon">üóëÔ∏è</span>
                    <span>Clear All Programs</span>
                </button>
            </div>
        </div>
    </div>
    
    <style>
        .slide-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        
        .slide-menu.active {
            right: 0;
        }
        
        .menu-header {
            background: #0099cc;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close-menu {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-content {
            padding: 20px;
        }
        
        .menu-section {
            margin-bottom: 30px;
        }
        
        .menu-section h4 {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .menu-item {
            width: 100%;
            padding: 12px 15px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .menu-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* Dark mode styles for menu */
        body.dark-mode .slide-menu {
            background: #2a2a2a;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .menu-header {
            background: #1a1a2a;
        }
        
        body.dark-mode .menu-section h4 {
            color: #999;
            border-color: #444;
        }
        
        body.dark-mode .menu-item {
            background: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .menu-item:hover {
            background: #404040;
        }
        
        /* Menu overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 9998;
        }
        
        .menu-overlay.active {
            display: block;
        }

        /* ============= DASHBOARD STYLES ============= */
        .tab-navigation {
            display: flex !important;
            gap: 8px;
            margin-bottom: 20px;
            visibility: visible !important;
            padding: 10px 0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn:hover {
            background: #e0e0e0;
            border-color: #999;
        }

        .tab-btn.active {
            background: #0099cc;
            color: white;
            border-color: #0099cc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Dashboard Container */
        .dashboard-container {
            padding: 20px;
            background: #f8f9fa !important;
            min-height: calc(100vh - 200px);
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Force all dashboard text to be dark and visible */
        .dashboard-container,
        .dashboard-container *,
        #dashboardTab,
        #dashboardTab *,
        .dashboard-widget,
        .dashboard-widget * {
            color: #1a1a1a !important;
            fill: #1a1a1a !important;
        }
        
        /* Force dashboard tab to be visible when active */
        #dashboardTab.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 999999 !important;
            background: white !important;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .dashboard-greeting {
            font-size: 28px;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .dashboard-subtitle {
            font-size: 16px;
            color: #666;
        }

        .dashboard-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            background: #f0f0f0;
            padding: 4px;
            border-radius: 8px;
        }

        .view-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: #0099cc;
            color: white;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Dashboard Widgets */
        .dashboard-widget {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 200px;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .widget-header h3 {
            margin: 0;
            font-size: 20px;
            color: #1a1a1a;
        }

        .widget-skeleton {
            padding: 40px;
            text-align: center;
            color: #999;
        }

        .widget-error {
            padding: 40px;
            text-align: center;
            color: #dc3545;
        }

        /* Flight Plan Widget */
        .priority-zones {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .priority-zone {
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        .zone-red {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .zone-purple {
            border-color: #6f42c1;
            background: #f8f5ff;
        }

        .zone-yellow {
            border-color: #ffc107;
            background: #fffef5;
        }

        .zone-green {
            border-color: #28a745;
            background: #f5fff8;
        }

        .zone-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 600;
            background: rgba(255,255,255,0.5);
        }

        .zone-icon {
            font-size: 20px;
        }

        .zone-title {
            flex: 1;
            color: #333;
        }

        .zone-count {
            background: rgba(0,0,0,0.1);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .zone-toggle {
            font-size: 12px;
            color: #666;
        }

        .zone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .zone-content.expanded {
            max-height: 2000px;
        }

        .priority-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .priority-item:last-child {
            border-bottom: none;
        }

        .priority-item-content {
            flex: 1;
        }

        .priority-item-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .priority-item-subtitle {
            font-size: 13px;
            color: #666;
        }

        .priority-item-action {
            padding: 6px 12px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .priority-item-action:hover {
            background: #0077aa;
        }

        .empty-zone {
            padding: 20px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        /* House Weather Widget */
        .house-card {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .house-card:hover {
            border-color: #0099cc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .house-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .weather-icon {
            font-size: 24px;
        }

        .house-name {
            flex: 1;
            font-weight: 600;
            font-size: 18px;
            color: #1a1a1a;
        }

        .house-score {
            text-align: center;
            margin: 12px 0;
        }

        .score-value {
            font-size: 36px;
            font-weight: bold;
            color: #0099cc;
        }

        .score-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .house-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        /* Metrics Widget */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .metric-card {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
        }

        /* Missions Widget */
        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mission-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #0099cc;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .mission-item.completed {
            background: #f0fdf4;
            border-left-color: #22c55e;
            opacity: 0.8;
        }
        
        .mission-item .mission-content {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            flex: 1;
        }
        
        .mission-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #22c55e;
            transition: transform 0.2s ease;
        }
        
        .mission-checkbox:checked {
            transform: scale(1.1);
        }
        
        .mission-task.task-complete {
            text-decoration: line-through;
            color: #6b7280;
        }
        
        .progress-circle {
            display: inline-flex;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin: 0 2px;
            border: 2px solid #e5e7eb;
            color: #9ca3af;
            background: white;
            transition: all 0.3s ease;
        }
        
        .progress-circle.completed {
            border-color: #22c55e;
            background: #22c55e;
            color: white;
        }
        
        @keyframes missionComplete {
            0% {
                transform: translateX(0);
                background: #f8f9fa;
            }
            50% {
                transform: translateX(5px);
                background: #dcfce7;
            }
            100% {
                transform: translateX(0);
                background: #f0fdf4;
            }
        }

        /* Health Bar Styles */
        .health-bar-container {
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .health-bar {
            flex: 1;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .health-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,255,255,0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s ease-out infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .score-text {
            font-weight: 700;
            font-size: 18px;
            min-width: 45px;
            text-align: right;
        }
        
        .house-card.score-excellent .health-bar-fill {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }
        
        .house-card.score-good .health-bar-fill {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }
        
        .house-card.score-fair .health-bar-fill {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .house-card.score-critical .health-bar-fill {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        
        .house-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .house-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        /* Zone Content Styling */
        .zone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .zone-content.expanded {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Quick Actions Widget */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .quick-action-button {
            padding: 16px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .quick-action-button:hover {
            border-color: #0099cc;
            background: #e6f7ff;
            transform: translateY(-2px);
        }

        .quick-action-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .quick-action-label {
            font-weight: 600;
            color: #1a1a1a;
        }
    </style>
    
    <!-- Menu Overlay -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>
    
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="header-text">
                    <h1>CareConnect Pro</h1>
                    <p>FAMILY FIRST ADOLESCENT SERVICES</p>
                </div>
            </div>
            <div class="header-right" style="display: flex; align-items: center; gap: 20px;">
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); text-align: right;">
                    Professional Aftercare Document Builder<br>
                    <small style="color: rgba(255,255,255,0.7); font-size: 12px;">v3.0 Deluxe</small><br>
                    <small id="sessionIndicator" style="color: #fbbf24; font-size: 11px; font-weight: 600; display: none;"></small>
                </div>
                <div class="header-controls" style="display: flex; gap: 10px;">
                    <button class="header-btn demo-btn" onclick="toggleDemoMode()" title="Toggle Demo Mode">
                        <span id="demoIcon">üé≠</span>
                    </button>
                    <button class="header-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <span id="themeIcon">üåô</span>
                    </button>
                    <button class="header-btn" onclick="toggleMenu()" title="Menu" style="font-size: 20px;">‚ò∞</button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Left Panel: Program List -->
            <div class="programs-panel">
                
                <!-- Tab Navigation -->
                <div class="tab-navigation" style="display: flex !important; gap: 8px; margin-bottom: 20px; visibility: visible !important;">
                    <button class="tab-btn" data-tab-target="dashboard" onclick="switchTab('dashboard')">
                        <span>üéØ Dashboard</span>
                    </button>
                    <button class="tab-btn active" data-tab-target="programs" onclick="switchTab('programs')">
                        <span>üìë Programs &amp; Docs</span>
                    </button>
                    <button class="tab-btn" data-tab-target="clients" onclick="switchTab('clients')">
                        <span>üë• Clients</span>
                    </button>
                </div>
                
                <!-- Dashboard Tab Content -->
                <div id="dashboardTab" class="tab-content">
                    <div class="dashboard-container">
                        <div class="dashboard-header">
                            <div>
                                <div class="dashboard-greeting" id="dashboardGreeting">Good morning</div>
                                <div class="dashboard-subtitle" id="dashboardSubtitle">Here's your morning priorities</div>
                            </div>
                            <div class="dashboard-controls">
                                <div class="view-toggle">
                                    <button class="active" onclick="dashboardManager.currentView='myClients'; dashboardManager.refreshDashboard()">My Clients</button>
                                    <button onclick="dashboardManager.currentView='allClients'; dashboardManager.refreshDashboard()">All Clients</button>
                                </div>
                                <div style="text-align: right; font-size: 13px; color: #6b7280;">
                                    <div id="coachIndicator">Coach: --</div>
                                    <div id="lastUpdateTime">Last updated: --</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                            <!-- Left column widgets -->
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <!-- North Star Metrics - HIDDEN (replaced with Aftercare Pipeline Status) -->
                                <div id="metricsWidget" class="dashboard-widget" style="display: none !important;"></div>
                                
                                <!-- Daily Flight Plan -->
                                <div id="flightPlanWidget" class="dashboard-widget"></div>
                            </div>
                            
                            <!-- Right column widgets -->
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <!-- House Weather System - HIDDEN (replaced with Active Client Tracker Grid) -->
                                <div id="houseWeatherWidget" class="dashboard-widget" style="display: none !important;"></div>
                                
                                <!-- Client Journey Radar -->
                                <div id="journeyRadarWidget" class="dashboard-widget"></div>
                                
                                <!-- Today's Missions -->
                                <div id="missionsWidget" class="dashboard-widget"></div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions (full width) -->
                        <div id="quickActionsWidget" class="dashboard-widget" style="margin-top: 20px;"></div>
                    </div>
                </div>
                
                <script>
                    // Tab switching function
                    function switchTab(tab) {
                        try {
                            console.log('Switching to tab:', tab);
                            console.trace('Tab switch called from:');
                            
                            // Don't block manual tab switches - only auto-switches at load
                            // if (window.blockTabSwitches && tab !== 'clients' && tab !== 'dashboard') {
                            //     console.warn('üõë BLOCKED tab switch to:', tab);
                            //     return;
                            // }
                            
                            // Remove active class from all tabs and buttons, and hide them
                            document.querySelectorAll('.tab-content').forEach(t => {
                                if (t) {
                                    t.classList.remove('active');
                                    // Explicitly hide inactive tabs
                                    if (t.id !== tab + 'Tab') {
                                        t.style.display = 'none';
                                    }
                                }
                            });
                            document.querySelectorAll('.tab-btn').forEach(b => {
                                if (b) b.classList.remove('active');
                            });
                            
                            // Add active class to selected tab and ensure it's visible
                            const tabElement = document.getElementById(tab + 'Tab');
                            if (tabElement) {
                                tabElement.classList.add('active');
                                // Explicitly show the active tab
                                tabElement.style.display = 'block';
                                tabElement.style.visibility = 'visible';
                                tabElement.style.opacity = '1';
                                console.log('Activated tab:', tab + 'Tab');
                            } else {
                                console.warn('Tab element not found:', tab + 'Tab');
                            }
                            
                            // Add active class to corresponding button
                            const tabButtons = document.querySelectorAll('.tab-btn');
                            tabButtons.forEach(btn => {
                                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tab)) {
                                    btn.classList.add('active');
                                    console.log('Activated button for:', tab);
                                }
                            });
                            
                            // Special handling for dashboard tab
                            if (tab === 'dashboard') {
                                // Add class to body for dashboard-specific styles
                                document.body.classList.add('dashboard-active');
                                
                                // Force dashboard tab to be visible
                                if (tabElement) {
                                    tabElement.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important; position: relative !important; z-index: 9999 !important;';
                                    console.log('‚úÖ Forced dashboard tab visibility');
                                }
                                
                                // Ensure dashboard container exists and is visible before rendering
                                const dashboardContainer = document.querySelector('.dashboard-container');
                                if (dashboardContainer) {
                                    dashboardContainer.style.display = 'block';
                                    dashboardContainer.style.visibility = 'visible';
                                    dashboardContainer.style.opacity = '1';
                                }
                                
                                // Initialize dashboard if not already done
                                setTimeout(() => {
                                    // Double-check tab is visible
                                    if (tabElement) {
                                        tabElement.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important; position: relative !important; z-index: 9999 !important;';
                                    }
                                    
                                    if (window.dashboardManager) {
                                        if (!window.dashboardManager.initialized) {
                                            initializeDashboard();
                                        } else {
                                            // Re-render widgets if already initialized - ensure containers exist first
                                            const widgetContainers = [
                                                'flightPlanWidget',
                                                'houseWeatherWidget',
                                                'journeyRadarWidget',
                                                'missionsWidget',
                                                'metricsWidget',
                                                'quickActionsWidget'
                                            ];
                                            
                                            const allContainersExist = widgetContainers.every(id => {
                                                const container = document.getElementById(id);
                                                return container !== null;
                                            });
                                            
                                            if (allContainersExist && window.dashboardWidgets && window.dashboardWidgets.renderAll) {
                                                window.dashboardWidgets.renderAll().then(() => {
                                                    console.log('‚úÖ Dashboard widgets re-rendered');
                                                }).catch(error => {
                                                    console.error('‚ùå Failed to re-render widgets:', error);
                                                    // Re-initialize if render fails
                                                    if (window.dashboardWidgets && window.dashboardWidgets.initialize) {
                                                        window.dashboardWidgets.initialize().then(() => {
                                                            return window.dashboardWidgets.renderAll();
                                                        }).catch(console.error);
                                                    }
                                                });
                                            } else {
                                                console.warn('‚ö†Ô∏è Widget containers missing, re-initializing...');
                                                initializeDashboard();
                                            }
                                        }
                                    } else {
                                        console.log('Dashboard manager not available, will retry...');
                                        setTimeout(() => {
                                            if (window.dashboardManager) {
                                                initializeDashboard();
                                            }
                                        }, 1000);
                                    }
                                }, 200);
                                
                                // IMPORTANT: Hide the document generation panel for Dashboard tab
                                const selectionPanel = document.querySelector('.selection-panel');
                                if (selectionPanel) {
                                    selectionPanel.style.display = 'none';
                                    selectionPanel.style.visibility = 'hidden';
                                    console.log('‚úÖ Hidden selection panel for Dashboard tab');
                                }
                                
                                // Adjust main content layout to full width
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr';
                                    mainContent.style.maxWidth = '100%';
                                }
                            } else if (tab === 'programs') {
                                // Remove dashboard mode
                                document.body.classList.remove('dashboard-active');
                                
                                // Ensure programs tab is visible
                                if (tabElement) {
                                    tabElement.style.display = 'block';
                                    tabElement.style.visibility = 'visible';
                                    tabElement.style.opacity = '1';
                                }
                                
                                // Show selection panel for Programs tab ONLY
                                const selectionPanel = document.querySelector('.selection-panel');
                                if (selectionPanel) {
                                    selectionPanel.style.display = 'flex';
                                    selectionPanel.style.visibility = 'visible';
                                    console.log('‚úÖ Showing selection panel for Programs tab');
                                }
                                
                                // Restore main content layout with side panel
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr 440px';
                                    mainContent.style.maxWidth = '';
                                }
                                
                                // Initialize client selector when programs tab is shown
                                setTimeout(() => {
                                    initializeClientSelector();
                                }, 100);
                            } else if (tab === 'clients') {
                                // For clients tab, keep full width but HIDE selection panel
                                document.body.classList.remove('dashboard-active');
                                
                                // Ensure clients tab is visible
                                if (tabElement) {
                                    tabElement.style.display = 'block';
                                    tabElement.style.visibility = 'visible';
                                    tabElement.style.opacity = '1';
                                }
                                
                                // IMPORTANT: Hide the document generation panel for Clients tab
                                const selectionPanel = document.querySelector('.selection-panel');
                                if (selectionPanel) {
                                    selectionPanel.style.display = 'none';
                                    selectionPanel.style.visibility = 'hidden';
                                    console.log('‚úÖ Hidden selection panel for Clients tab');
                                }
                                
                                // Full width layout for clients
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr';
                                }
                            }
                            
                            // Save preference
                            localStorage.setItem('lastActiveTab', tab);
                        } catch (error) {
                            console.error('Error switching tabs:', error);
                        }
                    }
                    
                    // Function to show selection panel (document generation UI)
                    function showSelectionPanel() {
                        // Restore all elements marked as hidden by dashboard
                        const hiddenElements = document.querySelectorAll('[data-dashboard-hidden="true"]');
                        hiddenElements.forEach(el => {
                            el.style.display = '';
                            el.style.visibility = '';
                            el.removeAttribute('data-dashboard-hidden');
                        });
                        console.log('‚úÖ Restored selection panel');
                    }
                    
                    // Function to hide selection panel (document generation UI)
                    // IMPORTANT: Only target the actual .selection-panel element to avoid affecting dashboard
                    function hideSelectionPanel() {
                        // ONLY target the specific selection panel element
                        const selectionPanel = document.querySelector('.selection-panel');
                        if (selectionPanel) {
                            // Double-check it's not inside dashboard tab
                            if (!selectionPanel.closest('#dashboardTab') && !selectionPanel.closest('.dashboard-container')) {
                                selectionPanel.style.display = 'none';
                                selectionPanel.style.visibility = 'hidden';
                                selectionPanel.setAttribute('data-dashboard-hidden', 'true');
                                console.log('‚úÖ Hidden selection panel (document generation UI)');
                            } else {
                                console.log('‚ö†Ô∏è Selection panel is inside dashboard - skipping hide');
                            }
                        }
                    }
                    
                    // EMERGENCY: Simple dashboard fallback
                    window.injectSimpleDashboard = function() {
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (!dashboardTab) {
                            console.error('Dashboard tab not found!');
                            return;
                        }
                        
                        dashboardTab.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important;';
                        dashboardTab.innerHTML = `
                            <div class="dashboard-container" style="padding: 20px; background: #f8f9fa !important; min-height: 600px; display: block !important;">
                                <h1 style="color: #111827 !important; margin-bottom: 20px;">üéØ Coach Dashboard (Fallback Mode)</h1>
                                <p style="color: #dc2626 !important; padding: 10px; background: #fee2e2; border-radius: 6px;">
                                    ‚ö†Ô∏è Dashboard widgets failed - showing emergency fallback
                                </p>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <h3 style="color: #374151 !important;">üìä Dashboard Status</h3>
                                        <p style="color: #059669 !important;">‚úÖ Fallback dashboard loaded</p>
                                        <p style="color: #4b5563 !important;">Time: ${new Date().toLocaleTimeString()}</p>
                                    </div>
                                    
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <h3 style="color: #374151 !important;">üîß Quick Fix</h3>
                                        <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                            üîÑ Reload Page
                                        </button>
                                        <button onclick="window.clearCacheAndReload()" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                                            üóëÔ∏è Clear Cache & Reload
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 30px; padding: 20px; background: #dbeafe; border-radius: 8px;">
                                    <h3 style="color: #1e40af !important;">‚ÑπÔ∏è What Happened?</h3>
                                    <p style="color: #1e40af !important;">The dashboard widgets failed to render. This fallback ensures you can still see something.</p>
                                    <p style="color: #1e40af !important; margin-top: 10px;">To fix: Try clearing browser cache or using a different browser.</p>
                                </div>
                            </div>
                        `;
                        
                        console.log('‚úÖ Simple fallback dashboard injected successfully');
                        return true;
                    }
                    
                    // Auto-inject fallback if main dashboard fails
                    setTimeout(() => {
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (dashboardTab && dashboardTab.classList.contains('active')) {
                            const widgets = document.querySelectorAll('.dashboard-widget');
                            if (widgets.length === 0) {
                                console.warn('‚ö†Ô∏è No dashboard widgets found after 3 seconds, injecting fallback');
                                window.injectSimpleDashboard();
                            }
                        }
                    }, 3000);
                    
                    // Initialize dashboard
                    async function initializeDashboard() {
                        if (!window.dashboardManager) {
                            console.log('Dashboard manager not loaded yet, retrying...');
                            setTimeout(initializeDashboard, 500);
                            return;
                        }
                        
                        if (!window.dashboardWidgets) {
                            console.log('Dashboard widgets not loaded yet, retrying...');
                            setTimeout(initializeDashboard, 500);
                            return;
                        }
                        
                        // Wait for required managers to be available (with timeout)
                        const waitStartTime = window.dashboardWaitStartTime || (window.dashboardWaitStartTime = Date.now());
                        const maxWaitTime = 30000; // 30 seconds max wait
                        
                        if (Date.now() - waitStartTime > maxWaitTime) {
                            console.error('Dashboard initialization timed out after 30 seconds');
                            console.log('Manager states:', {
                                clientManager: !!window.clientManager,
                                housesManager: !!window.housesManager,
                                milestonesManager: !!window.milestonesManager
                            });
                            // Continue anyway with available managers
                        } else if (!window.clientManager || !window.housesManager) {
                            // Only clientManager and housesManager are truly required
                            console.log('Waiting for essential managers...', {
                                clientManager: !!window.clientManager,
                                housesManager: !!window.housesManager,
                                milestonesManager: !!window.milestonesManager
                            });
                            setTimeout(initializeDashboard, 500);
                            return;
                        } else if (!window.milestonesManager) {
                            // Log warning but continue initialization
                            console.warn('MilestonesManager not available - dashboard will have limited functionality');
                        }
                        
                        try {
                            await dashboardManager.initialize();
                            
                            // Update greeting
                            const greeting = dashboardManager.getTimeAwareGreeting();
                            document.getElementById('dashboardGreeting').textContent = greeting.greeting;
                            document.getElementById('dashboardSubtitle').textContent = greeting.focus;
                            
                            // Update coach indicator
                            document.getElementById('coachIndicator').textContent = `Coach: ${dashboardManager.currentCoach.initials}`;
                            
                            // Ensure dashboard tab is visible before rendering
                            const dashboardTab = document.getElementById('dashboardTab');
                            if (dashboardTab) {
                                dashboardTab.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important; position: relative !important; z-index: 9999 !important;';
                            }
                            
                            // Ensure dashboard container exists
                            const dashboardContainer = document.querySelector('.dashboard-container');
                            if (!dashboardContainer) {
                                console.error('‚ùå Dashboard container not found!');
                                throw new Error('Dashboard container missing');
                            }
                            dashboardContainer.style.display = 'block';
                            dashboardContainer.style.visibility = 'visible';
                            
                            // Initialize and render widgets
                            await window.dashboardWidgets.initialize();
                            await dashboardManager.loadDashboardData();
                            
                            // Verify widget containers exist before rendering
                            const requiredContainers = [
                                'flightPlanWidget',
                                'houseWeatherWidget',
                                'journeyRadarWidget',
                                'missionsWidget',
                                'metricsWidget',
                                'quickActionsWidget'
                            ];
                            
                            const missingContainers = requiredContainers.filter(id => !document.getElementById(id));
                            if (missingContainers.length > 0) {
                                console.error('‚ùå Missing widget containers:', missingContainers);
                                throw new Error(`Missing widget containers: ${missingContainers.join(', ')}`);
                            }
                            
                            await window.dashboardWidgets.renderAll();
                            
                            // Ensure selection panel is hidden on dashboard (but don't affect dashboard)
                            const selectionPanel = document.querySelector('.selection-panel');
                            if (selectionPanel && !selectionPanel.closest('#dashboardTab')) {
                                selectionPanel.style.display = 'none';
                                selectionPanel.style.visibility = 'hidden';
                            }
                            
                            // Update last updated time
                            const updateTime = () => {
                                const now = new Date();
                                document.getElementById('lastUpdateTime').textContent = 
                                    `Last updated: ${now.toLocaleTimeString()}`;
                            };
                            updateTime();
                            setInterval(updateTime, 60000); // Update every minute
                            
                            // Clean up wait timer
                            delete window.dashboardWaitStartTime;
                            
                            console.log('‚úÖ Dashboard initialized successfully');
                        } catch (error) {
                            console.error('Failed to initialize dashboard:', error);
                            // Clean up wait timer on error too
                            delete window.dashboardWaitStartTime;
                        }
                    }
                    
                    // Set programs as default on page load
                    document.addEventListener('DOMContentLoaded', function() {
                        // Start with Programs tab as default
                        const defaultTab = 'programs';
                        
                        // Initially hide the selection panel
                        const selectionPanel = document.querySelector('.selection-panel');
                        if (selectionPanel) {
                            selectionPanel.style.display = 'none';
                            selectionPanel.style.visibility = 'hidden';
                        }
                        
                        // Load programs tab by default
                        setTimeout(() => {
                            switchTab(defaultTab);
                        }, 100);
                        
                        // Diagnostic scripts removed - no longer needed
                        // These were temporary fixes that caused console noise
                        
                        /* Commented out diagnostic scripts:
                        // Run diagnostics after a delay
                        setTimeout(() => {
                            const script = document.createElement('script');
                            script.src = 'dashboard-diagnostics-fix.js?v=' + Date.now();
                            document.body.appendChild(script);
                        }, 2000);
                        
                        // Apply visibility fix
                        setTimeout(() => {
                            const fixScript = document.createElement('script');
                            fixScript.src = 'dashboard-visibility-fix.js?v=' + Date.now();
                            document.body.appendChild(fixScript);
                        }, 2500);
                        
                        // Apply parent visibility fix immediately
                        setTimeout(() => {
                            const parentFixScript = document.createElement('script');
                            parentFixScript.src = 'parent-visibility-fix.js?v=' + Date.now();
                            document.body.appendChild(parentFixScript);
                        }, 500);
                        */
                    });
                    
                    // Helper function for notifications
                    function showNotification(message, type = 'info') {
                        const notification = document.createElement('div');
                        notification.className = `notification notification-${type}`;
                        notification.innerHTML = `
                            <div class="notification-content">
                                <div class="notification-message">${message}</div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                        
                        // Add styles if not already present
                        if (!document.querySelector('#notificationStyles')) {
                            const style = document.createElement('style');
                            style.id = 'notificationStyles';
                            style.textContent = `
                                .notification {
                                    position: fixed;
                                    top: 20px;
                                    right: 20px;
                                    padding: 16px 24px;
                                    border-radius: 8px;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                    z-index: 10000;
                                    animation: slideIn 0.3s ease-out;
                                }
                                .notification-success { background: #10b981; color: white; }
                                .notification-error { background: #ef4444; color: white; }
                                .notification-info { background: #3b82f6; color: white; }
                                @keyframes slideIn {
                                    from { transform: translateX(100%); opacity: 0; }
                                    to { transform: translateX(0); opacity: 1; }
                                }
                            `;
                            document.head.appendChild(style);
                        }
                        
                        setTimeout(() => notification.remove(), 3000);
                    }
                    
                    // Helper function for modals
                    function showModal(options) {
                        const modal = document.createElement('div');
                        modal.className = 'modal';
                        modal.style.display = 'block';
                        modal.innerHTML = `
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2>${options.title}</h2>
                                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    ${options.content}
                                </div>
                                <div class="modal-actions">
                                    ${options.buttons.map(btn => 
                                        `<button onclick="${btn.action}; this.closest('.modal').remove()">${btn.text}</button>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                    
                    function closeModal() {
                        const modal = document.querySelector('.modal:last-child');
                        if (modal) modal.remove();
                    }
                </script>
                
                <!-- Programs Tab Content -->
                <div id="programsTab" class="tab-content active">
                    <div id="programsDocsLoader" class="programs-docs-loader" role="status" aria-live="polite">
                        <span class="loader-spinner" aria-hidden="true"></span>
                        <span class="loader-copy">Loading Programs &amp; Docs workspace‚Ä¶</span>
                    </div>
                    <div id="programsDocsContainer" class="programs-docs-container" hidden></div>
                    <div id="programsDocsError" class="programs-docs-error" hidden role="alert">
                        <h3>Programs workspace unavailable</h3>
                        <p>Please retry loading or switch back to the legacy module if needed.</p>
                        <div class="programs-docs-error-actions">
                            <button type="button" class="btn btn-primary" onclick="retryProgramsDocsMount()">Retry load</button>
                            <button type="button" class="btn" onclick="toggleLegacyPrograms(true)">Open legacy Programs view</button>
                        </div>
                    </div>
                    <div id="legacyProgramsWrapper" class="legacy-programs-wrapper" hidden aria-live="polite"></div>
                </div> <!-- End of programsTab -->
                
                <!-- Clients Tab Content -->
                <div id="clientsTab" class="tab-content">
                    <div class="cm-tracker-container">
                        <!-- House Navigation -->
                        <div class="house-navigation">
                            <div class="house-tabs" id="houseTabs">
                                <!-- House tabs will be dynamically generated -->
                            </div>
                        </div>
                        
                        <!-- House Content Area -->
                        <div class="house-content" id="houseContent">
                            <div class="cm-quick-actions">
                                <button class="cm-action-btn primary" onclick="showAddClientModal()">
                                    ‚ûï Add Client
                                </button>
                                <button class="cm-action-btn" onclick="showBulkImport()">
                                    üì• Import Excel
                                </button>
                                <button class="cm-action-btn" onclick="exportCurrentHouse()">
                                    üíæ Export House
                                </button>
                                <button class="cm-action-btn" onclick="exportAllData()">
                                    üìä Export All
                                </button>
                                <button class="cm-action-btn" onclick="showReports()">
                                    üìà Reports
                                </button>
                                <button class="cm-action-btn" onclick="switchTab('programs')" style="background: #f3f4f6;" data-tab-target="programs">
                                    üìë Programs &amp; Docs
                                </button>
                            </div>
                            
                            <div id="houseClientsList">
                                <!-- Client table will be dynamically generated here -->
                            </div>
                        </div>
                        
                    </div>
                </div> <!-- End of clientsTab -->
                
            </div>
            
    <!-- ClearHive Branding -->
    <div style="text-align: center; padding: 20px; border-top: 1px solid #eee; margin-top: 40px; color: #999; font-size: 12px;">
        Document Creator by <strong>ClearHive Health LLC</strong>
    </div>
</body>
</html>

