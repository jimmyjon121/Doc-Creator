<!DOCTYPE html>
<!-- 
    CareConnect Pro v4.1.0
    Build Date: 2025-11-16T00:00:00.000Z
    Build Hash: dashboard-refresh-01
    Copyright (c) Family First Adolescent Services
-->
<!-- OFFICIAL ACTIVE APP ‚Äì v12.2-dashboard (edit/debug here). Stable snapshot: CURRENT-VERSION-v12/CareConnect-Pro_v12.1-STABLE.html. Programs module: programs-docs-module.html, dataset: programs.v2.json -->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect Pro v12.4 - REVAMPED PROFILE</title>
    
    <!-- Content Security Policy for enhanced security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https://tile.openstreetmap.org https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://tile.openstreetmap.fr https://a.tile.openstreetmap.fr https://b.tile.openstreetmap.fr https://c.tile.openstreetmap.fr https://server.arcgisonline.com https://services.arcgisonline.com https://*.opentopomap.org https://*.basemaps.cartocdn.com; font-src 'self' data:; connect-src 'self' https://nominatim.openstreetmap.org https://tile.openstreetmap.org https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://tile.openstreetmap.fr https://a.tile.openstreetmap.fr https://b.tile.openstreetmap.fr https://c.tile.openstreetmap.fr https://server.arcgisonline.com https://services.arcgisonline.com https://*.opentopomap.org https://*.basemaps.cartocdn.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none';">
    
    <!-- PDF Libraries for document merging -->
    <!-- Libraries loaded locally for HIPAA compliance - no external CDN -->
    <script src="libs/pdf-lib.min.js"></script>
    <script src="libs/jspdf.umd.min.js"></script>
    <script src="libs/html2canvas.min.js"></script>
    
    <link rel="stylesheet" href="css/client-profile.css">
    <link rel="stylesheet" href="css/app-layout.css">
    
    <!-- Enhanced Features Libraries -->
    <script src="libs/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="libs/select2.min.css">
    <script src="libs/select2.min.js"></script>
    <link rel="stylesheet" href="libs/leaflet.css">
    <link rel="stylesheet" href="map-v2-dist/assets/map-v2.css">
    <script src="libs/leaflet.js"></script>
    <script src="libs/chart.min.js"></script>
    <script src="libs/d3.v7.min.js"></script>
    
    <!-- Programs Data Loader - MUST load before other modules -->
    <script src="js/programs-loader.js"></script>
    <script src="js/programs-init.js"></script>
    
    <!-- Database Management -->
    <script src="indexed-db-manager.js"></script>

    <!-- Task Schema & Services -->
    <script src="configs/task-schema.js"></script>
    
    <!-- Client Management -->
    <script src="client-manager.js"></script>
    <script src="js/task-service.js"></script>
    
    <!-- Demo Data Generator (Development Only) -->
    <script src="js/demo-data.js"></script>
    
    <!-- CM Tracker for Clients Tab -->
    <script src="cm-tracker.js"></script>

    <!-- Client Profile Manager (Modern Modal) -->
    <script src="client-profile-manager.js"></script>
    
    <!-- Initialize Client Management System -->
    <script>
        (async function() {
            'use strict';
            
            // Initialize database manager
            window.dbManager = new IndexedDBManager('CareConnectDB', 2);
            
            // Initialize database with stores
            await window.dbManager.init([
                { name: 'clients', keyPath: 'id' },
                { name: 'documents', keyPath: 'id' },
                { name: 'programs', keyPath: 'id' },
                { name: 'settings', keyPath: 'key' }
            ]);
            
            // Initialize client manager
            window.clientManager = new ClientManager(window.dbManager);

            // Initialize task service (ensures TaskSchema state is populated)
            if (typeof ClientTaskService !== 'undefined') {
                window.taskService = new ClientTaskService(window.clientManager, window.TaskSchema);
                await window.taskService.initialize();
            }
            
            console.log('‚úÖ Client management system initialized');
            
            // Dispatch event to notify that client manager is ready
            window.dispatchEvent(new CustomEvent('clientManagerReady', { 
                detail: { 
                    clientManager: window.clientManager,
                    taskService: window.taskService
                } 
            }));
        })();
    </script>
    
    <!-- Enhanced Features Scripts -->
    <script>
        // Global error handler to prevent white screen
        window.addEventListener('error', function(e) {
            console.error('üî• Global error caught:', e.error || e.message);
            // Prevent white screen by showing error message
            if (e.error && e.error.message) {
                const errorMsg = e.error.message;
                if (errorMsg.includes('is not defined') || errorMsg.includes('is not a constructor')) {
                    console.error('‚ö†Ô∏è Critical script loading error detected');
                    // Don't reload automatically, just log
                }
            }
            return false; // Prevent default error handling
        });

        // Track which dashboard mode is currently active
        window.dashboardState = window.dashboardState || {
            mode: 'loading',
            lastReason: 'bootstrap',
            fallbackInjected: false,
            lastUpdated: Date.now()
        };

        function setDashboardMode(mode, reason = 'unspecified') {
            window.dashboardState = window.dashboardState || {};
            window.dashboardState.mode = mode;
            window.dashboardState.lastReason = reason;
            window.dashboardState.lastUpdated = Date.now();
            if (mode === 'fallback') {
                window.dashboardState.fallbackInjected = true;
            }
        }

        function canUseFallbackDashboard(reason = 'unspecified') {
            const state = window.dashboardState || {};
            if (state.mode === 'modern') {
                console.warn(`Skipping fallback dashboard (${reason}) because modern dashboard is active.`);
                return false;
            }
            return true;
        }
        
        // Ensure body is always visible once DOM is ready
        window.addEventListener('DOMContentLoaded', function() {
            document.body.style.opacity = '1';
            document.body.style.visibility = 'visible';
            document.body.style.display = 'block';
        });
        
        // Aggressive cache busting with random component
        const cacheBust = Date.now() + '-' + Math.random().toString(36).substring(7);
        
        // Global config (demo vs production behavior)
        window.ccConfig = window.ccConfig || {};
        if (typeof window.ccConfig.demoMode === 'undefined') {
            // Default: demo mode on for local development only
            const host = window.location.hostname;
            window.ccConfig.demoMode = (host === 'localhost' || host === '127.0.0.1');
        }
        // Dev helper docs: see DEV-TOOLS.md for reset/test workflows.

        // Debug logging flag (default controlled by ?debug=1 or localStorage `cc-debug`)
        if (typeof window.DEBUG === 'undefined') {
            const params = new URLSearchParams(window.location.search);
            const debugFromQuery = params.get('debug');
            const debugFromStorage = localStorage.getItem('cc-debug');
            window.DEBUG = debugFromQuery === '1' || debugFromStorage === 'true';
        }

        (function configureDebugLogging() {
            const originalLog = console.log.bind(console);
            const originalInfo = console.info ? console.info.bind(console) : originalLog;

            window.setCareConnectDebugLogging = function(enabled) {
                window.DEBUG = Boolean(enabled);
                localStorage.setItem('cc-debug', window.DEBUG ? 'true' : 'false');
            };

            console.log = (...args) => {
                if (window.DEBUG) {
                    originalLog(...args);
                }
            };

            if (console.info) {
                console.info = (...args) => {
                    if (window.DEBUG) {
                        originalInfo(...args);
                    }
                };
            }
        })();

        // One-time cleanup for legacy demo/test localStorage keys
        (function cleanupLegacyDemoKeys() {
            try {
                const legacyPrefixes = ['demo_', 'test_'];
                const legacySubstrings = ['demoClients', 'demoData'];
                const keysToRemove = [];
                
                for (let i = 0; i < localStorage.length; i += 1) {
                    const key = localStorage.key(i);
                    if (!key) continue;
                    if (legacyPrefixes.some(prefix => key.startsWith(prefix)) ||
                        legacySubstrings.some(fragment => key.includes(fragment))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach((key) => localStorage.removeItem(key));
                if (keysToRemove.length > 0) {
                    console.log(`üßπ Removed ${keysToRemove.length} legacy demo keys from localStorage`);
                }
            } catch (error) {
                console.warn('Legacy demo key cleanup skipped:', error);
            }
        })();
        
        // Function to clear all caches and reload
        window.clearCacheAndReload = function() {
            console.log('üßπ Clearing all caches...');
            // Clear IndexedDB
            if ('indexedDB' in window) {
                indexedDB.databases().then(databases => {
                    databases.forEach(db => {
                        indexedDB.deleteDatabase(db.name);
                        console.log('Deleted IndexedDB:', db.name);
                    });
                });
            }
            // Clear localStorage (but preserve login session)
            const sessionKeys = ['isLoggedIn', 'username', 'fullName', 'userRole', 'isMaster', 'loginExpires'];
            const savedSession = {};
            sessionKeys.forEach(key => {
                savedSession[key] = localStorage.getItem(key);
            });
            localStorage.clear();
            // Restore session after clear
            Object.keys(savedSession).forEach(key => {
                if (savedSession[key] !== null) {
                    localStorage.setItem(key, savedSession[key]);
                }
            });
            // Clear service worker cache
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                });
            }
            // Force reload with cache bypass
            window.location.reload(true);
        };
        
        // Function to load script with retry
        function loadScript(src, retries = 3) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${src}?v=${cacheBust}`;
                script.onload = () => {
                    console.log(`‚úÖ Loaded: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    if (retries > 0) {
                        console.warn(`‚ö†Ô∏è Retrying ${src}... (${retries} attempts left)`);
                        setTimeout(() => loadScript(src, retries - 1).then(resolve).catch(reject), 500);
                    } else {
                        console.error(`‚ùå Failed to load: ${src}`);
                        reject(new Error(`Failed to load ${src}`));
                    }
                };
                document.head.appendChild(script);
            });
        }
        
        // Load core scripts
        const scripts = [
            // Feature flags - Admin Command Center for enabling/disabling modules
            'feature-flags.js',
            // 'performance-monitor.js',
            // 'intelligent-matching.js',
            // 'multi-client-workflow.js',
            // 'advanced-filters.js',
            // 'morning-review-dashboard.js',
            
            // ACTIVE FILES:
            // 'indexed-db-manager.js', // DUPLICATE: Already loaded in <head>
            // 'client-manager.js', // DUPLICATE: Already loaded in <head>
            'tracker-engine.js',
            'tracker-timeline.js',
            'tracker-bulk-update.js',
            'tracker-aftercare-cascade.js',
            'discharge-checklist.js',
            'houses-manager.js',
            'milestones-manager.js',
            'aftercare-manager.js',
            'document-generator.js'
        ];
        
        // Load scripts sequentially to ensure proper order
        Promise.all(scripts.map(src => loadScript(src))).then(() => {
            console.log('‚úÖ All core scripts loaded');
            
            // Load dashboard scripts after core scripts
            const dashboardScripts = [
                'dashboard-manager.js',
                'dashboard-widgets.js',
                // 'enhancements/onboarding-integration.js' // REMOVED: Unused
            ];
            return Promise.all(dashboardScripts.map(src => loadScript(src)));
        }).then(() => {
            console.log('‚úÖ All dashboard scripts loaded');
            
            // Make dashboard manager globally available
            if (typeof dashboardManager !== 'undefined') {
                window.dashboardManager = dashboardManager;
            }
            if (typeof dashboardWidgets !== 'undefined') {
                window.dashboardWidgets = dashboardWidgets;
            }
            
            // Handle IndexedDB version errors - Handled gracefully in initializeEnhancedFeatures
            // window.addEventListener('error', function(event) {
            //    if (event.message && event.message.includes('VersionError')) {
            //        console.error('üîÑ IndexedDB version mismatch detected. Please clear cache.');
            //        if (confirm('IndexedDB version mismatch detected. Clear cache and reload?')) {
            //            window.clearCacheAndReload();
            //        }
            //    }
            // });
            
            // Initialize enhanced features now that all scripts are loaded
            return initializeEnhancedFeatures();
        }).catch(error => {
            console.error('‚ùå Script loading error:', error);
        });
    
// Enhancement: global-helpers.js
/**
 * Global Helper Functions for CareConnect Pro
 * Ensures all commonly used functions are available globally
 */

(function() {
    'use strict';
    
    // Ensure window object exists
    if (typeof window === 'undefined') return;
    
    // ============= NOTIFICATION SYSTEM =============
    
    /**
     * Show notification message to user
     * @param {string} message - The message to display
     * @param {string} type - Type of notification: 'success', 'error', 'warning', 'info'
     * @param {string} title - Optional title for the notification
     * @param {number} duration - Duration in milliseconds (default: 3000)
     */
    window.showNotification = window.showNotification || function(message, type = 'info', title = '', duration = 3000) {
        console.log(`[${type.toUpperCase()}] ${title ? title + ': ' : ''}${message}`);
        
        // Remove any existing notification
        const existingNotification = document.querySelector('.global-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `global-notification notification-${type}`;
        
        // Icon mapping
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };
        
        // Build notification HTML
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">${icons[type] || icons.info}</span>
                <div class="notification-text">
                    ${title ? `<strong>${title}</strong><br>` : ''}
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.closest('.global-notification').remove()">√ó</button>
            </div>
        `;
        
        // Add to document
        document.body.appendChild(notification);
        
        // Auto-remove after duration
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('fade-out');
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }
    };
    
    // ============= MODAL SYSTEM =============
    
    const MODAL_CLOSE_SELECTORS = [
        '.global-modal-overlay',
        '.modal-overlay',
        '.tracker-modal-overlay',
        '.timeline-modal-overlay',
        '.document-hub-overlay',
        '.cc-generic-modal',
        '.floating-modal',
        '.modal-backdrop',
        '#globalModal'
    ];
    
    function getAllModalElements() {
        const nodes = [];
        MODAL_CLOSE_SELECTORS.forEach(selector => {
            nodes.push(...document.querySelectorAll(selector));
        });
        return nodes;
    }
    
    function collectModalTargets(target) {
        if (!target) {
            return getAllModalElements();
        }
        if (typeof target === 'string') {
            return Array.from(document.querySelectorAll(target));
        }
        if (target instanceof Element) {
            return [target];
        }
        if (typeof NodeList !== 'undefined' && target instanceof NodeList) {
            return Array.from(target).filter(Boolean);
        }
        if (typeof HTMLCollection !== 'undefined' && target instanceof HTMLCollection) {
            return Array.from(target).filter(Boolean);
        }
        if (Array.isArray(target)) {
            return target.filter(el => el instanceof Element);
        }
        return [];
    }
    
    function removeModalElement(element) {
        if (!element || !element.parentElement) {
            return;
        }
        element.classList?.add?.('fade-out');
        const delay = element.classList?.contains?.('fade-out') ? 180 : 0;
        setTimeout(() => {
            if (element.parentElement) {
                element.remove();
            }
        }, delay);
    }
    
    function uniqueModalElements(elements) {
        const seen = new Set();
        return elements.filter(el => {
            if (!el || !el.isConnected || seen.has(el)) {
                return false;
            }
            seen.add(el);
            return true;
        });
    }
    
    function hasActiveModals() {
        return getAllModalElements().length > 0;
    }
    
    function closePanelsWithEscape() {
        let closed = false;
        
        if (typeof window.toggleMenu === 'function') {
            const menu = document.getElementById('slideMenu');
            if (menu && menu.classList.contains('active')) {
                window.toggleMenu(false);
                closed = true;
            }
        }
        
        if (typeof window.toggleHistory === 'function') {
            const historyPanel = document.getElementById('historyPanel');
            if (historyPanel && historyPanel.classList.contains('open')) {
                window.toggleHistory();
                closed = true;
            }
        }
        
        if (typeof window.closeComparison === 'function') {
            const comparisonView = document.getElementById('comparisonView');
            if (comparisonView && comparisonView.style.display !== 'none') {
                window.closeComparison();
                closed = true;
            }
        }
        
        return closed;
    }
    
    window.handleModalKeydown = window.handleModalKeydown || function handleModalKeydown(event) {
        if (event.key !== 'Escape') {
            return;
        }
        
        if (hasActiveModals()) {
            window.closeModal();
            return;
        }
        
        if (closePanelsWithEscape()) {
            return;
        }
    };
    
    if (!window.__modalKeyListenerBound) {
        document.addEventListener('keydown', window.handleModalKeydown);
        window.__modalKeyListenerBound = true;
    }
    
    /**
     * Close open modal elements
     * @param {Element|string|NodeList|Array} target - Optional target(s) to close
     */
    window.closeModal = function closeModal(target) {
        const elements = uniqueModalElements(collectModalTargets(target));
        if (!elements.length) {
            return;
        }
        elements.reverse().forEach(removeModalElement);
    };
    
    /**
     * Show modal dialog
     * @param {Object} options - Modal configuration
     * @param {string} options.title - Modal title
     * @param {string} options.content - HTML content
     * @param {Array} options.buttons - Array of button objects {text, action, primary}
     * @param {boolean} options.closeOnOverlay - Close when clicking overlay (default: true)
     * @param {string} options.size - Modal size: 'small', 'medium', 'large' (default: 'medium')
     */
    window.showModal = window.showModal || function(options = {}) {
        // Remove any existing modal
        window.closeModal();
        
        // Default options
        const defaults = {
            title: 'Modal',
            content: '',
            buttons: [{text: 'Close', action: () => window.closeModal()}],
            closeOnOverlay: true,
            size: 'medium'
        };
        
        const config = Object.assign({}, defaults, options);
        
        // Create modal elements
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay global-modal-overlay';
        overlay.id = 'globalModal';
        
        const modal = document.createElement('div');
        modal.className = `modal-content global-modal-content modal-${config.size}`;
        
        // Build modal HTML
        modal.innerHTML = `
            <div class="modal-header">
                <h3 class="modal-title">${config.title}</h3>
                <button class="modal-close" onclick="window.closeModal(this.closest('.global-modal-overlay'))">&times;</button>
            </div>
            <div class="modal-body">
                ${config.content}
            </div>
            ${config.buttons.length > 0 ? `
                <div class="modal-footer">
                    ${config.buttons.map(btn => `
                        <button class="btn ${btn.primary ? 'btn-primary' : 'btn-secondary'}" 
                                onclick="(${btn.action.toString()})()">${btn.text}</button>
                    `).join('')}
                </div>
            ` : ''}
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // Close on overlay click if enabled
        if (config.closeOnOverlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    window.closeModal(overlay);
                }
            });
        }
        
        // Focus management
        modal.focus();
        
        // Trap focus within modal
        const focusableElements = modal.querySelectorAll('button, input, select, textarea, a[href]');
        if (focusableElements.length > 0) {
            focusableElements[0].focus();
        }
    };
    
    // ============= NAVIGATION HELPERS =============
    
    /**
     * View client details
     * @param {string|Object} clientOrId - Client ID or client object
     */
    window.viewClientDetails = window.viewClientDetails || async function(clientOrId) {
        try {
            let client;
            
            // Handle both ID and object
            if (typeof clientOrId === 'string') {
                if (!window.clientManager) {
                    window.showNotification('Client manager not available', 'error');
                    return;
                }
                client = await window.clientManager.getClient(clientOrId);
            } else {
                client = clientOrId;
            }
            
            if (!client) {
                window.showNotification('Client not found', 'error');
                return;
            }
            
            // Switch to clients tab
            if (window.switchTab) {
                window.switchTab('clients');
            }
            
            // Show client details after a short delay
            setTimeout(() => {
                if (window.showClientDetailsModal) {
                    window.showClientDetailsModal(client);
                } else {
                    console.log('Client details modal not available, client:', client);
                    window.showNotification(`Viewing client: ${client.initials}`, 'info');
                }
            }, 100);
        } catch (error) {
            console.error('Error viewing client details:', error);
            window.showNotification('Failed to view client details', 'error');
        }
    };
    
    /**
     * Switch to a specific house view
     * @param {string} houseId - House ID to switch to
     */
    window.switchToHouse = window.switchToHouse || async function(houseId) {
        try {
            // Switch to clients tab first
            if (window.switchTab) {
                window.switchTab('clients');
            }
            
            // Wait for tab to load
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Find and click house filter button
            const houseButtons = document.querySelectorAll('.house-filter-btn');
            for (const btn of houseButtons) {
                if (btn.textContent.includes(houseId) || btn.dataset.house === houseId) {
                    btn.click();
                    window.showNotification(`Switched to ${houseId}`, 'success');
                    return;
                }
            }
            
            console.warn('House not found:', houseId);
            window.showNotification(`House ${houseId} not found`, 'warning');
        } catch (error) {
            console.error('Error switching house:', error);
            window.showNotification('Failed to switch house', 'error');
        }
    };
    
    // ============= UTILITY HELPERS =============
    
    /**
     * Debounce function execution
     * @param {Function} func - Function to debounce
     * @param {number} wait - Milliseconds to wait
     * @param {boolean} immediate - Execute immediately
     */
    window.debounce = window.debounce || function(func, wait, immediate) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            const later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };
    
    /**
     * Format date for display
     * @param {string|Date} date - Date to format
     * @param {boolean} includeTime - Include time in format
     */
    window.formatDate = window.formatDate || function(date, includeTime = false) {
        if (!date) return '';
        
        const d = new Date(date);
        if (isNaN(d.getTime())) return '';
        
        const options = {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        };
        
        if (includeTime) {
            options.hour = '2-digit';
            options.minute = '2-digit';
        }
        
        return d.toLocaleDateString('en-US', options);
    };
    
    /**
     * Calculate days between dates
     * @param {string|Date} date1 - First date
     * @param {string|Date} date2 - Second date (defaults to today)
     */
    window.daysBetween = window.daysBetween || function(date1, date2 = new Date()) {
        const d1 = new Date(date1);
        const d2 = new Date(date2);
        const diffTime = Math.abs(d2 - d1);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    };
    
    /**
     * Deep clone an object
     * @param {*} obj - Object to clone
     */
    window.deepClone = window.deepClone || function(obj) {
        if (obj === null || typeof obj !== 'object') return obj;
        if (obj instanceof Date) return new Date(obj.getTime());
        if (obj instanceof Array) return obj.map(item => window.deepClone(item));
        if (obj instanceof Object) {
            const cloned = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    cloned[key] = window.deepClone(obj[key]);
                }
            }
            return cloned;
        }
    };
    
    // ============= STYLES FOR NOTIFICATIONS AND MODALS =============
    
    if (!document.querySelector('#global-helpers-styles')) {
        const styles = document.createElement('style');
        styles.id = 'global-helpers-styles';
        styles.textContent = `
            /* Global Notification Styles */
            .global-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                max-width: 400px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 100000;
                animation: slideInRight 0.3s ease;
                border-left: 4px solid;
            }
            
            .global-notification.fade-out {
                animation: slideOutRight 0.3s ease;
            }
            
            .notification-content {
                display: flex;
                align-items: flex-start;
                padding: 16px;
                gap: 12px;
            }
            
            .notification-icon {
                font-size: 20px;
                flex-shrink: 0;
            }
            
            .notification-text {
                flex: 1;
                font-size: 14px;
                line-height: 1.5;
            }
            
            .notification-close {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                opacity: 0.5;
                transition: opacity 0.2s;
            }
            
            .notification-close:hover {
                opacity: 1;
            }
            
            /* Notification Types */
            .notification-success {
                border-left-color: #22c55e;
            }
            
            .notification-error {
                border-left-color: #ef4444;
            }
            
            .notification-warning {
                border-left-color: #f59e0b;
            }
            
            .notification-info {
                border-left-color: #3b82f6;
            }
            
            /* Global Modal Styles */
            .global-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                animation: fadeIn 0.2s ease;
            }
            
            .global-modal-overlay.fade-out {
                animation: fadeOut 0.2s ease;
            }
            
            .global-modal-content {
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                animation: modalSlideIn 0.3s ease;
            }
            
            .global-modal-content.modal-small {
                width: 400px;
            }
            
            .global-modal-content.modal-medium {
                width: 600px;
            }
            
            .global-modal-content.modal-large {
                width: 800px;
            }
            
            .modal-header {
                padding: 20px;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .modal-title {
                margin: 0;
                font-size: 20px;
                font-weight: 600;
            }
            
            .modal-close {
                background: none;
                border: none;
                font-size: 28px;
                cursor: pointer;
                opacity: 0.5;
                transition: opacity 0.2s;
                line-height: 1;
            }
            
            .modal-close:hover {
                opacity: 1;
            }
            
            .modal-body {
                padding: 20px;
                overflow-y: auto;
                flex: 1;
            }
            
            .modal-footer {
                padding: 20px;
                border-top: 1px solid #e5e7eb;
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            }
            
            /* Animations */
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            @keyframes modalSlideIn {
                from {
                    transform: translateY(-20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(styles);
    }
    
    console.log('‚úÖ Global helpers loaded successfully');
})();





// Enhancement: event-system.js
/**
 * Event System Enhancement
 * Implements a publish-subscribe event system for real-time updates
 */

(function() {
    'use strict';
    
    // Create event bus
    window.eventBus = {
        listeners: new Map(),
        
        /**
         * Subscribe to an event
         * @param {string} eventName - Name of the event
         * @param {Function} callback - Function to call when event fires
         * @param {Object} options - Options for subscription
         * @returns {Function} Unsubscribe function
         */
        on(eventName, callback, options = {}) {
            if (!this.listeners.has(eventName)) {
                this.listeners.set(eventName, new Set());
            }
            
            const listener = {
                callback,
                once: options.once || false,
                priority: options.priority || 0
            };
            
            this.listeners.get(eventName).add(listener);
            
            // Return unsubscribe function
            return () => {
                const listeners = this.listeners.get(eventName);
                if (listeners) {
                    listeners.delete(listener);
                }
            };
        },
        
        /**
         * Subscribe to an event once
         * @param {string} eventName - Name of the event
         * @param {Function} callback - Function to call when event fires
         */
        once(eventName, callback) {
            return this.on(eventName, callback, { once: true });
        },
        
        /**
         * Emit an event
         * @param {string} eventName - Name of the event
         * @param {*} data - Data to pass to listeners
         */
        emit(eventName, data) {
            const listeners = this.listeners.get(eventName);
            if (!listeners || listeners.size === 0) return;
            
            // Convert to array and sort by priority
            const sortedListeners = Array.from(listeners).sort((a, b) => b.priority - a.priority);
            
            sortedListeners.forEach(listener => {
                try {
                    listener.callback(data);
                    
                    // Remove if one-time listener
                    if (listener.once) {
                        listeners.delete(listener);
                    }
                } catch (error) {
                    console.error(`Error in event listener for ${eventName}:`, error);
                }
            });
            
            // Also emit wildcard event
            if (eventName !== '*') {
                this.emit('*', { eventName, data });
            }
        },
        
        /**
         * Remove all listeners for an event
         * @param {string} eventName - Name of the event
         */
        off(eventName) {
            this.listeners.delete(eventName);
        },
        
        /**
         * Get all listeners for an event
         * @param {string} eventName - Name of the event
         * @returns {Set} Set of listeners
         */
        getListeners(eventName) {
            return this.listeners.get(eventName) || new Set();
        }
    };
    
    // Enhance clientManager with events
    function enhanceClientManager() {
        if (!window.clientManager) return;
        
        const originalUpdateClient = window.clientManager.updateClient;
        window.clientManager.updateClient = async function(clientId, updates) {
            const oldClient = await this.getClient(clientId);
            const result = await originalUpdateClient.call(this, clientId, updates);
            const newClient = await this.getClient(clientId);
            
            // Emit update event
            window.eventBus.emit('client:updated', {
                clientId,
                oldData: oldClient,
                newData: newClient,
                changes: updates
            });
            
            // Check for specific tracker updates
            const trackerFields = Object.keys(updates).filter(key => 
                key.includes('Assessment') || 
                key.includes('Doc') || 
                key.includes('Packet') ||
                key.includes('discharge') ||
                key.includes('aftercare')
            );
            
            if (trackerFields.length > 0) {
                window.eventBus.emit('tracker:updated', {
                    clientId,
                    fields: trackerFields,
                    updates
                });
            }
            
            return result;
        };
        
        const originalCreateClient = window.clientManager.createClient;
        window.clientManager.createClient = async function(clientData) {
            const result = await originalCreateClient.call(this, clientData);
            
            // Emit create event
            window.eventBus.emit('client:created', {
                client: result
            });
            
            return result;
        };
        
        const originalDeleteClient = window.clientManager.deleteClient;
        if (originalDeleteClient) {
            window.clientManager.deleteClient = async function(clientId) {
                const client = await this.getClient(clientId);
                const result = await originalDeleteClient.call(this, clientId);
                
                // Emit delete event
                window.eventBus.emit('client:deleted', {
                    clientId,
                    client
                });
                
                return result;
            };
        }
    }
    
    // Subscribe to events for dashboard updates
    function setupDashboardSubscriptions() {
        // Debounce dashboard refresh
        let refreshTimeout;
        const debouncedRefresh = () => {
            clearTimeout(refreshTimeout);
            refreshTimeout = setTimeout(() => {
                if (window.dashboardManager?.refreshDashboard) {
                    window.dashboardManager.refreshDashboard();
                }
            }, 300); // Wait 300ms before refreshing
        };
        
        // Listen for client updates
        window.eventBus.on('client:updated', (data) => {
            console.log('Client updated:', data.clientId);
            
            // Invalidate cache
            if (window.dashboardManager?.cache) {
                delete window.dashboardManager.cache.clients;
                delete window.dashboardManager.cache.priorities;
            }
            
            // Refresh dashboard
            debouncedRefresh();
        });
        
        // Listen for tracker updates
        window.eventBus.on('tracker:updated', (data) => {
            console.log('Tracker updated:', data.clientId, data.fields);
            
            // Update specific widgets if they exist
            if (window.dashboardWidgets?.widgets) {
                const flightPlan = window.dashboardWidgets.widgets.get('flightPlan');
                if (flightPlan?.refresh) {
                    flightPlan.refresh();
                }
                
                const journeyRadar = window.dashboardWidgets.widgets.get('journeyRadar');
                if (journeyRadar?.refresh) {
                    journeyRadar.refresh();
                }
            }
        });
        
        // Listen for document events
        window.eventBus.on('document:generated', (data) => {
            console.log('Document generated:', data.documentType, 'for client:', data.clientId);
            
            // Show success notification
            window.showNotification('Document generated and tracker updated', 'success');
            
            // Update relevant widgets
            debouncedRefresh();
        });
        
        // Listen for all events in dev mode
        if (window.featureFlags && typeof window.featureFlags.isEnabled === 'function' && window.featureFlags.isEnabled('devMode')) {
            window.eventBus.on('*', (event) => {
                console.log(`[Event] ${event.eventName}:`, event.data);
            });
        }
    }
    
    // Enhance widget refresh capabilities
    function enhanceWidgetRefresh() {
        if (!window.dashboardWidgets?.widgets) return;
        
        // Add refresh method to all widgets
        window.dashboardWidgets.widgets.forEach((widget, name) => {
            if (!widget.refresh) {
                widget.refresh = function() {
                    const container = this.container;
                    if (container) {
                        // Re-render the widget
                        container.innerHTML = this.render();
                        console.log(`Refreshed widget: ${name}`);
                    }
                };
            }
        });
    }
    
    // Setup cache invalidation
    window.cacheManager = {
        invalidate(key) {
            if (window.dashboardManager?.cache) {
                if (key) {
                    delete window.dashboardManager.cache[key];
                    console.log(`Cache invalidated: ${key}`);
                } else {
                    // Clear all cache
                    Object.keys(window.dashboardManager.cache).forEach(k => {
                        delete window.dashboardManager.cache[k];
                    });
                    console.log('All cache cleared');
                }
            }
        },
        
        invalidateClient(clientId) {
            // Invalidate specific client-related caches
            this.invalidate('clients');
            this.invalidate('priorities');
            this.invalidate(`client-${clientId}`);
        },
        
        invalidateAll() {
            this.invalidate();
        }
    };
    
    // Listen for cache invalidation events
    window.eventBus.on('cache:invalidate', (data) => {
        window.cacheManager.invalidate(data.key);
    });
    
    window.eventBus.on('cache:invalidateClient', (data) => {
        window.cacheManager.invalidateClient(data.clientId);
    });
    
    function ensureDashboardTheme() {
        const dashboardTab = document.getElementById('dashboardTab');
        if (dashboardTab && dashboardTab.classList.contains('active')) {
            document.body.classList.add('dashboard-active');
            document.body.classList.remove('programs-docs-v2-active');
            document.body.style.background = 'white';
            document.body.style.color = '#1a1a1a';
        }
    }
    window.ensureDashboardTheme = ensureDashboardTheme;
    
    // Add global refresh function
    window.refreshDashboard = function(immediate = false) {
        ensureDashboardTheme();
        if (immediate) {
            window.cacheManager.invalidateAll();
            if (typeof initializeDashboard === 'function') {
                initializeDashboard(true);
            }
        } else {
            window.eventBus.emit('dashboard:refresh');
        }
    };

    // Listen for refresh requests
    let globalRefreshTimeout;
    window.eventBus.on('dashboard:refresh', () => {
        clearTimeout(globalRefreshTimeout);
        globalRefreshTimeout = setTimeout(() => {
            window.cacheManager.invalidateAll();
            if (typeof initializeDashboard === 'function') {
                initializeDashboard(true);
            }
        }, 300);
    });
    
    // Wait for dependencies and initialize
    function initialize() {
        enhanceClientManager();
        setupDashboardSubscriptions();
        enhanceWidgetRefresh();
        
        console.log('‚úÖ Event system initialized');
    }
    
    // Check if dependencies are loaded
    if (window.clientManager && window.dashboardManager) {
        initialize();
    } else {
        // Wait for dependencies
        const checkInterval = setInterval(() => {
            if (window.clientManager && window.dashboardManager) {
                clearInterval(checkInterval);
                initialize();
            }
        }, 100);
        
        // Timeout after 10 seconds
        setTimeout(() => {
            clearInterval(checkInterval);
            console.warn('Event system: Some dependencies not loaded');
            initialize(); // Try anyway
        }, 10000);
    }
    
    // Expose event system info
    window.eventSystemInfo = {
        getEventCount() {
            let count = 0;
            window.eventBus.listeners.forEach(listeners => {
                count += listeners.size;
            });
            return count;
        },
        
        getEvents() {
            return Array.from(window.eventBus.listeners.keys());
        },
        
        debugEvent(eventName) {
            const listeners = window.eventBus.getListeners(eventName);
            console.log(`Event "${eventName}" has ${listeners.size} listeners:`, listeners);
        }
    };
    
})();





// Enhancement: bugfixes.js
// Bugfixes for CareConnect Pro - ES6+ Modernized

console.log('üîß Bugfixes loaded');

// Fix for missing initializeEnhancedFeatures function
window.initializeEnhancedFeatures ??= function initializeEnhancedFeatures() {
    if (window.__enhancedFeaturesPromise) {
        return window.__enhancedFeaturesPromise;
    }
    
    window.__enhancedFeaturesPromise = (async () => {
        console.log('üöÄ Initializing enhanced features...');
        try {
            // Feature flags
            if (typeof FeatureFlagManager !== 'undefined' && !window.featureFlags) {
                window.featureFlags = new FeatureFlagManager();
                console.log('‚úÖ Feature flags initialized');
            }
            
            // Performance monitor
            if (typeof PerformanceMonitor !== 'undefined' && !window.performanceMonitor) {
                window.performanceMonitor = new PerformanceMonitor();
            }
            
            // IndexedDB manager
            if (typeof IndexedDBManager !== 'undefined' && !window.dbManager) {
                const dbManager = new IndexedDBManager();
                try {
                    await dbManager.init();
                } catch (error) {
                    if (error?.name === 'VersionError' && typeof clearIndexedDB === 'function') {
                        console.warn('Database version mismatch, clearing IndexedDB...');
                        await clearIndexedDB();
                        await dbManager.init();
                    } else {
                        throw error;
                    }
                }
                window.dbManager = dbManager;
                console.log('‚úÖ IndexedDB Manager initialized');
            }
            
            if (!window.dbManager) {
                throw new Error('IndexedDB Manager not available');
            }
            
            // Client manager
            if (typeof ClientManager !== 'undefined' && !window.clientManager) {
                window.clientManager = new ClientManager(window.dbManager);
                if (typeof window.clientManager.initialize === 'function') {
                    await window.clientManager.initialize();
                }
                console.log('‚úÖ ClientManager initialized');
            }
            
            // Houses manager
            if (typeof HousesManager !== 'undefined' && !window.housesManager) {
                const housesManager = new HousesManager(window.dbManager);
                if (typeof housesManager.initialize === 'function') {
                    await housesManager.initialize();
                }
                window.housesManager = housesManager;
            }
            
            // Milestones manager
            if (typeof MilestonesManager !== 'undefined' && !window.milestonesManager) {
                const milestonesManager = new MilestonesManager(window.dbManager);
                if (typeof milestonesManager.initialize === 'function') {
                    await milestonesManager.initialize();
                }
                window.milestonesManager = milestonesManager;
            }
            
            // Aftercare manager
            if (typeof AftercareManager !== 'undefined' && !window.aftercareManager) {
                const aftercareManager = new AftercareManager(window.dbManager);
                if (typeof aftercareManager.initialize === 'function') {
                    await aftercareManager.initialize();
                }
                window.aftercareManager = aftercareManager;
            }
            
            // Dashboard manager
            if (typeof DashboardManager !== 'undefined' && !window.dashboardManager) {
                window.dashboardManager = new DashboardManager();
                if (typeof window.dashboardManager.initialize === 'function') {
                    await window.dashboardManager.initialize();
                }
            }
            
            console.log('‚úÖ Enhanced features initialized');
        } catch (error) {
            console.error('‚ùå Failed to initialize enhanced features:', error);
            throw error;
        }
    })();
    
    return window.__enhancedFeaturesPromise;
};

// Fix for database initialization issues
document.addEventListener('DOMContentLoaded', () => {
    // Ensure programs are loaded
    if (!window.programs?.length) {
        console.warn('‚ö†Ô∏è Programs not loaded, attempting to initialize...');
        
        // Check again after a delay
        setTimeout(() => {
            if (!window.programs?.length) {
                console.error('‚ùå Programs still not loaded - check main HTML file');
            } else {
                console.log('‚úÖ Programs loaded:', window.programs.length, 'programs');
            }
        }, 1000);
    } else {
        console.log('‚úÖ Programs already loaded:', window.programs.length, 'programs');
    }
    
    // Fix for dashboard not showing
    const dashboardTab = document.getElementById('dashboardTab');
    if (dashboardTab?.style.display === 'none') {
        console.log('üîß Fixing hidden dashboard tab');
        dashboardTab.style.display = '';
    }
});

// Fix for Chrome extension file:// protocol issues
if (window.location.protocol === 'file:') {
    // Disable service worker registration for file protocol
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register = () => {
            console.log('Service Worker registration disabled for file:// protocol');
            return Promise.reject(new Error('Service Worker not supported on file:// protocol'));
        };
    }
}

// Login screen visibility is now managed entirely by login-robust.js
// Removed conflicting ensureLoginScreenVisible function to prevent conflicts

console.log('‚úÖ Bugfixes applied');

// Enhancement: features.js

// Custom Features - Add your custom JavaScript here

// Example: Add a custom keyboard shortcut
/*
document.addEventListener('keydown', function(e) {
    // Ctrl+Shift+S to quick save
    if (e.ctrlKey && e.shiftKey && e.key === 'S') {
        e.preventDefault();
        console.log('Quick save triggered!');
        // Add your save logic here
    }
});
*/

// Example: Add custom logging
console.log('CareConnect Pro - Enhanced Version Loaded');


// Enhancement: coach-profiles.js
// Enhanced Coach Profile System for CareConnect Pro - ES6+ Modernized
// Links user accounts to coach profiles with caseload management

(() => {
    'use strict';
    
    console.log('üë• Coach Profile Enhancement loaded');
    
    // Coach profile storage key
    const COACH_PROFILES_KEY = 'careconnect_coach_profiles';
    
    // Coach profile management
    const CoachProfiles = {
        // Get all coach profiles
        getAll() {
            const stored = localStorage.getItem(COACH_PROFILES_KEY);
            return stored ? JSON.parse(stored) : {};
        },
        
        // Save coach profiles
        saveAll(profiles) {
            localStorage.setItem(COACH_PROFILES_KEY, JSON.stringify(profiles));
        },
        
        // Create or update coach profile
        update(username, profileData) {
            const profiles = this.getAll();
            profiles[username] = {
                ...profiles[username],
                ...profileData,
                lastUpdated: new Date().toISOString()
            };
            this.saveAll(profiles);
            return profiles[username];
        },
        
        // Get coach profile for username
        get(username) {
            const profiles = this.getAll();
            return profiles[username] || null;
        }
    };
    
    // Generate initials from name
    const generateInitials = (name, max = 2) => {
        if (!name) return '';
        
        const parts = name.trim().split(/\s+/);
        return parts
            .map(part => part[0]?.toUpperCase() || '')
            .filter(Boolean)
            .slice(0, max)
            .join('') || name.substring(0, 2).toUpperCase();
    };
    
    // Enhanced getCurrentCoach that uses actual user data
    window.getEnhancedCurrentCoach = () => {
        const username = localStorage.getItem('username');
        const fullName = localStorage.getItem('fullName');
        const userRole = localStorage.getItem('userRole') || 'coach';
        const isMaster = localStorage.getItem('isMaster') === 'true';
        
        // Get stored profile
        let profile = CoachProfiles.get(username);
        
        // If no profile exists, create default from session data
        if (!profile && username) {
            profile = CoachProfiles.update(username, {
                username,
                fullName: fullName || username,
                initials: generateInitials(fullName || username),
                role: userRole,
                isAdmin: userRole === 'admin' || isMaster,
                department: '',
                phoneExtension: '',
                specializations: [],
                maxCaseload: 12,
                currentCaseload: 0
            });
        }
        
        return profile || {
            username: 'guest',
            fullName: 'Guest User',
            initials: 'GU',
            role: 'viewer',
            isAdmin: false
        };
    };
    
    // Enhanced profile setup dialog
    window.showCoachProfileSetup = (isFirstTime = false) => {
        const currentProfile = window.getEnhancedCurrentCoach();
        
        const dialogHtml = `
            <div class="modal-overlay" id="coachProfileModal">
                <div class="modal-content" style="max-width: 500px;">
                    <h2 style="margin-bottom: 20px;">
                        ${isFirstTime ? 'üëã Complete Your Coach Profile' : '‚öôÔ∏è Update Coach Profile'}
                    </h2>
                    
                    ${isFirstTime ? `
                        <p style="color: #666; margin-bottom: 20px;">
                            Let's set up your coach profile to personalize your experience and manage your caseload effectively.
                        </p>
                    ` : ''}
                    
                    <form id="coachProfileForm">
                        <div class="form-group">
                            <label>Full Name <span class="required">*</span></label>
                            <input type="text" id="profileFullName" value="${currentProfile.fullName}" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Coach Initials <span class="required">*</span></label>
                            <input type="text" id="profileInitials" value="${currentProfile.initials}" maxlength="3" required 
                                style="text-transform: uppercase;" placeholder="e.g., JD">
                            <small>Used to identify your clients in the system</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Department</label>
                            <select id="profileDepartment">
                                <option value="">Select Department</option>
                                <option value="clinical" ${currentProfile.department === 'clinical' ? 'selected' : ''}>Clinical</option>
                                <option value="residential" ${currentProfile.department === 'residential' ? 'selected' : ''}>Residential</option>
                                <option value="education" ${currentProfile.department === 'education' ? 'selected' : ''}>Education</option>
                                <option value="admin" ${currentProfile.department === 'admin' ? 'selected' : ''}>Administration</option>
                                <option value="support" ${currentProfile.department === 'support' ? 'selected' : ''}>Support Services</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Extension</label>
                            <input type="text" id="profileExtension" value="${currentProfile.phoneExtension || ''}" 
                                placeholder="e.g., 1234" maxlength="10">
                        </div>
                        
                        <div class="form-group">
                            <label>Role</label>
                            <select id="profileRole">
                                <option value="coach" ${currentProfile.role === 'coach' ? 'selected' : ''}>Coach</option>
                                <option value="supervisor" ${currentProfile.role === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                                <option value="admin" ${currentProfile.role === 'admin' ? 'selected' : ''}>Administrator</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Max Caseload</label>
                            <input type="number" id="profileMaxCaseload" value="${currentProfile.maxCaseload || 12}" 
                                min="1" max="50" required>
                            <small>Maximum number of clients you can manage</small>
                        </div>
                        
                        <div class="button-group" style="margin-top: 30px;">
                            <button type="submit" class="primary-button" style="flex: 1;">
                                ${isFirstTime ? 'Create Profile' : 'Update Profile'}
                            </button>
                            ${!isFirstTime ? `
                                <button type="button" onclick="closeCoachProfileModal()" class="secondary-button">
                                    Cancel
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Add dialog to page
        const existingModal = document.getElementById('coachProfileModal');
        existingModal?.remove();
        
        document.body.insertAdjacentHTML('beforeend', dialogHtml);
        
        // Handle form submission
        document.getElementById('coachProfileForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const username = localStorage.getItem('username');
            const profileData = {
                username,
                fullName: document.getElementById('profileFullName').value,
                initials: document.getElementById('profileInitials').value.toUpperCase(),
                role: document.getElementById('profileRole').value,
                department: document.getElementById('profileDepartment').value,
                phoneExtension: document.getElementById('profileExtension').value,
                maxCaseload: parseInt(document.getElementById('profileMaxCaseload').value),
                isAdmin: document.getElementById('profileRole').value === 'admin'
            };
            
            // Update profile
            CoachProfiles.update(username, profileData);
            
            // Update session storage
            localStorage.setItem('fullName', profileData.fullName);
            localStorage.setItem('userRole', profileData.role);
            
            // Show success message
            showNotification('Profile updated successfully!', 'success');
            
            // Close modal
            closeCoachProfileModal();
            
            // Refresh any UI elements that display coach info
            const coachDisplay = document.querySelector('.coach-info, .user-info');
            if (coachDisplay) {
                coachDisplay.textContent = `${profileData.fullName} (${profileData.initials})`;
            }
            
            // If first time, trigger any onboarding completion
            if (isFirstTime && window.onCoachProfileComplete) {
                window.onCoachProfileComplete();
            }
        };
    };
    
    // Close modal function
    window.closeCoachProfileModal = () => {
        const modal = document.getElementById('coachProfileModal');
        modal?.remove();
    };
    
    // Override getCurrentCoach if it exists
    if (typeof window.getCurrentCoach === 'function') {
        window._originalGetCurrentCoach = window.getCurrentCoach;
    }
    window.getCurrentCoach = window.getEnhancedCurrentCoach;
    
    // Add coach indicator to clients
    const enhanceClientDisplay = () => {
        const clients = document.querySelectorAll('.client-row, .client-card, .client-item');
        const currentCoach = window.getEnhancedCurrentCoach();
        
        clients.forEach(client => {
            const initials = client.dataset.clientInitials || client.textContent.match(/^([A-Z]{2,3})\s-/)?.[1];
            
            if (initials === currentCoach.initials) {
                client.classList.add('my-client');
                
                if (!client.querySelector('.coach-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'coach-indicator';
                    indicator.innerHTML = 'üë§';
                    indicator.title = 'Your Client';
                    client.appendChild(indicator);
                }
            }
        });
    };
    
    // Add profile button to UI
    const addProfileButton = () => {
        const userInfo = document.querySelector('.user-info, .header-right, .nav-right');
        if (!userInfo || document.getElementById('profileSettingsBtn')) return;
        
        const profileBtn = document.createElement('button');
        profileBtn.id = 'profileSettingsBtn';
        profileBtn.className = 'profile-settings-btn';
        profileBtn.innerHTML = 'üë§ Profile';
        profileBtn.onclick = () => window.showCoachProfileSetup(false);
        userInfo.appendChild(profileBtn);
    };
    
    // Show notification
    const showNotification = (message, type = 'info') => {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    };
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        // Add profile button
        setTimeout(addProfileButton, 1000);
        
        // Enhance client displays
        setTimeout(enhanceClientDisplay, 1500);
        
        // Check if first-time setup needed - but only when explicitly triggered
        const username = localStorage.getItem('username');
        if (username && !CoachProfiles.get(username)) {
            console.log('Coach profile not found for:', username, '- will create when requested');
        }
    });
    
    // Re-enhance on dynamic content changes
    if (window.MutationObserver) {
        const observer = new MutationObserver(() => {
            enhanceClientDisplay();
        });
        
        const waitForBody = () => {
            const target = document.body;
            if (!target) {
                setTimeout(waitForBody, 50);
                return;
            }
            observer.observe(target, {
                childList: true,
                subtree: true
            });
        };

        waitForBody();
    }
    
    // Export functions for external use
    window.CoachProfiles = {
        get: username => CoachProfiles.get(username),
        update: (username, data) => CoachProfiles.update(username, data),
        getAll: () => CoachProfiles.getAll(),
        showSetup: (isFirstTime) => window.showCoachProfileSetup(isFirstTime)
    };
    
    console.log('‚úÖ Coach Profile Enhancement ready');
})();

// Enhancement: login-fix.js
// Fix for login screen not showing

console.log('üîê Login fix applied');

// Simple proxy for handleLogin - ensures form's onsubmit works before login-robust.js loads
// login-robust.js will replace this with the full implementation
(function() {
    'use strict';
    
    // If handleLogin already exists and is not our proxy, don't override
    if (typeof window.handleLogin === 'function' && !window.handleLogin.__isProxy) {
        return;
    }
    
    // Create a simple proxy that queues calls until login-robust.js loads
    const proxyQueue = [];
    const proxyHandleLogin = function(event) {
        // If login-robust.js has loaded and set the real handleLogin, use it
        if (typeof window.CareConnectAuth !== 'undefined' && 
            typeof window.handleLogin === 'function' && 
            window.handleLogin !== proxyHandleLogin &&
            !window.handleLogin.__isProxy) {
            return window.handleLogin(event);
        }
        
        // Otherwise, prevent default and queue the call
        if (event && typeof event.preventDefault === 'function') {
            event.preventDefault();
        }
        
        // Queue for when login-robust.js loads
        proxyQueue.push({ event, timestamp: Date.now() });
        
        // Try to initialize login system if it hasn't loaded yet
        if (typeof window.CareConnectAuth === 'undefined') {
            console.log('‚è≥ Login system loading, queuing login attempt...');
        }
        
        return false;
    };
    
    proxyHandleLogin.__isProxy = true;
    proxyHandleLogin.__queue = proxyQueue;
    
    window.handleLogin = proxyHandleLogin;
    
    // Process queued calls when login-robust.js loads
    const checkForLoginSystem = setInterval(() => {
        if (typeof window.CareConnectAuth !== 'undefined' && 
            typeof window.handleLogin === 'function' && 
            window.handleLogin !== proxyHandleLogin &&
            !window.handleLogin.__isProxy) {
            clearInterval(checkForLoginSystem);
            // Process queued calls
            proxyQueue.forEach(({ event }) => {
                try {
                    window.handleLogin(event);
                } catch (err) {
                    console.error('Queued login call failed:', err);
                }
            });
            proxyQueue.length = 0;
        }
    }, 100);
    
    // Stop checking after 10 seconds
    setTimeout(() => clearInterval(checkForLoginSystem), 10000);
})();


// Enhancement: tracker-ui.js
/**
 * Tracker UI Enhancements
 * Adds completion indicators and tracker intelligence to dashboard
 */

(function() {
    'use strict';
    
    console.log('[TrackerUI] Initializing tracker UI enhancements...');
    
    // Wait for dependencies
    const waitForDependencies = () => {
        return new Promise((resolve) => {
            const checkInterval = setInterval(() => {
                if (window.trackerEngine && window.dashboardManager) {
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 100);
        });
    };
    
    // Enhance client card with tracker completion
    const enhanceClientCard = (card, client) => {
        // Check if already enhanced
        if (card.querySelector('.tracker-status')) return;
        
        // Get completion score
        const score = window.trackerEngine.getCompletionScore(client);
        
        // Create tracker status element
        const trackerStatus = document.createElement('div');
        trackerStatus.className = 'tracker-status';
        trackerStatus.innerHTML = `
            <div class="tracker-completion">
                <div class="completion-bar">
                    <div class="completion-fill" style="width: ${score.overallPercentage}%"></div>
                </div>
                <div class="completion-text">
                    <span class="completion-percentage">üìä Chart: ${score.overallPercentage}% Complete</span>
                    ${score.missingCritical.length > 0 ? 
                        `<span class="critical-missing">‚ö†Ô∏è ${score.missingCritical.length} critical items missing</span>` : 
                        ''
                    }
                </div>
            </div>
            ${score.missingCritical.length > 0 ? 
                `<div class="missing-items">
                    Missing: ${score.missingCritical.slice(0, 3).map(item => item.label).join(', ')}
                    ${score.missingCritical.length > 3 ? ` +${score.missingCritical.length - 3} more` : ''}
                </div>` : 
                ''
            }
        `;
        
        // Add risk level class
        trackerStatus.classList.add(`risk-${score.riskLevel}`);
        
        // Find insertion point (after client info, before actions)
        const clientInfo = card.querySelector('.client-info');
        if (clientInfo && clientInfo.nextSibling) {
            clientInfo.parentNode.insertBefore(trackerStatus, clientInfo.nextSibling);
        } else {
            card.appendChild(trackerStatus);
        }
        
        // Add click handler for detailed view
        trackerStatus.addEventListener('click', (e) => {
            e.stopPropagation();
            showTrackerDetails(client);
        });
    };
    
    // Show detailed tracker modal
    const showTrackerDetails = (client) => {
        const score = window.trackerEngine.getCompletionScore(client);
        const upcoming = window.trackerEngine.getUpcomingDeadlines(client);
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'tracker-modal-overlay';
        modal.innerHTML = `
            <div class="tracker-modal">
                <div class="tracker-modal-header">
                    <h3>Tracker Status: ${client.initials}</h3>
                    <button class="close-btn" onclick="window.closeModal(this.closest('.tracker-modal-overlay'))">√ó</button>
                </div>
                <div class="tracker-modal-content">
                    <div class="tracker-summary">
                        <div class="summary-stat">
                            <span class="stat-label">Overall</span>
                            <span class="stat-value">${score.overallPercentage}%</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Critical</span>
                            <span class="stat-value">${score.criticalPercentage}%</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Complete</span>
                            <span class="stat-value">${score.completedItems}/${score.totalItems}</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Days to Discharge</span>
                            <span class="stat-value">${score.daysToDischarge}</span>
                        </div>
                    </div>
                    
                    ${score.missingCritical.length > 0 ? `
                        <div class="missing-critical-section">
                            <h4>‚ö†Ô∏è Missing Critical Items</h4>
                            <ul class="missing-list">
                                ${score.missingCritical.map(item => `
                                    <li class="missing-item">
                                        <span class="item-label">${item.label}</span>
                                        <span class="item-due">Due by day ${item.dueByDay}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${upcoming.length > 0 ? `
                        <div class="upcoming-section">
                            <h4>üìÖ Upcoming Deadlines</h4>
                            <ul class="upcoming-list">
                                ${upcoming.map(item => `
                                    <li class="upcoming-item">
                                        <span class="item-label">${item.label}</span>
                                        <span class="item-due">Due in ${item.daysUntilDue} days</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="tracker-actions">
                        <button class="btn-primary" onclick="openBulkUpdate('${client.id}')">Quick Update</button>
                        <button class="btn-secondary" onclick="generateTrackerTasks('${client.id}')">Generate Tasks</button>
                        <button class="btn-secondary" onclick="openTrackerTimeline('${client.id}')">View Timeline</button>
                        <button class="btn-secondary" onclick="aftercareCascade.open('${client.id}')">Aftercare Options</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close on overlay click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    };
    
    // Intercept dashboard rendering to enhance cards
    const interceptDashboardRender = () => {
        const originalRenderClients = window.dashboardManager.renderClients;
        
        window.dashboardManager.renderClients = async function(clients, container) {
            // Call original render
            await originalRenderClients.call(this, clients, container);
            
            // Enhance each card
            const cards = container.querySelectorAll('.client-card');
            cards.forEach((card, index) => {
                if (clients[index]) {
                    enhanceClientCard(card, clients[index]);
                }
            });
        };
    };
    
    // Add tracker tasks to flight plan
    const enhanceFlightPlan = () => {
        const originalLoadPriorities = window.dashboardManager.loadPriorities;
        
        window.dashboardManager.loadPriorities = async function() {
            // Call original
            const priorities = await originalLoadPriorities.call(this);
            
            // Add tracker-generated tasks
            try {
                const clients = await this.getRelevantClients();
                const trackerTasks = [];
                
                for (const client of clients) {
                    const tasks = window.trackerEngine.generateTasksFromGaps(client);
                    trackerTasks.push(...tasks);
                }
                
                // Merge tracker tasks into priorities
                for (const task of trackerTasks) {
                    let zone = 'green';
                    if (task.priority === 'critical') zone = 'red';
                    else if (task.priority === 'high') zone = 'purple';
                    else if (task.priority === 'medium') zone = 'yellow';
                    
                    const item = {
                        type: task.type,
                        client: {
                            id: task.clientId,
                            initials: task.clientInitials,
                            houseId: task.houseId
                        },
                        message: task.title,
                        action: 'Mark Complete',
                        dueDate: task.dueDate,
                        trackerId: task.trackerId,
                        autoGenerated: true,
                        isTrackerTask: true  // Flag to identify tracker tasks
                    };
                    
                    if (!priorities[zone]) priorities[zone] = [];
                    priorities[zone].push(item);
                }
                
                return priorities;
            } catch (error) {
                console.error('[TrackerUI] Error generating tracker tasks:', error);
                return priorities;
            }
        };
    };
    
    // Global functions for modal actions
    window.openBulkUpdate = async (clientId) => {
        // This will be implemented in the bulk update phase
        console.log('[TrackerUI] Bulk update requested for client:', clientId);
        alert('Bulk update feature coming soon!');
    };
    
    window.openTrackerTimeline = async (clientId) => {
        try {
            const client = await window.clientManager.getClient(clientId);
            
            // Create timeline modal
            const modal = document.createElement('div');
            modal.className = 'tracker-modal-overlay timeline-modal-overlay';
            modal.innerHTML = `
                <div class="tracker-modal timeline-modal-large">
                    <div class="tracker-modal-header">
                        <h3>Tracker Timeline</h3>
                        <button class="close-btn" onclick="window.closeModal(this.closest('.tracker-modal-overlay'))">√ó</button>
                    </div>
                    <div class="tracker-modal-content">
                        <div id="timeline-container"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Render timeline
            const container = modal.querySelector('#timeline-container');
            if (window.trackerTimeline) {
                await window.trackerTimeline.render(client, container);
            } else {
                container.innerHTML = '<p>Timeline component not loaded</p>';
            }
            
            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
        } catch (error) {
            console.error('[TrackerUI] Error opening timeline:', error);
            alert('Error loading timeline. Check console for details.');
        }
    };
    
    window.generateTrackerTasks = async (clientId) => {
        try {
            const client = await window.clientManager.getClient(clientId);
            const tasks = window.trackerEngine.generateTasksFromGaps(client);
            
            if (tasks.length === 0) {
                alert('No tasks to generate - all requirements are on track!');
                return;
            }
            
            // Create tasks using task manager
            for (const task of tasks) {
                await window.taskManager.createTask({
                    title: task.title,
                    description: task.description,
                    priority: task.priority,
                    dueDate: task.dueDate,
                    category: 'tracker-generated',
                    clientId: task.clientId,
                    metadata: {
                        trackerId: task.trackerId,
                        autoGenerated: true
                    }
                });
            }
            
            alert(`Generated ${tasks.length} tasks from tracker gaps`);
            
            // Refresh dashboard
            if (window.dashboardManager.loadData) {
                await window.dashboardManager.loadData();
            }
            
            // Close modal
            const modal = document.querySelector('.tracker-modal-overlay');
            if (modal) modal.remove();
            
        } catch (error) {
            console.error('[TrackerUI] Error generating tasks:', error);
            alert('Error generating tasks. Check console for details.');
        }
    };
    
    // Initialize enhancements
    const initialize = async () => {
        console.log('[TrackerUI] Waiting for dependencies...');
        await waitForDependencies();
        
        console.log('[TrackerUI] Enhancing dashboard...');
        interceptDashboardRender();
        enhanceFlightPlan();
        
        // Trigger re-render if dashboard is already loaded
        if (window.dashboardManager.initialized) {
            console.log('[TrackerUI] Refreshing dashboard with tracker enhancements...');
            await window.dashboardManager.loadData();
        }
        
        console.log('[TrackerUI] Tracker UI enhancements ready');
    };
    
    // Start initialization
    initialize();
    
})();


// Enhancement: tracker-compliance-widget.js
/**
 * Tracker Compliance Dashboard Widget
 * House-level view of tracker completion across all clients
 */

(function() {
    'use strict';
    
    console.log('[ComplianceWidget] Initializing compliance widget...');
    
    // Compliance Widget Class
    class ComplianceWidget {
        constructor(container) {
            this.container = container;
            this.initialized = false;
            this.data = null;
        }
        
        async render() {
            if (!window.trackerEngine) {
                this.container.innerHTML = '<div class="widget-error">Tracker engine not loaded</div>';
                return;
            }
            
            try {
                // Get all clients grouped by house
                const clientsByHouse = await this.getClientsByHouse();
                
                // Calculate compliance for each house
                const houseStats = [];
                for (const [houseId, clients] of Object.entries(clientsByHouse)) {
                    if (clients.length > 0) {
                        const stats = window.trackerEngine.getHouseCompliance(clients);
                        houseStats.push(stats);
                    }
                }
                
                // Calculate overall compliance
                const overallStats = this.calculateOverallStats(houseStats);
                
                // Render the widget
                this.container.innerHTML = `
                    <div class="compliance-widget">
                        <div class="widget-header">
                            <h3>üìä Tracker Compliance</h3>
                            <button class="refresh-btn" onclick="dashboardWidgets.widgets.get('compliance')?.render()">
                                <span class="refresh-icon">‚Üª</span>
                            </button>
                        </div>
                        
                        <div class="compliance-overview">
                            <div class="overall-score">
                                <div class="score-circle" style="--percentage: ${overallStats.overall}">
                                    <svg viewBox="0 0 36 36" class="circular-chart">
                                        <path class="circle-bg"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        />
                                        <path class="circle"
                                            stroke-dasharray="${overallStats.overall}, 100"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        />
                                    </svg>
                                    <div class="percentage">
                                        <span class="value">${overallStats.overall}%</span>
                                        <span class="label">Overall</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="compliance-metrics">
                                <div class="metric">
                                    <span class="metric-value">${overallStats.critical}%</span>
                                    <span class="metric-label">Critical Items</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">${overallStats.atRisk}</span>
                                    <span class="metric-label">At Risk Clients</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">${overallStats.strong}</span>
                                    <span class="metric-label">Strong Performers</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="house-compliance-list">
                            ${houseStats.map(stats => this.renderHouseCard(stats)).join('')}
                        </div>
                        
                        ${overallStats.atRiskDetails.length > 0 ? `
                            <div class="at-risk-section">
                                <h4>‚ö†Ô∏è Immediate Attention Required</h4>
                                <div class="at-risk-list">
                                    ${overallStats.atRiskDetails.map(client => `
                                        <div class="at-risk-item">
                                            <span class="client-info">${client.message}</span>
                                            <button class="action-btn" onclick="openBulkUpdate('${client.client.id}')">
                                                Update
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
            } catch (error) {
                console.error('[ComplianceWidget] Render error:', error);
                this.container.innerHTML = '<div class="widget-error">Failed to load compliance data</div>';
            }
        }
        
        renderHouseCard(stats) {
            const riskClass = stats.overallCompliance >= 80 ? 'good' : 
                             stats.overallCompliance >= 60 ? 'warning' : 'danger';
            
            return `
                <div class="house-card ${riskClass}">
                    <div class="house-header">
                        <h4>${stats.houseId}</h4>
                        <span class="house-score">${stats.overallCompliance}%</span>
                    </div>
                    <div class="house-details">
                        <div class="detail-row">
                            <span>Clients:</span>
                            <span>${stats.totalClients}</span>
                        </div>
                        <div class="detail-row">
                            <span>Critical:</span>
                            <span>${stats.criticalCompliance}%</span>
                        </div>
                        <div class="detail-row">
                            <span>At Risk:</span>
                            <span class="${stats.atRiskClients.length > 0 ? 'text-danger' : ''}">${stats.atRiskClients.length}</span>
                        </div>
                    </div>
                    <div class="category-breakdown">
                        ${Object.entries(stats.byCategory).map(([cat, data]) => `
                            <div class="category-bar">
                                <div class="cat-label">${this.getCategoryLabel(cat)}</div>
                                <div class="cat-progress">
                                    <div class="cat-fill" style="width: ${data.percentage}%"></div>
                                </div>
                                <div class="cat-value">${data.percentage}%</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        getCategoryLabel(category) {
            const labels = {
                admission: 'Admission',
                clinical: 'Clinical',
                aftercare: 'Aftercare',
                documentation: 'Docs'
            };
            return labels[category] || category;
        }
        
        async getClientsByHouse() {
            let clients = [];
            
            // Prefer the same data pipeline the main dashboard uses
            if (window.dashboardManager?.getRelevantClients) {
                try {
                    clients = await window.dashboardManager.getRelevantClients();
                } catch (err) {
                    console.warn('[ComplianceWidget] Falling back to clientManager.getAllClients()', err);
                }
            }
            
            // Fallback if dashboardManager path fails
            if ((!clients || clients.length === 0) && window.clientManager?.getAllClients) {
                clients = await window.clientManager.getAllClients();
            }
            
            if (!Array.isArray(clients) || clients.length === 0) {
                return {};
            }
            
            const activeClients = clients.filter(c => c.status === 'active');
            
            const byHouse = {};
            activeClients.forEach(client => {
                const house = client.houseId || 'Unassigned';
                if (!byHouse[house]) byHouse[house] = [];
                byHouse[house].push(client);
            });
            
            return byHouse;
        }
        
        calculateOverallStats(houseStats) {
            let totalCompliance = 0;
            let totalCritical = 0;
            let totalAtRisk = 0;
            let totalStrong = 0;
            let allAtRisk = [];
            
            houseStats.forEach(stats => {
                totalCompliance += stats.overallCompliance;
                totalCritical += stats.criticalCompliance;
                totalAtRisk += stats.atRiskClients.length;
                totalStrong += stats.strongClients.length;
                allAtRisk.push(...stats.atRiskClients);
            });
            
            const houseCount = houseStats.length || 1;
            
            return {
                overall: Math.round(totalCompliance / houseCount),
                critical: Math.round(totalCritical / houseCount),
                atRisk: totalAtRisk,
                strong: totalStrong,
                atRiskDetails: allAtRisk.slice(0, 5) // Top 5 most at risk
            };
        }
    }
    
    // Wait for dependencies and inject widget
    const injectComplianceWidget = () => {
        const checkInterval = setInterval(() => {
            if (window.dashboardWidgets && window.trackerEngine && window.clientManager) {
                clearInterval(checkInterval);
                
                // Find or create container for compliance widget
                let container = document.querySelector('.compliance-widget-container');
                if (!container) {
                    const dashboardContainer = document.querySelector('.dashboard-container');
                    const mainGrid = dashboardContainer?.querySelector('.dashboard-main-grid');
                    
                    if (dashboardContainer) {
                        container = document.createElement('div');
                        container.className = 'widget-container compliance-widget-container';
                        
                        // Insert as a full-width section directly below the main grid
                        if (mainGrid && mainGrid.parentElement) {
                            mainGrid.parentElement.insertBefore(container, mainGrid.nextSibling);
                        } else {
                            dashboardContainer.appendChild(container);
                        }
                    }
                }
                
                if (container) {
                    // Create and register widget
                    const complianceWidget = new ComplianceWidget(container);
                    window.dashboardWidgets.widgets.set('compliance', complianceWidget);
                    
                    // Initial render
                    complianceWidget.render();
                    
                    console.log('[ComplianceWidget] Widget injected and rendered');
                } else {
                    console.warn('[ComplianceWidget] Could not find suitable container');
                }
            }
        }, 100);
    };
    
    // Start injection process
    injectComplianceWidget();
    
})();


// Enhancement: tracker-document-hub.js
/**
 * Tracker Document Hub Enhancement
 * Visual status indicators and centralized document tracking
 */

(function() {
    'use strict';
    
    console.log('[DocumentHub] Initializing document hub enhancements...');
    
    // Document definitions with metadata
    const documentDefinitions = [
        {
            id: 'needsAssessment',
            category: 'admission',
            label: 'Needs Assessment',
            required: true,
            dueByDay: 2,
            template: true
        },
        {
            id: 'healthPhysical',
            category: 'admission',
            label: 'Health & Physical',
            required: true,
            dueByDay: 2,
            template: true
        },
        {
            id: 'optionsDoc',
            category: 'aftercare',
            label: 'Aftercare Options Document',
            required: true,
            dueByDay: 21,
            template: true,
            requiresSignature: true
        },
        {
            id: 'dischargePacket',
            category: 'aftercare',
            label: 'Discharge Packet',
            required: true,
            dueByDay: 25,
            multipart: true
        },
        {
            id: 'dischargeSummary',
            category: 'discharge',
            label: 'Discharge Summary',
            required: true,
            dueByDay: 28,
            template: true
        },
        {
            id: 'dischargePlanningNote',
            category: 'discharge',
            label: 'Discharge Planning Note',
            required: true,
            dueByDay: 26,
            template: true
        },
        {
            id: 'dischargeASAM',
            category: 'discharge',
            label: 'Discharge ASAM',
            required: true,
            dueByDay: 28,
            template: false
        },
        {
            id: 'satisfactionSurvey',
            category: 'feedback',
            label: 'Satisfaction Survey',
            required: false,
            dueByDay: 25,
            template: true
        }
    ];
    
    // Document Hub Class
    class DocumentHub {
        constructor() {
            this.currentClient = null;
            this.initialized = false;
        }
        
        /**
         * Get document status for a client
         */
        getDocumentStatus(client, docDef) {
            const fieldName = docDef.id === 'optionsDoc' ? 'optionsDocUploaded' : 
                             docDef.id === 'dischargePacket' ? 'dischargePacketUploaded' :
                             docDef.id;
            
            const isComplete = client[fieldName];
            const completedDate = client[fieldName + 'Date'];
            const daysInCare = this.calculateDaysInCare(client.admissionDate);
            const daysToDischarge = this.calculateDaysToDischarge(client);
            
            let status = 'pending';
            let statusMessage = '';
            
            if (isComplete) {
                status = 'complete';
                statusMessage = completedDate ? 
                    `Completed ${new Date(completedDate).toLocaleDateString()}` : 
                    'Completed';
            } else if (daysInCare > docDef.dueByDay) {
                status = 'overdue';
                const daysOverdue = daysInCare - docDef.dueByDay;
                statusMessage = `Overdue by ${daysOverdue} days`;
            } else if (daysToDischarge <= 7 && docDef.required) {
                status = 'urgent';
                statusMessage = `Due in ${docDef.dueByDay - daysInCare} days`;
            } else {
                status = 'pending';
                statusMessage = `Due by day ${docDef.dueByDay}`;
            }
            
            return {
                status,
                statusMessage,
                isComplete,
                completedDate,
                daysUntilDue: docDef.dueByDay - daysInCare
            };
        }
        
        /**
         * Render document hub for a client
         */
        async renderDocumentHub(clientId) {
            try {
                this.currentClient = await window.clientManager.getClient(clientId);
                if (!this.currentClient) return;
                
                // Group documents by category
                const docsByCategory = this.groupDocumentsByCategory();
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'document-hub-overlay';
                modal.innerHTML = `
                    <div class="document-hub-modal">
                        <div class="document-hub-header">
                            <h3>üìÑ Document Status: ${this.currentClient.initials}</h3>
                            <button class="close-btn" onclick="window.closeModal(this.closest('.document-hub-overlay'))">√ó</button>
                        </div>
                        
                        <div class="document-hub-content">
                            <div class="document-summary">
                                ${this.renderDocumentSummary()}
                            </div>
                            
                            <div class="document-categories">
                                ${Object.entries(docsByCategory).map(([category, docs]) => 
                                    this.renderDocumentCategory(category, docs)
                                ).join('')}
                            </div>
                            
                            <div class="document-actions">
                                <button class="btn-primary" onclick="documentHub.generateMissing()">
                                    Generate Missing Documents
                                </button>
                                <button class="btn-secondary" onclick="documentHub.bulkUpload()">
                                    Bulk Upload
                                </button>
                                <button class="btn-secondary" onclick="documentHub.exportChecklist()">
                                    Export Checklist
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                console.error('[DocumentHub] Error rendering:', error);
                alert('Error loading document hub');
            }
        }
        
        /**
         * Render document summary stats
         */
        renderDocumentSummary() {
            let totalDocs = 0;
            let completedDocs = 0;
            let overdueDocs = 0;
            let urgentDocs = 0;
            
            documentDefinitions.forEach(docDef => {
                if (docDef.required) {
                    totalDocs++;
                    const status = this.getDocumentStatus(this.currentClient, docDef);
                    if (status.isComplete) completedDocs++;
                    if (status.status === 'overdue') overdueDocs++;
                    if (status.status === 'urgent') urgentDocs++;
                }
            });
            
            const percentage = totalDocs > 0 ? Math.round((completedDocs / totalDocs) * 100) : 0;
            
            return `
                <div class="summary-grid">
                    <div class="summary-stat">
                        <div class="stat-value">${percentage}%</div>
                        <div class="stat-label">Complete</div>
                    </div>
                    <div class="summary-stat">
                        <div class="stat-value">${completedDocs}/${totalDocs}</div>
                        <div class="stat-label">Documents</div>
                    </div>
                    <div class="summary-stat ${overdueDocs > 0 ? 'danger' : ''}">
                        <div class="stat-value">${overdueDocs}</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                    <div class="summary-stat ${urgentDocs > 0 ? 'warning' : ''}">
                        <div class="stat-value">${urgentDocs}</div>
                        <div class="stat-label">Urgent</div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Group documents by category
         */
        groupDocumentsByCategory() {
            const groups = {};
            
            documentDefinitions.forEach(docDef => {
                if (!groups[docDef.category]) {
                    groups[docDef.category] = [];
                }
                groups[docDef.category].push(docDef);
            });
            
            return groups;
        }
        
        /**
         * Render document category section
         */
        renderDocumentCategory(category, docs) {
            const categoryLabels = {
                admission: '48-Hour Admission',
                aftercare: 'Aftercare Planning',
                discharge: 'Discharge Documentation',
                feedback: 'Feedback & Surveys'
            };
            
            return `
                <div class="document-category">
                    <h4>${categoryLabels[category] || category}</h4>
                    <div class="document-list">
                        ${docs.map(doc => this.renderDocumentItem(doc)).join('')}
                    </div>
                </div>
            `;
        }
        
        /**
         * Render individual document item
         */
        renderDocumentItem(docDef) {
            const status = this.getDocumentStatus(this.currentClient, docDef);
            const statusIcon = this.getStatusIcon(status.status);
            const statusClass = `document-item ${status.status}`;
            
            return `
                <div class="${statusClass}">
                    <div class="document-icon">${statusIcon}</div>
                    <div class="document-info">
                        <div class="document-name">
                            ${docDef.label}
                            ${docDef.required ? '<span class="required-badge">Required</span>' : ''}
                            ${docDef.requiresSignature ? '<span class="signature-badge">Needs Signature</span>' : ''}
                        </div>
                        <div class="document-status">${status.statusMessage}</div>
                    </div>
                    <div class="document-actions">
                        ${status.isComplete ? `
                            <button class="btn-icon" title="View Document" onclick="documentHub.viewDocument('${docDef.id}')">
                                üëÅÔ∏è
                            </button>
                            <button class="btn-icon" title="Replace Document" onclick="documentHub.uploadDocument('${docDef.id}')">
                                üì§
                            </button>
                        ` : `
                            ${docDef.template ? `
                                <button class="btn-small" onclick="documentHub.generateDocument('${docDef.id}')">
                                    Generate
                                </button>
                            ` : ''}
                            <button class="btn-small primary" onclick="documentHub.uploadDocument('${docDef.id}')">
                                Upload
                            </button>
                        `}
                    </div>
                </div>
            `;
        }
        
        /**
         * Get status icon
         */
        getStatusIcon(status) {
            switch (status) {
                case 'complete': return '‚úÖ';
                case 'overdue': return '‚ùå';
                case 'urgent': return '‚ö†Ô∏è';
                default: return '‚óã';
            }
        }
        
        /**
         * Generate missing documents
         */
        async generateMissing() {
            const missing = documentDefinitions.filter(doc => {
                const status = this.getDocumentStatus(this.currentClient, doc);
                return !status.isComplete && doc.template;
            });
            
            if (missing.length === 0) {
                alert('No missing documents with templates available');
                return;
            }
            
            alert(`Generating ${missing.length} document templates:\n${missing.map(d => d.label).join('\n')}`);
            
            // In real implementation, this would generate actual documents
            console.log('[DocumentHub] Would generate:', missing);
        }
        
        /**
         * Handle document upload
         */
        uploadDocument(docId) {
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.doc,.docx';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                console.log(`[DocumentHub] Would upload ${file.name} for ${docId}`);
                
                // Update client record (in real implementation, would also upload file)
                const fieldName = docId === 'optionsDoc' ? 'optionsDocUploaded' : 
                                 docId === 'dischargePacket' ? 'dischargePacketUploaded' :
                                 docId;
                
                const updates = {
                    [fieldName]: true,
                    [fieldName + 'Date']: new Date().toISOString()
                };
                
                await window.clientManager.updateClient(this.currentClient.id, updates);
                
                // Refresh modal
                document.querySelector('.document-hub-overlay').remove();
                this.renderDocumentHub(this.currentClient.id);
                
                // Show success
                this.showNotification(`${file.name} uploaded successfully`, 'success');
            };
            
            input.click();
        }
        
        /**
         * View document (placeholder)
         */
        viewDocument(docId) {
            alert(`Viewing document: ${docId}\n(In real implementation, would open document viewer)`);
        }
        
        /**
         * Generate document from template (placeholder)
         */
        generateDocument(docId) {
            const doc = documentDefinitions.find(d => d.id === docId);
            alert(`Generating ${doc.label} from template...\n(In real implementation, would create document)`);
        }
        
        /**
         * Bulk upload interface (placeholder)
         */
        bulkUpload() {
            alert('Bulk upload interface coming soon!');
        }
        
        /**
         * Export checklist (placeholder)
         */
        exportChecklist() {
            const checklist = documentDefinitions.map(doc => {
                const status = this.getDocumentStatus(this.currentClient, doc);
                return `${status.isComplete ? '‚òë' : '‚òê'} ${doc.label} - ${status.statusMessage}`;
            }).join('\n');
            
            alert(`Document Checklist for ${this.currentClient.initials}:\n\n${checklist}`);
        }
        
        /**
         * Show notification
         */
        showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `document-notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('visible');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('visible');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Helper methods
        calculateDaysInCare(admissionDate) {
            if (!admissionDate) return 0;
            const admission = new Date(admissionDate);
            const today = new Date();
            const diffTime = Math.abs(today - admission);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        calculateDaysToDischarge(client) {
            if (!client.dischargeDate) {
                return Math.max(0, 30 - this.calculateDaysInCare(client.admissionDate));
            }
            const discharge = new Date(client.dischargeDate);
            const today = new Date();
            const diffTime = discharge - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
    }
    
    // Create global instance
    window.documentHub = new DocumentHub();
    
    // Add document hub button to client cards
    const addDocumentHubButtons = () => {
        const originalRenderClients = window.dashboardManager?.renderClients;
        
        if (originalRenderClients) {
            window.dashboardManager.renderClients = async function(clients, container) {
                // Call original
                await originalRenderClients.call(this, clients, container);
                
                // Add document hub buttons
                const cards = container.querySelectorAll('.client-card');
                cards.forEach((card, index) => {
                    if (clients[index] && !card.querySelector('.document-hub-btn')) {
                        const actionsContainer = card.querySelector('.client-actions') || card;
                        const btn = document.createElement('button');
                        btn.className = 'btn-small document-hub-btn';
                        btn.innerHTML = 'üìÑ Documents';
                        btn.onclick = () => window.documentHub.renderDocumentHub(clients[index].id);
                        actionsContainer.appendChild(btn);
                    }
                });
            };
        }
    };
    
    // Initialize when dependencies are ready
    const initInterval = setInterval(() => {
        if (window.dashboardManager && window.clientManager) {
            clearInterval(initInterval);
            addDocumentHubButtons();
            console.log('[DocumentHub] Document hub enhancements ready');
        }
    }, 100);
    
})();


// Enhancement: discharge-checklist.js
/**
 * Discharge Checklist UI Enhancement
 * Adds discharge checklist button to client cards and integrates with dashboard
 */

(function() {
    'use strict';
    
    // Wait for dashboard to be ready
    function waitForDashboard() {
        if (!window.dashboardWidgets || !window.dischargeChecklistManager) {
            setTimeout(waitForDashboard, 100);
            return;
        }
        
        enhanceClientCards();
    }
    
    /**
     * Add discharge checklist button to client cards
     */
    function enhanceClientCards() {
        // Override the renderClientCard method to add discharge checklist button
        const originalRenderCard = window.dashboardWidgets.renderClientCard;
        
        window.dashboardWidgets.renderClientCard = function(client) {
            const cardHtml = originalRenderCard.call(this, client);
            
            // Calculate days to discharge
            const daysToDischarge = client.dischargeDate ? 
                Math.ceil((new Date(client.dischargeDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
            
            // Only show discharge checklist button if discharge is within 7 days or past
            if (daysToDischarge !== null && daysToDischarge <= 7) {
                // Insert discharge checklist button before the closing client-actions div
                const insertPoint = '</div>\n            </div>';
                const dischargeButton = `
                    <button class="btn-discharge-checklist" 
                            onclick="dischargeChecklistManager.renderChecklistModal('${client.id}')"
                            title="Open FFAS Discharge Checklist">
                        üìã Discharge Checklist
                    </button>
                `;
                
                return cardHtml.replace(insertPoint, dischargeButton + insertPoint);
            }
            
            return cardHtml;
        };
        
        // Also add to the discharge prep alerts
        const originalRenderPriority = window.dashboardWidgets.renderPriorityItem;
        
        window.dashboardWidgets.renderPriorityItem = function(item, zoneColor) {
            const html = originalRenderPriority.call(this, item, zoneColor);
            
            // If this is a discharge prep item, add a link to the checklist
            if (item.type === 'discharge_prep') {
                const checklistLink = `
                    <button class="btn-link" 
                            onclick="dischargeChecklistManager.renderChecklistModal('${item.client.id}')"
                            style="margin-left: 8px; color: #7c3aed; text-decoration: underline; background: none; border: none; cursor: pointer;">
                        üìã Open Full Checklist
                    </button>
                `;
                
                // Insert after the action button
                return html.replace('</div>\n                </div>', checklistLink + '</div>\n                </div>');
            }
            
            return html;
        };
    }
    
    // Initialize when ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDashboard);
    } else {
        waitForDashboard();
    }
})();


if (false) {
// Enhancement: missions-redesign.js
/**
 * Missions Widget Redesign
 * Modern, beautiful redesign of the Today's Missions widget
 */

(function() {
    'use strict';
    
    // Wait for dashboard to be ready
    function waitForDashboard() {
        if (!window.dashboardWidgets || !window.dashboardManager) {
            setTimeout(waitForDashboard, 100);
            return;
        }
        
        enhanceMissionsWidget();
    }
    
    /**
     * Enhance the missions widget with modern design
     */
    function enhanceMissionsWidget() {
        // Wait for MissionsWidget to be available
        const checkForWidget = setInterval(() => {
            // Find the missions widget instance
            const widgetsManager = window.dashboardWidgets;
            if (widgetsManager && widgetsManager.widgets) {
                const missionsWidget = widgetsManager.widgets.get('missions');
                if (missionsWidget) {
                    clearInterval(checkForWidget);
                    
                    // Override the render method
                    const originalRender = missionsWidget.render.bind(missionsWidget);
                    missionsWidget.render = async function() {
                        try {
                            // Get the data first
                            const alerts = await window.dashboardManager.loadCriticalAlerts();
                            
                            // Use our modern rendering
                            const modernHtml = renderModernMissions(alerts);
                            
                            // Update the container
                            if (this.container) {
                                this.container.innerHTML = modernHtml;
                            }
                        } catch (error) {
                            console.error('Error rendering modern missions:', error);
                            // Fallback to original
                            return originalRender();
                        }
                    };
                    
                    // Trigger a re-render
                    missionsWidget.render();
                }
            }
        }, 100);
        
        // Also create the widget if it doesn't exist
        setTimeout(() => {
            clearInterval(checkForWidget);
            createMissionsWidgetIfMissing();
        }, 5000);
    }
    
    function createMissionsWidgetIfMissing() {
        // Check if there's a container for missions but no widget
        const container = document.querySelector('[data-widget="missions"], .missions-container');
        if (container && window.dashboardWidgets && !window.dashboardWidgets.widgets.get('missions')) {
            // Create a custom missions widget
            const missionsWidget = {
                id: 'missions',
                container: container,
                render: async function() {
                    const alerts = await window.dashboardManager.loadCriticalAlerts();
                    container.innerHTML = renderModernMissions(alerts);
                }
            };
            
            window.dashboardWidgets.widgets.set('missions', missionsWidget);
            missionsWidget.render();
        }
    }
    
    /**
     * Render modern missions widget
     */
    function renderModernMissions(data) {
        // Get missions from red and yellow zones
        const primaryMissions = data.red || [];
        const secondaryMissions = data.yellow || [];
        const totalMissions = primaryMissions.length + secondaryMissions.length;
        const completedCount = 0; // Would need to track this in actual implementation
        
        let html = `
            <div class="missions-widget">
                <!-- Header -->
                <div class="missions-header">
                    <div class="missions-title">
                        Today's Missions
                    </div>
                    <div class="missions-progress">
                        <div class="progress-circles">
                            ${Array(Math.max(2, totalMissions)).fill().map((_, i) => 
                                `<div class="progress-circle ${i < completedCount ? 'completed' : ''}"></div>`
                            ).join('')}
                        </div>
                        <span>${completedCount}/${totalMissions} Complete</span>
                    </div>
                </div>
        `;
        
        if (totalMissions === 0) {
            html += `
                <div class="missions-empty">
                    <div class="missions-empty-icon">üéâ</div>
                    <div class="missions-empty-text">All missions complete! Great work!</div>
                </div>
            `;
        } else {
            // Primary Objectives
            if (primaryMissions.length > 0) {
                html += `
                    <div class="mission-section primary">
                        <div class="mission-section-header">
                            <div class="mission-label">
                                <div class="icon">üéØ</div>
                                Primary Objective
                            </div>
                            <div class="mission-time">Est. ${primaryMissions.length * 5} min</div>
                        </div>
                        <div class="mission-items">
                `;
                
                primaryMissions.forEach(mission => {
                    const clientInfo = mission.client ? 
                        `<span class="mission-client">${mission.client.initials || 'Client'}</span>` : '';
                    
                    html += `
                        <div class="mission-item critical">
                            <div class="mission-checkbox">
                                <input type="checkbox" 
                                       id="mission-${mission.type}-${mission.client?.id}"
                                       ${mission.isTrackerTask ? 
                                         `onclick="dashboardWidgets.completeTrackerItem('${mission.client?.id}', '${mission.trackerId}')"` :
                                         `onclick="dashboardWidgets.completeMission('${mission.type}', '${mission.client?.id}')"` 
                                       }>
                            </div>
                            <div class="mission-content">
                                ${clientInfo}
                                <span class="mission-text">${mission.message}</span>
                                ${mission.priority === 'red' ? '<span class="mission-critical">CRITICAL</span>' : ''}
                            </div>
                            ${mission.action && mission.action !== 'Mark Complete' ? 
                                `<button class="mission-action" onclick="dashboardWidgets.takeAction('${mission.type}', '${mission.client?.id}')">
                                    ${mission.action}
                                </button>` : ''
                            }
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Secondary Objectives
            if (secondaryMissions.length > 0) {
                html += `
                    <div class="mission-section secondary">
                        <div class="mission-section-header">
                            <div class="mission-label">
                                <div class="icon">üé™</div>
                                Secondary Objectives
                            </div>
                            <div class="mission-time">Est. ${secondaryMissions.length * 5} min</div>
                        </div>
                        <div class="mission-items">
                `;
                
                secondaryMissions.forEach(mission => {
                    const clientInfo = mission.client ? 
                        `<span class="mission-client">${mission.client.initials || 'Client'}</span>` : '';
                    
                    html += `
                        <div class="mission-item">
                            <div class="mission-checkbox">
                                <input type="checkbox" 
                                       id="mission-${mission.type}-${mission.client?.id}"
                                       ${mission.isTrackerTask ? 
                                         `onclick="dashboardWidgets.completeTrackerItem('${mission.client?.id}', '${mission.trackerId}')"` :
                                         `onclick="dashboardWidgets.completeMission('${mission.type}', '${mission.client?.id}')"` 
                                       }>
                            </div>
                            <div class="mission-content">
                                ${clientInfo}
                                <span class="mission-text">${mission.message}</span>
                            </div>
                            ${mission.action && mission.action !== 'Mark Complete' ? 
                                `<button class="mission-action" onclick="dashboardWidgets.takeAction('${mission.type}', '${mission.client?.id}')">
                                    ${mission.action}
                                </button>` : ''
                            }
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
        }
        
        html += `
            </div>
            
            <!-- Quick Actions Bar -->
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="dashboardWidgets.openAddClient()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        ‚ûï
                    </div>
                    <span class="quick-action-label">Add Client</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.openGenerateDoc()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                        üìÑ
                    </div>
                    <span class="quick-action-label">Generate Doc</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.showAllAlerts()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        üîî
                    </div>
                    <span class="quick-action-label">All Alerts</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.exportReport()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        üìä
                    </div>
                    <span class="quick-action-label">Export Report</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.toggleFocusMode()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                        üéØ
                    </div>
                    <span class="quick-action-label">Focus Mode</span>
                </button>
                
                <button class="quick-action-btn" onclick="location.reload()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                        üîÑ
                    </div>
                    <span class="quick-action-label">Refresh</span>
                </button>
            </div>
        `;
        
        return html;
    }
    
    // Add mission completion handler if it doesn't exist
    if (window.dashboardWidgets && !window.dashboardWidgets.completeMission) {
        window.dashboardWidgets.completeMission = async function(missionType, clientId) {
            // Mark mission as complete
            console.log('Completing mission:', missionType, clientId);
            
            // Add completion animation
            const checkbox = document.querySelector(`#mission-${missionType}-${clientId}`);
            if (checkbox) {
                checkbox.checked = true;
                const missionItem = checkbox.closest('.mission-item');
                if (missionItem) {
                    missionItem.style.opacity = '0.5';
                    missionItem.style.textDecoration = 'line-through';
                }
            }
            
            // Update progress
            setTimeout(() => {
                window.dashboardManager.refreshDashboard();
            }, 500);
        };
    }
    
    // Add placeholder methods for quick actions if they don't exist
    const placeholderMethods = {
        openAddClient: () => console.log('Open Add Client modal'),
        openGenerateDoc: () => {
            // Try to open document creator if available
            const docBtn = document.querySelector('[onclick*="showDocumentCreator"]');
            if (docBtn) docBtn.click();
            else console.log('Open Generate Doc');
        },
        showAllAlerts: () => {
            // Show all zones if collapsed
            document.querySelectorAll('.zone-content.collapsed').forEach(zone => {
                zone.classList.remove('collapsed');
            });
        },
        exportReport: () => {
            // Try to trigger export if available
            if (window.exportDashboardData) {
                window.exportDashboardData();
            } else {
                console.log('Export Report');
            }
        },
        toggleFocusMode: () => {
            // Hide all except missions widget
            document.body.classList.toggle('focus-mode');
            if (document.body.classList.contains('focus-mode')) {
                // Hide other widgets
                document.querySelectorAll('.widget-card').forEach(widget => {
                    if (!widget.querySelector('.missions-widget')) {
                        widget.style.display = 'none';
                    }
                });
            } else {
                // Show all widgets
                document.querySelectorAll('.widget-card').forEach(widget => {
                    widget.style.display = '';
                });
            }
        }
    };
    
    // Add methods if they don't exist
    Object.keys(placeholderMethods).forEach(method => {
        if (window.dashboardWidgets && !window.dashboardWidgets[method]) {
            window.dashboardWidgets[method] = placeholderMethods[method];
        }
    });
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDashboard);
    } else {
        waitForDashboard();
    }
})();
}


// Enhancement: morning-review.js
/**
 * Morning Review Dashboard UI Enhancement
 * Adds morning review button and functionality
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.morningReview || !window.dashboardManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        addMorningReviewButton();
        checkAutoShowMorningReview();
    }
    
    /**
     * Add morning review button to dashboard
     */
    function addMorningReviewButton() {
        // Check every second for dashboard controls
        const checkInterval = setInterval(() => {
            const dashboardControls = document.querySelector('.dashboard-controls');
            if (dashboardControls) {
                clearInterval(checkInterval);
                
                // Check if button already exists
                if (document.querySelector('.btn-morning-review')) return;
                
                // Add the button
                const morningBtn = document.createElement('button');
                morningBtn.className = 'btn-morning-review';
                morningBtn.innerHTML = '‚òÄÔ∏è Morning Review';
                morningBtn.onclick = () => window.morningReview.renderMorningReview();
                
                // Insert before other buttons
                const firstButton = dashboardControls.querySelector('button');
                if (firstButton && firstButton.parentNode === dashboardControls) {
                    try {
                        dashboardControls.insertBefore(morningBtn, firstButton);
                    } catch (err) {
                        console.warn('Could not insert Morning Review button:', err);
                        dashboardControls.appendChild(morningBtn);
                    }
                } else {
                    dashboardControls.appendChild(morningBtn);
                }
                
                // Add notification badge if tasks are overdue
                checkForNotificationBadge();
            }
        }, 1000);
        
        // Stop checking after 30 seconds
        setTimeout(() => clearInterval(checkInterval), 30000);
    }
    
    /**
     * Check if we should auto-show morning review
     */
    function checkAutoShowMorningReview() {
        const hour = new Date().getHours();
        const lastShown = localStorage.getItem('lastMorningReviewDate');
        const today = new Date().toDateString();
        
        // Show automatically once per day in the morning (6am - 10am)
        if (hour >= 6 && hour <= 10 && lastShown !== today) {
            // Wait for dashboard to load
            setTimeout(() => {
                window.morningReview.renderMorningReview();
                localStorage.setItem('lastMorningReviewDate', today);
            }, 3000);
        }
    }
    
    /**
     * Add notification badge if there are overdue items
     */
    async function checkForNotificationBadge() {
        try {
            const clients = await window.clientManager.getAllClients();
            let overdueCount = 0;
            
            for (const client of clients) {
                if (client.status !== 'active') continue;
                
                const score = window.trackerEngine?.getCompletionScore(client);
                if (score && score.missingCritical) {
                    const daysInCare = window.trackerEngine.calculateDaysInCare(client.admissionDate);
                    const overdue = score.missingCritical.filter(item => daysInCare > item.dueByDay);
                    overdueCount += overdue.length;
                }
            }
            
            if (overdueCount > 0) {
                const morningBtn = document.querySelector('.btn-morning-review');
                if (morningBtn && !morningBtn.querySelector('.notification-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = overdueCount;
                    morningBtn.appendChild(badge);
                }
            }
        } catch (error) {
            console.error('Error checking for overdue items:', error);
        }
    }
    
    /**
     * Add keyboard shortcut
     */
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + M for Morning Review
        if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
            e.preventDefault();
            if (window.morningReview) {
                window.morningReview.renderMorningReview();
            }
        }
    });
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();

// Add notification badge styles
if (!document.querySelector('#morning-review-badge-styles')) {
    const style = document.createElement('style');
    style.id = 'morning-review-badge-styles';
    style.textContent = `
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
        
        .btn-morning-review {
            position: relative;
        }
    `;
    document.head.appendChild(style);
}


// Enhancement: quick-actions-complete.js
/**
 * Dashboard Quick Actions Enhancement
 * Completes implementation of all quick action buttons
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardWidgets || !window.clientManager || !window.showModal) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceQuickActions();
    }
    
    function enhanceQuickActions() {
        // Override quickGenerateDoc with full client-centric workflow
        window.dashboardWidgets.quickGenerateDoc = async function() {
            try {
                // Step 1: Select client
                const clients = await window.clientManager.getAllClients();
                const activeClients = clients.filter(c => c.status === 'active');
                
                if (activeClients.length === 0) {
                    window.showNotification('No active clients found', 'warning');
                    return;
                }
                
                // Build client selection HTML
                let clientOptionsHtml = `
                    <div class="client-selection-grid">
                        ${activeClients.map(client => {
                            const daysInCare = window.daysBetween(client.admissionDate) || 0;
                            return `
                                <label class="client-option">
                                    <input type="radio" name="selectedClient" value="${client.id}">
                                    <div class="client-card-mini">
                                        <span class="client-initials">${client.initials}</span>
                                        <span class="client-house">${client.houseId || 'No House'}</span>
                                        <span class="client-days">Day ${daysInCare}</span>
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>
                `;
                
                let selectedClientId = null;
                
                window.showModal({
                    title: 'üìÑ Generate Document - Select Client',
                    content: clientOptionsHtml,
                    size: 'large',
                    buttons: [
                        {
                            text: 'Next',
                            primary: true,
                            action: () => {
                                const selected = document.querySelector('input[name="selectedClient"]:checked');
                                if (!selected) {
                                    window.showNotification('Please select a client', 'warning');
                                    return;
                                }
                                selectedClientId = selected.value;
                                window.closeModal();
                                selectDocumentType(selectedClientId);
                            }
                        },
                        {
                            text: 'Cancel',
                            action: () => window.closeModal()
                        }
                    ]
                });
                
            } catch (error) {
                console.error('Error in quickGenerateDoc:', error);
                window.showNotification('Failed to start document generation', 'error');
            }
        };
        
        // Step 2: Select document type
        async function selectDocumentType(clientId) {
            const client = await window.clientManager.getClient(clientId);
            const daysInCare = window.daysBetween(client.admissionDate) || 0;
            
            const documentTypes = [
                {
                    id: 'aftercare-options',
                    name: 'Aftercare Options',
                    icon: 'üìã',
                    description: 'Compare aftercare programs for family',
                    recommended: daysInCare >= 14
                },
                {
                    id: 'aftercare-plan',
                    name: 'Aftercare Plan',
                    icon: 'üìÑ',
                    description: 'Detailed placement plan',
                    recommended: daysInCare >= 21
                },
                {
                    id: 'discharge-packet',
                    name: 'Discharge Packet',
                    icon: 'üì¶',
                    description: 'Complete discharge documentation',
                    recommended: daysInCare >= 25 || client.dischargeDate
                }
            ];
            
            const typeOptionsHtml = `
                <div class="selected-client-info">
                    <strong>Client:</strong> ${client.initials} - ${client.houseId} (Day ${daysInCare})
                </div>
                <div class="document-type-grid">
                    ${documentTypes.map(type => `
                        <label class="document-type-option ${type.recommended ? 'recommended' : ''}">
                            <input type="radio" name="documentType" value="${type.id}">
                            <div class="type-card">
                                <span class="type-icon">${type.icon}</span>
                                <span class="type-name">${type.name}</span>
                                <span class="type-description">${type.description}</span>
                                ${type.recommended ? '<span class="recommended-badge">Recommended</span>' : ''}
                            </div>
                        </label>
                    `).join('')}
                </div>
            `;
            
            window.showModal({
                title: 'üìÑ Select Document Type',
                content: typeOptionsHtml,
                size: 'medium',
                buttons: [
                    {
                        text: 'Next',
                        primary: true,
                        action: async () => {
                            const selected = document.querySelector('input[name="documentType"]:checked');
                            if (!selected) {
                                window.showNotification('Please select a document type', 'warning');
                                return;
                            }
                            window.closeModal();
                            
                            // For discharge packet, go directly to generation
                            if (selected.value === 'discharge-packet') {
                                generateDischargePacket(client);
                            } else {
                                // For other types, select programs
                                selectPrograms(client, selected.value);
                            }
                        }
                    },
                    {
                        text: 'Back',
                        action: () => {
                            window.closeModal();
                            window.dashboardWidgets.quickGenerateDoc();
                        }
                    }
                ]
            });
        }
        
        // Step 3: Select programs (for non-discharge documents)
        async function selectPrograms(client, documentType) {
            // Switch to programs tab to ensure programs are loaded
            window.switchTab('programs');
            
            // Wait for programs to load
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Show program selection in modal
            window.showNotification('Select programs from the Programs tab, then generate document', 'info', '', 5000);
            
            // Store context for document generation
            window.documentGenerationContext = {
                clientId: client.id,
                client: client,
                documentType: documentType
            };
        }
        
        // Generate discharge packet
        async function generateDischargePacket(client) {
            window.showNotification('Generating discharge packet...', 'info');
            
            // Switch to programs tab and trigger discharge packet creation
            window.switchTab('programs');
            
            // Store context
            window.documentGenerationContext = {
                clientId: client.id,
                client: client,
                documentType: 'discharge-packet'
            };
            
            // Wait for tab to load then trigger
            setTimeout(() => {
                if (window.createDischargePacket) {
                    window.createDischargePacket();
                }
            }, 500);
        }
        
        // Enhanced viewAllAlerts with filtering and actions
        window.dashboardWidgets.viewAllAlerts = async function() {
            const alerts = window.dashboardManager.cache.priorities;
            let currentFilter = 'all';
            
            function renderAlertsModal() {
                const zones = ['red', 'purple', 'yellow', 'green'];
                let filteredAlerts = {};
                
                // Apply filter
                if (currentFilter === 'all') {
                    filteredAlerts = alerts;
                } else {
                    filteredAlerts[currentFilter] = alerts[currentFilter] || [];
                }
                
                let content = `
                    <div class="alerts-modal-header">
                        <div class="alert-filters">
                            <button class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" 
                                    onclick="window.filterAlerts('all')">All Zones</button>
                            ${zones.map(zone => `
                                <button class="filter-btn zone-${zone} ${currentFilter === zone ? 'active' : ''}" 
                                        onclick="window.filterAlerts('${zone}')">
                                    ${zone.charAt(0).toUpperCase() + zone.slice(1)} (${(alerts[zone] || []).length})
                                </button>
                            `).join('')}
                        </div>
                        <div class="alert-actions">
                            <button class="btn btn-sm" onclick="window.exportAlerts()">
                                üìä Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="alerts-content">
                `;
                
                let hasAlerts = false;
                
                for (const [zone, items] of Object.entries(filteredAlerts)) {
                    if (!items || items.length === 0) continue;
                    hasAlerts = true;
                    
                    content += `
                        <div class="alert-zone-section">
                            <h4 class="zone-header zone-${zone}">
                                ${zone.charAt(0).toUpperCase() + zone.slice(1)} Zone
                            </h4>
                            <div class="alert-items">
                    `;
                    
                    for (const item of items) {
                        content += `
                            <div class="alert-item" onclick="window.navigateToAlert('${item.client.id}', '${item.type}')">
                                <div class="alert-client">
                                    <span class="client-badge">${item.client.initials}</span>
                                    <span class="house-badge">${item.client.houseId}</span>
                                </div>
                                <div class="alert-details">
                                    <div class="alert-message">${item.message}</div>
                                    ${item.dueDate ? `<div class="alert-due">Due: ${item.dueDate}</div>` : ''}
                                </div>
                                <div class="alert-actions">
                                    ${item.isTrackerTask ? 
                                        `<button class="btn btn-sm btn-success" 
                                                onclick="event.stopPropagation(); window.completeAlert('${item.client.id}', '${item.trackerId}')">
                                            ‚úì Complete
                                        </button>` : 
                                        `<button class="btn btn-sm" 
                                                onclick="event.stopPropagation(); window.takeAlertAction('${item.type}', '${item.client.id}')">
                                            ${item.action || 'View'}
                                        </button>`
                                    }
                                </div>
                            </div>
                        `;
                    }
                    
                    content += `
                            </div>
                        </div>
                    `;
                }
                
                if (!hasAlerts) {
                    content += `
                        <div class="empty-state">
                            <p>No alerts found${currentFilter !== 'all' ? ' in ' + currentFilter + ' zone' : ''}</p>
                        </div>
                    `;
                }
                
                content += '</div>';
                
                return content;
            }
            
            // Global functions for modal interactions
            window.filterAlerts = function(filter) {
                currentFilter = filter;
                const modalBody = document.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.innerHTML = renderAlertsModal();
                }
            };
            
            window.navigateToAlert = function(clientId, type) {
                window.closeModal();
                window.viewClientDetails(clientId);
            };
            
            window.completeAlert = async function(clientId, trackerId) {
                await window.dashboardWidgets.completeTrackerItem(clientId, trackerId);
                // Refresh modal
                window.dashboardManager.refreshDashboard();
                window.filterAlerts(currentFilter);
            };
            
            window.takeAlertAction = function(type, clientId) {
                window.closeModal();
                window.dashboardWidgets.takeAction(`action-${type}-${clientId}`, type, clientId);
            };
            
            window.exportAlerts = function() {
                const csv = generateAlertsCSV(alerts);
                downloadCSV(csv, `alerts-${new Date().toISOString().split('T')[0]}.csv`);
                window.showNotification('Alerts exported successfully', 'success');
            };
            
            // Show modal
            window.showModal({
                title: 'üîî All Alerts',
                content: renderAlertsModal(),
                size: 'large',
                buttons: [
                    {
                        text: 'Close',
                        action: () => window.closeModal()
                    }
                ]
            });
        };
        
        // Enhanced exportDashboard
        window.dashboardWidgets.exportDashboard = async function() {
            try {
                const data = {
                    exportDate: new Date().toISOString(),
                    coach: window.getCurrentCoach?.() || 'Unknown',
                    summary: {
                        totalClients: 0,
                        activeClients: 0,
                        criticalAlerts: 0,
                        todayTasks: 0
                    },
                    alerts: window.dashboardManager.cache.priorities,
                    clients: [],
                    milestones: []
                };
                
                // Gather all data
                const clients = await window.clientManager.getAllClients();
                data.summary.totalClients = clients.length;
                data.summary.activeClients = clients.filter(c => c.status === 'active').length;
                data.summary.criticalAlerts = (data.alerts.red || []).length;
                
                // Calculate today's tasks
                for (const zone of Object.values(data.alerts)) {
                    data.summary.todayTasks += zone.filter(item => 
                        item.dueDate && item.dueDate.includes('today')
                    ).length;
                }
                
                // Add client details
                for (const client of clients) {
                    const clientData = {
                        initials: client.initials,
                        house: client.houseId,
                        status: client.status,
                        admissionDate: client.admissionDate,
                        daysInCare: window.daysBetween(client.admissionDate),
                        trackerCompletion: 0
                    };
                    
                    // Calculate tracker completion
                    if (window.trackerEngine) {
                        const score = window.trackerEngine.getCompletionScore(client);
                        clientData.trackerCompletion = score.percentage;
                    }
                    
                    data.clients.push(clientData);
                }
                
                // Generate CSV
                const csv = generateDashboardCSV(data);
                downloadCSV(csv, `dashboard-export-${new Date().toISOString().split('T')[0]}.csv`);
                
                window.showNotification('Dashboard exported successfully', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                window.showNotification('Failed to export dashboard', 'error');
            }
        };
        
        // Enhanced enterFocusMode
        window.dashboardWidgets.enterFocusMode = function() {
            // Check if already in focus mode
            if (document.body.classList.contains('focus-mode')) {
                exitFocusMode();
                return;
            }
            
            // Enter focus mode
            document.body.classList.add('focus-mode');
            
            // Hide non-essential elements
            const elementsToHide = [
                '.header-controls',
                '.dashboard-controls',
                '#quickActionsWidget',
                '#missionsWidget',
                '.zone-yellow',
                '.zone-green'
            ];
            
            elementsToHide.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    el.dataset.focusHidden = 'true';
                    el.style.display = 'none';
                });
            });
            
            // Expand critical zones
            const redZone = document.querySelector('.zone-red');
            const purpleZone = document.querySelector('.zone-purple');
            
            if (redZone) {
                const content = redZone.querySelector('.zone-content');
                if (content) content.classList.add('expanded');
            }
            
            if (purpleZone) {
                const content = purpleZone.querySelector('.zone-content');
                if (content) content.classList.add('expanded');
            }
            
            // Add focus mode indicator
            const indicator = document.createElement('div');
            indicator.className = 'focus-mode-indicator';
            indicator.innerHTML = `
                <span>üéØ Focus Mode Active</span>
                <button onclick="window.dashboardWidgets.enterFocusMode()">Exit</button>
            `;
            document.body.appendChild(indicator);
            
            window.showNotification('Focus mode activated - showing only critical tasks', 'info');
        };
        
        function exitFocusMode() {
            document.body.classList.remove('focus-mode');
            
            // Restore hidden elements
            document.querySelectorAll('[data-focus-hidden="true"]').forEach(el => {
                el.style.display = '';
                delete el.dataset.focusHidden;
            });
            
            // Remove indicator
            const indicator = document.querySelector('.focus-mode-indicator');
            if (indicator) indicator.remove();
            
            window.showNotification('Focus mode deactivated', 'info');
        }
        
        // Helper functions
        function generateAlertsCSV(alerts) {
            let csv = 'Zone,Client,House,Message,Due Date,Type\n';
            
            for (const [zone, items] of Object.entries(alerts)) {
                for (const item of items) {
                    csv += `"${zone}","${item.client.initials}","${item.client.houseId}",`;
                    csv += `"${item.message.replace(/"/g, '""')}","${item.dueDate || ''}","${item.type}"\n`;
                }
            }
            
            return csv;
        }
        
        function generateDashboardCSV(data) {
            let csv = 'Dashboard Export\n';
            csv += `Export Date,${data.exportDate}\n`;
            csv += `Coach,${data.coach}\n\n`;
            
            csv += 'Summary\n';
            csv += `Total Clients,${data.summary.totalClients}\n`;
            csv += `Active Clients,${data.summary.activeClients}\n`;
            csv += `Critical Alerts,${data.summary.criticalAlerts}\n`;
            csv += `Today's Tasks,${data.summary.todayTasks}\n\n`;
            
            csv += 'Client Details\n';
            csv += 'Initials,House,Status,Admission Date,Days in Care,Tracker Completion\n';
            
            for (const client of data.clients) {
                csv += `${client.initials},${client.house},${client.status},`;
                csv += `${client.admissionDate},${client.daysInCare},${client.trackerCompletion}%\n`;
            }
            
            return csv;
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Add styles
        if (!document.querySelector('#quick-actions-styles')) {
            const styles = document.createElement('style');
            styles.id = 'quick-actions-styles';
            styles.textContent = `
                /* Client Selection Grid */
                .client-selection-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                    gap: 12px;
                    max-height: 400px;
                    overflow-y: auto;
                    padding: 4px;
                }
                
                .client-option {
                    cursor: pointer;
                }
                
                .client-option input {
                    position: absolute;
                    opacity: 0;
                }
                
                .client-card-mini {
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 12px;
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    transition: all 0.2s;
                }
                
                .client-option input:checked + .client-card-mini {
                    border-color: var(--ccp-primary-500);
                    background: var(--ccp-primary-100);
                }
                
                .client-card-mini:hover {
                    border-color: var(--ccp-primary-300);
                }
                
                /* Document Type Selection */
                .selected-client-info {
                    padding: 12px;
                    background: #f3f4f6;
                    border-radius: 6px;
                    margin-bottom: 16px;
                }
                
                .document-type-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 16px;
                }
                
                .document-type-option input {
                    position: absolute;
                    opacity: 0;
                }
                
                .type-card {
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 16px;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                    position: relative;
                }
                
                .document-type-option input:checked + .type-card {
                    border-color: var(--ccp-primary-500);
                    background: var(--ccp-primary-100);
                }
                
                .document-type-option.recommended .type-card {
                    border-color: var(--ccp-success-500);
                }
                
                .type-icon {
                    font-size: 32px;
                    text-align: center;
                }
                
                .type-name {
                    font-weight: 600;
                    font-size: 16px;
                }
                
                .type-description {
                    font-size: 14px;
                    color: #6b7280;
                }
                
                .recommended-badge {
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background: var(--ccp-success-500);
                    color: white;
                    font-size: 11px;
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-weight: 600;
                }
                
                /* Alerts Modal */
                .alerts-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 16px;
                    border-bottom: 1px solid #e5e7eb;
                }
                
                .alert-filters {
                    display: flex;
                    gap: 8px;
                }
                
                .filter-btn {
                    padding: 6px 12px;
                    border: 1px solid #e5e7eb;
                    background: white;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .filter-btn.active {
                    background: var(--ccp-primary-500);
                    color: white;
                    border-color: var(--ccp-primary-500);
                }
                
                .filter-btn.zone-red.active {
                    background: #ef4444;
                    border-color: #ef4444;
                }
                
                .filter-btn.zone-purple.active {
                    background: #a855f7;
                    border-color: #a855f7;
                }
                
                .filter-btn.zone-yellow.active {
                    background: #eab308;
                    border-color: #eab308;
                }
                
                .filter-btn.zone-green.active {
                    background: #22c55e;
                    border-color: #22c55e;
                }
                
                .alerts-content {
                    max-height: 500px;
                    overflow-y: auto;
                }
                
                .alert-zone-section {
                    margin-bottom: 24px;
                }
                
                .zone-header {
                    font-size: 16px;
                    font-weight: 600;
                    margin-bottom: 12px;
                    padding-left: 12px;
                    border-left: 4px solid;
                }
                
                .zone-header.zone-red {
                    border-left-color: #ef4444;
                    color: #dc2626;
                }
                
                .zone-header.zone-purple {
                    border-left-color: #a855f7;
                    color: #9333ea;
                }
                
                .zone-header.zone-yellow {
                    border-left-color: #eab308;
                    color: #ca8a04;
                }
                
                .zone-header.zone-green {
                    border-left-color: #22c55e;
                    color: #16a34a;
                }
                
                .alert-item {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 12px;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .alert-item:hover {
                    background: #f9fafb;
                    border-color: #d1d5db;
                }
                
                .alert-client {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                    flex-shrink: 0;
                }
                
                .alert-details {
                    flex: 1;
                }
                
                .alert-message {
                    font-size: 14px;
                }
                
                .alert-due {
                    font-size: 12px;
                    color: #6b7280;
                    margin-top: 2px;
                }
                
                /* Focus Mode */
                .focus-mode-indicator {
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #1f2937;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                }
                
                .focus-mode-indicator button {
                    background: white;
                    color: #1f2937;
                    border: none;
                    padding: 4px 12px;
                    border-radius: 12px;
                    cursor: pointer;
                    font-size: 12px;
                }
                
                body.focus-mode .dashboard-widget:not(#flightPlanWidget) {
                    opacity: 0.3;
                }
                
                body.focus-mode #flightPlanWidget {
                    transform: scale(1.05);
                    transition: transform 0.3s;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Quick actions enhanced successfully');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: document-generator-ui.js
/**
 * Document Generator UI Integration
 * Adds document generation buttons throughout the UI
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.documentGenerator || !window.dashboardWidgets || !window.clientManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        integrateDocumentGenerator();
    }
    
    function integrateDocumentGenerator() {
        // Add document generation button to dashboard header
        let dashboardButtonAdded = false;
        const addDashboardButton = () => {
            if (dashboardButtonAdded) return;
            
            const dashboardControls = document.querySelector('.dashboard-controls');
            if (dashboardControls && !document.querySelector('#btnGenerateDoc')) {
                const button = document.createElement('button');
                button.id = 'btnGenerateDoc';
                button.className = 'btn btn-primary';
                button.innerHTML = 'üìÑ Generate Document';
                button.onclick = () => window.generateDocument();
                
                // Insert before the first button
                const firstButton = dashboardControls.querySelector('button');
                if (firstButton && firstButton.parentNode === dashboardControls) {
                    try {
                        dashboardControls.insertBefore(button, firstButton);
                        dashboardButtonAdded = true;
                    } catch (err) {
                        console.warn('Could not insert button before first button:', err);
                        dashboardControls.appendChild(button);
                        dashboardButtonAdded = true;
                    }
                } else {
                    dashboardControls.appendChild(button);
                    dashboardButtonAdded = true;
                }
            }
        };
        
        // Enhance client cards with quick document generation
        const originalRenderClient = window.dashboardWidgets?.renderClient;
        if (originalRenderClient) {
            window.dashboardWidgets.renderClient = function(client) {
                let html = originalRenderClient.call(this, client);
                
                // Add document generation button to client card actions
                const daysInCare = window.daysBetween(client.admissionDate) || 0;
                const hasRecommendedDocs = window.documentGenerator.getRecommendedDocuments(client, daysInCare).length > 0;
                
                if (hasRecommendedDocs) {
                    const buttonHtml = `
                        <button class="btn-doc-gen-quick" 
                                onclick="window.generateDocument('${client.id}')"
                                title="Generate document for ${client.initials}">
                            üìÑ
                        </button>
                    `;
                    
                    // Insert button before the last closing div
                    const insertPos = html.lastIndexOf('</div>');
                    html = html.slice(0, insertPos) + buttonHtml + html.slice(insertPos);
                }
                
                return html;
            };
        }
        
        // Override the quickGenerateDoc to use our new system
        if (window.dashboardWidgets?.quickGenerateDoc) {
            window.dashboardWidgets.quickGenerateDoc = function() {
                window.generateDocument();
            };
        }
        
        // Add keyboard shortcut (Ctrl+D for document)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                window.generateDocument();
            }
        });
        
        // Listen for document generation events to refresh dashboard
        window.addEventListener('document:generated', (e) => {
            console.log('Document generated:', e.detail);
            
            // Refresh dashboard if available
            if (window.dashboardManager) {
                window.dashboardManager.refreshDashboard();
            }
            
            // Update tracker display if visible
            const trackerModal = document.querySelector('.tracker-modal');
            if (trackerModal) {
                const clientId = e.detail.clientId;
                // Refresh tracker display
                if (window.TrackerBulkUpdate?.instance) {
                    window.TrackerBulkUpdate.instance.loadClients();
                }
            }
        });
        
        // Add document generation to client details modal
        const originalShowClientDetailsModal = window.showClientDetailsModal;
        if (originalShowClientDetailsModal) {
            window.showClientDetailsModal = async function(client) {
                // Call original function
                await originalShowClientDetailsModal.call(this, client);
                
                // Add document section to the modal after a delay
                setTimeout(() => {
                    const modalBody = document.querySelector('.modal-body');
                    if (modalBody && !modalBody.querySelector('.client-documents-section')) {
                        const documents = window.documentGenerator.getClientDocuments(client.id);
                        const daysInCare = window.daysBetween(client.admissionDate) || 0;
                        const recommended = window.documentGenerator.getRecommendedDocuments(client, daysInCare);
                        
                        const documentsHtml = `
                            <div class="client-documents-section">
                                <h4>üìÑ Documents</h4>
                                
                                ${recommended.length > 0 ? `
                                    <div class="recommended-documents">
                                        <h5>Recommended Documents</h5>
                                        <div class="doc-recommendations">
                                            ${recommended.map(doc => `
                                                <button class="btn-doc-recommend" 
                                                        onclick="window.generateDocument('${client.id}', '${doc.key}')">
                                                    ${doc.icon} ${doc.name}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="document-history">
                                    <h5>Document History</h5>
                                    ${documents.length > 0 ? `
                                        <div class="doc-history-list">
                                            ${documents.map(doc => `
                                                <div class="doc-history-item">
                                                    <span class="doc-icon">${window.documentGenerator.documentTypes[doc.type]?.icon || 'üìÑ'}</span>
                                                    <span class="doc-name">${doc.name}</span>
                                                    <span class="doc-date">${window.formatDate(doc.createdAt)}</span>
                                                    <button class="btn-doc-action" onclick="window.documentGenerator.viewDocument('${doc.id}')">View</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : '<p class="no-documents">No documents generated yet</p>'}
                                    
                                    <button class="btn btn-primary btn-sm" onclick="window.generateDocument('${client.id}')">
                                        Generate New Document
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        modalBody.insertAdjacentHTML('beforeend', documentsHtml);
                    }
                }, 200);
            };
        }
        
        // Add styles
        if (!document.querySelector('#document-generator-ui-styles')) {
            const styles = document.createElement('style');
            styles.id = 'document-generator-ui-styles';
            styles.textContent = `
                /* Dashboard button */
                #btnGenerateDoc {
                    margin-right: 8px;
                }
                
                /* Client card quick button */
                .btn-doc-gen-quick {
                    position: absolute;
                    top: 8px;
                    right: 40px;
                    background: var(--ccp-primary-100);
                    border: 1px solid var(--ccp-primary-300);
                    border-radius: 6px;
                    padding: 4px 8px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .btn-doc-gen-quick:hover {
                    background: var(--ccp-primary-200);
                    transform: translateY(-1px);
                }
                
                /* Client documents section */
                .client-documents-section {
                    margin-top: 24px;
                    padding-top: 24px;
                    border-top: 2px solid #e5e7eb;
                }
                
                .client-documents-section h4 {
                    margin: 0 0 16px 0;
                    color: #1f2937;
                }
                
                .client-documents-section h5 {
                    margin: 0 0 12px 0;
                    color: #374151;
                    font-size: 16px;
                }
                
                .recommended-documents {
                    background: #f0f9ff;
                    padding: 16px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                }
                
                .doc-recommendations {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                }
                
                .btn-doc-recommend {
                    background: white;
                    border: 1px solid #3b82f6;
                    color: #3b82f6;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 14px;
                }
                
                .btn-doc-recommend:hover {
                    background: #3b82f6;
                    color: white;
                }
                
                .document-history {
                    background: #f9fafb;
                    padding: 16px;
                    border-radius: 8px;
                }
                
                .doc-history-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    margin-bottom: 16px;
                }
                
                .doc-history-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px;
                    background: white;
                    border-radius: 6px;
                    border: 1px solid #e5e7eb;
                }
                
                .doc-history-item .doc-icon {
                    font-size: 20px;
                }
                
                .doc-history-item .doc-name {
                    flex: 1;
                    font-size: 14px;
                }
                
                .doc-history-item .doc-date {
                    font-size: 12px;
                    color: #6b7280;
                }
                
                .btn-doc-action {
                    background: none;
                    border: 1px solid #e5e7eb;
                    padding: 4px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .btn-doc-action:hover {
                    background: #f3f4f6;
                    border-color: #d1d5db;
                }
                
                .no-documents {
                    text-align: center;
                    color: #6b7280;
                    font-style: italic;
                    margin: 16px 0;
                }
            `;
            document.head.appendChild(styles);
        }
        
        // Initialize dashboard button after DOM updates
        setTimeout(addDashboardButton, 500);
        
        // Re-add button when dashboard refreshes
        const observer = new MutationObserver(() => {
            addDashboardButton();
        });
        
        const dashboardContainer = document.querySelector('#dashboardTab');
        if (dashboardContainer) {
            observer.observe(dashboardContainer, { childList: true, subtree: true });
        }
        
        console.log('‚úÖ Document Generator UI integration complete');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: client-document-storage.js
/**
 * Client Document Storage Enhancement
 * Adds document storage to client records and document management features
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.clientManager || !window.documentGenerator) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceClientStorage();
    }
    
    function enhanceClientStorage() {
        // Extend client schema to include documents
        const originalCreateClient = window.clientManager.createClient;
        window.clientManager.createClient = async function(clientData) {
            // Ensure documents array exists
            clientData.documents = clientData.documents || [];
            return originalCreateClient.call(this, clientData);
        };
        
        // Extend update to handle documents
        const originalUpdateClient = window.clientManager.updateClient;
        window.clientManager.updateClient = async function(clientId, updates) {
            // If documents are being updated, handle special logic
            if (updates.documents) {
                const client = await this.getClient(clientId);
                if (client) {
                    // Merge documents arrays if adding
                    if (updates.$addToDocuments) {
                        updates.documents = [...(client.documents || []), ...updates.$addToDocuments];
                        delete updates.$addToDocuments;
                    }
                }
            }
            
            return originalUpdateClient.call(this, clientId, updates);
        };
        
        // Add method to add document to client
        window.clientManager.addDocument = async function(clientId, document) {
            const client = await this.getClient(clientId);
            if (!client) {
                throw new Error('Client not found');
            }
            
            // Ensure documents array exists
            if (!client.documents) {
                client.documents = [];
            }
            
            // Add document
            client.documents.push({
                ...document,
                addedAt: new Date().toISOString()
            });
            
            // Update client
            await this.updateClient(clientId, { documents: client.documents });
            
            return document;
        };
        
        // Add method to get client documents
        window.clientManager.getClientDocuments = async function(clientId) {
            const client = await this.getClient(clientId);
            return client?.documents || [];
        };
        
        // Override document generator to store with client
        const originalGenerateDocument = window.documentGenerator.generateDocument;
        window.documentGenerator.generateDocument = async function() {
            // Call original
            await originalGenerateDocument.call(this);
            
            // Get the generated document
            const workflow = this.activeWorkflow;
            if (workflow && workflow.client) {
                const lastDocument = this.generatedDocuments[this.generatedDocuments.length - 1];
                if (lastDocument) {
                    // Store with client
                    await window.clientManager.addDocument(workflow.client.id, lastDocument);
                    
                    // Fire event
                    window.dispatchEvent(new CustomEvent('client:documentAdded', {
                        detail: {
                            clientId: workflow.client.id,
                            document: lastDocument
                        }
                    }));
                }
            }
        };
        
        // Override getClientDocuments to use client storage
        window.documentGenerator.getClientDocuments = function(clientId) {
            // First check in-memory storage
            const inMemory = this.generatedDocuments.filter(doc => doc.clientId === clientId);
            
            // Then check client storage (async, so return promise)
            return window.clientManager.getClientDocuments(clientId).then(stored => {
                // Merge and deduplicate by ID
                const allDocs = [...inMemory];
                stored.forEach(doc => {
                    if (!allDocs.find(d => d.id === doc.id)) {
                        allDocs.push(doc);
                    }
                });
                
                // Sort by date (newest first)
                allDocs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                return allDocs;
            }).catch(() => inMemory); // Fallback to in-memory if error
        };
        
        // Add document vault functionality
        window.documentVault = {
            async getAllDocuments() {
                const clients = await window.clientManager.getAllClients();
                const allDocuments = [];
                
                for (const client of clients) {
                    const documents = await window.clientManager.getClientDocuments(client.id);
                    documents.forEach(doc => {
                        allDocuments.push({
                            ...doc,
                            clientInitials: client.initials,
                            clientHouse: client.houseId,
                            clientStatus: client.status
                        });
                    });
                }
                
                // Sort by date (newest first)
                allDocuments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                return allDocuments;
            },
            
            async searchDocuments(searchTerm) {
                const allDocs = await this.getAllDocuments();
                const term = searchTerm.toLowerCase();
                
                return allDocs.filter(doc => 
                    doc.name.toLowerCase().includes(term) ||
                    doc.clientInitials.toLowerCase().includes(term) ||
                    doc.type.toLowerCase().includes(term) ||
                    (doc.clientHouse && doc.clientHouse.toLowerCase().includes(term))
                );
            },
            
            async getDocumentsByType(type) {
                const allDocs = await this.getAllDocuments();
                return allDocs.filter(doc => doc.type === type);
            },
            
            async getDocumentsByDateRange(startDate, endDate) {
                const allDocs = await this.getAllDocuments();
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                return allDocs.filter(doc => {
                    const docDate = new Date(doc.createdAt);
                    return docDate >= start && docDate <= end;
                });
            },
            
            showVault() {
                window.showModal({
                    title: 'üóÉÔ∏è Document Vault',
                    content: '<div id="documentVaultContent">Loading...</div>',
                    size: 'large',
                    buttons: [
                        {
                            text: 'Export All',
                            action: () => this.exportAll()
                        },
                        {
                            text: 'Close',
                            primary: true,
                            action: () => window.closeModal()
                        }
                    ]
                });
                
                // Load vault content
                this.loadVaultContent();
            },
            
            async loadVaultContent() {
                const contentEl = document.getElementById('documentVaultContent');
                if (!contentEl) return;
                
                try {
                    const documents = await this.getAllDocuments();
                    
                    contentEl.innerHTML = `
                        <div class="vault-header">
                            <div class="vault-stats">
                                <span class="stat-item">üìÑ ${documents.length} Total Documents</span>
                            </div>
                            <div class="vault-search">
                                <input type="text" id="vaultSearch" placeholder="Search documents..." class="vault-search-input">
                                <select id="vaultTypeFilter" class="vault-filter">
                                    <option value="">All Types</option>
                                    <option value="aftercare-options">Aftercare Options</option>
                                    <option value="aftercare-plan">Aftercare Plan</option>
                                    <option value="discharge-packet">Discharge Packet</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="vault-documents" id="vaultDocumentsList">
                            ${documents.length > 0 ? documents.map(doc => `
                                <div class="vault-doc-item">
                                    <div class="vault-doc-icon">${window.documentGenerator.documentTypes[doc.type]?.icon || 'üìÑ'}</div>
                                    <div class="vault-doc-info">
                                        <div class="vault-doc-name">${doc.name}</div>
                                        <div class="vault-doc-meta">
                                            <span class="meta-item">üë§ ${doc.clientInitials}</span>
                                            <span class="meta-item">üè† ${doc.clientHouse || 'No House'}</span>
                                            <span class="meta-item">üìÖ ${window.formatDate(doc.createdAt)}</span>
                                            <span class="meta-item">‚úçÔ∏è ${doc.createdBy}</span>
                                        </div>
                                    </div>
                                    <div class="vault-doc-actions">
                                        <button class="btn btn-sm" onclick="window.documentGenerator.viewDocument('${doc.id}')">View</button>
                                        <button class="btn btn-sm" onclick="window.documentGenerator.printDocument('${doc.id}')">Print</button>
                                    </div>
                                </div>
                            `).join('') : '<p class="vault-empty">No documents in vault</p>'}
                        </div>
                    `;
                    
                    // Add search functionality
                    const searchInput = document.getElementById('vaultSearch');
                    const typeFilter = document.getElementById('vaultTypeFilter');
                    
                    const filterDocuments = async () => {
                        const searchTerm = searchInput.value;
                        const typeValue = typeFilter.value;
                        
                        let filtered = documents;
                        
                        if (searchTerm) {
                            filtered = await this.searchDocuments(searchTerm);
                        }
                        
                        if (typeValue) {
                            filtered = filtered.filter(doc => doc.type === typeValue);
                        }
                        
                        // Update list
                        const listEl = document.getElementById('vaultDocumentsList');
                        if (filtered.length > 0) {
                            listEl.innerHTML = filtered.map(doc => `
                                <div class="vault-doc-item">
                                    <div class="vault-doc-icon">${window.documentGenerator.documentTypes[doc.type]?.icon || 'üìÑ'}</div>
                                    <div class="vault-doc-info">
                                        <div class="vault-doc-name">${doc.name}</div>
                                        <div class="vault-doc-meta">
                                            <span class="meta-item">üë§ ${doc.clientInitials}</span>
                                            <span class="meta-item">üè† ${doc.clientHouse || 'No House'}</span>
                                            <span class="meta-item">üìÖ ${window.formatDate(doc.createdAt)}</span>
                                            <span class="meta-item">‚úçÔ∏è ${doc.createdBy}</span>
                                        </div>
                                    </div>
                                    <div class="vault-doc-actions">
                                        <button class="btn btn-sm" onclick="window.documentGenerator.viewDocument('${doc.id}')">View</button>
                                        <button class="btn btn-sm" onclick="window.documentGenerator.printDocument('${doc.id}')">Print</button>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            listEl.innerHTML = '<p class="vault-empty">No documents match your search</p>';
                        }
                    };
                    
                    searchInput.addEventListener('input', window.debounce(filterDocuments, 300));
                    typeFilter.addEventListener('change', filterDocuments);
                    
                } catch (error) {
                    console.error('Error loading vault:', error);
                    contentEl.innerHTML = '<p class="vault-error">Error loading documents</p>';
                }
            },
            
            async exportAll() {
                try {
                    const documents = await this.getAllDocuments();
                    
                    let csv = 'Document Name,Type,Client,House,Created Date,Created By\n';
                    
                    documents.forEach(doc => {
                        csv += `"${doc.name}","${doc.type}","${doc.clientInitials}",`;
                        csv += `"${doc.clientHouse || ''}","${window.formatDate(doc.createdAt)}","${doc.createdBy}"\n`;
                    });
                    
                    // Download CSV
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `document-vault-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    window.showNotification('Document vault exported successfully', 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    window.showNotification('Failed to export document vault', 'error');
                }
            }
        };
        
        // Add styles
        if (!document.querySelector('#client-document-storage-styles')) {
            const styles = document.createElement('style');
            styles.id = 'client-document-storage-styles';
            styles.textContent = `
                /* Document Vault Styles */
                .vault-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 16px;
                    border-bottom: 2px solid #e5e7eb;
                }
                
                .vault-stats {
                    display: flex;
                    gap: 20px;
                }
                
                .stat-item {
                    font-size: 16px;
                    font-weight: 500;
                    color: #374151;
                }
                
                .vault-search {
                    display: flex;
                    gap: 12px;
                }
                
                .vault-search-input {
                    width: 250px;
                    padding: 8px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                }
                
                .vault-filter {
                    padding: 8px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                    background: white;
                }
                
                .vault-documents {
                    max-height: 500px;
                    overflow-y: auto;
                }
                
                .vault-doc-item {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                    padding: 16px;
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    transition: all 0.2s;
                }
                
                .vault-doc-item:hover {
                    background: #f9fafb;
                    border-color: #d1d5db;
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                }
                
                .vault-doc-icon {
                    font-size: 32px;
                    flex-shrink: 0;
                }
                
                .vault-doc-info {
                    flex: 1;
                }
                
                .vault-doc-name {
                    font-weight: 600;
                    font-size: 16px;
                    color: #1f2937;
                    margin-bottom: 4px;
                }
                
                .vault-doc-meta {
                    display: flex;
                    gap: 16px;
                    font-size: 13px;
                    color: #6b7280;
                }
                
                .meta-item {
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }
                
                .vault-doc-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .vault-empty {
                    text-align: center;
                    color: #6b7280;
                    font-style: italic;
                    padding: 40px;
                }
                
                .vault-error {
                    text-align: center;
                    color: #ef4444;
                    padding: 40px;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Client document storage enhanced');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: document-vault-ui.js
/**
 * Document Vault UI Enhancement
 * Adds vault button to dashboard and integrates document storage UI
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.documentVault || !window.dashboardWidgets) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        integrateVaultUI();
    }
    
    function integrateVaultUI() {
        // Add vault button to dashboard header
        const addVaultButton = () => {
            const dashboardControls = document.querySelector('.dashboard-controls');
            if (dashboardControls && !document.querySelector('#btnDocumentVault')) {
                // Find the morning review button as reference point
                const morningReviewBtn = dashboardControls.querySelector('.btn-morning-review');
                
                const button = document.createElement('button');
                button.id = 'btnDocumentVault';
                button.className = 'btn btn-secondary';
                button.innerHTML = 'üóÉÔ∏è Document Vault';
                button.onclick = () => window.documentVault.showVault();
                button.title = 'View all generated documents';
                
                if (morningReviewBtn) {
                    morningReviewBtn.parentNode.insertBefore(button, morningReviewBtn.nextSibling);
                } else {
                    dashboardControls.appendChild(button);
                }
            }
        };
        
        // Add vault to quick actions
        const originalRender = window.dashboardWidgets.widgets.get('quickActions')?.render;
        if (originalRender) {
            window.dashboardWidgets.widgets.get('quickActions').render = function() {
                let html = originalRender.call(this);
                
                // Add vault action
                const vaultAction = `
                    <button class="quick-action-btn" onclick="window.documentVault.showVault()">
                        <span class="action-icon">üóÉÔ∏è</span>
                        <span class="action-label">Document Vault</span>
                    </button>
                `;
                
                // Insert before last closing div
                const insertPos = html.lastIndexOf('</div></div>');
                html = html.slice(0, insertPos) + vaultAction + html.slice(insertPos);
                
                return html;
            };
        }
        
        // Override document generator UI to update vault count
        const originalShowModal = window.documentGenerator.showModal;
        if (originalShowModal) {
            window.documentGenerator.showModal = async function(...args) {
                const result = originalShowModal.call(this, ...args);
                
                // Update vault button with document count
                const vaultBtn = document.querySelector('#btnDocumentVault');
                if (vaultBtn && window.documentVault) {
                    try {
                        const docs = await window.documentVault.getAllDocuments();
                        vaultBtn.innerHTML = `üóÉÔ∏è Vault (${docs.length})`;
                    } catch (e) {
                        console.error('Error updating vault count:', e);
                    }
                }
                
                return result;
            };
        }
        
        // Listen for document generation to update count
        window.addEventListener('client:documentAdded', async (e) => {
            const vaultBtn = document.querySelector('#btnDocumentVault');
            if (vaultBtn && window.documentVault) {
                try {
                    const docs = await window.documentVault.getAllDocuments();
                    vaultBtn.innerHTML = `üóÉÔ∏è Vault (${docs.length})`;
                } catch (e) {
                    console.error('Error updating vault count:', e);
                }
            }
        });
        
        // Add keyboard shortcut (Ctrl+V for vault)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'v' && !e.shiftKey) {
                e.preventDefault();
                window.documentVault.showVault();
            }
        });
        
        // Initialize vault button
        setTimeout(async () => {
            addVaultButton();
            
            // Update with initial count
            const vaultBtn = document.querySelector('#btnDocumentVault');
            if (vaultBtn && window.documentVault) {
                try {
                    const docs = await window.documentVault.getAllDocuments();
                    if (docs.length > 0) {
                        vaultBtn.innerHTML = `üóÉÔ∏è Vault (${docs.length})`;
                    }
                } catch (e) {
                    console.error('Error loading initial vault count:', e);
                }
            }
        }, 500);
        
        // Re-add button when dashboard refreshes
        const observer = new MutationObserver(() => {
            addVaultButton();
        });
        
        const dashboardContainer = document.querySelector('#dashboardTab');
        if (dashboardContainer) {
            observer.observe(dashboardContainer, { childList: true, subtree: true });
        }
        
        // Add styles for vault button
        if (!document.querySelector('#document-vault-ui-styles')) {
            const styles = document.createElement('style');
            styles.id = 'document-vault-ui-styles';
            styles.textContent = `
                #btnDocumentVault {
                    margin-left: 8px;
                    position: relative;
                }
                
                #btnDocumentVault.has-new::after {
                    content: '';
                    position: absolute;
                    top: -4px;
                    right: -4px;
                    width: 8px;
                    height: 8px;
                    background: #ef4444;
                    border-radius: 50%;
                    animation: pulse 2s infinite;
                }
                
                @keyframes pulse {
                    0% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.7; transform: scale(1.1); }
                    100% { opacity: 1; transform: scale(1); }
                }
                
                /* Quick action styling */
                .quick-action-btn[onclick*="documentVault"] {
                    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
                }
                
                .quick-action-btn[onclick*="documentVault"]:hover {
                    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Document Vault UI integrated');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: empty-states-errors.js
/**
 * Empty States and Error Handling Enhancement
 * Adds contextual empty states, loading indicators, and error recovery
 */

(function() {
    'use strict';
    
    // Loading state manager
    window.loadingManager = {
        activeLoaders: new Set(),
        
        show(id, message = 'Loading...') {
            this.activeLoaders.add(id);
            
            // Find container element
            const element = document.getElementById(id) || document.querySelector(`[data-widget="${id}"]`);
            if (!element) return;
            
            // Store original content
            if (!element.dataset.originalContent) {
                element.dataset.originalContent = element.innerHTML;
            }
            
            // Show loading state
            element.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p class="loading-message">${message}</p>
                </div>
            `;
            
            element.classList.add('is-loading');
        },
        
        hide(id) {
            this.activeLoaders.delete(id);
            
            const element = document.getElementById(id) || document.querySelector(`[data-widget="${id}"]`);
            if (!element) return;
            
            // Restore original content if available
            if (element.dataset.originalContent) {
                element.innerHTML = element.dataset.originalContent;
                delete element.dataset.originalContent;
            }
            
            element.classList.remove('is-loading');
        },
        
        isLoading(id) {
            return this.activeLoaders.has(id);
        }
    };
    
    // Empty state configurations
    const emptyStateConfigs = {
        flightPlan: {
            title: 'All Clear!',
            message: 'No urgent tasks at the moment. Great job staying on top of everything!',
            icon: '‚úÖ',
            action: {
                text: 'View All Clients',
                handler: () => window.dashboardManager?.setView('allClients')
            }
        },
        missions: {
            title: 'Mission Complete!',
            message: 'All tasks for today have been completed. Take a moment to review tomorrow\'s schedule.',
            icon: 'üéØ',
            action: {
                text: 'Morning Review',
                handler: () => window.morningReview?.show()
            }
        },
        journeyRadar: {
            title: 'No Active Clients',
            message: 'There are no active clients to display. Add a new client to get started.',
            icon: 'üë•',
            action: {
                text: 'Add Client',
                handler: () => window.showAddClientModal?.()
            }
        },
        houseWeather: {
            title: 'No House Data',
            message: 'House weather information will appear here once clients are assigned to houses.',
            icon: 'üè†'
        },
        default: {
            title: 'No Data Available',
            message: 'This section will populate once relevant data is available.',
            icon: '‚ÑπÔ∏è'
        }
    };
    
    // Error recovery strategies
    const errorRecovery = {
        async retry(fn, maxAttempts = 3, delay = 1000) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    lastError = error;
                    console.warn(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, delay * attempt));
                    }
                }
            }
            
            throw lastError;
        },
        
        handleError(widgetName, error, container) {
            console.error(`Error in ${widgetName}:`, error);
            
            const errorConfig = {
                title: 'Something went wrong',
                message: error.message || 'An unexpected error occurred',
                icon: '‚ö†Ô∏è',
                actions: [
                    {
                        text: 'Retry',
                        handler: () => window.dashboardManager?.refreshDashboard()
                    }
                ]
            };
            
            if (container) {
                container.innerHTML = this.renderErrorState(errorConfig);
            }
            
            // Report to error tracking if available
            if (window.errorTracker) {
                window.errorTracker.report(error, { widget: widgetName });
            }
        },
        
        renderErrorState(config) {
            return `
                <div class="error-state">
                    <div class="error-icon">${config.icon}</div>
                    <h3 class="error-title">${config.title}</h3>
                    <p class="error-message">${config.message}</p>
                    ${config.actions ? `
                        <div class="error-actions">
                            ${config.actions.map(action => `
                                <button class="btn btn-primary" onclick="(${action.handler})()">
                                    ${action.text}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
    };
    
    // Enhance widget rendering with empty states
    function enhanceWidgets() {
        if (!window.dashboardWidgets?.widgets) return;
        
        // Enhance each widget
        window.dashboardWidgets.widgets.forEach((widget, name) => {
            const originalRender = widget.render;
            if (!originalRender) return;
            
            widget.render = function() {
                const container = this.container;
                let widgetName = name;
                
                try {
                    // Show loading state
                    if (container) {
                        window.loadingManager.show(container.id || widgetName, `Loading ${widgetName}...`);
                    }
                    
                    // Call original render
                    let content = originalRender.call(this);
                    
                    // Check if content is empty or indicates no data
                    const isEmptyContent = !content || 
                        content.trim() === '' || 
                        content.includes('No data') ||
                        content.includes('no items') ||
                        (content.match(/<div/g) || []).length <= 2; // Just wrapper divs
                    
                    if (isEmptyContent) {
                        const config = emptyStateConfigs[widgetName] || emptyStateConfigs.default;
                        content = renderEmptyState(config);
                    }
                    
                    // Hide loading state
                    if (container) {
                        window.loadingManager.hide(container.id || widgetName);
                    }
                    
                    return content;
                    
                } catch (error) {
                    // Hide loading state
                    if (container) {
                        window.loadingManager.hide(container.id || widgetName);
                    }
                    
                    // Handle error
                    errorRecovery.handleError(widgetName, error, container);
                    return errorRecovery.renderErrorState({
                        title: 'Widget Error',
                        message: `Failed to load ${widgetName}`,
                        icon: '‚ùå',
                        actions: [{
                            text: 'Retry',
                            handler: () => this.refresh?.()
                        }]
                    });
                }
            };
            
            // Add retry capability
            if (!widget.retry) {
                widget.retry = async function() {
                    try {
                        await errorRecovery.retry(() => {
                            if (this.container) {
                                this.container.innerHTML = this.render();
                            }
                        });
                    } catch (error) {
                        errorRecovery.handleError(name, error, this.container);
                    }
                };
            }
        });
    }
    
    // Render empty state
    function renderEmptyState(config) {
        return `
            <div class="empty-state">
                <div class="empty-icon">${config.icon}</div>
                <h3 class="empty-title">${config.title}</h3>
                <p class="empty-message">${config.message}</p>
                ${config.action ? `
                    <button class="btn btn-primary empty-action" onclick="(${config.action.handler})()">
                        ${config.action.text}
                    </button>
                ` : ''}
            </div>
        `;
    }
    
    // Enhance data loading functions
    function enhanceDataLoading() {
        // Enhance clientManager
        if (window.clientManager) {
            const originalGetAllClients = window.clientManager.getAllClients;
            window.clientManager.getAllClients = async function() {
                return errorRecovery.retry(async () => {
                    const result = await originalGetAllClients.call(this);
                    if (!result) throw new Error('Failed to load clients');
                    return result;
                });
            };
        }
        
        // Enhance dashboard data loading
        if (window.dashboardManager) {
            const originalLoadDashboardData = window.dashboardManager.loadDashboardData;
            window.dashboardManager.loadDashboardData = async function() {
                const widgetContainer = document.querySelector('.dashboard-grid');
                if (widgetContainer) {
                    widgetContainer.classList.add('loading');
                }
                
                try {
                    const result = await errorRecovery.retry(() => 
                        originalLoadDashboardData.call(this)
                    );
                    
                    if (widgetContainer) {
                        widgetContainer.classList.remove('loading');
                    }
                    
                    return result;
                } catch (error) {
                    if (widgetContainer) {
                        widgetContainer.classList.remove('loading');
                    }
                    
                    // Show error notification
                    window.showNotification(
                        'Failed to load dashboard data. Please refresh the page.',
                        'error',
                        'Dashboard Error'
                    );
                    
                    throw error;
                }
            };
        }
    }
    
    // Add contextual help
    window.contextualHelp = {
        show(context) {
            const helpTexts = {
                'empty-flight-plan': 'The Daily Flight Plan shows urgent tasks that need attention. When it\'s empty, all critical items are handled!',
                'empty-missions': 'Today\'s Missions tracks your daily goals. Complete all missions to maintain excellent care standards.',
                'loading-error': 'If loading issues persist, try refreshing the page or clearing your browser cache.',
                'no-clients': 'Add your first client to start tracking their aftercare journey.'
            };
            
            const text = helpTexts[context] || 'Need help? Contact support for assistance.';
            
            window.showNotification(text, 'info', 'Tip', 5000);
        }
    };
    
    // Add loading states CSS
    if (!document.querySelector('#empty-states-errors-styles')) {
        const styles = document.createElement('style');
        styles.id = 'empty-states-errors-styles';
        styles.textContent = `
            /* Loading States */
            .loading-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                padding: 40px;
                text-align: center;
            }
            
            .loading-spinner {
                width: 48px;
                height: 48px;
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-top-color: var(--ccp-primary-500);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 16px;
            }
            
            .loading-message {
                color: #6b7280;
                font-size: 14px;
                margin: 0;
            }
            
            .is-loading {
                position: relative;
                pointer-events: none;
                opacity: 0.8;
            }
            
            .dashboard-grid.loading {
                opacity: 0.7;
                pointer-events: none;
            }
            
            /* Empty States */
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                padding: 40px 20px;
                text-align: center;
                animation: fadeIn 0.3s ease;
            }
            
            .empty-icon {
                font-size: 64px;
                margin-bottom: 16px;
                opacity: 0.7;
            }
            
            .empty-title {
                margin: 0 0 8px 0;
                font-size: 20px;
                font-weight: 600;
                color: #1f2937;
            }
            
            .empty-message {
                margin: 0 0 24px 0;
                color: #6b7280;
                font-size: 14px;
                max-width: 300px;
                line-height: 1.5;
            }
            
            .empty-action {
                margin-top: 8px;
            }
            
            /* Error States */
            .error-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                padding: 40px 20px;
                text-align: center;
                background: #fef2f2;
                border-radius: 8px;
                margin: 16px;
            }
            
            .error-icon {
                font-size: 48px;
                margin-bottom: 16px;
                color: #ef4444;
            }
            
            .error-title {
                margin: 0 0 8px 0;
                font-size: 18px;
                font-weight: 600;
                color: #991b1b;
            }
            
            .error-message {
                margin: 0 0 16px 0;
                color: #7f1d1d;
                font-size: 14px;
            }
            
            .error-actions {
                display: flex;
                gap: 12px;
                margin-top: 8px;
            }
            
            /* Animations */
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            /* Skeleton Loading */
            .skeleton {
                background: linear-gradient(
                    90deg,
                    #f3f4f6 25%,
                    #e5e7eb 50%,
                    #f3f4f6 75%
                );
                background-size: 200% 100%;
                animation: skeleton 1.5s infinite;
                border-radius: 4px;
            }
            
            .skeleton-text {
                height: 16px;
                margin-bottom: 8px;
            }
            
            .skeleton-title {
                height: 24px;
                width: 60%;
                margin-bottom: 16px;
            }
            
            @keyframes skeleton {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
            
            /* Help Tooltips */
            .help-tip {
                position: absolute;
                top: 8px;
                right: 8px;
                width: 20px;
                height: 20px;
                background: #e5e7eb;
                border-radius: 50%;
                cursor: help;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                color: #6b7280;
                transition: all 0.2s;
            }
            
            .help-tip:hover {
                background: #d1d5db;
                color: #374151;
            }
            
            /* Contextual Empty States */
            .zone-red .empty-state .empty-icon {
                color: #ef4444;
            }
            
            .zone-purple .empty-state .empty-icon {
                color: #a855f7;
            }
            
            .zone-yellow .empty-state .empty-icon {
                color: #eab308;
            }
            
            .zone-green .empty-state .empty-icon {
                color: #22c55e;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Initialize enhancements
    function initialize() {
        enhanceWidgets();
        enhanceDataLoading();
        
        console.log('‚úÖ Empty states and error handling initialized');
    }
    
    // Wait for dependencies
    if (window.dashboardWidgets && window.clientManager) {
        initialize();
    } else {
        const checkInterval = setInterval(() => {
            if (window.dashboardWidgets && window.clientManager) {
                clearInterval(checkInterval);
                initialize();
            }
        }, 100);
        
        setTimeout(() => clearInterval(checkInterval), 10000);
    }
})();





// Enhancement: alert-actionability.js
/**
 * Alert Actionability Enhancement
 * Makes alerts clickable, adds bulk actions, filters, and detailed alert modals
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardWidgets || !window.dashboardManager || !window.showModal) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceAlerts();
    }
    
    function enhanceAlerts() {
        // Enhance Flight Plan widget to make alerts clickable
        const flightPlanWidget = window.dashboardWidgets?.widgets?.get('flightPlan');
        if (flightPlanWidget) {
            const originalRenderPriorityItem = flightPlanWidget.renderPriorityItem;
            
            flightPlanWidget.renderPriorityItem = function(item, zone) {
                let html = originalRenderPriorityItem.call(this, item, zone);
                
                // Make the entire item clickable
                const itemWrapper = html.match(/<div[^>]*class="[^"]*priority-item[^"]*"[^>]*>/);
                if (itemWrapper) {
                    // Add click handler and cursor pointer
                    html = html.replace(
                        /<div([^>]*class="[^"]*priority-item[^"]*"[^>]*)>/,
                        '<div$1 onclick="window.handleAlertClick(event, \'' + item.client.id + '\', \'' + item.type + '\', \'' + zone + '\')" style="cursor: pointer;">'
                    );
                    
                    // Add hover effect class
                    html = html.replace(
                        /class="([^"]*priority-item[^"]*)"/,
                        'class="$1 alert-clickable"'
                    );
                }
                
                return html;
            };
        }
        
        // Global alert click handler
        window.handleAlertClick = function(event, clientId, alertType, zone) {
            // Prevent default if clicking on action buttons
            if (event.target.closest('button')) {
                return;
            }
            
            // Show alert details modal
            showAlertDetailsModal(clientId, alertType, zone);
        };
        
        // Show alert details modal
        async function showAlertDetailsModal(clientId, alertType, zone) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                // Get alert details
                const alert = getAlertDetails(client, alertType, zone);
                
                // Build modal content
                const content = `
                    <div class="alert-details-modal">
                        <div class="alert-header">
                            <div class="alert-client-info">
                                <span class="client-badge-large">${client.initials}</span>
                                <div class="client-details">
                                    <div class="client-name">${client.initials}</div>
                                    <div class="client-meta">
                                        <span>üè† ${client.houseId || 'No House'}</span>
                                        <span>üìÖ Day ${window.daysBetween(client.admissionDate) || 0}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="alert-zone-badge zone-${zone}">
                                ${zone.charAt(0).toUpperCase() + zone.slice(1)} Zone
                            </div>
                        </div>
                        
                        <div class="alert-content">
                            <div class="alert-message-section">
                                <h4>Alert Details</h4>
                                <p class="alert-message">${alert.message}</p>
                                ${alert.dueDate ? `<p class="alert-due"><strong>Due:</strong> ${alert.dueDate}</p>` : ''}
                                ${alert.description ? `<p class="alert-description">${alert.description}</p>` : ''}
                            </div>
                            
                            ${alert.trackerItem ? `
                                <div class="tracker-context">
                                    <h4>Tracker Context</h4>
                                    <div class="tracker-info">
                                        <span class="tracker-label">${alert.trackerItem.label}</span>
                                        <span class="tracker-status">${alert.trackerItem.complete ? '‚úÖ Complete' : '‚è≥ Pending'}</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="client-context">
                                <h4>Client Context</h4>
                                <div class="context-grid">
                                    <div class="context-item">
                                        <span class="context-label">Admission Date:</span>
                                        <span class="context-value">${window.formatDate(client.admissionDate)}</span>
                                    </div>
                                    ${client.dischargeDate ? `
                                        <div class="context-item">
                                            <span class="context-label">Discharge Date:</span>
                                            <span class="context-value">${window.formatDate(client.dischargeDate)}</span>
                                        </div>
                                    ` : ''}
                                    ${window.trackerEngine ? (() => {
                                        const score = window.trackerEngine.getCompletionScore(client);
                                        return `
                                            <div class="context-item">
                                                <span class="context-label">Tracker Completion:</span>
                                                <span class="context-value">${score.percentage}%</span>
                                            </div>
                                        `;
                                    })() : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert-actions-section">
                            <h4>Quick Actions</h4>
                            <div class="action-buttons-grid">
                                ${alert.isTrackerTask ? `
                                    <button class="btn btn-success" onclick="window.completeAlertFromModal('${clientId}', '${alert.trackerId}')">
                                        ‚úì Mark Complete
                                    </button>
                                ` : ''}
                                <button class="btn btn-primary" onclick="window.viewClientFromAlert('${clientId}')">
                                    üë§ View Client Details
                                </button>
                                ${alert.canGenerateDoc ? `
                                    <button class="btn btn-secondary" onclick="window.generateDocFromAlert('${clientId}', '${alert.docType}')">
                                        üìÑ Generate Document
                                    </button>
                                ` : ''}
                                ${alert.canOpenTracker ? `
                                    <button class="btn btn-secondary" onclick="window.openTrackerFromAlert('${clientId}')">
                                        üìä Open Tracker
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: 'üîî Alert Details',
                    content: content,
                    size: 'large',
                    buttons: [
                        {
                            text: 'Close',
                            primary: true,
                            action: () => window.closeModal()
                        }
                    ]
                });
                
            } catch (error) {
                console.error('Error showing alert details:', error);
                window.showNotification('Failed to load alert details', 'error');
            }
        }
        
        // Get alert details
        function getAlertDetails(client, alertType, zone) {
            const daysInCare = window.daysBetween(client.admissionDate) || 0;
            
            // Map alert types to details
            const alertMap = {
                'discharge-soon': {
                    message: `Discharge scheduled in ${daysInCare} days`,
                    dueDate: client.dischargeDate ? window.formatDate(client.dischargeDate) : null,
                    description: 'Ensure all discharge requirements are completed',
                    canGenerateDoc: true,
                    docType: 'discharge-packet',
                    canOpenTracker: true
                },
                'missing-critical': {
                    message: 'Critical tracker items are missing',
                    description: 'Complete critical items to ensure smooth discharge',
                    canOpenTracker: true,
                    isTrackerTask: true
                },
                'aftercare-due': {
                    message: 'Aftercare options document due',
                    dueDate: daysInCare >= 14 ? 'Due now' : `Due in ${14 - daysInCare} days`,
                    description: 'Generate aftercare options document for family review',
                    canGenerateDoc: true,
                    docType: 'aftercare-options'
                }
            };
            
            return alertMap[alertType] || {
                message: 'Action required',
                canOpenTracker: true
            };
        }
        
        // Action handlers
        window.completeAlertFromModal = async function(clientId, trackerId) {
            try {
                await window.dashboardWidgets.completeTrackerItem(clientId, trackerId);
                window.closeModal();
                window.showNotification('Alert item completed', 'success');
                window.dashboardManager.refreshDashboard();
            } catch (error) {
                console.error('Error completing alert:', error);
                window.showNotification('Failed to complete item', 'error');
            }
        };
        
        window.viewClientFromAlert = function(clientId) {
            window.closeModal();
            window.viewClientDetails(clientId);
        };
        
        window.generateDocFromAlert = function(clientId, docType) {
            window.closeModal();
            window.generateDocument(clientId, docType);
        };
        
        window.openTrackerFromAlert = function(clientId) {
            window.closeModal();
            // Open tracker bulk update for this client
            if (window.openBulkUpdate) {
                window.openBulkUpdate(clientId);
            } else {
                window.viewClientDetails(clientId);
            }
        };
        
        // Enhance bulk actions in viewAllAlerts
        const originalViewAllAlerts = window.dashboardWidgets.viewAllAlerts;
        window.dashboardWidgets.viewAllAlerts = async function() {
            // Call original to get the modal
            await originalViewAllAlerts.call(this);
            
            // Wait for modal to render
            setTimeout(() => {
                enhanceAlertsModal();
            }, 100);
        };
        
        function enhanceAlertsModal() {
            const modal = document.getElementById('globalModal');
            if (!modal) return;
            
            // Add bulk action controls
            const alertsContent = modal.querySelector('.alerts-content');
            if (!alertsContent) return;
            
            // Add checkbox to each alert item
            const alertItems = alertsContent.querySelectorAll('.alert-item');
            alertItems.forEach((item, index) => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'alert-select-checkbox';
                checkbox.dataset.index = index;
                item.insertBefore(checkbox, item.firstChild);
            });
            
            // Add bulk action bar
            const bulkBar = document.createElement('div');
            bulkBar.className = 'bulk-actions-bar';
            bulkBar.innerHTML = `
                <div class="bulk-info">
                    <span id="selectedCount">0</span> selected
                </div>
                <div class="bulk-buttons">
                    <button class="btn btn-sm" onclick="window.selectAllAlerts()">Select All</button>
                    <button class="btn btn-sm" onclick="window.deselectAllAlerts()">Deselect None</button>
                    <button class="btn btn-sm btn-success" onclick="window.bulkCompleteAlerts()" id="bulkCompleteBtn" disabled>
                        ‚úì Complete Selected
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="window.bulkViewClients()" id="bulkViewBtn" disabled>
                        üë§ View Selected Clients
                    </button>
                </div>
            `;
            
            alertsContent.insertBefore(bulkBar, alertsContent.firstChild);
            
            // Add selection handlers
            alertItems.forEach(item => {
                const checkbox = item.querySelector('.alert-select-checkbox');
                if (checkbox) {
                    checkbox.addEventListener('change', updateBulkActions);
                }
            });
        }
        
        // Bulk action functions
        window.selectAllAlerts = function() {
            document.querySelectorAll('.alert-select-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateBulkActions();
        };
        
        window.deselectAllAlerts = function() {
            document.querySelectorAll('.alert-select-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateBulkActions();
        };
        
        function updateBulkActions() {
            const selected = Array.from(document.querySelectorAll('.alert-select-checkbox:checked'));
            const count = selected.length;
            
            document.getElementById('selectedCount').textContent = count;
            
            const bulkCompleteBtn = document.getElementById('bulkCompleteBtn');
            const bulkViewBtn = document.getElementById('bulkViewBtn');
            
            if (bulkCompleteBtn) bulkCompleteBtn.disabled = count === 0;
            if (bulkViewBtn) bulkViewBtn.disabled = count === 0;
        }
        
        window.bulkCompleteAlerts = async function() {
            const selected = Array.from(document.querySelectorAll('.alert-select-checkbox:checked'));
            if (selected.length === 0) return;
            
            const confirmed = confirm(`Complete ${selected.length} selected alert(s)?`);
            if (!confirmed) return;
            
            let completed = 0;
            let failed = 0;
            
            for (const checkbox of selected) {
                const alertItem = checkbox.closest('.alert-item');
                const clientId = alertItem.dataset.clientId;
                const trackerId = alertItem.dataset.trackerId;
                
                if (clientId && trackerId) {
                    try {
                        await window.dashboardWidgets.completeTrackerItem(clientId, trackerId);
                        completed++;
                    } catch (error) {
                        failed++;
                    }
                }
            }
            
            window.showNotification(
                `Completed ${completed} alert(s)${failed > 0 ? `, ${failed} failed` : ''}`,
                completed > 0 ? 'success' : 'error'
            );
            
            window.dashboardManager.refreshDashboard();
            window.dashboardWidgets.viewAllAlerts();
        };
        
        window.bulkViewClients = function() {
            const selected = Array.from(document.querySelectorAll('.alert-select-checkbox:checked'));
            const clientIds = selected.map(cb => {
                const alertItem = cb.closest('.alert-item');
                return alertItem.dataset.clientId;
            }).filter(id => id);
            
            if (clientIds.length === 0) return;
            
            // Show client list modal
            window.showModal({
                title: `Selected Clients (${clientIds.length})`,
                content: `
                    <div class="bulk-clients-list">
                        ${clientIds.map(id => `
                            <div class="bulk-client-item">
                                <button class="btn btn-sm" onclick="window.viewClientFromAlert('${id}')">
                                    View Client ${id}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `,
                size: 'medium',
                buttons: [
                    {
                        text: 'Close',
                        action: () => window.closeModal()
                    }
                ]
            });
        };
        
        // Add styles
        if (!document.querySelector('#alert-actionability-styles')) {
            const styles = document.createElement('style');
            styles.id = 'alert-actionability-styles';
            styles.textContent = `
                /* Clickable alerts */
                .alert-clickable {
                    transition: all 0.2s;
                }
                
                .alert-clickable:hover {
                    background: #f9fafb !important;
                    transform: translateX(4px);
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                
                /* Alert details modal */
                .alert-details-modal {
                    padding: 0;
                }
                
                .alert-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    background: #f9fafb;
                    border-bottom: 2px solid #e5e7eb;
                }
                
                .alert-client-info {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                }
                
                .client-badge-large {
                    width: 56px;
                    height: 56px;
                    border-radius: 50%;
                    background: var(--ccp-primary-500);
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 24px;
                    font-weight: 600;
                }
                
                .client-details {
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                }
                
                .client-name {
                    font-size: 18px;
                    font-weight: 600;
                    color: #1f2937;
                }
                
                .client-meta {
                    display: flex;
                    gap: 16px;
                    font-size: 14px;
                    color: #6b7280;
                }
                
                .alert-zone-badge {
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-weight: 600;
                    font-size: 14px;
                }
                
                .alert-zone-badge.zone-red {
                    background: #fee2e2;
                    color: #991b1b;
                }
                
                .alert-zone-badge.zone-purple {
                    background: #f3e8ff;
                    color: #6b21a8;
                }
                
                .alert-zone-badge.zone-yellow {
                    background: #fef9c3;
                    color: #854d0e;
                }
                
                .alert-zone-badge.zone-green {
                    background: #dcfce7;
                    color: #166534;
                }
                
                .alert-content {
                    padding: 24px;
                }
                
                .alert-content h4 {
                    margin: 0 0 12px 0;
                    font-size: 16px;
                    color: #1f2937;
                }
                
                .alert-message-section {
                    margin-bottom: 24px;
                    padding-bottom: 24px;
                    border-bottom: 1px solid #e5e7eb;
                }
                
                .alert-message {
                    font-size: 16px;
                    color: #374151;
                    margin: 0 0 8px 0;
                }
                
                .alert-due {
                    color: #dc2626;
                    font-weight: 500;
                    margin: 8px 0;
                }
                
                .alert-description {
                    color: #6b7280;
                    font-size: 14px;
                    margin: 8px 0 0 0;
                }
                
                .tracker-context,
                .client-context {
                    margin-bottom: 24px;
                }
                
                .tracker-info {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px;
                    background: #f9fafb;
                    border-radius: 6px;
                }
                
                .tracker-label {
                    font-weight: 500;
                }
                
                .tracker-status {
                    font-size: 14px;
                }
                
                .context-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 12px;
                }
                
                .context-item {
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                }
                
                .context-label {
                    font-size: 12px;
                    color: #6b7280;
                }
                
                .context-value {
                    font-weight: 500;
                    color: #1f2937;
                }
                
                .alert-actions-section {
                    padding: 20px;
                    background: #f9fafb;
                    border-top: 2px solid #e5e7eb;
                }
                
                .action-buttons-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 12px;
                }
                
                /* Bulk actions */
                .bulk-actions-bar {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px 16px;
                    background: #f3f4f6;
                    border-radius: 8px;
                    margin-bottom: 16px;
                }
                
                .bulk-info {
                    font-weight: 500;
                    color: #374151;
                }
                
                .bulk-buttons {
                    display: flex;
                    gap: 8px;
                }
                
                .alert-select-checkbox {
                    margin-right: 12px;
                    cursor: pointer;
                }
                
                .bulk-clients-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    max-height: 400px;
                    overflow-y: auto;
                }
                
                .bulk-client-item {
                    padding: 12px;
                    background: #f9fafb;
                    border-radius: 6px;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Alert actionability enhanced');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: tracker-completion-enhancement.js
/**
 * Tracker Completion Enhancement
 * Adds confirmation dialogs, optional notes, undo/redo, and bulk update capabilities
 */

(function() {
    'use strict';
    
    // History stack for undo/redo
    window.trackerHistory = {
        stack: [],
        currentIndex: -1,
        maxSize: 50,
        
        push(action) {
            // Remove any actions after current index (when undoing then doing new action)
            this.stack = this.stack.slice(0, this.currentIndex + 1);
            
            // Add new action
            this.stack.push({
                ...action,
                timestamp: new Date().toISOString()
            });
            
            // Limit stack size
            if (this.stack.length > this.maxSize) {
                this.stack.shift();
            } else {
                this.currentIndex++;
            }
            
            // Save to localStorage
            this.save();
        },
        
        undo() {
            if (this.currentIndex < 0) return null;
            
            const action = this.stack[this.currentIndex];
            this.currentIndex--;
            this.save();
            
            return action;
        },
        
        redo() {
            if (this.currentIndex >= this.stack.length - 1) return null;
            
            this.currentIndex++;
            const action = this.stack[this.currentIndex];
            this.save();
            
            return action;
        },
        
        canUndo() {
            return this.currentIndex >= 0;
        },
        
        canRedo() {
            return this.currentIndex < this.stack.length - 1;
        },
        
        save() {
            try {
                localStorage.setItem('tracker_history', JSON.stringify({
                    stack: this.stack,
                    currentIndex: this.currentIndex
                }));
            } catch (e) {
                console.warn('Failed to save tracker history:', e);
            }
        },
        
        load() {
            try {
                const saved = localStorage.getItem('tracker_history');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.stack = data.stack || [];
                    this.currentIndex = data.currentIndex || -1;
                }
            } catch (e) {
                console.warn('Failed to load tracker history:', e);
            }
        }
    };
    
    // Load history on init
    window.trackerHistory.load();
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardWidgets || !window.clientManager || !window.showModal) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceTrackerCompletion();
    }
    
    function enhanceTrackerCompletion() {
        // Override completeTrackerItem with enhanced version
        const originalCompleteTrackerItem = window.dashboardWidgets.completeTrackerItem;
        
        window.dashboardWidgets.completeTrackerItem = async function(clientId, trackerId, skipConfirm = false) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                // Get tracker item info
                const trackerItem = getTrackerItemInfo(client, trackerId);
                if (!trackerItem) {
                    window.showNotification('Tracker item not found', 'error');
                    return;
                }
                
                // Show confirmation dialog unless skipped
                if (!skipConfirm) {
                    const confirmed = await showCompletionDialog(client, trackerItem);
                    if (!confirmed) return;
                }
                
                // Store state for undo
                const beforeState = {
                    clientId,
                    trackerId,
                    value: client[trackerItem.field],
                    dateValue: client[trackerItem.dateField]
                };
                
                // Perform completion
                const updates = {};
                updates[trackerItem.field] = true;
                if (trackerItem.dateField) {
                    updates[trackerItem.dateField] = new Date().toISOString();
                }
                
                await window.clientManager.updateClient(clientId, updates);
                
                // Store in history
                window.trackerHistory.push({
                    type: 'complete',
                    beforeState,
                    afterState: {
                        clientId,
                        trackerId,
                        value: true,
                        dateValue: updates[trackerItem.dateField]
                    },
                    note: window.lastCompletionNote || null
                });
                
                // Clear note
                window.lastCompletionNote = null;
                
                // Show success
                window.showNotification(`${trackerItem.label} marked as complete`, 'success');
                
                // Refresh dashboard
                if (window.dashboardManager) {
                    window.dashboardManager.refreshDashboard();
                }
                
            } catch (error) {
                console.error('Error completing tracker item:', error);
                window.showNotification('Failed to complete tracker item', 'error');
            }
        };
        
        // Show completion confirmation dialog
        async function showCompletionDialog(client, trackerItem) {
            return new Promise((resolve) => {
                const content = `
                    <div class="completion-dialog">
                        <div class="completion-header">
                            <h4>Complete Tracker Item</h4>
                        </div>
                        
                        <div class="completion-info">
                            <div class="info-row">
                                <span class="label">Client:</span>
                                <span class="value">${client.initials} - ${client.houseId || 'No House'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Item:</span>
                                <span class="value">${trackerItem.label}</span>
                            </div>
                            ${trackerItem.critical ? '<div class="critical-badge">‚ö†Ô∏è Critical Item</div>' : ''}
                        </div>
                        
                        <div class="completion-note-section">
                            <label for="completionNote">Add Note (Optional)</label>
                            <textarea 
                                id="completionNote" 
                                class="completion-note-input" 
                                placeholder="Add any notes about this completion..."
                                rows="3"
                            ></textarea>
                        </div>
                        
                        <div class="completion-actions">
                            <button class="btn btn-secondary" onclick="window.completionDialogCancel()">Cancel</button>
                            <button class="btn btn-primary" onclick="window.completionDialogConfirm()">Confirm</button>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: '‚úì Complete Tracker Item',
                    content: content,
                    size: 'small',
                    closeOnOverlay: false,
                    buttons: []
                });
                
                // Set up handlers
                window.completionDialogConfirm = () => {
                    const note = document.getElementById('completionNote').value.trim();
                    if (note) {
                        window.lastCompletionNote = note;
                    }
                    window.closeModal();
                    resolve(true);
                };
                
                window.completionDialogCancel = () => {
                    window.closeModal();
                    resolve(false);
                };
            });
        }
        
        // Get tracker item info
        function getTrackerItemInfo(client, trackerId) {
            if (!window.trackerEngine) return null;
            
            const requirements = window.trackerEngine.requirements || [];
            const item = requirements.find(r => r.id === trackerId);
            
            if (!item) return null;
            
            // Map to client field
            const fieldMap = {
                'needs_assessment': { field: 'needsAssessment', dateField: 'needsAssessmentDate' },
                'health_physical': { field: 'healthPhysical', dateField: 'healthPhysicalDate' },
                'aftercare_thread': { field: 'aftercareThread', dateField: 'aftercareThreadDate' },
                'options_doc': { field: 'optionsDocUploaded', dateField: 'optionsDocUploadedDate' },
                'discharge_packet': { field: 'dischargePacketUploaded', dateField: 'dischargePacketUploadedDate' }
            };
            
            const mapping = fieldMap[trackerId] || { field: trackerId, dateField: null };
            
            return {
                id: trackerId,
                label: item.label,
                critical: item.critical || false,
                field: mapping.field,
                dateField: mapping.dateField
            };
        }
        
        // Undo last completion
        window.undoTrackerCompletion = async function() {
            if (!window.trackerHistory.canUndo()) {
                window.showNotification('Nothing to undo', 'info');
                return;
            }
            
            const action = window.trackerHistory.undo();
            if (!action || action.type !== 'complete') {
                window.showNotification('Cannot undo this action', 'warning');
                return;
            }
            
            try {
                const updates = {};
                const trackerItem = getTrackerItemInfo(
                    await window.clientManager.getClient(action.beforeState.clientId),
                    action.beforeState.trackerId
                );
                
                if (trackerItem) {
                    updates[trackerItem.field] = action.beforeState.value;
                    if (trackerItem.dateField) {
                        updates[trackerItem.dateField] = action.beforeState.dateValue;
                    }
                    
                    await window.clientManager.updateClient(action.beforeState.clientId, updates);
                    window.showNotification('Action undone', 'success');
                    
                    if (window.dashboardManager) {
                        window.dashboardManager.refreshDashboard();
                    }
                }
            } catch (error) {
                console.error('Error undoing:', error);
                window.showNotification('Failed to undo', 'error');
            }
        };
        
        // Redo last undone action
        window.redoTrackerCompletion = async function() {
            if (!window.trackerHistory.canRedo()) {
                window.showNotification('Nothing to redo', 'info');
                return;
            }
            
            const action = window.trackerHistory.redo();
            if (!action || action.type !== 'complete') {
                window.showNotification('Cannot redo this action', 'warning');
                return;
            }
            
            try {
                await window.dashboardWidgets.completeTrackerItem(
                    action.afterState.clientId,
                    action.afterState.trackerId,
                    true // Skip confirm
                );
                window.showNotification('Action redone', 'success');
            } catch (error) {
                console.error('Error redoing:', error);
                window.showNotification('Failed to redo', 'error');
            }
        };
        
        // Add bulk update button to Flight Plan widget
        const flightPlanWidget = window.dashboardWidgets?.widgets?.get('flightPlan');
        if (flightPlanWidget) {
            const originalRender = flightPlanWidget.render;
            
            flightPlanWidget.render = function() {
                let html = originalRender.call(this);
                
                // Add bulk update button to header
                const headerMatch = html.match(/(<div[^>]*class="[^"]*widget-header[^"]*"[^>]*>)/);
                if (headerMatch) {
                    const bulkButton = `
                        <button class="btn btn-sm btn-secondary bulk-update-btn" onclick="window.showBulkTrackerUpdate()">
                            üìã Bulk Update
                        </button>
                    `;
                    html = html.replace(headerMatch[0], headerMatch[0] + bulkButton);
                }
                
                // Add undo/redo buttons
                const undoRedoButtons = `
                    <div class="undo-redo-controls">
                        <button class="btn-icon" onclick="window.undoTrackerCompletion()" 
                                title="Undo (Ctrl+Z)" ${!window.trackerHistory.canUndo() ? 'disabled' : ''}>
                            ‚Ü∂ Undo
                        </button>
                        <button class="btn-icon" onclick="window.redoTrackerCompletion()" 
                                title="Redo (Ctrl+Y)" ${!window.trackerHistory.canRedo() ? 'disabled' : ''}>
                            ‚Ü∑ Redo
                        </button>
                    </div>
                `;
                
                html = html.replace('</div></div>', undoRedoButtons + '</div></div>');
                
                return html;
            };
        }
        
        // Bulk tracker update modal
        window.showBulkTrackerUpdate = async function() {
            try {
                const clients = await window.clientManager.getAllClients();
                const activeClients = clients.filter(c => c.status === 'active');
                
                if (activeClients.length === 0) {
                    window.showNotification('No active clients found', 'warning');
                    return;
                }
                
                // Get tracker requirements
                const requirements = window.trackerEngine?.requirements || [];
                
                const content = `
                    <div class="bulk-tracker-update">
                        <div class="bulk-header">
                            <p>Select clients and tracker items to complete in bulk.</p>
                        </div>
                        
                        <div class="bulk-selection">
                            <div class="bulk-clients-section">
                                <h5>Clients</h5>
                                <div class="bulk-clients-list">
                                    ${activeClients.map(client => `
                                        <label class="bulk-client-checkbox">
                                            <input type="checkbox" class="bulk-client-select" value="${client.id}">
                                            <span>${client.initials} - ${client.houseId || 'No House'}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="bulk-items-section">
                                <h5>Tracker Items</h5>
                                <div class="bulk-items-list">
                                    ${requirements.map(req => `
                                        <label class="bulk-item-checkbox">
                                            <input type="checkbox" class="bulk-item-select" value="${req.id}">
                                            <span>${req.label} ${req.critical ? '‚ö†Ô∏è' : ''}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bulk-summary">
                            <span id="bulkSummary">0 clients, 0 items selected</span>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: 'üìã Bulk Tracker Update',
                    content: content,
                    size: 'large',
                    buttons: [
                        {
                            text: 'Cancel',
                            action: () => window.closeModal()
                        },
                        {
                            text: 'Complete Selected',
                            primary: true,
                            action: () => executeBulkUpdate()
                        }
                    ]
                });
                
                // Update summary on selection change
                document.querySelectorAll('.bulk-client-select, .bulk-item-select').forEach(cb => {
                    cb.addEventListener('change', updateBulkSummary);
                });
                
                updateBulkSummary();
                
            } catch (error) {
                console.error('Error showing bulk update:', error);
                window.showNotification('Failed to load bulk update', 'error');
            }
        };
        
        function updateBulkSummary() {
            const selectedClients = document.querySelectorAll('.bulk-client-select:checked').length;
            const selectedItems = document.querySelectorAll('.bulk-item-select:checked').length;
            
            const summary = document.getElementById('bulkSummary');
            if (summary) {
                summary.textContent = `${selectedClients} clients, ${selectedItems} items selected`;
            }
        }
        
        async function executeBulkUpdate() {
            const selectedClients = Array.from(document.querySelectorAll('.bulk-client-select:checked')).map(cb => cb.value);
            const selectedItems = Array.from(document.querySelectorAll('.bulk-item-select:checked')).map(cb => cb.value);
            
            if (selectedClients.length === 0 || selectedItems.length === 0) {
                window.showNotification('Please select at least one client and one item', 'warning');
                return;
            }
            
            const confirmed = confirm(`Complete ${selectedItems.length} item(s) for ${selectedClients.length} client(s)?`);
            if (!confirmed) return;
            
            let completed = 0;
            let failed = 0;
            
            window.showNotification('Processing bulk update...', 'info');
            
            for (const clientId of selectedClients) {
                for (const itemId of selectedItems) {
                    try {
                        await window.dashboardWidgets.completeTrackerItem(clientId, itemId, true);
                        completed++;
                    } catch (error) {
                        failed++;
                    }
                }
            }
            
            window.closeModal();
            window.showNotification(
                `Bulk update complete: ${completed} items completed${failed > 0 ? `, ${failed} failed` : ''}`,
                completed > 0 ? 'success' : 'error'
            );
            
            if (window.dashboardManager) {
                window.dashboardManager.refreshDashboard();
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                window.undoTrackerCompletion();
            }
            
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                window.redoTrackerCompletion();
            }
        });
        
        // Add styles
        if (!document.querySelector('#tracker-completion-enhancement-styles')) {
            const styles = document.createElement('style');
            styles.id = 'tracker-completion-enhancement-styles';
            styles.textContent = `
                /* Completion Dialog */
                .completion-dialog {
                    padding: 0;
                }
                
                .completion-header h4 {
                    margin: 0 0 16px 0;
                    color: #1f2937;
                }
                
                .completion-info {
                    margin-bottom: 20px;
                }
                
                .info-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 8px;
                }
                
                .info-row .label {
                    font-weight: 500;
                    color: #6b7280;
                }
                
                .info-row .value {
                    color: #1f2937;
                }
                
                .critical-badge {
                    display: inline-block;
                    margin-top: 8px;
                    padding: 4px 8px;
                    background: #fef2f2;
                    color: #991b1b;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 500;
                }
                
                .completion-note-section {
                    margin-bottom: 20px;
                }
                
                .completion-note-section label {
                    display: block;
                    margin-bottom: 8px;
                    font-weight: 500;
                    color: #374151;
                }
                
                .completion-note-input {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-family: inherit;
                    font-size: 14px;
                    resize: vertical;
                }
                
                .completion-actions {
                    display: flex;
                    justify-content: flex-end;
                    gap: 12px;
                }
                
                /* Bulk Update */
                .bulk-update-btn {
                    margin-left: auto;
                }
                
                .undo-redo-controls {
                    display: flex;
                    gap: 8px;
                    padding: 12px;
                    background: #f9fafb;
                    border-top: 1px solid #e5e7eb;
                }
                
                .btn-icon {
                    background: white;
                    border: 1px solid #d1d5db;
                    padding: 6px 12px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s;
                }
                
                .btn-icon:hover:not(:disabled) {
                    background: #f3f4f6;
                    border-color: #9ca3af;
                }
                
                .btn-icon:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                
                .bulk-tracker-update {
                    padding: 0;
                }
                
                .bulk-header {
                    margin-bottom: 20px;
                    color: #6b7280;
                }
                
                .bulk-selection {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 24px;
                    margin-bottom: 20px;
                }
                
                .bulk-clients-section h5,
                .bulk-items-section h5 {
                    margin: 0 0 12px 0;
                    color: #1f2937;
                }
                
                .bulk-clients-list,
                .bulk-items-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    max-height: 300px;
                    overflow-y: auto;
                    padding: 8px;
                    background: #f9fafb;
                    border-radius: 6px;
                }
                
                .bulk-client-checkbox,
                .bulk-item-checkbox {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px;
                    background: white;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .bulk-client-checkbox:hover,
                .bulk-item-checkbox:hover {
                    background: #f3f4f6;
                }
                
                .bulk-summary {
                    padding: 12px;
                    background: #eff6ff;
                    border-radius: 6px;
                    text-align: center;
                    font-weight: 500;
                    color: #1e40af;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Tracker completion enhancement initialized');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: client-data-validation.js
/**
 * Client Data Validation Enhancement
 * Adds validation for client creation/updates, duplicate checking, date validation, and error display
 */

(function() {
    'use strict';
    
    // Validation rules
    const validationRules = {
        initials: {
            required: true,
            minLength: 2,
            maxLength: 10,
            pattern: /^[A-Z]{2,10}$/,
            message: 'Initials must be 2-10 uppercase letters'
        },
        houseId: {
            required: false,
            pattern: /^[A-Z0-9_\s-]+$/i,
            message: 'House ID can only contain letters, numbers, spaces, underscores, and hyphens'
        },
        admissionDate: {
            required: true,
            validate: (date) => {
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'Invalid date';
                if (d > new Date()) return 'Admission date cannot be in the future';
                return null;
            }
        },
        dischargeDate: {
            required: false,
            validate: (date, client) => {
                if (!date) return null;
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'Invalid date';
                if (client.admissionDate) {
                    const admission = new Date(client.admissionDate);
                    if (d < admission) return 'Discharge date must be after admission date';
                }
                return null;
            }
        },
        status: {
            required: true,
            allowedValues: ['active', 'discharged', 'archived'],
            message: 'Status must be active, discharged, or archived'
        }
    };
    
    // Validation engine
    window.clientValidator = {
        /**
         * Validate client data
         * @param {Object} clientData - Client data to validate
         * @param {Object} existingClient - Existing client data (for updates)
         * @returns {Object} Validation result { valid: boolean, errors: Object }
         */
        validate(clientData, existingClient = null) {
            const errors = {};
            let isValid = true;
            
            // Validate each field
            for (const [field, rules] of Object.entries(validationRules)) {
                const value = clientData[field];
                
                // Required check
                if (rules.required && (!value || value === '')) {
                    errors[field] = `${field} is required`;
                    isValid = false;
                    continue;
                }
                
                // Skip if empty and not required
                if (!value || value === '') continue;
                
                // Min length check
                if (rules.minLength && value.length < rules.minLength) {
                    errors[field] = `${field} must be at least ${rules.minLength} characters`;
                    isValid = false;
                    continue;
                }
                
                // Max length check
                if (rules.maxLength && value.length > rules.maxLength) {
                    errors[field] = `${field} must be no more than ${rules.maxLength} characters`;
                    isValid = false;
                    continue;
                }
                
                // Pattern check
                if (rules.pattern && !rules.pattern.test(value)) {
                    errors[field] = rules.message || `${field} format is invalid`;
                    isValid = false;
                    continue;
                }
                
                // Custom validation
                if (rules.validate) {
                    const customError = rules.validate(value, clientData);
                    if (customError) {
                        errors[field] = customError;
                        isValid = false;
                    }
                }
                
                // Allowed values check
                if (rules.allowedValues && !rules.allowedValues.includes(value)) {
                    errors[field] = rules.message || `${field} must be one of: ${rules.allowedValues.join(', ')}`;
                    isValid = false;
                }
            }
            
            return { valid: isValid, errors };
        },
        
        /**
         * Check for duplicate client
         * @param {string} initials - Client initials
         * @param {string} houseId - House ID
         * @param {string} excludeId - Client ID to exclude (for updates)
         * @returns {boolean} True if duplicate exists
         */
        async checkDuplicate(initials, houseId, excludeId = null) {
            if (!window.clientManager) return false;
            
            try {
                const clients = await window.clientManager.getAllClients();
                return clients.some(client => 
                    client.id !== excludeId &&
                    client.initials === initials &&
                    client.houseId === houseId
                );
            } catch (error) {
                console.error('Error checking duplicate:', error);
                return false;
            }
        },
        
        /**
         * Validate date range
         * @param {string} startDate - Start date
         * @param {string} endDate - End date
         * @returns {string|null} Error message or null
         */
        validateDateRange(startDate, endDate) {
            if (!startDate || !endDate) return null;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (isNaN(start.getTime())) return 'Invalid start date';
            if (isNaN(end.getTime())) return 'Invalid end date';
            if (end < start) return 'End date must be after start date';
            
            return null;
        },
        
        /**
         * Format validation errors for display
         * @param {Object} errors - Validation errors
         * @returns {string} Formatted error message
         */
        formatErrors(errors) {
            if (!errors || Object.keys(errors).length === 0) return '';
            
            return Object.entries(errors)
                .map(([field, message]) => `${field}: ${message}`)
                .join('\n');
        }
    };
    
    // Enhance clientManager with validation
    function enhanceClientManager() {
        if (!window.clientManager) return;
        
        // Wrap createClient
        const originalCreateClient = window.clientManager.createClient;
        window.clientManager.createClient = async function(clientData) {
            const normalizedClient = { ...clientData };
            if (!normalizedClient.status) {
                normalizedClient.status = normalizedClient.dischargeDate ? 'discharged' : 'active';
            }
            
            // Validate
            const validation = window.clientValidator.validate(normalizedClient);
            
            if (!validation.valid) {
                const errorMsg = window.clientValidator.formatErrors(validation.errors);
                throw new Error(`Validation failed:\n${errorMsg}`);
            }
            
            // Check duplicate
            if (!normalizedClient.isDemo && normalizedClient.initials && normalizedClient.houseId) {
                const isDuplicate = await window.clientValidator.checkDuplicate(
                    normalizedClient.initials,
                    normalizedClient.houseId
                );
                
                if (isDuplicate) {
                    throw new Error(`Client with initials "${normalizedClient.initials}" already exists in ${normalizedClient.houseId}`);
                }
            }
            
            // Call original
            return originalCreateClient.call(this, normalizedClient);
        };
        
        // Wrap updateClient
        const originalUpdateClient = window.clientManager.updateClient;
        window.clientManager.updateClient = async function(clientId, updates) {
            // Get existing client
            const existingClient = await this.getClient(clientId);
            if (!existingClient) {
                throw new Error('Client not found');
            }
            
            // Merge updates with existing data for validation
            const mergedData = { ...existingClient, ...updates };
            if (!mergedData.status) {
                mergedData.status = mergedData.dischargeDate ? 'discharged' : 'active';
            }
            
            // Validate
            const validation = window.clientValidator.validate(mergedData, existingClient);
            
            if (!validation.valid) {
                const errorMsg = window.clientValidator.formatErrors(validation.errors);
                throw new Error(`Validation failed:\n${errorMsg}`);
            }
            
            // Check duplicate if initials or houseId changed
            if (!mergedData.isDemo && (updates.initials || updates.houseId)) {
                const newInitials = updates.initials || existingClient.initials;
                const newHouseId = updates.houseId || existingClient.houseId;
                
                const isDuplicate = await window.clientValidator.checkDuplicate(
                    newInitials,
                    newHouseId,
                    clientId
                );
                
                if (isDuplicate) {
                    throw new Error(`Client with initials "${newInitials}" already exists in ${newHouseId}`);
                }
            }
            
            // Call original
            return originalUpdateClient.call(this, clientId, updates);
        };
    }
    
    // Add validation UI helpers
    window.showValidationErrors = function(errors, container) {
        if (!container) return;
        
        // Remove existing errors
        container.querySelectorAll('.validation-error').forEach(el => el.remove());
        
        // Add error messages
        for (const [field, message] of Object.entries(errors)) {
            const errorEl = document.createElement('div');
            errorEl.className = 'validation-error';
            errorEl.textContent = `${field}: ${message}`;
            container.appendChild(errorEl);
        }
    };
    
    window.clearValidationErrors = function(container) {
        if (!container) return;
        container.querySelectorAll('.validation-error').forEach(el => el.remove());
    };
    
    // Enhance showAddClientModal with validation
    function enhanceAddClientModal() {
        const originalShowAddClientModal = window.showAddClientModal;
        if (!originalShowAddClientModal) return;
        
        window.showAddClientModal = async function() {
            // Call original
            await originalShowAddClientModal.call(this);
            
            // Wait for modal to render
            setTimeout(() => {
                addValidationToModal();
            }, 100);
        };
        
        function addValidationToModal() {
            const modal = document.getElementById('globalModal');
            if (!modal) return;
            
            const form = modal.querySelector('form') || modal.querySelector('.client-form');
            if (!form) return;
            
            // Add real-time validation
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('blur', () => {
                    validateField(input);
                });
                
                input.addEventListener('input', () => {
                    clearFieldError(input);
                });
            });
            
            // Enhance submit handler
            const submitBtn = form.querySelector('button[type="submit"]') || 
                            form.querySelector('.btn-primary');
            
            if (submitBtn) {
                const originalClick = submitBtn.onclick;
                submitBtn.onclick = async function(e) {
                    e.preventDefault();
                    
                    // Validate all fields
                    const formData = new FormData(form);
                    const clientData = Object.fromEntries(formData.entries());
                    
                    // Convert dates
                    if (clientData.admissionDate) {
                        clientData.admissionDate = new Date(clientData.admissionDate).toISOString();
                    }
                    if (clientData.dischargeDate) {
                        clientData.dischargeDate = new Date(clientData.dischargeDate).toISOString();
                    }
                    
                    const validation = window.clientValidator.validate(clientData);
                    
                    if (!validation.valid) {
                        showValidationErrors(validation.errors, form);
                        window.showNotification('Please fix validation errors', 'error');
                        return;
                    }
                    
                    // Check duplicate
                    try {
                        const isDuplicate = await window.clientValidator.checkDuplicate(
                            clientData.initials,
                            clientData.houseId
                        );
                        
                        if (isDuplicate) {
                            window.showNotification(
                                `Client with initials "${clientData.initials}" already exists in ${clientData.houseId}`,
                                'error'
                            );
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking duplicate:', error);
                    }
                    
                    // Call original handler
                    if (originalClick) {
                        originalClick.call(this, e);
                    }
                };
            }
        }
        
        function validateField(input) {
            const field = input.name || input.id;
            const value = input.value;
            
            const rules = validationRules[field];
            if (!rules) return;
            
            const clientData = { [field]: value };
            const validation = window.clientValidator.validate(clientData);
            
            if (validation.errors[field]) {
                showFieldError(input, validation.errors[field]);
            } else {
                clearFieldError(input);
            }
        }
        
        function showFieldError(input, message) {
            clearFieldError(input);
            
            input.classList.add('validation-error-field');
            
            const errorEl = document.createElement('div');
            errorEl.className = 'validation-error-message';
            errorEl.textContent = message;
            
            input.parentNode.insertBefore(errorEl, input.nextSibling);
        }
        
        function clearFieldError(input) {
            input.classList.remove('validation-error-field');
            const errorMsg = input.parentNode.querySelector('.validation-error-message');
            if (errorMsg) {
                errorMsg.remove();
            }
        }
    }
    
    // Add styles
    if (!document.querySelector('#client-data-validation-styles')) {
        const styles = document.createElement('style');
        styles.id = 'client-data-validation-styles';
        styles.textContent = `
            /* Validation Errors */
            .validation-error {
                padding: 8px 12px;
                margin: 8px 0;
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-left: 4px solid #ef4444;
                border-radius: 4px;
                color: #991b1b;
                font-size: 14px;
            }
            
            .validation-error-field {
                border-color: #ef4444 !important;
                box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
            }
            
            .validation-error-message {
                margin-top: 4px;
                font-size: 12px;
                color: #ef4444;
            }
            
            /* Success state */
            .validation-success-field {
                border-color: #22c55e !important;
                box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Initialize
    function initialize() {
        enhanceClientManager();
        enhanceAddClientModal();
        
        console.log('‚úÖ Client data validation initialized');
    }
    
    // Wait for dependencies
    if (window.clientManager) {
        initialize();
    } else {
        const checkInterval = setInterval(() => {
            if (window.clientManager) {
                clearInterval(checkInterval);
                initialize();
            }
        }, 100);
        
        setTimeout(() => clearInterval(checkInterval), 10000);
    }
})();





// Enhancement: discharge-packet-integration.js
/**
 * Discharge Packet Integration Enhancement
 * Adds discharge packet button to client details, auto-populates with client data, updates tracker on completion
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.documentGenerator || !window.showClientDetailsModal || !window.clientManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        integrateDischargePacket();
    }
    
    function integrateDischargePacket() {
        // Override showClientDetailsModal to add discharge packet button
        const originalShowClientDetailsModal = window.showClientDetailsModal;
        
        window.showClientDetailsModal = async function(client) {
            // Call original function
            await originalShowClientDetailsModal.call(this, client);
            
            // Wait for modal to render
            setTimeout(() => {
                addDischargePacketButton(client);
            }, 200);
        };
        
        /**
         * Add discharge packet button to client details modal
         */
        function addDischargePacketButton(client) {
            const modal = document.getElementById('globalModal') || document.querySelector('.modal');
            if (!modal) return;
            
            // Check if button already exists
            if (modal.querySelector('.discharge-packet-btn')) return;
            
            // Find a good place to add the button - look for action buttons or document section
            const actionsSection = modal.querySelector('.client-actions') || 
                                 modal.querySelector('.modal-actions') ||
                                 modal.querySelector('.client-documents-section');
            
            let buttonContainer;
            
            if (actionsSection) {
                // Add button to existing actions section
                buttonContainer = actionsSection;
            } else {
                // Create new actions section
                const modalBody = modal.querySelector('.modal-body') || modal.querySelector('.modal-content');
                if (modalBody) {
                    buttonContainer = document.createElement('div');
                    buttonContainer.className = 'discharge-packet-section';
                    modalBody.appendChild(buttonContainer);
                } else {
                    return; // Can't find a place to add it
                }
            }
            
            // Check if discharge packet is already completed
            const daysInCare = window.daysBetween(client.admissionDate) || 0;
            const isCompleted = client.dischargePacketUploaded;
            const isRecommended = daysInCare >= 25; // Discharge packet min day
            
            // Create button
            const button = document.createElement('button');
            button.className = `btn discharge-packet-btn ${isCompleted ? 'btn-success' : 'btn-primary'}`;
            button.innerHTML = isCompleted 
                ? '‚úÖ Discharge Packet Generated' 
                : 'üì¶ Generate Discharge Packet';
            button.title = isCompleted 
                ? 'Discharge packet already generated'
                : 'Generate discharge packet for this client';
            
            if (!isCompleted && isRecommended) {
                button.onclick = () => generateDischargePacketForClient(client);
            } else if (!isCompleted) {
                button.disabled = true;
                button.title = `Discharge packet available after day 25 (currently day ${daysInCare})`;
            } else {
                button.onclick = () => {
                    window.showNotification('Discharge packet already generated', 'info');
                };
            }
            
            // Insert button
            if (buttonContainer.classList.contains('discharge-packet-section')) {
                buttonContainer.innerHTML = `
                    <h4>üì¶ Discharge Packet</h4>
                    <p class="discharge-packet-info">
                        ${isCompleted 
                            ? `Generated on ${window.formatDate(client.dischargePacketUploadedDate)}`
                            : isRecommended
                                ? 'Ready to generate discharge packet'
                                : `Available after day 25 (currently day ${daysInCare})`
                        }
                    </p>
                `;
                buttonContainer.appendChild(button);
            } else {
                // Insert at beginning of container
                buttonContainer.insertBefore(button, buttonContainer.firstChild);
            }
        }
        
        /**
         * Generate discharge packet for a specific client (skips client selection)
         */
        async function generateDischargePacketForClient(client) {
            try {
                // Verify client still exists and is active
                const currentClient = await window.clientManager.getClient(client.id);
                if (!currentClient) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                if (currentClient.status !== 'active') {
                    window.showNotification('Can only generate discharge packets for active clients', 'warning');
                    return;
                }
                
                // Check if already completed
                if (currentClient.dischargePacketUploaded) {
                    const confirmed = confirm('Discharge packet already generated. Generate another?');
                    if (!confirmed) return;
                }
                
                // Close client details modal
                window.closeModal();
                
                // Show confirmation dialog
                const daysInCare = window.daysBetween(currentClient.admissionDate) || 0;
                const confirmed = await showDischargePacketConfirmation(currentClient, daysInCare);
                
                if (!confirmed) return;
                
                // Start workflow directly with client and document type pre-selected
                window.documentGenerator.activeWorkflow = {
                    clientId: currentClient.id,
                    client: currentClient,
                    documentType: 'discharge-packet',
                    programs: [] // Will be selected in next step
                };
                
                // Skip to program selection (step 3)
                await window.documentGenerator.selectPrograms();
                
            } catch (error) {
                console.error('Error generating discharge packet:', error);
                window.showNotification('Failed to generate discharge packet', 'error');
            }
        }
        
        /**
         * Show confirmation dialog for discharge packet generation
         */
        async function showDischargePacketConfirmation(client, daysInCare) {
            return new Promise((resolve) => {
                const content = `
                    <div class="discharge-packet-confirmation">
                        <div class="confirmation-header">
                            <h4>üì¶ Generate Discharge Packet</h4>
                        </div>
                        
                        <div class="client-summary">
                            <div class="summary-row">
                                <span class="label">Client:</span>
                                <span class="value">${client.initials}</span>
                            </div>
                            <div class="summary-row">
                                <span class="label">House:</span>
                                <span class="value">${client.houseId || 'No House'}</span>
                            </div>
                            <div class="summary-row">
                                <span class="label">Days in Care:</span>
                                <span class="value">${daysInCare}</span>
                            </div>
                            ${client.dischargeDate ? `
                                <div class="summary-row">
                                    <span class="label">Discharge Date:</span>
                                    <span class="value">${window.formatDate(client.dischargeDate)}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="confirmation-info">
                            <p>This will generate a complete discharge packet for <strong>${client.initials}</strong>.</p>
                            <p>The following will be included:</p>
                            <ul>
                                <li>Discharge summary</li>
                                <li>Treatment completion details</li>
                                <li>Aftercare recommendations</li>
                                <li>Follow-up instructions</li>
                            </ul>
                            <p class="tracker-note">‚úì The client tracker will be automatically updated upon completion.</p>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: 'Generate Discharge Packet',
                    content: content,
                    size: 'medium',
                    buttons: [
                        {
                            text: 'Cancel',
                            action: () => {
                                window.closeModal();
                                resolve(false);
                            }
                        },
                        {
                            text: 'Continue',
                            primary: true,
                            action: () => {
                                window.closeModal();
                                resolve(true);
                            }
                        }
                    ]
                });
            });
        }
        
        // Also add quick access from client cards if they exist
        if (window.dashboardWidgets) {
            const originalRenderClient = window.dashboardWidgets.renderClient;
            if (originalRenderClient) {
                window.dashboardWidgets.renderClient = function(client) {
                    let html = originalRenderClient.call(this, client);
                    
                    // Add discharge packet quick button if eligible
                    const daysInCare = window.daysBetween(client.admissionDate) || 0;
                    const isEligible = daysInCare >= 25 && !client.dischargePacketUploaded;
                    
                    if (isEligible) {
                        const buttonHtml = `
                            <button class="btn-discharge-packet-quick" 
                                    onclick="window.generateDischargePacketQuick('${client.id}')"
                                    title="Generate discharge packet for ${client.initials}">
                                üì¶
                            </button>
                        `;
                        
                        // Insert button in client card actions
                        const insertPos = html.lastIndexOf('</div>');
                        if (insertPos > 0) {
                            html = html.slice(0, insertPos) + buttonHtml + html.slice(insertPos);
                        }
                    }
                    
                    return html;
                };
            }
        }
        
        // Quick access function for client cards
        window.generateDischargePacketQuick = async function(clientId) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                await generateDischargePacketForClient(client);
            } catch (error) {
                console.error('Error generating discharge packet:', error);
                window.showNotification('Failed to generate discharge packet', 'error');
            }
        };
        
        // Add styles
        if (!document.querySelector('#discharge-packet-integration-styles')) {
            const styles = document.createElement('style');
            styles.id = 'discharge-packet-integration-styles';
            styles.textContent = `
                /* Discharge Packet Section */
                .discharge-packet-section {
                    margin-top: 20px;
                    padding: 16px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border: 1px solid #e5e7eb;
                }
                
                .discharge-packet-section h4 {
                    margin: 0 0 8px 0;
                    color: #1f2937;
                    font-size: 16px;
                }
                
                .discharge-packet-info {
                    margin: 0 0 12px 0;
                    color: #6b7280;
                    font-size: 14px;
                }
                
                .discharge-packet-btn {
                    width: 100%;
                    margin-top: 8px;
                    padding: 12px;
                    font-size: 15px;
                    font-weight: 500;
                }
                
                .discharge-packet-btn:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                }
                
                /* Quick button in client cards */
                .btn-discharge-packet-quick {
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 6px 10px;
                    cursor: pointer;
                    font-size: 16px;
                    transition: all 0.2s;
                    margin-left: 4px;
                }
                
                .btn-discharge-packet-quick:hover {
                    background: #5568d3;
                    transform: scale(1.05);
                }
                
                /* Confirmation Dialog */
                .discharge-packet-confirmation {
                    padding: 0;
                }
                
                .confirmation-header {
                    margin-bottom: 20px;
                }
                
                .confirmation-header h4 {
                    margin: 0;
                    color: #1f2937;
                }
                
                .client-summary {
                    background: #f9fafb;
                    padding: 16px;
                    border-radius: 6px;
                    margin-bottom: 20px;
                }
                
                .summary-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 8px;
                }
                
                .summary-row:last-child {
                    margin-bottom: 0;
                }
                
                .summary-row .label {
                    font-weight: 500;
                    color: #6b7280;
                }
                
                .summary-row .value {
                    color: #1f2937;
                    font-weight: 500;
                }
                
                .confirmation-info {
                    margin-bottom: 20px;
                }
                
                .confirmation-info p {
                    margin-bottom: 12px;
                    color: #374151;
                    line-height: 1.6;
                }
                
                .confirmation-info ul {
                    margin: 12px 0 12px 20px;
                    color: #374151;
                }
                
                .confirmation-info li {
                    margin-bottom: 6px;
                }
                
                .tracker-note {
                    margin-top: 16px;
                    padding: 12px;
                    background: #eff6ff;
                    border-left: 4px solid #3b82f6;
                    border-radius: 4px;
                    color: #1e40af;
                    font-weight: 500;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Discharge packet integration initialized');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();




// Enhancement: widget-rendering-optimization.js
/**
 * Widget Rendering Optimization Enhancement
 * Implements selective widget updates, virtual scrolling for long lists, debounce search inputs
 */

(function() {
    'use strict';
    
    // Debounce utility (if not already available)
    if (!window.debounce) {
        window.debounce = function(func, wait, immediate) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                const later = function() {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        };
    }
    
    // Track which widgets need updates
    const widgetUpdateQueue = new Set();
    let updateScheduled = false;
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardManager || !window.dashboardWidgets) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        optimizeWidgetRendering();
        addVirtualScrolling();
        debounceSearchInputs();
    }
    
    /**
     * Optimize widget rendering with selective updates
     */
    function optimizeWidgetRendering() {
        const originalRefreshDashboard = window.dashboardManager.refreshDashboard;
        
        // Override refreshDashboard to support selective updates
        window.dashboardManager.refreshDashboard = async function(widgetIds = null) {
            try {
                console.log('üîÑ Refreshing dashboard' + (widgetIds ? ` (selective: ${widgetIds.join(', ')})` : ' (full)'));
                
                // If specific widgets requested, only update those
                if (widgetIds && Array.isArray(widgetIds)) {
                    for (const widgetId of widgetIds) {
                        const widget = this.widgets.get(widgetId);
                        if (widget && widget.refresh) {
                            await widget.refresh();
                        }
                    }
                    return true;
                }
                
                // Full refresh - invalidate cache
                this.cache.lastCacheTime = 0;
                await this.loadDashboardData();
                
                // Notify all widgets to update
                for (const [widgetId, widget] of this.widgets) {
                    if (widget.refresh) {
                        await widget.refresh();
                    }
                }
                
                console.log('‚úÖ Dashboard refreshed');
                return true;
            } catch (error) {
                console.error('Failed to refresh dashboard:', error);
                return false;
            }
        };
        
        // Add method to queue widget updates
        window.dashboardManager.queueWidgetUpdate = function(widgetId) {
            widgetUpdateQueue.add(widgetId);
            scheduleWidgetUpdates();
        };
        
        // Schedule batched widget updates
        function scheduleWidgetUpdates() {
            if (updateScheduled) return;
            
            updateScheduled = true;
            requestAnimationFrame(() => {
                if (widgetUpdateQueue.size > 0) {
                    const widgetsToUpdate = Array.from(widgetUpdateQueue);
                    widgetUpdateQueue.clear();
                    window.dashboardManager.refreshDashboard(widgetsToUpdate);
                }
                updateScheduled = false;
            });
        }
        
        // Enhance event system to trigger selective updates
        if (window.publish) {
            const originalPublish = window.publish;
            window.publish = function(event, data) {
                originalPublish.call(this, event, data);
                
                // Map events to widgets that need updating
                const eventWidgetMap = {
                    'client:updated': ['flightPlan', 'journeyRadar', 'missions'],
                    'tracker:updated': ['flightPlan', 'compliance'],
                    'document:generated': ['flightPlan', 'documentHub'],
                    'milestone:completed': ['journeyRadar', 'missions']
                };
                
                const widgetsToUpdate = eventWidgetMap[event] || [];
                if (widgetsToUpdate.length > 0) {
                    widgetsToUpdate.forEach(widgetId => {
                        window.dashboardManager.queueWidgetUpdate(widgetId);
                    });
                }
            };
        }
    }
    
    /**
     * Add virtual scrolling for long lists
     */
    function addVirtualScrolling() {
        // Virtual scrolling implementation for long lists
        window.VirtualScroller = class {
            constructor(container, items, itemHeight = 60, renderItem) {
                this.container = container;
                this.items = items;
                this.itemHeight = itemHeight;
                this.renderItem = renderItem;
                this.scrollTop = 0;
                this.containerHeight = container.clientHeight;
                this.visibleCount = Math.ceil(this.containerHeight / this.itemHeight) + 2; // Buffer
                
                this.init();
            }
            
            init() {
                // Create scroll container
                this.scrollContainer = document.createElement('div');
                this.scrollContainer.className = 'virtual-scroll-container';
                this.scrollContainer.style.height = `${this.containerHeight}px`;
                this.scrollContainer.style.overflowY = 'auto';
                this.scrollContainer.style.position = 'relative';
                
                // Create content spacer
                this.spacer = document.createElement('div');
                this.spacer.style.height = `${this.items.length * this.itemHeight}px`;
                
                // Create visible items container
                this.itemsContainer = document.createElement('div');
                this.itemsContainer.className = 'virtual-items-container';
                this.itemsContainer.style.position = 'absolute';
                this.itemsContainer.style.top = '0';
                this.itemsContainer.style.width = '100%';
                
                this.scrollContainer.appendChild(this.spacer);
                this.scrollContainer.appendChild(this.itemsContainer);
                
                // Replace original container content
                this.container.innerHTML = '';
                this.container.appendChild(this.scrollContainer);
                
                // Add scroll listener
                this.scrollContainer.addEventListener('scroll', () => {
                    this.scrollTop = this.scrollContainer.scrollTop;
                    this.render();
                });
                
                // Initial render
                this.render();
            }
            
            render() {
                const startIndex = Math.floor(this.scrollTop / this.itemHeight);
                const endIndex = Math.min(startIndex + this.visibleCount, this.items.length);
                
                // Update spacer position
                this.itemsContainer.style.top = `${startIndex * this.itemHeight}px`;
                
                // Render visible items
                const visibleItems = this.items.slice(startIndex, endIndex);
                this.itemsContainer.innerHTML = visibleItems.map((item, idx) => {
                    return this.renderItem(item, startIndex + idx);
                }).join('');
            }
            
            updateItems(newItems) {
                this.items = newItems;
                this.spacer.style.height = `${this.items.length * this.itemHeight}px`;
                this.render();
            }
        };
        
        // Enhance widgets that render long lists
        if (window.dashboardWidgets) {
            const originalRenderClient = window.dashboardWidgets.renderClient;
            if (originalRenderClient) {
                // Store original for non-virtual rendering
                window.dashboardWidgets.renderClientOriginal = originalRenderClient;
                
                // Add virtual scrolling option
                window.dashboardWidgets.renderClientList = function(clients, container, useVirtual = false) {
                    if (!useVirtual || clients.length < 20) {
                        // Use regular rendering for small lists
                        container.innerHTML = clients.map(client => originalRenderClient.call(this, client)).join('');
                        return;
                    }
                    
                    // Use virtual scrolling for long lists
                    const itemHeight = 80; // Approximate client card height
                    const renderItem = (client, index) => originalRenderClient.call(this, client);
                    
                    if (!container.virtualScroller) {
                        container.virtualScroller = new window.VirtualScroller(
                            container,
                            clients,
                            itemHeight,
                            renderItem
                        );
                    } else {
                        container.virtualScroller.updateItems(clients);
                    }
                };
            }
        }
    }
    
    /**
     * Debounce search inputs throughout the app
     */
    function debounceSearchInputs() {
        // Find and debounce all search inputs
        function debounceSearchInputsInContainer(container) {
            const searchInputs = container.querySelectorAll('input[type="search"], input[placeholder*="Search" i], input[placeholder*="Filter" i]');
            
            searchInputs.forEach(input => {
                // Skip if already debounced
                if (input.dataset.debounced === 'true') return;
                
                input.dataset.debounced = 'true';
                
                // Get original oninput handler if exists
                const originalHandler = input.oninput;
                
                // Create debounced handler
                const debouncedHandler = window.debounce((e) => {
                    if (originalHandler) {
                        originalHandler.call(input, e);
                    }
                    
                    // Trigger custom event for search
                    const searchEvent = new CustomEvent('search', {
                        detail: { value: e.target.value },
                        bubbles: true
                    });
                    input.dispatchEvent(searchEvent);
                }, 300); // 300ms debounce
                
                // Replace oninput
                input.addEventListener('input', debouncedHandler);
            });
        }
        
        // Debounce existing inputs
        debounceSearchInputsInContainer(document);
        
        // Watch for new inputs added dynamically
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        debounceSearchInputsInContainer(node);
                    }
                });
            });
        });
        
        const attachObserver = () => {
            const target = document.body;
            if (!target) {
                setTimeout(attachObserver, 50);
                return;
            }
            observer.observe(target, {
                childList: true,
                subtree: true
            });
        };

        attachObserver();
        
        // Enhance client search specifically
        if (window.clientManager) {
            const originalSearchClients = window.clientManager.searchClients;
            if (originalSearchClients) {
                window.clientManager.searchClients = window.debounce(originalSearchClients, 300);
            }
        }
    }
    
    // Add performance monitoring
    function addPerformanceMonitoring() {
        if (window.performance && window.performance.mark) {
            // Mark widget render times
            const originalRender = window.dashboardWidgets?.widgets?.get('flightPlan')?.render;
            if (originalRender) {
                const flightPlanWidget = window.dashboardWidgets.widgets.get('flightPlan');
                flightPlanWidget.render = async function() {
                    window.performance.mark('widget-render-start');
                    await originalRender.call(this);
                    window.performance.mark('widget-render-end');
                    window.performance.measure('widget-render', 'widget-render-start', 'widget-render-end');
                    
                    const measure = window.performance.getEntriesByName('widget-render')[0];
                    if (measure.duration > 100) {
                        console.warn(`Widget render took ${measure.duration.toFixed(2)}ms`);
                    }
                };
            }
        }
    }
    
    // Add styles for virtual scrolling
    if (!document.querySelector('#widget-rendering-optimization-styles')) {
        const styles = document.createElement('style');
        styles.id = 'widget-rendering-optimization-styles';
        styles.textContent = `
            /* Virtual Scrolling */
            .virtual-scroll-container {
                position: relative;
            }
            
            .virtual-items-container {
                will-change: transform;
            }
            
            /* Optimize rendering */
            .dashboard-widget {
                contain: layout style paint;
            }
            
            /* Smooth scrolling */
            .virtual-scroll-container {
                scroll-behavior: smooth;
            }
            
            /* Loading states */
            .widget-updating {
                opacity: 0.7;
                pointer-events: none;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
    
    // Add performance monitoring after a delay
    setTimeout(addPerformanceMonitoring, 1000);
    
    console.log('‚úÖ Widget rendering optimization initialized');
})();




// Enhancement: indexeddb-optimization.js
/**
 * IndexedDB Optimization Enhancement
 * Adds indexes on frequently queried fields (houseId, status, dates), implements query result caching
 */

(function() {
    'use strict';
    
    // Query cache
    const queryCache = new Map();
    const CACHE_DURATION = 30000; // 30 seconds
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.indexedDBManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        addIndexes();
        addQueryCaching();
    }
    
    /**
     * Add indexes to existing stores
     */
    function addIndexes() {
        // Check if we need to upgrade the database
        const currentVersion = indexedDBManager.version || 4;
        const targetVersion = currentVersion + 1;
        
        // We'll enhance the existing methods rather than upgrading
        // This is safer and doesn't require a migration
        
        // Enhance getAllClients to use indexes
        const originalGetAll = indexedDBManager.getAll;
        if (originalGetAll) {
            indexedDBManager.getAll = async function(storeName, indexName = null, query = null) {
                try {
                    const db = await this.getDB();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    
                    let request;
                    
                    // Use index if provided and exists
                    if (indexName && store.indexNames.contains(indexName)) {
                        const index = store.index(indexName);
                        if (query !== null && query !== undefined) {
                            request = index.getAll(query);
                        } else {
                            request = index.openCursor();
                        }
                    } else {
                        request = store.getAll();
                    }
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => {
                            resolve(request.result || []);
                        };
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('Error in getAll:', error);
                    // Fallback to original if available
                    if (originalGetAll) {
                        return originalGetAll.call(this, storeName);
                    }
                    throw error;
                }
            };
        }
        
        // Add query method with index support
        indexedDBManager.query = async function(storeName, filters = {}) {
            try {
                const db = await this.getDB();
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                
                // Build query based on available indexes
                let indexName = null;
                let queryValue = null;
                
                // Prefer indexed fields
                if (filters.houseId && store.indexNames.contains('houseId')) {
                    indexName = 'houseId';
                    queryValue = filters.houseId;
                } else if (filters.status && store.indexNames.contains('status')) {
                    indexName = 'status';
                    queryValue = filters.status;
                }
                
                let results = [];
                
                if (indexName) {
                    // Use index for faster query
                    const index = store.index(indexName);
                    const request = index.getAll(queryValue);
                    
                    results = await new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => reject(request.error);
                    });
                } else {
                    // Fallback to full scan with filtering
                    const request = store.getAll();
                    results = await new Promise((resolve, reject) => {
                        request.onsuccess = () => {
                            let filtered = request.result || [];
                            
                            // Apply filters
                            if (filters.houseId) {
                                filtered = filtered.filter(item => item.houseId === filters.houseId);
                            }
                            if (filters.status) {
                                filtered = filtered.filter(item => item.status === filters.status);
                            }
                            if (filters.admissionDateFrom) {
                                const fromDate = new Date(filters.admissionDateFrom);
                                filtered = filtered.filter(item => {
                                    if (!item.admissionDate) return false;
                                    return new Date(item.admissionDate) >= fromDate;
                                });
                            }
                            if (filters.admissionDateTo) {
                                const toDate = new Date(filters.admissionDateTo);
                                filtered = filtered.filter(item => {
                                    if (!item.admissionDate) return false;
                                    return new Date(item.admissionDate) <= toDate;
                                });
                            }
                            
                            resolve(filtered);
                        };
                        request.onerror = () => reject(request.error);
                    });
                }
                
                return results;
            } catch (error) {
                console.error('Error in query:', error);
                throw error;
            }
        };
    }
    
    /**
     * Add query result caching
     */
    function addQueryCaching() {
        // Cache key generator
        function getCacheKey(storeName, filters) {
            return `${storeName}:${JSON.stringify(filters)}`;
        }
        
        // Check if cache entry is valid
        function isCacheValid(entry) {
            if (!entry) return false;
            const age = Date.now() - entry.timestamp;
            return age < CACHE_DURATION;
        }
        
        // Enhanced getAllClients with caching
        if (indexedDBManager.getAllClients) {
            const originalGetAllClients = indexedDBManager.getAllClients;
            
            indexedDBManager.getAllClients = async function(filters = {}) {
                const cacheKey = getCacheKey('clients', filters);
                const cached = queryCache.get(cacheKey);
                
                if (isCacheValid(cached)) {
                    console.log('üì¶ Using cached clients query');
                    return cached.data;
                }
                
                // Execute query
                let results;
                if (Object.keys(filters).length > 0) {
                    results = await this.query('clients', filters);
                } else {
                    results = await originalGetAllClients.call(this);
                }
                
                // Cache results
                queryCache.set(cacheKey, {
                    data: results,
                    timestamp: Date.now()
                });
                
                return results;
            };
        }
        
        // Enhanced getClientsByHouse with caching
        if (indexedDBManager.getClientsByHouse) {
            const originalGetClientsByHouse = indexedDBManager.getClientsByHouse;
            
            indexedDBManager.getClientsByHouse = async function(houseId) {
                const cacheKey = getCacheKey('clients', { houseId });
                const cached = queryCache.get(cacheKey);
                
                if (isCacheValid(cached)) {
                    console.log(`üì¶ Using cached clients for house ${houseId}`);
                    return cached.data;
                }
                
                const results = await originalGetClientsByHouse.call(this, houseId);
                
                queryCache.set(cacheKey, {
                    data: results,
                    timestamp: Date.now()
                });
                
                return results;
            };
        }
        
        // Enhanced getClientsByStatus with caching
        if (indexedDBManager.getClientsByStatus) {
            const originalGetClientsByStatus = indexedDBManager.getClientsByStatus;
            
            indexedDBManager.getClientsByStatus = async function(status) {
                const cacheKey = getCacheKey('clients', { status });
                const cached = queryCache.get(cacheKey);
                
                if (isCacheValid(cached)) {
                    console.log(`üì¶ Using cached clients with status ${status}`);
                    return cached.data;
                }
                
                const results = await originalGetClientsByStatus.call(this, status);
                
                queryCache.set(cacheKey, {
                    data: results,
                    timestamp: Date.now()
                });
                
                return results;
            };
        }
        
        // Add cache invalidation methods
        indexedDBManager.invalidateCache = function(storeName = null) {
            if (storeName) {
                // Invalidate specific store
                for (const [key] of queryCache) {
                    if (key.startsWith(storeName + ':')) {
                        queryCache.delete(key);
                    }
                }
            } else {
                // Invalidate all
                queryCache.clear();
            }
            console.log('üóëÔ∏è Cache invalidated' + (storeName ? ` for ${storeName}` : ''));
        };
        
        // Auto-invalidate cache on updates
        if (indexedDBManager.put) {
            const originalPut = indexedDBManager.put;
            indexedDBManager.put = async function(storeName, data) {
                const result = await originalPut.call(this, storeName, data);
                this.invalidateCache(storeName);
                return result;
            };
        }
        
        if (indexedDBManager.delete) {
            const originalDelete = indexedDBManager.delete;
            indexedDBManager.delete = async function(storeName, key) {
                const result = await originalDelete.call(this, storeName, key);
                this.invalidateCache(storeName);
                return result;
            };
        }
        
        // Clean up old cache entries periodically
        setInterval(() => {
            const now = Date.now();
            for (const [key, entry] of queryCache) {
                if (!isCacheValid(entry)) {
                    queryCache.delete(key);
                }
            }
        }, CACHE_DURATION);
    }
    
    // Integrate with event system for cache invalidation
    if (window.subscribe) {
        window.subscribe('client:updated', () => {
            if (indexedDBManager.invalidateCache) {
                indexedDBManager.invalidateCache('clients');
            }
        });
        
        window.subscribe('tracker:updated', () => {
            if (indexedDBManager.invalidateCache) {
                indexedDBManager.invalidateCache('clients');
            }
        });
    }
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
    
    console.log('‚úÖ IndexedDB optimization initialized');
})();




// Enhancement: onboarding-integration.js
/**
 * Onboarding System Integration
 * Loads onboarding assets and initializes the manager when the dashboard is ready.
 */

(function() {
    'use strict';

    if (window.__onboardingIntegrationLoaded) return;
    window.__onboardingIntegrationLoaded = true;

    const ASSET_PATH = 'onboarding/';
    const SCRIPT_FILES = [
        'onboarding-content.js',
        'onboarding-manager.js',
        'onboarding-video.js',
        'onboarding-tour.js',
        'onboarding-practice.js'
    ];

    // Track if scripts are loading to prevent duplicate loads
    let scriptsLoading = false;
    let scriptsLoaded = false;

    function loadScript(src) {
        return new Promise((resolve, reject) => {
            if (document.querySelector(`script[data-onboarding="${src}"]`)) {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = src;
            script.async = false;
            script.dataset.onboarding = src;
            script.onload = resolve;
            script.onerror = () => reject(new Error(`Failed to load ${src}`));
            document.head.appendChild(script);
        });
    }

    function ensureStyles() {
        if (document.querySelector('link[data-onboarding-style="styles"]')) return;
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = `${ASSET_PATH}onboarding-styles.css`;
        link.dataset.onboardingStyle = 'styles';
        document.head.appendChild(link);
    }

    function loadAssets() {
        if (scriptsLoaded) {
            console.log('[Onboarding] Assets already loaded');
            return Promise.resolve();
        }
        
        if (scriptsLoading) {
            console.log('[Onboarding] Assets already loading, waiting...');
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (scriptsLoaded) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 5000);
            });
        }

        scriptsLoading = true;
        ensureStyles();
        
        return SCRIPT_FILES.reduce((promise, file) => {
            return promise.then(() => {
                console.log(`[Onboarding] Loading ${file}...`);
                return loadScript(`${ASSET_PATH}${file}`);
            }).then(() => {
                console.log(`[Onboarding] Loaded ${file}`);
            });
        }, Promise.resolve()).then(() => {
            scriptsLoaded = true;
            scriptsLoading = false;
            console.log('[Onboarding] All assets loaded');
            
            // Ensure manager is available
            if (!window.onboardingManager) {
                console.warn('[Onboarding] Manager not found after loading scripts, waiting...');
                return new Promise((resolve) => {
                    const checkManager = setInterval(() => {
                        if (window.onboardingManager) {
                            clearInterval(checkManager);
                            resolve();
                        }
                    }, 100);
                    setTimeout(() => {
                        clearInterval(checkManager);
                        resolve();
                    }, 2000);
                });
            }
        });
    }

    function waitForDashboardReady(timeoutMs = 30000) {
        return new Promise((resolve, reject) => {
            const start = Date.now();

            const interval = setInterval(() => {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const dashboardVisible = document.querySelector('.dashboard-container, #dashboardTab, [data-page="dashboard"], .dashboard-manager');
                const managerAvailable = window.onboardingManager;

                if (isLoggedIn && managerAvailable) {
                    // If dashboard is visible, great. If not, still proceed after a short delay
                    if (dashboardVisible || Date.now() - start > 2000) {
                        clearInterval(interval);
                        console.log('[Onboarding] Dashboard ready, initializing...');
                        resolve();
                    }
                }

                if (Date.now() - start > timeoutMs) {
                    clearInterval(interval);
                    console.warn('[Onboarding] Timeout waiting for dashboard, proceeding anyway...');
                    resolve(); // Resolve instead of reject to still try initialization
                }
            }, 500);
        });
    }

    async function initializeOnboarding() {
        try {
            console.log('[Onboarding] Starting initialization...');
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) {
                console.log('[Onboarding] User not logged in, skipping');
                return;
            }

            await loadAssets();
            console.log('[Onboarding] Assets loaded, waiting for dashboard...');
            await waitForDashboardReady();
            
            // Wait a moment for manager to be available
            let attempts = 0;
            while (!window.onboardingManager && attempts < 10) {
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }

            if (window.onboardingManager && typeof window.onboardingManager.initialize === 'function') {
                console.log('[Onboarding] Initializing manager...');
                await window.onboardingManager.initialize();
                console.log('[Onboarding] Manager initialized successfully');
            } else {
                console.error('[Onboarding] Manager not available after loading assets');
                console.error('[Onboarding] window.onboardingManager:', window.onboardingManager);
                console.error('[Onboarding] Available globals:', Object.keys(window).filter(k => k.includes('onboard')));
            }
        } catch (error) {
            console.error('[Onboarding] Error during initialization:', error);
        }
    }

    function hookLoginFlow() {
        // Hook into showDashboard if it exists
        const originalShowDashboard = window.showDashboard;
        if (originalShowDashboard) {
            window.showDashboard = async function(...args) {
                const result = originalShowDashboard.apply(this, args);
                setTimeout(() => initializeOnboarding(), 500);
                return result;
            };
        }

        // Also watch for login state changes
        const checkLoginState = () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (isLoggedIn) {
                setTimeout(() => initializeOnboarding(), 1000);
            }
        };

        // Check immediately
        checkLoginState();

        // Watch for changes
        const originalSetItem = Storage.prototype.setItem;
        Storage.prototype.setItem = function(key, value) {
            originalSetItem.apply(this, arguments);
            if (key === 'isLoggedIn' && value === 'true') {
                setTimeout(() => initializeOnboarding(), 1000);
            }
        };
    }

    function hookKeyboardShortcut() {
        document.addEventListener('keydown', (event) => {
            const isShortcut = (event.ctrlKey || event.metaKey) && event.shiftKey && event.key.toLowerCase() === 'o';
            if (!isShortcut) return;
            event.preventDefault();
            loadAssets().then(() => {
                if (window.onboardingManager) {
                    window.onboardingManager.replay();
                }
            });
        });
    }

    hookLoginFlow();
    hookKeyboardShortcut();

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initializeOnboarding();
    } else {
        window.addEventListener('DOMContentLoaded', initializeOnboarding);
    }

    window.triggerOnboardingTutorial = () => initializeOnboarding();
})();



</script>
    <!-- Client Tracking Styles -->
    <style>
        /* Base Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        /* Client Tracking Styles */
        .tab-navigation {
            display: none !important;
            visibility: hidden !important;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            background: #f9fafb;
            color: #374151;
            transform: translateY(-1px);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }
        
        .tab-content {
            display: none;
            height: 100%;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .client-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .client-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .client-header h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }
        
        .current-client-banner {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .current-client-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-avatar {
            width: 50px;
            height: 50px;
            background: white;
            color: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .client-details {
            flex: 1;
        }
        
        .client-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .client-id {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .client-actions {
            display: flex;
            gap: 10px;
        }
        
        .client-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .client-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .client-quick-add {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .client-form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .client-form-group {
            flex: 1;
        }
        
        .client-form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #4b5563;
            font-weight: 500;
        }
        
        .client-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .client-form-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .add-client-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-client-btn:hover {
            background: #5558e3;
        }
        
        .client-list-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .client-list-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-list-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-filter-tabs {
            display: flex;
            gap: 10px;
        }
        
        .client-filter-tab {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .client-filter-tab:hover {
            border-color: #d1d5db;
            color: #4b5563;
        }
        
        .client-filter-tab.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .client-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .client-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-card:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .client-card.selected {
            background: #ede9fe;
            border-color: #8b5cf6;
        }
        
        .client-card-avatar {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .client-card-info {
            flex: 1;
        }
        
        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .client-card-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-card-kipu {
            font-size: 14px;
            color: #6b7280;
        }
        
        .client-card-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #6b7280;
        }
        
        .client-status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .client-status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .client-status-badge.waitlist {
            background: #fef3c7;
            color: #92400e;
        }
        
        .client-status-badge.discharged {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .client-empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .client-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .client-search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        /* Alert Animation */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Milestone Indicator Styles */
        .milestone-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .milestone-indicator.complete {
            background-color: #10b981;
            color: white;
        }
        
        .milestone-indicator.overdue {
            background-color: #ef4444;
            color: white;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .milestone-indicator.due-today {
            background-color: #f59e0b;
            color: white;
        }
        
        .milestone-indicator.due-soon {
            background-color: #f59e0b;
            color: white;
            opacity: 0.8;
        }
        
        .milestone-indicator.in-progress {
            background-color: #3b82f6;
            color: white;
        }
        
        .milestone-indicator.pending {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .8;
            }
        }
        
        /* Days in care color coding */
        .days-in-care {
            font-weight: 500;
        }
        
        td.days-in-care {
            text-align: center;
        }
        
        /* Color code days based on milestones */
        .days-13 { color: #f59e0b; font-weight: 600; }
        .days-14 { color: #f59e0b; font-weight: 600; }
        .days-16plus { color: #ef4444; font-weight: 600; }
        
        /* CM Tracker House Navigation */
        .cm-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #f9fafb;
        }
        
        .house-navigation {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 0;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .house-tabs {
            display: flex;
            gap: 0;
            flex: 1;
            overflow-x: auto;
        }
        
        .house-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        
        .house-tab:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .house-tab.active {
            color: #6366f1;
            background: #eef2ff;
            border-bottom-color: #6366f1;
        }
        
        .house-tab .client-count {
            margin-left: 5px;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: normal;
        }
        
        .house-tab.active .client-count {
            background: #6366f1;
            color: white;
        }
        
        .house-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .cm-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .cm-action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .cm-action-btn:hover {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .cm-action-btn.primary {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .cm-action-btn.primary:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }
        
        /* Prevent accidental JSON rendering */
        body > *:not(script):not(style):not(link) {
            white-space: normal;
        }
        
        /* Hide any raw JSON that might accidentally render */
        body > pre:not(.code-block),
        body > code:not(.inline-code) {
            display: none !important;
        }
        
        .clients-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .clients-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .clients-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .clients-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            color: #1f2937;
        }
        
        .clients-table tr:hover {
            background: #f9fafb;
        }
        
        .client-initials {
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
        }
        
        .client-initials:hover {
            color: #6366f1;
            text-decoration: underline;
        }
        
        .days-in-care {
            font-weight: 500;
            color: #6b7280;
        }
        
        .team-member {
            font-size: 13px;
            color: #6b7280;
        }
        
        .milestone-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .milestone-indicator.complete {
            background: #10b981;
            color: white;
        }
        
        .milestone-indicator.pending {
            background: #f3f4f6;
            color: #9ca3af;
            border: 1px solid #e5e7eb;
        }
        
        .milestone-indicator.overdue {
            background: #ef4444;
            color: white;
        }
        
        .aftercare-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .aftercare-status.sent {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .aftercare-status.engaged {
            background: #fef3c7;
            color: #92400e;
        }
        
        .aftercare-status.accepted {
            background: #d1fae5;
            color: #065f46;
        }
        
        .aftercare-status.declined {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 4px 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #e5e7eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .empty-state-text {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 500px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #1f2937;
            font-size: 20px;
        }
        
        .modal-content label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }
        
        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
    
/* Enhancement: styles.css */

/* Custom Enhancements - Add your custom styles here */

/* Modal Overlay Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
}

/* Form Enhancements */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #2d3748;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #667eea;
}

.form-group small {
    display: block;
    margin-top: 4px;
    font-size: 12px;
}

/* Button Styles */
.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}

.btn-primary:hover {
    transform: translateY(-2px);
}

.btn-secondary {
    background: #e2e8f0;
    color: #2d3748;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-secondary:hover {
    background: #cbd5e0;
}

.btn-icon {
    background: transparent;
    border: 1px solid #e2e8f0;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    margin-left: 10px;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: #f7fafc;
    border-color: #cbd5e0;
}

/* Notifications */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Enhancement: unified-design.css */


/* Enhancement: tracker-ui.css */
/**
 * Tracker UI Styles
 * Visual enhancements for tracker completion indicators
 */

/* Tracker Status in Client Cards */
.tracker-status {
    margin: 10px 0;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tracker-status:hover {
    background: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Risk Level Indicators */
.tracker-status.risk-red {
    border-left: 4px solid #dc3545;
    background: #fff5f5;
}

.tracker-status.risk-yellow {
    border-left: 4px solid #ffc107;
    background: #fffdf5;
}

.tracker-status.risk-green {
    border-left: 4px solid #28a745;
    background: #f5fff7;
}

/* Completion Bar */
.completion-bar {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.completion-fill {
    height: 100%;
    background: linear-gradient(90deg, #0099cc 0%, #006699 100%);
    transition: width 0.5s ease;
    position: relative;
}

.completion-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255,255,255,0.3) 50%,
        transparent 100%
    );
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Completion Text */
.completion-text {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    margin-bottom: 4px;
}

.completion-percentage {
    font-weight: 600;
    color: #333;
}

.critical-missing {
    color: #dc3545;
    font-weight: 500;
}

/* Missing Items */
.missing-items {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
    font-style: italic;
}

/* Tracker Modal */
.tracker-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.tracker-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tracker-modal-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tracker-modal-header h3 {
    margin: 0;
    font-size: 20px;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.3s ease;
}

.close-btn:hover {
    background: rgba(255,255,255,0.2);
}

.tracker-modal-content {
    padding: 20px;
    overflow-y: auto;
    max-height: calc(80vh - 70px);
}

/* Summary Stats */
.tracker-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.summary-stat {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: #0099cc;
}

/* Missing & Upcoming Sections */
.missing-critical-section,
.upcoming-section {
    margin-bottom: 20px;
}

.missing-critical-section h4,
.upcoming-section h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 16px;
}

.missing-list,
.upcoming-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.missing-item,
.upcoming-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.missing-item:hover,
.upcoming-item:hover {
    border-color: #0099cc;
    box-shadow: 0 2px 8px rgba(0,153,204,0.1);
}

.missing-item {
    border-left: 3px solid #dc3545;
}

.upcoming-item {
    border-left: 3px solid #ffc107;
}

.item-label {
    font-weight: 500;
    color: #333;
}

.item-due {
    font-size: 12px;
    color: #666;
}

/* Tracker Actions */
.tracker-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.tracker-actions button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,153,204,0.3);
}

.btn-secondary {
    background: #f8f9fa;
    color: #333;
    border: 1px solid #dee2e6;
}

.btn-secondary:hover {
    background: #e9ecef;
}

/* Dashboard Integration */
.client-card {
    position: relative;
    transition: all 0.3s ease;
}

.client-card:has(.tracker-status.risk-red) {
    border-color: #dc3545;
}

.client-card:has(.tracker-status.risk-yellow) {
    border-color: #ffc107;
}

/* Flight Plan Integration */
.priority-item[data-tracker-generated="true"] {
    position: relative;
}

.priority-item[data-tracker-generated="true"]::before {
    content: 'ü§ñ';
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    opacity: 0.5;
}

/* Timeline Modal Specific */
.timeline-modal-large {
    width: 95%;
    max-width: 1200px;
}

.timeline-modal-large .tracker-modal-content {
    max-height: calc(90vh - 70px);
}

/* Responsive Design */
@media (max-width: 768px) {
    .tracker-modal {
        width: 95%;
        max-height: 90vh;
    }
    
    .tracker-summary {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .completion-text {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .tracker-actions {
        flex-direction: column;
    }
}


/* Enhancement: tracker-timeline.css */
/**
 * Tracker Timeline Styles
 * Visual timeline component for tracker progress
 */

/* Timeline Container */
.tracker-timeline {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Timeline Header */
.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.timeline-title h3 {
    margin: 0;
    color: #333;
    font-size: 20px;
}

.timeline-subtitle {
    display: block;
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.timeline-stats {
    display: flex;
    gap: 20px;
}

.stat-badge {
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 28px;
    font-weight: 700;
    color: #0099cc;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Timeline Container */
.timeline-container {
    position: relative;
    margin: 40px 0;
    padding: 40px 0;
}

/* Timeline Track */
.timeline-track {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 4px;
    background: #e0e0e0;
    transform: translateY(-50%);
    border-radius: 2px;
}

.timeline-progress {
    height: 100%;
    background: linear-gradient(90deg, #0099cc 0%, #006699 100%);
    border-radius: 2px;
    transition: width 0.5s ease;
}

/* Timeline Markers */
.timeline-markers {
    position: relative;
    height: 60px;
}

.timeline-marker {
    position: absolute;
    transform: translateX(-50%);
}

.marker-line {
    width: 2px;
    height: 40px;
    background: #999;
    margin: 0 auto;
}

.marker-label {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    margin-top: 5px;
    text-align: center;
}

.timeline-marker.admission .marker-line {
    background: #28a745;
}

.timeline-marker.current .marker-line {
    background: #0099cc;
    width: 3px;
}

.timeline-marker.current .marker-label {
    font-weight: 600;
    color: #0099cc;
}

.timeline-marker.discharge .marker-line {
    background: #dc3545;
}

/* Timeline Items */
.timeline-items {
    position: relative;
    min-height: 200px;
    margin-top: 40px;
}

.timeline-group {
    position: absolute;
    transform: translateX(-50%);
}

.group-connector {
    width: 2px;
    height: 20px;
    background: #ddd;
    margin: 0 auto;
}

.group-label {
    font-size: 12px;
    color: #666;
    text-align: center;
    margin-bottom: 10px;
    font-weight: 600;
}

.group-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
}

/* Timeline Item */
.timeline-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    white-space: nowrap;
}

.timeline-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.item-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
}

.item-icon.complete {
    background: #28a745;
    color: white;
}

.item-icon.pending {
    background: #e0e0e0;
    color: #666;
}

.item-icon.upcoming {
    background: #ffc107;
    color: white;
}

.item-icon.overdue {
    background: #dc3545;
    color: white;
}

.item-content {
    flex: 1;
}

.item-title {
    font-size: 13px;
    font-weight: 500;
    color: #333;
    display: flex;
    align-items: center;
    gap: 5px;
}

.critical-badge {
    color: #dc3545;
    font-size: 12px;
}

.item-date {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

/* Timeline Item Status Colors */
.timeline-item.complete {
    background: #e8f5e9;
}

.timeline-item.overdue {
    background: #ffebee;
}

.timeline-item.upcoming {
    background: #fff8e1;
}

/* Tooltip */
.item-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-10px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
    pointer-events: none;
}

.item-tooltip.visible {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
}

.tooltip-content {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    min-width: 250px;
}

.tooltip-content h4 {
    margin: 0 0 8px 0;
    color: #333;
    font-size: 14px;
}

.tooltip-content p {
    margin: 0 0 10px 0;
    font-size: 12px;
    color: #666;
    line-height: 1.5;
}

.tooltip-status {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

.btn-mark-complete {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-mark-complete:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,153,204,0.3);
}

/* Legend */
.timeline-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #666;
}

.legend-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}

.legend-icon.complete {
    background: #28a745;
    color: white;
}

.legend-icon.pending {
    background: #e0e0e0;
    color: #666;
}

.legend-icon.overdue {
    background: #dc3545;
    color: white;
}

.legend-icon.critical {
    background: transparent;
    color: #dc3545;
}

/* Notifications */
.timeline-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 10000;
}

.timeline-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.timeline-notification.success {
    background: #28a745;
}

.timeline-notification.error {
    background: #dc3545;
}

.timeline-notification.info {
    background: #0099cc;
}

/* Responsive Design */
@media (max-width: 768px) {
    .timeline-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .timeline-stats {
        justify-content: center;
    }
    
    .timeline-container {
        overflow-x: auto;
        padding-bottom: 60px;
    }
    
    .timeline-items {
        min-width: 600px;
    }
    
    .timeline-legend {
        flex-wrap: wrap;
        gap: 10px;
    }
}


/* Enhancement: tracker-bulk-update.css */
/**
 * Tracker Bulk Update Modal Styles
 * Quick-entry interface for updating multiple tracker items
 */

/* Overlay */
.bulk-update-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

/* Modal Container */
.bulk-update-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

/* Header */
.bulk-update-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-info h3 {
    margin: 0 0 8px 0;
    font-size: 20px;
}

.header-stats {
    display: flex;
    gap: 15px;
    font-size: 14px;
    opacity: 0.9;
}

.header-stats .stat {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.header-stats .stat::after {
    content: '‚Ä¢';
    margin-left: 10px;
    opacity: 0.5;
}

.header-stats .stat:last-child::after {
    display: none;
}

/* Content */
.bulk-update-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Filters */
.bulk-update-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.filter-btn {
    padding: 8px 16px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-btn:hover {
    background: #f8f9fa;
}

.filter-btn.active {
    background: #0099cc;
    color: white;
    border-color: #0099cc;
}

/* Categories */
.bulk-update-categories {
    margin-bottom: 20px;
}

.update-category {
    margin-bottom: 25px;
}

.category-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid #e0e0e0;
}

.category-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Items */
.update-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.update-item:hover {
    background: #e9ecef;
}

.update-item.complete {
    background: #e8f5e9;
}

.update-item.overdue {
    background: #ffebee;
    border-left: 3px solid #dc3545;
}

.item-label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    flex: 1;
}

.item-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.item-text {
    font-size: 14px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.critical-badge {
    color: #dc3545;
    font-size: 12px;
}

.item-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
}

.completed-date {
    color: #28a745;
}

.due-date {
    color: #666;
}

.overdue-badge {
    background: #dc3545;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

/* Notes Section */
.bulk-update-notes {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.bulk-update-notes label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.bulk-update-notes textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 14px;
    resize: vertical;
    font-family: inherit;
}

.bulk-update-notes textarea:focus {
    outline: none;
    border-color: #0099cc;
    box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
}

/* Footer */
.bulk-update-footer {
    padding: 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

.footer-info {
    font-size: 14px;
    color: #666;
}

.footer-actions {
    display: flex;
    gap: 10px;
}

.footer-actions button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary {
    background: white;
    color: #333;
    border: 1px solid #dee2e6;
}

.btn-secondary:hover {
    background: #e9ecef;
}

.btn-primary {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,153,204,0.3);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Notifications */
.bulk-update-notification {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.bulk-update-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.bulk-update-notification.success {
    background: #28a745;
}

.bulk-update-notification.error {
    background: #dc3545;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .bulk-update-modal {
        width: 95%;
        max-height: 95vh;
    }
    
    .bulk-update-header {
        padding: 15px;
    }
    
    .header-info h3 {
        font-size: 18px;
    }
    
    .header-stats {
        font-size: 12px;
    }
    
    .bulk-update-filters {
        flex-wrap: wrap;
    }
    
    .update-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .item-info {
        margin-left: 30px;
    }
    
    .footer-actions {
        flex-direction: column;
        width: 100%;
    }
    
    .footer-actions button {
        width: 100%;
    }
}


/* Enhancement: tracker-compliance-widget.css */
/**
 * Tracker Compliance Widget Styles
 * House-level compliance dashboard visualization
 */

/* Widget Container */
.compliance-widget {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Widget Header */
.compliance-widget .widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.compliance-widget .widget-header h3 {
    margin: 0;
    font-size: 18px;
    color: #333;
}

.refresh-btn {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    background: #f8f9fa;
    transform: rotate(180deg);
}

.refresh-icon {
    font-size: 16px;
    color: #666;
}

/* Compliance Overview */
.compliance-overview {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 20px;
    margin-bottom: 25px;
    padding-bottom: 25px;
    border-bottom: 1px solid #e0e0e0;
}

/* Overall Score Circle */
.overall-score {
    display: flex;
    align-items: center;
    justify-content: center;
}

.score-circle {
    position: relative;
    width: 100px;
    height: 100px;
}

.circular-chart {
    display: block;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.circle-bg {
    fill: none;
    stroke: #f0f0f0;
    stroke-width: 2.8;
}

.circle {
    fill: none;
    stroke: #0099cc;
    stroke-width: 2.8;
    stroke-linecap: round;
    animation: progress 1s ease-out forwards;
}

@keyframes progress {
    0% {
        stroke-dasharray: 0 100;
    }
}

.percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.percentage .value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: #0099cc;
}

.percentage .label {
    display: block;
    font-size: 11px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Compliance Metrics */
.compliance-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    align-items: center;
}

.metric {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.metric-value {
    display: block;
    font-size: 28px;
    font-weight: 700;
    color: #333;
    margin-bottom: 5px;
}

.metric-label {
    display: block;
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* House Compliance List */
.house-compliance-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

/* House Card */
.house-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.house-card.good {
    border-color: #28a745;
}

.house-card.warning {
    border-color: #ffc107;
}

.house-card.danger {
    border-color: #dc3545;
}

.house-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.house-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.house-header h4 {
    margin: 0;
    font-size: 16px;
    color: #333;
}

.house-score {
    font-size: 20px;
    font-weight: 700;
}

.house-card.good .house-score {
    color: #28a745;
}

.house-card.warning .house-score {
    color: #ffc107;
}

.house-card.danger .house-score {
    color: #dc3545;
}

/* House Details */
.house-details {
    margin-bottom: 12px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    padding: 3px 0;
}

.detail-row span:first-child {
    color: #666;
}

.detail-row span:last-child {
    font-weight: 600;
    color: #333;
}

.text-danger {
    color: #dc3545 !important;
}

/* Category Breakdown */
.category-breakdown {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e0e0e0;
}

.category-bar {
    display: grid;
    grid-template-columns: 60px 1fr 40px;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}

.cat-label {
    font-size: 11px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.cat-progress {
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
}

.cat-fill {
    height: 100%;
    background: linear-gradient(90deg, #0099cc 0%, #006699 100%);
    transition: width 0.5s ease;
}

.cat-value {
    font-size: 11px;
    font-weight: 600;
    color: #333;
    text-align: right;
}

/* At Risk Section */
.at-risk-section {
    background: #fff5f5;
    border: 1px solid #ffcdd2;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.at-risk-section h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: #c62828;
}

.at-risk-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.at-risk-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid #ffebee;
}

.client-info {
    font-size: 13px;
    color: #333;
}

.action-btn {
    padding: 6px 12px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-btn:hover {
    background: #c82333;
    transform: translateY(-1px);
}

/* Widget Error */
.widget-error {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}

/* Responsive Design */
@media (max-width: 768px) {
    .compliance-overview {
        grid-template-columns: 1fr;
        text-align: center;
    }
    
    .overall-score {
        margin: 0 auto 20px;
    }
    
    .compliance-metrics {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .house-compliance-list {
        grid-template-columns: 1fr;
    }
    
    .metric {
        padding: 10px;
    }
    
    .metric-value {
        font-size: 20px;
    }
}


/* Enhancement: tracker-document-hub.css */
/**
 * Tracker Document Hub Styles
 * Visual status indicators for document tracking
 */

/* Document Hub Overlay */
.document-hub-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

/* Document Hub Modal */
.document-hub-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

/* Header */
.document-hub-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.document-hub-header h3 {
    margin: 0;
    font-size: 20px;
}

/* Content */
.document-hub-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Document Summary */
.document-summary {
    margin-bottom: 25px;
    padding-bottom: 25px;
    border-bottom: 2px solid #e0e0e0;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
}

.summary-stat {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.summary-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.summary-stat.danger {
    background: #ffebee;
    border: 1px solid #ffcdd2;
}

.summary-stat.warning {
    background: #fff8e1;
    border: 1px solid #ffe0b2;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #0099cc;
    display: block;
    margin-bottom: 5px;
}

.summary-stat.danger .stat-value {
    color: #dc3545;
}

.summary-stat.warning .stat-value {
    color: #ffc107;
}

.stat-label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Document Categories */
.document-categories {
    margin-bottom: 20px;
}

.document-category {
    margin-bottom: 25px;
}

.document-category h4 {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 15px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid #e0e0e0;
}

/* Document List */
.document-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Document Item */
.document-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.document-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.document-item.complete {
    background: #e8f5e9;
    border-color: #4caf50;
}

.document-item.overdue {
    background: #ffebee;
    border-color: #f44336;
}

.document-item.urgent {
    background: #fff8e1;
    border-color: #ff9800;
}

/* Document Icon */
.document-icon {
    font-size: 24px;
    width: 40px;
    text-align: center;
}

/* Document Info */
.document-info {
    flex: 1;
}

.document-name {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.required-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: #dc3545;
    color: white;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.signature-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: #6c757d;
    color: white;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.document-status {
    font-size: 12px;
    color: #666;
}

.document-item.overdue .document-status {
    color: #dc3545;
    font-weight: 600;
}

.document-item.urgent .document-status {
    color: #ff9800;
    font-weight: 600;
}

/* Document Actions */
.document-actions {
    display: flex;
    gap: 8px;
}

.btn-icon {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: #f8f9fa;
    transform: scale(1.1);
}

.btn-small {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-small:hover {
    background: #f8f9fa;
}

.btn-small.primary {
    background: #0099cc;
    color: white;
    border-color: #0099cc;
}

.btn-small.primary:hover {
    background: #0088bb;
    transform: translateY(-1px);
}

/* Document Actions Footer */
.document-hub-content .document-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.document-hub-content .document-actions button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Document Hub Button on Cards */
.document-hub-btn {
    margin-top: 8px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #333;
}

.document-hub-btn:hover {
    background: #e9ecef;
    border-color: #0099cc;
    color: #0099cc;
}

/* Notifications */
.document-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 10001;
}

.document-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.document-notification.success {
    background: #28a745;
}

.document-notification.error {
    background: #dc3545;
}

.document-notification.info {
    background: #0099cc;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .document-hub-modal {
        width: 95%;
        max-height: 95vh;
    }
    
    .summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .document-item {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .document-info {
        width: 100%;
    }
    
    .document-actions {
        width: 100%;
        justify-content: center;
    }
    
    .document-hub-content .document-actions {
        flex-direction: column;
    }
    
    .document-hub-content .document-actions button {
        width: 100%;
    }
}


/* Enhancement: tracker-aftercare-cascade.css */
/**
 * Aftercare Options Cascade Styles
 * Visual flow for aftercare decisions
 */

/* Overlay */
.aftercare-cascade-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

/* Modal */
.aftercare-cascade-modal {
    background: white;
    border-radius: 12px;
    width: 95%;
    max-width: 1100px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

/* Header */
.cascade-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-info h3 {
    margin: 0 0 8px 0;
    font-size: 20px;
}

.header-stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    opacity: 0.9;
}

.header-stats span {
    position: relative;
}

.header-stats span:not(:last-child)::after {
    content: '‚Ä¢';
    position: absolute;
    right: -12px;
    opacity: 0.5;
}

/* Content */
.cascade-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Timeline */
.cascade-timeline {
    margin-bottom: 30px;
}

.timeline-header {
    display: grid;
    grid-template-columns: 2fr 2fr 1.5fr;
    gap: 20px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
}

.timeline-label {
    font-size: 14px;
    font-weight: 600;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Cascade Options */
.cascade-options {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 20px;
}

/* Individual Option */
.cascade-option {
    display: grid;
    grid-template-columns: 40px 2fr 60px 2fr 60px 1.5fr;
    gap: 0;
    align-items: start;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.cascade-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.option-number {
    width: 32px;
    height: 32px;
    background: #0099cc;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
}

/* Option Stages */
.option-stage {
    padding: 0 15px;
}

.stage-content h4 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #333;
}

.option-details {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
}

.detail-item {
    font-size: 12px;
    padding: 3px 8px;
    background: white;
    border-radius: 4px;
    color: #666;
}

.date-label {
    font-size: 11px;
    color: #999;
    margin-top: 5px;
}

.stage-actions {
    margin-top: 10px;
}

/* Connectors */
.option-connector {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    height: 100%;
}

.connector-line {
    position: absolute;
    width: 100%;
    height: 2px;
    background: #ddd;
    top: 50%;
    transform: translateY(-50%);
}

.connector-icon {
    position: relative;
    background: white;
    padding: 5px;
    font-size: 18px;
    z-index: 1;
}

/* Response Status */
.response-status {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.response-text {
    font-size: 13px;
    color: #666;
    font-style: italic;
    margin: 8px 0;
}

/* Status Colors */
.status-accepted .option-number,
.status-accepted .connector-icon {
    background: #28a745;
    color: white;
}

.status-declined .option-number,
.status-declined .connector-icon {
    background: #dc3545;
    color: white;
}

.status-pending .option-number,
.status-pending .connector-icon {
    background: #ffc107;
    color: white;
}

.status-waitlist .option-number,
.status-waitlist .connector-icon {
    background: #6c757d;
    color: white;
}

.cascade-option.status-accepted {
    border-color: #28a745;
    background: #f0fdf4;
}

.cascade-option.status-declined {
    border-color: #dc3545;
    background: #fef2f2;
}

/* Next Steps */
.next-steps-list {
    margin: 10px 0;
    padding-left: 20px;
    font-size: 13px;
    color: #666;
}

.next-steps-list li {
    margin: 5px 0;
}

.declined-note,
.waitlist-note,
.pending-note {
    padding: 10px;
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
}

.declined-note {
    background: #ffebee;
    color: #c62828;
}

.waitlist-note {
    background: #f5f5f5;
    color: #616161;
}

.pending-note {
    background: #fff8e1;
    color: #f57c00;
}

/* Option Timeline */
.option-timeline {
    grid-column: 2 / -1;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
}

.timeline-event {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-right: 20px;
    font-size: 12px;
    color: #666;
}

.event-date {
    font-weight: 600;
}

/* Empty State */
.cascade-empty {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.cascade-empty h4 {
    margin: 0 0 10px 0;
    color: #333;
}

/* Add Option Section */
.add-option-section {
    text-align: center;
    padding: 20px;
}

.btn-add-option {
    padding: 12px 24px;
    background: white;
    border: 2px dashed #0099cc;
    border-radius: 8px;
    color: #0099cc;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-add-option:hover {
    background: #f0f9ff;
    border-style: solid;
}

/* Summary Section */
.cascade-summary {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.summary-section h4 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #333;
}

.summary-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.summary-stats .stat {
    flex: 1;
    text-align: center;
    padding: 15px;
    border-radius: 8px;
    font-size: 20px;
    font-weight: 700;
}

.stat.accepted {
    background: #e8f5e9;
    color: #2e7d32;
}

.stat.pending {
    background: #fff8e1;
    color: #f57c00;
}

.stat.declined {
    background: #ffebee;
    color: #c62828;
}

.primary-selection,
.waiting-response,
.recommendation {
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.primary-selection {
    background: #e8f5e9;
    border: 1px solid #4caf50;
}

.waiting-response {
    background: #fff8e1;
    border: 1px solid #ffc107;
}

.recommendation {
    background: #e3f2fd;
    border: 1px solid #2196f3;
}

.primary-selection h5,
.waiting-response h5,
.recommendation h5 {
    margin: 0 0 8px 0;
    font-size: 14px;
}

.selection-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

/* Actions */
.cascade-actions {
    display: flex;
    gap: 10px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.cascade-actions button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Buttons */
.btn-icon {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: #f8f9fa;
    transform: scale(1.1);
}

.btn-small {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-small:hover {
    background: #f8f9fa;
}

/* Notifications */
.cascade-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 10001;
}

.cascade-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.cascade-notification.success {
    background: #28a745;
}

.cascade-notification.error {
    background: #dc3545;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 1024px) {
    .cascade-option {
        grid-template-columns: 40px 1fr;
        gap: 10px;
    }
    
    .option-stage,
    .option-connector {
        grid-column: 2;
        margin-bottom: 15px;
    }
    
    .option-connector {
        height: 40px;
        flex-direction: column;
    }
    
    .connector-line {
        width: 2px;
        height: 100%;
        left: 50%;
        top: 0;
        transform: translateX(-50%);
    }
    
    .timeline-header {
        display: none;
    }
}

@media (max-width: 768px) {
    .aftercare-cascade-modal {
        width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
    }
    
    .cascade-actions {
        flex-direction: column;
    }
    
    .cascade-actions button {
        width: 100%;
    }
}


/* Enhancement: discharge-checklist.css */
/* Discharge Checklist Styles */

.discharge-checklist-modal .modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

.discharge-checklist-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 2px solid #e5e7eb;
}

.discharge-checklist-modal h2 {
    margin: 0;
    color: #1f2937;
    font-size: 24px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-close:hover {
    color: #1f2937;
}

/* Progress Bar */
.checklist-progress {
    padding: 20px;
    background: #f9fafb;
}

.progress-bar {
    width: 100%;
    height: 24px;
    background: #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    transition: width 0.3s ease;
}

.progress-text {
    margin-top: 10px;
    text-align: center;
    font-size: 14px;
    color: #6b7280;
}

/* Checklist Sections */
.checklist-sections {
    padding: 20px;
}

.checklist-section {
    margin-bottom: 30px;
}

.checklist-section h3 {
    color: #374151;
    font-size: 18px;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e5e7eb;
}

/* Checklist Items */
.checklist-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.checklist-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px 16px;
    transition: all 0.2s ease;
}

.checklist-item:hover {
    border-color: #9ca3af;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.checklist-item.completed {
    background: #f0fdf4;
    border-color: #86efac;
}

.checklist-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    gap: 12px;
}

.checklist-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    cursor: pointer;
    flex-shrink: 0;
}

.item-label {
    flex: 1;
    font-size: 15px;
    color: #1f2937;
    line-height: 1.5;
}

.checklist-item.completed .item-label {
    color: #059669;
    text-decoration: line-through;
}

.required {
    color: #ef4444;
    font-weight: bold;
    margin-left: 4px;
}

.item-description {
    margin-left: 32px;
    margin-top: 6px;
    font-size: 13px;
    color: #6b7280;
    font-style: italic;
}

.item-meta {
    margin-left: 32px;
    margin-top: 6px;
    font-size: 12px;
    color: #10b981;
    font-weight: 500;
}

/* Modal Footer */
.discharge-checklist-modal .modal-footer {
    padding: 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Print Styles */
@media print {
    .discharge-checklist-modal {
        position: static;
        background: white;
    }
    
    .discharge-checklist-modal .modal-content {
        box-shadow: none;
        max-width: 100%;
    }
    
    .btn-close,
    .modal-footer button {
        display: none;
    }
    
    .checklist-item {
        break-inside: avoid;
    }
    
    .checklist-section {
        page-break-inside: avoid;
    }
}

/* Add discharge button to client cards */
.btn-discharge-checklist {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: transform 0.2s;
}

.btn-discharge-checklist:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}


/* Enhancement: missions-redesign.css */
/* Modern Missions Widget Redesign */

.missions-widget {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.25);
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
}

.missions-widget::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 60%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
}

/* Header Section */
.missions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    position: relative;
    z-index: 1;
}

.missions-title {
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    font-size: 24px;
    font-weight: 700;
}

.missions-title::before {
    content: 'üéØ';
    font-size: 28px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.missions-progress {
    display: flex;
    align-items: center;
    gap: 16px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    padding: 8px 16px;
    border-radius: 100px;
    color: white;
    font-weight: 600;
}

.progress-circles {
    display: flex;
    gap: 8px;
}

.progress-circle {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    background: transparent;
    transition: all 0.3s ease;
}

.progress-circle.completed {
    background: white;
    border-color: white;
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.4);
}

/* Mission Sections */
.mission-section {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.mission-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.mission-section.primary {
    border-left: 4px solid #ef4444;
}

.mission-section.secondary {
    border-left: 4px solid #f59e0b;
}

.mission-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.mission-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #1f2937;
    font-size: 16px;
}

.mission-label .icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.mission-section.primary .icon {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.mission-section.secondary .icon {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
}

.mission-time {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
}

/* Mission Items */
.mission-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px;
    border-radius: 12px;
    background: linear-gradient(135deg, #fafafa 0%, #f9fafb 100%);
    margin-bottom: 12px;
    transition: all 0.2s ease;
    position: relative;
}

.mission-item:hover {
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    transform: translateX(4px);
}

.mission-item.critical {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.mission-checkbox {
    position: relative;
}

.mission-checkbox input[type="checkbox"] {
    width: 24px;
    height: 24px;
    appearance: none;
    border: 2px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.mission-checkbox input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-color: #059669;
}

.mission-checkbox input[type="checkbox"]:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 14px;
    font-weight: bold;
}

.mission-content {
    flex: 1;
}

.mission-client {
    display: inline-block;
    background: #1f2937;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 8px;
}

.mission-text {
    color: #4b5563;
    font-size: 15px;
    line-height: 1.4;
}

.mission-critical {
    display: inline-block;
    background: #ef4444;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    margin-left: 8px;
}

.mission-action {
    padding: 8px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.mission-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Quick Actions Bar */
.quick-actions {
    display: flex;
    gap: 12px;
    padding: 20px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    flex-wrap: wrap;
    justify-content: center;
}

.quick-action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 100px;
}

.quick-action-btn:hover {
    background: linear-gradient(135deg, white 0%, #f9fafb 100%);
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.quick-action-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.quick-action-label {
    font-size: 13px;
    color: #6b7280;
    font-weight: 600;
    text-align: center;
}

/* Animations */
@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

.missions-widget {
    animation: slideInFromTop 0.5s ease;
}

.mission-section {
    animation: slideInFromTop 0.5s ease;
    animation-fill-mode: both;
}

.mission-section:nth-child(2) {
    animation-delay: 0.1s;
}

.mission-section:nth-child(3) {
    animation-delay: 0.2s;
}

/* Empty State */
.missions-empty {
    text-align: center;
    padding: 40px;
    color: rgba(255, 255, 255, 0.9);
}

.missions-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.missions-empty-text {
    font-size: 18px;
    font-weight: 500;
}

/* Responsive Design */
@media (max-width: 768px) {
    .missions-widget {
        padding: 20px;
    }
    
    .missions-title {
        font-size: 20px;
    }
    
    .quick-actions {
        padding: 12px;
    }
    
    .quick-action-btn {
        min-width: 80px;
        padding: 12px 8px;
    }
}


/* Enhancement: morning-review.css */
/* Morning Review Dashboard Styles */

.morning-review-modal .modal-content {
    max-height: 90vh;
    overflow-y: auto;
    background: #f9fafb;
}

/* Morning Header */
.morning-header {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 30px;
    margin: -30px -30px 20px -30px;
    border-radius: 12px 12px 0 0;
}

.morning-greeting h2 {
    margin: 0;
    font-size: 32px;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.review-date {
    margin: 8px 0 0 0;
    font-size: 18px;
    opacity: 0.9;
}

.morning-header .btn-close {
    color: white;
    opacity: 0.8;
}

.morning-header .btn-close:hover {
    opacity: 1;
}

/* Review Content */
.review-content {
    padding: 0 20px 20px;
}

/* Morning Stats */
.morning-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
    transition: all 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.stat-card.alert {
    border-color: #ef4444;
    background: #fef2f2;
}

.stat-card.primary {
    border-color: #3b82f6;
    background: #eff6ff;
}

.stat-card.success {
    border-color: #10b981;
    background: #f0fdf4;
}

.stat-number {
    font-size: 36px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 8px;
}

.stat-card.alert .stat-number {
    color: #dc2626;
}

.stat-card.primary .stat-number {
    color: #2563eb;
}

.stat-card.success .stat-number {
    color: #059669;
}

.stat-label {
    font-size: 14px;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Daily Insights */
.daily-insights {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 30px;
}

.insight-banner {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    border-radius: 8px;
    font-size: 15px;
}

.insight-banner.critical {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    color: #991b1b;
    border-left: 4px solid #dc2626;
}

.insight-banner.warning {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    color: #92400e;
    border-left: 4px solid #f59e0b;
}

.insight-banner.efficiency {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    color: #075985;
    border-left: 4px solid #0284c7;
}

.insight-banner.reminder {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    color: #374151;
    border-left: 4px solid #6b7280;
}

.insight-banner.success {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    color: #14532d;
    border-left: 4px solid #22c55e;
}

.insight-icon {
    font-size: 20px;
    flex-shrink: 0;
}

/* Batch Actions */
.batch-actions-section {
    margin-bottom: 30px;
}

.batch-actions-section h3 {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    color: #1f2937;
}

.batch-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.batch-action-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 22px;
    transition: all 0.2s ease;
}

.batch-action-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.batch-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 13px;
    color: #6b7280;
}

.batch-count {
    background: #3b82f6;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
}

.batch-time {
    display: flex;
    align-items: center;
    gap: 4px;
}

.batch-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
}

.batch-clients {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 16px;
}

.btn-batch {
    width: 100%;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-batch:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Review Sections */
.review-sections {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.review-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.review-section h3 {
    margin: 0 0 16px 0;
    color: #1f2937;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.review-section.overdue {
    border-left: 4px solid #ef4444;
}

.review-section.today {
    border-left: 4px solid #3b82f6;
}

.review-section.upcoming {
    border-left: 4px solid #8b5cf6;
}

.review-section.followups {
    border-left: 4px solid #f59e0b;
}

.review-section.opportunities {
    border-left: 4px solid #10b981;
}

/* Task List */
.task-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.review-task-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 16px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
}

.review-task-item:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
}

.task-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.task-details {
    flex: 1;
}

.task-client {
    font-size: 13px;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 4px;
}

.task-name {
    font-size: 15px;
    color: #1f2937;
    font-weight: 500;
}

.task-overdue {
    font-size: 12px;
    color: #dc2626;
    margin-top: 4px;
    font-weight: 600;
}

.task-due {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
}

.btn-task-action {
    padding: 6px 12px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 13px;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-task-action:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

/* Follow-up List */
.followup-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.followup-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.followup-client {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
}

.followup-options {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.option-tag {
    background: #fef3c7;
    color: #92400e;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.btn-followup {
    padding: 8px 16px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-followup:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

/* Opportunity List */
.opportunity-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.opportunity-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border-radius: 8px;
    border: 1px solid #86efac;
}

.opp-icon {
    font-size: 32px;
    flex-shrink: 0;
}

.opp-details {
    flex: 1;
}

.opp-message {
    font-weight: 600;
    color: #166534;
    margin-bottom: 4px;
}

.opp-benefit {
    font-size: 13px;
    color: #15803d;
}

.btn-opportunity {
    padding: 8px 20px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-opportunity:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* Morning Review Button */
.btn-morning-review {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
}

.btn-morning-review:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
    .morning-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .batch-actions-grid {
        grid-template-columns: 1fr;
    }
    
    .review-task-item {
        flex-wrap: wrap;
    }
    
    .task-details {
        flex: 1 0 100%;
    }
}

/* Print Styles */
@media print {
    .morning-review-modal {
        position: static;
        background: white;
    }
    
    .morning-header {
        color: black;
        background: none;
        border-bottom: 2px solid #000;
    }
    
    .btn-close,
    .modal-footer,
    .btn-batch,
    .btn-task-action,
    .btn-followup,
    .btn-opportunity {
        display: none;
    }
    
    .review-section {
        page-break-inside: avoid;
    }
}

        /* Clinician Workspace Auth Screen */
        .auth-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
            background:
                radial-gradient(circle at top left, rgba(255, 255, 255, 0.12), transparent 55%),
                radial-gradient(circle at bottom right, rgba(30, 64, 175, 0.4), transparent 55%),
                linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #0f172a;
        }

        .auth-orb {
            position: absolute;
            border-radius: 999px;
            filter: blur(40px);
            opacity: 0.75;
            pointer-events: none;
            animation: authOrbFloat 12s ease-in-out infinite;
        }

        .auth-orb--1 {
            width: 340px;
            height: 340px;
            top: -80px;
            left: -40px;
            background: radial-gradient(circle, rgba(248, 250, 252, 0.9), rgba(148, 163, 184, 0.1));
            animation-delay: -2s;
        }

        .auth-orb--2 {
            width: 260px;
            height: 260px;
            bottom: -40px;
            right: 12%;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.85), rgba(37, 99, 235, 0.1));
            animation-delay: -4s;
        }

        .auth-orb--3 {
            width: 220px;
            height: 220px;
            top: 18%;
            right: -60px;
            background: radial-gradient(circle, rgba(249, 115, 22, 0.85), rgba(126, 34, 206, 0.15));
            animation-delay: -6s;
        }

        @keyframes authOrbFloat {
            0%, 100% { transform: translate3d(0, 0, 0); }
            33% { transform: translate3d(18px, -10px, 0); }
            66% { transform: translate3d(-14px, 12px, 0); }
        }

        .auth-shell {
            position: relative;
            width: 100%;
            max-width: 1120px;
            min-height: 540px;
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
            gap: 32px;
            z-index: 1;
        }

        .auth-panel {
            position: relative;
            border-radius: 28px;
            backdrop-filter: blur(26px);
            -webkit-backdrop-filter: blur(26px);
        }

        .auth-panel--left {
            padding: 32px;
            background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.96), rgba(241, 245, 249, 0.94));
            box-shadow:
                0 24px 60px rgba(15, 23, 42, 0.30),
                0 0 0 1px rgba(226, 232, 240, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .auth-panel--right {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-brand {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 24px;
        }

        .auth-brand-text {
            flex: 1;
        }

        .auth-logo {
            width: 100px;
            height: 100px;
            margin-left: -12px;
            display: block;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            padding: 14px;
            object-fit: contain;
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(15, 23, 42, 0.12);
        }

        .auth-logo[alt] {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            text-align: center;
            color: #4b5563;
        }

        .auth-brand-parent {
            font-size: 14px;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 600;
        }

        .auth-brand-product {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.04em;
            color: #111827;
        }

        .auth-brand-org {
            margin-top: 4px;
            font-size: 14px;
            color: #4b5563;
        }

        .auth-title {
            margin: 24px 0 6px;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: #111827;
        }

        .auth-subtitle {
            margin: 0 0 18px;
            font-size: 14px;
            color: #4b5563;
            max-width: 420px;
        }

        .auth-bullets {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .auth-bullets li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 14px;
            color: #111827;
            margin-bottom: 12px;
        }

        .auth-bullets li::before {
            content: '‚Ä¢';
            color: #4f46e5;
            font-weight: 700;
            margin-top: 1px;
        }

        .auth-footnote {
            margin-top: 24px;
            padding-top: 18px;
            border-top: 1px solid rgba(209, 213, 219, 0.9);
        }

        .auth-footnote-main {
            font-size: 13px;
            color: #374151;
            margin: 0 0 4px;
        }

        .auth-footnote-sub {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }

        .auth-card {
            width: 100%;
            max-width: 420px;
            padding: 28px 26px;
            border-radius: 24px;
            background: rgba(248, 250, 252, 0.98);
            box-shadow:
                0 20px 45px rgba(15, 23, 42, 0.40),
                0 0 0 1px rgba(226, 232, 240, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .auth-card-header h2 {
            margin: 0 0 6px;
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .auth-card-header p {
            margin: 0;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .auth-form {
            margin-top: 20px;
        }

        .auth-alert {
            display: none;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(254, 215, 215, 0.8);
            color: #9b2c2c;
            border: 1px solid rgba(252, 165, 165, 0.8);
            font-size: 13px;
            margin-bottom: 16px;
        }

        .auth-field {
            margin-bottom: 16px;
        }

        .auth-field label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .auth-field input {
            width: 100%;
            padding: 11px 12px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            background: #ffffff;
            color: #111827;
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
        }

        .auth-field input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.16);
        }

        .auth-form-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin: 2px 0 18px;
        }

        .auth-remember {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #4b5563;
        }

        .auth-remember input {
            width: 16px;
            height: 16px;
            accent-color: #4f46e5;
        }

        .auth-link {
            border: none;
            background: none;
            padding: 0;
            font-size: 12px;
            color: #4f46e5;
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-submit-btn {
            width: 100%;
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #f9fafb;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 12px 30px rgba(79, 70, 229, 0.40);
            transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
        }

        .auth-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 40px rgba(79, 70, 229, 0.50);
            filter: brightness(1.03);
        }

        .auth-submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 10px 24px rgba(79, 70, 229, 0.35);
        }

        .auth-small-print {
            font-size: 11px;
            color: #6b7280;
            line-height: 1.45;
            margin: 0 0 12px;
        }

        .auth-support {
            margin-top: 14px;
            padding-top: 12px;
            border-top: 1px dashed rgba(209, 213, 219, 0.9);
        }

        .auth-support-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .auth-support p {
            margin: 0;
            font-size: 12px;
            color: #6b7280;
            line-height: 1.6;
        }

        @media (max-width: 960px) {
            .auth-shell {
                grid-template-columns: minmax(0, 1fr);
                max-width: 560px;
                gap: 20px;
            }

            .auth-panel--left {
                padding: 26px 24px;
                border-radius: 24px;
            }

            .auth-panel--right {
                justify-content: stretch;
            }

            .auth-card {
                margin: 0 auto;
            }
        }

        @media (max-width: 640px) {
            .auth-screen {
                padding: 18px;
            }

            .auth-panel--left {
                padding: 22px 20px;
                border-radius: 22px;
            }

            .auth-card {
                border-radius: 20px;
                padding: 22px 20px;
            }

            .auth-brand-product {
                font-size: 26px;
            }

            .auth-title {
                font-size: 22px;
            }

            .auth-form-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .auth-link {
                align-self: flex-start;
            }
        }

</style>
    <style>
        .programs-docs-loader,
        .programs-docs-error {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(110, 123, 255, 0.2);
            background: rgba(233, 236, 255, 0.55);
            color: #151633;
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .programs-docs-loader .loader-spinner {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid rgba(110, 123, 255, 0.3);
            border-top-color: #6E7BFF;
            animation: programsDocsSpin 0.9s linear infinite;
        }

        .programs-docs-error {
            flex-direction: column;
            align-items: flex-start;
            background: rgba(255, 245, 245, 0.85);
            border: 1px solid rgba(221, 72, 72, 0.35);
        }

        .programs-docs-error h3 {
            margin: 0;
            font-size: 16px;
            color: #b42318;
        }

        .programs-docs-error p {
            margin: 4px 0 12px 0;
            color: #7a271a;
            font-size: 14px;
        }

        .programs-docs-error-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        body.programs-docs-v2-active {
            overflow-x: hidden;
        }
        
        body.programs-docs-v2-active #mainApp {
            padding: 0 !important;
        }
        
        .programs-docs-container {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - var(--programs-header-height, 180px));
            position: relative;
            overflow: visible;
        }
        
        /* Ensure Programs tab takes full space */
        #programsTab.tab-content {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - var(--programs-header-height, 180px));
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        
        #programsTab.tab-content.active {
            display: flex !important;
        }
        
        /* Hide legacy elements when module is loaded */
        body.programs-docs-v2-active .legacy-programs-wrapper,
        body.programs-docs-v2-active #programsDocsError,
        body.programs-docs-v2-active #programsDocsLoader {
            display: none !important;
        }
        
        /* Make sure the module content fills the container */
        .programs-docs-container > * {
            width: 100%;
            height: 100%;
        }
        
        /* When module is loaded, ensure its root elements take full space */
        body.programs-docs-v2-active #programsDocsContainer,
        body.programs-docs-v2-active #programsDocsContainer > body,
        body.programs-docs-v2-active #programsDocsContainer > html {
            width: 100% !important;
            height: 100% !important;
            min-height: calc(100vh - var(--programs-header-height, 180px)) !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Ensure the module's workspace takes full space */
        body.programs-docs-v2-active .workspace,
        body.programs-docs-v2-active .three-pane-layout,
        body.programs-docs-v2-active [class*="workspace"] {
            width: 100% !important;
            height: 100% !important;
            min-height: calc(100vh - var(--programs-header-height, 180px)) !important;
        }
        
        /* Remove any max-width constraints */
        body.programs-docs-v2-active #programsDocsContainer * {
            max-width: none !important;
        }
        
        /* Ensure tab content area doesn't constrain */
        body.programs-docs-v2-active #programsTab {
            max-width: 100% !important;
            overflow: visible !important;
        }
        
        /* Stretch the outer container to full viewport */
        body.programs-docs-v2-active .container {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: clamp(16px, 2.5vw, 44px) clamp(16px, 2.5vw, 56px) !important;
            border-radius: 0 !important;
            min-height: 100vh !important;
            box-shadow: none !important;
            background: transparent !important;
        }
        
        /* Apply purple gradient background to html and body when Programs & Docs is active */
        html.programs-docs-v2-active,
        body.programs-docs-v2-active {
            position: relative !important;
            background:
                radial-gradient(circle at 12% 18%, rgba(203, 207, 255, 0.35), transparent 45%),
                radial-gradient(circle at 88% 8%, rgba(110, 123, 255, 0.22), transparent 52%),
                linear-gradient(145deg, #ffffff 0%, #F3F4FF 100%) !important;
            min-height: 100vh !important;
        }
        
        html.programs-docs-v2-active::before,
        body.programs-docs-v2-active::before {
            content: "" !important;
            position: fixed !important;
            inset: 0 !important;
            pointer-events: none !important;
            background: radial-gradient(circle at 20% 70%, rgba(110, 123, 255, 0.08), transparent 60%) !important;
            z-index: -1 !important;
        }
        
        /* Ensure #mainApp is transparent */
        body.programs-docs-v2-active #mainApp {
            padding: 0 !important;
            background: transparent !important;
        }
        
        body.programs-docs-v2-active .main-content {
            max-width: 100% !important;
            border-radius: 24px !important;
        }
        
        body.programs-docs-v2-active .main-content {
            padding: clamp(16px, 2vw, 36px) !important;
            grid-template-columns: 1fr !important; /* Override grid layout */
            background: transparent !important;
        }
        
        /* Override module's fixed layout */
        body.programs-docs-v2-active .app-shell {
            max-width: 100% !important;
            width: 100% !important;
            margin: 0 !important;
            padding-left: clamp(16px, 2vw, 32px) !important;
            padding-right: clamp(16px, 2vw, 32px) !important;
            padding-top: 32px !important;
            padding-bottom: 80px !important;
            grid-template-columns: minmax(200px, 1fr) minmax(400px, 3fr) minmax(250px, 1fr) !important;
            gap: clamp(16px, 2vw, 24px) !important;
        }
        
        /* Make panes responsive and semi-transparent to show gradient */
        body.programs-docs-v2-active .pane {
            width: 100% !important;
            box-sizing: border-box !important;
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        /* Dynamic height calculation */
        body.programs-docs-v2-active #programsDocsContainer {
            height: calc(100vh - var(--programs-header-height, 180px)) !important;
        }
        
        /* Ultra-wide screens (>2000px) */
        @media (min-width: 2000px) {
            body.programs-docs-v2-active .app-shell {
                grid-template-columns: minmax(300px, 0.18fr) minmax(600px, 1fr) minmax(350px, 0.22fr) !important;
                padding-left: 3vw !important;
                padding-right: 3vw !important;
            }
        }
        
        /* Standard desktop (1400px - 2000px) */
        @media (min-width: 1400px) and (max-width: 2000px) {
            body.programs-docs-v2-active .app-shell {
                grid-template-columns: minmax(260px, 0.2fr) minmax(500px, 1fr) minmax(320px, 0.24fr) !important;
            }
        }
        
        /* Tablet/small desktop (<1400px) */
        @media (max-width: 1400px) {
            body.programs-docs-v2-active .app-shell {
                grid-template-columns: minmax(240px, 0.22fr) minmax(400px, 1fr) minmax(280px, 0.26fr) !important;
            }
        }
        
        /* Remove fixed padding from body and containers */
        body.programs-docs-v2-active {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Override programs panel constraints */
        body.programs-docs-v2-active .programs-panel {
            max-width: 100% !important;
            width: 100% !important;
        }
        
        /* Ensure selection panel doesn't interfere */
        body.programs-docs-v2-active .selection-panel {
            display: none !important;
        }
        
        body.programs-docs-v2-active .app-footer {
            max-width: 100% !important;
            margin: 0 !important;
            padding-left: 2vw !important;
            padding-right: 2vw !important;
        }
        
        /* Ensure toolbar stretches full width and reduce height significantly */
        body.programs-docs-v2-active .toolbar {
            width: 100% !important;
            max-width: 100% !important;
            left: 0 !important;
            right: 0 !important;
            margin: 0 !important;
            padding: 8px clamp(16px, 2vw, 28px) !important;
            min-height: auto !important;
            height: auto !important;
        }
        
        /* Reduce toolbar brand icon size */
        body.programs-docs-v2-active .toolbar__brand span {
            width: 28px !important;
            height: 28px !important;
            font-size: 0.75rem !important;
        }
        
        /* Reduce toolbar brand text size */
        body.programs-docs-v2-active .toolbar__brand {
            font-size: 0.85rem !important;
            gap: 8px !important;
        }
        
        /* Reduce search bar height */
        body.programs-docs-v2-active .toolbar__search label {
            padding: 6px 14px !important;
            min-height: auto !important;
        }
        
        /* Reduce search input size */
        body.programs-docs-v2-active .toolbar__search input {
            font-size: 0.875rem !important;
            padding: 0 !important;
        }
        
        /* Reduce toolbar action buttons */
        body.programs-docs-v2-active .toolbar__actions {
            gap: 8px !important;
        }
        
        body.programs-docs-v2-active .toolbar__document-toggle-btn,
        body.programs-docs-v2-active .toolbar__actions button {
            padding: 6px 12px !important;
            font-size: 0.8rem !important;
            min-height: auto !important;
            height: auto !important;
        }

        .legacy-programs-wrapper {
            margin-top: 24px;
        }

        .legacy-programs-notice {
            padding: 20px;
            border: 1px dashed rgba(110, 123, 255, 0.35);
            border-radius: 16px;
            background: white;
            color: #48508A;
        }

        .legacy-programs-notice h4 {
            margin: 0 0 8px 0;
            color: #0F1020;
            font-size: 16px;
        }

        .legacy-programs-notice p {
            margin: 0;
            font-size: 14px;
        }

        .legacy-programs-fallback {
            margin-top: 16px;
            border: 1px solid rgba(110, 123, 255, 0.18);
            border-radius: 18px;
            background: rgba(233, 236, 255, 0.25);
            box-shadow: 0 12px 32px rgba(15, 16, 32, 0.08);
            overflow: hidden;
        }

        .legacy-programs-frame {
            width: 100%;
            min-height: 720px;
            border: 0;
            background: white;
        }

        .legacy-programs-disclaimer {
            margin: 0;
            padding: 12px 18px 16px;
            font-size: 13px;
            color: #48508A;
            background: rgba(233, 236, 255, 0.65);
            border-top: 1px solid rgba(110, 123, 255, 0.18);
        }

        body.programs-docs-v2-active .selection-panel {
            display: none !important;
        }

        @keyframes programsDocsSpin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- Client Tracking JavaScript -->
    <script>
        // CM Tracker Functions
        let currentHouseId = 'house_nest';
        let currentClientFilter = 'active';
        let cmTrackerInitialized = false;
        
        // Initialize CM Tracker
        async function initializeCMTracker() {
            try {
                // Check if managers are available
                if (!window.dbManager) {
                    console.error('DBManager not available for CM Tracker');
                    return;
                }
                
                // Initialize houses manager
                if (!window.housesManager) {
                    window.housesManager = new HousesManager(window.dbManager);
                    await window.housesManager.initialize();
                }
                housesManager = window.housesManager;
                
                // Initialize milestones manager
                if (!window.milestonesManager) {
                    window.milestonesManager = new MilestonesManager(window.dbManager);
                }
                milestonesManager = window.milestonesManager;
                
                // Initialize aftercare manager
                if (!window.aftercareManager) {
                    window.aftercareManager = new AftercareManager(window.dbManager);
                }
                aftercareManager = window.aftercareManager;
                
                // Initialize houses in database
                await window.dbManager.initializeHouses();
                
                // Build house navigation
                await buildHouseNavigation();
                
                // Load initial house
                await loadHouseView(currentHouseId);
                
                cmTrackerInitialized = true;
                console.log('‚úÖ CM Tracker initialized');
            } catch (error) {
                console.error('Failed to initialize CM Tracker:', error);
            }
        }
        
        // Build house navigation tabs
        async function buildHouseNavigation() {
            const houseTabs = document.getElementById('houseTabs');
            if (!houseTabs) return;
            
            houseTabs.innerHTML = '';
            
            // Get houses
            const houses = await housesManager.getActiveHouses();
            
            // Create tabs for each house
            for (let i = 0; i < houses.length; i++) {
                const house = houses[i];
                const clientCount = await housesManager.getClientCount(house.id, true);
                
                const tab = document.createElement('button');
                tab.className = 'house-tab';
                if (i === 0) tab.className += ' active'; // First house is active by default
                tab.id = `houseTab_${house.id}`;
                tab.onclick = () => switchToHouse(house.id);
                
                tab.innerHTML = `
                    ${house.name}
                    <span class="client-count">${clientCount}</span>
                `;
                
                houseTabs.appendChild(tab);
            }
            
            // Add discharged clients tab
            const dischargedCount = await getDischargedClientsCount();
            const dischargedTab = document.createElement('button');
            dischargedTab.className = 'house-tab';
            dischargedTab.id = 'houseTab_discharged';
            dischargedTab.onclick = () => switchToHouse('discharged');
            dischargedTab.innerHTML = `
                Discharged
                <span class="client-count">${dischargedCount}</span>
            `;
            houseTabs.appendChild(dischargedTab);
        }
        
        // Get discharged clients count
        async function getDischargedClientsCount() {
            if (!window.clientManager) return 0;
            const discharged = await window.clientManager.getDischargedClients();
            return discharged.length;
        }
        
        // Switch to a house
        async function switchToHouse(houseId) {
            currentHouseId = houseId;
            
            // Update active tab
            document.querySelectorAll('.house-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.getElementById(`houseTab_${houseId}`);
            if (activeTab) activeTab.classList.add('active');
            
            // Load house view
            await loadHouseView(houseId);
        }
        
        // Load house view
        async function loadHouseView(houseId) {
            const container = document.getElementById('houseClientsList');
            if (!container) return;
            
            try {
                let clients;
                let houseName;
                
                if (houseId === 'discharged') {
                    clients = await window.clientManager.getDischargedClients();
                    houseName = 'Discharged Clients';
                } else {
                    const house = housesManager.getHouseById(houseId);
                    if (!house) return;
                    houseName = house.name;
                    clients = await window.clientManager.getClientsByHouse(houseId, currentClientFilter === 'active');
                }
                
                if (clients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üè†</div>
                            <div class="empty-state-title">No clients in ${houseName}</div>
                            <div class="empty-state-text">Click "Add Client" to add a new client to this house</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = await buildClientsTable(clients, houseName);
                }
            } catch (error) {
                console.error('Failed to load house view:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Error loading clients</div>
                        <div class="empty-state-text">${error.message}</div>
                    </div>
                `;
            }
        }
        
        // Build clients table
        async function buildClientsTable(clients, houseName) {
            const table = document.createElement('div');
            table.className = 'clients-table-container';
            
            // Add export controls
            let tableHTML = `
                <div class="table-controls" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 14px; color: #6b7280;">
                        Showing ${clients.length} client${clients.length !== 1 ? 's' : ''} in ${houseName}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportCurrentView()" class="export-btn" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                            üìÑ Export to CSV
                        </button>
                        <button onclick="exportAllData()" class="export-btn" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                            üìä Export All Houses
                        </button>
                    </div>
                </div>
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Kipu ID</th>
                            <th>Days</th>
                            <th>Coach</th>
                            <th>CM</th>
                            <th>Thread</th>
                            <th>Options</th>
                            <th>Packet</th>
                            <th>Aftercare</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const client of clients) {
                const daysInCare = window.clientManager.calculateDaysInCare(client);
                
                // Apply CSS class based on days in care
                let daysClass = '';
                if (daysInCare === 13) {
                    daysClass = 'days-13';
                } else if (daysInCare === 14) {
                    daysClass = 'days-14';
                } else if (daysInCare >= 16) {
                    daysClass = 'days-16plus';
                }
                
                // Get milestones
                let milestones = [];
                try {
                    milestones = await milestonesManager.getClientMilestones(client.id);
                } catch (e) {
                    // Client may not have milestones initialized yet
                }
                
                // Get specific milestone statuses
                const threadMilestone = milestones.find(m => m.milestone === 'aftercare_thread');
                const optionsMilestone = milestones.find(m => m.milestone === 'options_doc');
                const packetMilestone = milestones.find(m => m.milestone === 'discharge_packet');
                
                const threadDisplay = threadMilestone 
                    ? milestonesManager.getMilestoneDisplayStatus(threadMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                    
                const optionsDisplay = optionsMilestone
                    ? milestonesManager.getMilestoneDisplayStatus(optionsMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                    
                const packetDisplay = packetMilestone
                    ? milestonesManager.getMilestoneDisplayStatus(packetMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                
                // Get aftercare options
                let aftercareOptions = [];
                let aftercareDisplay = 'No options';
                try {
                    aftercareOptions = await aftercareManager.getClientAftercareOptions(client.id);
                    if (aftercareOptions.length > 0) {
                        const summary = aftercareManager.getAftercareSummary(aftercareOptions);
                        aftercareDisplay = summary.displayString;
                    }
                } catch (e) {
                    // Client may not have aftercare options yet
                }
                
                tableHTML += `
                    <tr>
                        <td><span class="client-initials" onclick="viewClientDetails('${client.id}')">${client.initials}</span></td>
                        <td>${client.kipuId}</td>
                        <td class="days-in-care ${daysClass}">${daysInCare}</td>
                        <td class="team-member">${client.clinicalCoachInitials || '-'}</td>
                        <td class="team-member">${client.caseManagerInitials || '-'}</td>
                        <td>
                            <span class="milestone-indicator ${threadDisplay.class}" 
                                  title="${threadDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'aftercare_thread')">
                                ${threadDisplay.icon}
                            </span>
                        </td>
                        <td>
                            <span class="milestone-indicator ${optionsDisplay.class}" 
                                  title="${optionsDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'options_doc')">
                                ${optionsDisplay.icon}
                            </span>
                        </td>
                        <td>
                            <span class="milestone-indicator ${packetDisplay.class}" 
                                  title="${packetDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'discharge_packet')">
                                ${packetDisplay.icon}
                            </span>
                        </td>
                        <td><span class="aftercare-status" style="font-size: 12px;">${aftercareDisplay}</span></td>
                        <td class="action-buttons">
                            <button class="action-btn" onclick="viewClientDetails('${client.id}')">View</button>
                            <button class="action-btn" onclick="editClient('${client.id}')">Edit</button>
                            <button class="action-btn" onclick="generateClientDocument('${client.id}')">Doc</button>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            return tableHTML;
        }
        
        // Export current view to CSV
        async function exportCurrentView() {
            try {
                // Load export module if not already loaded
                if (!window.CMTrackerExport) {
                    const script = document.createElement('script');
                    script.src = 'cm-tracker-export.js';
                    document.head.appendChild(script);
                    
                    // Wait for script to load
                    await new Promise(resolve => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000); // Timeout fallback
                    });
                }
                
                // Initialize export module if not loaded
                if (!window.cmTrackerExport) {
                    window.cmTrackerExport = new CMTrackerExport();
                }
                
                // Export current house
                const options = {
                    houseId: currentHouseId === 'discharged' ? null : currentHouseId,
                    includeArchived: currentHouseId === 'discharged'
                };
                
                const result = await window.cmTrackerExport.exportToCSV(options);
                
                if (result.success) {
                    showAlert(`Exported ${result.rowCount - 1} clients successfully`, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                showAlert('Failed to export data: ' + error.message, 'error');
            }
        }
        
        // Export all data to CSV
        async function exportAllData() {
            try {
                // Load export module if not already loaded
                if (!window.CMTrackerExport) {
                    const script = document.createElement('script');
                    script.src = 'cm-tracker-export.js';
                    document.head.appendChild(script);
                    
                    // Wait for script to load
                    await new Promise(resolve => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000); // Timeout fallback
                    });
                }
                
                // Initialize export module if not loaded
                if (!window.cmTrackerExport) {
                    window.cmTrackerExport = new CMTrackerExport();
                }
                
                // Export all houses
                const result = await window.cmTrackerExport.exportToCSV({
                    includeArchived: true
                });
                
                if (result.success) {
                    showAlert(`Exported ${result.rowCount - 1} clients successfully`, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                showAlert('Failed to export data: ' + error.message, 'error');
            }
        }
        
        // Ensure tab navigation is visible
        function ensureTabNavigationVisible() {
            return; // Disabled - using drawer navigation instead
            const tabNav = document.querySelector('.tab-navigation');
            if (!tabNav) {
                // Tab navigation doesn't exist, create it
                const programsPanel = document.querySelector('.programs-panel');
                if (programsPanel) {
                    const tabNavHTML = `
                        <div class="tab-navigation">
                            <button class="tab-btn" data-tab-target="dashboard" onclick="window.switchTab && window.switchTab('dashboard')">
                                <span>üéØ Dashboard</span>
                            </button>
                            <button class="tab-btn active" data-tab-target="programs" onclick="window.switchTab && window.switchTab('programs')">
                                <span>üìë Programs &amp; Docs</span>
                            </button>
                            <button class="tab-btn" data-tab-target="clients" onclick="window.switchTab && window.switchTab('clients')">
                                <span>üë• Clients</span>
                            </button>
                        </div>
                    `;
                    // Insert at the beginning of programs-panel
                    programsPanel.insertAdjacentHTML('afterbegin', tabNavHTML);
                    document.body.classList.add('tab-nav-fallback');
                    console.log('‚úÖ Tab navigation created dynamically');
                }
            } else {
                // Ensure fallback visibility is enabled
                document.body.classList.add('tab-nav-fallback');
                tabNav.style.display = '';
                tabNav.style.visibility = '';
                tabNav.style.zIndex = '';
                tabNav.style.position = '';
                console.log('‚úÖ Tab navigation fallback activated');
            }
        }
        
        // Initialize Client Tracker (for backward compatibility)
        function initializeClientTracker() {
            // Ensure tab navigation is visible first
            ensureTabNavigationVisible();
            
            // Initialize CM Tracker when client tab is opened
            if (!cmTrackerInitialized) {
                initializeCMTracker();
            }
        }
        
        // Manual initialization function
        async function initializeClientManagerManually() {
            try {
                console.log('Attempting manual ClientManager initialization...');
                
                // Check if dbManager exists, if not create it
                if (!window.dbManager) {
                    console.log('Creating IndexedDBManager...');
                    window.dbManager = new IndexedDBManager();
                    await window.dbManager.init();
                }
                
                // Create ClientManager
                console.log('Creating ClientManager...');
                window.clientManager = new ClientManager(window.dbManager);
                await window.clientManager.initialize();
                
                console.log('‚úÖ ClientManager manually initialized:', window.clientManager);
                
                // Initialize the UI
                initializeClientTracker();
                
                // Hide the warning
                const statusDiv = document.getElementById('clientManagerStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
                
                showAlert('Client manager initialized successfully!', 'success');
            } catch (error) {
                console.error('Failed to manually initialize ClientManager:', error);
                showAlert('Failed to initialize client manager: ' + error.message, 'error');
            }
        }
        
        // Handle client manager events
        function handleClientEvent(event, data) {
            switch (event) {
                case 'current-client-changed':
                    updateCurrentClientDisplay();
                    refreshSelectedPrograms();
                    break;
                case 'client-created':
                case 'client-updated':
                    refreshClientsList();
                    if (data.id === clientManager.getCurrentClient()?.id) {
                        updateCurrentClientDisplay();
                    }
                    break;
            }
        }
        
        // Module path - the module file is copied to dist as programs-docs-module.html during build
        // When served from dist/, use the same directory; when from root, use dist/ prefix
        const PROGRAMS_DOCS_MODULE_PATH = (() => {
            const pathname = (window.location.pathname || '').toLowerCase();
            const fileName = pathname.split('/').pop() || '';

            // If served from any packaged bundle (dist, CURRENT-VERSION-v12, etc.), keep module in same directory
            if (
                fileName.startsWith('careconnect-pro') ||
                pathname.includes('/dist/') ||
                pathname.includes('/current-version-v12/')
            ) {
                return 'programs-docs-module.html';
            }

            // Legacy fallback ‚Äì assume module lives under dist/
            return 'dist/programs-docs-module.html';
        })();
        let programsDocsLegacyNoticeShown = false;

        function shouldUseProgramsDocs() {
            try {
                if (window.featureFlags && typeof window.featureFlags.isEnabled === 'function') {
                    return window.featureFlags.isEnabled('programsV2Core') !== false;
                }
            } catch (error) {
                console.warn('Programs & Docs feature flag unavailable:', error);
            }
            // Default to true if feature flags not available
            return true;
        }
        
        // Make function globally available immediately
        window.shouldUseProgramsDocs = shouldUseProgramsDocs;

        async function mountProgramsDocsModule(forceReload = false) {
            const container = document.getElementById('programsDocsContainer');
            const loader = document.getElementById('programsDocsLoader');
            const errorEl = document.getElementById('programsDocsError');

            if (!container || !loader) {
                console.warn('Programs & Docs container missing from shell.');
                return false;
            }

            if (!shouldUseProgramsDocs()) {
                revealLegacyProgramsNotice('feature-disabled');
                return false;
            }

            if (window.__programsDocsMountPromise && !forceReload) {
                return window.__programsDocsMountPromise;
            }

            loader.hidden = false;
            if (errorEl) {
                errorEl.hidden = true;
            }
            container.hidden = true;

            const fetchUrl = forceReload
                ? `${PROGRAMS_DOCS_MODULE_PATH}?cacheBust=${Date.now()}`
                : PROGRAMS_DOCS_MODULE_PATH;

            console.log('[Programs & Docs] Loading module from:', fetchUrl);
            console.log('[Programs & Docs] Current pathname:', window.location.pathname);

            const mountPromise = (async () => {
                try {
                    let response = await fetch(fetchUrl, { cache: 'no-store' });
                    if (!response.ok) {
                        // Fallback: if root-level path fails with 404, try CURRENT-VERSION-v12/ prefix
                        const is404 = response.status === 404;
                        const isRootPath = !window.location.pathname.toLowerCase().includes('/current-version-v12/');
                        const isSimpleModulePath = PROGRAMS_DOCS_MODULE_PATH === 'programs-docs-module.html';
                        
                        if (is404 && isRootPath && isSimpleModulePath) {
                            const fallbackUrl = `CURRENT-VERSION-v12/programs-docs-module.html${forceReload ? `?cacheBust=${Date.now()}` : ''}`;
                            console.warn('[Programs & Docs] Primary module path not found, trying fallback:', fallbackUrl);
                            response = await fetch(fallbackUrl, { cache: 'no-store' });
                        }

                        if (!response.ok) {
                            if (response.status === 404) {
                                throw new Error(`Module not found at ${fetchUrl}. Please check the file path.`);
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                    }

                    const htmlText = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');

                    // Inject styles once
                    doc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                        const href = link.getAttribute('href');
                        if (!href) return;
                        if (document.querySelector(`link[data-programs-docs-style="true"][href="${href}"]`)) {
                            return;
                        }
                        const clone = link.cloneNode(true);
                        clone.dataset.programsDocsStyle = 'true';
                        document.head.appendChild(clone);
                    });

                    window.__programsDocsInlineStyles = window.__programsDocsInlineStyles || new Set();
                    doc.querySelectorAll('style').forEach(styleTag => {
                        const cssText = styleTag.textContent || '';
                        if (window.__programsDocsInlineStyles.has(cssText)) {
                            return;
                        }
                        const clone = styleTag.cloneNode(true);
                        clone.dataset.programsDocsStyle = 'true';
                        clone.dataset.programsDocsInline = 'true';
                        window.__programsDocsInlineStyles.add(cssText);
                        document.head.appendChild(clone);
                    });

                    container.innerHTML = doc.body.innerHTML;
                    container.hidden = false;
                    loader.hidden = true;
                    if (errorEl) {
                        errorEl.hidden = true;
                    }
                    document.body.classList.add('programs-docs-v2-active');
                    document.documentElement.classList.add('programs-docs-v2-active');
                    requestAnimationFrame(() => {
                        const toolbar = container.querySelector('.toolbar');
                        if (toolbar) {
                            const toolbarHeight = Math.round(toolbar.getBoundingClientRect().height);
                            document.documentElement.style.setProperty('--programs-header-height', `${toolbarHeight}px`);
                        }
                    });
                    
                    // Apply inline styles to override parent containers
                    const applyFullViewportStyles = () => {
                        // Apply clean white/gray background for modern look
                        // The purple gradient (legacy) has been removed as requested
                        const cleanBg = '#f8f9fa'; // Standard dashboard background
                        
                        document.documentElement.style.background = cleanBg;
                        document.documentElement.style.minHeight = '100vh';
                        document.body.style.background = cleanBg;
                        document.body.style.minHeight = '100vh';
                        
                        // Override .container
                        const outerContainer = document.querySelector('.container');
                        if (outerContainer) {
                            outerContainer.style.width = '100%';
                            outerContainer.style.maxWidth = '100%';
                            outerContainer.style.margin = '0';
                            outerContainer.style.padding = 'clamp(16px, 2.5vw, 44px) clamp(16px, 2.5vw, 56px)';
                            outerContainer.style.borderRadius = '0';
                            outerContainer.style.minHeight = '100vh';
                            outerContainer.style.boxShadow = 'none';
                            outerContainer.style.background = 'transparent';
                        }
                        
                        // Override .main-content - make it transparent
                        const mainContent = document.querySelector('.main-content');
                        if (mainContent) {
                            mainContent.style.gridTemplateColumns = '1fr';
                            mainContent.style.maxWidth = '100%';
                            mainContent.style.padding = 'clamp(16px, 2vw, 36px)';
                            mainContent.style.background = 'transparent';
                        }
                        
                        // Override #mainApp - make it transparent
                        const mainApp = document.getElementById('mainApp');
                        if (mainApp) {
                            mainApp.style.padding = '0';
                            mainApp.style.width = '100%';
                            mainApp.style.maxWidth = '100%';
                            mainApp.style.background = 'transparent';
                        }
                        
                        // Hide selection panel
                        const selectionPanel = document.querySelector('.selection-panel');
                        if (selectionPanel) {
                            selectionPanel.style.display = 'none';
                        }
                        
                        // Override programs panel
                        const programsPanel = document.querySelector('.programs-panel');
                        if (programsPanel) {
                            programsPanel.style.maxWidth = '100%';
                            programsPanel.style.width = '100%';
                        }
                        
                        // Override module's app-shell
                        const appShell = container.querySelector('.app-shell');
                        if (appShell) {
                            appShell.style.width = '100%';
                            appShell.style.maxWidth = '100%';
                            appShell.style.margin = '0';
                            appShell.style.paddingLeft = 'clamp(16px, 2vw, 32px)';
                            appShell.style.paddingRight = 'clamp(16px, 2vw, 32px)';
                        }
                        
                        // Make panes semi-transparent to show gradient
                        const panes = container.querySelectorAll('.pane');
                        panes.forEach(pane => {
                            pane.style.background = 'rgba(255, 255, 255, 0.85)';
                            pane.style.backdropFilter = 'blur(10px)';
                        });
                    };
                    
                    // Apply styles immediately
                    applyFullViewportStyles();
                    
                    // Ensure container takes full space
                    container.style.width = '100%';
                    container.style.height = '100%';
                    container.style.minHeight = 'calc(100vh - 200px)';
                    container.style.display = 'block';
                    
                    // Hide legacy wrapper if it exists
                    const legacyWrapper = document.getElementById('legacyProgramsWrapper');
                    if (legacyWrapper) {
                        legacyWrapper.hidden = true;
                        legacyWrapper.style.display = 'none';
                    }
                    
                    const adjustProgramsDocsLayout = () => {
                        // Re-apply full viewport styles
                        applyFullViewportStyles();
                        
                        const nav = document.querySelector('.tab-navigation');
                        let headerHeight = container.getBoundingClientRect().top;
                        if (headerHeight <= 0 && nav) {
                            headerHeight = nav.getBoundingClientRect().bottom;
                        }
                        if (!Number.isFinite(headerHeight) || headerHeight <= 0) {
                            headerHeight = 150;
                        }
                        headerHeight = Math.max(120, Math.round(headerHeight));
                        document.documentElement.style.setProperty('--programs-header-height', `${headerHeight}px`);
                        
                        const targetHeight = `calc(100vh - ${headerHeight}px)`;
                        container.style.height = targetHeight;
                        container.style.minHeight = targetHeight;
                        
                        const programsTab = document.getElementById('programsTab');
                        if (programsTab) {
                            programsTab.style.minHeight = targetHeight;
                        }
                        
                        const shell = container.querySelector('.app-shell');
                        if (shell) {
                            const viewportWidth = window.innerWidth;
                            if (viewportWidth > 1600) {
                                const scaleFactor = viewportWidth / 1600;
                                const gap = Math.min(56, Math.round(24 * scaleFactor));
                                shell.style.gap = `${gap}px`;
                            } else {
                                shell.style.removeProperty('gap');
                            }
                        }
                    };
                    
                    adjustProgramsDocsLayout();
                    
                    if (window.__programsDocsLayoutAdjuster) {
                        window.removeEventListener('resize', window.__programsDocsLayoutAdjuster);
                    }
                    window.__programsDocsLayoutAdjuster = () => adjustProgramsDocsLayout();
                    window.addEventListener('resize', window.__programsDocsLayoutAdjuster, { passive: true });
                    
                    if (window.__programsDocsResizeObserver instanceof ResizeObserver) {
                        window.__programsDocsResizeObserver.disconnect();
                    }
                    if (typeof ResizeObserver === 'function') {
                        window.__programsDocsResizeObserver = new ResizeObserver(() => adjustProgramsDocsLayout());
                        window.__programsDocsResizeObserver.observe(document.body);
                        window.__programsDocsResizeObserver.observe(container);
                    }

                    // Execute inline scripts sequentially
                    const scripts = Array.from(doc.querySelectorAll('script'));
                    for (const scriptNode of scripts) {
                        const scriptEl = document.createElement('script');
                        for (const attr of scriptNode.attributes) {
                            scriptEl.setAttribute(attr.name, attr.value);
                        }
                        if (scriptNode.src) {
                            scriptEl.src = scriptNode.src;
                        } else {
                            scriptEl.textContent = scriptNode.textContent;
                        }
                        scriptEl.dataset.programsDocsScript = 'true';
                        container.appendChild(scriptEl);

                        if (scriptEl.src) {
                            await new Promise((resolve, reject) => {
                                scriptEl.onload = resolve;
                                scriptEl.onerror = () => reject(new Error(`Failed to load ${scriptEl.src}`));
                            });
                        }
                    }

                    window.__programsDocsLoaded = true;
                    window.ccShell?.setSectionState?.('programs');
                    return true;
                } catch (error) {
                    console.error('Programs & Docs mount failure:', error);
                    console.error('Attempted to load from:', fetchUrl);
                    loader.hidden = true;
                    window.ccShell?.setSectionState?.('programs-error');
                    if (errorEl) {
                        errorEl.hidden = false;
                        const errorParagraph = errorEl.querySelector('p');
                        if (errorParagraph) {
                            const friendlyMessage = error.message.includes('404') || error.message.includes('not found')
                                ? 'Module file not found. Please ensure CareConnect-Pro.html is accessible.'
                                : `Failed to load module: ${error.message}`;
                            errorParagraph.textContent = friendlyMessage;
                        }
                    }
                    revealLegacyProgramsNotice('load-error');
                    // document.body.classList.remove('programs-docs-v2-active');
                    // document.documentElement.classList.remove('programs-docs-v2-active');
                    throw error;
                }
            })();

            window.__programsDocsMountPromise = mountPromise;
            return mountPromise;
        }
        // Make mount function globally available
        window.mountProgramsDocsModule = mountProgramsDocsModule;

        function retryProgramsDocsMount() {
            window.__programsDocsMountPromise = null;
            window.ccShell?.setSectionState?.('programs-loading');
            return mountProgramsDocsModule(true).catch(() => {});
        }
        
        // Make retry function globally available
        window.retryProgramsDocsMount = retryProgramsDocsMount;

        function toggleLegacyPrograms(show) {
            const wrapper = document.getElementById('legacyProgramsWrapper');
            if (!wrapper) return;
            if (show) {
                revealLegacyProgramsNotice('manual-request');
                initializeLegacyProgramsModule();
            } else {
                wrapper.hidden = true;
            }
        }

        function revealLegacyProgramsNotice(reason) {
            const wrapper = document.getElementById('legacyProgramsWrapper');
            const errorEl = document.getElementById('programsDocsError');
            if (!wrapper) return;

            if (!wrapper.dataset.rendered) {
                wrapper.innerHTML = `
                    <div class="legacy-programs-notice">
                        <h4>Legacy Programs experience</h4>
                        <p>The updated Programs &amp; Docs module is currently unavailable (${reason}). Disable the <code>programsV2Core</code> feature flag or contact support for assistance.</p>
                    </div>
                `;
                wrapper.dataset.rendered = 'true';
            }

            wrapper.hidden = false;
            if (errorEl) {
                errorEl.hidden = false;
            }
            programsDocsLegacyNoticeShown = true;
            // document.body.classList.remove('programs-docs-v2-active');
            // document.documentElement.classList.remove('programs-docs-v2-active');
            initializeLegacyProgramsModule();
        }

        // Legacy switchTab function removed - using the main one defined later in the file
        // This ensures all tab switching goes through the unified implementation
        
        // Quick add client
        async function quickAddClient() {
            // Check if clientManager is initialized
            if (!window.clientManager) {
                showAlert('Client manager is not ready. Please refresh the page.', 'error');
                console.error('ClientManager not initialized');
                return;
            }
            
            const initials = document.getElementById('newClientInitials').value.trim().toUpperCase();
            const kipuId = document.getElementById('newClientKipu').value.trim();
            
            if (!initials || !kipuId) {
                showAlert('Please enter both initials and Kipu ID', 'error');
                return;
            }
            
            try {
                const newClient = await window.clientManager.createClient({
                    initials,
                    kipuId
                });
                
                // Clear form
                document.getElementById('newClientInitials').value = '';
                document.getElementById('newClientKipu').value = '';
                
                // Set as current client
                await window.clientManager.setCurrentClient(newClient.id);
                
                showAlert(`Client ${initials} added successfully!`, 'success');
                refreshClientsList();
            } catch (error) {
                showAlert(error.message, 'error');
                console.error('Error creating client:', error);
            }
        }
        
        // Filter clients
        function filterClients(filter) {
            currentClientFilter = filter;
            
            // Update filter tabs
            document.querySelectorAll('.client-filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            refreshClientsList();
        }
        
        // Search clients
        let clientSearchTimeout;
        function searchClients(query) {
            clearTimeout(clientSearchTimeout);
            clientSearchTimeout = setTimeout(async () => {
                const results = await clientManager.searchClients(query);
                displayClients(results);
            }, 300);
        }
        
        // Refresh clients list - make globally available
        window.refreshClientsList = async function refreshClientsList() {
            // Check if old UI container exists (may not exist in CM Tracker view)
            const clientsContainer = document.getElementById('clientsList');
            if (!clientsContainer) {
                // Old UI doesn't exist, likely using CM Tracker
                return;
            }
            
            const allClients = await clientManager.getAllClients();
            let filteredClients = allClients;
            
            // Apply status filter
            if (currentClientFilter !== 'all') {
                filteredClients = allClients.filter(client => 
                    client.status === currentClientFilter
                );
            }
            
            // Apply search if active
            const searchBox = document.getElementById('clientSearchBox');
            if (searchBox) {
                const searchQuery = searchBox.value;
                if (searchQuery) {
                    const searchLower = searchQuery.toLowerCase();
                    filteredClients = filteredClients.filter(client => 
                        client.initials.toLowerCase().includes(searchLower) ||
                        client.kipuId.includes(searchQuery)
                    );
                }
            }
            
            displayClients(filteredClients);
        }
        
        // Display clients
        function displayClients(clients) {
            const container = document.getElementById('clientsList');
            
            // Check if old UI container exists (may not exist in CM Tracker view)
            if (!container) {
                // Old UI doesn't exist, likely using CM Tracker
                return;
            }
            
            if (!clients || clients.length === 0) {
                container.innerHTML = `
                    <div class="client-empty-state">
                        <div class="client-empty-icon">üë•</div>
                        <p>No clients found</p>
                    </div>
                `;
                return;
            }
            
            const currentClient = clientManager.getCurrentClient();
            
            container.innerHTML = clients.map(client => {
                const isSelected = currentClient?.id === client.id;
                const lastModified = new Date(client.lastModified).toLocaleDateString();
                const programCount = client.programHistory?.filter(p => p.status === 'selected').length || 0;
                
                return `
                    <div class="client-card ${isSelected ? 'selected' : ''}" 
                         onclick="selectClient('${client.id}')"
                         data-client-id="${client.id}">
                        <div class="client-card-avatar">${client.initials}</div>
                        <div class="client-card-info">
                            <div class="client-card-header">
                                <span class="client-card-name">${client.initials}</span>
                                <span class="client-status-badge ${client.status}">${client.status}</span>
                            </div>
                            <div class="client-card-kipu">Kipu ID: ${client.kipuId}</div>
                            <div class="client-card-meta">
                                <span>${programCount} programs</span>
                                <span>Modified: ${lastModified}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Select client
        async function selectClient(clientId) {
            await clientManager.setCurrentClient(clientId);
            refreshClientsList();
            updateCurrentClientDisplay();
            
            // If programs were selected for this client, restore them
            const clientPrograms = await clientManager.getClientPrograms(clientId);
            if (clientPrograms && clientPrograms.length > 0) {
                selectedPrograms = [...clientPrograms];
                updateSelectedPrograms();
                renderSelectedPrograms();
            }
        }
        
        // Update current client display
        function updateCurrentClientDisplay() {
            const client = clientManager.getCurrentClient();
            
            // Check if elements exist (may not exist in CM Tracker view)
            const avatarEl = document.getElementById('currentClientAvatar');
            const nameEl = document.getElementById('currentClientName');
            const kipuEl = document.getElementById('currentClientKipu');
            
            if (!avatarEl || !nameEl || !kipuEl) {
                // Old UI elements don't exist, likely using CM Tracker
                return;
            }
            
            if (!client) {
                avatarEl.textContent = '--';
                nameEl.textContent = 'No Client Selected';
                kipuEl.textContent = 'Select a client to begin';
                return;
            }
            
            avatarEl.textContent = client.initials;
            nameEl.textContent = `${client.initials} - ${client.status}`;
            kipuEl.textContent = `Kipu ID: ${client.kipuId}`;
        }
        
        // Edit current client
        function editCurrentClient() {
            const client = clientManager.getCurrentClient();
            if (!client) {
                showAlert('No client selected', 'error');
                return;
            }
            
            // Create edit dialog
            const newStatus = prompt(`Change status for ${client.initials}:\n1. active\n2. waitlist\n3. discharged`, client.status);
            
            if (newStatus && ['active', 'waitlist', 'discharged'].includes(newStatus)) {
                clientManager.updateClientStatus(client.id, newStatus).then(() => {
                    showAlert('Client status updated', 'success');
                    refreshClientsList();
                    updateCurrentClientDisplay();
                });
            }
        }
        
        // Clear current client
        function clearCurrentClient() {
            clientManager.setCurrentClient(null);
            updateCurrentClientDisplay();
            // Clear selected programs
            selectedPrograms = [];
            updateSelectedPrograms();
            renderSelectedPrograms();
        }
        
        // Override the original handleProgramClick to link with current client
        const originalHandleProgramClick = window.handleProgramClick;
        window.handleProgramClick = function(programId, isSubProgram = false, parentId = null) {
            // Call original function
            if (originalHandleProgramClick) {
                originalHandleProgramClick(programId, isSubProgram, parentId);
            }
            
            // Track program selection for current client if clientManager is available
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client) {
                    if (selectedPrograms.includes(programId)) {
                        clientManager.addProgramToClient(client.id, programId, {
                            isSubProgram,
                            parentId,
                            addedFrom: 'program-list'
                        });
                    } else {
                        clientManager.removeProgramFromClient(client.id, programId);
                    }
                }
            }
        };
        
        // Override generateDocument to track for current client
        const originalGenerateDocument = window.generateDocument;
        window.generateDocument = function() {
            // Track for current client if clientManager is available
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client && selectedPrograms.length > 0) {
                    // Track document generation
                    clientManager.addDocumentRecord(client.id, {
                        type: documentType,
                        programIds: [...selectedPrograms],
                        settings: {
                            includeAtHome,
                            includeAlumni
                        },
                        fileName: `CareConnect_${client.initials}_${new Date().toISOString().split('T')[0]}.docx`
                    });
                }
            }
            
            // Call original function
            if (originalGenerateDocument) {
                return originalGenerateDocument();
            }
        };
        
        // Helper function to show alerts
        function showAlert(message, type = 'info') {
            // You can customize this to use your preferred notification system
            const alertClass = type === 'error' ? 'error-alert' : 'success-alert';
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.textContent = message;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'error' ? '#ef4444' : '#10b981'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // Export client data
        async function exportClientData() {
            try {
                const clients = await clientManager.getAllClients();
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    clients: clients
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `clients-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showAlert(`Exported ${clients.length} clients`, 'success');
            } catch (error) {
                showAlert('Failed to export clients', 'error');
                console.error(error);
            }
        }
        
        // Import client data
        async function importClientData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.clients || !Array.isArray(data.clients)) {
                        throw new Error('Invalid client data format');
                    }
                    
                    let imported = 0;
                    for (const client of data.clients) {
                        try {
                            await clientManager.importClient(client);
                            imported++;
                        } catch (err) {
                            console.warn(`Failed to import client ${client.initials}:`, err);
                        }
                    }
                    
                    await refreshClientsList();
                    showAlert(`Imported ${imported} clients`, 'success');
                } catch (error) {
                    showAlert('Failed to import clients', 'error');
                    console.error(error);
                }
            };
            
            input.click();
        }
        
        // Toggle recent clients dropdown
        function toggleRecentClients() {
            const dropdown = document.getElementById('recentClientsDropdown');
            if (dropdown.style.display === 'none') {
                loadRecentClients();
                dropdown.style.display = 'block';
                // Close on click outside
                setTimeout(() => {
                    document.addEventListener('click', closeRecentClientsOnClickOutside);
                }, 100);
            } else {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeRecentClientsOnClickOutside);
            }
        }
        
        // Close dropdown on click outside
        function closeRecentClientsOnClickOutside(e) {
            const dropdown = document.getElementById('recentClientsDropdown');
            if (!dropdown.contains(e.target) && !e.target.closest('button[onclick*="toggleRecentClients"]')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeRecentClientsOnClickOutside);
            }
        }
        
        // Load recent clients
        async function loadRecentClients() {
            const dropdown = document.getElementById('recentClientsDropdown');
            
            // Check if clientManager exists
            if (!window.clientManager) {
                dropdown.innerHTML = `
                    <div style="padding: 12px; color: #6b7280; text-align: center;">
                        Client manager not initialized yet
                    </div>
                `;
                return;
            }
            
            const recentClients = await clientManager.getRecentClients(5);
            const currentClient = clientManager.getCurrentClient();
            
            if (recentClients.length === 0) {
                dropdown.innerHTML = `
                    <div style="padding: 12px; color: #6b7280; text-align: center;">
                        No recent clients
                    </div>
                `;
                return;
            }
            
            dropdown.innerHTML = recentClients.map(client => {
                const isActive = currentClient?.id === client.id;
                const programCount = client.programHistory?.filter(p => p.status === 'selected').length || 0;
                return `
                    <div onclick="quickSelectClient('${client.id}')" 
                         style="padding: 10px; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: background 0.2s; ${isActive ? 'background: #ede9fe;' : ''}"
                         onmouseover="this.style.background='#f3f4f6'" 
                         onmouseout="this.style.background='${isActive ? '#ede9fe' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #1f2937;">${client.initials}</strong>
                                <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Kipu: ${client.kipuId}</span>
                            </div>
                            <span style="background: ${client.status === 'active' ? '#d1fae5' : client.status === 'waitlist' ? '#fef3c7' : '#f3f4f6'}; 
                                         color: ${client.status === 'active' ? '#065f46' : client.status === 'waitlist' ? '#92400e' : '#6b7280'}; 
                                         padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${client.status}
                            </span>
                        </div>
                        <div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">
                            ${programCount} programs ‚Ä¢ Last modified: ${new Date(client.lastModified).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Quick select client from dropdown
        async function quickSelectClient(clientId) {
            if (!window.clientManager) {
                showAlert('Client manager not ready yet', 'error');
                return;
            }
            
            await selectClient(clientId);
            document.getElementById('recentClientsDropdown').style.display = 'none';
            document.removeEventListener('click', closeRecentClientsOnClickOutside);
            
            // Update current client indicator
            const currentClient = clientManager.getCurrentClient();
            const button = document.querySelector('button[onclick*="toggleRecentClients"]');
            if (currentClient && button) {
                button.innerHTML = `‚ö° ${currentClient.initials} (${currentClient.kipuId}) ‚ñº`;
            }
        }
        
        // Manage favorite programs
        function manageFavorites() {
            const favorites = JSON.parse(localStorage.getItem('favoritePrograms') || '[]');
            
            // Create a modal for managing favorites
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                z-index: 10001;
                max-width: 600px;
                width: 90%;
                max-height: 70vh;
                overflow-y: auto;
            `;
            modal.classList.add('floating-modal');
            
            modal.innerHTML = `
                <h3 style="margin-top: 0;">‚≠ê Manage Favorite Programs</h3>
                <p style="color: #6b7280; font-size: 14px;">Select programs to add to favorites for quick access:</p>
                <div id="favoritesSelection" style="margin: 20px 0;">
                    ${programs.slice(0, 20).map(program => `
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" value="${program.id}" 
                                   ${favorites.includes(program.id) ? 'checked' : ''} 
                                   style="margin-right: 8px;">
                            ${program.name}
                        </label>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="window.closeModal()" 
                            style="padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveFavorites()" 
                            style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Save Favorites
                    </button>
                </div>
            `;
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
            `;
            backdrop.onclick = () => window.closeModal();
            
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }
        
        // Save favorite programs
        function saveFavorites() {
            const checkboxes = document.querySelectorAll('#favoritesSelection input[type="checkbox"]');
            const favorites = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    favorites.push(checkbox.value);
                }
            });
            
            localStorage.setItem('favoritePrograms', JSON.stringify(favorites));
            loadFavoritePrograms();
            
            // Close modal
            window.closeModal();
            
            showAlert('Favorites saved!', 'success');
        }
        
        // Load favorite programs
        function loadFavoritePrograms() {
            const favorites = JSON.parse(localStorage.getItem('favoritePrograms') || '[]');
            const container = document.getElementById('favoritePrograms');
            const list = document.getElementById('favoriteProgramsList');
            
            if (!container || !list) {
                return; // Elements don't exist, skip
            }
            
            if (favorites.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = favorites.map(programId => {
                const program = programs.find(p => p.id === programId);
                if (!program) return '';
                
                const isSelected = selectedPrograms.includes(programId);
                return `
                    <button onclick="toggleFavoriteProgram('${programId}')" 
                            style="padding: 6px 12px; 
                                   background: ${isSelected ? '#065f46' : '#f59e0b'}; 
                                   color: white; 
                                   border: none; 
                                   border-radius: 4px; 
                                   cursor: pointer; 
                                   font-size: 12px;
                                   transition: all 0.2s;">
                        ${isSelected ? '‚úì' : '+'} ${program.name}
                    </button>
                `;
            }).join('');
        }
        
        // Toggle favorite program
        function toggleFavoriteProgram(programId) {
            if (selectedPrograms.includes(programId)) {
                // Remove if already selected
                const index = selectedPrograms.indexOf(programId);
                selectedPrograms.splice(index, 1);
            } else {
                // Add to selection
                selectedPrograms.push(programId);
            }
            
            updateSelectedPrograms();
            renderSelectedPrograms();
            loadFavoritePrograms(); // Refresh the favorites display
            
            // Track for current client
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client) {
                    if (selectedPrograms.includes(programId)) {
                        clientManager.addProgramToClient(client.id, programId, { addedFrom: 'favorites' });
                    } else {
                        clientManager.removeProgramFromClient(client.id, programId);
                    }
                }
            }
        }
        
        // Initialize workflow features on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure tab navigation is visible immediately
            ensureTabNavigationVisible();
            
            setTimeout(() => {
                loadFavoritePrograms();
                
                // Ensure tab navigation is still visible after delay
                ensureTabNavigationVisible();
                
                // Check if clientManager is initialized
                if (!window.clientManager) {
                    console.warn('ClientManager not initialized after 2 seconds');
                    // Show warning if on clients tab
                    const clientsTab = document.getElementById('clientsTab');
                    if (clientsTab && clientsTab.classList.contains('active')) {
                        const statusDiv = document.getElementById('clientManagerStatus');
                        if (statusDiv) {
                            statusDiv.style.display = 'block';
                        }
                    }
                } else {
                    console.log('ClientManager is available:', window.clientManager);
                    // Update recent clients button with current client if any
                    const currentClient = clientManager.getCurrentClient();
                    if (currentClient) {
                        const button = document.querySelector('button[onclick*="toggleRecentClients"]');
                        if (button) {
                            button.innerHTML = `‚ö° ${currentClient.initials} (${currentClient.kipuId}) ‚ñº`;
                        }
                    }
                }
            }, 2000); // Increased timeout to ensure clientManager is initialized
        });
        // CM Tracker Functions
        // Show add client modal - make globally available
        window.showAddClientModal = async function showAddClientModal() {
            const houses = await housesManager.getActiveHouses();
            const currentHouse = houses.find(h => h.id === currentHouseId) || houses[0];
            
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <h3>Add New Client</h3>
                        <form id="addClientForm" onsubmit="handleAddClient(event)">
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>Client Initials *</label>
                                    <input type="text" name="initials" maxlength="4" required 
                                           style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Kipu ID *</label>
                                    <input type="text" name="kipuId" required style="width: 100%;">
                                </div>
                                <div>
                                    <label>House *</label>
                                    <select name="houseId" required style="width: 100%;">
                                        ${houses.map(h => `
                                            <option value="${h.id}" ${h.id === currentHouse.id ? 'selected' : ''}>
                                                ${h.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label>Admission Date</label>
                                    <input type="date" name="admissionDate" style="width: 100%;">
                                </div>
                                <div>
                                    <label>Clinical Coach</label>
                                    <input type="text" name="clinicalCoachInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Case Manager</label>
                                    <input type="text" name="caseManagerInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Primary Therapist</label>
                                    <input type="text" name="primaryTherapistInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                                <button type="button" onclick="window.closeModal()" 
                                        style="padding: 10px 20px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Add Client
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add keyboard listener for ESC key
            document.addEventListener('keydown', handleModalKeydown);
            
            // Fix overlay click handling
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeModal();
                    }
                });
            }
        }
        
        // Handle add client form submission
        async function handleAddClient(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
                const clientData = {
                initials: formData.get('initials'),
                kipuId: formData.get('kipuId'),
                houseId: formData.get('houseId'),
                admissionDate: formData.get('admissionDate') || new Date().toISOString().split('T')[0],  // Default to today if not provided
                clinicalCoachInitials: formData.get('clinicalCoachInitials') || '',
                caseManagerInitials: formData.get('caseManagerInitials') || '',
                primaryTherapistInitials: formData.get('primaryTherapistInitials') || '',
                status: 'active'  // Explicitly set active status
            };
            
            try {
                const newClient = await window.clientManager.createClient(clientData);
                
                // Initialize milestones for the new client
                await milestonesManager.initializeClientMilestones(newClient.id);
                
                showAlert('Client added successfully!', 'success');
                closeModal();
                await loadHouseView(currentHouseId);
                await buildHouseNavigation(); // Update counts
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        // View client details with modern design
        // NOTE: Accepts either a client ID (string) or a full client object
        async function viewClientDetails(clientOrId) {
            try {
                let clientId = null;
                let client = null;
                
                // Support being called with either an ID or a client object
                if (typeof clientOrId === 'string') {
                    clientId = clientOrId;
                } else if (clientOrId && typeof clientOrId === 'object') {
                    clientId = clientOrId.id;
                    client = clientOrId;
                }
                
                // Guard against invalid IDs (prevents IndexedDB DataError)
                if (!clientId) {
                    console.error('viewClientDetails called without a valid clientId:', clientOrId);
                    showAlert('Client not found', 'error');
                    return;
                }
                
                // Load client from ClientManager if we weren't given the full object
                if (!client) {
                    client = await window.clientManager.getClient(clientId);
                }
                
                if (!client) {
                    showAlert('Client not found', 'error');
                    return;
                }
                
                // Get related data
                const house = housesManager.getHouseById(client.houseId);
                const milestones = await milestonesManager.getClientMilestones(client.id);
                const aftercareOptions = await aftercareManager.getClientAftercareOptions(client.id);
                const daysInCare = window.clientManager.calculateDaysInCare(client);
                const hoursElapsed = window.clientManager.calculateHoursElapsed(client);
                
                console.log('Debug - Days in care calculation:', {
                    clientInitials: client.initials,
                    admissionDate: client.admissionDate, 
                    daysInCare: daysInCare
                });
                
                // Calculate completion percentages based on tracking fields
                const trackingFields = [
                    'needsAssessment', 'healthPhysical', 'aftercareThreadSent',
                    'optionsDocUploaded', 'dischargePacketUploaded', 'referralClosureCorrespondence',
                    'gadCompleted', 'phqCompleted', 'satisfactionSurvey', 
                    'dischargeSummary', 'dischargePlanningNote', 'dischargeASAM'
                ];
                const completed = trackingFields.filter(field => client[field]).length;
                const completionPercentage = trackingFields.length > 0 ? Math.round((completed / trackingFields.length) * 100) : 0;
                
                // Build modal HTML with modern design
                const modalHTML = `
                    <div class="modal-overlay">
                        <div class="modal-content modern-modal">
                            <!-- Header with key metrics -->
                            <div class="modal-header">
                                <div class="modal-header-left">
                                    <h2 class="client-name">${client.initials}</h2>
                                    <span class="client-id">${client.kipuId}</span>
                                    <span class="client-status status-${client.status}">${client.status === 'active' ? '‚óè Active' : '‚óã Discharged'}</span>
                                </div>
                                <div class="modal-header-right">
                                    <div class="metric-card">
                                        <div class="metric-value">${daysInCare || 0}</div>
                                        <div class="metric-label">Days in Care</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value">${completionPercentage || 0}%</div>
                                        <div class="metric-label">Completed</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value">${house ? house.name : 'N/A'}</div>
                                        <div class="metric-label">House</div>
                                    </div>
                                </div>
                                <button class="modal-close" onclick="window.closeModal()">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="modal-toolbar" style="display:flex; justify-content:flex-end; gap:12px; margin: 12px 0 20px 0;">
                                <button class="primary-action" onclick="generateClientDocument('${clientId}', { focusSearch: true })" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                                    <span>‚ú®</span>
                                    <span>Create Document for ${client.initials}</span>
                                </button>
                            </div>
                            
                            <!-- Main Content Area -->
                            <div class="modal-body">
                                <!-- Sidebar Navigation -->
                                <div class="sidebar-nav">
                                    <button class="nav-item active" onclick="switchDetailSection('tracking', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M9 2L2 7L9 12M2 7H18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>Tracking</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('assessments', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M9 11L3 17L1 15L7 9L9 11ZM16 3L19 6L13 12L11 10L16 3Z" fill="currentColor"/>
                                        </svg>
                                        <span>Assessments</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('aftercare', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18C5.58172 18 2 14.4183 2 10C2 5.58172 5.58172 2 10 2ZM10 5L7 9H9V13L13 9H11V5H10Z" fill="currentColor"/>
                                        </svg>
                                        <span>Aftercare</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('team', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M12 4.354C11.3687 3.72275 10.5687 3.375 9.69995 3.375C8.83119 3.375 8.0312 3.72275 7.39995 4.354C6.7687 4.98525 6.42095 5.78525 6.42095 6.654C6.42095 7.52275 6.7687 8.32275 7.39995 8.954C8.0312 9.58525 8.83119 9.933 9.69995 9.933C10.5687 9.933 11.3687 9.58525 11.9999 8.954C12.6312 8.32275 12.9789 7.52275 12.9789 6.654C12.9789 5.78525 12.6312 4.98525 12 4.354Z" fill="currentColor"/>
                                            <path d="M16.5 14.954C16.5 14.274 16.3679 13.6019 16.1124 12.975C15.857 12.3482 15.4831 11.7786 15.0104 11.2969C14.5376 10.8152 13.975 10.4305 13.3525 10.1636C12.73 9.89666 12.0596 9.75255 11.3789 9.73875C10.8262 10.1458 10.1842 10.4271 9.49997 10.5598C8.81578 10.4271 8.17378 10.1458 7.62108 9.73875C6.94036 9.75255 6.26999 9.89666 5.64749 10.1636C5.025 10.4305 4.46235 10.8152 3.98965 11.2969C3.51695 11.7786 3.14301 12.3482 2.88758 12.975C2.63214 13.6019 2.5 14.274 2.5 14.954V16.563H16.5V14.954Z" fill="currentColor"/>
                                        </svg>
                                        <span>Care Team</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('timeline', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M10 2C14.418 2 18 5.582 18 10S14.418 18 10 18S2 14.418 2 10S5.582 2 10 2ZM10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>Timeline</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('notes', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M4 5C4 4.44772 4.44772 4 5 4H11C11.5523 4 12 4.44772 12 5V16L8 14L4 16V5Z" fill="currentColor"/>
                                        </svg>
                                        <span>Notes</span>
                                    </button>
                                </div>
                            
                                
                                <!-- Content Area -->
                                <div class="content-area">
                                    <!-- Tracking Section -->
                                    <div id="trackingSection" class="section-content active">
                                        ${hoursElapsed < 48 && client.status === 'active' ? `
                                        <!-- 48-hour Admission Countdown -->
                                        <div class="admission-timer ${hoursElapsed >= 36 ? 'timer-urgent' : hoursElapsed >= 24 ? 'timer-warning' : ''}">
                                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" style="margin-right: 8px;">
                                                <path d="M10 2C14.418 2 18 5.582 18 10S14.418 18 10 18S2 14.418 2 10S5.582 2 10 2ZM10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            <span class="timer-text">
                                                <strong>${48 - hoursElapsed} hours remaining</strong> for admission assessments
                                                ${!client.needsAssessment || !client.healthPhysical ? `
                                                    <span class="timer-items">
                                                        ${!client.needsAssessment ? '‚Ä¢ Needs Assessment' : ''}
                                                        ${!client.healthPhysical ? '‚Ä¢ Health & Physical' : ''}
                                                    </span>
                                                ` : ''}
                                            </span>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- Tracking Cards -->
                                        <div class="tracking-grid">
                                            <!-- Admission & Assessment Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìã Admission & Assessment</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item" data-tracking="needs-assessment">
                                                        <input type="checkbox" 
                                                               id="needs-assessment-${clientId}" 
                                                               ${client.needsAssessment ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'needsAssessment', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Needs Assessment</span>
                                                        ${client.needsAssessmentDate ? `<span class="completion-date">${new Date(client.needsAssessmentDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="health-physical">
                                                        <input type="checkbox" 
                                                               id="health-physical-${clientId}" 
                                                               ${client.healthPhysical ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'healthPhysical', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Health & Physical Assessment</span>
                                                        ${client.healthPhysicalDate ? `<span class="completion-date">${new Date(client.healthPhysicalDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Aftercare Planning Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üéØ Aftercare Planning</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item ${daysInCare >= 14 && daysInCare <= 16 ? 'highlight-warning' : daysInCare > 16 ? 'highlight-danger' : ''}" data-tracking="aftercare-thread">
                                                        <input type="checkbox" 
                                                               id="aftercare-thread-${clientId}" 
                                                               ${client.aftercareThreadSent ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'aftercareThreadSent', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Aftercare Planning Thread Sent</span>
                                                        ${daysInCare >= 14 ? `<span class="days-indicator days-${daysInCare}">${daysInCare} days</span>` : ''}
                                                        ${client.aftercareThreadDate ? `<span class="completion-date">${new Date(client.aftercareThreadDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="options-doc">
                                                        <input type="checkbox" 
                                                               id="options-doc-${clientId}" 
                                                               ${client.optionsDocUploaded ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'optionsDocUploaded', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Options Document in Kipu</span>
                                                        ${client.optionsDocUploadedDate ? `<span class="completion-date">${new Date(client.optionsDocUploadedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="discharge-packet">
                                                        <input type="checkbox" 
                                                               id="discharge-packet-${clientId}" 
                                                               ${client.dischargePacketUploaded ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargePacketUploaded', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Discharge Packet in Kipu</span>
                                                        ${client.dischargePacketDate ? `<span class="completion-date">${new Date(client.dischargePacketDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="referral-closure">
                                                        <input type="checkbox" 
                                                               id="referral-closure-${clientId}" 
                                                               ${client.referralClosureCorrespondence ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'referralClosureCorrespondence', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Referral/Closure Correspondence</span>
                                                        ${client.referralClosureDate ? `<span class="completion-date">${new Date(client.referralClosureDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                                
                                                <!-- Aftercare Options Progress Tracking -->
                                                ${client.aftercareOptions && client.aftercareOptions.length > 0 ? `
                                                    <div class="aftercare-options-tracking">
                                                        <h4 style="font-size: 14px; margin: 16px 0 12px 0; font-weight: 600; color: #374151;">
                                                            Aftercare Options Progress
                                                        </h4>
                                                        ${client.aftercareOptions.map(option => `
                                                            <div class="aftercare-option-item">
                                                                <div class="option-header">
                                                                    <span class="option-name">${option.programName}</span>
                                                                    <span class="option-status status-${option.status}">${option.status}</span>
                                                                </div>
                                                                
                                                                <div class="progress-tracker">
                                                                    <div class="progress-step ${option.familyContacted ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'familyContacted', ${!option.familyContacted})">
                                                                        <span class="step-icon">
                                                                            ${option.familyContacted ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                '‚òéÔ∏è'}
                                                                        </span>
                                                                        <span class="step-label">Family Contacted</span>
                                                                    </div>
                                                                    <div class="progress-step ${option.recordsSent ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'recordsSent', ${!option.recordsSent})">
                                                                        <span class="step-icon">
                                                                            ${option.recordsSent ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                'üìÑ'}
                                                                        </span>
                                                                        <span class="step-label">Records Sent</span>
                                                                    </div>
                                                                    <div class="progress-step ${option.assessmentScheduled ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'assessmentScheduled', ${!option.assessmentScheduled})">
                                                                        <span class="step-icon">
                                                                            ${option.assessmentScheduled ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                'üìÖ'}
                                                                        </span>
                                                                        <span class="step-label">Assessment Set</span>
                                                                    </div>
                                                                    <div class="progress-step ${option.accepted ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'accepted', ${!option.accepted})">
                                                                        <span class="step-icon">
                                                                            ${option.accepted ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                '‚úÖ'}
                                                                        </span>
                                                                        <span class="step-label">Accepted</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            
                                            <!-- Clinical Assessments Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìä Clinical Assessments</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item" data-tracking="gad-completed">
                                                        <input type="checkbox" 
                                                               id="gad-completed-${clientId}" 
                                                               ${client.gadCompleted ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'gadCompleted', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">GAD-7 Completed (in Kipu)</span>
                                                        ${client.gadCompletedDate ? `<span class="completion-date">${new Date(client.gadCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="phq-completed">
                                                        <input type="checkbox" 
                                                               id="phq-completed-${clientId}" 
                                                               ${client.phqCompleted ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'phqCompleted', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">PHQ-9 Completed (in Kipu)</span>
                                                        ${client.phqCompletedDate ? `<span class="completion-date">${new Date(client.phqCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="satisfaction-survey">
                                                        <input type="checkbox" 
                                                               id="satisfaction-survey-${clientId}" 
                                                               ${client.satisfactionSurvey ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'satisfactionSurvey', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Satisfaction Survey Completed</span>
                                                        ${client.satisfactionSurveyDate ? `<span class="completion-date">${new Date(client.satisfactionSurveyDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Documentation Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìÑ Documentation</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item" data-tracking="discharge-summary">
                                                        <input type="checkbox" 
                                                               id="discharge-summary-${clientId}" 
                                                               ${client.dischargeSummary ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargeSummary', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Discharge Summary</span>
                                                        ${client.dischargeSummaryDate ? `<span class="completion-date">${new Date(client.dischargeSummaryDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="discharge-planning">
                                                        <input type="checkbox" 
                                                               id="discharge-planning-${clientId}" 
                                                               ${client.dischargePlanningNote ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargePlanningNote', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Final Discharge Planning Note</span>
                                                        ${client.dischargePlanningNoteDate ? `<span class="completion-date">${new Date(client.dischargePlanningNoteDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="discharge-asam">
                                                        <input type="checkbox" 
                                                               id="discharge-asam-${clientId}" 
                                                               ${client.dischargeASAM ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargeASAM', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Discharge ASAM</span>
                                                        ${client.dischargeASAMDate ? `<span class="completion-date">${new Date(client.dischargeASAMDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Assessments Section -->
                                    <div id="assessmentsSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Assessment History</h2>
                                        </div>
                                        <div class="tracking-grid">
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìä Clinical Assessments Status</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item">
                                                        <input type="checkbox" ${client.gadCompleted ? 'checked' : ''} style="pointer-events: none;">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">GAD-7 Completed (in Kipu)</span>
                                                        ${client.gadCompletedDate ? `<span class="completion-date">${new Date(client.gadCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item">
                                                        <input type="checkbox" ${client.phqCompleted ? 'checked' : ''} style="pointer-events: none;">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">PHQ-9 Completed (in Kipu)</span>
                                                        ${client.phqCompletedDate ? `<span class="completion-date">${new Date(client.phqCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item">
                                                        <input type="checkbox" ${client.satisfactionSurvey ? 'checked' : ''} style="pointer-events: none;">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Satisfaction Survey Completed</span>
                                                        ${client.satisfactionSurveyDate ? `<span class="completion-date">${new Date(client.satisfactionSurveyDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìù Notes</h3>
                                                <p style="color: #6b7280; padding: 20px;">All assessments are completed within Kipu. This tracking ensures completion status is documented.</p>
                                            </div>
                                        </div>
                                    </div>
                                
                                    
                                    <!-- Aftercare Section -->
                                    <div id="aftercareSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Aftercare Options</h2>
                                            <button class="btn-primary" onclick="addAftercareOption('${clientId}')">+ Add Option</button>
                                        </div>
                                        <div class="aftercare-grid">
                                            ${buildModernAftercareList(aftercareOptions, clientId)}
                                        </div>
                                    </div>
                                    
                                    <!-- Care Team Section -->
                                    <div id="teamSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Care Team Assignments</h2>
                                        </div>
                                        <div class="team-grid">
                                            <div class="team-member-card">
                                                <div class="member-icon">ü§ù</div>
                                                <label>Case Manager</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="caseManager" 
                                                       value="${client.caseManagerInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'caseManagerInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üè•</div>
                                                <label>Clinical Coach</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="clinicalCoach" 
                                                       value="${client.clinicalCoachInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'clinicalCoachInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üë®‚Äç‚öïÔ∏è</div>
                                                <label>Primary Therapist</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="primaryTherapist" 
                                                       value="${client.primaryTherapistInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'primaryTherapistInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üë•</div>
                                                <label>Primary Family Ambassador</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="familyAmbassador" 
                                                       value="${client.familyAmbassadorPrimaryInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'familyAmbassadorPrimaryInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üë•</div>
                                                <label>Secondary Family Ambassador</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="familyAmbassador2" 
                                                       value="${client.familyAmbassadorSecondaryInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'familyAmbassadorSecondaryInitials', this.value)">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Timeline Section -->
                                    <div id="timelineSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Client Timeline</h2>
                                        </div>
                                        <div class="timeline-container">
                                            ${buildClientTimeline(client, milestones, daysInCare)}
                                        </div>
                                    </div>
                                    
                                    <!-- Notes Section -->
                                    <div id="notesSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Notes & Documentation</h2>
                                        </div>
                                        <div class="notes-container">
                                            <textarea class="notes-textarea" 
                                                      id="clientNotes" 
                                                      placeholder="Add notes about this client..."
                                                      oninput="autoSaveNotes('${clientId}', this.value)">${client.notes || ''}</textarea>
                                            <div class="notes-footer">
                                                <span id="noteSaveStatus" class="save-status">All changes saved</span>
                                                <span class="notes-timestamp">Last updated: ${client.notesUpdatedAt ? new Date(client.notesUpdatedAt).toLocaleString() : 'Never'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                // Add comprehensive modern styling
                const style = document.createElement('style');
                style.textContent = `
                    /* Modal Base Styles */
                    .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(0, 0, 0, 0.6);
                        backdrop-filter: blur(4px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 999999;
                        cursor: pointer;
                        animation: fadeIn 0.2s ease;
                    }
                    .modal-content {
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
                        cursor: default;
                        overflow: hidden;
                        position: relative;
                    }
                    .modern-modal {
                        width: 1000px;
                        max-width: 95vw;
                        height: 75vh;
                        max-height: 700px;
                        display: flex;
                        flex-direction: column;
                        animation: slideIn 0.3s ease;
                    }
                    
                    /* Modal Header */
                    .modal-header {
                        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                        color: white;
                        padding: 24px;
                        display: flex;
                        align-items: center;
                        gap: 20px;
                        position: relative;
                    }
                    .modal-header-left {
                        flex: 1;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    .client-name {
                        font-size: 22px;
                        font-weight: 700;
                        margin: 0;
                    }
                    .client-id {
                        background: rgba(255,255,255,0.2);
                        padding: 4px 10px;
                        border-radius: 20px;
                        font-size: 13px;
                    }
                    .client-status {
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: 500;
                    }
                    .status-active {
                        background: #10b981;
                        color: white;
                    }
                    .status-discharged {
                        background: #ef4444;
                        color: white;
                    }
                    
                    /* Header Metrics */
                    .modal-header-right {
                        display: flex;
                        gap: 16px;
                    }
                    .metric-card {
                        background: rgba(255,255,255,0.15);
                        backdrop-filter: blur(10px);
                        padding: 12px 20px;
                        border-radius: 12px;
                        text-align: center;
                        min-width: 100px;
                    }
                    .metric-value {
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 4px;
                    }
                    .metric-label {
                        font-size: 12px;
                        opacity: 0.9;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    
                    /* Modal Close Button */
                    .modal-close {
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        color: white;
                    }
                    .modal-close:hover {
                        background: rgba(255,255,255,0.3);
                        transform: scale(1.1);
                    }
                    
                    /* Modal Body */
                    .modal-body {
                        flex: 1;
                        display: flex;
                        overflow: hidden;
                        background: #f8f9fa;
                    }
                    
                    /* Sidebar Navigation */
                    .sidebar-nav {
                        width: 180px;
                        background: white;
                        padding: 12px 6px;
                        border-right: 1px solid #e5e7eb;
                        display: flex;
                        flex-direction: column;
                        gap: 2px;
                    }
                    .nav-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px 12px;
                        border: none;
                        background: transparent;
                        color: #6b7280;
                        font-size: 13px;
                        font-weight: 500;
                        text-align: left;
                        cursor: pointer;
                        border-radius: 6px;
                        transition: all 0.2s ease;
                    }
                    .nav-item:hover {
                        background: #f3f4f6;
                        color: #1f2937;
                    }
                    .nav-item.active {
                        background: #6366f1;
                        color: white;
                    }
                    .nav-icon {
                        width: 20px;
                        height: 20px;
                        flex-shrink: 0;
                    }
                    
                    /* Content Area */
                    .content-area {
                        flex: 1;
                        overflow-y: auto;
                        padding: 24px;
                    }
                    .section-content {
                        display: none;
                    }
                    .section-content.active {
                        display: block;
                        animation: fadeIn 0.3s ease;
                    }
                    .section-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 24px;
                    }
                    .section-header h2 {
                        font-size: 24px;
                        font-weight: 700;
                        color: #1f2937;
                        margin: 0;
                    }
                    
                    /* Tracking Grid */
                    .tracking-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 16px;
                    }
                    .tracking-card {
                        background: white;
                        border-radius: 10px;
                        padding: 16px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
                        transition: all 0.2s ease;
                    }
                    .tracking-card:hover {
                        box-shadow: 0 3px 12px rgba(0,0,0,0.1);
                        transform: translateY(-1px);
                    }
                    
                    /* Admission Timer */
                    .admission-timer {
                        display: flex;
                        align-items: center;
                        background: #fef3c7;
                        border: 2px solid #f59e0b;
                        border-radius: 8px;
                        padding: 12px 16px;
                        margin-bottom: 16px;
                        font-size: 14px;
                        color: #92400e;
                    }
                    .admission-timer.timer-warning {
                        background: #fee2e2;
                        border-color: #ef4444;
                        color: #991b1b;
                    }
                    .admission-timer.timer-urgent {
                        background: #dc2626;
                        border-color: #991b1b;
                        color: white;
                        animation: pulse 2s infinite;
                    }
                    .timer-text {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }
                    .timer-items {
                        font-size: 12px;
                        opacity: 0.9;
                        margin-left: 28px;
                    }
                    
                    /* Aftercare Progress Tracking */
                    .aftercare-options-tracking {
                        margin-top: 16px;
                        border-top: 1px solid #e5e7eb;
                        padding-top: 12px;
                    }
                    .aftercare-option-item {
                        background: #f9fafb;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 12px;
                    }
                    .option-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                    }
                    .option-name {
                        font-weight: 600;
                        font-size: 14px;
                        color: #111827;
                    }
                    .option-status {
                        font-size: 12px;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-weight: 500;
                        text-transform: capitalize;
                    }
                    .status-exploring {
                        background: #dbeafe;
                        color: #1e40af;
                    }
                    .status-in-progress {
                        background: #fef3c7;
                        color: #92400e;
                    }
                    .status-accepted {
                        background: #d1fae5;
                        color: #065f46;
                    }
                    .status-declined {
                        background: #fee2e2;
                        color: #991b1b;
                    }
                    
                    /* Progress Tracker Steps */
                    .progress-tracker {
                        display: flex;
                        gap: 8px;
                        flex-wrap: wrap;
                    }
                    .progress-step {
                        flex: 1;
                        min-width: 100px;
                        background: white;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 8px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 4px;
                    }
                    .progress-step:hover {
                        border-color: #6366f1;
                        background: #eef2ff;
                    }
                    .progress-step.completed {
                        background: #10b981;
                        border-color: #10b981;
                        color: white;
                    }
                    .step-icon {
                        font-size: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: transform 0.2s ease;
                    }
                    
                    .progress-step:hover .step-icon {
                        transform: scale(1.1);
                    }
                    
                    .progress-step.completed .step-icon svg {
                        animation: svgCheckPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                    }
                    
                    @keyframes svgCheckPop {
                        0% {
                            transform: scale(0) rotate(-45deg);
                            opacity: 0;
                        }
                        50% {
                            transform: scale(1.2) rotate(5deg);
                        }
                        100% {
                            transform: scale(1) rotate(0deg);
                            opacity: 1;
                        }
                    }
                    .step-label {
                        font-size: 11px;
                        font-weight: 500;
                    }
                    
                    /* Day indicators */
                    .days-indicator {
                        background: #fbbf24;
                        color: #78350f;
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 11px;
                        font-weight: 600;
                        margin-left: auto;
                    }
                    .days-15, .days-16 {
                        background: #fb923c;
                        color: #7c2d12;
                    }
                    .days-17, .days-18, .days-19, .days-20 {
                        background: #ef4444;
                        color: white;
                    }
                    
                    /* Highlight states */
                    .highlight-warning {
                        background: #fef3c7 !important;
                    }
                    .highlight-danger {
                        background: #fee2e2 !important;
                    }
                    
                    @keyframes pulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.8; }
                        100% { opacity: 1; }
                    }
                    .card-title {
                        font-size: 15px;
                        font-weight: 600;
                        color: #1f2937;
                        margin: 0 0 12px 0;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    
                    /* Checklist Styles */
                    .checklist {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }
                    .checklist-item {
                        display: flex;
                        align-items: center;
                        cursor: pointer;
                        padding: 8px 10px;
                        border-radius: 6px;
                        transition: all 0.2s ease;
                        position: relative;
                        font-size: 13px;
                    }
                    .checklist-item:hover {
                        background: #f9fafb;
                    }
                    .checklist-item.highlight-warning {
                        background: #fef3c7;
                        border: 1px solid #fbbf24;
                    }
                    .checklist-item.highlight-danger {
                        background: #fee2e2;
                        border: 1px solid #ef4444;
                    }
                    .checklist-item input[type="checkbox"] {
                        position: absolute;
                        opacity: 0;
                        cursor: pointer;
                    }
                    
                    .checklist-item input[type="checkbox"][style*="pointer-events: none"] {
                        cursor: default;
                    }
                    .checkbox-custom {
                        width: 24px;
                        height: 24px;
                        border: 2.5px solid #e5e7eb;
                        border-radius: 6px;
                        margin-right: 12px;
                        position: relative;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        flex-shrink: 0;
                        background: white;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                        overflow: hidden;
                    }
                    
                    .checklist-item:hover .checkbox-custom {
                        border-color: #22c55e;
                        transform: scale(1.05);
                        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1),
                                    0 1px 3px rgba(0, 0, 0, 0.1);
                    }
                    
                    .checkbox-custom::before {
                        content: '';
                        position: absolute;
                        top: -1px;
                        left: -1px;
                        right: -1px;
                        bottom: -1px;
                        background: linear-gradient(135deg, #22c55e, #16a34a);
                        transform: scale(0);
                        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        border-radius: 4px;
                    }
                    
                    .checklist-item input:checked ~ .checkbox-custom,
                    .checklist-item input[checked] ~ .checkbox-custom {
                        border-color: transparent;
                        animation: checkPulse 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    }
                    
                    .checklist-item input:checked ~ .checkbox-custom::before,
                    .checklist-item input[checked] ~ .checkbox-custom::before {
                        transform: scale(1);
                    }
                    
                    .checklist-item input:checked ~ .checkbox-custom::after,
                    .checklist-item input[checked] ~ .checkbox-custom::after {
                        content: '';
                        position: absolute;
                        width: 7px;
                        height: 12px;
                        border: solid white;
                        border-width: 0 3px 3px 0;
                        top: 40%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(45deg) scale(1);
                        animation: checkmarkPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                        animation-delay: 0.1s;
                        animation-fill-mode: both;
                        z-index: 2;
                    }
                    
                    @keyframes checkPulse {
                        0% { 
                            transform: scale(1); 
                            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                        }
                        30% { 
                            transform: scale(0.95); 
                            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                        }
                        60% { 
                            transform: scale(1.1); 
                            box-shadow: 0 0 0 8px rgba(34, 197, 94, 0.15),
                                        0 2px 4px rgba(0, 0, 0, 0.1);
                        }
                        100% { 
                            transform: scale(1); 
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                    }
                    
                    @keyframes checkmarkPop {
                        0% {
                            transform: translate(-50%, -50%) rotate(45deg) scale(0);
                            opacity: 0;
                        }
                        50% {
                            transform: translate(-50%, -50%) rotate(45deg) scale(1.3);
                            opacity: 1;
                        }
                        100% {
                            transform: translate(-50%, -50%) rotate(45deg) scale(1);
                            opacity: 1;
                        }
                    }
                    .item-text {
                        flex: 1;
                        color: #374151;
                        font-weight: 500;
                        font-size: 13px;
                    }
                    .checklist-item input:checked ~ .item-text,
                    .checklist-item input[checked] ~ .item-text {
                        color: #6b7280;
                        text-decoration: line-through;
                    }
                    .completion-date {
                        font-size: 11px;
                        color: #9ca3af;
                        margin-left: auto;
                    }
                    .days-indicator {
                        font-size: 12px;
                        font-weight: 600;
                        padding: 2px 8px;
                        border-radius: 12px;
                        margin-left: 8px;
                    }
                    .days-14, .days-15, .days-16 {
                        background: #fef3c7;
                        color: #92400e;
                    }
                    .days-indicator.days-17,
                    .days-indicator.days-18,
                    .days-indicator.days-19,
                    .days-indicator.days-20 {
                        background: #fee2e2;
                        color: #991b1b;
                    }
                    
                    /* Assessment Scores */
                    .assessment-scores {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                        margin-bottom: 16px;
                    }
                    .score-item {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }
                    .score-item label {
                        font-size: 14px;
                        font-weight: 600;
                        color: #374151;
                    }
                    .score-input {
                        padding: 8px 12px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        text-align: center;
                        transition: all 0.2s ease;
                    }
                    .score-input:focus {
                        outline: none;
                        border-color: #6366f1;
                        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                    }
                    
                    /* Team Grid */
                    .team-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 16px;
                    }
                    .team-member-card {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        transition: all 0.2s ease;
                    }
                    .team-member-card:hover {
                        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                        transform: translateY(-2px);
                    }
                    .member-icon {
                        font-size: 32px;
                        margin-bottom: 8px;
                    }
                    .team-member-card label {
                        display: block;
                        font-size: 14px;
                        font-weight: 600;
                        color: #374151;
                        margin-bottom: 8px;
                    }
                    .team-input {
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        text-align: center;
                        font-size: 18px;
                        font-weight: 700;
                        text-transform: uppercase;
                        transition: all 0.2s ease;
                    }
                    .team-input:focus {
                        outline: none;
                        border-color: #6366f1;
                        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                    }
                    
                    /* Notes Section */
                    .notes-container {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                    }
                    .notes-textarea {
                        width: 100%;
                        min-height: 300px;
                        padding: 16px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-family: inherit;
                        font-size: 14px;
                        line-height: 1.5;
                        resize: vertical;
                        transition: all 0.2s ease;
                    }
                    .notes-textarea:focus {
                        outline: none;
                        border-color: #6366f1;
                        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                    }
                    .notes-footer {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 12px;
                    }
                    .save-status {
                        font-size: 12px;
                        color: #10b981;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    }
                    .save-status.saving {
                        color: #6366f1;
                    }
                    .notes-timestamp {
                        font-size: 12px;
                        color: #9ca3af;
                    }
                    
                    /* Buttons */
                    .btn-primary {
                        background: #6366f1;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .btn-primary:hover {
                        background: #4f46e5;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
                    }
                    
                    /* Animations */
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .detail-tab-content {
                        padding: 20px;
                    }
                    .milestone-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        margin-bottom: 8px;
                        background: #f9fafb;
                        border-radius: 8px;
                        border: 1px solid #e5e7eb;
                    }
                    .milestone-item:hover {
                        background: #f3f4f6;
                    }
                    .aftercare-item {
                        padding: 15px;
                        margin-bottom: 10px;
                        background: white;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                    }
                    
                    /* Visual indicator color coding */
                    .milestone-indicator {
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        min-width: 28px;
                        height: 28px;
                        border-radius: 6px;
                        font-size: 16px;
                        transition: all 0.2s ease;
                        cursor: pointer;
                        user-select: none;
                    }
                    
                    .milestone-indicator.complete {
                        background-color: #10b981;
                        color: white;
                    }
                    
                    .milestone-indicator.overdue {
                        background-color: #ef4444;
                        color: white;
                        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
                    }
                    
                    .milestone-indicator.due-today {
                        background-color: #f59e0b;
                        color: white;
                    }
                    
                    .milestone-indicator.due-soon {
                        background-color: #f59e0b;
                        color: white;
                        opacity: 0.8;
                    }
                    
                    .milestone-indicator.in-progress {
                        background-color: #3b82f6;
                        color: white;
                    }
                    
                    .milestone-indicator.pending {
                        background: #e5e7eb;
                        color: #6b7280;
                    }
                    
                    @keyframes pulse {
                        0%, 100% {
                            opacity: 1;
                        }
                        50% {
                            opacity: .8;
                        }
                    }
                    /* Days in care color coding */
                    .days-in-care {
                        font-weight: 500;
                    }
                    
                    td.days-in-care {
                        text-align: center;
                    }
                    
                    /* Color code days based on milestones */
                    .days-13 { color: #f59e0b; font-weight: 600; }
                    .days-14 { color: #f59e0b; font-weight: 600; }
                    .days-16plus { color: #ef4444; font-weight: 600; }
                `;
                document.head.appendChild(style);
                
                // Add keyboard listener for ESC key
                document.addEventListener('keydown', handleModalKeydown);
                
                // Fix overlay click handling
                const overlay = document.querySelector('.modal-overlay');
                if (overlay) {
                    overlay.addEventListener('click', function(event) {
                        if (event.target === this) {
                            closeModal();
                        }
                    });
                    
                    // Prevent clicks inside modal from bubbling up
                    const modalContent = overlay.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.addEventListener('click', function(event) {
                            event.stopPropagation();
                        });
                    }
                }
                
            } catch (error) {
                console.error('Failed to load client details:', error);
                showAlert('Failed to load client details', 'error');
            }
        }
        
        // Update tracking field for a client
        async function updateTracking(clientId, field, checked) {
            try {
                const update = {};
                update[field] = checked;
                
                // Add timestamp if checked
                if (checked) {
                    update[field + 'Date'] = new Date().toISOString();
                } else {
                    update[field + 'Date'] = null;
                }
                
                await window.clientManager.updateClient(clientId, update);
                
                // Visual feedback
                const checkbox = document.querySelector(`#${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-${clientId}`);
                if (checkbox) {
                    const label = checkbox.closest('.checklist-item');
                    if (label) {
                        label.style.background = checked ? '#d1fae5' : 'transparent';
                        setTimeout(() => {
                            label.style.background = '';
                        }, 500);
                    }
                }
                
                // Update completion percentage
                updateCompletionPercentage(clientId);
                
                // Show success message
                showAlert(`‚úÖ ${field} ${checked ? 'marked complete' : 'unchecked'}`, 'success');
            } catch (error) {
                console.error('Failed to update tracking:', error);
                showAlert('Failed to update tracking', 'error');
            }
        }
        
        // Update aftercare option progress
        async function updateAftercareProgress(clientId, programId, field, value) {
            try {
                const progressUpdate = {};
                progressUpdate[field] = value;
                
                // Add timestamp for certain fields
                if (value && ['familyContacted', 'recordsSent', 'assessmentScheduled', 'accepted'].includes(field)) {
                    progressUpdate[field + 'Date'] = new Date().toISOString();
                }
                
                // Update status based on progress
                if (field === 'accepted' && value) {
                    progressUpdate.status = 'accepted';
                } else if (field === 'assessmentScheduled' && value) {
                    progressUpdate.status = 'in-progress';
                }
                
                await window.clientManager.updateAftercareProgress(clientId, programId, progressUpdate);
                
                // Reload the section to show updated data
                const client = await window.clientManager.getClient(clientId);
                if (client && client.aftercareOptions) {
                    const aftercareHTML = client.aftercareOptions.map(option => `
                        <div class="aftercare-option-item">
                            <div class="option-header">
                                <span class="option-name">${option.programName}</span>
                                <span class="option-status status-${option.status}">${option.status}</span>
                            </div>
                            
                            <div class="progress-tracker">
                                <div class="progress-step ${option.familyContacted ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'familyContacted', ${!option.familyContacted})">
                                    <span class="step-icon">
                                        ${option.familyContacted ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            '‚òéÔ∏è'}
                                    </span>
                                    <span class="step-label">Family Contacted</span>
                                </div>
                                <div class="progress-step ${option.recordsSent ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'recordsSent', ${!option.recordsSent})">
                                    <span class="step-icon">
                                        ${option.recordsSent ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            'üìÑ'}
                                    </span>
                                    <span class="step-label">Records Sent</span>
                                </div>
                                <div class="progress-step ${option.assessmentScheduled ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'assessmentScheduled', ${!option.assessmentScheduled})">
                                    <span class="step-icon">
                                        ${option.assessmentScheduled ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            'üìÖ'}
                                    </span>
                                    <span class="step-label">Assessment Set</span>
                                </div>
                                <div class="progress-step ${option.accepted ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'accepted', ${!option.accepted})">
                                    <span class="step-icon">
                                        ${option.accepted ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            '‚úÖ'}
                                    </span>
                                    <span class="step-label">Accepted</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Update just the aftercare tracking section
                    const trackingSection = document.querySelector('.aftercare-options-tracking');
                    if (trackingSection) {
                        trackingSection.innerHTML = `
                            <h4 style="font-size: 14px; margin: 16px 0 12px 0; font-weight: 600; color: #374151;">
                                Aftercare Options Progress
                            </h4>
                            ${aftercareHTML}
                        `;
                    }
                }
                
                showAlert(`‚úÖ Updated ${field} for aftercare option`, 'success');
            } catch (error) {
                console.error('Failed to update aftercare progress:', error);
                showAlert('Failed to update aftercare progress', 'error');
            }
        }
        
        // Update completion percentage in the header
        async function updateCompletionPercentage(clientId) {
            const client = await window.clientManager.getClient(clientId);
            if (!client) return;
            
            const trackingFields = [
                'needsAssessment', 'healthPhysical', 'aftercareThreadSent',
                'optionsDocUploaded', 'dischargePacketUploaded', 'referralClosureCorrespondence',
                'gadCompleted', 'phqCompleted', 'satisfactionSurvey', 
                'dischargeSummary', 'dischargePlanningNote', 'dischargeASAM'
            ];
            const completed = trackingFields.filter(field => client[field]).length;
            const completionPercentage = trackingFields.length > 0 ? Math.round((completed / trackingFields.length) * 100) : 0;
            
            // Update the percentage display
            const percentageDisplay = document.querySelector('.metric-value');
            if (percentageDisplay && percentageDisplay.nextElementSibling?.textContent === 'Completed') {
                percentageDisplay.textContent = `${completionPercentage}%`;
            }
        }
        
        // Build milestones list for client details
        async function buildMilestonesList(client, milestones, daysInCare) {
            let html = '<div>';
            
            for (const milestone of milestones) {
                const display = milestonesManager.getMilestoneDisplayStatus(milestone, daysInCare);
                const milestoneType = Object.values(milestonesManager.milestoneTypes).find(t => t.id === milestone.milestone);
                
                html += `
                    <div class="milestone-item">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${milestoneType.icon}</span>
                            <div>
                                <strong>${milestoneType.displayName}</strong>
                                <div style="font-size: 12px; color: #6b7280;">${milestoneType.description}</div>
                            </div>
                        </div>
                        <button onclick="toggleMilestone('${client.id}', '${milestone.milestone}')" 
                                class="milestone-indicator ${display.class}" 
                                style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; background: ${display.class === 'complete' ? '#10b981' : '#e5e7eb'}; color: ${display.class === 'complete' ? 'white' : '#374151'};">
                            ${display.icon} ${display.class === 'complete' ? 'Complete' : 'Mark Complete'}
                        </button>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Build aftercare list for client details
        function buildAftercareList(aftercareOptions, clientId) {
            if (aftercareOptions.length === 0) {
                return '<p style="color: #6b7280;">No aftercare options added yet.</p>';
            }
            
            let html = '<div>';
            
            for (const option of aftercareOptions) {
                const statusDisplay = aftercareManager.getStatusDisplay(option.status);
                
                html += `
                    <div class="aftercare-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 8px 0;">Option ${option.ordinal}: ${option.programName || 'Unnamed Program'}</h5>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <span style="padding: 4px 8px; background: ${statusDisplay.background}; color: ${statusDisplay.color}; border-radius: 4px; font-size: 12px;">
                                        ${statusDisplay.icon} ${statusDisplay.label}
                                    </span>
                                    ${option.dateProvidedToFamily ? `<span style="font-size: 12px; color: #6b7280;">Provided: ${option.dateProvidedToFamily}</span>` : ''}
                                </div>
                                ${option.notes ? `<p style="margin: 5px 0; font-size: 14px; color: #374151;">${option.notes}</p>` : ''}
                            </div>
                            <button onclick="editAftercareOption('${clientId}', ${option.ordinal})" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer;">
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Switch detail section
        function switchDetailSection(sectionName, event) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const sectionElement = document.getElementById(sectionName + 'Section');
            if (sectionElement) {
                sectionElement.classList.add('active');
            }
            
            // Add active class to selected nav item
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If no event, find the nav item by section name and activate it
                const navItem = document.querySelector(`.nav-item[onclick*="${sectionName}"]`);
                if (navItem) navItem.classList.add('active');
            }
        }
        
        // Save care team
        async function saveCareTeam(clientId) {
            try {
                const updates = {
                    clinicalCoachInitials: document.getElementById('clinicalCoach').value,
                    caseManagerInitials: document.getElementById('caseManager').value,
                    primaryTherapistInitials: document.getElementById('primaryTherapist').value,
                    familyAmbassadorPrimaryInitials: document.getElementById('familyAmbassador').value
                };
                
                await window.clientManager.updateClient(clientId, updates);
                showAlert('Care team updated successfully', 'success');
                
                // Refresh the table
                await loadHouseView(currentHouseId);
            } catch (error) {
                console.error('Failed to save care team:', error);
                showAlert('Failed to save care team', 'error');
            }
        }
        
        // Update tracking checkbox
        async function updateTracking(clientId, field, checked) {
            try {
                const updates = { [field]: checked };
                // Add timestamp if checked
                if (checked) {
                    updates[field + 'Date'] = new Date().toISOString();
                }
                
                await window.clientManager.updateClient(clientId, updates);
                
                // Visual feedback
                const checkbox = document.getElementById(`${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-${clientId}`);
                if (checkbox) {
                    const item = checkbox.closest('.checklist-item');
                    if (item) {
                        // Add completion animation
                        item.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            item.style.transform = 'scale(1)';
                        }, 200);
                    }
                }
                
                // Update completion percentage
                updateCompletionPercentage(clientId);
            } catch (error) {
                console.error('Failed to update tracking:', error);
                showAlert('Failed to update tracking', 'error');
                // Revert checkbox
                const checkbox = document.getElementById(`${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-${clientId}`);
                if (checkbox) checkbox.checked = !checked;
            }
        }
        
        // Update score
        async function updateScore(clientId, field, value) {
            try {
                const updates = { [field]: value ? parseInt(value) : null };
                await window.clientManager.updateClient(clientId, updates);
                
                // Visual feedback
                const input = document.getElementById(`${field.replace('Score', '-score')}-${clientId}`);
                if (input) {
                    input.style.borderColor = '#10b981';
                    setTimeout(() => {
                        input.style.borderColor = '#e5e7eb';
                    }, 1000);
                }
            } catch (error) {
                console.error('Failed to update score:', error);
                showAlert('Failed to update score', 'error');
            }
        }
        
        // Update team member
        async function updateTeamMember(clientId, field, value) {
            try {
                const updates = { [field]: value.toUpperCase() };
                await window.clientManager.updateClient(clientId, updates);
                
                // Visual feedback
                const input = event.target;
                if (input) {
                    input.style.borderColor = '#10b981';
                    setTimeout(() => {
                        input.style.borderColor = '#e5e7eb';
                    }, 1000);
                }
            } catch (error) {
                console.error('Failed to update team member:', error);
                showAlert('Failed to update team member', 'error');
            }
        }
        
        // Auto-save notes
        let noteSaveTimeout;
        async function autoSaveNotes(clientId, notes) {
            const statusElement = document.getElementById('noteSaveStatus');
            if (statusElement) {
                statusElement.textContent = 'Saving...';
                statusElement.classList.add('saving');
            }
            
            // Clear previous timeout
            clearTimeout(noteSaveTimeout);
            
            // Set new timeout
            noteSaveTimeout = setTimeout(async () => {
                try {
                    await window.clientManager.updateClient(clientId, { 
                        notes,
                        notesUpdatedAt: new Date().toISOString()
                    });
                    
                    if (statusElement) {
                        statusElement.textContent = 'All changes saved';
                        statusElement.classList.remove('saving');
                    }
                } catch (error) {
                    console.error('Failed to save notes:', error);
                    if (statusElement) {
                        statusElement.textContent = 'Failed to save';
                        statusElement.classList.remove('saving');
                        statusElement.style.color = '#ef4444';
                    }
                }
            }, 1000); // Save after 1 second of no typing
        }
        
        // Update completion percentage
        async function updateCompletionPercentage(clientId) {
            try {
                const client = await window.clientManager.getClient(clientId);
                const trackingFields = [
                    'needsAssessment', 'healthPhysical', 'aftercareThreadSent',
                    'optionsDocUploaded', 'dischargePacketUploaded', 'gadCompleted',
                    'phqCompleted', 'satisfactionSurvey', 'referralClosure', 
                    'dischargeSummary', 'dischargePlanningNote', 'dischargeASAM'
                ];
                
                const completed = trackingFields.filter(field => client[field]).length;
                const percentage = Math.round((completed / trackingFields.length) * 100);
                
                const percentageElement = document.querySelector('.metric-value');
                if (percentageElement) {
                    percentageElement.textContent = percentage + '%';
                    // Add animation
                    percentageElement.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        percentageElement.style.transform = 'scale(1)';
                    }, 300);
                }
            } catch (error) {
                console.error('Failed to update percentage:', error);
            }
        }
        
        // Build assessment history
        async function buildAssessmentHistory(clientId) {
            // This would fetch assessment history from your data source
            // For now, return a placeholder
            return `
                <div class="assessment-placeholder">
                    <p style="color: #6b7280; text-align: center; padding: 40px;">
                        No assessments recorded yet. Click "Add Assessment" to begin.
                    </p>
                </div>
            `;
        }
        
        // Build modern aftercare list
        function buildModernAftercareList(aftercareOptions, clientId) {
            if (!aftercareOptions || aftercareOptions.length === 0) {
                return `
                    <div class="aftercare-placeholder">
                        <p style="color: #6b7280; text-align: center; padding: 40px;">
                            No aftercare options added yet. Click "Add Option" to begin.
                        </p>
                    </div>
                `;
            }
            
            return aftercareOptions.map(option => `
                <div class="aftercare-card">
                    <div class="aftercare-header">
                        <h4>${option.programName}</h4>
                        <span class="aftercare-status status-${option.status}">${option.status}</span>
                    </div>
                    <div class="aftercare-details">
                        ${option.dateProvided ? `<p><strong>Date Provided:</strong> ${new Date(option.dateProvided).toLocaleDateString()}</p>` : ''}
                        ${option.notes ? `<p><strong>Notes:</strong> ${option.notes}</p>` : ''}
                    </div>
                    <button class="btn-secondary" onclick="removeAftercareOption('${clientId}', '${option.id}')">Remove</button>
                </div>
            `).join('');
        }
        
        // Build client timeline
        function buildClientTimeline(client, milestones, daysInCare) {
            const events = [];
            
            // Add admission event
            if (client.admissionDate) {
                events.push({
                    date: new Date(client.admissionDate),
                    type: 'admission',
                    title: 'Admitted',
                    description: `${client.initials} admitted to ${client.houseId || 'facility'}`
                });
            }
            
            // Add tracking events
            const trackingEvents = [
                { field: 'needsAssessmentDate', title: 'Needs Assessment Completed' },
                { field: 'healthPhysicalDate', title: 'Health & Physical Assessment Completed' },
                { field: 'aftercareThreadDate', title: 'Aftercare Planning Thread Sent' },
                { field: 'optionsDocDate', title: 'Options Document Uploaded' },
                { field: 'dischargePacketDate', title: 'Discharge Packet Uploaded' }
            ];
            
            trackingEvents.forEach(event => {
                if (client[event.field]) {
                    events.push({
                        date: new Date(client[event.field]),
                        type: 'tracking',
                        title: event.title
                    });
                }
            });
            
            // Add discharge event
            if (client.dischargeDate) {
                events.push({
                    date: new Date(client.dischargeDate),
                    type: 'discharge',
                    title: 'Discharged',
                    description: `After ${daysInCare} days in care`
                });
            }
            
            // Sort events by date
            events.sort((a, b) => a.date - b.date);
            
            // Build timeline HTML
            return `
                <div class="timeline">
                    ${events.map((event, index) => `
                        <div class="timeline-event ${event.type}">
                            <div class="timeline-date">${event.date.toLocaleDateString()}</div>
                            <div class="timeline-content">
                                <h4>${event.title}</h4>
                                ${event.description ? `<p>${event.description}</p>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Add aftercare option
        async function addAftercareOption(clientId) {
            // Get programs for selection
            const programs = JSON.parse(localStorage.getItem('therapyPrograms') || '[]');
            
            let programOptions = programs.map(p => 
                `<option value="${p.name}">${p.name}</option>`
            ).join('');
            
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal-content" style="width: 500px;">
                        <h3>Add Aftercare Option</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Program Name</label>
                            <select id="programSelect" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <option value="">Select a program...</option>
                                ${programOptions}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Status</label>
                            <select id="optionStatus" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <option value="pending">Pending</option>
                                <option value="sent">Sent to Family</option>
                                <option value="engaged">Family Engaged</option>
                                <option value="accepted">Accepted</option>
                                <option value="declined">Declined</option>
                                <option value="waitlist">Waitlist</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Date Provided to Family</label>
                            <input type="date" id="dateProvided" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Notes</label>
                            <textarea id="optionNotes" style="width: 100%; height: 80px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="window.closeModal()" style="padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="handleAddAftercareOption('${clientId}')" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Add Option
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add keyboard listener for ESC key
            document.addEventListener('keydown', handleModalKeydown);
            
            // Fix overlay click handling
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeModal();
                    }
                });
            }
        }
        
        // Handle add aftercare option
        async function handleAddAftercareOption(clientId) {
            try {
                const programName = document.getElementById('programSelect').value;
                const status = document.getElementById('optionStatus').value;
                const dateProvided = document.getElementById('dateProvided').value;
                const notes = document.getElementById('optionNotes').value;
                
                if (!programName) {
                    showAlert('Please select a program', 'error');
                    return;
                }
                
                await aftercareManager.addAftercareOption(clientId, {
                    programName,
                    status,
                    dateProvidedToFamily: dateProvided,
                    notes
                });
                
                showAlert('Aftercare option added successfully', 'success');
                closeModal();
                
                // Refresh the client details
                viewClientDetails(clientId);
                
                // Refresh the table
                await loadHouseView(currentHouseId);
            } catch (error) {
                console.error('Failed to add aftercare option:', error);
                showAlert(error.message || 'Failed to add aftercare option', 'error');
            }
        }
        
        // Edit client
        function editClient(clientId) {
            // This will be implemented
            console.log('Edit client:', clientId);
        }
        
        // Generate document for client
        async function generateClientDocument(clientId, options = {}) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    showAlert('Client not found', 'error');
                    return;
                }

                const contextPayload = {
                    clientId,
                    initials: client.initials || '',
                    kipuId: client.kipuId || null
                };

                window.__pendingProgramsDocsClientContext = contextPayload;

                await mountProgramsDocsModule();

                if (window.CareConnectProgramsDocs?.setClientContext) {
                    await window.CareConnectProgramsDocs.setClientContext(contextPayload);
                }

                window.__pendingProgramsDocsClientContext = null;

                if (window.clientManager?.setCurrentClient) {
                    await window.clientManager.setCurrentClient(clientId);
                }

                localStorage.setItem('currentClientId', clientId);
                switchTab('programs');

                if (options.focusSearch && window.CareConnectProgramsDocs?.focusSearch) {
                    window.CareConnectProgramsDocs.focusSearch();
                }

                if (window.CareConnect?.events) {
                    try {
                        window.CareConnect.events.emit('clients:programs-docs-opened', {
                            clientId,
                            initials: client.initials || ''
                        });
                    } catch (eventError) {
                        console.warn('Programs docs open event failed:', eventError);
                    }
                }

                showAlert(`Programs workspace ready for ${client.initials || 'client'}.`, 'success');
            } catch (error) {
                console.error('Failed to open Programs & Docs for client:', error);
                showAlert('Unable to open Programs & Docs. Please try again.', 'error');
            }
        }
        
        // Export current house
        async function exportCurrentHouse() {
            try {
                const houseData = await housesManager.exportHouseData(currentHouseId);
                const json = JSON.stringify(houseData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${houseData.house.name}_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showAlert('House data exported successfully!', 'success');
            } catch (error) {
                showAlert('Failed to export house data: ' + error.message, 'error');
            }
        }
        
        // Export all data
        function exportAllData() {
            // To be implemented with Excel export
            showAlert('Excel export will be implemented with the Excel export module', 'info');
        }
        
        // Show bulk import
        function showBulkImport() {
            // To be implemented with Excel import
            showAlert('Excel import will be implemented with the Excel import module', 'info');
        }
        
        // Show reports
        function showReports() {
            // To be implemented with reporting module
            showAlert('Reports will be implemented with the reporting module', 'info');
        }
        
        // Toggle milestone completion
        async function toggleMilestone(clientId, milestoneId) {
            try {
                await milestonesManager.toggleMilestone(clientId, milestoneId);
                await loadHouseView(currentHouseId); // Refresh the view
            } catch (error) {
                console.error('Failed to toggle milestone:', error);
                showAlert('Failed to update milestone', 'error');
            }
        }
        
        // Reset database
        async function resetDatabase() {
            if (confirm('This will clear all local data and reload the page. Continue?')) {
                try {
                    await clearIndexedDB();
                    localStorage.clear();
                    localStorage.clear();
                    showAlert('Database cleared. Reloading...', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } catch (error) {
                    showAlert('Failed to reset database: ' + error.message, 'error');
                }
            }
        }
    </script>
    <!-- Initialize Service Worker -->
    <script>
        // Function to clear IndexedDB if needed
        async function clearIndexedDB() {
            try {
                await indexedDB.deleteDatabase('CareConnectPro');
                console.log('Database cleared successfully');
                return true;
            } catch (error) {
                console.error('Failed to clear database:', error);
                return false;
            }
        }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                });
            }
            // Force reload with cache bypass
            window.location.reload(true);
        };
        
        // Function to load script with retry
        function loadScript(src, retries = 3) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${src}?v=${cacheBust}`;
                script.onload = () => {
                    console.log(`‚úÖ Loaded: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    if (retries > 0) {
                        console.warn(`‚ö†Ô∏è Retrying ${src}... (${retries} attempts left)`);
                        setTimeout(() => loadScript(src, retries - 1).then(resolve).catch(reject), 500);
                    } else {
                        console.error(`‚ùå Failed to load: ${src}`);
                        reject(new Error(`Failed to load ${src}`));
                    }
                };
                document.head.appendChild(script);
            });
        }
        
        // Load core scripts
        const scripts = [
            'feature-flags.js',
            'performance-monitor.js', 
            'indexed-db-manager.js',
            'intelligent-matching.js',
            'multi-client-workflow.js',
            'advanced-filters.js',
            'client-manager.js',
            'demo-data-generator.js',
            'tracker-engine.js',
            'morning-review-dashboard.js',
            'tracker-timeline.js',
            'tracker-bulk-update.js',
            'tracker-aftercare-cascade.js',
            'discharge-checklist.js',
            'houses-manager.js',
            'milestones-manager.js',
            'aftercare-manager.js',
            'document-generator.js'
        ];
        
        // Load scripts sequentially to ensure proper order
        Promise.all(scripts.map(src => loadScript(src))).then(() => {
            console.log('‚úÖ All core scripts loaded');
            
            // Load dashboard scripts after core scripts
            const dashboardScripts = [
                'dashboard-manager.js',
                'dashboard-widgets.js',
                // 'enhancements/onboarding-integration.js' // REMOVED: Unused
            ];
            return Promise.all(dashboardScripts.map(src => loadScript(src)));
        }).then(() => {
            console.log('‚úÖ All dashboard scripts loaded');
            
            // Make dashboard manager globally available
            if (typeof dashboardManager !== 'undefined') {
                window.dashboardManager = dashboardManager;
            }
            if (typeof dashboardWidgets !== 'undefined') {
                window.dashboardWidgets = dashboardWidgets;
            }
            
            // Load demo data loader in development
            if (window.location.hostname === 'localhost') {
                loadScript('demo-data-loader.js').then(() => {
                    console.log('‚úÖ Demo data loader initialized');
                }).catch(err => {
                    console.warn('Demo data loader not found (optional)');
                });
            }
            
            // Handle IndexedDB version errors - Handled gracefully in initializeEnhancedFeatures
            // window.addEventListener('error', function(event) {
            //    if (event.message && event.message.includes('VersionError')) {
            //        console.error('üîÑ IndexedDB version mismatch detected. Please clear cache.');
            //        if (confirm('IndexedDB version mismatch detected. Clear cache and reload?')) {
            //            window.clearCacheAndReload();
            //        }
            //    }
            // });
            
            // Initialize enhanced features now that all scripts are loaded
            return initializeEnhancedFeatures();
        }).catch(error => {
            console.error('‚ùå Script loading error:', error);
        });
    
// Enhancement: global-helpers.js
/**
 * Global Helper Functions for CareConnect Pro
 * Ensures all commonly used functions are available globally
 */

(function() {
    'use strict';
    
    // Ensure window object exists
    if (typeof window === 'undefined') return;
    
    // ============= NOTIFICATION SYSTEM =============
    
    /**
     * Show notification message to user
     * @param {string} message - The message to display
     * @param {string} type - Type of notification: 'success', 'error', 'warning', 'info'
     * @param {string} title - Optional title for the notification
     * @param {number} duration - Duration in milliseconds (default: 3000)
     */
    window.showNotification = window.showNotification || function(message, type = 'info', title = '', duration = 3000) {
        console.log(`[${type.toUpperCase()}] ${title ? title + ': ' : ''}${message}`);
        
        // Remove any existing notification
        const existingNotification = document.querySelector('.global-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `global-notification notification-${type}`;
        
        // Icon mapping
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };
        
        // Build notification HTML
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">${icons[type] || icons.info}</span>
                <div class="notification-text">
                    ${title ? `<strong>${title}</strong><br>` : ''}
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.closest('.global-notification').remove()">√ó</button>
            </div>
        `;
        
        // Add to document
        document.body.appendChild(notification);
        
        // Auto-remove after duration
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('fade-out');
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }
    };
    
    // ============= MODAL SYSTEM =============
    
    const MODAL_CLOSE_SELECTORS = [
        '.global-modal-overlay',
        '.modal-overlay',
        '.tracker-modal-overlay',
        '.timeline-modal-overlay',
        '.document-hub-overlay',
        '.cc-generic-modal',
        '.floating-modal',
        '.modal-backdrop',
        '#globalModal'
    ];
    
    function getAllModalElements() {
        const nodes = [];
        MODAL_CLOSE_SELECTORS.forEach(selector => {
            nodes.push(...document.querySelectorAll(selector));
        });
        return nodes;
    }
    
    function collectModalTargets(target) {
        if (!target) {
            return getAllModalElements();
        }
        if (typeof target === 'string') {
            return Array.from(document.querySelectorAll(target));
        }
        if (target instanceof Element) {
            return [target];
        }
        if (typeof NodeList !== 'undefined' && target instanceof NodeList) {
            return Array.from(target).filter(Boolean);
        }
        if (typeof HTMLCollection !== 'undefined' && target instanceof HTMLCollection) {
            return Array.from(target).filter(Boolean);
        }
        if (Array.isArray(target)) {
            return target.filter(el => el instanceof Element);
        }
        return [];
    }
    
    function removeModalElement(element) {
        if (!element || !element.parentElement) {
            return;
        }
        element.classList?.add?.('fade-out');
        const delay = element.classList?.contains?.('fade-out') ? 180 : 0;
        setTimeout(() => {
            if (element.parentElement) {
                element.remove();
            }
        }, delay);
    }
    
    function uniqueModalElements(elements) {
        const seen = new Set();
        return elements.filter(el => {
            if (!el || !el.isConnected || seen.has(el)) {
                return false;
            }
            seen.add(el);
            return true;
        });
    }
    
    function hasActiveModals() {
        return getAllModalElements().length > 0;
    }
    
    function closePanelsWithEscape() {
        let closed = false;
        
        if (typeof window.toggleMenu === 'function') {
            const menu = document.getElementById('slideMenu');
            if (menu && menu.classList.contains('active')) {
                window.toggleMenu(false);
                closed = true;
            }
        }
        
        if (typeof window.toggleHistory === 'function') {
            const historyPanel = document.getElementById('historyPanel');
            if (historyPanel && historyPanel.classList.contains('open')) {
                window.toggleHistory();
                closed = true;
            }
        }
        
        if (typeof window.closeComparison === 'function') {
            const comparisonView = document.getElementById('comparisonView');
            if (comparisonView && comparisonView.style.display !== 'none') {
                window.closeComparison();
                closed = true;
            }
        }
        
        return closed;
    }
    
    window.handleModalKeydown = window.handleModalKeydown || function handleModalKeydown(event) {
        if (event.key !== 'Escape') {
            return;
        }
        
        if (hasActiveModals()) {
            window.closeModal();
            return;
        }
        
        if (closePanelsWithEscape()) {
            return;
        }
    };
    
    if (!window.__modalKeyListenerBound) {
        document.addEventListener('keydown', window.handleModalKeydown);
        window.__modalKeyListenerBound = true;
    }
    
    /**
     * Close open modal elements
     * @param {Element|string|NodeList|Array} target - Optional target(s) to close
     */
    window.closeModal = function closeModal(target) {
        const elements = uniqueModalElements(collectModalTargets(target));
        if (!elements.length) {
            return;
        }
        elements.reverse().forEach(removeModalElement);
    };
    
    /**
     * Show modal dialog
     * @param {Object} options - Modal configuration
     * @param {string} options.title - Modal title
     * @param {string} options.content - HTML content
     * @param {Array} options.buttons - Array of button objects {text, action, primary}
     * @param {boolean} options.closeOnOverlay - Close when clicking overlay (default: true)
     * @param {string} options.size - Modal size: 'small', 'medium', 'large' (default: 'medium')
     */
    window.showModal = window.showModal || function(options = {}) {
        // Remove any existing modal
        window.closeModal();
        
        // Default options
        const defaults = {
            title: 'Modal',
            content: '',
            buttons: [{text: 'Close', action: () => window.closeModal()}],
            closeOnOverlay: true,
            size: 'medium'
        };
        
        const config = Object.assign({}, defaults, options);
        
        // Create modal elements
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay global-modal-overlay';
        overlay.id = 'globalModal';
        
        const modal = document.createElement('div');
        modal.className = `modal-content global-modal-content modal-${config.size}`;
        
        // Build modal HTML
        modal.innerHTML = `
            <div class="modal-header">
                <h3 class="modal-title">${config.title}</h3>
                <button class="modal-close" onclick="window.closeModal(this.closest('.global-modal-overlay'))">&times;</button>
            </div>
            <div class="modal-body">
                ${config.content}
            </div>
            ${config.buttons.length > 0 ? `
                <div class="modal-footer">
                    ${config.buttons.map(btn => `
                        <button class="btn ${btn.primary ? 'btn-primary' : 'btn-secondary'}" 
                                onclick="(${btn.action.toString()})()">${btn.text}</button>
                    `).join('')}
                </div>
            ` : ''}
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // Close on overlay click if enabled
        if (config.closeOnOverlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    window.closeModal(overlay);
                }
            });
        }
        
        // Focus management
        modal.focus();
        
        // Trap focus within modal
        const focusableElements = modal.querySelectorAll('button, input, select, textarea, a[href]');
        if (focusableElements.length > 0) {
            focusableElements[0].focus();
        }
    };
    
    // ============= NAVIGATION HELPERS =============
    
    /**
     * View client details
     * @param {string|Object} clientOrId - Client ID or client object
     */
    window.viewClientDetails = window.viewClientDetails || async function(clientOrId) {
        try {
            let client;
            
            // Handle both ID and object
            if (typeof clientOrId === 'string') {
                if (!window.clientManager) {
                    window.showNotification('Client manager not available', 'error');
                    return;
                }
                client = await window.clientManager.getClient(clientOrId);
            } else {
                client = clientOrId;
            }
            
            if (!client) {
                window.showNotification('Client not found', 'error');
                return;
            }
            
            // Switch to clients tab
            if (window.switchTab) {
                window.switchTab('clients');
            }
            
            // Show client details after a short delay
            setTimeout(() => {
                if (window.showClientDetailsModal) {
                    window.showClientDetailsModal(client);
                } else {
                    console.log('Client details modal not available, client:', client);
                    window.showNotification(`Viewing client: ${client.initials}`, 'info');
                }
            }, 100);
        } catch (error) {
            console.error('Error viewing client details:', error);
            window.showNotification('Failed to view client details', 'error');
        }
    };
    
    /**
     * Switch to a specific house view
     * @param {string} houseId - House ID to switch to
     */
    window.switchToHouse = window.switchToHouse || async function(houseId) {
        try {
            // Switch to clients tab first
            if (window.switchTab) {
                window.switchTab('clients');
            }
            
            // Wait for tab to load
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Find and click house filter button
            const houseButtons = document.querySelectorAll('.house-filter-btn');
            for (const btn of houseButtons) {
                if (btn.textContent.includes(houseId) || btn.dataset.house === houseId) {
                    btn.click();
                    window.showNotification(`Switched to ${houseId}`, 'success');
                    return;
                }
            }
            
            console.warn('House not found:', houseId);
            window.showNotification(`House ${houseId} not found`, 'warning');
        } catch (error) {
            console.error('Error switching house:', error);
            window.showNotification('Failed to switch house', 'error');
        }
    };
    
    // ============= UTILITY HELPERS =============
    
    /**
     * Debounce function execution
     * @param {Function} func - Function to debounce
     * @param {number} wait - Milliseconds to wait
     * @param {boolean} immediate - Execute immediately
     */
    window.debounce = window.debounce || function(func, wait, immediate) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            const later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };
    
    /**
     * Format date for display
     * @param {string|Date} date - Date to format
     * @param {boolean} includeTime - Include time in format
     */
    window.formatDate = window.formatDate || function(date, includeTime = false) {
        if (!date) return '';
        
        const d = new Date(date);
        if (isNaN(d.getTime())) return '';
        
        const options = {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        };
        
        if (includeTime) {
            options.hour = '2-digit';
            options.minute = '2-digit';
        }
        
        return d.toLocaleDateString('en-US', options);
    };
    
    /**
     * Calculate days between dates
     * @param {string|Date} date1 - First date
     * @param {string|Date} date2 - Second date (defaults to today)
     */
    window.daysBetween = window.daysBetween || function(date1, date2 = new Date()) {
        const d1 = new Date(date1);
        const d2 = new Date(date2);
        const diffTime = Math.abs(d2 - d1);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    };
    
    /**
     * Deep clone an object
     * @param {*} obj - Object to clone
     */
    window.deepClone = window.deepClone || function(obj) {
        if (obj === null || typeof obj !== 'object') return obj;
        if (obj instanceof Date) return new Date(obj.getTime());
        if (obj instanceof Array) return obj.map(item => window.deepClone(item));
        if (obj instanceof Object) {
            const cloned = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    cloned[key] = window.deepClone(obj[key]);
                }
            }
            return cloned;
        }
    };
    
    // ============= STYLES FOR NOTIFICATIONS AND MODALS =============
    
    if (!document.querySelector('#global-helpers-styles')) {
        const styles = document.createElement('style');
        styles.id = 'global-helpers-styles';
        styles.textContent = `
            /* Global Notification Styles */
            .global-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                max-width: 400px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 100000;
                animation: slideInRight 0.3s ease;
                border-left: 4px solid;
            }
            
            .global-notification.fade-out {
                animation: slideOutRight 0.3s ease;
            }
            
            .notification-content {
                display: flex;
                align-items: flex-start;
                padding: 16px;
                gap: 12px;
            }
            
            .notification-icon {
                font-size: 20px;
                flex-shrink: 0;
            }
            
            .notification-text {
                flex: 1;
                font-size: 14px;
                line-height: 1.5;
            }
            
            .notification-close {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                opacity: 0.5;
                transition: opacity 0.2s;
            }
            
            .notification-close:hover {
                opacity: 1;
            }
            
            /* Notification Types */
            .notification-success {
                border-left-color: #22c55e;
            }
            
            .notification-error {
                border-left-color: #ef4444;
            }
            
            .notification-warning {
                border-left-color: #f59e0b;
            }
            
            .notification-info {
                border-left-color: #3b82f6;
            }
            
            /* Global Modal Styles */
            .global-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                animation: fadeIn 0.2s ease;
            }
            
            .global-modal-overlay.fade-out {
                animation: fadeOut 0.2s ease;
            }
            
            .global-modal-content {
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                animation: modalSlideIn 0.3s ease;
            }
            
            .global-modal-content.modal-small {
                width: 400px;
            }
            
            .global-modal-content.modal-medium {
                width: 600px;
            }
            
            .global-modal-content.modal-large {
                width: 800px;
            }
            
            .modal-header {
                padding: 20px;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .modal-title {
                margin: 0;
                font-size: 20px;
                font-weight: 600;
            }
            
            .modal-close {
                background: none;
                border: none;
                font-size: 28px;
                cursor: pointer;
                opacity: 0.5;
                transition: opacity 0.2s;
                line-height: 1;
            }
            
            .modal-close:hover {
                opacity: 1;
            }
            
            .modal-body {
                padding: 20px;
                overflow-y: auto;
                flex: 1;
            }
            
            .modal-footer {
                padding: 20px;
                border-top: 1px solid #e5e7eb;
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            }
            
            /* Animations */
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            @keyframes modalSlideIn {
                from {
                    transform: translateY(-20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(styles);
    }
    
    console.log('‚úÖ Global helpers loaded successfully');
})();





// Enhancement: event-system.js
/**
 * Event System Enhancement
 * Implements a publish-subscribe event system for real-time updates
 */

(function() {
    'use strict';
    
    // Create event bus
    window.eventBus = {
        listeners: new Map(),
        
        /**
         * Subscribe to an event
         * @param {string} eventName - Name of the event
         * @param {Function} callback - Function to call when event fires
         * @param {Object} options - Options for subscription
         * @returns {Function} Unsubscribe function
         */
        on(eventName, callback, options = {}) {
            if (!this.listeners.has(eventName)) {
                this.listeners.set(eventName, new Set());
            }
            
            const listener = {
                callback,
                once: options.once || false,
                priority: options.priority || 0
            };
            
            this.listeners.get(eventName).add(listener);
            
            // Return unsubscribe function
            return () => {
                const listeners = this.listeners.get(eventName);
                if (listeners) {
                    listeners.delete(listener);
                }
            };
        },
        
        /**
         * Subscribe to an event once
         * @param {string} eventName - Name of the event
         * @param {Function} callback - Function to call when event fires
         */
        once(eventName, callback) {
            return this.on(eventName, callback, { once: true });
        },
        
        /**
         * Emit an event
         * @param {string} eventName - Name of the event
         * @param {*} data - Data to pass to listeners
         */
        emit(eventName, data) {
            const listeners = this.listeners.get(eventName);
            if (!listeners || listeners.size === 0) return;
            
            // Convert to array and sort by priority
            const sortedListeners = Array.from(listeners).sort((a, b) => b.priority - a.priority);
            
            sortedListeners.forEach(listener => {
                try {
                    listener.callback(data);
                    
                    // Remove if one-time listener
                    if (listener.once) {
                        listeners.delete(listener);
                    }
                } catch (error) {
                    console.error(`Error in event listener for ${eventName}:`, error);
                }
            });
            
            // Also emit wildcard event
            if (eventName !== '*') {
                this.emit('*', { eventName, data });
            }
        },
        
        /**
         * Remove all listeners for an event
         * @param {string} eventName - Name of the event
         */
        off(eventName) {
            this.listeners.delete(eventName);
        },
        
        /**
         * Get all listeners for an event
         * @param {string} eventName - Name of the event
         * @returns {Set} Set of listeners
         */
        getListeners(eventName) {
            return this.listeners.get(eventName) || new Set();
        }
    };
    
    // Enhance clientManager with events
    function enhanceClientManager() {
        if (!window.clientManager) return;
        
        const originalUpdateClient = window.clientManager.updateClient;
        window.clientManager.updateClient = async function(clientId, updates) {
            const oldClient = await this.getClient(clientId);
            const result = await originalUpdateClient.call(this, clientId, updates);
            const newClient = await this.getClient(clientId);
            
            // Emit update event
            window.eventBus.emit('client:updated', {
                clientId,
                oldData: oldClient,
                newData: newClient,
                changes: updates
            });
            
            // Check for specific tracker updates
            const trackerFields = Object.keys(updates).filter(key => 
                key.includes('Assessment') || 
                key.includes('Doc') || 
                key.includes('Packet') ||
                key.includes('discharge') ||
                key.includes('aftercare')
            );
            
            if (trackerFields.length > 0) {
                window.eventBus.emit('tracker:updated', {
                    clientId,
                    fields: trackerFields,
                    updates
                });
            }
            
            return result;
        };
        
        const originalCreateClient = window.clientManager.createClient;
        window.clientManager.createClient = async function(clientData) {
            const result = await originalCreateClient.call(this, clientData);
            
            // Emit create event
            window.eventBus.emit('client:created', {
                client: result
            });
            
            return result;
        };
        
        const originalDeleteClient = window.clientManager.deleteClient;
        if (originalDeleteClient) {
            window.clientManager.deleteClient = async function(clientId) {
                const client = await this.getClient(clientId);
                const result = await originalDeleteClient.call(this, clientId);
                
                // Emit delete event
                window.eventBus.emit('client:deleted', {
                    clientId,
                    client
                });
                
                return result;
            };
        }
    }
    
    // Subscribe to events for dashboard updates
    function setupDashboardSubscriptions() {
        // Debounce dashboard refresh
        let refreshTimeout;
        const debouncedRefresh = () => {
            clearTimeout(refreshTimeout);
            refreshTimeout = setTimeout(() => {
                if (window.dashboardManager?.refreshDashboard) {
                    window.dashboardManager.refreshDashboard();
                }
            }, 300); // Wait 300ms before refreshing
        };
        
        // Listen for client updates
        window.eventBus.on('client:updated', (data) => {
            console.log('Client updated:', data.clientId);
            
            // Invalidate cache
            if (window.dashboardManager?.cache) {
                delete window.dashboardManager.cache.clients;
                delete window.dashboardManager.cache.priorities;
            }
            
            // Refresh dashboard
            debouncedRefresh();
        });
        
        // Listen for tracker updates
        window.eventBus.on('tracker:updated', (data) => {
            console.log('Tracker updated:', data.clientId, data.fields);
            
            // Update specific widgets if they exist
            if (window.dashboardWidgets?.widgets) {
                const flightPlan = window.dashboardWidgets.widgets.get('flightPlan');
                if (flightPlan?.refresh) {
                    flightPlan.refresh();
                }
                
                const journeyRadar = window.dashboardWidgets.widgets.get('journeyRadar');
                if (journeyRadar?.refresh) {
                    journeyRadar.refresh();
                }
            }
        });
        
        // Listen for document events
        window.eventBus.on('document:generated', (data) => {
            console.log('Document generated:', data.documentType, 'for client:', data.clientId);
            
            // Show success notification
            window.showNotification('Document generated and tracker updated', 'success');
            
            // Update relevant widgets
            debouncedRefresh();
        });
        
        // Listen for all events in dev mode
        if (window.featureFlags && typeof window.featureFlags.isEnabled === 'function' && window.featureFlags.isEnabled('devMode')) {
            window.eventBus.on('*', (event) => {
                console.log(`[Event] ${event.eventName}:`, event.data);
            });
        }
    }
    
    // Enhance widget refresh capabilities
    function enhanceWidgetRefresh() {
        if (!window.dashboardWidgets?.widgets) return;
        
        // Add refresh method to all widgets
        window.dashboardWidgets.widgets.forEach((widget, name) => {
            if (!widget.refresh) {
                widget.refresh = function() {
                    const container = this.container;
                    if (container) {
                        // Re-render the widget
                        container.innerHTML = this.render();
                        console.log(`Refreshed widget: ${name}`);
                    }
                };
            }
        });
    }
    
    // Setup cache invalidation
    window.cacheManager = {
        invalidate(key) {
            if (window.dashboardManager?.cache) {
                if (key) {
                    delete window.dashboardManager.cache[key];
                    console.log(`Cache invalidated: ${key}`);
                } else {
                    // Clear all cache
                    Object.keys(window.dashboardManager.cache).forEach(k => {
                        delete window.dashboardManager.cache[k];
                    });
                    console.log('All cache cleared');
                }
            }
        },
        
        invalidateClient(clientId) {
            // Invalidate specific client-related caches
            this.invalidate('clients');
            this.invalidate('priorities');
            this.invalidate(`client-${clientId}`);
        },
        
        invalidateAll() {
            this.invalidate();
        }
    };
    
    // Listen for cache invalidation events
    window.eventBus.on('cache:invalidate', (data) => {
        window.cacheManager.invalidate(data.key);
    });
    
    window.eventBus.on('cache:invalidateClient', (data) => {
        window.cacheManager.invalidateClient(data.clientId);
    });
    
    function ensureDashboardTheme() {
        const dashboardTab = document.getElementById('dashboardTab');
        if (dashboardTab && dashboardTab.classList.contains('active')) {
            document.body.classList.add('dashboard-active');
            document.body.classList.remove('programs-docs-v2-active');
            document.body.style.background = 'white';
            document.body.style.color = '#1a1a1a';
        }
    }
    window.ensureDashboardTheme = ensureDashboardTheme;
    
    // Add global refresh function
    window.refreshDashboard = function(immediate = false) {
        ensureDashboardTheme();
        if (immediate) {
            window.cacheManager.invalidateAll();
            if (typeof initializeDashboard === 'function') {
                initializeDashboard(true);
            }
        } else {
            window.eventBus.emit('dashboard:refresh');
        }
    };

    window.populateDemoClients = async function(count = 50) {
        // In non-demo mode, treat this as a no-op to prevent accidental demo data in production
        if (!window.ccConfig?.demoMode) {
            window.showNotification('Demo data is disabled in this environment.', 'info');
            return;
        }
        
        console.log('populateDemoClients called with count:', count);
        
        // Wait for ClientManager to be ready
        let retries = 10;
        while (!window.clientManager && retries > 0) {
            console.log('Waiting for ClientManager to initialize...');
            await new Promise(resolve => setTimeout(resolve, 500));
            retries--;
        }
        
        // Check if demo data generator is available
        if (!window.demoDataGenerator) {
            console.error('Demo data generator not available');
            window.showNotification('Demo data generator not loaded', 'error');
            return;
        }
        
        if (!window.clientManager?.generateDemoClients) {
            console.error('ClientManager.generateDemoClients not available');
            window.showNotification('Client manager not ready', 'error');
            return;
        }
        
        const confirmed = window.confirm(
            `Populate demo clients?\n\nThis will remove existing demo clients and create ${count} fresh records for testing.`
        );
        if (!confirmed) return;
        
        try {
            window.showNotification('üé≠ Creating demo clients‚Ä¶', 'info');
            console.log('Calling clientManager.generateDemoClients...');
            const created = await window.clientManager.generateDemoClients(count);
            console.log('Created clients:', created);
            window.showNotification(`‚úÖ Added ${created.length} demo clients`, 'success');
            
            // Force dashboard refresh
            if (window.dashboardManager) {
                console.log('Refreshing dashboard...');
                await window.dashboardManager.refreshDashboard();
            }
            
            if (typeof initializeDashboard === 'function') {
                console.log('Re-initializing dashboard...');
                await initializeDashboard(true);
            }
            
            // Also refresh widgets directly
            if (window.dashboardWidgets?.renderAll) {
                console.log('Re-rendering widgets...');
                await window.dashboardWidgets.renderAll();
            }

            // If the Clients tab is active, refresh the CM Tracker view too
            const clientsTab = document.getElementById('clientsTab');
            if (clientsTab && clientsTab.classList.contains('active')) {
                if (typeof initializeCMTracker === 'function') {
                    console.log('Re-initializing CM Tracker after demo populate...');
                    await initializeCMTracker();
                } else if (typeof initializeClientTracker === 'function') {
                    console.log('Re-initializing legacy client tracker after demo populate...');
                    initializeClientTracker();
                }
            }
        } catch (error) {
            console.error('Failed to generate demo clients:', error);
            window.showNotification('Failed to generate demo clients: ' + error.message, 'error');
        }
    };
    
    // Listen for refresh requests
    let globalRefreshTimeout;
    window.eventBus.on('dashboard:refresh', () => {
        clearTimeout(globalRefreshTimeout);
        globalRefreshTimeout = setTimeout(() => {
            window.cacheManager.invalidateAll();
            if (typeof initializeDashboard === 'function') {
                initializeDashboard(true);
            }
        }, 300);
    });
    
    // Wait for dependencies and initialize
    function initialize() {
        enhanceClientManager();
        setupDashboardSubscriptions();
        enhanceWidgetRefresh();
        
        console.log('‚úÖ Event system initialized');
    }
    
    // Check if dependencies are loaded
    if (window.clientManager && window.dashboardManager) {
        initialize();
    } else {
        // Wait for dependencies
        const checkInterval = setInterval(() => {
            if (window.clientManager && window.dashboardManager) {
                clearInterval(checkInterval);
                initialize();
            }
        }, 100);
        
        // Timeout after 10 seconds
        setTimeout(() => {
            clearInterval(checkInterval);
            console.warn('Event system: Some dependencies not loaded');
            initialize(); // Try anyway
        }, 10000);
    }
    
    // Expose event system info
    window.eventSystemInfo = {
        getEventCount() {
            let count = 0;
            window.eventBus.listeners.forEach(listeners => {
                count += listeners.size;
            });
            return count;
        },
        
        getEvents() {
            return Array.from(window.eventBus.listeners.keys());
        },
        
        debugEvent(eventName) {
            const listeners = window.eventBus.getListeners(eventName);
            console.log(`Event "${eventName}" has ${listeners.size} listeners:`, listeners);
        }
    };
    
})();





// Enhancement: bugfixes.js
// Bugfixes for CareConnect Pro - ES6+ Modernized

console.log('üîß Bugfixes loaded');

// Fix for missing initializeEnhancedFeatures function
window.initializeEnhancedFeatures ??= function initializeEnhancedFeatures() {
    if (window.__enhancedFeaturesPromise) {
        return window.__enhancedFeaturesPromise;
    }
    
    window.__enhancedFeaturesPromise = (async () => {
        console.log('üöÄ Initializing enhanced features...');
        try {
            // Feature flags
            if (typeof FeatureFlagManager !== 'undefined' && !window.featureFlags) {
                window.featureFlags = new FeatureFlagManager();
                console.log('‚úÖ Feature flags initialized');
            }
            
            // Performance monitor
            if (typeof PerformanceMonitor !== 'undefined' && !window.performanceMonitor) {
                window.performanceMonitor = new PerformanceMonitor();
            }
            
            // IndexedDB manager
            if (typeof IndexedDBManager !== 'undefined' && !window.dbManager) {
                const dbManager = new IndexedDBManager();
                try {
                    await dbManager.init();
                } catch (error) {
                    if (error?.name === 'VersionError' && typeof clearIndexedDB === 'function') {
                        console.warn('Database version mismatch, clearing IndexedDB...');
                        await clearIndexedDB();
                        await dbManager.init();
                    } else {
                        throw error;
                    }
                }
                window.dbManager = dbManager;
                console.log('‚úÖ IndexedDB Manager initialized');
            }
            
            if (!window.dbManager) {
                throw new Error('IndexedDB Manager not available');
            }
            
            // Client manager
            if (typeof ClientManager !== 'undefined' && !window.clientManager) {
                window.clientManager = new ClientManager(window.dbManager);
                if (typeof window.clientManager.initialize === 'function') {
                    await window.clientManager.initialize();
                }
                console.log('‚úÖ ClientManager initialized');
            }
            
            // Houses manager
            if (typeof HousesManager !== 'undefined' && !window.housesManager) {
                const housesManager = new HousesManager(window.dbManager);
                if (typeof housesManager.initialize === 'function') {
                    await housesManager.initialize();
                }
                window.housesManager = housesManager;
            }
            
            // Milestones manager
            if (typeof MilestonesManager !== 'undefined' && !window.milestonesManager) {
                const milestonesManager = new MilestonesManager(window.dbManager);
                if (typeof milestonesManager.initialize === 'function') {
                    await milestonesManager.initialize();
                }
                window.milestonesManager = milestonesManager;
            }
            
            // Aftercare manager
            if (typeof AftercareManager !== 'undefined' && !window.aftercareManager) {
                const aftercareManager = new AftercareManager(window.dbManager);
                if (typeof aftercareManager.initialize === 'function') {
                    await aftercareManager.initialize();
                }
                window.aftercareManager = aftercareManager;
            }
            
            // Dashboard manager
            if (typeof DashboardManager !== 'undefined' && !window.dashboardManager) {
                window.dashboardManager = new DashboardManager();
                if (typeof window.dashboardManager.initialize === 'function') {
                    await window.dashboardManager.initialize();
                }
            }
            
            console.log('‚úÖ Enhanced features initialized');
        } catch (error) {
            console.error('‚ùå Failed to initialize enhanced features:', error);
            throw error;
        }
    })();
    
    return window.__enhancedFeaturesPromise;
};

// Fix for database initialization issues
document.addEventListener('DOMContentLoaded', () => {
    // Ensure programs are loaded
    if (!window.programs?.length) {
        console.warn('‚ö†Ô∏è Programs not loaded, attempting to initialize...');
        
        // Check again after a delay
        setTimeout(() => {
            if (!window.programs?.length) {
                console.error('‚ùå Programs still not loaded - check main HTML file');
            } else {
                console.log('‚úÖ Programs loaded:', window.programs.length, 'programs');
            }
        }, 1000);
    } else {
        console.log('‚úÖ Programs already loaded:', window.programs.length, 'programs');
    }
    
    // Fix for dashboard not showing
    const dashboardTab = document.getElementById('dashboardTab');
    if (dashboardTab?.style.display === 'none') {
        console.log('üîß Fixing hidden dashboard tab');
        dashboardTab.style.display = '';
    }
});

// Fix for Chrome extension file:// protocol issues
if (window.location.protocol === 'file:') {
    // Disable service worker registration for file protocol
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register = () => {
            console.log('Service Worker registration disabled for file:// protocol');
            return Promise.reject(new Error('Service Worker not supported on file:// protocol'));
        };
    }
}

// Login screen visibility is now managed entirely by login-robust.js
// Removed conflicting ensureLoginScreenVisible function to prevent conflicts

console.log('‚úÖ Bugfixes applied');

// Enhancement: features.js

// Custom Features - Add your custom JavaScript here

// Example: Add a custom keyboard shortcut
/*
document.addEventListener('keydown', function(e) {
    // Ctrl+Shift+S to quick save
    if (e.ctrlKey && e.shiftKey && e.key === 'S') {
        e.preventDefault();
        console.log('Quick save triggered!');
        // Add your save logic here
    }
});
*/

// Example: Add custom logging
console.log('CareConnect Pro - Enhanced Version Loaded');


// Enhancement: coach-profiles.js
// Enhanced Coach Profile System for CareConnect Pro - ES6+ Modernized
// Links user accounts to coach profiles with caseload management

(() => {
    'use strict';
    
    console.log('üë• Coach Profile Enhancement loaded');
    
    // Coach profile storage key
    const COACH_PROFILES_KEY = 'careconnect_coach_profiles';
    
    // Coach profile management
    const CoachProfiles = {
        // Get all coach profiles
        getAll() {
            const stored = localStorage.getItem(COACH_PROFILES_KEY);
            return stored ? JSON.parse(stored) : {};
        },
        
        // Save coach profiles
        saveAll(profiles) {
            localStorage.setItem(COACH_PROFILES_KEY, JSON.stringify(profiles));
        },
        
        // Create or update coach profile
        update(username, profileData) {
            const profiles = this.getAll();
            profiles[username] = {
                ...profiles[username],
                ...profileData,
                lastUpdated: new Date().toISOString()
            };
            this.saveAll(profiles);
            return profiles[username];
        },
        
        // Get coach profile for username
        get(username) {
            const profiles = this.getAll();
            return profiles[username] || null;
        }
    };
    
    // Generate initials from name
    const generateInitials = (name, max = 2) => {
        if (!name) return '';
        
        const parts = name.trim().split(/\s+/);
        return parts
            .map(part => part[0]?.toUpperCase() || '')
            .filter(Boolean)
            .slice(0, max)
            .join('') || name.substring(0, 2).toUpperCase();
    };
    
    // Enhanced getCurrentCoach that uses actual user data
    window.getEnhancedCurrentCoach = () => {
        const username = localStorage.getItem('username');
        const fullName = localStorage.getItem('fullName');
        const userRole = localStorage.getItem('userRole') || 'coach';
        const isMaster = localStorage.getItem('isMaster') === 'true';
        
        // Get stored profile
        let profile = CoachProfiles.get(username);
        
        // If no profile exists, create default from session data
        if (!profile && username) {
            profile = CoachProfiles.update(username, {
                username,
                fullName: fullName || username,
                initials: generateInitials(fullName || username),
                role: userRole,
                isAdmin: userRole === 'admin' || isMaster,
                department: '',
                phoneExtension: '',
                specializations: [],
                maxCaseload: 12,
                currentCaseload: 0
            });
        }
        
        return profile || {
            username: 'guest',
            fullName: 'Guest User',
            initials: 'GU',
            role: 'viewer',
            isAdmin: false
        };
    };
    
    // Enhanced profile setup dialog
    window.showCoachProfileSetup = (isFirstTime = false) => {
        const currentProfile = window.getEnhancedCurrentCoach();
        
        const dialogHtml = `
            <div class="modal-overlay" id="coachProfileModal">
                <div class="modal-content" style="max-width: 500px;">
                    <h2 style="margin-bottom: 20px;">
                        ${isFirstTime ? 'üëã Complete Your Coach Profile' : '‚öôÔ∏è Update Coach Profile'}
                    </h2>
                    
                    ${isFirstTime ? `
                        <p style="color: #666; margin-bottom: 20px;">
                            Let's set up your coach profile to personalize your experience and manage your caseload effectively.
                        </p>
                    ` : ''}
                    
                    <form id="coachProfileForm">
                        <div class="form-group">
                            <label>Full Name <span class="required">*</span></label>
                            <input type="text" id="profileFullName" value="${currentProfile.fullName}" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Coach Initials <span class="required">*</span></label>
                            <input type="text" id="profileInitials" value="${currentProfile.initials}" maxlength="3" required 
                                style="text-transform: uppercase;" placeholder="e.g., JD">
                            <small>Used to identify your clients in the system</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Department</label>
                            <select id="profileDepartment">
                                <option value="">Select Department</option>
                                <option value="clinical" ${currentProfile.department === 'clinical' ? 'selected' : ''}>Clinical</option>
                                <option value="residential" ${currentProfile.department === 'residential' ? 'selected' : ''}>Residential</option>
                                <option value="education" ${currentProfile.department === 'education' ? 'selected' : ''}>Education</option>
                                <option value="admin" ${currentProfile.department === 'admin' ? 'selected' : ''}>Administration</option>
                                <option value="support" ${currentProfile.department === 'support' ? 'selected' : ''}>Support Services</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Extension</label>
                            <input type="text" id="profileExtension" value="${currentProfile.phoneExtension || ''}" 
                                placeholder="e.g., 1234" maxlength="10">
                        </div>
                        
                        <div class="form-group">
                            <label>Role</label>
                            <select id="profileRole">
                                <option value="coach" ${currentProfile.role === 'coach' ? 'selected' : ''}>Coach</option>
                                <option value="supervisor" ${currentProfile.role === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                                <option value="admin" ${currentProfile.role === 'admin' ? 'selected' : ''}>Administrator</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Max Caseload</label>
                            <input type="number" id="profileMaxCaseload" value="${currentProfile.maxCaseload || 12}" 
                                min="1" max="50" required>
                            <small>Maximum number of clients you can manage</small>
                        </div>
                        
                        <div class="button-group" style="margin-top: 30px;">
                            <button type="submit" class="primary-button" style="flex: 1;">
                                ${isFirstTime ? 'Create Profile' : 'Update Profile'}
                            </button>
                            ${!isFirstTime ? `
                                <button type="button" onclick="closeCoachProfileModal()" class="secondary-button">
                                    Cancel
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Add dialog to page
        const existingModal = document.getElementById('coachProfileModal');
        existingModal?.remove();
        
        document.body.insertAdjacentHTML('beforeend', dialogHtml);
        
        // Handle form submission
        document.getElementById('coachProfileForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const username = localStorage.getItem('username');
            const profileData = {
                username,
                fullName: document.getElementById('profileFullName').value,
                initials: document.getElementById('profileInitials').value.toUpperCase(),
                role: document.getElementById('profileRole').value,
                department: document.getElementById('profileDepartment').value,
                phoneExtension: document.getElementById('profileExtension').value,
                maxCaseload: parseInt(document.getElementById('profileMaxCaseload').value),
                isAdmin: document.getElementById('profileRole').value === 'admin'
            };
            
            // Update profile
            CoachProfiles.update(username, profileData);
            
            // Update session storage
            localStorage.setItem('fullName', profileData.fullName);
            localStorage.setItem('userRole', profileData.role);
            
            // Show success message
            showNotification('Profile updated successfully!', 'success');
            
            // Close modal
            closeCoachProfileModal();
            
            // Refresh any UI elements that display coach info
            const coachDisplay = document.querySelector('.coach-info, .user-info');
            if (coachDisplay) {
                coachDisplay.textContent = `${profileData.fullName} (${profileData.initials})`;
            }
            
            // If first time, trigger any onboarding completion
            if (isFirstTime && window.onCoachProfileComplete) {
                window.onCoachProfileComplete();
            }
        };
    };
    
    // Close modal function
    window.closeCoachProfileModal = () => {
        const modal = document.getElementById('coachProfileModal');
        modal?.remove();
    };
    
    // Override getCurrentCoach if it exists
    if (typeof window.getCurrentCoach === 'function') {
        window._originalGetCurrentCoach = window.getCurrentCoach;
    }
    window.getCurrentCoach = window.getEnhancedCurrentCoach;
    
    // Add coach indicator to clients
    const enhanceClientDisplay = () => {
        const clients = document.querySelectorAll('.client-row, .client-card, .client-item');
        const currentCoach = window.getEnhancedCurrentCoach();
        
        clients.forEach(client => {
            const initials = client.dataset.clientInitials || client.textContent.match(/^([A-Z]{2,3})\s-/)?.[1];
            
            if (initials === currentCoach.initials) {
                client.classList.add('my-client');
                
                if (!client.querySelector('.coach-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'coach-indicator';
                    indicator.innerHTML = 'üë§';
                    indicator.title = 'Your Client';
                    client.appendChild(indicator);
                }
            }
        });
    };
    
    // Add profile button to UI
    const addProfileButton = () => {
        const userInfo = document.querySelector('.user-info, .header-right, .nav-right');
        if (!userInfo || document.getElementById('profileSettingsBtn')) return;
        
        const profileBtn = document.createElement('button');
        profileBtn.id = 'profileSettingsBtn';
        profileBtn.className = 'profile-settings-btn';
        profileBtn.innerHTML = 'üë§ Profile';
        profileBtn.onclick = () => window.showCoachProfileSetup(false);
        userInfo.appendChild(profileBtn);
    };
    
    // Show notification
    const showNotification = (message, type = 'info') => {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    };
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        // Add profile button
        setTimeout(addProfileButton, 1000);
        
        // Enhance client displays
        setTimeout(enhanceClientDisplay, 1500);
        
        // Check if first-time setup needed - but only when explicitly triggered
        const username = localStorage.getItem('username');
        if (username && !CoachProfiles.get(username)) {
            console.log('Coach profile not found for:', username, '- will create when requested');
        }
    });
    
    // Re-enhance on dynamic content changes
    if (window.MutationObserver) {
        const observer = new MutationObserver(() => {
            enhanceClientDisplay();
        });
        
        const waitForBody = () => {
            const target = document.body;
            if (!target) {
                setTimeout(waitForBody, 50);
                return;
            }
            observer.observe(target, {
                childList: true,
                subtree: true
            });
        };

        waitForBody();
    }
    
    // Export functions for external use
    window.CoachProfiles = {
        get: username => CoachProfiles.get(username),
        update: (username, data) => CoachProfiles.update(username, data),
        getAll: () => CoachProfiles.getAll(),
        showSetup: (isFirstTime) => window.showCoachProfileSetup(isFirstTime)
    };
    
    console.log('‚úÖ Coach Profile Enhancement ready');
})();

// Enhancement: login-fix.js
// Fix for login screen not showing

console.log('üîê Login fix applied');

// Early proxy: ensure handleLogin always exists and queues attempts until ready
// Account registry and account creation helpers
(function() {
    const STORAGE_KEY = 'ccpro-user-accounts-v1';
    const DEFAULT_USERS = [
        { username: 'MasterAdmin', password: 'FFA121', role: 'admin', fullName: 'Master Administrator' },
        { username: 'Doc121', password: 'FFA121', role: 'user', fullName: 'Document Creator' }
    ];
    let memoryFallback = [];

    function normalizeAccount(raw) {
        if (!raw || typeof raw !== 'object') {
            return null;
        }
        const username = typeof raw.username === 'string' ? raw.username.trim() : '';
        const password = typeof raw.password === 'string' ? raw.password : '';
        if (!username || !password) {
            return null;
        }
        const role = typeof raw.role === 'string' && raw.role.toLowerCase() === 'admin' ? 'admin' : 'user';
        const fullName = typeof raw.fullName === 'string' && raw.fullName.trim() ? raw.fullName.trim() : username;
        return { username, password, role, fullName };
    }

    function mergeDefaults(accounts) {
        const list = Array.isArray(accounts) ? accounts.slice() : [];
        DEFAULT_USERS.forEach(defaultUser => {
            const exists = list.some(acc => acc.username.toLowerCase() === defaultUser.username.toLowerCase());
            if (!exists) {
                list.push({ ...defaultUser });
            }
        });
        return list;
    }

    function loadAccounts() {
        let parsed = [];
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const raw = JSON.parse(stored);
                if (Array.isArray(raw)) {
                    parsed = raw.map(normalizeAccount).filter(Boolean);
                }
            }
        } catch (error) {
            console.warn('Unable to load stored accounts, falling back to memory copy', error);
            parsed = memoryFallback.slice();
        }
        if (!parsed.length && memoryFallback.length) {
            parsed = memoryFallback.slice();
        }
        parsed = mergeDefaults(parsed);
        memoryFallback = parsed.slice();
        return parsed;
    }

    function saveAccounts(accounts) {
        const normalized = Array.isArray(accounts) ? accounts.map(normalizeAccount).filter(Boolean) : [];
        memoryFallback = normalized.slice();
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
        } catch (error) {
            console.warn('Unable to persist accounts, using in-memory fallback only', error);
        }
    }

    function addAccount(account) {
        const normalized = normalizeAccount(account);
        if (!normalized) {
            throw new Error('Invalid account details. Please try again.');
        }
        const accounts = loadAccounts();
        const exists = accounts.some(acc => acc.username.toLowerCase() === normalized.username.toLowerCase());
        if (exists) {
            throw new Error('Username already exists. Please choose a different one.');
        }
        accounts.push(normalized);
        saveAccounts(accounts);
        return normalized;
    }

    function getInitials(nameOrUsername) {
        const source = (nameOrUsername || '').trim();
        if (!source) {
            return 'U';
        }
        const parts = source.split(/\s+/).filter(Boolean);
        if (!parts.length) {
            return source.slice(0, 2).toUpperCase();
        }
        const initials = parts.slice(0, 2).map(part => part.charAt(0).toUpperCase()).join('');
        return initials || source.slice(0, 2).toUpperCase();
    }

    window.ccAccountRegistry = {
        load: loadAccounts,
        save: saveAccounts,
        add: addAccount,
        storageKey: STORAGE_KEY,
        getInitials
    };

    window.showAccountCreation = function() {
        try {
            const usernameInput = prompt('Choose a username (3-20 characters, letters/numbers/._- only):');
            if (!usernameInput) {
                alert('Account creation cancelled.');
                return;
            }
            const username = usernameInput.trim();
            if (!/^[A-Za-z0-9._-]{3,20}$/.test(username)) {
                alert('Username must be 3-20 characters and contain only letters, numbers, periods, underscores, or hyphens.');
                return;
            }

            const passwordInput = prompt('Choose a password (minimum 6 characters):');
            if (!passwordInput) {
                alert('Account creation cancelled.');
                return;
            }
            const password = passwordInput.trim();
            if (password.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }

            const fullNameInput = prompt('Enter a display name for this user (optional):', username);
            const roleInput = prompt('Enter role for this user (admin/user). Leave blank for standard user:', 'user');
            const role = roleInput && roleInput.trim().toLowerCase() === 'admin' ? 'admin' : 'user';

            const account = window.ccAccountRegistry.add({
                username,
                password,
                fullName: fullNameInput && fullNameInput.trim() ? fullNameInput.trim() : username,
                role
            });

            alert(`Account created for ${account.username}. You can now sign in with these credentials.`);
        } catch (error) {
            console.error('Failed to create account', error);
            alert(error && error.message ? error.message : 'Failed to create account. Please try again.');
        }
    };

    // Ensure defaults are present in storage
    saveAccounts(loadAccounts());
})();

// Define handleLogin function if it doesn't exist
// Run immediately, not waiting for DOMContentLoaded
(function() {
    const existing = typeof window.handleLogin === 'function' ? window.handleLogin : null;
    const isProxy = Boolean(existing && existing.__ccHandleLoginProxy);

    if (existing && !isProxy) {
        console.log('‚úÖ handleLogin already defined');
        return;
    }

    console.log('üîê Creating handleLogin function');

    const queue = isProxy && Array.isArray(existing.__queue) ? existing.__queue : [];

    const realHandleLogin = async function(eventOrUsername, password) {
        try {
            let username, pwd;
            
            // Handle both event object and direct username/password
            if (eventOrUsername && typeof eventOrUsername === 'object' && eventOrUsername.preventDefault) {
                // Event object passed
                eventOrUsername.preventDefault();
                const form = eventOrUsername.target || eventOrUsername.currentTarget;
                const usernameInput = form.querySelector('input[type="text"], input[name="username"], #loginUsername');
                const passwordInput = form.querySelector('input[type="password"], input[name="password"], #loginPassword');
                
                if (!usernameInput || !passwordInput) {
                    // Try global selectors as fallback
                    username = document.querySelector('#loginUsername, input[type="text"]')?.value || '';
                    pwd = document.querySelector('#loginPassword, input[type="password"]')?.value || '';
                } else {
                    username = usernameInput.value.trim();
                    pwd = passwordInput.value;
                }
            } else {
                // Direct username/password passed
                username = String(eventOrUsername || '').trim();
                pwd = String(password || '');
            }
            
            // Clear any previous error
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            
            // Validate inputs
            if (!username || !pwd) {
                const errorMsg = 'Please enter both username and password';
                if (errorDiv) {
                    errorDiv.textContent = errorMsg;
                    errorDiv.style.display = 'block';
                } else {
                    alert(errorMsg);
                }
                return false;
            }
            
            // Validate credentials
            const registry = window.ccAccountRegistry;
            const accounts = registry ? registry.load() : [];
            const normalizedUsername = username.toLowerCase();
            const account = accounts.find(acc => acc.username.toLowerCase() === normalizedUsername);

            if (!account || account.password !== pwd) {
                const errorMsg = 'Invalid username or password';
                if (errorDiv) {
                    errorDiv.textContent = errorMsg;
                    errorDiv.style.display = 'block';
                } else {
                    alert(errorMsg);
                }
                return false;
            }

            const fullName = account.fullName || account.username;
            const initials = registry && typeof registry.getInitials === 'function'
                ? registry.getInitials(fullName)
                : (fullName || account.username).slice(0, 2).toUpperCase();

            // Successful login
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('username', account.username);
            localStorage.setItem('userRole', account.role || 'user');
            localStorage.setItem('fullName', fullName);
            localStorage.setItem('userInitials', initials);
            localStorage.setItem('manualLogin', 'true');
            
            console.log('‚úÖ Login successful:', account.username);
            
            // Hide login screen and show main app
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            if (loginScreen) {
                loginScreen.style.display = 'none';
                loginScreen.style.visibility = 'hidden';
            }
            
            if (mainApp) {
                mainApp.style.display = 'block';
                mainApp.style.visibility = 'visible';
            }
            
            // Update user profile button if it exists
            const userProfileBtn = document.getElementById('userProfileBtn');
            if (userProfileBtn) {
                const usernameDisplay = userProfileBtn.querySelector('.username-display');
                if (usernameDisplay) {
                    usernameDisplay.textContent = account.username;
                }
            }

            const displayFullName = document.getElementById('displayFullName');
            if (displayFullName) {
                displayFullName.textContent = fullName;
            }

            const displayUsername = document.getElementById('displayUsername');
            if (displayUsername) {
                displayUsername.textContent = `@${account.username}`;
            }

            const userInitials = document.getElementById('userInitials');
            if (userInitials) {
                userInitials.textContent = initials;
            }

            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.textContent = initials;
            }
            
            return true;
        } catch (error) {
            console.error('‚ùå Login error:', error);
            const errorDiv = document.getElementById('loginError');
            const errorMsg = 'An error occurred during login. Please try again.';
            if (errorDiv) {
                errorDiv.textContent = errorMsg;
                errorDiv.style.display = 'block';
            } else {
                alert(errorMsg);
            }
            return false;
        }
    };

    realHandleLogin.__ccHandleLoginReady = true;

    if (isProxy) {
        existing.__impl = realHandleLogin;
        existing.__isReady = true;
        window.handleLogin = existing;
    } else {
        window.handleLogin = realHandleLogin;
    }

    if (Array.isArray(queue) && queue.length) {
        const queuedCalls = queue.splice(0, queue.length);
        queuedCalls.forEach(entry => {
            if (!entry) return;
            setTimeout(() => {
                try {
                    realHandleLogin.apply(entry.context || window, entry.args || []);
                } catch (err) {
                    console.error('Queued login attempt failed:', err);
                }
            }, 0);
        });
    }

    console.log('‚úÖ handleLogin function created');
})();


// Enhancement: tracker-ui.js
/**
 * Tracker UI Enhancements
 * Adds completion indicators and tracker intelligence to dashboard
 */

(function() {
    'use strict';
    
    console.log('[TrackerUI] Initializing tracker UI enhancements...');
    
    // Wait for dependencies
    const waitForDependencies = () => {
        return new Promise((resolve) => {
            const checkInterval = setInterval(() => {
                if (window.trackerEngine && window.dashboardManager) {
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 100);
        });
    };
    
    // Enhance client card with tracker completion
    const enhanceClientCard = (card, client) => {
        // Check if already enhanced
        if (card.querySelector('.tracker-status')) return;
        
        // Get completion score
        const score = window.trackerEngine.getCompletionScore(client);
        
        // Create tracker status element
        const trackerStatus = document.createElement('div');
        trackerStatus.className = 'tracker-status';
        trackerStatus.innerHTML = `
            <div class="tracker-completion">
                <div class="completion-bar">
                    <div class="completion-fill" style="width: ${score.overallPercentage}%"></div>
                </div>
                <div class="completion-text">
                    <span class="completion-percentage">üìä Chart: ${score.overallPercentage}% Complete</span>
                    ${score.missingCritical.length > 0 ? 
                        `<span class="critical-missing">‚ö†Ô∏è ${score.missingCritical.length} critical items missing</span>` : 
                        ''
                    }
                </div>
            </div>
            ${score.missingCritical.length > 0 ? 
                `<div class="missing-items">
                    Missing: ${score.missingCritical.slice(0, 3).map(item => item.label).join(', ')}
                    ${score.missingCritical.length > 3 ? ` +${score.missingCritical.length - 3} more` : ''}
                </div>` : 
                ''
            }
        `;
        
        // Add risk level class
        trackerStatus.classList.add(`risk-${score.riskLevel}`);
        
        // Find insertion point (after client info, before actions)
        const clientInfo = card.querySelector('.client-info');
        if (clientInfo && clientInfo.nextSibling) {
            clientInfo.parentNode.insertBefore(trackerStatus, clientInfo.nextSibling);
        } else {
            card.appendChild(trackerStatus);
        }
        
        // Add click handler for detailed view
        trackerStatus.addEventListener('click', (e) => {
            e.stopPropagation();
            showTrackerDetails(client);
        });
    };
    
    // Show detailed tracker modal
    const showTrackerDetails = (client) => {
        const score = window.trackerEngine.getCompletionScore(client);
        const upcoming = window.trackerEngine.getUpcomingDeadlines(client);
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'tracker-modal-overlay';
        modal.innerHTML = `
            <div class="tracker-modal">
                <div class="tracker-modal-header">
                    <h3>Tracker Status: ${client.initials}</h3>
                    <button class="close-btn" onclick="window.closeModal(this.closest('.tracker-modal-overlay'))">√ó</button>
                </div>
                <div class="tracker-modal-content">
                    <div class="tracker-summary">
                        <div class="summary-stat">
                            <span class="stat-label">Overall</span>
                            <span class="stat-value">${score.overallPercentage}%</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Critical</span>
                            <span class="stat-value">${score.criticalPercentage}%</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Complete</span>
                            <span class="stat-value">${score.completedItems}/${score.totalItems}</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Days to Discharge</span>
                            <span class="stat-value">${score.daysToDischarge}</span>
                        </div>
                    </div>
                    
                    ${score.missingCritical.length > 0 ? `
                        <div class="missing-critical-section">
                            <h4>‚ö†Ô∏è Missing Critical Items</h4>
                            <ul class="missing-list">
                                ${score.missingCritical.map(item => `
                                    <li class="missing-item">
                                        <span class="item-label">${item.label}</span>
                                        <span class="item-due">Due by day ${item.dueByDay}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${upcoming.length > 0 ? `
                        <div class="upcoming-section">
                            <h4>üìÖ Upcoming Deadlines</h4>
                            <ul class="upcoming-list">
                                ${upcoming.map(item => `
                                    <li class="upcoming-item">
                                        <span class="item-label">${item.label}</span>
                                        <span class="item-due">Due in ${item.daysUntilDue} days</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="tracker-actions">
                        <button class="btn-primary" onclick="openBulkUpdate('${client.id}')">Quick Update</button>
                        <button class="btn-secondary" onclick="generateTrackerTasks('${client.id}')">Generate Tasks</button>
                        <button class="btn-secondary" onclick="openTrackerTimeline('${client.id}')">View Timeline</button>
                        <button class="btn-secondary" onclick="aftercareCascade.open('${client.id}')">Aftercare Options</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close on overlay click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    };
    
    // Intercept dashboard rendering to enhance cards
    const interceptDashboardRender = () => {
        const originalRenderClients = window.dashboardManager.renderClients;
        
        window.dashboardManager.renderClients = async function(clients, container) {
            // Call original render
            await originalRenderClients.call(this, clients, container);
            
            // Enhance each card
            const cards = container.querySelectorAll('.client-card');
            cards.forEach((card, index) => {
                if (clients[index]) {
                    enhanceClientCard(card, clients[index]);
                }
            });
        };
    };
    
    // Add tracker tasks to flight plan
    const enhanceFlightPlan = () => {
        const originalLoadPriorities = window.dashboardManager.loadPriorities;
        
        window.dashboardManager.loadPriorities = async function() {
            // Call original
            const priorities = await originalLoadPriorities.call(this);
            
            // Add tracker-generated tasks
            try {
                const clients = await this.getRelevantClients();
                const trackerTasks = [];
                
                for (const client of clients) {
                    const tasks = window.trackerEngine.generateTasksFromGaps(client);
                    trackerTasks.push(...tasks);
                }
                
                // Merge tracker tasks into priorities
                for (const task of trackerTasks) {
                    let zone = 'green';
                    if (task.priority === 'critical') zone = 'red';
                    else if (task.priority === 'high') zone = 'purple';
                    else if (task.priority === 'medium') zone = 'yellow';
                    
                    const item = {
                        type: task.type,
                        client: {
                            id: task.clientId,
                            initials: task.clientInitials,
                            houseId: task.houseId
                        },
                        message: task.title,
                        action: 'Mark Complete',
                        dueDate: task.dueDate,
                        trackerId: task.trackerId,
                        autoGenerated: true,
                        isTrackerTask: true  // Flag to identify tracker tasks
                    };
                    
                    if (!priorities[zone]) priorities[zone] = [];
                    priorities[zone].push(item);
                }
                
                return priorities;
            } catch (error) {
                console.error('[TrackerUI] Error generating tracker tasks:', error);
                return priorities;
            }
        };
    };
    
    // Global functions for modal actions
    window.openBulkUpdate = async (clientId) => {
        // This will be implemented in the bulk update phase
        console.log('[TrackerUI] Bulk update requested for client:', clientId);
        alert('Bulk update feature coming soon!');
    };
    
    window.openTrackerTimeline = async (clientId) => {
        try {
            const client = await window.clientManager.getClient(clientId);
            
            // Create timeline modal
            const modal = document.createElement('div');
            modal.className = 'tracker-modal-overlay timeline-modal-overlay';
            modal.innerHTML = `
                <div class="tracker-modal timeline-modal-large">
                    <div class="tracker-modal-header">
                        <h3>Tracker Timeline</h3>
                        <button class="close-btn" onclick="window.closeModal(this.closest('.tracker-modal-overlay'))">√ó</button>
                    </div>
                    <div class="tracker-modal-content">
                        <div id="timeline-container"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Render timeline
            const container = modal.querySelector('#timeline-container');
            if (window.trackerTimeline) {
                await window.trackerTimeline.render(client, container);
            } else {
                container.innerHTML = '<p>Timeline component not loaded</p>';
            }
            
            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
        } catch (error) {
            console.error('[TrackerUI] Error opening timeline:', error);
            alert('Error loading timeline. Check console for details.');
        }
    };
    
    window.generateTrackerTasks = async (clientId) => {
        try {
            const client = await window.clientManager.getClient(clientId);
            const tasks = window.trackerEngine.generateTasksFromGaps(client);
            
            if (tasks.length === 0) {
                alert('No tasks to generate - all requirements are on track!');
                return;
            }
            
            // Create tasks using task manager
            for (const task of tasks) {
                await window.taskManager.createTask({
                    title: task.title,
                    description: task.description,
                    priority: task.priority,
                    dueDate: task.dueDate,
                    category: 'tracker-generated',
                    clientId: task.clientId,
                    metadata: {
                        trackerId: task.trackerId,
                        autoGenerated: true
                    }
                });
            }
            
            alert(`Generated ${tasks.length} tasks from tracker gaps`);
            
            // Refresh dashboard
            if (window.dashboardManager.loadData) {
                await window.dashboardManager.loadData();
            }
            
            // Close modal
            const modal = document.querySelector('.tracker-modal-overlay');
            if (modal) modal.remove();
            
        } catch (error) {
            console.error('[TrackerUI] Error generating tasks:', error);
            alert('Error generating tasks. Check console for details.');
        }
    };
    
    // Initialize enhancements
    const initialize = async () => {
        console.log('[TrackerUI] Waiting for dependencies...');
        await waitForDependencies();
        
        console.log('[TrackerUI] Enhancing dashboard...');
        interceptDashboardRender();
        enhanceFlightPlan();
        
        // Trigger re-render if dashboard is already loaded
        if (window.dashboardManager.initialized) {
            console.log('[TrackerUI] Refreshing dashboard with tracker enhancements...');
            await window.dashboardManager.loadData();
        }
        
        console.log('[TrackerUI] Tracker UI enhancements ready');
    };
    
    // Start initialization
    initialize();
    
})();


// Enhancement: tracker-compliance-widget.js
/**
 * Tracker Compliance Dashboard Widget
 * House-level view of tracker completion across all clients
 */

(function() {
    'use strict';
    
    console.log('[ComplianceWidget] Initializing compliance widget...');
    
    // Compliance Widget Class
    class ComplianceWidget {
        constructor(container) {
            this.container = container;
            this.initialized = false;
            this.data = null;
        }
        
        async render() {
            if (!window.trackerEngine) {
                this.container.innerHTML = '<div class="widget-error">Tracker engine not loaded</div>';
                return;
            }
            
            try {
                // Get all clients grouped by house
                const clientsByHouse = await this.getClientsByHouse();
                
                // Calculate compliance for each house
                const houseStats = [];
                for (const [houseId, clients] of Object.entries(clientsByHouse)) {
                    if (clients.length > 0) {
                        const stats = window.trackerEngine.getHouseCompliance(clients);
                        houseStats.push(stats);
                    }
                }
                
                // Calculate overall compliance
                const overallStats = this.calculateOverallStats(houseStats);
                
                // Render the widget
                this.container.innerHTML = `
                    <div class="compliance-widget">
                        <div class="widget-header">
                            <h3>üìä Tracker Compliance</h3>
                            <button class="refresh-btn" onclick="dashboardWidgets.widgets.get('compliance')?.render()">
                                <span class="refresh-icon">‚Üª</span>
                            </button>
                        </div>
                        
                        <div class="compliance-overview">
                            <div class="overall-score">
                                <div class="score-circle" style="--percentage: ${overallStats.overall}">
                                    <svg viewBox="0 0 36 36" class="circular-chart">
                                        <path class="circle-bg"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        />
                                        <path class="circle"
                                            stroke-dasharray="${overallStats.overall}, 100"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        />
                                    </svg>
                                    <div class="percentage">
                                        <span class="value">${overallStats.overall}%</span>
                                        <span class="label">Overall</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="compliance-metrics">
                                <div class="metric">
                                    <span class="metric-value">${overallStats.critical}%</span>
                                    <span class="metric-label">Critical Items</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">${overallStats.atRisk}</span>
                                    <span class="metric-label">At Risk Clients</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">${overallStats.strong}</span>
                                    <span class="metric-label">Strong Performers</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="house-compliance-list">
                            ${houseStats.map(stats => this.renderHouseCard(stats)).join('')}
                        </div>
                        
                        ${overallStats.atRiskDetails.length > 0 ? `
                            <div class="at-risk-section">
                                <h4>‚ö†Ô∏è Immediate Attention Required</h4>
                                <div class="at-risk-list">
                                    ${overallStats.atRiskDetails.map(client => `
                                        <div class="at-risk-item">
                                            <span class="client-info">${client.message}</span>
                                            <button class="action-btn" onclick="openBulkUpdate('${client.client.id}')">
                                                Update
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
            } catch (error) {
                console.error('[ComplianceWidget] Render error:', error);
                this.container.innerHTML = '<div class="widget-error">Failed to load compliance data</div>';
            }
        }
        
        renderHouseCard(stats) {
            const riskClass = stats.overallCompliance >= 80 ? 'good' : 
                             stats.overallCompliance >= 60 ? 'warning' : 'danger';
            
            return `
                <div class="house-card ${riskClass}">
                    <div class="house-header">
                        <h4>${stats.houseId}</h4>
                        <span class="house-score">${stats.overallCompliance}%</span>
                    </div>
                    <div class="house-details">
                        <div class="detail-row">
                            <span>Clients:</span>
                            <span>${stats.totalClients}</span>
                        </div>
                        <div class="detail-row">
                            <span>Critical:</span>
                            <span>${stats.criticalCompliance}%</span>
                        </div>
                        <div class="detail-row">
                            <span>At Risk:</span>
                            <span class="${stats.atRiskClients.length > 0 ? 'text-danger' : ''}">${stats.atRiskClients.length}</span>
                        </div>
                    </div>
                    <div class="category-breakdown">
                        ${Object.entries(stats.byCategory).map(([cat, data]) => `
                            <div class="category-bar">
                                <div class="cat-label">${this.getCategoryLabel(cat)}</div>
                                <div class="cat-progress">
                                    <div class="cat-fill" style="width: ${data.percentage}%"></div>
                                </div>
                                <div class="cat-value">${data.percentage}%</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        getCategoryLabel(category) {
            const labels = {
                admission: 'Admission',
                clinical: 'Clinical',
                aftercare: 'Aftercare',
                documentation: 'Docs'
            };
            return labels[category] || category;
        }
        
        async getClientsByHouse() {
            let clients = [];
            
            // Prefer the same data pipeline the main dashboard uses
            if (window.dashboardManager?.getRelevantClients) {
                try {
                    clients = await window.dashboardManager.getRelevantClients();
                } catch (err) {
                    console.warn('[ComplianceWidget] Falling back to clientManager.getAllClients()', err);
                }
            }
            
            // Fallback if dashboardManager path fails
            if ((!clients || clients.length === 0) && window.clientManager?.getAllClients) {
                clients = await window.clientManager.getAllClients();
            }
            
            if (!Array.isArray(clients) || clients.length === 0) {
                return {};
            }
            
            const activeClients = clients.filter(c => c.status === 'active');
            
            const byHouse = {};
            activeClients.forEach(client => {
                const house = client.houseId || 'Unassigned';
                if (!byHouse[house]) byHouse[house] = [];
                byHouse[house].push(client);
            });
            
            return byHouse;
        }
        
        calculateOverallStats(houseStats) {
            let totalCompliance = 0;
            let totalCritical = 0;
            let totalAtRisk = 0;
            let totalStrong = 0;
            let allAtRisk = [];
            
            houseStats.forEach(stats => {
                totalCompliance += stats.overallCompliance;
                totalCritical += stats.criticalCompliance;
                totalAtRisk += stats.atRiskClients.length;
                totalStrong += stats.strongClients.length;
                allAtRisk.push(...stats.atRiskClients);
            });
            
            const houseCount = houseStats.length || 1;
            
            return {
                overall: Math.round(totalCompliance / houseCount),
                critical: Math.round(totalCritical / houseCount),
                atRisk: totalAtRisk,
                strong: totalStrong,
                atRiskDetails: allAtRisk.slice(0, 5) // Top 5 most at risk
            };
        }
    }
    
    // Wait for dependencies and inject widget
    const injectComplianceWidget = () => {
        const checkInterval = setInterval(() => {
            if (window.dashboardWidgets && window.trackerEngine && window.clientManager) {
                clearInterval(checkInterval);
                
                // Find or create container for compliance widget
                let container = document.querySelector('.compliance-widget-container');
                if (!container) {
                    const dashboardContainer = document.querySelector('.dashboard-container');
                    const mainGrid = dashboardContainer?.querySelector('.dashboard-main-grid');
                    
                    if (dashboardContainer) {
                        container = document.createElement('div');
                        container.className = 'widget-container compliance-widget-container';
                        
                        // Insert as a full-width section directly below the main grid
                        if (mainGrid && mainGrid.parentElement) {
                            mainGrid.parentElement.insertBefore(container, mainGrid.nextSibling);
                        } else {
                            dashboardContainer.appendChild(container);
                        }
                    }
                }
                
                if (container) {
                    // Create and register widget
                    const complianceWidget = new ComplianceWidget(container);
                    window.dashboardWidgets.widgets.set('compliance', complianceWidget);
                    
                    // Initial render
                    complianceWidget.render();
                    
                    console.log('[ComplianceWidget] Widget injected and rendered');
                } else {
                    console.warn('[ComplianceWidget] Could not find suitable container');
                }
            }
        }, 100);
    };
    
    // Start injection process
    injectComplianceWidget();
    
})();


// Enhancement: tracker-document-hub.js
/**
 * Tracker Document Hub Enhancement
 * Visual status indicators and centralized document tracking
 */

(function() {
    'use strict';
    
    console.log('[DocumentHub] Initializing document hub enhancements...');
    
    // Document definitions with metadata
    const documentDefinitions = [
        {
            id: 'needsAssessment',
            category: 'admission',
            label: 'Needs Assessment',
            required: true,
            dueByDay: 2,
            template: true
        },
        {
            id: 'healthPhysical',
            category: 'admission',
            label: 'Health & Physical',
            required: true,
            dueByDay: 2,
            template: true
        },
        {
            id: 'optionsDoc',
            category: 'aftercare',
            label: 'Aftercare Options Document',
            required: true,
            dueByDay: 21,
            template: true,
            requiresSignature: true
        },
        {
            id: 'dischargePacket',
            category: 'aftercare',
            label: 'Discharge Packet',
            required: true,
            dueByDay: 25,
            multipart: true
        },
        {
            id: 'dischargeSummary',
            category: 'discharge',
            label: 'Discharge Summary',
            required: true,
            dueByDay: 28,
            template: true
        },
        {
            id: 'dischargePlanningNote',
            category: 'discharge',
            label: 'Discharge Planning Note',
            required: true,
            dueByDay: 26,
            template: true
        },
        {
            id: 'dischargeASAM',
            category: 'discharge',
            label: 'Discharge ASAM',
            required: true,
            dueByDay: 28,
            template: false
        },
        {
            id: 'satisfactionSurvey',
            category: 'feedback',
            label: 'Satisfaction Survey',
            required: false,
            dueByDay: 25,
            template: true
        }
    ];
    
    // Document Hub Class
    class DocumentHub {
        constructor() {
            this.currentClient = null;
            this.initialized = false;
        }
        
        /**
         * Get document status for a client
         */
        getDocumentStatus(client, docDef) {
            const fieldName = docDef.id === 'optionsDoc' ? 'optionsDocUploaded' : 
                             docDef.id === 'dischargePacket' ? 'dischargePacketUploaded' :
                             docDef.id;
            
            const isComplete = client[fieldName];
            const completedDate = client[fieldName + 'Date'];
            const daysInCare = this.calculateDaysInCare(client.admissionDate);
            const daysToDischarge = this.calculateDaysToDischarge(client);
            
            let status = 'pending';
            let statusMessage = '';
            
            if (isComplete) {
                status = 'complete';
                statusMessage = completedDate ? 
                    `Completed ${new Date(completedDate).toLocaleDateString()}` : 
                    'Completed';
            } else if (daysInCare > docDef.dueByDay) {
                status = 'overdue';
                const daysOverdue = daysInCare - docDef.dueByDay;
                statusMessage = `Overdue by ${daysOverdue} days`;
            } else if (daysToDischarge <= 7 && docDef.required) {
                status = 'urgent';
                statusMessage = `Due in ${docDef.dueByDay - daysInCare} days`;
            } else {
                status = 'pending';
                statusMessage = `Due by day ${docDef.dueByDay}`;
            }
            
            return {
                status,
                statusMessage,
                isComplete,
                completedDate,
                daysUntilDue: docDef.dueByDay - daysInCare
            };
        }
        
        /**
         * Render document hub for a client
         */
        async renderDocumentHub(clientId) {
            try {
                this.currentClient = await window.clientManager.getClient(clientId);
                if (!this.currentClient) return;
                
                // Group documents by category
                const docsByCategory = this.groupDocumentsByCategory();
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'document-hub-overlay';
                modal.innerHTML = `
                    <div class="document-hub-modal">
                        <div class="document-hub-header">
                            <h3>üìÑ Document Status: ${this.currentClient.initials}</h3>
                            <button class="close-btn" onclick="window.closeModal(this.closest('.document-hub-overlay'))">√ó</button>
                        </div>
                        
                        <div class="document-hub-content">
                            <div class="document-summary">
                                ${this.renderDocumentSummary()}
                            </div>
                            
                            <div class="document-categories">
                                ${Object.entries(docsByCategory).map(([category, docs]) => 
                                    this.renderDocumentCategory(category, docs)
                                ).join('')}
                            </div>
                            
                            <div class="document-actions">
                                <button class="btn-primary" onclick="documentHub.generateMissing()">
                                    Generate Missing Documents
                                </button>
                                <button class="btn-secondary" onclick="documentHub.bulkUpload()">
                                    Bulk Upload
                                </button>
                                <button class="btn-secondary" onclick="documentHub.exportChecklist()">
                                    Export Checklist
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                console.error('[DocumentHub] Error rendering:', error);
                alert('Error loading document hub');
            }
        }
        
        /**
         * Render document summary stats
         */
        renderDocumentSummary() {
            let totalDocs = 0;
            let completedDocs = 0;
            let overdueDocs = 0;
            let urgentDocs = 0;
            
            documentDefinitions.forEach(docDef => {
                if (docDef.required) {
                    totalDocs++;
                    const status = this.getDocumentStatus(this.currentClient, docDef);
                    if (status.isComplete) completedDocs++;
                    if (status.status === 'overdue') overdueDocs++;
                    if (status.status === 'urgent') urgentDocs++;
                }
            });
            
            const percentage = totalDocs > 0 ? Math.round((completedDocs / totalDocs) * 100) : 0;
            
            return `
                <div class="summary-grid">
                    <div class="summary-stat">
                        <div class="stat-value">${percentage}%</div>
                        <div class="stat-label">Complete</div>
                    </div>
                    <div class="summary-stat">
                        <div class="stat-value">${completedDocs}/${totalDocs}</div>
                        <div class="stat-label">Documents</div>
                    </div>
                    <div class="summary-stat ${overdueDocs > 0 ? 'danger' : ''}">
                        <div class="stat-value">${overdueDocs}</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                    <div class="summary-stat ${urgentDocs > 0 ? 'warning' : ''}">
                        <div class="stat-value">${urgentDocs}</div>
                        <div class="stat-label">Urgent</div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Group documents by category
         */
        groupDocumentsByCategory() {
            const groups = {};
            
            documentDefinitions.forEach(docDef => {
                if (!groups[docDef.category]) {
                    groups[docDef.category] = [];
                }
                groups[docDef.category].push(docDef);
            });
            
            return groups;
        }
        
        /**
         * Render document category section
         */
        renderDocumentCategory(category, docs) {
            const categoryLabels = {
                admission: '48-Hour Admission',
                aftercare: 'Aftercare Planning',
                discharge: 'Discharge Documentation',
                feedback: 'Feedback & Surveys'
            };
            
            return `
                <div class="document-category">
                    <h4>${categoryLabels[category] || category}</h4>
                    <div class="document-list">
                        ${docs.map(doc => this.renderDocumentItem(doc)).join('')}
                    </div>
                </div>
            `;
        }
        
        /**
         * Render individual document item
         */
        renderDocumentItem(docDef) {
            const status = this.getDocumentStatus(this.currentClient, docDef);
            const statusIcon = this.getStatusIcon(status.status);
            const statusClass = `document-item ${status.status}`;
            
            return `
                <div class="${statusClass}">
                    <div class="document-icon">${statusIcon}</div>
                    <div class="document-info">
                        <div class="document-name">
                            ${docDef.label}
                            ${docDef.required ? '<span class="required-badge">Required</span>' : ''}
                            ${docDef.requiresSignature ? '<span class="signature-badge">Needs Signature</span>' : ''}
                        </div>
                        <div class="document-status">${status.statusMessage}</div>
                    </div>
                    <div class="document-actions">
                        ${status.isComplete ? `
                            <button class="btn-icon" title="View Document" onclick="documentHub.viewDocument('${docDef.id}')">
                                üëÅÔ∏è
                            </button>
                            <button class="btn-icon" title="Replace Document" onclick="documentHub.uploadDocument('${docDef.id}')">
                                üì§
                            </button>
                        ` : `
                            ${docDef.template ? `
                                <button class="btn-small" onclick="documentHub.generateDocument('${docDef.id}')">
                                    Generate
                                </button>
                            ` : ''}
                            <button class="btn-small primary" onclick="documentHub.uploadDocument('${docDef.id}')">
                                Upload
                            </button>
                        `}
                    </div>
                </div>
            `;
        }
        
        /**
         * Get status icon
         */
        getStatusIcon(status) {
            switch (status) {
                case 'complete': return '‚úÖ';
                case 'overdue': return '‚ùå';
                case 'urgent': return '‚ö†Ô∏è';
                default: return '‚óã';
            }
        }
        
        /**
         * Generate missing documents
         */
        async generateMissing() {
            const missing = documentDefinitions.filter(doc => {
                const status = this.getDocumentStatus(this.currentClient, doc);
                return !status.isComplete && doc.template;
            });
            
            if (missing.length === 0) {
                alert('No missing documents with templates available');
                return;
            }
            
            alert(`Generating ${missing.length} document templates:\n${missing.map(d => d.label).join('\n')}`);
            
            // In real implementation, this would generate actual documents
            console.log('[DocumentHub] Would generate:', missing);
        }
        
        /**
         * Handle document upload
         */
        uploadDocument(docId) {
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.doc,.docx';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                console.log(`[DocumentHub] Would upload ${file.name} for ${docId}`);
                
                // Update client record (in real implementation, would also upload file)
                const fieldName = docId === 'optionsDoc' ? 'optionsDocUploaded' : 
                                 docId === 'dischargePacket' ? 'dischargePacketUploaded' :
                                 docId;
                
                const updates = {
                    [fieldName]: true,
                    [fieldName + 'Date']: new Date().toISOString()
                };
                
                await window.clientManager.updateClient(this.currentClient.id, updates);
                
                // Refresh modal
                document.querySelector('.document-hub-overlay').remove();
                this.renderDocumentHub(this.currentClient.id);
                
                // Show success
                this.showNotification(`${file.name} uploaded successfully`, 'success');
            };
            
            input.click();
        }
        
        /**
         * View document (placeholder)
         */
        viewDocument(docId) {
            alert(`Viewing document: ${docId}\n(In real implementation, would open document viewer)`);
        }
        
        /**
         * Generate document from template (placeholder)
         */
        generateDocument(docId) {
            const doc = documentDefinitions.find(d => d.id === docId);
            alert(`Generating ${doc.label} from template...\n(In real implementation, would create document)`);
        }
        
        /**
         * Bulk upload interface (placeholder)
         */
        bulkUpload() {
            alert('Bulk upload interface coming soon!');
        }
        
        /**
         * Export checklist (placeholder)
         */
        exportChecklist() {
            const checklist = documentDefinitions.map(doc => {
                const status = this.getDocumentStatus(this.currentClient, doc);
                return `${status.isComplete ? '‚òë' : '‚òê'} ${doc.label} - ${status.statusMessage}`;
            }).join('\n');
            
            alert(`Document Checklist for ${this.currentClient.initials}:\n\n${checklist}`);
        }
        
        /**
         * Show notification
         */
        showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `document-notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('visible');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('visible');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Helper methods
        calculateDaysInCare(admissionDate) {
            if (!admissionDate) return 0;
            const admission = new Date(admissionDate);
            const today = new Date();
            const diffTime = Math.abs(today - admission);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        calculateDaysToDischarge(client) {
            if (!client.dischargeDate) {
                return Math.max(0, 30 - this.calculateDaysInCare(client.admissionDate));
            }
            const discharge = new Date(client.dischargeDate);
            const today = new Date();
            const diffTime = discharge - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
    }
    
    // Create global instance
    window.documentHub = new DocumentHub();
    
    // Add document hub button to client cards
    const addDocumentHubButtons = () => {
        const originalRenderClients = window.dashboardManager?.renderClients;
        
        if (originalRenderClients) {
            window.dashboardManager.renderClients = async function(clients, container) {
                // Call original
                await originalRenderClients.call(this, clients, container);
                
                // Add document hub buttons
                const cards = container.querySelectorAll('.client-card');
                cards.forEach((card, index) => {
                    if (clients[index] && !card.querySelector('.document-hub-btn')) {
                        const actionsContainer = card.querySelector('.client-actions') || card;
                        const btn = document.createElement('button');
                        btn.className = 'btn-small document-hub-btn';
                        btn.innerHTML = 'üìÑ Documents';
                        btn.onclick = () => window.documentHub.renderDocumentHub(clients[index].id);
                        actionsContainer.appendChild(btn);
                    }
                });
            };
        }
    };
    
    // Initialize when dependencies are ready
    const initInterval = setInterval(() => {
        if (window.dashboardManager && window.clientManager) {
            clearInterval(initInterval);
            addDocumentHubButtons();
            console.log('[DocumentHub] Document hub enhancements ready');
        }
    }, 100);
    
})();


// Enhancement: discharge-checklist.js
/**
 * Discharge Checklist UI Enhancement
 * Adds discharge checklist button to client cards and integrates with dashboard
 */

(function() {
    'use strict';
    
    // Wait for dashboard to be ready
    function waitForDashboard() {
        if (!window.dashboardWidgets || !window.dischargeChecklistManager) {
            setTimeout(waitForDashboard, 100);
            return;
        }
        
        enhanceClientCards();
    }
    
    /**
     * Add discharge checklist button to client cards
     */
    function enhanceClientCards() {
        // Override the renderClientCard method to add discharge checklist button
        const originalRenderCard = window.dashboardWidgets.renderClientCard;
        
        window.dashboardWidgets.renderClientCard = function(client) {
            const cardHtml = originalRenderCard.call(this, client);
            
            // Calculate days to discharge
            const daysToDischarge = client.dischargeDate ? 
                Math.ceil((new Date(client.dischargeDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
            
            // Only show discharge checklist button if discharge is within 7 days or past
            if (daysToDischarge !== null && daysToDischarge <= 7) {
                // Insert discharge checklist button before the closing client-actions div
                const insertPoint = '</div>\n            </div>';
                const dischargeButton = `
                    <button class="btn-discharge-checklist" 
                            onclick="dischargeChecklistManager.renderChecklistModal('${client.id}')"
                            title="Open FFAS Discharge Checklist">
                        üìã Discharge Checklist
                    </button>
                `;
                
                return cardHtml.replace(insertPoint, dischargeButton + insertPoint);
            }
            
            return cardHtml;
        };
        
        // Also add to the discharge prep alerts
        const originalRenderPriority = window.dashboardWidgets.renderPriorityItem;
        
        window.dashboardWidgets.renderPriorityItem = function(item, zoneColor) {
            const html = originalRenderPriority.call(this, item, zoneColor);
            
            // If this is a discharge prep item, add a link to the checklist
            if (item.type === 'discharge_prep') {
                const checklistLink = `
                    <button class="btn-link" 
                            onclick="dischargeChecklistManager.renderChecklistModal('${item.client.id}')"
                            style="margin-left: 8px; color: #7c3aed; text-decoration: underline; background: none; border: none; cursor: pointer;">
                        üìã Open Full Checklist
                    </button>
                `;
                
                // Insert after the action button
                return html.replace('</div>\n                </div>', checklistLink + '</div>\n                </div>');
            }
            
            return html;
        };
    }
    
    // Initialize when ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDashboard);
    } else {
        waitForDashboard();
    }
})();


if (false) {
// Enhancement: missions-redesign.js
/**
 * Missions Widget Redesign
 * Modern, beautiful redesign of the Today's Missions widget
 */

(function() {
    'use strict';
    
    // Wait for dashboard to be ready
    function waitForDashboard() {
        if (!window.dashboardWidgets || !window.dashboardManager) {
            setTimeout(waitForDashboard, 100);
            return;
        }
        
        enhanceMissionsWidget();
    }
    
    /**
     * Enhance the missions widget with modern design
     */
    function enhanceMissionsWidget() {
        // Wait for MissionsWidget to be available
        const checkForWidget = setInterval(() => {
            // Find the missions widget instance
            const widgetsManager = window.dashboardWidgets;
            if (widgetsManager && widgetsManager.widgets) {
                const missionsWidget = widgetsManager.widgets.get('missions');
                if (missionsWidget) {
                    clearInterval(checkForWidget);
                    
                    // Override the render method
                    const originalRender = missionsWidget.render.bind(missionsWidget);
                    missionsWidget.render = async function() {
                        try {
                            // Get the data first
                            const alerts = await window.dashboardManager.loadCriticalAlerts();
                            
                            // Use our modern rendering
                            const modernHtml = renderModernMissions(alerts);
                            
                            // Update the container
                            if (this.container) {
                                this.container.innerHTML = modernHtml;
                            }
                        } catch (error) {
                            console.error('Error rendering modern missions:', error);
                            // Fallback to original
                            return originalRender();
                        }
                    };
                    
                    // Trigger a re-render
                    missionsWidget.render();
                }
            }
        }, 100);
        
        // Also create the widget if it doesn't exist
        setTimeout(() => {
            clearInterval(checkForWidget);
            createMissionsWidgetIfMissing();
        }, 5000);
    }
    
    function createMissionsWidgetIfMissing() {
        // Check if there's a container for missions but no widget
        const container = document.querySelector('[data-widget="missions"], .missions-container');
        if (container && window.dashboardWidgets && !window.dashboardWidgets.widgets.get('missions')) {
            // Create a custom missions widget
            const missionsWidget = {
                id: 'missions',
                container: container,
                render: async function() {
                    const alerts = await window.dashboardManager.loadCriticalAlerts();
                    container.innerHTML = renderModernMissions(alerts);
                }
            };
            
            window.dashboardWidgets.widgets.set('missions', missionsWidget);
            missionsWidget.render();
        }
    }
    
    /**
     * Render modern missions widget
     */
    function renderModernMissions(data) {
        // Get missions from red and yellow zones
        const primaryMissions = data.red || [];
        const secondaryMissions = data.yellow || [];
        const totalMissions = primaryMissions.length + secondaryMissions.length;
        const completedCount = 0; // Would need to track this in actual implementation
        
        let html = `
            <div class="missions-widget">
                <!-- Header -->
                <div class="missions-header">
                    <div class="missions-title">
                        Today's Missions
                    </div>
                    <div class="missions-progress">
                        <div class="progress-circles">
                            ${Array(Math.max(2, totalMissions)).fill().map((_, i) => 
                                `<div class="progress-circle ${i < completedCount ? 'completed' : ''}"></div>`
                            ).join('')}
                        </div>
                        <span>${completedCount}/${totalMissions} Complete</span>
                    </div>
                </div>
        `;
        
        if (totalMissions === 0) {
            html += `
                <div class="missions-empty">
                    <div class="missions-empty-icon">üéâ</div>
                    <div class="missions-empty-text">All missions complete! Great work!</div>
                </div>
            `;
        } else {
            // Primary Objectives
            if (primaryMissions.length > 0) {
                html += `
                    <div class="mission-section primary">
                        <div class="mission-section-header">
                            <div class="mission-label">
                                <div class="icon">üéØ</div>
                                Primary Objective
                            </div>
                            <div class="mission-time">Est. ${primaryMissions.length * 5} min</div>
                        </div>
                        <div class="mission-items">
                `;
                
                primaryMissions.forEach(mission => {
                    const clientInfo = mission.client ? 
                        `<span class="mission-client">${mission.client.initials || 'Client'}</span>` : '';
                    
                    html += `
                        <div class="mission-item critical">
                            <div class="mission-checkbox">
                                <input type="checkbox" 
                                       id="mission-${mission.type}-${mission.client?.id}"
                                       ${mission.isTrackerTask ? 
                                         `onclick="dashboardWidgets.completeTrackerItem('${mission.client?.id}', '${mission.trackerId}')"` :
                                         `onclick="dashboardWidgets.completeMission('${mission.type}', '${mission.client?.id}')"` 
                                       }>
                            </div>
                            <div class="mission-content">
                                ${clientInfo}
                                <span class="mission-text">${mission.message}</span>
                                ${mission.priority === 'red' ? '<span class="mission-critical">CRITICAL</span>' : ''}
                            </div>
                            ${mission.action && mission.action !== 'Mark Complete' ? 
                                `<button class="mission-action" onclick="dashboardWidgets.takeAction('${mission.type}', '${mission.client?.id}')">
                                    ${mission.action}
                                </button>` : ''
                            }
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Secondary Objectives
            if (secondaryMissions.length > 0) {
                html += `
                    <div class="mission-section secondary">
                        <div class="mission-section-header">
                            <div class="mission-label">
                                <div class="icon">üé™</div>
                                Secondary Objectives
                            </div>
                            <div class="mission-time">Est. ${secondaryMissions.length * 5} min</div>
                        </div>
                        <div class="mission-items">
                `;
                
                secondaryMissions.forEach(mission => {
                    const clientInfo = mission.client ? 
                        `<span class="mission-client">${mission.client.initials || 'Client'}</span>` : '';
                    
                    html += `
                        <div class="mission-item">
                            <div class="mission-checkbox">
                                <input type="checkbox" 
                                       id="mission-${mission.type}-${mission.client?.id}"
                                       ${mission.isTrackerTask ? 
                                         `onclick="dashboardWidgets.completeTrackerItem('${mission.client?.id}', '${mission.trackerId}')"` :
                                         `onclick="dashboardWidgets.completeMission('${mission.type}', '${mission.client?.id}')"` 
                                       }>
                            </div>
                            <div class="mission-content">
                                ${clientInfo}
                                <span class="mission-text">${mission.message}</span>
                            </div>
                            ${mission.action && mission.action !== 'Mark Complete' ? 
                                `<button class="mission-action" onclick="dashboardWidgets.takeAction('${mission.type}', '${mission.client?.id}')">
                                    ${mission.action}
                                </button>` : ''
                            }
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
        }
        
        html += `
            </div>
            
            <!-- Quick Actions Bar -->
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="dashboardWidgets.openAddClient()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        ‚ûï
                    </div>
                    <span class="quick-action-label">Add Client</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.openGenerateDoc()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                        üìÑ
                    </div>
                    <span class="quick-action-label">Generate Doc</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.showAllAlerts()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        üîî
                    </div>
                    <span class="quick-action-label">All Alerts</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.exportReport()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        üìä
                    </div>
                    <span class="quick-action-label">Export Report</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.toggleFocusMode()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                        üéØ
                    </div>
                    <span class="quick-action-label">Focus Mode</span>
                </button>
                
                <button class="quick-action-btn" onclick="location.reload()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                        üîÑ
                    </div>
                    <span class="quick-action-label">Refresh</span>
                </button>
            </div>
        `;
        
        return html;
    }
    
    // Add mission completion handler if it doesn't exist
    if (window.dashboardWidgets && !window.dashboardWidgets.completeMission) {
        window.dashboardWidgets.completeMission = async function(missionType, clientId) {
            // Mark mission as complete
            console.log('Completing mission:', missionType, clientId);
            
            // Add completion animation
            const checkbox = document.querySelector(`#mission-${missionType}-${clientId}`);
            if (checkbox) {
                checkbox.checked = true;
                const missionItem = checkbox.closest('.mission-item');
                if (missionItem) {
                    missionItem.style.opacity = '0.5';
                    missionItem.style.textDecoration = 'line-through';
                }
            }
            
            // Update progress
            setTimeout(() => {
                window.dashboardManager.refreshDashboard();
            }, 500);
        };
    }
    
    // Add placeholder methods for quick actions if they don't exist
    const placeholderMethods = {
        openAddClient: () => console.log('Open Add Client modal'),
        openGenerateDoc: () => {
            // Try to open document creator if available
            const docBtn = document.querySelector('[onclick*="showDocumentCreator"]');
            if (docBtn) docBtn.click();
            else console.log('Open Generate Doc');
        },
        showAllAlerts: () => {
            // Show all zones if collapsed
            document.querySelectorAll('.zone-content.collapsed').forEach(zone => {
                zone.classList.remove('collapsed');
            });
        },
        exportReport: () => {
            // Try to trigger export if available
            if (window.exportDashboardData) {
                window.exportDashboardData();
            } else {
                console.log('Export Report');
            }
        },
        toggleFocusMode: () => {
            // Hide all except missions widget
            document.body.classList.toggle('focus-mode');
            if (document.body.classList.contains('focus-mode')) {
                // Hide other widgets
                document.querySelectorAll('.widget-card').forEach(widget => {
                    if (!widget.querySelector('.missions-widget')) {
                        widget.style.display = 'none';
                    }
                });
            } else {
                // Show all widgets
                document.querySelectorAll('.widget-card').forEach(widget => {
                    widget.style.display = '';
                });
            }
        }
    };
    
    // Add methods if they don't exist
    Object.keys(placeholderMethods).forEach(method => {
        if (window.dashboardWidgets && !window.dashboardWidgets[method]) {
            window.dashboardWidgets[method] = placeholderMethods[method];
        }
    });
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDashboard);
    } else {
        waitForDashboard();
    }
})();
}


// Enhancement: morning-review.js
/**
 * Morning Review Dashboard UI Enhancement
 * Adds morning review button and functionality
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.morningReview || !window.dashboardManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        addMorningReviewButton();
        checkAutoShowMorningReview();
    }
    
    /**
     * Add morning review button to dashboard
     */
    function addMorningReviewButton() {
        // Check every second for dashboard controls
        const checkInterval = setInterval(() => {
            const dashboardControls = document.querySelector('.dashboard-controls');
            if (dashboardControls) {
                clearInterval(checkInterval);
                
                // Check if button already exists
                if (document.querySelector('.btn-morning-review')) return;
                
                // Add the button
                const morningBtn = document.createElement('button');
                morningBtn.className = 'btn-morning-review';
                morningBtn.innerHTML = '‚òÄÔ∏è Morning Review';
                morningBtn.onclick = () => window.morningReview.renderMorningReview();
                
                // Insert before other buttons
                const firstButton = dashboardControls.querySelector('button');
                if (firstButton && firstButton.parentNode === dashboardControls) {
                    try {
                        dashboardControls.insertBefore(morningBtn, firstButton);
                    } catch (err) {
                        console.warn('Could not insert Morning Review button:', err);
                        dashboardControls.appendChild(morningBtn);
                    }
                } else {
                    dashboardControls.appendChild(morningBtn);
                }
                
                // Add notification badge if tasks are overdue
                checkForNotificationBadge();
            }
        }, 1000);
        
        // Stop checking after 30 seconds
        setTimeout(() => clearInterval(checkInterval), 30000);
    }
    
    /**
     * Check if we should auto-show morning review
     */
    function checkAutoShowMorningReview() {
        const hour = new Date().getHours();
        const lastShown = localStorage.getItem('lastMorningReviewDate');
        const today = new Date().toDateString();
        
        // Show automatically once per day in the morning (6am - 10am)
        if (hour >= 6 && hour <= 10 && lastShown !== today) {
            // Wait for dashboard to load
            setTimeout(() => {
                window.morningReview.renderMorningReview();
                localStorage.setItem('lastMorningReviewDate', today);
            }, 3000);
        }
    }
    
    /**
     * Add notification badge if there are overdue items
     */
    async function checkForNotificationBadge() {
        try {
            const clients = await window.clientManager.getAllClients();
            let overdueCount = 0;
            
            for (const client of clients) {
                if (client.status !== 'active') continue;
                
                const score = window.trackerEngine?.getCompletionScore(client);
                if (score && score.missingCritical) {
                    const daysInCare = window.trackerEngine.calculateDaysInCare(client.admissionDate);
                    const overdue = score.missingCritical.filter(item => daysInCare > item.dueByDay);
                    overdueCount += overdue.length;
                }
            }
            
            if (overdueCount > 0) {
                const morningBtn = document.querySelector('.btn-morning-review');
                if (morningBtn && !morningBtn.querySelector('.notification-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = overdueCount;
                    morningBtn.appendChild(badge);
                }
            }
        } catch (error) {
            console.error('Error checking for overdue items:', error);
        }
    }
    
    /**
     * Add keyboard shortcut
     */
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + M for Morning Review
        if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
            e.preventDefault();
            if (window.morningReview) {
                window.morningReview.renderMorningReview();
            }
        }
    });
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();

// Add notification badge styles
if (!document.querySelector('#morning-review-badge-styles')) {
    const style = document.createElement('style');
    style.id = 'morning-review-badge-styles';
    style.textContent = `
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
        
        .btn-morning-review {
            position: relative;
        }
    `;
    document.head.appendChild(style);
}


// Enhancement: quick-actions-complete.js
/**
 * Dashboard Quick Actions Enhancement
 * Completes implementation of all quick action buttons
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardWidgets || !window.clientManager || !window.showModal) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceQuickActions();
    }
    
    function enhanceQuickActions() {
        // Override quickGenerateDoc with full client-centric workflow
        window.dashboardWidgets.quickGenerateDoc = async function() {
            try {
                // Step 1: Select client
                const clients = await window.clientManager.getAllClients();
                const activeClients = clients.filter(c => c.status === 'active');
                
                if (activeClients.length === 0) {
                    window.showNotification('No active clients found', 'warning');
                    return;
                }
                
                // Build client selection HTML
                let clientOptionsHtml = `
                    <div class="client-selection-grid">
                        ${activeClients.map(client => {
                            const daysInCare = window.daysBetween(client.admissionDate) || 0;
                            return `
                                <label class="client-option">
                                    <input type="radio" name="selectedClient" value="${client.id}">
                                    <div class="client-card-mini">
                                        <span class="client-initials">${client.initials}</span>
                                        <span class="client-house">${client.houseId || 'No House'}</span>
                                        <span class="client-days">Day ${daysInCare}</span>
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>
                `;
                
                let selectedClientId = null;
                
                window.showModal({
                    title: 'üìÑ Generate Document - Select Client',
                    content: clientOptionsHtml,
                    size: 'large',
                    buttons: [
                        {
                            text: 'Next',
                            primary: true,
                            action: () => {
                                const selected = document.querySelector('input[name="selectedClient"]:checked');
                                if (!selected) {
                                    window.showNotification('Please select a client', 'warning');
                                    return;
                                }
                                selectedClientId = selected.value;
                                window.closeModal();
                                selectDocumentType(selectedClientId);
                            }
                        },
                        {
                            text: 'Cancel',
                            action: () => window.closeModal()
                        }
                    ]
                });
                
            } catch (error) {
                console.error('Error in quickGenerateDoc:', error);
                window.showNotification('Failed to start document generation', 'error');
            }
        };
        
        // Step 2: Select document type
        async function selectDocumentType(clientId) {
            const client = await window.clientManager.getClient(clientId);
            const daysInCare = window.daysBetween(client.admissionDate) || 0;
            
            const documentTypes = [
                {
                    id: 'aftercare-options',
                    name: 'Aftercare Options',
                    icon: 'üìã',
                    description: 'Compare aftercare programs for family',
                    recommended: daysInCare >= 14
                },
                {
                    id: 'aftercare-plan',
                    name: 'Aftercare Plan',
                    icon: 'üìÑ',
                    description: 'Detailed placement plan',
                    recommended: daysInCare >= 21
                },
                {
                    id: 'discharge-packet',
                    name: 'Discharge Packet',
                    icon: 'üì¶',
                    description: 'Complete discharge documentation',
                    recommended: daysInCare >= 25 || client.dischargeDate
                }
            ];
            
            const typeOptionsHtml = `
                <div class="selected-client-info">
                    <strong>Client:</strong> ${client.initials} - ${client.houseId} (Day ${daysInCare})
                </div>
                <div class="document-type-grid">
                    ${documentTypes.map(type => `
                        <label class="document-type-option ${type.recommended ? 'recommended' : ''}">
                            <input type="radio" name="documentType" value="${type.id}">
                            <div class="type-card">
                                <span class="type-icon">${type.icon}</span>
                                <span class="type-name">${type.name}</span>
                                <span class="type-description">${type.description}</span>
                                ${type.recommended ? '<span class="recommended-badge">Recommended</span>' : ''}
                            </div>
                        </label>
                    `).join('')}
                </div>
            `;
            
            window.showModal({
                title: 'üìÑ Select Document Type',
                content: typeOptionsHtml,
                size: 'medium',
                buttons: [
                    {
                        text: 'Next',
                        primary: true,
                        action: async () => {
                            const selected = document.querySelector('input[name="documentType"]:checked');
                            if (!selected) {
                                window.showNotification('Please select a document type', 'warning');
                                return;
                            }
                            window.closeModal();
                            
                            // For discharge packet, go directly to generation
                            if (selected.value === 'discharge-packet') {
                                generateDischargePacket(client);
                            } else {
                                // For other types, select programs
                                selectPrograms(client, selected.value);
                            }
                        }
                    },
                    {
                        text: 'Back',
                        action: () => {
                            window.closeModal();
                            window.dashboardWidgets.quickGenerateDoc();
                        }
                    }
                ]
            });
        }
        
        // Step 3: Select programs (for non-discharge documents)
        async function selectPrograms(client, documentType) {
            // Switch to programs tab to ensure programs are loaded
            window.switchTab('programs');
            
            // Wait for programs to load
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Show program selection in modal
            window.showNotification('Select programs from the Programs tab, then generate document', 'info', '', 5000);
            
            // Store context for document generation
            window.documentGenerationContext = {
                clientId: client.id,
                client: client,
                documentType: documentType
            };
        }
        
        // Generate discharge packet
        async function generateDischargePacket(client) {
            window.showNotification('Generating discharge packet...', 'info');
            
            // Switch to programs tab and trigger discharge packet creation
            window.switchTab('programs');
            
            // Store context
            window.documentGenerationContext = {
                clientId: client.id,
                client: client,
                documentType: 'discharge-packet'
            };
            
            // Wait for tab to load then trigger
            setTimeout(() => {
                if (window.createDischargePacket) {
                    window.createDischargePacket();
                }
            }, 500);
        }
        
        // Enhanced viewAllAlerts with filtering and actions
        window.dashboardWidgets.viewAllAlerts = async function() {
            const alerts = window.dashboardManager.cache.priorities;
            let currentFilter = 'all';
            
            function renderAlertsModal() {
                const zones = ['red', 'purple', 'yellow', 'green'];
                let filteredAlerts = {};
                
                // Apply filter
                if (currentFilter === 'all') {
                    filteredAlerts = alerts;
                } else {
                    filteredAlerts[currentFilter] = alerts[currentFilter] || [];
                }
                
                let content = `
                    <div class="alerts-modal-header">
                        <div class="alert-filters">
                            <button class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" 
                                    onclick="window.filterAlerts('all')">All Zones</button>
                            ${zones.map(zone => `
                                <button class="filter-btn zone-${zone} ${currentFilter === zone ? 'active' : ''}" 
                                        onclick="window.filterAlerts('${zone}')">
                                    ${zone.charAt(0).toUpperCase() + zone.slice(1)} (${(alerts[zone] || []).length})
                                </button>
                            `).join('')}
                        </div>
                        <div class="alert-actions">
                            <button class="btn btn-sm" onclick="window.exportAlerts()">
                                üìä Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="alerts-content">
                `;
                
                let hasAlerts = false;
                
                for (const [zone, items] of Object.entries(filteredAlerts)) {
                    if (!items || items.length === 0) continue;
                    hasAlerts = true;
                    
                    content += `
                        <div class="alert-zone-section">
                            <h4 class="zone-header zone-${zone}">
                                ${zone.charAt(0).toUpperCase() + zone.slice(1)} Zone
                            </h4>
                            <div class="alert-items">
                    `;
                    
                    for (const item of items) {
                        content += `
                            <div class="alert-item" onclick="window.navigateToAlert('${item.client.id}', '${item.type}')">
                                <div class="alert-client">
                                    <span class="client-badge">${item.client.initials}</span>
                                    <span class="house-badge">${item.client.houseId}</span>
                                </div>
                                <div class="alert-details">
                                    <div class="alert-message">${item.message}</div>
                                    ${item.dueDate ? `<div class="alert-due">Due: ${item.dueDate}</div>` : ''}
                                </div>
                                <div class="alert-actions">
                                    ${item.isTrackerTask ? 
                                        `<button class="btn btn-sm btn-success" 
                                                onclick="event.stopPropagation(); window.completeAlert('${item.client.id}', '${item.trackerId}')">
                                            ‚úì Complete
                                        </button>` : 
                                        `<button class="btn btn-sm" 
                                                onclick="event.stopPropagation(); window.takeAlertAction('${item.type}', '${item.client.id}')">
                                            ${item.action || 'View'}
                                        </button>`
                                    }
                                </div>
                            </div>
                        `;
                    }
                    
                    content += `
                            </div>
                        </div>
                    `;
                }
                
                if (!hasAlerts) {
                    content += `
                        <div class="empty-state">
                            <p>No alerts found${currentFilter !== 'all' ? ' in ' + currentFilter + ' zone' : ''}</p>
                        </div>
                    `;
                }
                
                content += '</div>';
                
                return content;
            }
            
            // Global functions for modal interactions
            window.filterAlerts = function(filter) {
                currentFilter = filter;
                const modalBody = document.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.innerHTML = renderAlertsModal();
                }
            };
            
            window.navigateToAlert = function(clientId, type) {
                window.closeModal();
                window.viewClientDetails(clientId);
            };
            
            window.completeAlert = async function(clientId, trackerId) {
                await window.dashboardWidgets.completeTrackerItem(clientId, trackerId);
                // Refresh modal
                window.dashboardManager.refreshDashboard();
                window.filterAlerts(currentFilter);
            };
            
            window.takeAlertAction = function(type, clientId) {
                window.closeModal();
                window.dashboardWidgets.takeAction(`action-${type}-${clientId}`, type, clientId);
            };
            
            window.exportAlerts = function() {
                const csv = generateAlertsCSV(alerts);
                downloadCSV(csv, `alerts-${new Date().toISOString().split('T')[0]}.csv`);
                window.showNotification('Alerts exported successfully', 'success');
            };
            
            // Show modal
            window.showModal({
                title: 'üîî All Alerts',
                content: renderAlertsModal(),
                size: 'large',
                buttons: [
                    {
                        text: 'Close',
                        action: () => window.closeModal()
                    }
                ]
            });
        };
        
        // Enhanced exportDashboard
        window.dashboardWidgets.exportDashboard = async function() {
            try {
                const data = {
                    exportDate: new Date().toISOString(),
                    coach: window.getCurrentCoach?.() || 'Unknown',
                    summary: {
                        totalClients: 0,
                        activeClients: 0,
                        criticalAlerts: 0,
                        todayTasks: 0
                    },
                    alerts: window.dashboardManager.cache.priorities,
                    clients: [],
                    milestones: []
                };
                
                // Gather all data
                const clients = await window.clientManager.getAllClients();
                data.summary.totalClients = clients.length;
                data.summary.activeClients = clients.filter(c => c.status === 'active').length;
                data.summary.criticalAlerts = (data.alerts.red || []).length;
                
                // Calculate today's tasks
                for (const zone of Object.values(data.alerts)) {
                    data.summary.todayTasks += zone.filter(item => 
                        item.dueDate && item.dueDate.includes('today')
                    ).length;
                }
                
                // Add client details
                for (const client of clients) {
                    const clientData = {
                        initials: client.initials,
                        house: client.houseId,
                        status: client.status,
                        admissionDate: client.admissionDate,
                        daysInCare: window.daysBetween(client.admissionDate),
                        trackerCompletion: 0
                    };
                    
                    // Calculate tracker completion
                    if (window.trackerEngine) {
                        const score = window.trackerEngine.getCompletionScore(client);
                        clientData.trackerCompletion = score.percentage;
                    }
                    
                    data.clients.push(clientData);
                }
                
                // Generate CSV
                const csv = generateDashboardCSV(data);
                downloadCSV(csv, `dashboard-export-${new Date().toISOString().split('T')[0]}.csv`);
                
                window.showNotification('Dashboard exported successfully', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                window.showNotification('Failed to export dashboard', 'error');
            }
        };
        
        // Enhanced enterFocusMode
        window.dashboardWidgets.enterFocusMode = function() {
            // Check if already in focus mode
            if (document.body.classList.contains('focus-mode')) {
                exitFocusMode();
                return;
            }
            
            // Enter focus mode
            document.body.classList.add('focus-mode');
            
            // Hide non-essential elements
            const elementsToHide = [
                '.header-controls',
                '.dashboard-controls',
                '#quickActionsWidget',
                '#missionsWidget',
                '.zone-yellow',
                '.zone-green'
            ];
            
            elementsToHide.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    el.dataset.focusHidden = 'true';
                    el.style.display = 'none';
                });
            });
            
            // Expand critical zones
            const redZone = document.querySelector('.zone-red');
            const purpleZone = document.querySelector('.zone-purple');
            
            if (redZone) {
                const content = redZone.querySelector('.zone-content');
                if (content) content.classList.add('expanded');
            }
            
            if (purpleZone) {
                const content = purpleZone.querySelector('.zone-content');
                if (content) content.classList.add('expanded');
            }
            
            // Add focus mode indicator
            const indicator = document.createElement('div');
            indicator.className = 'focus-mode-indicator';
            indicator.innerHTML = `
                <span>üéØ Focus Mode Active</span>
                <button onclick="window.dashboardWidgets.enterFocusMode()">Exit</button>
            `;
            document.body.appendChild(indicator);
            
            window.showNotification('Focus mode activated - showing only critical tasks', 'info');
        };
        
        function exitFocusMode() {
            document.body.classList.remove('focus-mode');
            
            // Restore hidden elements
            document.querySelectorAll('[data-focus-hidden="true"]').forEach(el => {
                el.style.display = '';
                delete el.dataset.focusHidden;
            });
            
            // Remove indicator
            const indicator = document.querySelector('.focus-mode-indicator');
            if (indicator) indicator.remove();
            
            window.showNotification('Focus mode deactivated', 'info');
        }
        
        // Helper functions
        function generateAlertsCSV(alerts) {
            let csv = 'Zone,Client,House,Message,Due Date,Type\n';
            
            for (const [zone, items] of Object.entries(alerts)) {
                for (const item of items) {
                    csv += `"${zone}","${item.client.initials}","${item.client.houseId}",`;
                    csv += `"${item.message.replace(/"/g, '""')}","${item.dueDate || ''}","${item.type}"\n`;
                }
            }
            
            return csv;
        }
        
        function generateDashboardCSV(data) {
            let csv = 'Dashboard Export\n';
            csv += `Export Date,${data.exportDate}\n`;
            csv += `Coach,${data.coach}\n\n`;
            
            csv += 'Summary\n';
            csv += `Total Clients,${data.summary.totalClients}\n`;
            csv += `Active Clients,${data.summary.activeClients}\n`;
            csv += `Critical Alerts,${data.summary.criticalAlerts}\n`;
            csv += `Today's Tasks,${data.summary.todayTasks}\n\n`;
            
            csv += 'Client Details\n';
            csv += 'Initials,House,Status,Admission Date,Days in Care,Tracker Completion\n';
            
            for (const client of data.clients) {
                csv += `${client.initials},${client.house},${client.status},`;
                csv += `${client.admissionDate},${client.daysInCare},${client.trackerCompletion}%\n`;
            }
            
            return csv;
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Add styles
        if (!document.querySelector('#quick-actions-styles')) {
            const styles = document.createElement('style');
            styles.id = 'quick-actions-styles';
            styles.textContent = `
                /* Client Selection Grid */
                .client-selection-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                    gap: 12px;
                    max-height: 400px;
                    overflow-y: auto;
                    padding: 4px;
                }
                
                .client-option {
                    cursor: pointer;
                }
                
                .client-option input {
                    position: absolute;
                    opacity: 0;
                }
                
                .client-card-mini {
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 12px;
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    transition: all 0.2s;
                }
                
                .client-option input:checked + .client-card-mini {
                    border-color: var(--ccp-primary-500);
                    background: var(--ccp-primary-100);
                }
                
                .client-card-mini:hover {
                    border-color: var(--ccp-primary-300);
                }
                
                /* Document Type Selection */
                .selected-client-info {
                    padding: 12px;
                    background: #f3f4f6;
                    border-radius: 6px;
                    margin-bottom: 16px;
                }
                
                .document-type-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 16px;
                }
                
                .document-type-option input {
                    position: absolute;
                    opacity: 0;
                }
                
                .type-card {
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 16px;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                    position: relative;
                }
                
                .document-type-option input:checked + .type-card {
                    border-color: var(--ccp-primary-500);
                    background: var(--ccp-primary-100);
                }
                
                .document-type-option.recommended .type-card {
                    border-color: var(--ccp-success-500);
                }
                
                .type-icon {
                    font-size: 32px;
                    text-align: center;
                }
                
                .type-name {
                    font-weight: 600;
                    font-size: 16px;
                }
                
                .type-description {
                    font-size: 14px;
                    color: #6b7280;
                }
                
                .recommended-badge {
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background: var(--ccp-success-500);
                    color: white;
                    font-size: 11px;
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-weight: 600;
                }
                
                /* Alerts Modal */
                .alerts-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 16px;
                    border-bottom: 1px solid #e5e7eb;
                }
                
                .alert-filters {
                    display: flex;
                    gap: 8px;
                }
                
                .filter-btn {
                    padding: 6px 12px;
                    border: 1px solid #e5e7eb;
                    background: white;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .filter-btn.active {
                    background: var(--ccp-primary-500);
                    color: white;
                    border-color: var(--ccp-primary-500);
                }
                
                .filter-btn.zone-red.active {
                    background: #ef4444;
                    border-color: #ef4444;
                }
                
                .filter-btn.zone-purple.active {
                    background: #a855f7;
                    border-color: #a855f7;
                }
                
                .filter-btn.zone-yellow.active {
                    background: #eab308;
                    border-color: #eab308;
                }
                
                .filter-btn.zone-green.active {
                    background: #22c55e;
                    border-color: #22c55e;
                }
                
                .alerts-content {
                    max-height: 500px;
                    overflow-y: auto;
                }
                
                .alert-zone-section {
                    margin-bottom: 24px;
                }
                
                .zone-header {
                    font-size: 16px;
                    font-weight: 600;
                    margin-bottom: 12px;
                    padding-left: 12px;
                    border-left: 4px solid;
                }
                
                .zone-header.zone-red {
                    border-left-color: #ef4444;
                    color: #dc2626;
                }
                
                .zone-header.zone-purple {
                    border-left-color: #a855f7;
                    color: #9333ea;
                }
                
                .zone-header.zone-yellow {
                    border-left-color: #eab308;
                    color: #ca8a04;
                }
                
                .zone-header.zone-green {
                    border-left-color: #22c55e;
                    color: #16a34a;
                }
                
                .alert-item {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 12px;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .alert-item:hover {
                    background: #f9fafb;
                    border-color: #d1d5db;
                }
                
                .alert-client {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                    flex-shrink: 0;
                }
                
                .alert-details {
                    flex: 1;
                }
                
                .alert-message {
                    font-size: 14px;
                }
                
                .alert-due {
                    font-size: 12px;
                    color: #6b7280;
                    margin-top: 2px;
                }
                
                /* Focus Mode */
                .focus-mode-indicator {
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #1f2937;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                }
                
                .focus-mode-indicator button {
                    background: white;
                    color: #1f2937;
                    border: none;
                    padding: 4px 12px;
                    border-radius: 12px;
                    cursor: pointer;
                    font-size: 12px;
                }
                
                body.focus-mode .dashboard-widget:not(#flightPlanWidget) {
                    opacity: 0.3;
                }
                
                body.focus-mode #flightPlanWidget {
                    transform: scale(1.05);
                    transition: transform 0.3s;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Quick actions enhanced successfully');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: document-generator-ui.js
/**
 * Document Generator UI Integration
 * Adds document generation buttons throughout the UI
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.documentGenerator || !window.dashboardWidgets || !window.clientManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        integrateDocumentGenerator();
    }
    
    function integrateDocumentGenerator() {
        // Add document generation button to dashboard header
        let dashboardButtonAdded = false;
        const addDashboardButton = () => {
            if (dashboardButtonAdded) return;
            
            const dashboardControls = document.querySelector('.dashboard-controls');
            if (dashboardControls && !document.querySelector('#btnGenerateDoc')) {
                const button = document.createElement('button');
                button.id = 'btnGenerateDoc';
                button.className = 'btn btn-primary';
                button.innerHTML = 'üìÑ Generate Document';
                button.onclick = () => window.generateDocument();
                
                // Insert before the first button
                const firstButton = dashboardControls.querySelector('button');
                if (firstButton && firstButton.parentNode === dashboardControls) {
                    try {
                        dashboardControls.insertBefore(button, firstButton);
                        dashboardButtonAdded = true;
                    } catch (err) {
                        console.warn('Could not insert button before first button:', err);
                        dashboardControls.appendChild(button);
                        dashboardButtonAdded = true;
                    }
                } else {
                    dashboardControls.appendChild(button);
                    dashboardButtonAdded = true;
                }
            }
        };
        
        // Enhance client cards with quick document generation
        const originalRenderClient = window.dashboardWidgets?.renderClient;
        if (originalRenderClient) {
            window.dashboardWidgets.renderClient = function(client) {
                let html = originalRenderClient.call(this, client);
                
                // Add document generation button to client card actions
                const daysInCare = window.daysBetween(client.admissionDate) || 0;
                const hasRecommendedDocs = window.documentGenerator.getRecommendedDocuments(client, daysInCare).length > 0;
                
                if (hasRecommendedDocs) {
                    const buttonHtml = `
                        <button class="btn-doc-gen-quick" 
                                onclick="window.generateDocument('${client.id}')"
                                title="Generate document for ${client.initials}">
                            üìÑ
                        </button>
                    `;
                    
                    // Insert button before the last closing div
                    const insertPos = html.lastIndexOf('</div>');
                    html = html.slice(0, insertPos) + buttonHtml + html.slice(insertPos);
                }
                
                return html;
            };
        }
        
        // Override the quickGenerateDoc to use our new system
        if (window.dashboardWidgets?.quickGenerateDoc) {
            window.dashboardWidgets.quickGenerateDoc = function() {
                window.generateDocument();
            };
        }
        
        // Add keyboard shortcut (Ctrl+D for document)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                window.generateDocument();
            }
        });
        
        // Listen for document generation events to refresh dashboard
        window.addEventListener('document:generated', (e) => {
            console.log('Document generated:', e.detail);
            
            // Refresh dashboard if available
            if (window.dashboardManager) {
                window.dashboardManager.refreshDashboard();
            }
            
            // Update tracker display if visible
            const trackerModal = document.querySelector('.tracker-modal');
            if (trackerModal) {
                const clientId = e.detail.clientId;
                // Refresh tracker display
                if (window.TrackerBulkUpdate?.instance) {
                    window.TrackerBulkUpdate.instance.loadClients();
                }
            }
        });
        
        // Add document generation to client details modal
        const originalShowClientDetailsModal = window.showClientDetailsModal;
        if (originalShowClientDetailsModal) {
            window.showClientDetailsModal = async function(client) {
                // Call original function
                await originalShowClientDetailsModal.call(this, client);
                
                // Add document section to the modal after a delay
                setTimeout(() => {
                    const modalBody = document.querySelector('.modal-body');
                    if (modalBody && !modalBody.querySelector('.client-documents-section')) {
                        const documents = window.documentGenerator.getClientDocuments(client.id);
                        const daysInCare = window.daysBetween(client.admissionDate) || 0;
                        const recommended = window.documentGenerator.getRecommendedDocuments(client, daysInCare);
                        
                        const documentsHtml = `
                            <div class="client-documents-section">
                                <h4>üìÑ Documents</h4>
                                
                                ${recommended.length > 0 ? `
                                    <div class="recommended-documents">
                                        <h5>Recommended Documents</h5>
                                        <div class="doc-recommendations">
                                            ${recommended.map(doc => `
                                                <button class="btn-doc-recommend" 
                                                        onclick="window.generateDocument('${client.id}', '${doc.key}')">
                                                    ${doc.icon} ${doc.name}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="document-history">
                                    <h5>Document History</h5>
                                    ${documents.length > 0 ? `
                                        <div class="doc-history-list">
                                            ${documents.map(doc => `
                                                <div class="doc-history-item">
                                                    <span class="doc-icon">${window.documentGenerator.documentTypes[doc.type]?.icon || 'üìÑ'}</span>
                                                    <span class="doc-name">${doc.name}</span>
                                                    <span class="doc-date">${window.formatDate(doc.createdAt)}</span>
                                                    <button class="btn-doc-action" onclick="window.documentGenerator.viewDocument('${doc.id}')">View</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : '<p class="no-documents">No documents generated yet</p>'}
                                    
                                    <button class="btn btn-primary btn-sm" onclick="window.generateDocument('${client.id}')">
                                        Generate New Document
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        modalBody.insertAdjacentHTML('beforeend', documentsHtml);
                    }
                }, 200);
            };
        }
        
        // Add styles
        if (!document.querySelector('#document-generator-ui-styles')) {
            const styles = document.createElement('style');
            styles.id = 'document-generator-ui-styles';
            styles.textContent = `
                /* Dashboard button */
                #btnGenerateDoc {
                    margin-right: 8px;
                }
                
                /* Client card quick button */
                .btn-doc-gen-quick {
                    position: absolute;
                    top: 8px;
                    right: 40px;
                    background: var(--ccp-primary-100);
                    border: 1px solid var(--ccp-primary-300);
                    border-radius: 6px;
                    padding: 4px 8px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .btn-doc-gen-quick:hover {
                    background: var(--ccp-primary-200);
                    transform: translateY(-1px);
                }
                
                /* Client documents section */
                .client-documents-section {
                    margin-top: 24px;
                    padding-top: 24px;
                    border-top: 2px solid #e5e7eb;
                }
                
                .client-documents-section h4 {
                    margin: 0 0 16px 0;
                    color: #1f2937;
                }
                
                .client-documents-section h5 {
                    margin: 0 0 12px 0;
                    color: #374151;
                    font-size: 16px;
                }
                
                .recommended-documents {
                    background: #f0f9ff;
                    padding: 16px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                }
                
                .doc-recommendations {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                }
                
                .btn-doc-recommend {
                    background: white;
                    border: 1px solid #3b82f6;
                    color: #3b82f6;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 14px;
                }
                
                .btn-doc-recommend:hover {
                    background: #3b82f6;
                    color: white;
                }
                
                .document-history {
                    background: #f9fafb;
                    padding: 16px;
                    border-radius: 8px;
                }
                
                .doc-history-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    margin-bottom: 16px;
                }
                
                .doc-history-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px;
                    background: white;
                    border-radius: 6px;
                    border: 1px solid #e5e7eb;
                }
                
                .doc-history-item .doc-icon {
                    font-size: 20px;
                }
                
                .doc-history-item .doc-name {
                    flex: 1;
                    font-size: 14px;
                }
                
                .doc-history-item .doc-date {
                    font-size: 12px;
                    color: #6b7280;
                }
                
                .btn-doc-action {
                    background: none;
                    border: 1px solid #e5e7eb;
                    padding: 4px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .btn-doc-action:hover {
                    background: #f3f4f6;
                    border-color: #d1d5db;
                }
                
                .no-documents {
                    text-align: center;
                    color: #6b7280;
                    font-style: italic;
                    margin: 16px 0;
                }
            `;
            document.head.appendChild(styles);
        }
        
        // Initialize dashboard button after DOM updates
        setTimeout(addDashboardButton, 500);
        
        // Re-add button when dashboard refreshes
        const observer = new MutationObserver(() => {
            addDashboardButton();
        });
        
        const dashboardContainer = document.querySelector('#dashboardTab');
        if (dashboardContainer) {
            observer.observe(dashboardContainer, { childList: true, subtree: true });
        }
        
        console.log('‚úÖ Document Generator UI integration complete');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: client-document-storage.js
/**
 * Client Document Storage Enhancement
 * Adds document storage to client records and document management features
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.clientManager || !window.documentGenerator) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceClientStorage();
    }
    
    function enhanceClientStorage() {
        // Extend client schema to include documents
        const originalCreateClient = window.clientManager.createClient;
        window.clientManager.createClient = async function(clientData) {
            // Ensure documents array exists
            clientData.documents = clientData.documents || [];
            return originalCreateClient.call(this, clientData);
        };
        
        // Extend update to handle documents
        const originalUpdateClient = window.clientManager.updateClient;
        window.clientManager.updateClient = async function(clientId, updates) {
            // If documents are being updated, handle special logic
            if (updates.documents) {
                const client = await this.getClient(clientId);
                if (client) {
                    // Merge documents arrays if adding
                    if (updates.$addToDocuments) {
                        updates.documents = [...(client.documents || []), ...updates.$addToDocuments];
                        delete updates.$addToDocuments;
                    }
                }
            }
            
            return originalUpdateClient.call(this, clientId, updates);
        };
        
        // Add method to add document to client
        window.clientManager.addDocument = async function(clientId, document) {
            const client = await this.getClient(clientId);
            if (!client) {
                throw new Error('Client not found');
            }
            
            // Ensure documents array exists
            if (!client.documents) {
                client.documents = [];
            }
            
            // Add document
            client.documents.push({
                ...document,
                addedAt: new Date().toISOString()
            });
            
            // Update client
            await this.updateClient(clientId, { documents: client.documents });
            
            return document;
        };
        
        // Add method to get client documents
        window.clientManager.getClientDocuments = async function(clientId) {
            const client = await this.getClient(clientId);
            return client?.documents || [];
        };
        
        // Override document generator to store with client
        const originalGenerateDocument = window.documentGenerator.generateDocument;
        window.documentGenerator.generateDocument = async function() {
            // Call original
            await originalGenerateDocument.call(this);
            
            // Get the generated document
            const workflow = this.activeWorkflow;
            if (workflow && workflow.client) {
                const lastDocument = this.generatedDocuments[this.generatedDocuments.length - 1];
                if (lastDocument) {
                    // Store with client
                    await window.clientManager.addDocument(workflow.client.id, lastDocument);
                    
                    // Fire event
                    window.dispatchEvent(new CustomEvent('client:documentAdded', {
                        detail: {
                            clientId: workflow.client.id,
                            document: lastDocument
                        }
                    }));
                }
            }
        };
        
        // Override getClientDocuments to use client storage
        window.documentGenerator.getClientDocuments = function(clientId) {
            // First check in-memory storage
            const inMemory = this.generatedDocuments.filter(doc => doc.clientId === clientId);
            
            // Then check client storage (async, so return promise)
            return window.clientManager.getClientDocuments(clientId).then(stored => {
                // Merge and deduplicate by ID
                const allDocs = [...inMemory];
                stored.forEach(doc => {
                    if (!allDocs.find(d => d.id === doc.id)) {
                        allDocs.push(doc);
                    }
                });
                
                // Sort by date (newest first)
                allDocs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                return allDocs;
            }).catch(() => inMemory); // Fallback to in-memory if error
        };
        
        // Add document vault functionality
        window.documentVault = {
            async getAllDocuments() {
                const clients = await window.clientManager.getAllClients();
                const allDocuments = [];
                
                for (const client of clients) {
                    const documents = await window.clientManager.getClientDocuments(client.id);
                    documents.forEach(doc => {
                        allDocuments.push({
                            ...doc,
                            clientInitials: client.initials,
                            clientHouse: client.houseId,
                            clientStatus: client.status
                        });
                    });
                }
                
                // Sort by date (newest first)
                allDocuments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                return allDocuments;
            },
            
            async searchDocuments(searchTerm) {
                const allDocs = await this.getAllDocuments();
                const term = searchTerm.toLowerCase();
                
                return allDocs.filter(doc => 
                    doc.name.toLowerCase().includes(term) ||
                    doc.clientInitials.toLowerCase().includes(term) ||
                    doc.type.toLowerCase().includes(term) ||
                    (doc.clientHouse && doc.clientHouse.toLowerCase().includes(term))
                );
            },
            
            async getDocumentsByType(type) {
                const allDocs = await this.getAllDocuments();
                return allDocs.filter(doc => doc.type === type);
            },
            
            async getDocumentsByDateRange(startDate, endDate) {
                const allDocs = await this.getAllDocuments();
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                return allDocs.filter(doc => {
                    const docDate = new Date(doc.createdAt);
                    return docDate >= start && docDate <= end;
                });
            },
            
            showVault() {
                window.showModal({
                    title: 'üóÉÔ∏è Document Vault',
                    content: '<div id="documentVaultContent">Loading...</div>',
                    size: 'large',
                    buttons: [
                        {
                            text: 'Export All',
                            action: () => this.exportAll()
                        },
                        {
                            text: 'Close',
                            primary: true,
                            action: () => window.closeModal()
                        }
                    ]
                });
                
                // Load vault content
                this.loadVaultContent();
            },
            
            async loadVaultContent() {
                const contentEl = document.getElementById('documentVaultContent');
                if (!contentEl) return;
                
                try {
                    const documents = await this.getAllDocuments();
                    
                    contentEl.innerHTML = `
                        <div class="vault-header">
                            <div class="vault-stats">
                                <span class="stat-item">üìÑ ${documents.length} Total Documents</span>
                            </div>
                            <div class="vault-search">
                                <input type="text" id="vaultSearch" placeholder="Search documents..." class="vault-search-input">
                                <select id="vaultTypeFilter" class="vault-filter">
                                    <option value="">All Types</option>
                                    <option value="aftercare-options">Aftercare Options</option>
                                    <option value="aftercare-plan">Aftercare Plan</option>
                                    <option value="discharge-packet">Discharge Packet</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="vault-documents" id="vaultDocumentsList">
                            ${documents.length > 0 ? documents.map(doc => `
                                <div class="vault-doc-item">
                                    <div class="vault-doc-icon">${window.documentGenerator.documentTypes[doc.type]?.icon || 'üìÑ'}</div>
                                    <div class="vault-doc-info">
                                        <div class="vault-doc-name">${doc.name}</div>
                                        <div class="vault-doc-meta">
                                            <span class="meta-item">üë§ ${doc.clientInitials}</span>
                                            <span class="meta-item">üè† ${doc.clientHouse || 'No House'}</span>
                                            <span class="meta-item">üìÖ ${window.formatDate(doc.createdAt)}</span>
                                            <span class="meta-item">‚úçÔ∏è ${doc.createdBy}</span>
                                        </div>
                                    </div>
                                    <div class="vault-doc-actions">
                                        <button class="btn btn-sm" onclick="window.documentGenerator.viewDocument('${doc.id}')">View</button>
                                        <button class="btn btn-sm" onclick="window.documentGenerator.printDocument('${doc.id}')">Print</button>
                                    </div>
                                </div>
                            `).join('') : '<p class="vault-empty">No documents in vault</p>'}
                        </div>
                    `;
                    
                    // Add search functionality
                    const searchInput = document.getElementById('vaultSearch');
                    const typeFilter = document.getElementById('vaultTypeFilter');
                    
                    const filterDocuments = async () => {
                        const searchTerm = searchInput.value;
                        const typeValue = typeFilter.value;
                        
                        let filtered = documents;
                        
                        if (searchTerm) {
                            filtered = await this.searchDocuments(searchTerm);
                        }
                        
                        if (typeValue) {
                            filtered = filtered.filter(doc => doc.type === typeValue);
                        }
                        
                        // Update list
                        const listEl = document.getElementById('vaultDocumentsList');
                        if (filtered.length > 0) {
                            listEl.innerHTML = filtered.map(doc => `
                                <div class="vault-doc-item">
                                    <div class="vault-doc-icon">${window.documentGenerator.documentTypes[doc.type]?.icon || 'üìÑ'}</div>
                                    <div class="vault-doc-info">
                                        <div class="vault-doc-name">${doc.name}</div>
                                        <div class="vault-doc-meta">
                                            <span class="meta-item">üë§ ${doc.clientInitials}</span>
                                            <span class="meta-item">üè† ${doc.clientHouse || 'No House'}</span>
                                            <span class="meta-item">üìÖ ${window.formatDate(doc.createdAt)}</span>
                                            <span class="meta-item">‚úçÔ∏è ${doc.createdBy}</span>
                                        </div>
                                    </div>
                                    <div class="vault-doc-actions">
                                        <button class="btn btn-sm" onclick="window.documentGenerator.viewDocument('${doc.id}')">View</button>
                                        <button class="btn btn-sm" onclick="window.documentGenerator.printDocument('${doc.id}')">Print</button>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            listEl.innerHTML = '<p class="vault-empty">No documents match your search</p>';
                        }
                    };
                    
                    searchInput.addEventListener('input', window.debounce(filterDocuments, 300));
                    typeFilter.addEventListener('change', filterDocuments);
                    
                } catch (error) {
                    console.error('Error loading vault:', error);
                    contentEl.innerHTML = '<p class="vault-error">Error loading documents</p>';
                }
            },
            
            async exportAll() {
                try {
                    const documents = await this.getAllDocuments();
                    
                    let csv = 'Document Name,Type,Client,House,Created Date,Created By\n';
                    
                    documents.forEach(doc => {
                        csv += `"${doc.name}","${doc.type}","${doc.clientInitials}",`;
                        csv += `"${doc.clientHouse || ''}","${window.formatDate(doc.createdAt)}","${doc.createdBy}"\n`;
                    });
                    
                    // Download CSV
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `document-vault-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    window.showNotification('Document vault exported successfully', 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    window.showNotification('Failed to export document vault', 'error');
                }
            }
        };
        
        // Add styles
        if (!document.querySelector('#client-document-storage-styles')) {
            const styles = document.createElement('style');
            styles.id = 'client-document-storage-styles';
            styles.textContent = `
                /* Document Vault Styles */
                .vault-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 16px;
                    border-bottom: 2px solid #e5e7eb;
                }
                
                .vault-stats {
                    display: flex;
                    gap: 20px;
                }
                
                .stat-item {
                    font-size: 16px;
                    font-weight: 500;
                    color: #374151;
                }
                
                .vault-search {
                    display: flex;
                    gap: 12px;
                }
                
                .vault-search-input {
                    width: 250px;
                    padding: 8px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                }
                
                .vault-filter {
                    padding: 8px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                    background: white;
                }
                
                .vault-documents {
                    max-height: 500px;
                    overflow-y: auto;
                }
                
                .vault-doc-item {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                    padding: 16px;
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    transition: all 0.2s;
                }
                
                .vault-doc-item:hover {
                    background: #f9fafb;
                    border-color: #d1d5db;
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                }
                
                .vault-doc-icon {
                    font-size: 32px;
                    flex-shrink: 0;
                }
                
                .vault-doc-info {
                    flex: 1;
                }
                
                .vault-doc-name {
                    font-weight: 600;
                    font-size: 16px;
                    color: #1f2937;
                    margin-bottom: 4px;
                }
                
                .vault-doc-meta {
                    display: flex;
                    gap: 16px;
                    font-size: 13px;
                    color: #6b7280;
                }
                
                .meta-item {
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }
                
                .vault-doc-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .vault-empty {
                    text-align: center;
                    color: #6b7280;
                    font-style: italic;
                    padding: 40px;
                }
                
                .vault-error {
                    text-align: center;
                    color: #ef4444;
                    padding: 40px;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Client document storage enhanced');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: document-vault-ui.js
/**
 * Document Vault UI Enhancement
 * Adds vault button to dashboard and integrates document storage UI
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.documentVault || !window.dashboardWidgets) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        integrateVaultUI();
    }
    
    function integrateVaultUI() {
        // Add vault button to dashboard header
        const addVaultButton = () => {
            const dashboardControls = document.querySelector('.dashboard-controls');
            if (dashboardControls && !document.querySelector('#btnDocumentVault')) {
                // Find the morning review button as reference point
                const morningReviewBtn = dashboardControls.querySelector('.btn-morning-review');
                
                const button = document.createElement('button');
                button.id = 'btnDocumentVault';
                button.className = 'btn btn-secondary';
                button.innerHTML = 'üóÉÔ∏è Document Vault';
                button.onclick = () => window.documentVault.showVault();
                button.title = 'View all generated documents';
                
                if (morningReviewBtn) {
                    morningReviewBtn.parentNode.insertBefore(button, morningReviewBtn.nextSibling);
                } else {
                    dashboardControls.appendChild(button);
                }
            }
        };
        
        // Add vault to quick actions
        const originalRender = window.dashboardWidgets.widgets.get('quickActions')?.render;
        if (originalRender) {
            window.dashboardWidgets.widgets.get('quickActions').render = function() {
                let html = originalRender.call(this);
                
                // Add vault action
                const vaultAction = `
                    <button class="quick-action-btn" onclick="window.documentVault.showVault()">
                        <span class="action-icon">üóÉÔ∏è</span>
                        <span class="action-label">Document Vault</span>
                    </button>
                `;
                
                // Insert before last closing div
                const insertPos = html.lastIndexOf('</div></div>');
                html = html.slice(0, insertPos) + vaultAction + html.slice(insertPos);
                
                return html;
            };
        }
        
        // Override document generator UI to update vault count
        const originalShowModal = window.documentGenerator.showModal;
        if (originalShowModal) {
            window.documentGenerator.showModal = async function(...args) {
                const result = originalShowModal.call(this, ...args);
                
                // Update vault button with document count
                const vaultBtn = document.querySelector('#btnDocumentVault');
                if (vaultBtn && window.documentVault) {
                    try {
                        const docs = await window.documentVault.getAllDocuments();
                        vaultBtn.innerHTML = `üóÉÔ∏è Vault (${docs.length})`;
                    } catch (e) {
                        console.error('Error updating vault count:', e);
                    }
                }
                
                return result;
            };
        }
        
        // Listen for document generation to update count
        window.addEventListener('client:documentAdded', async (e) => {
            const vaultBtn = document.querySelector('#btnDocumentVault');
            if (vaultBtn && window.documentVault) {
                try {
                    const docs = await window.documentVault.getAllDocuments();
                    vaultBtn.innerHTML = `üóÉÔ∏è Vault (${docs.length})`;
                } catch (e) {
                    console.error('Error updating vault count:', e);
                }
            }
        });
        
        // Add keyboard shortcut (Ctrl+V for vault)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'v' && !e.shiftKey) {
                e.preventDefault();
                window.documentVault.showVault();
            }
        });
        
        // Initialize vault button
        setTimeout(async () => {
            addVaultButton();
            
            // Update with initial count
            const vaultBtn = document.querySelector('#btnDocumentVault');
            if (vaultBtn && window.documentVault) {
                try {
                    const docs = await window.documentVault.getAllDocuments();
                    if (docs.length > 0) {
                        vaultBtn.innerHTML = `üóÉÔ∏è Vault (${docs.length})`;
                    }
                } catch (e) {
                    console.error('Error loading initial vault count:', e);
                }
            }
        }, 500);
        
        // Re-add button when dashboard refreshes
        const observer = new MutationObserver(() => {
            addVaultButton();
        });
        
        const dashboardContainer = document.querySelector('#dashboardTab');
        if (dashboardContainer) {
            observer.observe(dashboardContainer, { childList: true, subtree: true });
        }
        
        // Add styles for vault button
        if (!document.querySelector('#document-vault-ui-styles')) {
            const styles = document.createElement('style');
            styles.id = 'document-vault-ui-styles';
            styles.textContent = `
                #btnDocumentVault {
                    margin-left: 8px;
                    position: relative;
                }
                
                #btnDocumentVault.has-new::after {
                    content: '';
                    position: absolute;
                    top: -4px;
                    right: -4px;
                    width: 8px;
                    height: 8px;
                    background: #ef4444;
                    border-radius: 50%;
                    animation: pulse 2s infinite;
                }
                
                @keyframes pulse {
                    0% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.7; transform: scale(1.1); }
                    100% { opacity: 1; transform: scale(1); }
                }
                
                /* Quick action styling */
                .quick-action-btn[onclick*="documentVault"] {
                    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
                }
                
                .quick-action-btn[onclick*="documentVault"]:hover {
                    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Document Vault UI integrated');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: empty-states-errors.js
/**
 * Empty States and Error Handling Enhancement
 * Adds contextual empty states, loading indicators, and error recovery
 */

(function() {
    'use strict';
    
    // Loading state manager
    window.loadingManager = {
        activeLoaders: new Set(),
        
        show(id, message = 'Loading...') {
            this.activeLoaders.add(id);
            
            // Find container element
            const element = document.getElementById(id) || document.querySelector(`[data-widget="${id}"]`);
            if (!element) return;
            
            // Store original content
            if (!element.dataset.originalContent) {
                element.dataset.originalContent = element.innerHTML;
            }
            
            // Show loading state
            element.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p class="loading-message">${message}</p>
                </div>
            `;
            
            element.classList.add('is-loading');
        },
        
        hide(id) {
            this.activeLoaders.delete(id);
            
            const element = document.getElementById(id) || document.querySelector(`[data-widget="${id}"]`);
            if (!element) return;
            
            // Restore original content if available
            if (element.dataset.originalContent) {
                element.innerHTML = element.dataset.originalContent;
                delete element.dataset.originalContent;
            }
            
            element.classList.remove('is-loading');
        },
        
        isLoading(id) {
            return this.activeLoaders.has(id);
        }
    };
    
    // Empty state configurations
    const emptyStateConfigs = {
        flightPlan: {
            title: 'All Clear!',
            message: 'No urgent tasks at the moment. Great job staying on top of everything!',
            icon: '‚úÖ',
            action: {
                text: 'View All Clients',
                handler: () => window.dashboardManager?.setView('allClients')
            }
        },
        missions: {
            title: 'Mission Complete!',
            message: 'All tasks for today have been completed. Take a moment to review tomorrow\'s schedule.',
            icon: 'üéØ',
            action: {
                text: 'Morning Review',
                handler: () => window.morningReview?.show()
            }
        },
        journeyRadar: {
            title: 'No Active Clients',
            message: 'There are no active clients to display. Add a new client to get started.',
            icon: 'üë•',
            action: {
                text: 'Add Client',
                handler: () => window.showAddClientModal?.()
            }
        },
        houseWeather: {
            title: 'No House Data',
            message: 'House weather information will appear here once clients are assigned to houses.',
            icon: 'üè†'
        },
        default: {
            title: 'No Data Available',
            message: 'This section will populate once relevant data is available.',
            icon: '‚ÑπÔ∏è'
        }
    };
    
    // Error recovery strategies
    const errorRecovery = {
        async retry(fn, maxAttempts = 3, delay = 1000) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    lastError = error;
                    console.warn(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, delay * attempt));
                    }
                }
            }
            
            throw lastError;
        },
        
        handleError(widgetName, error, container) {
            console.error(`Error in ${widgetName}:`, error);
            
            const errorConfig = {
                title: 'Something went wrong',
                message: error.message || 'An unexpected error occurred',
                icon: '‚ö†Ô∏è',
                actions: [
                    {
                        text: 'Retry',
                        handler: () => window.dashboardManager?.refreshDashboard()
                    }
                ]
            };
            
            if (container) {
                container.innerHTML = this.renderErrorState(errorConfig);
            }
            
            // Report to error tracking if available
            if (window.errorTracker) {
                window.errorTracker.report(error, { widget: widgetName });
            }
        },
        
        renderErrorState(config) {
            return `
                <div class="error-state">
                    <div class="error-icon">${config.icon}</div>
                    <h3 class="error-title">${config.title}</h3>
                    <p class="error-message">${config.message}</p>
                    ${config.actions ? `
                        <div class="error-actions">
                            ${config.actions.map(action => `
                                <button class="btn btn-primary" onclick="(${action.handler})()">
                                    ${action.text}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
    };
    
    // Enhance widget rendering with empty states
    function enhanceWidgets() {
        if (!window.dashboardWidgets?.widgets) return;
        
        // Enhance each widget
        window.dashboardWidgets.widgets.forEach((widget, name) => {
            const originalRender = widget.render;
            if (!originalRender) return;
            
            widget.render = function() {
                const container = this.container;
                let widgetName = name;
                
                try {
                    // Show loading state
                    if (container) {
                        window.loadingManager.show(container.id || widgetName, `Loading ${widgetName}...`);
                    }
                    
                    // Call original render
                    let content = originalRender.call(this);
                    
                    // Check if content is empty or indicates no data
                    const isEmptyContent = !content || 
                        content.trim() === '' || 
                        content.includes('No data') ||
                        content.includes('no items') ||
                        (content.match(/<div/g) || []).length <= 2; // Just wrapper divs
                    
                    if (isEmptyContent) {
                        const config = emptyStateConfigs[widgetName] || emptyStateConfigs.default;
                        content = renderEmptyState(config);
                    }
                    
                    // Hide loading state
                    if (container) {
                        window.loadingManager.hide(container.id || widgetName);
                    }
                    
                    return content;
                    
                } catch (error) {
                    // Hide loading state
                    if (container) {
                        window.loadingManager.hide(container.id || widgetName);
                    }
                    
                    // Handle error
                    errorRecovery.handleError(widgetName, error, container);
                    return errorRecovery.renderErrorState({
                        title: 'Widget Error',
                        message: `Failed to load ${widgetName}`,
                        icon: '‚ùå',
                        actions: [{
                            text: 'Retry',
                            handler: () => this.refresh?.()
                        }]
                    });
                }
            };
            
            // Add retry capability
            if (!widget.retry) {
                widget.retry = async function() {
                    try {
                        await errorRecovery.retry(() => {
                            if (this.container) {
                                this.container.innerHTML = this.render();
                            }
                        });
                    } catch (error) {
                        errorRecovery.handleError(name, error, this.container);
                    }
                };
            }
        });
    }
    
    // Render empty state
    function renderEmptyState(config) {
        return `
            <div class="empty-state">
                <div class="empty-icon">${config.icon}</div>
                <h3 class="empty-title">${config.title}</h3>
                <p class="empty-message">${config.message}</p>
                ${config.action ? `
                    <button class="btn btn-primary empty-action" onclick="(${config.action.handler})()">
                        ${config.action.text}
                    </button>
                ` : ''}
            </div>
        `;
    }
    
    // Enhance data loading functions
    function enhanceDataLoading() {
        // Enhance clientManager
        if (window.clientManager) {
            const originalGetAllClients = window.clientManager.getAllClients;
            window.clientManager.getAllClients = async function() {
                return errorRecovery.retry(async () => {
                    const result = await originalGetAllClients.call(this);
                    if (!result) throw new Error('Failed to load clients');
                    return result;
                });
            };
        }
        
        // Enhance dashboard data loading
        if (window.dashboardManager) {
            const originalLoadDashboardData = window.dashboardManager.loadDashboardData;
            window.dashboardManager.loadDashboardData = async function() {
                const widgetContainer = document.querySelector('.dashboard-grid');
                if (widgetContainer) {
                    widgetContainer.classList.add('loading');
                }
                
                try {
                    const result = await errorRecovery.retry(() => 
                        originalLoadDashboardData.call(this)
                    );
                    
                    if (widgetContainer) {
                        widgetContainer.classList.remove('loading');
                    }
                    
                    return result;
                } catch (error) {
                    if (widgetContainer) {
                        widgetContainer.classList.remove('loading');
                    }
                    
                    // Show error notification
                    window.showNotification(
                        'Failed to load dashboard data. Please refresh the page.',
                        'error',
                        'Dashboard Error'
                    );
                    
                    throw error;
                }
            };
        }
    }
    
    // Add contextual help
    window.contextualHelp = {
        show(context) {
            const helpTexts = {
                'empty-flight-plan': 'The Daily Flight Plan shows urgent tasks that need attention. When it\'s empty, all critical items are handled!',
                'empty-missions': 'Today\'s Missions tracks your daily goals. Complete all missions to maintain excellent care standards.',
                'loading-error': 'If loading issues persist, try refreshing the page or clearing your browser cache.',
                'no-clients': 'Add your first client to start tracking their aftercare journey.'
            };
            
            const text = helpTexts[context] || 'Need help? Contact support for assistance.';
            
            window.showNotification(text, 'info', 'Tip', 5000);
        }
    };
    
    // Add loading states CSS
    if (!document.querySelector('#empty-states-errors-styles')) {
        const styles = document.createElement('style');
        styles.id = 'empty-states-errors-styles';
        styles.textContent = `
            /* Loading States */
            .loading-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                padding: 40px;
                text-align: center;
            }
            
            .loading-spinner {
                width: 48px;
                height: 48px;
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-top-color: var(--ccp-primary-500);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 16px;
            }
            
            .loading-message {
                color: #6b7280;
                font-size: 14px;
                margin: 0;
            }
            
            .is-loading {
                position: relative;
                pointer-events: none;
                opacity: 0.8;
            }
            
            .dashboard-grid.loading {
                opacity: 0.7;
                pointer-events: none;
            }
            
            /* Empty States */
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                padding: 40px 20px;
                text-align: center;
                animation: fadeIn 0.3s ease;
            }
            
            .empty-icon {
                font-size: 64px;
                margin-bottom: 16px;
                opacity: 0.7;
            }
            
            .empty-title {
                margin: 0 0 8px 0;
                font-size: 20px;
                font-weight: 600;
                color: #1f2937;
            }
            
            .empty-message {
                margin: 0 0 24px 0;
                color: #6b7280;
                font-size: 14px;
                max-width: 300px;
                line-height: 1.5;
            }
            
            .empty-action {
                margin-top: 8px;
            }
            
            /* Error States */
            .error-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                padding: 40px 20px;
                text-align: center;
                background: #fef2f2;
                border-radius: 8px;
                margin: 16px;
            }
            
            .error-icon {
                font-size: 48px;
                margin-bottom: 16px;
                color: #ef4444;
            }
            
            .error-title {
                margin: 0 0 8px 0;
                font-size: 18px;
                font-weight: 600;
                color: #991b1b;
            }
            
            .error-message {
                margin: 0 0 16px 0;
                color: #7f1d1d;
                font-size: 14px;
            }
            
            .error-actions {
                display: flex;
                gap: 12px;
                margin-top: 8px;
            }
            
            /* Animations */
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            /* Skeleton Loading */
            .skeleton {
                background: linear-gradient(
                    90deg,
                    #f3f4f6 25%,
                    #e5e7eb 50%,
                    #f3f4f6 75%
                );
                background-size: 200% 100%;
                animation: skeleton 1.5s infinite;
                border-radius: 4px;
            }
            
            .skeleton-text {
                height: 16px;
                margin-bottom: 8px;
            }
            
            .skeleton-title {
                height: 24px;
                width: 60%;
                margin-bottom: 16px;
            }
            
            @keyframes skeleton {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
            
            /* Help Tooltips */
            .help-tip {
                position: absolute;
                top: 8px;
                right: 8px;
                width: 20px;
                height: 20px;
                background: #e5e7eb;
                border-radius: 50%;
                cursor: help;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                color: #6b7280;
                transition: all 0.2s;
            }
            
            .help-tip:hover {
                background: #d1d5db;
                color: #374151;
            }
            
            /* Contextual Empty States */
            .zone-red .empty-state .empty-icon {
                color: #ef4444;
            }
            
            .zone-purple .empty-state .empty-icon {
                color: #a855f7;
            }
            
            .zone-yellow .empty-state .empty-icon {
                color: #eab308;
            }
            
            .zone-green .empty-state .empty-icon {
                color: #22c55e;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Initialize enhancements
    function initialize() {
        enhanceWidgets();
        enhanceDataLoading();
        
        console.log('‚úÖ Empty states and error handling initialized');
    }
    
    // Wait for dependencies
    if (window.dashboardWidgets && window.clientManager) {
        initialize();
    } else {
        const checkInterval = setInterval(() => {
            if (window.dashboardWidgets && window.clientManager) {
                clearInterval(checkInterval);
                initialize();
            }
        }, 100);
        
        setTimeout(() => clearInterval(checkInterval), 10000);
    }
})();





// Enhancement: alert-actionability.js
/**
 * Alert Actionability Enhancement
 * Makes alerts clickable, adds bulk actions, filters, and detailed alert modals
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardWidgets || !window.dashboardManager || !window.showModal) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceAlerts();
    }
    
    function enhanceAlerts() {
        // Enhance Flight Plan widget to make alerts clickable
        const flightPlanWidget = window.dashboardWidgets?.widgets?.get('flightPlan');
        if (flightPlanWidget) {
            const originalRenderPriorityItem = flightPlanWidget.renderPriorityItem;
            
            flightPlanWidget.renderPriorityItem = function(item, zone) {
                let html = originalRenderPriorityItem.call(this, item, zone);
                
                // Make the entire item clickable
                const itemWrapper = html.match(/<div[^>]*class="[^"]*priority-item[^"]*"[^>]*>/);
                if (itemWrapper) {
                    // Add click handler and cursor pointer
                    html = html.replace(
                        /<div([^>]*class="[^"]*priority-item[^"]*"[^>]*)>/,
                        '<div$1 onclick="window.handleAlertClick(event, \'' + item.client.id + '\', \'' + item.type + '\', \'' + zone + '\')" style="cursor: pointer;">'
                    );
                    
                    // Add hover effect class
                    html = html.replace(
                        /class="([^"]*priority-item[^"]*)"/,
                        'class="$1 alert-clickable"'
                    );
                }
                
                return html;
            };
        }
        
        // Global alert click handler
        window.handleAlertClick = function(event, clientId, alertType, zone) {
            // Prevent default if clicking on action buttons
            if (event.target.closest('button')) {
                return;
            }
            
            // Show alert details modal
            showAlertDetailsModal(clientId, alertType, zone);
        };
        
        // Show alert details modal
        async function showAlertDetailsModal(clientId, alertType, zone) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                // Get alert details
                const alert = getAlertDetails(client, alertType, zone);
                
                // Build modal content
                const content = `
                    <div class="alert-details-modal">
                        <div class="alert-header">
                            <div class="alert-client-info">
                                <span class="client-badge-large">${client.initials}</span>
                                <div class="client-details">
                                    <div class="client-name">${client.initials}</div>
                                    <div class="client-meta">
                                        <span>üè† ${client.houseId || 'No House'}</span>
                                        <span>üìÖ Day ${window.daysBetween(client.admissionDate) || 0}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="alert-zone-badge zone-${zone}">
                                ${zone.charAt(0).toUpperCase() + zone.slice(1)} Zone
                            </div>
                        </div>
                        
                        <div class="alert-content">
                            <div class="alert-message-section">
                                <h4>Alert Details</h4>
                                <p class="alert-message">${alert.message}</p>
                                ${alert.dueDate ? `<p class="alert-due"><strong>Due:</strong> ${alert.dueDate}</p>` : ''}
                                ${alert.description ? `<p class="alert-description">${alert.description}</p>` : ''}
                            </div>
                            
                            ${alert.trackerItem ? `
                                <div class="tracker-context">
                                    <h4>Tracker Context</h4>
                                    <div class="tracker-info">
                                        <span class="tracker-label">${alert.trackerItem.label}</span>
                                        <span class="tracker-status">${alert.trackerItem.complete ? '‚úÖ Complete' : '‚è≥ Pending'}</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="client-context">
                                <h4>Client Context</h4>
                                <div class="context-grid">
                                    <div class="context-item">
                                        <span class="context-label">Admission Date:</span>
                                        <span class="context-value">${window.formatDate(client.admissionDate)}</span>
                                    </div>
                                    ${client.dischargeDate ? `
                                        <div class="context-item">
                                            <span class="context-label">Discharge Date:</span>
                                            <span class="context-value">${window.formatDate(client.dischargeDate)}</span>
                                        </div>
                                    ` : ''}
                                    ${window.trackerEngine ? (() => {
                                        const score = window.trackerEngine.getCompletionScore(client);
                                        return `
                                            <div class="context-item">
                                                <span class="context-label">Tracker Completion:</span>
                                                <span class="context-value">${score.percentage}%</span>
                                            </div>
                                        `;
                                    })() : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert-actions-section">
                            <h4>Quick Actions</h4>
                            <div class="action-buttons-grid">
                                ${alert.isTrackerTask ? `
                                    <button class="btn btn-success" onclick="window.completeAlertFromModal('${clientId}', '${alert.trackerId}')">
                                        ‚úì Mark Complete
                                    </button>
                                ` : ''}
                                <button class="btn btn-primary" onclick="window.viewClientFromAlert('${clientId}')">
                                    üë§ View Client Details
                                </button>
                                ${alert.canGenerateDoc ? `
                                    <button class="btn btn-secondary" onclick="window.generateDocFromAlert('${clientId}', '${alert.docType}')">
                                        üìÑ Generate Document
                                    </button>
                                ` : ''}
                                ${alert.canOpenTracker ? `
                                    <button class="btn btn-secondary" onclick="window.openTrackerFromAlert('${clientId}')">
                                        üìä Open Tracker
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: 'üîî Alert Details',
                    content: content,
                    size: 'large',
                    buttons: [
                        {
                            text: 'Close',
                            primary: true,
                            action: () => window.closeModal()
                        }
                    ]
                });
                
            } catch (error) {
                console.error('Error showing alert details:', error);
                window.showNotification('Failed to load alert details', 'error');
            }
        }
        
        // Get alert details
        function getAlertDetails(client, alertType, zone) {
            const daysInCare = window.daysBetween(client.admissionDate) || 0;
            
            // Map alert types to details
            const alertMap = {
                'discharge-soon': {
                    message: `Discharge scheduled in ${daysInCare} days`,
                    dueDate: client.dischargeDate ? window.formatDate(client.dischargeDate) : null,
                    description: 'Ensure all discharge requirements are completed',
                    canGenerateDoc: true,
                    docType: 'discharge-packet',
                    canOpenTracker: true
                },
                'missing-critical': {
                    message: 'Critical tracker items are missing',
                    description: 'Complete critical items to ensure smooth discharge',
                    canOpenTracker: true,
                    isTrackerTask: true
                },
                'aftercare-due': {
                    message: 'Aftercare options document due',
                    dueDate: daysInCare >= 14 ? 'Due now' : `Due in ${14 - daysInCare} days`,
                    description: 'Generate aftercare options document for family review',
                    canGenerateDoc: true,
                    docType: 'aftercare-options'
                }
            };
            
            return alertMap[alertType] || {
                message: 'Action required',
                canOpenTracker: true
            };
        }
        
        // Action handlers
        window.completeAlertFromModal = async function(clientId, trackerId) {
            try {
                await window.dashboardWidgets.completeTrackerItem(clientId, trackerId);
                window.closeModal();
                window.showNotification('Alert item completed', 'success');
                window.dashboardManager.refreshDashboard();
            } catch (error) {
                console.error('Error completing alert:', error);
                window.showNotification('Failed to complete item', 'error');
            }
        };
        
        window.viewClientFromAlert = function(clientId) {
            window.closeModal();
            window.viewClientDetails(clientId);
        };
        
        window.generateDocFromAlert = function(clientId, docType) {
            window.closeModal();
            window.generateDocument(clientId, docType);
        };
        
        window.openTrackerFromAlert = function(clientId) {
            window.closeModal();
            // Open tracker bulk update for this client
            if (window.openBulkUpdate) {
                window.openBulkUpdate(clientId);
            } else {
                window.viewClientDetails(clientId);
            }
        };
        
        // Enhance bulk actions in viewAllAlerts
        const originalViewAllAlerts = window.dashboardWidgets.viewAllAlerts;
        window.dashboardWidgets.viewAllAlerts = async function() {
            // Call original to get the modal
            await originalViewAllAlerts.call(this);
            
            // Wait for modal to render
            setTimeout(() => {
                enhanceAlertsModal();
            }, 100);
        };
        
        function enhanceAlertsModal() {
            const modal = document.getElementById('globalModal');
            if (!modal) return;
            
            // Add bulk action controls
            const alertsContent = modal.querySelector('.alerts-content');
            if (!alertsContent) return;
            
            // Add checkbox to each alert item
            const alertItems = alertsContent.querySelectorAll('.alert-item');
            alertItems.forEach((item, index) => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'alert-select-checkbox';
                checkbox.dataset.index = index;
                item.insertBefore(checkbox, item.firstChild);
            });
            
            // Add bulk action bar
            const bulkBar = document.createElement('div');
            bulkBar.className = 'bulk-actions-bar';
            bulkBar.innerHTML = `
                <div class="bulk-info">
                    <span id="selectedCount">0</span> selected
                </div>
                <div class="bulk-buttons">
                    <button class="btn btn-sm" onclick="window.selectAllAlerts()">Select All</button>
                    <button class="btn btn-sm" onclick="window.deselectAllAlerts()">Deselect None</button>
                    <button class="btn btn-sm btn-success" onclick="window.bulkCompleteAlerts()" id="bulkCompleteBtn" disabled>
                        ‚úì Complete Selected
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="window.bulkViewClients()" id="bulkViewBtn" disabled>
                        üë§ View Selected Clients
                    </button>
                </div>
            `;
            
            alertsContent.insertBefore(bulkBar, alertsContent.firstChild);
            
            // Add selection handlers
            alertItems.forEach(item => {
                const checkbox = item.querySelector('.alert-select-checkbox');
                if (checkbox) {
                    checkbox.addEventListener('change', updateBulkActions);
                }
            });
        }
        
        // Bulk action functions
        window.selectAllAlerts = function() {
            document.querySelectorAll('.alert-select-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateBulkActions();
        };
        
        window.deselectAllAlerts = function() {
            document.querySelectorAll('.alert-select-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateBulkActions();
        };
        
        function updateBulkActions() {
            const selected = Array.from(document.querySelectorAll('.alert-select-checkbox:checked'));
            const count = selected.length;
            
            document.getElementById('selectedCount').textContent = count;
            
            const bulkCompleteBtn = document.getElementById('bulkCompleteBtn');
            const bulkViewBtn = document.getElementById('bulkViewBtn');
            
            if (bulkCompleteBtn) bulkCompleteBtn.disabled = count === 0;
            if (bulkViewBtn) bulkViewBtn.disabled = count === 0;
        }
        
        window.bulkCompleteAlerts = async function() {
            const selected = Array.from(document.querySelectorAll('.alert-select-checkbox:checked'));
            if (selected.length === 0) return;
            
            const confirmed = confirm(`Complete ${selected.length} selected alert(s)?`);
            if (!confirmed) return;
            
            let completed = 0;
            let failed = 0;
            
            for (const checkbox of selected) {
                const alertItem = checkbox.closest('.alert-item');
                const clientId = alertItem.dataset.clientId;
                const trackerId = alertItem.dataset.trackerId;
                
                if (clientId && trackerId) {
                    try {
                        await window.dashboardWidgets.completeTrackerItem(clientId, trackerId);
                        completed++;
                    } catch (error) {
                        failed++;
                    }
                }
            }
            
            window.showNotification(
                `Completed ${completed} alert(s)${failed > 0 ? `, ${failed} failed` : ''}`,
                completed > 0 ? 'success' : 'error'
            );
            
            window.dashboardManager.refreshDashboard();
            window.dashboardWidgets.viewAllAlerts();
        };
        
        window.bulkViewClients = function() {
            const selected = Array.from(document.querySelectorAll('.alert-select-checkbox:checked'));
            const clientIds = selected.map(cb => {
                const alertItem = cb.closest('.alert-item');
                return alertItem.dataset.clientId;
            }).filter(id => id);
            
            if (clientIds.length === 0) return;
            
            // Show client list modal
            window.showModal({
                title: `Selected Clients (${clientIds.length})`,
                content: `
                    <div class="bulk-clients-list">
                        ${clientIds.map(id => `
                            <div class="bulk-client-item">
                                <button class="btn btn-sm" onclick="window.viewClientFromAlert('${id}')">
                                    View Client ${id}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `,
                size: 'medium',
                buttons: [
                    {
                        text: 'Close',
                        action: () => window.closeModal()
                    }
                ]
            });
        };
        
        // Add styles
        if (!document.querySelector('#alert-actionability-styles')) {
            const styles = document.createElement('style');
            styles.id = 'alert-actionability-styles';
            styles.textContent = `
                /* Clickable alerts */
                .alert-clickable {
                    transition: all 0.2s;
                }
                
                .alert-clickable:hover {
                    background: #f9fafb !important;
                    transform: translateX(4px);
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                
                /* Alert details modal */
                .alert-details-modal {
                    padding: 0;
                }
                
                .alert-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    background: #f9fafb;
                    border-bottom: 2px solid #e5e7eb;
                }
                
                .alert-client-info {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                }
                
                .client-badge-large {
                    width: 56px;
                    height: 56px;
                    border-radius: 50%;
                    background: var(--ccp-primary-500);
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 24px;
                    font-weight: 600;
                }
                
                .client-details {
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                }
                
                .client-name {
                    font-size: 18px;
                    font-weight: 600;
                    color: #1f2937;
                }
                
                .client-meta {
                    display: flex;
                    gap: 16px;
                    font-size: 14px;
                    color: #6b7280;
                }
                
                .alert-zone-badge {
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-weight: 600;
                    font-size: 14px;
                }
                
                .alert-zone-badge.zone-red {
                    background: #fee2e2;
                    color: #991b1b;
                }
                
                .alert-zone-badge.zone-purple {
                    background: #f3e8ff;
                    color: #6b21a8;
                }
                
                .alert-zone-badge.zone-yellow {
                    background: #fef9c3;
                    color: #854d0e;
                }
                
                .alert-zone-badge.zone-green {
                    background: #dcfce7;
                    color: #166534;
                }
                
                .alert-content {
                    padding: 24px;
                }
                
                .alert-content h4 {
                    margin: 0 0 12px 0;
                    font-size: 16px;
                    color: #1f2937;
                }
                
                .alert-message-section {
                    margin-bottom: 24px;
                    padding-bottom: 24px;
                    border-bottom: 1px solid #e5e7eb;
                }
                
                .alert-message {
                    font-size: 16px;
                    color: #374151;
                    margin: 0 0 8px 0;
                }
                
                .alert-due {
                    color: #dc2626;
                    font-weight: 500;
                    margin: 8px 0;
                }
                
                .alert-description {
                    color: #6b7280;
                    font-size: 14px;
                    margin: 8px 0 0 0;
                }
                
                .tracker-context,
                .client-context {
                    margin-bottom: 24px;
                }
                
                .tracker-info {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px;
                    background: #f9fafb;
                    border-radius: 6px;
                }
                
                .tracker-label {
                    font-weight: 500;
                }
                
                .tracker-status {
                    font-size: 14px;
                }
                
                .context-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 12px;
                }
                
                .context-item {
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                }
                
                .context-label {
                    font-size: 12px;
                    color: #6b7280;
                }
                
                .context-value {
                    font-weight: 500;
                    color: #1f2937;
                }
                
                .alert-actions-section {
                    padding: 20px;
                    background: #f9fafb;
                    border-top: 2px solid #e5e7eb;
                }
                
                .action-buttons-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 12px;
                }
                
                /* Bulk actions */
                .bulk-actions-bar {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px 16px;
                    background: #f3f4f6;
                    border-radius: 8px;
                    margin-bottom: 16px;
                }
                
                .bulk-info {
                    font-weight: 500;
                    color: #374151;
                }
                
                .bulk-buttons {
                    display: flex;
                    gap: 8px;
                }
                
                .alert-select-checkbox {
                    margin-right: 12px;
                    cursor: pointer;
                }
                
                .bulk-clients-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    max-height: 400px;
                    overflow-y: auto;
                }
                
                .bulk-client-item {
                    padding: 12px;
                    background: #f9fafb;
                    border-radius: 6px;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Alert actionability enhanced');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: tracker-completion-enhancement.js
/**
 * Tracker Completion Enhancement
 * Adds confirmation dialogs, optional notes, undo/redo, and bulk update capabilities
 */

(function() {
    'use strict';
    
    // History stack for undo/redo
    window.trackerHistory = {
        stack: [],
        currentIndex: -1,
        maxSize: 50,
        
        push(action) {
            // Remove any actions after current index (when undoing then doing new action)
            this.stack = this.stack.slice(0, this.currentIndex + 1);
            
            // Add new action
            this.stack.push({
                ...action,
                timestamp: new Date().toISOString()
            });
            
            // Limit stack size
            if (this.stack.length > this.maxSize) {
                this.stack.shift();
            } else {
                this.currentIndex++;
            }
            
            // Save to localStorage
            this.save();
        },
        
        undo() {
            if (this.currentIndex < 0) return null;
            
            const action = this.stack[this.currentIndex];
            this.currentIndex--;
            this.save();
            
            return action;
        },
        
        redo() {
            if (this.currentIndex >= this.stack.length - 1) return null;
            
            this.currentIndex++;
            const action = this.stack[this.currentIndex];
            this.save();
            
            return action;
        },
        
        canUndo() {
            return this.currentIndex >= 0;
        },
        
        canRedo() {
            return this.currentIndex < this.stack.length - 1;
        },
        
        save() {
            try {
                localStorage.setItem('tracker_history', JSON.stringify({
                    stack: this.stack,
                    currentIndex: this.currentIndex
                }));
            } catch (e) {
                console.warn('Failed to save tracker history:', e);
            }
        },
        
        load() {
            try {
                const saved = localStorage.getItem('tracker_history');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.stack = data.stack || [];
                    this.currentIndex = data.currentIndex || -1;
                }
            } catch (e) {
                console.warn('Failed to load tracker history:', e);
            }
        }
    };
    
    // Load history on init
    window.trackerHistory.load();
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardWidgets || !window.clientManager || !window.showModal) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceTrackerCompletion();
    }
    
    function enhanceTrackerCompletion() {
        // Override completeTrackerItem with enhanced version
        const originalCompleteTrackerItem = window.dashboardWidgets.completeTrackerItem;
        
        window.dashboardWidgets.completeTrackerItem = async function(clientId, trackerId, skipConfirm = false) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                // Get tracker item info
                const trackerItem = getTrackerItemInfo(client, trackerId);
                if (!trackerItem) {
                    window.showNotification('Tracker item not found', 'error');
                    return;
                }
                
                // Show confirmation dialog unless skipped
                if (!skipConfirm) {
                    const confirmed = await showCompletionDialog(client, trackerItem);
                    if (!confirmed) return;
                }
                
                // Store state for undo
                const beforeState = {
                    clientId,
                    trackerId,
                    value: client[trackerItem.field],
                    dateValue: client[trackerItem.dateField]
                };
                
                // Perform completion
                const updates = {};
                updates[trackerItem.field] = true;
                if (trackerItem.dateField) {
                    updates[trackerItem.dateField] = new Date().toISOString();
                }
                
                await window.clientManager.updateClient(clientId, updates);
                
                // Store in history
                window.trackerHistory.push({
                    type: 'complete',
                    beforeState,
                    afterState: {
                        clientId,
                        trackerId,
                        value: true,
                        dateValue: updates[trackerItem.dateField]
                    },
                    note: window.lastCompletionNote || null
                });
                
                // Clear note
                window.lastCompletionNote = null;
                
                // Show success
                window.showNotification(`${trackerItem.label} marked as complete`, 'success');
                
                // Refresh dashboard
                if (window.dashboardManager) {
                    window.dashboardManager.refreshDashboard();
                }
                
            } catch (error) {
                console.error('Error completing tracker item:', error);
                window.showNotification('Failed to complete tracker item', 'error');
            }
        };
        
        // Show completion confirmation dialog
        async function showCompletionDialog(client, trackerItem) {
            return new Promise((resolve) => {
                const content = `
                    <div class="completion-dialog">
                        <div class="completion-header">
                            <h4>Complete Tracker Item</h4>
                        </div>
                        
                        <div class="completion-info">
                            <div class="info-row">
                                <span class="label">Client:</span>
                                <span class="value">${client.initials} - ${client.houseId || 'No House'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Item:</span>
                                <span class="value">${trackerItem.label}</span>
                            </div>
                            ${trackerItem.critical ? '<div class="critical-badge">‚ö†Ô∏è Critical Item</div>' : ''}
                        </div>
                        
                        <div class="completion-note-section">
                            <label for="completionNote">Add Note (Optional)</label>
                            <textarea 
                                id="completionNote" 
                                class="completion-note-input" 
                                placeholder="Add any notes about this completion..."
                                rows="3"
                            ></textarea>
                        </div>
                        
                        <div class="completion-actions">
                            <button class="btn btn-secondary" onclick="window.completionDialogCancel()">Cancel</button>
                            <button class="btn btn-primary" onclick="window.completionDialogConfirm()">Confirm</button>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: '‚úì Complete Tracker Item',
                    content: content,
                    size: 'small',
                    closeOnOverlay: false,
                    buttons: []
                });
                
                // Set up handlers
                window.completionDialogConfirm = () => {
                    const note = document.getElementById('completionNote').value.trim();
                    if (note) {
                        window.lastCompletionNote = note;
                    }
                    window.closeModal();
                    resolve(true);
                };
                
                window.completionDialogCancel = () => {
                    window.closeModal();
                    resolve(false);
                };
            });
        }
        
        // Get tracker item info
        function getTrackerItemInfo(client, trackerId) {
            if (!window.trackerEngine) return null;
            
            const requirements = window.trackerEngine.requirements || [];
            const item = requirements.find(r => r.id === trackerId);
            
            if (!item) return null;
            
            // Map to client field
            const fieldMap = {
                'needs_assessment': { field: 'needsAssessment', dateField: 'needsAssessmentDate' },
                'health_physical': { field: 'healthPhysical', dateField: 'healthPhysicalDate' },
                'aftercare_thread': { field: 'aftercareThread', dateField: 'aftercareThreadDate' },
                'options_doc': { field: 'optionsDocUploaded', dateField: 'optionsDocUploadedDate' },
                'discharge_packet': { field: 'dischargePacketUploaded', dateField: 'dischargePacketUploadedDate' }
            };
            
            const mapping = fieldMap[trackerId] || { field: trackerId, dateField: null };
            
            return {
                id: trackerId,
                label: item.label,
                critical: item.critical || false,
                field: mapping.field,
                dateField: mapping.dateField
            };
        }
        
        // Undo last completion
        window.undoTrackerCompletion = async function() {
            if (!window.trackerHistory.canUndo()) {
                window.showNotification('Nothing to undo', 'info');
                return;
            }
            
            const action = window.trackerHistory.undo();
            if (!action || action.type !== 'complete') {
                window.showNotification('Cannot undo this action', 'warning');
                return;
            }
            
            try {
                const updates = {};
                const trackerItem = getTrackerItemInfo(
                    await window.clientManager.getClient(action.beforeState.clientId),
                    action.beforeState.trackerId
                );
                
                if (trackerItem) {
                    updates[trackerItem.field] = action.beforeState.value;
                    if (trackerItem.dateField) {
                        updates[trackerItem.dateField] = action.beforeState.dateValue;
                    }
                    
                    await window.clientManager.updateClient(action.beforeState.clientId, updates);
                    window.showNotification('Action undone', 'success');
                    
                    if (window.dashboardManager) {
                        window.dashboardManager.refreshDashboard();
                    }
                }
            } catch (error) {
                console.error('Error undoing:', error);
                window.showNotification('Failed to undo', 'error');
            }
        };
        
        // Redo last undone action
        window.redoTrackerCompletion = async function() {
            if (!window.trackerHistory.canRedo()) {
                window.showNotification('Nothing to redo', 'info');
                return;
            }
            
            const action = window.trackerHistory.redo();
            if (!action || action.type !== 'complete') {
                window.showNotification('Cannot redo this action', 'warning');
                return;
            }
            
            try {
                await window.dashboardWidgets.completeTrackerItem(
                    action.afterState.clientId,
                    action.afterState.trackerId,
                    true // Skip confirm
                );
                window.showNotification('Action redone', 'success');
            } catch (error) {
                console.error('Error redoing:', error);
                window.showNotification('Failed to redo', 'error');
            }
        };
        
        // Add bulk update button to Flight Plan widget
        const flightPlanWidget = window.dashboardWidgets?.widgets?.get('flightPlan');
        if (flightPlanWidget) {
            const originalRender = flightPlanWidget.render;
            
            flightPlanWidget.render = function() {
                let html = originalRender.call(this);
                
                // Add bulk update button to header
                const headerMatch = html.match(/(<div[^>]*class="[^"]*widget-header[^"]*"[^>]*>)/);
                if (headerMatch) {
                    const bulkButton = `
                        <button class="btn btn-sm btn-secondary bulk-update-btn" onclick="window.showBulkTrackerUpdate()">
                            üìã Bulk Update
                        </button>
                    `;
                    html = html.replace(headerMatch[0], headerMatch[0] + bulkButton);
                }
                
                // Add undo/redo buttons
                const undoRedoButtons = `
                    <div class="undo-redo-controls">
                        <button class="btn-icon" onclick="window.undoTrackerCompletion()" 
                                title="Undo (Ctrl+Z)" ${!window.trackerHistory.canUndo() ? 'disabled' : ''}>
                            ‚Ü∂ Undo
                        </button>
                        <button class="btn-icon" onclick="window.redoTrackerCompletion()" 
                                title="Redo (Ctrl+Y)" ${!window.trackerHistory.canRedo() ? 'disabled' : ''}>
                            ‚Ü∑ Redo
                        </button>
                    </div>
                `;
                
                html = html.replace('</div></div>', undoRedoButtons + '</div></div>');
                
                return html;
            };
        }
        
        // Bulk tracker update modal
        window.showBulkTrackerUpdate = async function() {
            try {
                const clients = await window.clientManager.getAllClients();
                const activeClients = clients.filter(c => c.status === 'active');
                
                if (activeClients.length === 0) {
                    window.showNotification('No active clients found', 'warning');
                    return;
                }
                
                // Get tracker requirements
                const requirements = window.trackerEngine?.requirements || [];
                
                const content = `
                    <div class="bulk-tracker-update">
                        <div class="bulk-header">
                            <p>Select clients and tracker items to complete in bulk.</p>
                        </div>
                        
                        <div class="bulk-selection">
                            <div class="bulk-clients-section">
                                <h5>Clients</h5>
                                <div class="bulk-clients-list">
                                    ${activeClients.map(client => `
                                        <label class="bulk-client-checkbox">
                                            <input type="checkbox" class="bulk-client-select" value="${client.id}">
                                            <span>${client.initials} - ${client.houseId || 'No House'}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="bulk-items-section">
                                <h5>Tracker Items</h5>
                                <div class="bulk-items-list">
                                    ${requirements.map(req => `
                                        <label class="bulk-item-checkbox">
                                            <input type="checkbox" class="bulk-item-select" value="${req.id}">
                                            <span>${req.label} ${req.critical ? '‚ö†Ô∏è' : ''}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bulk-summary">
                            <span id="bulkSummary">0 clients, 0 items selected</span>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: 'üìã Bulk Tracker Update',
                    content: content,
                    size: 'large',
                    buttons: [
                        {
                            text: 'Cancel',
                            action: () => window.closeModal()
                        },
                        {
                            text: 'Complete Selected',
                            primary: true,
                            action: () => executeBulkUpdate()
                        }
                    ]
                });
                
                // Update summary on selection change
                document.querySelectorAll('.bulk-client-select, .bulk-item-select').forEach(cb => {
                    cb.addEventListener('change', updateBulkSummary);
                });
                
                updateBulkSummary();
                
            } catch (error) {
                console.error('Error showing bulk update:', error);
                window.showNotification('Failed to load bulk update', 'error');
            }
        };
        
        function updateBulkSummary() {
            const selectedClients = document.querySelectorAll('.bulk-client-select:checked').length;
            const selectedItems = document.querySelectorAll('.bulk-item-select:checked').length;
            
            const summary = document.getElementById('bulkSummary');
            if (summary) {
                summary.textContent = `${selectedClients} clients, ${selectedItems} items selected`;
            }
        }
        
        async function executeBulkUpdate() {
            const selectedClients = Array.from(document.querySelectorAll('.bulk-client-select:checked')).map(cb => cb.value);
            const selectedItems = Array.from(document.querySelectorAll('.bulk-item-select:checked')).map(cb => cb.value);
            
            if (selectedClients.length === 0 || selectedItems.length === 0) {
                window.showNotification('Please select at least one client and one item', 'warning');
                return;
            }
            
            const confirmed = confirm(`Complete ${selectedItems.length} item(s) for ${selectedClients.length} client(s)?`);
            if (!confirmed) return;
            
            let completed = 0;
            let failed = 0;
            
            window.showNotification('Processing bulk update...', 'info');
            
            for (const clientId of selectedClients) {
                for (const itemId of selectedItems) {
                    try {
                        await window.dashboardWidgets.completeTrackerItem(clientId, itemId, true);
                        completed++;
                    } catch (error) {
                        failed++;
                    }
                }
            }
            
            window.closeModal();
            window.showNotification(
                `Bulk update complete: ${completed} items completed${failed > 0 ? `, ${failed} failed` : ''}`,
                completed > 0 ? 'success' : 'error'
            );
            
            if (window.dashboardManager) {
                window.dashboardManager.refreshDashboard();
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                window.undoTrackerCompletion();
            }
            
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                window.redoTrackerCompletion();
            }
        });
        
        // Add styles
        if (!document.querySelector('#tracker-completion-enhancement-styles')) {
            const styles = document.createElement('style');
            styles.id = 'tracker-completion-enhancement-styles';
            styles.textContent = `
                /* Completion Dialog */
                .completion-dialog {
                    padding: 0;
                }
                
                .completion-header h4 {
                    margin: 0 0 16px 0;
                    color: #1f2937;
                }
                
                .completion-info {
                    margin-bottom: 20px;
                }
                
                .info-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 8px;
                }
                
                .info-row .label {
                    font-weight: 500;
                    color: #6b7280;
                }
                
                .info-row .value {
                    color: #1f2937;
                }
                
                .critical-badge {
                    display: inline-block;
                    margin-top: 8px;
                    padding: 4px 8px;
                    background: #fef2f2;
                    color: #991b1b;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 500;
                }
                
                .completion-note-section {
                    margin-bottom: 20px;
                }
                
                .completion-note-section label {
                    display: block;
                    margin-bottom: 8px;
                    font-weight: 500;
                    color: #374151;
                }
                
                .completion-note-input {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-family: inherit;
                    font-size: 14px;
                    resize: vertical;
                }
                
                .completion-actions {
                    display: flex;
                    justify-content: flex-end;
                    gap: 12px;
                }
                
                /* Bulk Update */
                .bulk-update-btn {
                    margin-left: auto;
                }
                
                .undo-redo-controls {
                    display: flex;
                    gap: 8px;
                    padding: 12px;
                    background: #f9fafb;
                    border-top: 1px solid #e5e7eb;
                }
                
                .btn-icon {
                    background: white;
                    border: 1px solid #d1d5db;
                    padding: 6px 12px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s;
                }
                
                .btn-icon:hover:not(:disabled) {
                    background: #f3f4f6;
                    border-color: #9ca3af;
                }
                
                .btn-icon:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                
                .bulk-tracker-update {
                    padding: 0;
                }
                
                .bulk-header {
                    margin-bottom: 20px;
                    color: #6b7280;
                }
                
                .bulk-selection {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 24px;
                    margin-bottom: 20px;
                }
                
                .bulk-clients-section h5,
                .bulk-items-section h5 {
                    margin: 0 0 12px 0;
                    color: #1f2937;
                }
                
                .bulk-clients-list,
                .bulk-items-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    max-height: 300px;
                    overflow-y: auto;
                    padding: 8px;
                    background: #f9fafb;
                    border-radius: 6px;
                }
                
                .bulk-client-checkbox,
                .bulk-item-checkbox {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px;
                    background: white;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .bulk-client-checkbox:hover,
                .bulk-item-checkbox:hover {
                    background: #f3f4f6;
                }
                
                .bulk-summary {
                    padding: 12px;
                    background: #eff6ff;
                    border-radius: 6px;
                    text-align: center;
                    font-weight: 500;
                    color: #1e40af;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Tracker completion enhancement initialized');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: client-data-validation.js
/**
 * Client Data Validation Enhancement
 * Adds validation for client creation/updates, duplicate checking, date validation, and error display
 */

(function() {
    'use strict';
    
    // Validation rules
    const validationRules = {
        initials: {
            required: true,
            minLength: 2,
            maxLength: 10,
            pattern: /^[A-Z]{2,10}$/,
            message: 'Initials must be 2-10 uppercase letters'
        },
        houseId: {
            required: false,
            pattern: /^[A-Z0-9_\s-]+$/i,
            message: 'House ID can only contain letters, numbers, spaces, underscores, and hyphens'
        },
        admissionDate: {
            required: true,
            validate: (date) => {
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'Invalid date';
                if (d > new Date()) return 'Admission date cannot be in the future';
                return null;
            }
        },
        dischargeDate: {
            required: false,
            validate: (date, client) => {
                if (!date) return null;
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'Invalid date';
                if (client.admissionDate) {
                    const admission = new Date(client.admissionDate);
                    if (d < admission) return 'Discharge date must be after admission date';
                }
                return null;
            }
        },
        status: {
            required: true,
            allowedValues: ['active', 'discharged', 'archived'],
            message: 'Status must be active, discharged, or archived'
        }
    };
    
    // Validation engine
    window.clientValidator = {
        /**
         * Validate client data
         * @param {Object} clientData - Client data to validate
         * @param {Object} existingClient - Existing client data (for updates)
         * @returns {Object} Validation result { valid: boolean, errors: Object }
         */
        validate(clientData, existingClient = null) {
            const errors = {};
            let isValid = true;
            
            // Validate each field
            for (const [field, rules] of Object.entries(validationRules)) {
                const value = clientData[field];
                
                // Required check
                if (rules.required && (!value || value === '')) {
                    errors[field] = `${field} is required`;
                    isValid = false;
                    continue;
                }
                
                // Skip if empty and not required
                if (!value || value === '') continue;
                
                // Min length check
                if (rules.minLength && value.length < rules.minLength) {
                    errors[field] = `${field} must be at least ${rules.minLength} characters`;
                    isValid = false;
                    continue;
                }
                
                // Max length check
                if (rules.maxLength && value.length > rules.maxLength) {
                    errors[field] = `${field} must be no more than ${rules.maxLength} characters`;
                    isValid = false;
                    continue;
                }
                
                // Pattern check
                if (rules.pattern && !rules.pattern.test(value)) {
                    errors[field] = rules.message || `${field} format is invalid`;
                    isValid = false;
                    continue;
                }
                
                // Custom validation
                if (rules.validate) {
                    const customError = rules.validate(value, clientData);
                    if (customError) {
                        errors[field] = customError;
                        isValid = false;
                    }
                }
                
                // Allowed values check
                if (rules.allowedValues && !rules.allowedValues.includes(value)) {
                    errors[field] = rules.message || `${field} must be one of: ${rules.allowedValues.join(', ')}`;
                    isValid = false;
                }
            }
            
            return { valid: isValid, errors };
        },
        
        /**
         * Check for duplicate client
         * @param {string} initials - Client initials
         * @param {string} houseId - House ID
         * @param {string} excludeId - Client ID to exclude (for updates)
         * @returns {boolean} True if duplicate exists
         */
        async checkDuplicate(initials, houseId, excludeId = null) {
            if (!window.clientManager) return false;
            
            try {
                const clients = await window.clientManager.getAllClients();
                return clients.some(client => 
                    client.id !== excludeId &&
                    client.initials === initials &&
                    client.houseId === houseId
                );
            } catch (error) {
                console.error('Error checking duplicate:', error);
                return false;
            }
        },
        
        /**
         * Validate date range
         * @param {string} startDate - Start date
         * @param {string} endDate - End date
         * @returns {string|null} Error message or null
         */
        validateDateRange(startDate, endDate) {
            if (!startDate || !endDate) return null;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (isNaN(start.getTime())) return 'Invalid start date';
            if (isNaN(end.getTime())) return 'Invalid end date';
            if (end < start) return 'End date must be after start date';
            
            return null;
        },
        
        /**
         * Format validation errors for display
         * @param {Object} errors - Validation errors
         * @returns {string} Formatted error message
         */
        formatErrors(errors) {
            if (!errors || Object.keys(errors).length === 0) return '';
            
            return Object.entries(errors)
                .map(([field, message]) => `${field}: ${message}`)
                .join('\n');
        }
    };
    
    // Enhance clientManager with validation
    function enhanceClientManager() {
        if (!window.clientManager) return;
        
        // Wrap createClient
        const originalCreateClient = window.clientManager.createClient;
        window.clientManager.createClient = async function(clientData) {
            const normalizedClient = { ...clientData };
            if (!normalizedClient.status) {
                normalizedClient.status = normalizedClient.dischargeDate ? 'discharged' : 'active';
            }
            
            // Validate
            const validation = window.clientValidator.validate(normalizedClient);
            
            if (!validation.valid) {
                const errorMsg = window.clientValidator.formatErrors(validation.errors);
                throw new Error(`Validation failed:\n${errorMsg}`);
            }
            
            // Check duplicate
            if (!normalizedClient.isDemo && normalizedClient.initials && normalizedClient.houseId) {
                const isDuplicate = await window.clientValidator.checkDuplicate(
                    normalizedClient.initials,
                    normalizedClient.houseId
                );
                
                if (isDuplicate) {
                    throw new Error(`Client with initials "${normalizedClient.initials}" already exists in ${normalizedClient.houseId}`);
                }
            }
            
            // Call original
            return originalCreateClient.call(this, normalizedClient);
        };
        
        // Wrap updateClient
        const originalUpdateClient = window.clientManager.updateClient;
        window.clientManager.updateClient = async function(clientId, updates) {
            // Get existing client
            const existingClient = await this.getClient(clientId);
            if (!existingClient) {
                throw new Error('Client not found');
            }
            
            // Merge updates with existing data for validation
            const mergedData = { ...existingClient, ...updates };
            if (!mergedData.status) {
                mergedData.status = mergedData.dischargeDate ? 'discharged' : 'active';
            }
            
            // Validate
            const validation = window.clientValidator.validate(mergedData, existingClient);
            
            if (!validation.valid) {
                const errorMsg = window.clientValidator.formatErrors(validation.errors);
                throw new Error(`Validation failed:\n${errorMsg}`);
            }
            
            // Check duplicate if initials or houseId changed
            if (!mergedData.isDemo && (updates.initials || updates.houseId)) {
                const newInitials = updates.initials || existingClient.initials;
                const newHouseId = updates.houseId || existingClient.houseId;
                
                const isDuplicate = await window.clientValidator.checkDuplicate(
                    newInitials,
                    newHouseId,
                    clientId
                );
                
                if (isDuplicate) {
                    throw new Error(`Client with initials "${newInitials}" already exists in ${newHouseId}`);
                }
            }
            
            // Call original
            return originalUpdateClient.call(this, clientId, updates);
        };
    }
    
    // Add validation UI helpers
    window.showValidationErrors = function(errors, container) {
        if (!container) return;
        
        // Remove existing errors
        container.querySelectorAll('.validation-error').forEach(el => el.remove());
        
        // Add error messages
        for (const [field, message] of Object.entries(errors)) {
            const errorEl = document.createElement('div');
            errorEl.className = 'validation-error';
            errorEl.textContent = `${field}: ${message}`;
            container.appendChild(errorEl);
        }
    };
    
    window.clearValidationErrors = function(container) {
        if (!container) return;
        container.querySelectorAll('.validation-error').forEach(el => el.remove());
    };
    
    // Enhance showAddClientModal with validation
    function enhanceAddClientModal() {
        const originalShowAddClientModal = window.showAddClientModal;
        if (!originalShowAddClientModal) return;
        
        window.showAddClientModal = async function() {
            // Call original
            await originalShowAddClientModal.call(this);
            
            // Wait for modal to render
            setTimeout(() => {
                addValidationToModal();
            }, 100);
        };
        
        function addValidationToModal() {
            const modal = document.getElementById('globalModal');
            if (!modal) return;
            
            const form = modal.querySelector('form') || modal.querySelector('.client-form');
            if (!form) return;
            
            // Add real-time validation
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('blur', () => {
                    validateField(input);
                });
                
                input.addEventListener('input', () => {
                    clearFieldError(input);
                });
            });
            
            // Enhance submit handler
            const submitBtn = form.querySelector('button[type="submit"]') || 
                            form.querySelector('.btn-primary');
            
            if (submitBtn) {
                const originalClick = submitBtn.onclick;
                submitBtn.onclick = async function(e) {
                    e.preventDefault();
                    
                    // Validate all fields
                    const formData = new FormData(form);
                    const clientData = Object.fromEntries(formData.entries());
                    
                    // Convert dates
                    if (clientData.admissionDate) {
                        clientData.admissionDate = new Date(clientData.admissionDate).toISOString();
                    }
                    if (clientData.dischargeDate) {
                        clientData.dischargeDate = new Date(clientData.dischargeDate).toISOString();
                    }
                    
                    const validation = window.clientValidator.validate(clientData);
                    
                    if (!validation.valid) {
                        showValidationErrors(validation.errors, form);
                        window.showNotification('Please fix validation errors', 'error');
                        return;
                    }
                    
                    // Check duplicate
                    try {
                        const isDuplicate = await window.clientValidator.checkDuplicate(
                            clientData.initials,
                            clientData.houseId
                        );
                        
                        if (isDuplicate) {
                            window.showNotification(
                                `Client with initials "${clientData.initials}" already exists in ${clientData.houseId}`,
                                'error'
                            );
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking duplicate:', error);
                    }
                    
                    // Call original handler
                    if (originalClick) {
                        originalClick.call(this, e);
                    }
                };
            }
        }
        
        function validateField(input) {
            const field = input.name || input.id;
            const value = input.value;
            
            const rules = validationRules[field];
            if (!rules) return;
            
            const clientData = { [field]: value };
            const validation = window.clientValidator.validate(clientData);
            
            if (validation.errors[field]) {
                showFieldError(input, validation.errors[field]);
            } else {
                clearFieldError(input);
            }
        }
        
        function showFieldError(input, message) {
            clearFieldError(input);
            
            input.classList.add('validation-error-field');
            
            const errorEl = document.createElement('div');
            errorEl.className = 'validation-error-message';
            errorEl.textContent = message;
            
            input.parentNode.insertBefore(errorEl, input.nextSibling);
        }
        
        function clearFieldError(input) {
            input.classList.remove('validation-error-field');
            const errorMsg = input.parentNode.querySelector('.validation-error-message');
            if (errorMsg) {
                errorMsg.remove();
            }
        }
    }
    
    // Add styles
    if (!document.querySelector('#client-data-validation-styles')) {
        const styles = document.createElement('style');
        styles.id = 'client-data-validation-styles';
        styles.textContent = `
            /* Validation Errors */
            .validation-error {
                padding: 8px 12px;
                margin: 8px 0;
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-left: 4px solid #ef4444;
                border-radius: 4px;
                color: #991b1b;
                font-size: 14px;
            }
            
            .validation-error-field {
                border-color: #ef4444 !important;
                box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
            }
            
            .validation-error-message {
                margin-top: 4px;
                font-size: 12px;
                color: #ef4444;
            }
            
            /* Success state */
            .validation-success-field {
                border-color: #22c55e !important;
                box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Initialize
    function initialize() {
        enhanceClientManager();
        enhanceAddClientModal();
        
        console.log('‚úÖ Client data validation initialized');
    }
    
    // Wait for dependencies
    if (window.clientManager) {
        initialize();
    } else {
        const checkInterval = setInterval(() => {
            if (window.clientManager) {
                clearInterval(checkInterval);
                initialize();
            }
        }, 100);
        
        setTimeout(() => clearInterval(checkInterval), 10000);
    }
})();





// Enhancement: discharge-packet-integration.js
/**
 * Discharge Packet Integration Enhancement
 * Adds discharge packet button to client details, auto-populates with client data, updates tracker on completion
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.documentGenerator || !window.showClientDetailsModal || !window.clientManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        integrateDischargePacket();
    }
    
    function integrateDischargePacket() {
        // Override showClientDetailsModal to add discharge packet button
        const originalShowClientDetailsModal = window.showClientDetailsModal;
        
        window.showClientDetailsModal = async function(client) {
            // Call original function
            await originalShowClientDetailsModal.call(this, client);
            
            // Wait for modal to render
            setTimeout(() => {
                addDischargePacketButton(client);
            }, 200);
        };
        
        /**
         * Add discharge packet button to client details modal
         */
        function addDischargePacketButton(client) {
            const modal = document.getElementById('globalModal') || document.querySelector('.modal');
            if (!modal) return;
            
            // Check if button already exists
            if (modal.querySelector('.discharge-packet-btn')) return;
            
            // Find a good place to add the button - look for action buttons or document section
            const actionsSection = modal.querySelector('.client-actions') || 
                                 modal.querySelector('.modal-actions') ||
                                 modal.querySelector('.client-documents-section');
            
            let buttonContainer;
            
            if (actionsSection) {
                // Add button to existing actions section
                buttonContainer = actionsSection;
            } else {
                // Create new actions section
                const modalBody = modal.querySelector('.modal-body') || modal.querySelector('.modal-content');
                if (modalBody) {
                    buttonContainer = document.createElement('div');
                    buttonContainer.className = 'discharge-packet-section';
                    modalBody.appendChild(buttonContainer);
                } else {
                    return; // Can't find a place to add it
                }
            }
            
            // Check if discharge packet is already completed
            const daysInCare = window.daysBetween(client.admissionDate) || 0;
            const isCompleted = client.dischargePacketUploaded;
            const isRecommended = daysInCare >= 25; // Discharge packet min day
            
            // Create button
            const button = document.createElement('button');
            button.className = `btn discharge-packet-btn ${isCompleted ? 'btn-success' : 'btn-primary'}`;
            button.innerHTML = isCompleted 
                ? '‚úÖ Discharge Packet Generated' 
                : 'üì¶ Generate Discharge Packet';
            button.title = isCompleted 
                ? 'Discharge packet already generated'
                : 'Generate discharge packet for this client';
            
            if (!isCompleted && isRecommended) {
                button.onclick = () => generateDischargePacketForClient(client);
            } else if (!isCompleted) {
                button.disabled = true;
                button.title = `Discharge packet available after day 25 (currently day ${daysInCare})`;
            } else {
                button.onclick = () => {
                    window.showNotification('Discharge packet already generated', 'info');
                };
            }
            
            // Insert button
            if (buttonContainer.classList.contains('discharge-packet-section')) {
                buttonContainer.innerHTML = `
                    <h4>üì¶ Discharge Packet</h4>
                    <p class="discharge-packet-info">
                        ${isCompleted 
                            ? `Generated on ${window.formatDate(client.dischargePacketUploadedDate)}`
                            : isRecommended
                                ? 'Ready to generate discharge packet'
                                : `Available after day 25 (currently day ${daysInCare})`
                        }
                    </p>
                `;
                buttonContainer.appendChild(button);
            } else {
                // Insert at beginning of container
                buttonContainer.insertBefore(button, buttonContainer.firstChild);
            }
        }
        
        /**
         * Generate discharge packet for a specific client (skips client selection)
         */
        async function generateDischargePacketForClient(client) {
            try {
                // Verify client still exists and is active
                const currentClient = await window.clientManager.getClient(client.id);
                if (!currentClient) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                if (currentClient.status !== 'active') {
                    window.showNotification('Can only generate discharge packets for active clients', 'warning');
                    return;
                }
                
                // Check if already completed
                if (currentClient.dischargePacketUploaded) {
                    const confirmed = confirm('Discharge packet already generated. Generate another?');
                    if (!confirmed) return;
                }
                
                // Close client details modal
                window.closeModal();
                
                // Show confirmation dialog
                const daysInCare = window.daysBetween(currentClient.admissionDate) || 0;
                const confirmed = await showDischargePacketConfirmation(currentClient, daysInCare);
                
                if (!confirmed) return;
                
                // Start workflow directly with client and document type pre-selected
                window.documentGenerator.activeWorkflow = {
                    clientId: currentClient.id,
                    client: currentClient,
                    documentType: 'discharge-packet',
                    programs: [] // Will be selected in next step
                };
                
                // Skip to program selection (step 3)
                await window.documentGenerator.selectPrograms();
                
            } catch (error) {
                console.error('Error generating discharge packet:', error);
                window.showNotification('Failed to generate discharge packet', 'error');
            }
        }
        
        /**
         * Show confirmation dialog for discharge packet generation
         */
        async function showDischargePacketConfirmation(client, daysInCare) {
            return new Promise((resolve) => {
                const content = `
                    <div class="discharge-packet-confirmation">
                        <div class="confirmation-header">
                            <h4>üì¶ Generate Discharge Packet</h4>
                        </div>
                        
                        <div class="client-summary">
                            <div class="summary-row">
                                <span class="label">Client:</span>
                                <span class="value">${client.initials}</span>
                            </div>
                            <div class="summary-row">
                                <span class="label">House:</span>
                                <span class="value">${client.houseId || 'No House'}</span>
                            </div>
                            <div class="summary-row">
                                <span class="label">Days in Care:</span>
                                <span class="value">${daysInCare}</span>
                            </div>
                            ${client.dischargeDate ? `
                                <div class="summary-row">
                                    <span class="label">Discharge Date:</span>
                                    <span class="value">${window.formatDate(client.dischargeDate)}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="confirmation-info">
                            <p>This will generate a complete discharge packet for <strong>${client.initials}</strong>.</p>
                            <p>The following will be included:</p>
                            <ul>
                                <li>Discharge summary</li>
                                <li>Treatment completion details</li>
                                <li>Aftercare recommendations</li>
                                <li>Follow-up instructions</li>
                            </ul>
                            <p class="tracker-note">‚úì The client tracker will be automatically updated upon completion.</p>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: 'Generate Discharge Packet',
                    content: content,
                    size: 'medium',
                    buttons: [
                        {
                            text: 'Cancel',
                            action: () => {
                                window.closeModal();
                                resolve(false);
                            }
                        },
                        {
                            text: 'Continue',
                            primary: true,
                            action: () => {
                                window.closeModal();
                                resolve(true);
                            }
                        }
                    ]
                });
            });
        }
        
        // Also add quick access from client cards if they exist
        if (window.dashboardWidgets) {
            const originalRenderClient = window.dashboardWidgets.renderClient;
            if (originalRenderClient) {
                window.dashboardWidgets.renderClient = function(client) {
                    let html = originalRenderClient.call(this, client);
                    
                    // Add discharge packet quick button if eligible
                    const daysInCare = window.daysBetween(client.admissionDate) || 0;
                    const isEligible = daysInCare >= 25 && !client.dischargePacketUploaded;
                    
                    if (isEligible) {
                        const buttonHtml = `
                            <button class="btn-discharge-packet-quick" 
                                    onclick="window.generateDischargePacketQuick('${client.id}')"
                                    title="Generate discharge packet for ${client.initials}">
                                üì¶
                            </button>
                        `;
                        
                        // Insert button in client card actions
                        const insertPos = html.lastIndexOf('</div>');
                        if (insertPos > 0) {
                            html = html.slice(0, insertPos) + buttonHtml + html.slice(insertPos);
                        }
                    }
                    
                    return html;
                };
            }
        }
        
        // Quick access function for client cards
        window.generateDischargePacketQuick = async function(clientId) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                await generateDischargePacketForClient(client);
            } catch (error) {
                console.error('Error generating discharge packet:', error);
                window.showNotification('Failed to generate discharge packet', 'error');
            }
        };
        
        // Add styles
        if (!document.querySelector('#discharge-packet-integration-styles')) {
            const styles = document.createElement('style');
            styles.id = 'discharge-packet-integration-styles';
            styles.textContent = `
                /* Discharge Packet Section */
                .discharge-packet-section {
                    margin-top: 20px;
                    padding: 16px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border: 1px solid #e5e7eb;
                }
                
                .discharge-packet-section h4 {
                    margin: 0 0 8px 0;
                    color: #1f2937;
                    font-size: 16px;
                }
                
                .discharge-packet-info {
                    margin: 0 0 12px 0;
                    color: #6b7280;
                    font-size: 14px;
                }
                
                .discharge-packet-btn {
                    width: 100%;
                    margin-top: 8px;
                    padding: 12px;
                    font-size: 15px;
                    font-weight: 500;
                }
                
                .discharge-packet-btn:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                }
                
                /* Quick button in client cards */
                .btn-discharge-packet-quick {
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 6px 10px;
                    cursor: pointer;
                    font-size: 16px;
                    transition: all 0.2s;
                    margin-left: 4px;
                }
                
                .btn-discharge-packet-quick:hover {
                    background: #5568d3;
                    transform: scale(1.05);
                }
                
                /* Confirmation Dialog */
                .discharge-packet-confirmation {
                    padding: 0;
                }
                
                .confirmation-header {
                    margin-bottom: 20px;
                }
                
                .confirmation-header h4 {
                    margin: 0;
                    color: #1f2937;
                }
                
                .client-summary {
                    background: #f9fafb;
                    padding: 16px;
                    border-radius: 6px;
                    margin-bottom: 20px;
                }
                
                .summary-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 8px;
                }
                
                .summary-row:last-child {
                    margin-bottom: 0;
                }
                
                .summary-row .label {
                    font-weight: 500;
                    color: #6b7280;
                }
                
                .summary-row .value {
                    color: #1f2937;
                    font-weight: 500;
                }
                
                .confirmation-info {
                    margin-bottom: 20px;
                }
                
                .confirmation-info p {
                    margin-bottom: 12px;
                    color: #374151;
                    line-height: 1.6;
                }
                
                .confirmation-info ul {
                    margin: 12px 0 12px 20px;
                    color: #374151;
                }
                
                .confirmation-info li {
                    margin-bottom: 6px;
                }
                
                .tracker-note {
                    margin-top: 16px;
                    padding: 12px;
                    background: #eff6ff;
                    border-left: 4px solid #3b82f6;
                    border-radius: 4px;
                    color: #1e40af;
                    font-weight: 500;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('‚úÖ Discharge packet integration initialized');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();




// Enhancement: widget-rendering-optimization.js
/**
 * Widget Rendering Optimization Enhancement
 * Implements selective widget updates, virtual scrolling for long lists, debounce search inputs
 */

(function() {
    'use strict';
    
    // Debounce utility (if not already available)
    if (!window.debounce) {
        window.debounce = function(func, wait, immediate) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                const later = function() {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        };
    }
    
    // Track which widgets need updates
    const widgetUpdateQueue = new Set();
    let updateScheduled = false;
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardManager || !window.dashboardWidgets) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        optimizeWidgetRendering();
        addVirtualScrolling();
        debounceSearchInputs();
    }
    
    /**
     * Optimize widget rendering with selective updates
     */
    function optimizeWidgetRendering() {
        const originalRefreshDashboard = window.dashboardManager.refreshDashboard;
        
        // Override refreshDashboard to support selective updates
        window.dashboardManager.refreshDashboard = async function(widgetIds = null) {
            try {
                console.log('üîÑ Refreshing dashboard' + (widgetIds ? ` (selective: ${widgetIds.join(', ')})` : ' (full)'));
                
                // If specific widgets requested, only update those
                if (widgetIds && Array.isArray(widgetIds)) {
                    for (const widgetId of widgetIds) {
                        const widget = this.widgets.get(widgetId);
                        if (widget && widget.refresh) {
                            await widget.refresh();
                        }
                    }
                    return true;
                }
                
                // Full refresh - invalidate cache
                this.cache.lastCacheTime = 0;
                await this.loadDashboardData();
                
                // Notify all widgets to update
                for (const [widgetId, widget] of this.widgets) {
                    if (widget.refresh) {
                        await widget.refresh();
                    }
                }
                
                console.log('‚úÖ Dashboard refreshed');
                return true;
            } catch (error) {
                console.error('Failed to refresh dashboard:', error);
                return false;
            }
        };
        
        // Add method to queue widget updates
        window.dashboardManager.queueWidgetUpdate = function(widgetId) {
            widgetUpdateQueue.add(widgetId);
            scheduleWidgetUpdates();
        };
        
        // Schedule batched widget updates
        function scheduleWidgetUpdates() {
            if (updateScheduled) return;
            
            updateScheduled = true;
            requestAnimationFrame(() => {
                if (widgetUpdateQueue.size > 0) {
                    const widgetsToUpdate = Array.from(widgetUpdateQueue);
                    widgetUpdateQueue.clear();
                    window.dashboardManager.refreshDashboard(widgetsToUpdate);
                }
                updateScheduled = false;
            });
        }
        
        // Enhance event system to trigger selective updates
        if (window.publish) {
            const originalPublish = window.publish;
            window.publish = function(event, data) {
                originalPublish.call(this, event, data);
                
                // Map events to widgets that need updating
                const eventWidgetMap = {
                    'client:updated': ['flightPlan', 'journeyRadar', 'missions'],
                    'tracker:updated': ['flightPlan', 'compliance'],
                    'document:generated': ['flightPlan', 'documentHub'],
                    'milestone:completed': ['journeyRadar', 'missions']
                };
                
                const widgetsToUpdate = eventWidgetMap[event] || [];
                if (widgetsToUpdate.length > 0) {
                    widgetsToUpdate.forEach(widgetId => {
                        window.dashboardManager.queueWidgetUpdate(widgetId);
                    });
                }
            };
        }
    }
    
    /**
     * Add virtual scrolling for long lists
     */
    function addVirtualScrolling() {
        // Virtual scrolling implementation for long lists
        window.VirtualScroller = class {
            constructor(container, items, itemHeight = 60, renderItem) {
                this.container = container;
                this.items = items;
                this.itemHeight = itemHeight;
                this.renderItem = renderItem;
                this.scrollTop = 0;
                this.containerHeight = container.clientHeight;
                this.visibleCount = Math.ceil(this.containerHeight / this.itemHeight) + 2; // Buffer
                
                this.init();
            }
            
            init() {
                // Create scroll container
                this.scrollContainer = document.createElement('div');
                this.scrollContainer.className = 'virtual-scroll-container';
                this.scrollContainer.style.height = `${this.containerHeight}px`;
                this.scrollContainer.style.overflowY = 'auto';
                this.scrollContainer.style.position = 'relative';
                
                // Create content spacer
                this.spacer = document.createElement('div');
                this.spacer.style.height = `${this.items.length * this.itemHeight}px`;
                
                // Create visible items container
                this.itemsContainer = document.createElement('div');
                this.itemsContainer.className = 'virtual-items-container';
                this.itemsContainer.style.position = 'absolute';
                this.itemsContainer.style.top = '0';
                this.itemsContainer.style.width = '100%';
                
                this.scrollContainer.appendChild(this.spacer);
                this.scrollContainer.appendChild(this.itemsContainer);
                
                // Replace original container content
                this.container.innerHTML = '';
                this.container.appendChild(this.scrollContainer);
                
                // Add scroll listener
                this.scrollContainer.addEventListener('scroll', () => {
                    this.scrollTop = this.scrollContainer.scrollTop;
                    this.render();
                });
                
                // Initial render
                this.render();
            }
            
            render() {
                const startIndex = Math.floor(this.scrollTop / this.itemHeight);
                const endIndex = Math.min(startIndex + this.visibleCount, this.items.length);
                
                // Update spacer position
                this.itemsContainer.style.top = `${startIndex * this.itemHeight}px`;
                
                // Render visible items
                const visibleItems = this.items.slice(startIndex, endIndex);
                this.itemsContainer.innerHTML = visibleItems.map((item, idx) => {
                    return this.renderItem(item, startIndex + idx);
                }).join('');
            }
            
            updateItems(newItems) {
                this.items = newItems;
                this.spacer.style.height = `${this.items.length * this.itemHeight}px`;
                this.render();
            }
        };
        
        // Enhance widgets that render long lists
        if (window.dashboardWidgets) {
            const originalRenderClient = window.dashboardWidgets.renderClient;
            if (originalRenderClient) {
                // Store original for non-virtual rendering
                window.dashboardWidgets.renderClientOriginal = originalRenderClient;
                
                // Add virtual scrolling option
                window.dashboardWidgets.renderClientList = function(clients, container, useVirtual = false) {
                    if (!useVirtual || clients.length < 20) {
                        // Use regular rendering for small lists
                        container.innerHTML = clients.map(client => originalRenderClient.call(this, client)).join('');
                        return;
                    }
                    
                    // Use virtual scrolling for long lists
                    const itemHeight = 80; // Approximate client card height
                    const renderItem = (client, index) => originalRenderClient.call(this, client);
                    
                    if (!container.virtualScroller) {
                        container.virtualScroller = new window.VirtualScroller(
                            container,
                            clients,
                            itemHeight,
                            renderItem
                        );
                    } else {
                        container.virtualScroller.updateItems(clients);
                    }
                };
            }
        }
    }
    
    /**
     * Debounce search inputs throughout the app
     */
    function debounceSearchInputs() {
        // Find and debounce all search inputs
        function debounceSearchInputsInContainer(container) {
            const searchInputs = container.querySelectorAll('input[type="search"], input[placeholder*="Search" i], input[placeholder*="Filter" i]');
            
            searchInputs.forEach(input => {
                // Skip if already debounced
                if (input.dataset.debounced === 'true') return;
                
                input.dataset.debounced = 'true';
                
                // Get original oninput handler if exists
                const originalHandler = input.oninput;
                
                // Create debounced handler
                const debouncedHandler = window.debounce((e) => {
                    if (originalHandler) {
                        originalHandler.call(input, e);
                    }
                    
                    // Trigger custom event for search
                    const searchEvent = new CustomEvent('search', {
                        detail: { value: e.target.value },
                        bubbles: true
                    });
                    input.dispatchEvent(searchEvent);
                }, 300); // 300ms debounce
                
                // Replace oninput
                input.addEventListener('input', debouncedHandler);
            });
        }
        
        // Debounce existing inputs
        debounceSearchInputsInContainer(document);
        
        // Watch for new inputs added dynamically
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        debounceSearchInputsInContainer(node);
                    }
                });
            });
        });
        
        const attachObserver = () => {
            const target = document.body;
            if (!target) {
                setTimeout(attachObserver, 50);
                return;
            }
            observer.observe(target, {
                childList: true,
                subtree: true
            });
        };

        attachObserver();
        
        // Enhance client search specifically
        if (window.clientManager) {
            const originalSearchClients = window.clientManager.searchClients;
            if (originalSearchClients) {
                window.clientManager.searchClients = window.debounce(originalSearchClients, 300);
            }
        }
    }
    
    // Add performance monitoring
    function addPerformanceMonitoring() {
        if (window.performance && window.performance.mark) {
            // Mark widget render times
            const originalRender = window.dashboardWidgets?.widgets?.get('flightPlan')?.render;
            if (originalRender) {
                const flightPlanWidget = window.dashboardWidgets.widgets.get('flightPlan');
                flightPlanWidget.render = async function() {
                    window.performance.mark('widget-render-start');
                    await originalRender.call(this);
                    window.performance.mark('widget-render-end');
                    window.performance.measure('widget-render', 'widget-render-start', 'widget-render-end');
                    
                    const measure = window.performance.getEntriesByName('widget-render')[0];
                    if (measure.duration > 100) {
                        console.warn(`Widget render took ${measure.duration.toFixed(2)}ms`);
                    }
                };
            }
        }
    }
    
    // Add styles for virtual scrolling
    if (!document.querySelector('#widget-rendering-optimization-styles')) {
        const styles = document.createElement('style');
        styles.id = 'widget-rendering-optimization-styles';
        styles.textContent = `
            /* Virtual Scrolling */
            .virtual-scroll-container {
                position: relative;
            }
            
            .virtual-items-container {
                will-change: transform;
            }
            
            /* Optimize rendering */
            .dashboard-widget {
                contain: layout style paint;
            }
            
            /* Smooth scrolling */
            .virtual-scroll-container {
                scroll-behavior: smooth;
            }
            
            /* Loading states */
            .widget-updating {
                opacity: 0.7;
                pointer-events: none;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
    
    // Add performance monitoring after a delay
    setTimeout(addPerformanceMonitoring, 1000);
    
    console.log('‚úÖ Widget rendering optimization initialized');
})();




// Enhancement: indexeddb-optimization.js
/**
 * IndexedDB Optimization Enhancement
 * Adds indexes on frequently queried fields (houseId, status, dates), implements query result caching
 */

(function() {
    'use strict';
    
    // Query cache
    const queryCache = new Map();
    const CACHE_DURATION = 30000; // 30 seconds
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.indexedDBManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        addIndexes();
        addQueryCaching();
    }
    
    /**
     * Add indexes to existing stores
     */
    function addIndexes() {
        // Check if we need to upgrade the database
        const currentVersion = indexedDBManager.version || 4;
        const targetVersion = currentVersion + 1;
        
        // We'll enhance the existing methods rather than upgrading
        // This is safer and doesn't require a migration
        
        // Enhance getAllClients to use indexes
        const originalGetAll = indexedDBManager.getAll;
        if (originalGetAll) {
            indexedDBManager.getAll = async function(storeName, indexName = null, query = null) {
                try {
                    const db = await this.getDB();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    
                    let request;
                    
                    // Use index if provided and exists
                    if (indexName && store.indexNames.contains(indexName)) {
                        const index = store.index(indexName);
                        if (query !== null && query !== undefined) {
                            request = index.getAll(query);
                        } else {
                            request = index.openCursor();
                        }
                    } else {
                        request = store.getAll();
                    }
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => {
                            resolve(request.result || []);
                        };
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('Error in getAll:', error);
                    // Fallback to original if available
                    if (originalGetAll) {
                        return originalGetAll.call(this, storeName);
                    }
                    throw error;
                }
            };
        }
        
        // Add query method with index support
        indexedDBManager.query = async function(storeName, filters = {}) {
            try {
                const db = await this.getDB();
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                
                // Build query based on available indexes
                let indexName = null;
                let queryValue = null;
                
                // Prefer indexed fields
                if (filters.houseId && store.indexNames.contains('houseId')) {
                    indexName = 'houseId';
                    queryValue = filters.houseId;
                } else if (filters.status && store.indexNames.contains('status')) {
                    indexName = 'status';
                    queryValue = filters.status;
                }
                
                let results = [];
                
                if (indexName) {
                    // Use index for faster query
                    const index = store.index(indexName);
                    const request = index.getAll(queryValue);
                    
                    results = await new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => reject(request.error);
                    });
                } else {
                    // Fallback to full scan with filtering
                    const request = store.getAll();
                    results = await new Promise((resolve, reject) => {
                        request.onsuccess = () => {
                            let filtered = request.result || [];
                            
                            // Apply filters
                            if (filters.houseId) {
                                filtered = filtered.filter(item => item.houseId === filters.houseId);
                            }
                            if (filters.status) {
                                filtered = filtered.filter(item => item.status === filters.status);
                            }
                            if (filters.admissionDateFrom) {
                                const fromDate = new Date(filters.admissionDateFrom);
                                filtered = filtered.filter(item => {
                                    if (!item.admissionDate) return false;
                                    return new Date(item.admissionDate) >= fromDate;
                                });
                            }
                            if (filters.admissionDateTo) {
                                const toDate = new Date(filters.admissionDateTo);
                                filtered = filtered.filter(item => {
                                    if (!item.admissionDate) return false;
                                    return new Date(item.admissionDate) <= toDate;
                                });
                            }
                            
                            resolve(filtered);
                        };
                        request.onerror = () => reject(request.error);
                    });
                }
                
                return results;
            } catch (error) {
                console.error('Error in query:', error);
                throw error;
            }
        };
    }
    
    /**
     * Add query result caching
     */
    function addQueryCaching() {
        // Cache key generator
        function getCacheKey(storeName, filters) {
            return `${storeName}:${JSON.stringify(filters)}`;
        }
        
        // Check if cache entry is valid
        function isCacheValid(entry) {
            if (!entry) return false;
            const age = Date.now() - entry.timestamp;
            return age < CACHE_DURATION;
        }
        
        // Enhanced getAllClients with caching
        if (indexedDBManager.getAllClients) {
            const originalGetAllClients = indexedDBManager.getAllClients;
            
            indexedDBManager.getAllClients = async function(filters = {}) {
                const cacheKey = getCacheKey('clients', filters);
                const cached = queryCache.get(cacheKey);
                
                if (isCacheValid(cached)) {
                    console.log('üì¶ Using cached clients query');
                    return cached.data;
                }
                
                // Execute query
                let results;
                if (Object.keys(filters).length > 0) {
                    results = await this.query('clients', filters);
                } else {
                    results = await originalGetAllClients.call(this);
                }
                
                // Cache results
                queryCache.set(cacheKey, {
                    data: results,
                    timestamp: Date.now()
                });
                
                return results;
            };
        }
        
        // Enhanced getClientsByHouse with caching
        if (indexedDBManager.getClientsByHouse) {
            const originalGetClientsByHouse = indexedDBManager.getClientsByHouse;
            
            indexedDBManager.getClientsByHouse = async function(houseId) {
                const cacheKey = getCacheKey('clients', { houseId });
                const cached = queryCache.get(cacheKey);
                
                if (isCacheValid(cached)) {
                    console.log(`üì¶ Using cached clients for house ${houseId}`);
                    return cached.data;
                }
                
                const results = await originalGetClientsByHouse.call(this, houseId);
                
                queryCache.set(cacheKey, {
                    data: results,
                    timestamp: Date.now()
                });
                
                return results;
            };
        }
        
        // Enhanced getClientsByStatus with caching
        if (indexedDBManager.getClientsByStatus) {
            const originalGetClientsByStatus = indexedDBManager.getClientsByStatus;
            
            indexedDBManager.getClientsByStatus = async function(status) {
                const cacheKey = getCacheKey('clients', { status });
                const cached = queryCache.get(cacheKey);
                
                if (isCacheValid(cached)) {
                    console.log(`üì¶ Using cached clients with status ${status}`);
                    return cached.data;
                }
                
                const results = await originalGetClientsByStatus.call(this, status);
                
                queryCache.set(cacheKey, {
                    data: results,
                    timestamp: Date.now()
                });
                
                return results;
            };
        }
        
        // Add cache invalidation methods
        indexedDBManager.invalidateCache = function(storeName = null) {
            if (storeName) {
                // Invalidate specific store
                for (const [key] of queryCache) {
                    if (key.startsWith(storeName + ':')) {
                        queryCache.delete(key);
                    }
                }
            } else {
                // Invalidate all
                queryCache.clear();
            }
            console.log('üóëÔ∏è Cache invalidated' + (storeName ? ` for ${storeName}` : ''));
        };
        
        // Auto-invalidate cache on updates
        if (indexedDBManager.put) {
            const originalPut = indexedDBManager.put;
            indexedDBManager.put = async function(storeName, data) {
                const result = await originalPut.call(this, storeName, data);
                this.invalidateCache(storeName);
                return result;
            };
        }
        
        if (indexedDBManager.delete) {
            const originalDelete = indexedDBManager.delete;
            indexedDBManager.delete = async function(storeName, key) {
                const result = await originalDelete.call(this, storeName, key);
                this.invalidateCache(storeName);
                return result;
            };
        }
        
        // Clean up old cache entries periodically
        setInterval(() => {
            const now = Date.now();
            for (const [key, entry] of queryCache) {
                if (!isCacheValid(entry)) {
                    queryCache.delete(key);
                }
            }
        }, CACHE_DURATION);
    }
    
    // Integrate with event system for cache invalidation
    if (window.subscribe) {
        window.subscribe('client:updated', () => {
            if (indexedDBManager.invalidateCache) {
                indexedDBManager.invalidateCache('clients');
            }
        });
        
        window.subscribe('tracker:updated', () => {
            if (indexedDBManager.invalidateCache) {
                indexedDBManager.invalidateCache('clients');
            }
        });
    }
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
    
    console.log('‚úÖ IndexedDB optimization initialized');
})();




// Enhancement: onboarding-integration.js
/**
 * Onboarding System Integration
 * Loads onboarding assets and initializes the manager when the dashboard is ready.
 */

(function() {
    'use strict';

    if (window.__onboardingIntegrationLoaded) return;
    window.__onboardingIntegrationLoaded = true;

    const ASSET_PATH = 'onboarding/';
    const SCRIPT_FILES = [
        'onboarding-content.js',
        'onboarding-manager.js',
        'onboarding-video.js',
        'onboarding-tour.js',
        'onboarding-practice.js'
    ];

    // Track if scripts are loading to prevent duplicate loads
    let scriptsLoading = false;
    let scriptsLoaded = false;

    function loadScript(src) {
        return new Promise((resolve, reject) => {
            if (document.querySelector(`script[data-onboarding="${src}"]`)) {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = src;
            script.async = false;
            script.dataset.onboarding = src;
            script.onload = resolve;
            script.onerror = () => reject(new Error(`Failed to load ${src}`));
            document.head.appendChild(script);
        });
    }

    function ensureStyles() {
        if (document.querySelector('link[data-onboarding-style="styles"]')) return;
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = `${ASSET_PATH}onboarding-styles.css`;
        link.dataset.onboardingStyle = 'styles';
        document.head.appendChild(link);
    }

    function loadAssets() {
        if (scriptsLoaded) {
            console.log('[Onboarding] Assets already loaded');
            return Promise.resolve();
        }
        
        if (scriptsLoading) {
            console.log('[Onboarding] Assets already loading, waiting...');
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (scriptsLoaded) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 5000);
            });
        }

        scriptsLoading = true;
        ensureStyles();
        
        return SCRIPT_FILES.reduce((promise, file) => {
            return promise.then(() => {
                console.log(`[Onboarding] Loading ${file}...`);
                return loadScript(`${ASSET_PATH}${file}`);
            }).then(() => {
                console.log(`[Onboarding] Loaded ${file}`);
            });
        }, Promise.resolve()).then(() => {
            scriptsLoaded = true;
            scriptsLoading = false;
            console.log('[Onboarding] All assets loaded');
            
            // Ensure manager is available
            if (!window.onboardingManager) {
                console.warn('[Onboarding] Manager not found after loading scripts, waiting...');
                return new Promise((resolve) => {
                    const checkManager = setInterval(() => {
                        if (window.onboardingManager) {
                            clearInterval(checkManager);
                            resolve();
                        }
                    }, 100);
                    setTimeout(() => {
                        clearInterval(checkManager);
                        resolve();
                    }, 2000);
                });
            }
        });
    }

    function waitForDashboardReady(timeoutMs = 30000) {
        return new Promise((resolve, reject) => {
            const start = Date.now();

            const interval = setInterval(() => {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const dashboardVisible = document.querySelector('.dashboard-container, #dashboardTab, [data-page="dashboard"], .dashboard-manager');
                const managerAvailable = window.onboardingManager;

                if (isLoggedIn && managerAvailable) {
                    // If dashboard is visible, great. If not, still proceed after a short delay
                    if (dashboardVisible || Date.now() - start > 2000) {
                        clearInterval(interval);
                        console.log('[Onboarding] Dashboard ready, initializing...');
                        resolve();
                    }
                }

                if (Date.now() - start > timeoutMs) {
                    clearInterval(interval);
                    console.warn('[Onboarding] Timeout waiting for dashboard, proceeding anyway...');
                    resolve(); // Resolve instead of reject to still try initialization
                }
            }, 500);
        });
    }

    async function initializeOnboarding() {
        try {
            console.log('[Onboarding] Starting initialization...');
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) {
                console.log('[Onboarding] User not logged in, skipping');
                return;
            }

            await loadAssets();
            console.log('[Onboarding] Assets loaded, waiting for dashboard...');
            await waitForDashboardReady();
            
            // Wait a moment for manager to be available
            let attempts = 0;
            while (!window.onboardingManager && attempts < 10) {
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }

            if (window.onboardingManager && typeof window.onboardingManager.initialize === 'function') {
                console.log('[Onboarding] Initializing manager...');
                await window.onboardingManager.initialize();
                console.log('[Onboarding] Manager initialized successfully');
            } else {
                console.error('[Onboarding] Manager not available after loading assets');
                console.error('[Onboarding] window.onboardingManager:', window.onboardingManager);
                console.error('[Onboarding] Available globals:', Object.keys(window).filter(k => k.includes('onboard')));
            }
        } catch (error) {
            console.error('[Onboarding] Error during initialization:', error);
        }
    }

    function hookLoginFlow() {
        // Hook into showDashboard if it exists
        const originalShowDashboard = window.showDashboard;
        if (originalShowDashboard) {
            window.showDashboard = async function(...args) {
                const result = originalShowDashboard.apply(this, args);
                setTimeout(() => initializeOnboarding(), 500);
                return result;
            };
        }

        // Also watch for login state changes
        const checkLoginState = () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (isLoggedIn) {
                setTimeout(() => initializeOnboarding(), 1000);
            }
        };

        // Check immediately
        checkLoginState();

        // Watch for changes
        const originalSetItem = Storage.prototype.setItem;
        Storage.prototype.setItem = function(key, value) {
            originalSetItem.apply(this, arguments);
            if (key === 'isLoggedIn' && value === 'true') {
                setTimeout(() => initializeOnboarding(), 1000);
            }
        };
    }

    function hookKeyboardShortcut() {
        document.addEventListener('keydown', (event) => {
            const isShortcut = (event.ctrlKey || event.metaKey) && event.shiftKey && event.key.toLowerCase() === 'o';
            if (!isShortcut) return;
            event.preventDefault();
            loadAssets().then(() => {
                if (window.onboardingManager) {
                    window.onboardingManager.replay();
                }
            });
        });
    }

    hookLoginFlow();
    hookKeyboardShortcut();

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initializeOnboarding();
    } else {
        window.addEventListener('DOMContentLoaded', initializeOnboarding);
    }

    window.triggerOnboardingTutorial = () => initializeOnboarding();
})();



</script>
    <!-- Client Tracking Styles -->
    <style>
        /* Base Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        /* Client Tracking Styles */
        .tab-navigation {
            display: none !important;
            visibility: hidden !important;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            background: #f9fafb;
            color: #374151;
            transform: translateY(-1px);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }
        
        .tab-content {
            display: none;
            height: 100%;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .client-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .client-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .client-header h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }
        
        .current-client-banner {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .current-client-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-avatar {
            width: 50px;
            height: 50px;
            background: white;
            color: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .client-details {
            flex: 1;
        }
        
        .client-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .client-id {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .client-actions {
            display: flex;
            gap: 10px;
        }
        
        .client-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .client-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .client-quick-add {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .client-form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .client-form-group {
            flex: 1;
        }
        
        .client-form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #4b5563;
            font-weight: 500;
        }
        
        .client-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .client-form-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .add-client-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-client-btn:hover {
            background: #5558e3;
        }
        
        .client-list-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .client-list-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-list-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-filter-tabs {
            display: flex;
            gap: 10px;
        }
        
        .client-filter-tab {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .client-filter-tab:hover {
            border-color: #d1d5db;
            color: #4b5563;
        }
        
        .client-filter-tab.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .client-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .client-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-card:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .client-card.selected {
            background: #ede9fe;
            border-color: #8b5cf6;
        }
        
        .client-card-avatar {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .client-card-info {
            flex: 1;
        }
        
        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .client-card-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-card-kipu {
            font-size: 14px;
            color: #6b7280;
        }
        
        .client-card-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #6b7280;
        }
        
        .client-status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .client-status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .client-status-badge.waitlist {
            background: #fef3c7;
            color: #92400e;
        }
        
        .client-status-badge.discharged {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .client-empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .client-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .client-search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        /* Alert Animation */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Milestone Indicator Styles */
        .milestone-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .milestone-indicator.complete {
            background-color: #10b981;
            color: white;
        }
        
        .milestone-indicator.overdue {
            background-color: #ef4444;
            color: white;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .milestone-indicator.due-today {
            background-color: #f59e0b;
            color: white;
        }
        
        .milestone-indicator.due-soon {
            background-color: #f59e0b;
            color: white;
            opacity: 0.8;
        }
        
        .milestone-indicator.in-progress {
            background-color: #3b82f6;
            color: white;
        }
        
        .milestone-indicator.pending {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .8;
            }
        }
        
        /* Days in care color coding */
        .days-in-care {
            font-weight: 500;
        }
        
        td.days-in-care {
            text-align: center;
        }
        
        /* Color code days based on milestones */
        .days-13 { color: #f59e0b; font-weight: 600; }
        .days-14 { color: #f59e0b; font-weight: 600; }
        .days-16plus { color: #ef4444; font-weight: 600; }
        
        /* CM Tracker House Navigation */
        .cm-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #f9fafb;
        }
        
        .house-navigation {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 0;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .house-tabs {
            display: flex;
            gap: 0;
            flex: 1;
            overflow-x: auto;
        }
        
        .house-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        
        .house-tab:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .house-tab.active {
            color: #6366f1;
            background: #eef2ff;
            border-bottom-color: #6366f1;
        }
        
        .house-tab .client-count {
            margin-left: 5px;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: normal;
        }
        
        .house-tab.active .client-count {
            background: #6366f1;
            color: white;
        }
        
        .house-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .cm-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .cm-action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .cm-action-btn:hover {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .cm-action-btn.primary {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .cm-action-btn.primary:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }
        
        /* Prevent accidental JSON rendering */
        body > *:not(script):not(style):not(link) {
            white-space: normal;
        }
        
        /* Hide any raw JSON that might accidentally render */
        body > pre:not(.code-block),
        body > code:not(.inline-code) {
            display: none !important;
        }
        
        .clients-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .clients-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .clients-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .clients-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            color: #1f2937;
        }
        
        .clients-table tr:hover {
            background: #f9fafb;
        }
        
        .client-initials {
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
        }
        
        .client-initials:hover {
            color: #6366f1;
            text-decoration: underline;
        }
        
        .days-in-care {
            font-weight: 500;
            color: #6b7280;
        }
        
        .team-member {
            font-size: 13px;
            color: #6b7280;
        }
        
        .milestone-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .milestone-indicator.complete {
            background: #10b981;
            color: white;
        }
        
        .milestone-indicator.pending {
            background: #f3f4f6;
            color: #9ca3af;
            border: 1px solid #e5e7eb;
        }
        
        .milestone-indicator.overdue {
            background: #ef4444;
            color: white;
        }
        
        .aftercare-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .aftercare-status.sent {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .aftercare-status.engaged {
            background: #fef3c7;
            color: #92400e;
        }
        
        .aftercare-status.accepted {
            background: #d1fae5;
            color: #065f46;
        }
        
        .aftercare-status.declined {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 4px 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #e5e7eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .empty-state-text {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 500px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #1f2937;
            font-size: 20px;
        }
        
        .modal-content label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }
        
        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
    
/* Enhancement: styles.css */

/* Custom Enhancements - Add your custom styles here */

/* Modal Overlay Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
}

/* Form Enhancements */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #2d3748;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #667eea;
}

.form-group small {
    display: block;
    margin-top: 4px;
    font-size: 12px;
}

/* Button Styles */
.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}

.btn-primary:hover {
    transform: translateY(-2px);
}

.btn-secondary {
    background: #e2e8f0;
    color: #2d3748;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-secondary:hover {
    background: #cbd5e0;
}

.btn-icon {
    background: transparent;
    border: 1px solid #e2e8f0;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    margin-left: 10px;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: #f7fafc;
    border-color: #cbd5e0;
}

/* Notifications */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Enhancement: unified-design.css */


/* Enhancement: tracker-ui.css */
/**
 * Tracker UI Styles
 * Visual enhancements for tracker completion indicators
 */

/* Tracker Status in Client Cards */
.tracker-status {
    margin: 10px 0;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tracker-status:hover {
    background: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Risk Level Indicators */
.tracker-status.risk-red {
    border-left: 4px solid #dc3545;
    background: #fff5f5;
}

.tracker-status.risk-yellow {
    border-left: 4px solid #ffc107;
    background: #fffdf5;
}

.tracker-status.risk-green {
    border-left: 4px solid #28a745;
    background: #f5fff7;
}

/* Completion Bar */
.completion-bar {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.completion-fill {
    height: 100%;
    background: linear-gradient(90deg, #0099cc 0%, #006699 100%);
    transition: width 0.5s ease;
    position: relative;
}

.completion-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255,255,255,0.3) 50%,
        transparent 100%
    );
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Completion Text */
.completion-text {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    margin-bottom: 4px;
}

.completion-percentage {
    font-weight: 600;
    color: #333;
}

.critical-missing {
    color: #dc3545;
    font-weight: 500;
}

/* Missing Items */
.missing-items {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
    font-style: italic;
}

/* Tracker Modal */
.tracker-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.tracker-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tracker-modal-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tracker-modal-header h3 {
    margin: 0;
    font-size: 20px;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.3s ease;
}

.close-btn:hover {
    background: rgba(255,255,255,0.2);
}

.tracker-modal-content {
    padding: 20px;
    overflow-y: auto;
    max-height: calc(80vh - 70px);
}

/* Summary Stats */
.tracker-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.summary-stat {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: #0099cc;
}

/* Missing & Upcoming Sections */
.missing-critical-section,
.upcoming-section {
    margin-bottom: 20px;
}

.missing-critical-section h4,
.upcoming-section h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 16px;
}

.missing-list,
.upcoming-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.missing-item,
.upcoming-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.missing-item:hover,
.upcoming-item:hover {
    border-color: #0099cc;
    box-shadow: 0 2px 8px rgba(0,153,204,0.1);
}

.missing-item {
    border-left: 3px solid #dc3545;
}

.upcoming-item {
    border-left: 3px solid #ffc107;
}

.item-label {
    font-weight: 500;
    color: #333;
}

.item-due {
    font-size: 12px;
    color: #666;
}

/* Tracker Actions */
.tracker-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.tracker-actions button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,153,204,0.3);
}

.btn-secondary {
    background: #f8f9fa;
    color: #333;
    border: 1px solid #dee2e6;
}

.btn-secondary:hover {
    background: #e9ecef;
}

/* Dashboard Integration */
.client-card {
    position: relative;
    transition: all 0.3s ease;
}

.client-card:has(.tracker-status.risk-red) {
    border-color: #dc3545;
}

.client-card:has(.tracker-status.risk-yellow) {
    border-color: #ffc107;
}

/* Flight Plan Integration */
.priority-item[data-tracker-generated="true"] {
    position: relative;
}

.priority-item[data-tracker-generated="true"]::before {
    content: 'ü§ñ';
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    opacity: 0.5;
}

/* Timeline Modal Specific */
.timeline-modal-large {
    width: 95%;
    max-width: 1200px;
}

.timeline-modal-large .tracker-modal-content {
    max-height: calc(90vh - 70px);
}

/* Responsive Design */
@media (max-width: 768px) {
    .tracker-modal {
        width: 95%;
        max-height: 90vh;
    }
    
    .tracker-summary {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .completion-text {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .tracker-actions {
        flex-direction: column;
    }
}


/* Enhancement: tracker-timeline.css */
/**
 * Tracker Timeline Styles
 * Visual timeline component for tracker progress
 */

/* Timeline Container */
.tracker-timeline {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Timeline Header */
.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.timeline-title h3 {
    margin: 0;
    color: #333;
    font-size: 20px;
}

.timeline-subtitle {
    display: block;
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.timeline-stats {
    display: flex;
    gap: 20px;
}

.stat-badge {
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 28px;
    font-weight: 700;
    color: #0099cc;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Timeline Container */
.timeline-container {
    position: relative;
    margin: 40px 0;
    padding: 40px 0;
}

/* Timeline Track */
.timeline-track {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 4px;
    background: #e0e0e0;
    transform: translateY(-50%);
    border-radius: 2px;
}

.timeline-progress {
    height: 100%;
    background: linear-gradient(90deg, #0099cc 0%, #006699 100%);
    border-radius: 2px;
    transition: width 0.5s ease;
}

/* Timeline Markers */
.timeline-markers {
    position: relative;
    height: 60px;
}

.timeline-marker {
    position: absolute;
    transform: translateX(-50%);
}

.marker-line {
    width: 2px;
    height: 40px;
    background: #999;
    margin: 0 auto;
}

.marker-label {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    margin-top: 5px;
    text-align: center;
}

.timeline-marker.admission .marker-line {
    background: #28a745;
}

.timeline-marker.current .marker-line {
    background: #0099cc;
    width: 3px;
}

.timeline-marker.current .marker-label {
    font-weight: 600;
    color: #0099cc;
}

.timeline-marker.discharge .marker-line {
    background: #dc3545;
}

/* Timeline Items */
.timeline-items {
    position: relative;
    min-height: 200px;
    margin-top: 40px;
}

.timeline-group {
    position: absolute;
    transform: translateX(-50%);
}

.group-connector {
    width: 2px;
    height: 20px;
    background: #ddd;
    margin: 0 auto;
}

.group-label {
    font-size: 12px;
    color: #666;
    text-align: center;
    margin-bottom: 10px;
    font-weight: 600;
}

.group-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
}

/* Timeline Item */
.timeline-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    white-space: nowrap;
}

.timeline-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.item-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
}

.item-icon.complete {
    background: #28a745;
    color: white;
}

.item-icon.pending {
    background: #e0e0e0;
    color: #666;
}

.item-icon.upcoming {
    background: #ffc107;
    color: white;
}

.item-icon.overdue {
    background: #dc3545;
    color: white;
}

.item-content {
    flex: 1;
}

.item-title {
    font-size: 13px;
    font-weight: 500;
    color: #333;
    display: flex;
    align-items: center;
    gap: 5px;
}

.critical-badge {
    color: #dc3545;
    font-size: 12px;
}

.item-date {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

/* Timeline Item Status Colors */
.timeline-item.complete {
    background: #e8f5e9;
}

.timeline-item.overdue {
    background: #ffebee;
}

.timeline-item.upcoming {
    background: #fff8e1;
}

/* Tooltip */
.item-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-10px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
    pointer-events: none;
}

.item-tooltip.visible {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
}

.tooltip-content {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    min-width: 250px;
}

.tooltip-content h4 {
    margin: 0 0 8px 0;
    color: #333;
    font-size: 14px;
}

.tooltip-content p {
    margin: 0 0 10px 0;
    font-size: 12px;
    color: #666;
    line-height: 1.5;
}

.tooltip-status {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

.btn-mark-complete {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-mark-complete:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,153,204,0.3);
}

/* Legend */
.timeline-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #666;
}

.legend-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}

.legend-icon.complete {
    background: #28a745;
    color: white;
}

.legend-icon.pending {
    background: #e0e0e0;
    color: #666;
}

.legend-icon.overdue {
    background: #dc3545;
    color: white;
}

.legend-icon.critical {
    background: transparent;
    color: #dc3545;
}

/* Notifications */
.timeline-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 10000;
}

.timeline-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.timeline-notification.success {
    background: #28a745;
}

.timeline-notification.error {
    background: #dc3545;
}

.timeline-notification.info {
    background: #0099cc;
}

/* Responsive Design */
@media (max-width: 768px) {
    .timeline-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .timeline-stats {
        justify-content: center;
    }
    
    .timeline-container {
        overflow-x: auto;
        padding-bottom: 60px;
    }
    
    .timeline-items {
        min-width: 600px;
    }
    
    .timeline-legend {
        flex-wrap: wrap;
        gap: 10px;
    }
}


/* Enhancement: tracker-bulk-update.css */
/**
 * Tracker Bulk Update Modal Styles
 * Quick-entry interface for updating multiple tracker items
 */

/* Overlay */
.bulk-update-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

/* Modal Container */
.bulk-update-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

/* Header */
.bulk-update-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-info h3 {
    margin: 0 0 8px 0;
    font-size: 20px;
}

.header-stats {
    display: flex;
    gap: 15px;
    font-size: 14px;
    opacity: 0.9;
}

.header-stats .stat {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.header-stats .stat::after {
    content: '‚Ä¢';
    margin-left: 10px;
    opacity: 0.5;
}

.header-stats .stat:last-child::after {
    display: none;
}

/* Content */
.bulk-update-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Filters */
.bulk-update-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.filter-btn {
    padding: 8px 16px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-btn:hover {
    background: #f8f9fa;
}

.filter-btn.active {
    background: #0099cc;
    color: white;
    border-color: #0099cc;
}

/* Categories */
.bulk-update-categories {
    margin-bottom: 20px;
}

.update-category {
    margin-bottom: 25px;
}

.category-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid #e0e0e0;
}

.category-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Items */
.update-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.update-item:hover {
    background: #e9ecef;
}

.update-item.complete {
    background: #e8f5e9;
}

.update-item.overdue {
    background: #ffebee;
    border-left: 3px solid #dc3545;
}

.item-label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    flex: 1;
}

.item-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.item-text {
    font-size: 14px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.critical-badge {
    color: #dc3545;
    font-size: 12px;
}

.item-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
}

.completed-date {
    color: #28a745;
}

.due-date {
    color: #666;
}

.overdue-badge {
    background: #dc3545;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

/* Notes Section */
.bulk-update-notes {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.bulk-update-notes label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.bulk-update-notes textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 14px;
    resize: vertical;
    font-family: inherit;
}

.bulk-update-notes textarea:focus {
    outline: none;
    border-color: #0099cc;
    box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
}

/* Footer */
.bulk-update-footer {
    padding: 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

.footer-info {
    font-size: 14px;
    color: #666;
}

.footer-actions {
    display: flex;
    gap: 10px;
}

.footer-actions button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary {
    background: white;
    color: #333;
    border: 1px solid #dee2e6;
}

.btn-secondary:hover {
    background: #e9ecef;
}

.btn-primary {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,153,204,0.3);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Notifications */
.bulk-update-notification {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.bulk-update-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.bulk-update-notification.success {
    background: #28a745;
}

.bulk-update-notification.error {
    background: #dc3545;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .bulk-update-modal {
        width: 95%;
        max-height: 95vh;
    }
    
    .bulk-update-header {
        padding: 15px;
    }
    
    .header-info h3 {
        font-size: 18px;
    }
    
    .header-stats {
        font-size: 12px;
    }
    
    .bulk-update-filters {
        flex-wrap: wrap;
    }
    
    .update-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .item-info {
        margin-left: 30px;
    }
    
    .footer-actions {
        flex-direction: column;
        width: 100%;
    }
    
    .footer-actions button {
        width: 100%;
    }
}


/* Enhancement: tracker-compliance-widget.css */
/**
 * Tracker Compliance Widget Styles
 * House-level compliance dashboard visualization
 */

/* Widget Container */
.compliance-widget {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Widget Header */
.compliance-widget .widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.compliance-widget .widget-header h3 {
    margin: 0;
    font-size: 18px;
    color: #333;
}

.refresh-btn {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    background: #f8f9fa;
    transform: rotate(180deg);
}

.refresh-icon {
    font-size: 16px;
    color: #666;
}

/* Compliance Overview */
.compliance-overview {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 20px;
    margin-bottom: 25px;
    padding-bottom: 25px;
    border-bottom: 1px solid #e0e0e0;
}

/* Overall Score Circle */
.overall-score {
    display: flex;
    align-items: center;
    justify-content: center;
}

.score-circle {
    position: relative;
    width: 100px;
    height: 100px;
}

.circular-chart {
    display: block;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.circle-bg {
    fill: none;
    stroke: #f0f0f0;
    stroke-width: 2.8;
}

.circle {
    fill: none;
    stroke: #0099cc;
    stroke-width: 2.8;
    stroke-linecap: round;
    animation: progress 1s ease-out forwards;
}

@keyframes progress {
    0% {
        stroke-dasharray: 0 100;
    }
}

.percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.percentage .value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: #0099cc;
}

.percentage .label {
    display: block;
    font-size: 11px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Compliance Metrics */
.compliance-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    align-items: center;
}

.metric {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.metric-value {
    display: block;
    font-size: 28px;
    font-weight: 700;
    color: #333;
    margin-bottom: 5px;
}

.metric-label {
    display: block;
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* House Compliance List */
.house-compliance-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

/* House Card */
.house-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.house-card.good {
    border-color: #28a745;
}

.house-card.warning {
    border-color: #ffc107;
}

.house-card.danger {
    border-color: #dc3545;
}

.house-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.house-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.house-header h4 {
    margin: 0;
    font-size: 16px;
    color: #333;
}

.house-score {
    font-size: 20px;
    font-weight: 700;
}

.house-card.good .house-score {
    color: #28a745;
}

.house-card.warning .house-score {
    color: #ffc107;
}

.house-card.danger .house-score {
    color: #dc3545;
}

/* House Details */
.house-details {
    margin-bottom: 12px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    padding: 3px 0;
}

.detail-row span:first-child {
    color: #666;
}

.detail-row span:last-child {
    font-weight: 600;
    color: #333;
}

.text-danger {
    color: #dc3545 !important;
}

/* Category Breakdown */
.category-breakdown {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e0e0e0;
}

.category-bar {
    display: grid;
    grid-template-columns: 60px 1fr 40px;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}

.cat-label {
    font-size: 11px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.cat-progress {
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
}

.cat-fill {
    height: 100%;
    background: linear-gradient(90deg, #0099cc 0%, #006699 100%);
    transition: width 0.5s ease;
}

.cat-value {
    font-size: 11px;
    font-weight: 600;
    color: #333;
    text-align: right;
}

/* At Risk Section */
.at-risk-section {
    background: #fff5f5;
    border: 1px solid #ffcdd2;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.at-risk-section h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: #c62828;
}

.at-risk-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.at-risk-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid #ffebee;
}

.client-info {
    font-size: 13px;
    color: #333;
}

.action-btn {
    padding: 6px 12px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-btn:hover {
    background: #c82333;
    transform: translateY(-1px);
}

/* Widget Error */
.widget-error {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}

/* Responsive Design */
@media (max-width: 768px) {
    .compliance-overview {
        grid-template-columns: 1fr;
        text-align: center;
    }
    
    .overall-score {
        margin: 0 auto 20px;
    }
    
    .compliance-metrics {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .house-compliance-list {
        grid-template-columns: 1fr;
    }
    
    .metric {
        padding: 10px;
    }
    
    .metric-value {
        font-size: 20px;
    }
}


/* Enhancement: tracker-document-hub.css */
/**
 * Tracker Document Hub Styles
 * Visual status indicators for document tracking
 */

/* Document Hub Overlay */
.document-hub-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

/* Document Hub Modal */
.document-hub-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

/* Header */
.document-hub-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.document-hub-header h3 {
    margin: 0;
    font-size: 20px;
}

/* Content */
.document-hub-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Document Summary */
.document-summary {
    margin-bottom: 25px;
    padding-bottom: 25px;
    border-bottom: 2px solid #e0e0e0;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
}

.summary-stat {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.summary-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.summary-stat.danger {
    background: #ffebee;
    border: 1px solid #ffcdd2;
}

.summary-stat.warning {
    background: #fff8e1;
    border: 1px solid #ffe0b2;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #0099cc;
    display: block;
    margin-bottom: 5px;
}

.summary-stat.danger .stat-value {
    color: #dc3545;
}

.summary-stat.warning .stat-value {
    color: #ffc107;
}

.stat-label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Document Categories */
.document-categories {
    margin-bottom: 20px;
}

.document-category {
    margin-bottom: 25px;
}

.document-category h4 {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 15px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid #e0e0e0;
}

/* Document List */
.document-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Document Item */
.document-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.document-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.document-item.complete {
    background: #e8f5e9;
    border-color: #4caf50;
}

.document-item.overdue {
    background: #ffebee;
    border-color: #f44336;
}

.document-item.urgent {
    background: #fff8e1;
    border-color: #ff9800;
}

/* Document Icon */
.document-icon {
    font-size: 24px;
    width: 40px;
    text-align: center;
}

/* Document Info */
.document-info {
    flex: 1;
}

.document-name {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.required-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: #dc3545;
    color: white;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.signature-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: #6c757d;
    color: white;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.document-status {
    font-size: 12px;
    color: #666;
}

.document-item.overdue .document-status {
    color: #dc3545;
    font-weight: 600;
}

.document-item.urgent .document-status {
    color: #ff9800;
    font-weight: 600;
}

/* Document Actions */
.document-actions {
    display: flex;
    gap: 8px;
}

.btn-icon {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: #f8f9fa;
    transform: scale(1.1);
}

.btn-small {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-small:hover {
    background: #f8f9fa;
}

.btn-small.primary {
    background: #0099cc;
    color: white;
    border-color: #0099cc;
}

.btn-small.primary:hover {
    background: #0088bb;
    transform: translateY(-1px);
}

/* Document Actions Footer */
.document-hub-content .document-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.document-hub-content .document-actions button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Document Hub Button on Cards */
.document-hub-btn {
    margin-top: 8px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #333;
}

.document-hub-btn:hover {
    background: #e9ecef;
    border-color: #0099cc;
    color: #0099cc;
}

/* Notifications */
.document-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 10001;
}

.document-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.document-notification.success {
    background: #28a745;
}

.document-notification.error {
    background: #dc3545;
}

.document-notification.info {
    background: #0099cc;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .document-hub-modal {
        width: 95%;
        max-height: 95vh;
    }
    
    .summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .document-item {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .document-info {
        width: 100%;
    }
    
    .document-actions {
        width: 100%;
        justify-content: center;
    }
    
    .document-hub-content .document-actions {
        flex-direction: column;
    }
    
    .document-hub-content .document-actions button {
        width: 100%;
    }
}


/* Enhancement: tracker-aftercare-cascade.css */
/**
 * Aftercare Options Cascade Styles
 * Visual flow for aftercare decisions
 */

/* Overlay */
.aftercare-cascade-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

/* Modal */
.aftercare-cascade-modal {
    background: white;
    border-radius: 12px;
    width: 95%;
    max-width: 1100px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

/* Header */
.cascade-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-info h3 {
    margin: 0 0 8px 0;
    font-size: 20px;
}

.header-stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    opacity: 0.9;
}

.header-stats span {
    position: relative;
}

.header-stats span:not(:last-child)::after {
    content: '‚Ä¢';
    position: absolute;
    right: -12px;
    opacity: 0.5;
}

/* Content */
.cascade-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Timeline */
.cascade-timeline {
    margin-bottom: 30px;
}

.timeline-header {
    display: grid;
    grid-template-columns: 2fr 2fr 1.5fr;
    gap: 20px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
}

.timeline-label {
    font-size: 14px;
    font-weight: 600;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Cascade Options */
.cascade-options {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 20px;
}

/* Individual Option */
.cascade-option {
    display: grid;
    grid-template-columns: 40px 2fr 60px 2fr 60px 1.5fr;
    gap: 0;
    align-items: start;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.cascade-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.option-number {
    width: 32px;
    height: 32px;
    background: #0099cc;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
}

/* Option Stages */
.option-stage {
    padding: 0 15px;
}

.stage-content h4 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #333;
}

.option-details {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
}

.detail-item {
    font-size: 12px;
    padding: 3px 8px;
    background: white;
    border-radius: 4px;
    color: #666;
}

.date-label {
    font-size: 11px;
    color: #999;
    margin-top: 5px;
}

.stage-actions {
    margin-top: 10px;
}

/* Connectors */
.option-connector {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    height: 100%;
}

.connector-line {
    position: absolute;
    width: 100%;
    height: 2px;
    background: #ddd;
    top: 50%;
    transform: translateY(-50%);
}

.connector-icon {
    position: relative;
    background: white;
    padding: 5px;
    font-size: 18px;
    z-index: 1;
}

/* Response Status */
.response-status {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.response-text {
    font-size: 13px;
    color: #666;
    font-style: italic;
    margin: 8px 0;
}

/* Status Colors */
.status-accepted .option-number,
.status-accepted .connector-icon {
    background: #28a745;
    color: white;
}

.status-declined .option-number,
.status-declined .connector-icon {
    background: #dc3545;
    color: white;
}

.status-pending .option-number,
.status-pending .connector-icon {
    background: #ffc107;
    color: white;
}

.status-waitlist .option-number,
.status-waitlist .connector-icon {
    background: #6c757d;
    color: white;
}

.cascade-option.status-accepted {
    border-color: #28a745;
    background: #f0fdf4;
}

.cascade-option.status-declined {
    border-color: #dc3545;
    background: #fef2f2;
}

/* Next Steps */
.next-steps-list {
    margin: 10px 0;
    padding-left: 20px;
    font-size: 13px;
    color: #666;
}

.next-steps-list li {
    margin: 5px 0;
}

.declined-note,
.waitlist-note,
.pending-note {
    padding: 10px;
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
}

.declined-note {
    background: #ffebee;
    color: #c62828;
}

.waitlist-note {
    background: #f5f5f5;
    color: #616161;
}

.pending-note {
    background: #fff8e1;
    color: #f57c00;
}

/* Option Timeline */
.option-timeline {
    grid-column: 2 / -1;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
}

.timeline-event {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-right: 20px;
    font-size: 12px;
    color: #666;
}

.event-date {
    font-weight: 600;
}

/* Empty State */
.cascade-empty {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.cascade-empty h4 {
    margin: 0 0 10px 0;
    color: #333;
}

/* Add Option Section */
.add-option-section {
    text-align: center;
    padding: 20px;
}

.btn-add-option {
    padding: 12px 24px;
    background: white;
    border: 2px dashed #0099cc;
    border-radius: 8px;
    color: #0099cc;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-add-option:hover {
    background: #f0f9ff;
    border-style: solid;
}

/* Summary Section */
.cascade-summary {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.summary-section h4 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #333;
}

.summary-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.summary-stats .stat {
    flex: 1;
    text-align: center;
    padding: 15px;
    border-radius: 8px;
    font-size: 20px;
    font-weight: 700;
}

.stat.accepted {
    background: #e8f5e9;
    color: #2e7d32;
}

.stat.pending {
    background: #fff8e1;
    color: #f57c00;
}

.stat.declined {
    background: #ffebee;
    color: #c62828;
}

.primary-selection,
.waiting-response,
.recommendation {
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.primary-selection {
    background: #e8f5e9;
    border: 1px solid #4caf50;
}

.waiting-response {
    background: #fff8e1;
    border: 1px solid #ffc107;
}

.recommendation {
    background: #e3f2fd;
    border: 1px solid #2196f3;
}

.primary-selection h5,
.waiting-response h5,
.recommendation h5 {
    margin: 0 0 8px 0;
    font-size: 14px;
}

.selection-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

/* Actions */
.cascade-actions {
    display: flex;
    gap: 10px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.cascade-actions button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Buttons */
.btn-icon {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: #f8f9fa;
    transform: scale(1.1);
}

.btn-small {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-small:hover {
    background: #f8f9fa;
}

/* Notifications */
.cascade-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 10001;
}

.cascade-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.cascade-notification.success {
    background: #28a745;
}

.cascade-notification.error {
    background: #dc3545;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 1024px) {
    .cascade-option {
        grid-template-columns: 40px 1fr;
        gap: 10px;
    }
    
    .option-stage,
    .option-connector {
        grid-column: 2;
        margin-bottom: 15px;
    }
    
    .option-connector {
        height: 40px;
        flex-direction: column;
    }
    
    .connector-line {
        width: 2px;
        height: 100%;
        left: 50%;
        top: 0;
        transform: translateX(-50%);
    }
    
    .timeline-header {
        display: none;
    }
}

@media (max-width: 768px) {
    .aftercare-cascade-modal {
        width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
    }
    
    .cascade-actions {
        flex-direction: column;
    }
    
    .cascade-actions button {
        width: 100%;
    }
}


/* Enhancement: discharge-checklist.css */
/* Discharge Checklist Styles */

.discharge-checklist-modal .modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

.discharge-checklist-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 2px solid #e5e7eb;
}

.discharge-checklist-modal h2 {
    margin: 0;
    color: #1f2937;
    font-size: 24px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-close:hover {
    color: #1f2937;
}

/* Progress Bar */
.checklist-progress {
    padding: 20px;
    background: #f9fafb;
}

.progress-bar {
    width: 100%;
    height: 24px;
    background: #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    transition: width 0.3s ease;
}

.progress-text {
    margin-top: 10px;
    text-align: center;
    font-size: 14px;
    color: #6b7280;
}

/* Checklist Sections */
.checklist-sections {
    padding: 20px;
}

.checklist-section {
    margin-bottom: 30px;
}

.checklist-section h3 {
    color: #374151;
    font-size: 18px;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e5e7eb;
}

/* Checklist Items */
.checklist-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.checklist-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px 16px;
    transition: all 0.2s ease;
}

.checklist-item:hover {
    border-color: #9ca3af;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.checklist-item.completed {
    background: #f0fdf4;
    border-color: #86efac;
}

.checklist-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    gap: 12px;
}

.checklist-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    cursor: pointer;
    flex-shrink: 0;
}

.item-label {
    flex: 1;
    font-size: 15px;
    color: #1f2937;
    line-height: 1.5;
}

.checklist-item.completed .item-label {
    color: #059669;
    text-decoration: line-through;
}

.required {
    color: #ef4444;
    font-weight: bold;
    margin-left: 4px;
}

.item-description {
    margin-left: 32px;
    margin-top: 6px;
    font-size: 13px;
    color: #6b7280;
    font-style: italic;
}

.item-meta {
    margin-left: 32px;
    margin-top: 6px;
    font-size: 12px;
    color: #10b981;
    font-weight: 500;
}

/* Modal Footer */
.discharge-checklist-modal .modal-footer {
    padding: 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Print Styles */
@media print {
    .discharge-checklist-modal {
        position: static;
        background: white;
    }
    
    .discharge-checklist-modal .modal-content {
        box-shadow: none;
        max-width: 100%;
    }
    
    .btn-close,
    .modal-footer button {
        display: none;
    }
    
    .checklist-item {
        break-inside: avoid;
    }
    
    .checklist-section {
        page-break-inside: avoid;
    }
}

/* Add discharge button to client cards */
.btn-discharge-checklist {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: transform 0.2s;
}

.btn-discharge-checklist:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}


/* Enhancement: missions-redesign.css */
/* Modern Missions Widget Redesign */

.missions-widget {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.25);
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
}

.missions-widget::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 60%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
}

/* Header Section */
.missions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    position: relative;
    z-index: 1;
}

.missions-title {
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    font-size: 24px;
    font-weight: 700;
}

.missions-title::before {
    content: 'üéØ';
    font-size: 28px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.missions-progress {
    display: flex;
    align-items: center;
    gap: 16px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    padding: 8px 16px;
    border-radius: 100px;
    color: white;
    font-weight: 600;
}

.progress-circles {
    display: flex;
    gap: 8px;
}

.progress-circle {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    background: transparent;
    transition: all 0.3s ease;
}

.progress-circle.completed {
    background: white;
    border-color: white;
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.4);
}

/* Mission Sections */
.mission-section {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.mission-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.mission-section.primary {
    border-left: 4px solid #ef4444;
}

.mission-section.secondary {
    border-left: 4px solid #f59e0b;
}

.mission-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.mission-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #1f2937;
    font-size: 16px;
}

.mission-label .icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.mission-section.primary .icon {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.mission-section.secondary .icon {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
}

.mission-time {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
}

/* Mission Items */
.mission-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px;
    border-radius: 12px;
    background: linear-gradient(135deg, #fafafa 0%, #f9fafb 100%);
    margin-bottom: 12px;
    transition: all 0.2s ease;
    position: relative;
}

.mission-item:hover {
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    transform: translateX(4px);
}

.mission-item.critical {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.mission-checkbox {
    position: relative;
}

.mission-checkbox input[type="checkbox"] {
    width: 24px;
    height: 24px;
    appearance: none;
    border: 2px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.mission-checkbox input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-color: #059669;
}

.mission-checkbox input[type="checkbox"]:checked::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 14px;
    font-weight: bold;
}

.mission-content {
    flex: 1;
}

.mission-client {
    display: inline-block;
    background: #1f2937;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 8px;
}

.mission-text {
    color: #4b5563;
    font-size: 15px;
    line-height: 1.4;
}

.mission-critical {
    display: inline-block;
    background: #ef4444;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    margin-left: 8px;
}

.mission-action {
    padding: 8px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.mission-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Quick Actions Bar */
.quick-actions {
    display: flex;
    gap: 12px;
    padding: 20px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    flex-wrap: wrap;
    justify-content: center;
}

.quick-action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 100px;
}

.quick-action-btn:hover {
    background: linear-gradient(135deg, white 0%, #f9fafb 100%);
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.quick-action-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.quick-action-label {
    font-size: 13px;
    color: #6b7280;
    font-weight: 600;
    text-align: center;
}

/* Animations */
@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

.missions-widget {
    animation: slideInFromTop 0.5s ease;
}

.mission-section {
    animation: slideInFromTop 0.5s ease;
    animation-fill-mode: both;
}

.mission-section:nth-child(2) {
    animation-delay: 0.1s;
}

.mission-section:nth-child(3) {
    animation-delay: 0.2s;
}

/* Empty State */
.missions-empty {
    text-align: center;
    padding: 40px;
    color: rgba(255, 255, 255, 0.9);
}

.missions-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.missions-empty-text {
    font-size: 18px;
    font-weight: 500;
}

/* Responsive Design */
@media (max-width: 768px) {
    .missions-widget {
        padding: 20px;
    }
    
    .missions-title {
        font-size: 20px;
    }
    
    .quick-actions {
        padding: 12px;
    }
    
    .quick-action-btn {
        min-width: 80px;
        padding: 12px 8px;
    }
}


/* Enhancement: morning-review.css */
/* Morning Review Dashboard Styles */

.morning-review-modal .modal-content {
    max-height: 90vh;
    overflow-y: auto;
    background: #f9fafb;
}

/* Morning Header */
.morning-header {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 30px;
    margin: -30px -30px 20px -30px;
    border-radius: 12px 12px 0 0;
}

.morning-greeting h2 {
    margin: 0;
    font-size: 32px;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.review-date {
    margin: 8px 0 0 0;
    font-size: 18px;
    opacity: 0.9;
}

.morning-header .btn-close {
    color: white;
    opacity: 0.8;
}

.morning-header .btn-close:hover {
    opacity: 1;
}

/* Review Content */
.review-content {
    padding: 0 20px 20px;
}

/* Morning Stats */
.morning-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
    transition: all 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.stat-card.alert {
    border-color: #ef4444;
    background: #fef2f2;
}

.stat-card.primary {
    border-color: #3b82f6;
    background: #eff6ff;
}

.stat-card.success {
    border-color: #10b981;
    background: #f0fdf4;
}

.stat-number {
    font-size: 36px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 8px;
}

.stat-card.alert .stat-number {
    color: #dc2626;
}

.stat-card.primary .stat-number {
    color: #2563eb;
}

.stat-card.success .stat-number {
    color: #059669;
}

.stat-label {
    font-size: 14px;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Daily Insights */
.daily-insights {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 30px;
}

.insight-banner {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    border-radius: 8px;
    font-size: 15px;
}

.insight-banner.critical {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    color: #991b1b;
    border-left: 4px solid #dc2626;
}

.insight-banner.warning {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    color: #92400e;
    border-left: 4px solid #f59e0b;
}

.insight-banner.efficiency {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    color: #075985;
    border-left: 4px solid #0284c7;
}

.insight-banner.reminder {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    color: #374151;
    border-left: 4px solid #6b7280;
}

.insight-banner.success {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    color: #14532d;
    border-left: 4px solid #22c55e;
}

.insight-icon {
    font-size: 20px;
    flex-shrink: 0;
}

/* Batch Actions */
.batch-actions-section {
    margin-bottom: 30px;
}

.batch-actions-section h3 {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    color: #1f2937;
}

.batch-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.batch-action-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 22px;
    transition: all 0.2s ease;
}

.batch-action-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.batch-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 13px;
    color: #6b7280;
}

.batch-count {
    background: #3b82f6;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
}

.batch-time {
    display: flex;
    align-items: center;
    gap: 4px;
}

.batch-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
}

.batch-clients {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 16px;
}

.btn-batch {
    width: 100%;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-batch:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Review Sections */
.review-sections {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.review-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.review-section h3 {
    margin: 0 0 16px 0;
    color: #1f2937;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.review-section.overdue {
    border-left: 4px solid #ef4444;
}

.review-section.today {
    border-left: 4px solid #3b82f6;
}

.review-section.upcoming {
    border-left: 4px solid #8b5cf6;
}

.review-section.followups {
    border-left: 4px solid #f59e0b;
}

.review-section.opportunities {
    border-left: 4px solid #10b981;
}

/* Task List */
.task-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.review-task-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 16px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
}

.review-task-item:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
}

.task-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.task-details {
    flex: 1;
}

.task-client {
    font-size: 13px;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 4px;
}

.task-name {
    font-size: 15px;
    color: #1f2937;
    font-weight: 500;
}

.task-overdue {
    font-size: 12px;
    color: #dc2626;
    margin-top: 4px;
    font-weight: 600;
}

.task-due {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
}

.btn-task-action {
    padding: 6px 12px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 13px;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-task-action:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

/* Follow-up List */
.followup-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.followup-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.followup-client {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
}

.followup-options {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.option-tag {
    background: #fef3c7;
    color: #92400e;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.btn-followup {
    padding: 8px 16px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-followup:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

/* Opportunity List */
.opportunity-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.opportunity-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border-radius: 8px;
    border: 1px solid #86efac;
}

.opp-icon {
    font-size: 32px;
    flex-shrink: 0;
}

.opp-details {
    flex: 1;
}

.opp-message {
    font-weight: 600;
    color: #166534;
    margin-bottom: 4px;
}

.opp-benefit {
    font-size: 13px;
    color: #15803d;
}

.btn-opportunity {
    padding: 8px 20px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-opportunity:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* Morning Review Button */
.btn-morning-review {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
}

.btn-morning-review:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
    .morning-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .batch-actions-grid {
        grid-template-columns: 1fr;
    }
    
    .review-task-item {
        flex-wrap: wrap;
    }
    
    .task-details {
        flex: 1 0 100%;
    }
}

/* Print Styles */
@media print {
    .morning-review-modal {
        position: static;
        background: white;
    }
    
    .morning-header {
        color: black;
        background: none;
        border-bottom: 2px solid #000;
    }
    
    .btn-close,
    .modal-footer,
    .btn-batch,
    .btn-task-action,
    .btn-followup,
    .btn-opportunity {
        display: none;
    }
    
    .review-section {
        page-break-inside: avoid;
    }
}

        /* Clinician Workspace Auth Screen */
        .auth-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
            background:
                radial-gradient(circle at top left, rgba(255, 255, 255, 0.12), transparent 55%),
                radial-gradient(circle at bottom right, rgba(30, 64, 175, 0.4), transparent 55%),
                linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #0f172a;
        }

        .auth-orb {
            position: absolute;
            border-radius: 999px;
            filter: blur(40px);
            opacity: 0.75;
            pointer-events: none;
            animation: authOrbFloat 12s ease-in-out infinite;
        }

        .auth-orb--1 {
            width: 340px;
            height: 340px;
            top: -80px;
            left: -40px;
            background: radial-gradient(circle, rgba(248, 250, 252, 0.9), rgba(148, 163, 184, 0.1));
            animation-delay: -2s;
        }

        .auth-orb--2 {
            width: 260px;
            height: 260px;
            bottom: -40px;
            right: 12%;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.85), rgba(37, 99, 235, 0.1));
            animation-delay: -4s;
        }

        .auth-orb--3 {
            width: 220px;
            height: 220px;
            top: 18%;
            right: -60px;
            background: radial-gradient(circle, rgba(249, 115, 22, 0.85), rgba(126, 34, 206, 0.15));
            animation-delay: -6s;
        }

        @keyframes authOrbFloat {
            0%, 100% { transform: translate3d(0, 0, 0); }
            33% { transform: translate3d(18px, -10px, 0); }
            66% { transform: translate3d(-14px, 12px, 0); }
        }

        .auth-shell {
            position: relative;
            width: 100%;
            max-width: 1120px;
            min-height: 540px;
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
            gap: 32px;
            z-index: 1;
        }

        .auth-panel {
            position: relative;
            border-radius: 28px;
            backdrop-filter: blur(26px);
            -webkit-backdrop-filter: blur(26px);
        }

        .auth-panel--left {
            padding: 32px;
            background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.96), rgba(241, 245, 249, 0.94));
            box-shadow:
                0 24px 60px rgba(15, 23, 42, 0.30),
                0 0 0 1px rgba(226, 232, 240, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .auth-panel--right {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-brand {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 24px;
        }

        .auth-brand-text {
            flex: 1;
        }

        .auth-logo {
            width: 100px;
            height: 100px;
            margin-left: -12px;
            display: block;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            padding: 14px;
            object-fit: contain;
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(15, 23, 42, 0.12);
        }

        .auth-logo[alt] {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            text-align: center;
            color: #4b5563;
        }

        .auth-brand-parent {
            font-size: 14px;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 600;
        }

        .auth-brand-product {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.04em;
            color: #111827;
        }

        .auth-brand-org {
            margin-top: 4px;
            font-size: 14px;
            color: #4b5563;
        }

        .auth-title {
            margin: 24px 0 6px;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: #111827;
        }

        .auth-subtitle {
            margin: 0 0 18px;
            font-size: 14px;
            color: #4b5563;
            max-width: 420px;
        }

        .auth-bullets {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .auth-bullets li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 14px;
            color: #111827;
            margin-bottom: 12px;
        }

        .auth-bullets li::before {
            content: '‚Ä¢';
            color: #4f46e5;
            font-weight: 700;
            margin-top: 1px;
        }

        .auth-footnote {
            margin-top: 24px;
            padding-top: 18px;
            border-top: 1px solid rgba(209, 213, 219, 0.9);
        }

        .auth-footnote-main {
            font-size: 13px;
            color: #374151;
            margin: 0 0 4px;
        }

        .auth-footnote-sub {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }

        .auth-card {
            width: 100%;
            max-width: 420px;
            padding: 28px 26px;
            border-radius: 24px;
            background: rgba(248, 250, 252, 0.98);
            box-shadow:
                0 20px 45px rgba(15, 23, 42, 0.40),
                0 0 0 1px rgba(226, 232, 240, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .auth-card-header h2 {
            margin: 0 0 6px;
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .auth-card-header p {
            margin: 0;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .auth-form {
            margin-top: 20px;
        }

        .auth-alert {
            display: none;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(254, 215, 215, 0.8);
            color: #9b2c2c;
            border: 1px solid rgba(252, 165, 165, 0.8);
            font-size: 13px;
            margin-bottom: 16px;
        }

        .auth-field {
            margin-bottom: 16px;
        }

        .auth-field label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .auth-field input {
            width: 100%;
            padding: 11px 12px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            background: #ffffff;
            color: #111827;
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
        }

        .auth-field input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.16);
        }

        .auth-form-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin: 2px 0 18px;
        }

        .auth-remember {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #4b5563;
        }

        .auth-remember input {
            width: 16px;
            height: 16px;
            accent-color: #4f46e5;
        }

        .auth-link {
            border: none;
            background: none;
            padding: 0;
            font-size: 12px;
            color: #4f46e5;
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-submit-btn {
            width: 100%;
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #f9fafb;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 12px 30px rgba(79, 70, 229, 0.40);
            transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
        }

        .auth-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 40px rgba(79, 70, 229, 0.50);
            filter: brightness(1.03);
        }

        .auth-submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 10px 24px rgba(79, 70, 229, 0.35);
        }

        .auth-small-print {
            font-size: 11px;
            color: #6b7280;
            line-height: 1.45;
            margin: 0 0 12px;
        }

        .auth-support {
            margin-top: 14px;
            padding-top: 12px;
            border-top: 1px dashed rgba(209, 213, 219, 0.9);
        }

        .auth-support-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .auth-support p {
            margin: 0;
            font-size: 12px;
            color: #6b7280;
            line-height: 1.6;
        }

        @media (max-width: 960px) {
            .auth-shell {
                grid-template-columns: minmax(0, 1fr);
                max-width: 560px;
                gap: 20px;
            }

            .auth-panel--left {
                padding: 26px 24px;
                border-radius: 24px;
            }

            .auth-panel--right {
                justify-content: stretch;
            }

            .auth-card {
                margin: 0 auto;
            }
        }

        @media (max-width: 640px) {
            .auth-screen {
                padding: 18px;
            }

            .auth-panel--left {
                padding: 22px 20px;
                border-radius: 22px;
            }

            .auth-card {
                border-radius: 20px;
                padding: 22px 20px;
            }

            .auth-brand-product {
                font-size: 26px;
            }

            .auth-title {
                font-size: 22px;
            }

            .auth-form-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .auth-link {
                align-self: flex-start;
            }
        }

</style>
    <style>
        .programs-docs-loader,
        .programs-docs-error {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(110, 123, 255, 0.2);
            background: rgba(233, 236, 255, 0.55);
            color: #151633;
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .programs-docs-loader .loader-spinner {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid rgba(110, 123, 255, 0.3);
            border-top-color: #6E7BFF;
            animation: programsDocsSpin 0.9s linear infinite;
        }

        .programs-docs-error {
            flex-direction: column;
            align-items: flex-start;
            background: rgba(255, 245, 245, 0.85);
            border: 1px solid rgba(221, 72, 72, 0.35);
        }

        .programs-docs-error h3 {
            margin: 0;
            font-size: 16px;
            color: #b42318;
        }

        .programs-docs-error p {
            margin: 4px 0 12px 0;
            color: #7a271a;
            font-size: 14px;
        }

        .programs-docs-error-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        body.programs-docs-v2-active {
            overflow-x: hidden;
        }
        
        body.programs-docs-v2-active #mainApp {
            padding: 0 !important;
        }
        
        .programs-docs-container {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - var(--programs-header-height, 180px));
            position: relative;
            overflow: visible;
        }
        
        /* Ensure Programs tab takes full space */
        #programsTab.tab-content {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - var(--programs-header-height, 180px));
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        
        #programsTab.tab-content.active {
            display: flex !important;
        }
        
        /* Hide legacy elements when module is loaded */
        body.programs-docs-v2-active .legacy-programs-wrapper,
        body.programs-docs-v2-active #programsDocsError,
        body.programs-docs-v2-active #programsDocsLoader {
            display: none !important;
        }
        
        /* Make sure the module content fills the container */
        .programs-docs-container > * {
            width: 100%;
            height: 100%;
        }
        
        /* When module is loaded, ensure its root elements take full space */
        body.programs-docs-v2-active #programsDocsContainer,
        body.programs-docs-v2-active #programsDocsContainer > body,
        body.programs-docs-v2-active #programsDocsContainer > html {
            width: 100% !important;
            height: 100% !important;
            min-height: calc(100vh - var(--programs-header-height, 180px)) !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Ensure the module's workspace takes full space */
        body.programs-docs-v2-active .workspace,
        body.programs-docs-v2-active .three-pane-layout,
        body.programs-docs-v2-active [class*="workspace"] {
            width: 100% !important;
            height: 100% !important;
            min-height: calc(100vh - var(--programs-header-height, 180px)) !important;
        }
        
        /* Remove any max-width constraints */
        body.programs-docs-v2-active #programsDocsContainer * {
            max-width: none !important;
        }
        
        /* Ensure tab content area doesn't constrain */
        body.programs-docs-v2-active #programsTab {
            max-width: 100% !important;
            overflow: visible !important;
        }
        
        /* Stretch the outer container to full viewport */
        body.programs-docs-v2-active .container {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: clamp(16px, 2.5vw, 44px) clamp(16px, 2.5vw, 56px) !important;
            border-radius: 0 !important;
            min-height: 100vh !important;
            box-shadow: none !important;
            background: transparent !important;
        }
        
        /* Apply purple gradient background to html and body when Programs & Docs is active */
        html.programs-docs-v2-active,
        body.programs-docs-v2-active {
            position: relative !important;
            background:
                radial-gradient(circle at 12% 18%, rgba(203, 207, 255, 0.35), transparent 45%),
                radial-gradient(circle at 88% 8%, rgba(110, 123, 255, 0.22), transparent 52%),
                linear-gradient(145deg, #ffffff 0%, #F3F4FF 100%) !important;
            min-height: 100vh !important;
        }
        
        html.programs-docs-v2-active::before,
        body.programs-docs-v2-active::before {
            content: "" !important;
            position: fixed !important;
            inset: 0 !important;
            pointer-events: none !important;
            background: radial-gradient(circle at 20% 70%, rgba(110, 123, 255, 0.08), transparent 60%) !important;
            z-index: -1 !important;
        }
        
        /* Ensure #mainApp is transparent */
        body.programs-docs-v2-active #mainApp {
            padding: 0 !important;
            background: transparent !important;
        }
        
        body.programs-docs-v2-active .main-content {
            max-width: 100% !important;
            border-radius: 24px !important;
        }
        
        body.programs-docs-v2-active .main-content {
            padding: clamp(16px, 2vw, 36px) !important;
            grid-template-columns: 1fr !important; /* Override grid layout */
            background: transparent !important;
        }
        
        /* Override module's fixed layout */
        body.programs-docs-v2-active .app-shell {
            max-width: 100% !important;
            width: 100% !important;
            margin: 0 !important;
            padding-left: clamp(16px, 2vw, 32px) !important;
            padding-right: clamp(16px, 2vw, 32px) !important;
            padding-top: 32px !important;
            padding-bottom: 80px !important;
            grid-template-columns: minmax(200px, 1fr) minmax(400px, 3fr) minmax(250px, 1fr) !important;
            gap: clamp(16px, 2vw, 24px) !important;
        }
        
        /* Make panes responsive and semi-transparent to show gradient */
        body.programs-docs-v2-active .pane {
            width: 100% !important;
            box-sizing: border-box !important;
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        /* Dynamic height calculation */
        body.programs-docs-v2-active #programsDocsContainer {
            height: calc(100vh - var(--programs-header-height, 180px)) !important;
        }
        
        /* Ultra-wide screens (>2000px) */
        @media (min-width: 2000px) {
            body.programs-docs-v2-active .app-shell {
                grid-template-columns: minmax(300px, 0.18fr) minmax(600px, 1fr) minmax(350px, 0.22fr) !important;
                padding-left: 3vw !important;
                padding-right: 3vw !important;
            }
        }
        
        /* Standard desktop (1400px - 2000px) */
        @media (min-width: 1400px) and (max-width: 2000px) {
            body.programs-docs-v2-active .app-shell {
                grid-template-columns: minmax(260px, 0.2fr) minmax(500px, 1fr) minmax(320px, 0.24fr) !important;
            }
        }
        
        /* Tablet/small desktop (<1400px) */
        @media (max-width: 1400px) {
            body.programs-docs-v2-active .app-shell {
                grid-template-columns: minmax(240px, 0.22fr) minmax(400px, 1fr) minmax(280px, 0.26fr) !important;
            }
        }
        
        /* Remove fixed padding from body and containers */
        body.programs-docs-v2-active {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Override programs panel constraints */
        body.programs-docs-v2-active .programs-panel {
            max-width: 100% !important;
            width: 100% !important;
        }
        
        /* Ensure selection panel doesn't interfere */
        body.programs-docs-v2-active .selection-panel {
            display: none !important;
        }
        
        body.programs-docs-v2-active .app-footer {
            max-width: 100% !important;
            margin: 0 !important;
            padding-left: 2vw !important;
            padding-right: 2vw !important;
        }
        
        /* Ensure toolbar stretches full width and reduce height significantly */
        body.programs-docs-v2-active .toolbar {
            width: 100% !important;
            max-width: 100% !important;
            left: 0 !important;
            right: 0 !important;
            margin: 0 !important;
            padding: 8px clamp(16px, 2vw, 28px) !important;
            min-height: auto !important;
            height: auto !important;
        }
        
        /* Reduce toolbar brand icon size */
        body.programs-docs-v2-active .toolbar__brand span {
            width: 28px !important;
            height: 28px !important;
            font-size: 0.75rem !important;
        }
        
        /* Reduce toolbar brand text size */
        body.programs-docs-v2-active .toolbar__brand {
            font-size: 0.85rem !important;
            gap: 8px !important;
        }
        
        /* Reduce search bar height */
        body.programs-docs-v2-active .toolbar__search label {
            padding: 6px 14px !important;
            min-height: auto !important;
        }
        
        /* Reduce search input size */
        body.programs-docs-v2-active .toolbar__search input {
            font-size: 0.875rem !important;
            padding: 0 !important;
        }
        
        /* Reduce toolbar action buttons */
        body.programs-docs-v2-active .toolbar__actions {
            gap: 8px !important;
        }
        
        body.programs-docs-v2-active .toolbar__document-toggle-btn,
        body.programs-docs-v2-active .toolbar__actions button {
            padding: 6px 12px !important;
            font-size: 0.8rem !important;
            min-height: auto !important;
            height: auto !important;
        }

        .legacy-programs-wrapper {
            margin-top: 24px;
        }

        .legacy-programs-notice {
            padding: 20px;
            border: 1px dashed rgba(110, 123, 255, 0.35);
            border-radius: 16px;
            background: white;
            color: #48508A;
        }

        .legacy-programs-notice h4 {
            margin: 0 0 8px 0;
            color: #0F1020;
            font-size: 16px;
        }

        .legacy-programs-notice p {
            margin: 0;
            font-size: 14px;
        }

        .legacy-programs-fallback {
            margin-top: 16px;
            border: 1px solid rgba(110, 123, 255, 0.18);
            border-radius: 18px;
            background: rgba(233, 236, 255, 0.25);
            box-shadow: 0 12px 32px rgba(15, 16, 32, 0.08);
            overflow: hidden;
        }

        .legacy-programs-frame {
            width: 100%;
            min-height: 720px;
            border: 0;
            background: white;
        }

        .legacy-programs-disclaimer {
            margin: 0;
            padding: 12px 18px 16px;
            font-size: 13px;
            color: #48508A;
            background: rgba(233, 236, 255, 0.65);
            border-top: 1px solid rgba(110, 123, 255, 0.18);
        }

        body.programs-docs-v2-active .selection-panel {
            display: none !important;
        }

        @keyframes programsDocsSpin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- Client Tracking JavaScript -->
    <script>
        // CM Tracker Functions
        let currentHouseId = 'house_nest';
        let currentClientFilter = 'active';
        let cmTrackerInitialized = false;
        
        // Initialize CM Tracker
        async function initializeCMTracker() {
            try {
                // Check if managers are available
                if (!window.dbManager) {
                    console.error('DBManager not available for CM Tracker');
                    return;
                }
                
                // Initialize houses manager
                if (!window.housesManager) {
                    window.housesManager = new HousesManager(window.dbManager);
                    await window.housesManager.initialize();
                }
                housesManager = window.housesManager;
                
                // Initialize milestones manager
                if (!window.milestonesManager) {
                    window.milestonesManager = new MilestonesManager(window.dbManager);
                }
                milestonesManager = window.milestonesManager;
                
                // Initialize aftercare manager
                if (!window.aftercareManager) {
                    window.aftercareManager = new AftercareManager(window.dbManager);
                }
                aftercareManager = window.aftercareManager;
                
                // Initialize houses in database
                await window.dbManager.initializeHouses();
                
                // Build house navigation
                await buildHouseNavigation();
                
                // Load initial house
                await loadHouseView(currentHouseId);
                
                cmTrackerInitialized = true;
                console.log('‚úÖ CM Tracker initialized');
            } catch (error) {
                console.error('Failed to initialize CM Tracker:', error);
            }
        }
        
        // Build house navigation tabs
        async function buildHouseNavigation() {
            const houseTabs = document.getElementById('houseTabs');
            if (!houseTabs) return;
            
            houseTabs.innerHTML = '';
            
            // Get houses
            const houses = await housesManager.getActiveHouses();
            
            // Create tabs for each house
            for (let i = 0; i < houses.length; i++) {
                const house = houses[i];
                const clientCount = await housesManager.getClientCount(house.id, true);
                
                const tab = document.createElement('button');
                tab.className = 'house-tab';
                if (i === 0) tab.className += ' active'; // First house is active by default
                tab.id = `houseTab_${house.id}`;
                tab.onclick = () => switchToHouse(house.id);
                
                tab.innerHTML = `
                    ${house.name}
                    <span class="client-count">${clientCount}</span>
                `;
                
                houseTabs.appendChild(tab);
            }
            
            // Add discharged clients tab
            const dischargedCount = await getDischargedClientsCount();
            const dischargedTab = document.createElement('button');
            dischargedTab.className = 'house-tab';
            dischargedTab.id = 'houseTab_discharged';
            dischargedTab.onclick = () => switchToHouse('discharged');
            dischargedTab.innerHTML = `
                Discharged
                <span class="client-count">${dischargedCount}</span>
            `;
            houseTabs.appendChild(dischargedTab);
        }
        
        // Get discharged clients count
        async function getDischargedClientsCount() {
            if (!window.clientManager) return 0;
            const discharged = await window.clientManager.getDischargedClients();
            return discharged.length;
        }
        
        // Switch to a house
        async function switchToHouse(houseId) {
            currentHouseId = houseId;
            
            // Update active tab
            document.querySelectorAll('.house-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.getElementById(`houseTab_${houseId}`);
            if (activeTab) activeTab.classList.add('active');
            
            // Load house view
            await loadHouseView(houseId);
        }
        
        // Load house view
        async function loadHouseView(houseId) {
            const container = document.getElementById('houseClientsList');
            if (!container) return;
            
            try {
                let clients;
                let houseName;
                
                if (houseId === 'discharged') {
                    clients = await window.clientManager.getDischargedClients();
                    houseName = 'Discharged Clients';
                } else {
                    const house = housesManager.getHouseById(houseId);
                    if (!house) return;
                    houseName = house.name;
                    clients = await window.clientManager.getClientsByHouse(houseId, currentClientFilter === 'active');
                }
                
                if (clients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üè†</div>
                            <div class="empty-state-title">No clients in ${houseName}</div>
                            <div class="empty-state-text">Click "Add Client" to add a new client to this house</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = await buildClientsTable(clients, houseName);
                }
            } catch (error) {
                console.error('Failed to load house view:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">Error loading clients</div>
                        <div class="empty-state-text">${error.message}</div>
                    </div>
                `;
            }
        }
        
        // Build clients table
        async function buildClientsTable(clients, houseName) {
            const table = document.createElement('div');
            table.className = 'clients-table-container';
            
            // Add export controls
            let tableHTML = `
                <div class="table-controls" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 14px; color: #6b7280;">
                        Showing ${clients.length} client${clients.length !== 1 ? 's' : ''} in ${houseName}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportCurrentView()" class="export-btn" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                            üìÑ Export to CSV
                        </button>
                        <button onclick="exportAllData()" class="export-btn" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                            üìä Export All Houses
                        </button>
                    </div>
                </div>
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Kipu ID</th>
                            <th>Days</th>
                            <th>Coach</th>
                            <th>CM</th>
                            <th>Thread</th>
                            <th>Options</th>
                            <th>Packet</th>
                            <th>Aftercare</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const client of clients) {
                const daysInCare = window.clientManager.calculateDaysInCare(client);
                
                // Apply CSS class based on days in care
                let daysClass = '';
                if (daysInCare === 13) {
                    daysClass = 'days-13';
                } else if (daysInCare === 14) {
                    daysClass = 'days-14';
                } else if (daysInCare >= 16) {
                    daysClass = 'days-16plus';
                }
                
                // Get milestones
                let milestones = [];
                try {
                    milestones = await milestonesManager.getClientMilestones(client.id);
                } catch (e) {
                    // Client may not have milestones initialized yet
                }
                
                // Get specific milestone statuses
                const threadMilestone = milestones.find(m => m.milestone === 'aftercare_thread');
                const optionsMilestone = milestones.find(m => m.milestone === 'options_doc');
                const packetMilestone = milestones.find(m => m.milestone === 'discharge_packet');
                
                const threadDisplay = threadMilestone 
                    ? milestonesManager.getMilestoneDisplayStatus(threadMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                    
                const optionsDisplay = optionsMilestone
                    ? milestonesManager.getMilestoneDisplayStatus(optionsMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                    
                const packetDisplay = packetMilestone
                    ? milestonesManager.getMilestoneDisplayStatus(packetMilestone, daysInCare)
                    : { icon: '‚è∏', class: 'pending', tooltip: 'Not Started' };
                
                // Get aftercare options
                let aftercareOptions = [];
                let aftercareDisplay = 'No options';
                try {
                    aftercareOptions = await aftercareManager.getClientAftercareOptions(client.id);
                    if (aftercareOptions.length > 0) {
                        const summary = aftercareManager.getAftercareSummary(aftercareOptions);
                        aftercareDisplay = summary.displayString;
                    }
                } catch (e) {
                    // Client may not have aftercare options yet
                }
                
                tableHTML += `
                    <tr>
                        <td><span class="client-initials" onclick="viewClientDetails('${client.id}')">${client.initials}</span></td>
                        <td>${client.kipuId}</td>
                        <td class="days-in-care ${daysClass}">${daysInCare}</td>
                        <td class="team-member">${client.clinicalCoachInitials || '-'}</td>
                        <td class="team-member">${client.caseManagerInitials || '-'}</td>
                        <td>
                            <span class="milestone-indicator ${threadDisplay.class}" 
                                  title="${threadDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'aftercare_thread')">
                                ${threadDisplay.icon}
                            </span>
                        </td>
                        <td>
                            <span class="milestone-indicator ${optionsDisplay.class}" 
                                  title="${optionsDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'options_doc')">
                                ${optionsDisplay.icon}
                            </span>
                        </td>
                        <td>
                            <span class="milestone-indicator ${packetDisplay.class}" 
                                  title="${packetDisplay.tooltip}"
                                  onclick="toggleMilestone('${client.id}', 'discharge_packet')">
                                ${packetDisplay.icon}
                            </span>
                        </td>
                        <td><span class="aftercare-status" style="font-size: 12px;">${aftercareDisplay}</span></td>
                        <td class="action-buttons">
                            <button class="action-btn" onclick="viewClientDetails('${client.id}')">View</button>
                            <button class="action-btn" onclick="editClient('${client.id}')">Edit</button>
                            <button class="action-btn" onclick="generateClientDocument('${client.id}')">Doc</button>
                        </td>
                    </tr>
                `;
            }
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            return tableHTML;
        }
        
        // Export current view to CSV
        async function exportCurrentView() {
            try {
                // Load export module if not already loaded
                if (!window.CMTrackerExport) {
                    const script = document.createElement('script');
                    script.src = 'cm-tracker-export.js';
                    document.head.appendChild(script);
                    
                    // Wait for script to load
                    await new Promise(resolve => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000); // Timeout fallback
                    });
                }
                
                // Initialize export module if not loaded
                if (!window.cmTrackerExport) {
                    window.cmTrackerExport = new CMTrackerExport();
                }
                
                // Export current house
                const options = {
                    houseId: currentHouseId === 'discharged' ? null : currentHouseId,
                    includeArchived: currentHouseId === 'discharged'
                };
                
                const result = await window.cmTrackerExport.exportToCSV(options);
                
                if (result.success) {
                    showAlert(`Exported ${result.rowCount - 1} clients successfully`, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                showAlert('Failed to export data: ' + error.message, 'error');
            }
        }
        
        // Export all data to CSV
        async function exportAllData() {
            try {
                // Load export module if not already loaded
                if (!window.CMTrackerExport) {
                    const script = document.createElement('script');
                    script.src = 'cm-tracker-export.js';
                    document.head.appendChild(script);
                    
                    // Wait for script to load
                    await new Promise(resolve => {
                        script.onload = resolve;
                        setTimeout(resolve, 2000); // Timeout fallback
                    });
                }
                
                // Initialize export module if not loaded
                if (!window.cmTrackerExport) {
                    window.cmTrackerExport = new CMTrackerExport();
                }
                
                // Export all houses
                const result = await window.cmTrackerExport.exportToCSV({
                    includeArchived: true
                });
                
                if (result.success) {
                    showAlert(`Exported ${result.rowCount - 1} clients successfully`, 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Export failed:', error);
                showAlert('Failed to export data: ' + error.message, 'error');
            }
        }
        
        // Ensure tab navigation is visible
        function ensureTabNavigationVisible() {
            return; // Disabled - using drawer navigation instead
            const tabNav = document.querySelector('.tab-navigation');
            if (!tabNav) {
                // Tab navigation doesn't exist, create it
                const programsPanel = document.querySelector('.programs-panel');
                if (programsPanel) {
                    const tabNavHTML = `
                        <div class="tab-navigation">
                            <button class="tab-btn" data-tab-target="dashboard" onclick="window.switchTab && window.switchTab('dashboard')">
                                <span>üéØ Dashboard</span>
                            </button>
                            <button class="tab-btn active" data-tab-target="programs" onclick="window.switchTab && window.switchTab('programs')">
                                <span>üìë Programs &amp; Docs</span>
                            </button>
                            <button class="tab-btn" data-tab-target="clients" onclick="window.switchTab && window.switchTab('clients')">
                                <span>üë• Clients</span>
                            </button>
                        </div>
                    `;
                    // Insert at the beginning of programs-panel
                    programsPanel.insertAdjacentHTML('afterbegin', tabNavHTML);
                    document.body.classList.add('tab-nav-fallback');
                    console.log('‚úÖ Tab navigation created dynamically');
                }
            } else {
                // Ensure fallback visibility is enabled
                document.body.classList.add('tab-nav-fallback');
                tabNav.style.display = '';
                tabNav.style.visibility = '';
                tabNav.style.zIndex = '';
                tabNav.style.position = '';
                console.log('‚úÖ Tab navigation fallback activated');
            }
        }
        
        // Initialize Client Tracker (for backward compatibility)
        function initializeClientTracker() {
            // Ensure tab navigation is visible first
            ensureTabNavigationVisible();
            
            // Initialize CM Tracker when client tab is opened
            if (!cmTrackerInitialized) {
                initializeCMTracker();
            }
        }
        
        // Manual initialization function
        async function initializeClientManagerManually() {
            try {
                console.log('Attempting manual ClientManager initialization...');
                
                // Check if dbManager exists, if not create it
                if (!window.dbManager) {
                    console.log('Creating IndexedDBManager...');
                    window.dbManager = new IndexedDBManager();
                    await window.dbManager.init();
                }
                
                // Create ClientManager
                console.log('Creating ClientManager...');
                window.clientManager = new ClientManager(window.dbManager);
                await window.clientManager.initialize();
                
                console.log('‚úÖ ClientManager manually initialized:', window.clientManager);
                
                // Initialize the UI
                initializeClientTracker();
                
                // Hide the warning
                const statusDiv = document.getElementById('clientManagerStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
                
                showAlert('Client manager initialized successfully!', 'success');
            } catch (error) {
                console.error('Failed to manually initialize ClientManager:', error);
                showAlert('Failed to initialize client manager: ' + error.message, 'error');
            }
        }
        
        // Handle client manager events
        function handleClientEvent(event, data) {
            switch (event) {
                case 'current-client-changed':
                    updateCurrentClientDisplay();
                    refreshSelectedPrograms();
                    break;
                case 'client-created':
                case 'client-updated':
                    refreshClientsList();
                    if (data.id === clientManager.getCurrentClient()?.id) {
                        updateCurrentClientDisplay();
                    }
                    break;
            }
        }
        
        // Module path - the module file is copied to dist as programs-docs-module.html during build
        // When served from dist/, use the same directory; when from root, use dist/ prefix
        const PROGRAMS_DOCS_MODULE_PATH = (() => {
            const pathname = (window.location.pathname || '').toLowerCase();
            const fileName = pathname.split('/').pop() || '';

            // If served from any packaged bundle (dist, CURRENT-VERSION-v12, etc.), keep module in same directory
            if (
                fileName.startsWith('careconnect-pro') ||
                pathname.includes('/dist/') ||
                pathname.includes('/current-version-v12/')
            ) {
                return 'programs-docs-module.html';
            }

            // Legacy fallback ‚Äì assume module lives under dist/
            return 'dist/programs-docs-module.html';
        })();
        let programsDocsLegacyNoticeShown = false;

        function shouldUseProgramsDocs() {
            try {
                if (window.featureFlags && typeof window.featureFlags.isEnabled === 'function') {
                    return window.featureFlags.isEnabled('programsV2Core') !== false;
                }
            } catch (error) {
                console.warn('Programs & Docs feature flag unavailable:', error);
            }
            // Default to true if feature flags not available
            return true;
        }
        
        // Make function globally available immediately
        window.shouldUseProgramsDocs = shouldUseProgramsDocs;

        async function mountProgramsDocsModule(forceReload = false) {
            const container = document.getElementById('programsDocsContainer');
            const loader = document.getElementById('programsDocsLoader');
            const errorEl = document.getElementById('programsDocsError');

            if (!container || !loader) {
                console.warn('Programs & Docs container missing from shell.');
                return false;
            }

            if (!shouldUseProgramsDocs()) {
                revealLegacyProgramsNotice('feature-disabled');
                return false;
            }

            if (window.__programsDocsMountPromise && !forceReload) {
                return window.__programsDocsMountPromise;
            }

            loader.hidden = false;
            if (errorEl) {
                errorEl.hidden = true;
            }
            container.hidden = true;

            const fetchUrl = forceReload
                ? `${PROGRAMS_DOCS_MODULE_PATH}?cacheBust=${Date.now()}`
                : PROGRAMS_DOCS_MODULE_PATH;

            console.log('[Programs & Docs] Loading module from:', fetchUrl);
            console.log('[Programs & Docs] Current pathname:', window.location.pathname);

            const mountPromise = (async () => {
                try {
                    let response = await fetch(fetchUrl, { cache: 'no-store' });
                    if (!response.ok) {
                        // Fallback: if root-level path fails with 404, try CURRENT-VERSION-v12/ prefix
                        const is404 = response.status === 404;
                        const isRootPath = !window.location.pathname.toLowerCase().includes('/current-version-v12/');
                        const isSimpleModulePath = PROGRAMS_DOCS_MODULE_PATH === 'programs-docs-module.html';
                        
                        if (is404 && isRootPath && isSimpleModulePath) {
                            const fallbackUrl = `CURRENT-VERSION-v12/programs-docs-module.html${forceReload ? `?cacheBust=${Date.now()}` : ''}`;
                            console.warn('[Programs & Docs] Primary module path not found, trying fallback:', fallbackUrl);
                            response = await fetch(fallbackUrl, { cache: 'no-store' });
                        }

                        if (!response.ok) {
                            if (response.status === 404) {
                                throw new Error(`Module not found at ${fetchUrl}. Please check the file path.`);
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                    }

                    const htmlText = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');

                    // Inject styles once
                    doc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                        const href = link.getAttribute('href');
                        if (!href) return;
                        if (document.querySelector(`link[data-programs-docs-style="true"][href="${href}"]`)) {
                            return;
                        }
                        const clone = link.cloneNode(true);
                        clone.dataset.programsDocsStyle = 'true';
                        document.head.appendChild(clone);
                    });

                    window.__programsDocsInlineStyles = window.__programsDocsInlineStyles || new Set();
                    doc.querySelectorAll('style').forEach(styleTag => {
                        const cssText = styleTag.textContent || '';
                        if (window.__programsDocsInlineStyles.has(cssText)) {
                            return;
                        }
                        const clone = styleTag.cloneNode(true);
                        clone.dataset.programsDocsStyle = 'true';
                        clone.dataset.programsDocsInline = 'true';
                        window.__programsDocsInlineStyles.add(cssText);
                        document.head.appendChild(clone);
                    });

                    container.innerHTML = doc.body.innerHTML;
                    container.hidden = false;
                    loader.hidden = true;
                    if (errorEl) {
                        errorEl.hidden = true;
                    }
                    document.body.classList.add('programs-docs-v2-active');
                    document.documentElement.classList.add('programs-docs-v2-active');
                    requestAnimationFrame(() => {
                        const toolbar = container.querySelector('.toolbar');
                        if (toolbar) {
                            const toolbarHeight = Math.round(toolbar.getBoundingClientRect().height);
                            document.documentElement.style.setProperty('--programs-header-height', `${toolbarHeight}px`);
                        }
                    });
                    
                    // Apply inline styles to override parent containers
                    const applyFullViewportStyles = () => {
                        // Apply clean white/gray background for modern look
                        // The purple gradient (legacy) has been removed as requested
                        const cleanBg = '#f8f9fa'; // Standard dashboard background
                        
                        document.documentElement.style.background = cleanBg;
                        document.documentElement.style.minHeight = '100vh';
                        document.body.style.background = cleanBg;
                        document.body.style.minHeight = '100vh';
                        
                        // Override .container
                        const outerContainer = document.querySelector('.container');
                        if (outerContainer) {
                            outerContainer.style.width = '100%';
                            outerContainer.style.maxWidth = '100%';
                            outerContainer.style.margin = '0';
                            outerContainer.style.padding = 'clamp(16px, 2.5vw, 44px) clamp(16px, 2.5vw, 56px)';
                            outerContainer.style.borderRadius = '0';
                            outerContainer.style.minHeight = '100vh';
                            outerContainer.style.boxShadow = 'none';
                            outerContainer.style.background = 'transparent';
                        }
                        
                        // Override .main-content - make it transparent
                        const mainContent = document.querySelector('.main-content');
                        if (mainContent) {
                            mainContent.style.gridTemplateColumns = '1fr';
                            mainContent.style.maxWidth = '100%';
                            mainContent.style.padding = 'clamp(16px, 2vw, 36px)';
                            mainContent.style.background = 'transparent';
                        }
                        
                        // Override #mainApp - make it transparent
                        const mainApp = document.getElementById('mainApp');
                        if (mainApp) {
                            mainApp.style.padding = '0';
                            mainApp.style.width = '100%';
                            mainApp.style.maxWidth = '100%';
                            mainApp.style.background = 'transparent';
                        }
                        
                        // Hide selection panel
                        const selectionPanel = document.querySelector('.selection-panel');
                        if (selectionPanel) {
                            selectionPanel.style.display = 'none';
                        }
                        
                        // Override programs panel
                        const programsPanel = document.querySelector('.programs-panel');
                        if (programsPanel) {
                            programsPanel.style.maxWidth = '100%';
                            programsPanel.style.width = '100%';
                        }
                        
                        // Override module's app-shell
                        const appShell = container.querySelector('.app-shell');
                        if (appShell) {
                            appShell.style.width = '100%';
                            appShell.style.maxWidth = '100%';
                            appShell.style.margin = '0';
                            appShell.style.paddingLeft = 'clamp(16px, 2vw, 32px)';
                            appShell.style.paddingRight = 'clamp(16px, 2vw, 32px)';
                        }
                        
                        // Make panes semi-transparent to show gradient
                        const panes = container.querySelectorAll('.pane');
                        panes.forEach(pane => {
                            pane.style.background = 'rgba(255, 255, 255, 0.85)';
                            pane.style.backdropFilter = 'blur(10px)';
                        });
                    };
                    
                    // Apply styles immediately
                    applyFullViewportStyles();
                    
                    // Ensure container takes full space
                    container.style.width = '100%';
                    container.style.height = '100%';
                    container.style.minHeight = 'calc(100vh - 200px)';
                    container.style.display = 'block';
                    
                    // Hide legacy wrapper if it exists
                    const legacyWrapper = document.getElementById('legacyProgramsWrapper');
                    if (legacyWrapper) {
                        legacyWrapper.hidden = true;
                        legacyWrapper.style.display = 'none';
                    }
                    
                    const adjustProgramsDocsLayout = () => {
                        // Re-apply full viewport styles
                        applyFullViewportStyles();
                        
                        const nav = document.querySelector('.tab-navigation');
                        let headerHeight = container.getBoundingClientRect().top;
                        if (headerHeight <= 0 && nav) {
                            headerHeight = nav.getBoundingClientRect().bottom;
                        }
                        if (!Number.isFinite(headerHeight) || headerHeight <= 0) {
                            headerHeight = 150;
                        }
                        headerHeight = Math.max(120, Math.round(headerHeight));
                        document.documentElement.style.setProperty('--programs-header-height', `${headerHeight}px`);
                        
                        const targetHeight = `calc(100vh - ${headerHeight}px)`;
                        container.style.height = targetHeight;
                        container.style.minHeight = targetHeight;
                        
                        const programsTab = document.getElementById('programsTab');
                        if (programsTab) {
                            programsTab.style.minHeight = targetHeight;
                        }
                        
                        const shell = container.querySelector('.app-shell');
                        if (shell) {
                            const viewportWidth = window.innerWidth;
                            if (viewportWidth > 1600) {
                                const scaleFactor = viewportWidth / 1600;
                                const gap = Math.min(56, Math.round(24 * scaleFactor));
                                shell.style.gap = `${gap}px`;
                            } else {
                                shell.style.removeProperty('gap');
                            }
                        }
                    };
                    
                    adjustProgramsDocsLayout();
                    
                    if (window.__programsDocsLayoutAdjuster) {
                        window.removeEventListener('resize', window.__programsDocsLayoutAdjuster);
                    }
                    window.__programsDocsLayoutAdjuster = () => adjustProgramsDocsLayout();
                    window.addEventListener('resize', window.__programsDocsLayoutAdjuster, { passive: true });
                    
                    if (window.__programsDocsResizeObserver instanceof ResizeObserver) {
                        window.__programsDocsResizeObserver.disconnect();
                    }
                    if (typeof ResizeObserver === 'function') {
                        window.__programsDocsResizeObserver = new ResizeObserver(() => adjustProgramsDocsLayout());
                        window.__programsDocsResizeObserver.observe(document.body);
                        window.__programsDocsResizeObserver.observe(container);
                    }

                    // Execute inline scripts sequentially
                    const scripts = Array.from(doc.querySelectorAll('script'));
                    for (const scriptNode of scripts) {
                        const scriptEl = document.createElement('script');
                        for (const attr of scriptNode.attributes) {
                            scriptEl.setAttribute(attr.name, attr.value);
                        }
                        if (scriptNode.src) {
                            scriptEl.src = scriptNode.src;
                        } else {
                            scriptEl.textContent = scriptNode.textContent;
                        }
                        scriptEl.dataset.programsDocsScript = 'true';
                        container.appendChild(scriptEl);

                        if (scriptEl.src) {
                            await new Promise((resolve, reject) => {
                                scriptEl.onload = resolve;
                                scriptEl.onerror = () => reject(new Error(`Failed to load ${scriptEl.src}`));
                            });
                        }
                    }

                    window.__programsDocsLoaded = true;
                    window.ccShell?.setSectionState?.('programs');
                    return true;
                } catch (error) {
                    console.error('Programs & Docs mount failure:', error);
                    console.error('Attempted to load from:', fetchUrl);
                    loader.hidden = true;
                    window.ccShell?.setSectionState?.('programs-error');
                    if (errorEl) {
                        errorEl.hidden = false;
                        const errorParagraph = errorEl.querySelector('p');
                        if (errorParagraph) {
                            const friendlyMessage = error.message.includes('404') || error.message.includes('not found')
                                ? 'Module file not found. Please ensure CareConnect-Pro.html is accessible.'
                                : `Failed to load module: ${error.message}`;
                            errorParagraph.textContent = friendlyMessage;
                        }
                    }
                    revealLegacyProgramsNotice('load-error');
                    // document.body.classList.remove('programs-docs-v2-active');
                    // document.documentElement.classList.remove('programs-docs-v2-active');
                    throw error;
                }
            })();

            window.__programsDocsMountPromise = mountPromise;
            return mountPromise;
        }
        // Make mount function globally available
        window.mountProgramsDocsModule = mountProgramsDocsModule;

        function retryProgramsDocsMount() {
            window.__programsDocsMountPromise = null;
            window.ccShell?.setSectionState?.('programs-loading');
            return mountProgramsDocsModule(true).catch(() => {});
        }
        
        // Make retry function globally available
        window.retryProgramsDocsMount = retryProgramsDocsMount;

        function toggleLegacyPrograms(show) {
            const wrapper = document.getElementById('legacyProgramsWrapper');
            if (!wrapper) return;
            if (show) {
                revealLegacyProgramsNotice('manual-request');
                initializeLegacyProgramsModule();
            } else {
                wrapper.hidden = true;
            }
        }

        function revealLegacyProgramsNotice(reason) {
            const wrapper = document.getElementById('legacyProgramsWrapper');
            const errorEl = document.getElementById('programsDocsError');
            if (!wrapper) return;

            if (!wrapper.dataset.rendered) {
                wrapper.innerHTML = `
                    <div class="legacy-programs-notice">
                        <h4>Legacy Programs experience</h4>
                        <p>The updated Programs &amp; Docs module is currently unavailable (${reason}). Disable the <code>programsV2Core</code> feature flag or contact support for assistance.</p>
                    </div>
                `;
                wrapper.dataset.rendered = 'true';
            }

            wrapper.hidden = false;
            if (errorEl) {
                errorEl.hidden = false;
            }
            programsDocsLegacyNoticeShown = true;
            // document.body.classList.remove('programs-docs-v2-active');
            // document.documentElement.classList.remove('programs-docs-v2-active');
            initializeLegacyProgramsModule();
        }

        // Legacy switchTab function removed - using the main one defined later in the file
        // This ensures all tab switching goes through the unified implementation
        
        // Quick add client
        async function quickAddClient() {
            // Check if clientManager is initialized
            if (!window.clientManager) {
                showAlert('Client manager is not ready. Please refresh the page.', 'error');
                console.error('ClientManager not initialized');
                return;
            }
            
            const initials = document.getElementById('newClientInitials').value.trim().toUpperCase();
            const kipuId = document.getElementById('newClientKipu').value.trim();
            
            if (!initials || !kipuId) {
                showAlert('Please enter both initials and Kipu ID', 'error');
                return;
            }
            
            try {
                const newClient = await window.clientManager.createClient({
                    initials,
                    kipuId
                });
                
                // Clear form
                document.getElementById('newClientInitials').value = '';
                document.getElementById('newClientKipu').value = '';
                
                // Set as current client
                await window.clientManager.setCurrentClient(newClient.id);
                
                showAlert(`Client ${initials} added successfully!`, 'success');
                refreshClientsList();
            } catch (error) {
                showAlert(error.message, 'error');
                console.error('Error creating client:', error);
            }
        }
        
        // Filter clients
        function filterClients(filter) {
            currentClientFilter = filter;
            
            // Update filter tabs
            document.querySelectorAll('.client-filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            refreshClientsList();
        }
        
        // Search clients
        let clientSearchTimeout;
        function searchClients(query) {
            clearTimeout(clientSearchTimeout);
            clientSearchTimeout = setTimeout(async () => {
                const results = await clientManager.searchClients(query);
                displayClients(results);
            }, 300);
        }
        
        // Refresh clients list - make globally available
        window.refreshClientsList = async function refreshClientsList() {
            // Check if old UI container exists (may not exist in CM Tracker view)
            const clientsContainer = document.getElementById('clientsList');
            if (!clientsContainer) {
                // Old UI doesn't exist, likely using CM Tracker
                return;
            }
            
            const allClients = await clientManager.getAllClients();
            let filteredClients = allClients;
            
            // Apply status filter
            if (currentClientFilter !== 'all') {
                filteredClients = allClients.filter(client => 
                    client.status === currentClientFilter
                );
            }
            
            // Apply search if active
            const searchBox = document.getElementById('clientSearchBox');
            if (searchBox) {
                const searchQuery = searchBox.value;
                if (searchQuery) {
                    const searchLower = searchQuery.toLowerCase();
                    filteredClients = filteredClients.filter(client => 
                        client.initials.toLowerCase().includes(searchLower) ||
                        client.kipuId.includes(searchQuery)
                    );
                }
            }
            
            displayClients(filteredClients);
        }
        
        // Display clients
        function displayClients(clients) {
            const container = document.getElementById('clientsList');
            
            // Check if old UI container exists (may not exist in CM Tracker view)
            if (!container) {
                // Old UI doesn't exist, likely using CM Tracker
                return;
            }
            
            if (!clients || clients.length === 0) {
                container.innerHTML = `
                    <div class="client-empty-state">
                        <div class="client-empty-icon">üë•</div>
                        <p>No clients found</p>
                    </div>
                `;
                return;
            }
            
            const currentClient = clientManager.getCurrentClient();
            
            container.innerHTML = clients.map(client => {
                const isSelected = currentClient?.id === client.id;
                const lastModified = new Date(client.lastModified).toLocaleDateString();
                const programCount = client.programHistory?.filter(p => p.status === 'selected').length || 0;
                
                return `
                    <div class="client-card ${isSelected ? 'selected' : ''}" 
                         onclick="selectClient('${client.id}')"
                         data-client-id="${client.id}">
                        <div class="client-card-avatar">${client.initials}</div>
                        <div class="client-card-info">
                            <div class="client-card-header">
                                <span class="client-card-name">${client.initials}</span>
                                <span class="client-status-badge ${client.status}">${client.status}</span>
                            </div>
                            <div class="client-card-kipu">Kipu ID: ${client.kipuId}</div>
                            <div class="client-card-meta">
                                <span>${programCount} programs</span>
                                <span>Modified: ${lastModified}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Select client
        async function selectClient(clientId) {
            await clientManager.setCurrentClient(clientId);
            refreshClientsList();
            updateCurrentClientDisplay();
            
            // If programs were selected for this client, restore them
            const clientPrograms = await clientManager.getClientPrograms(clientId);
            if (clientPrograms && clientPrograms.length > 0) {
                selectedPrograms = [...clientPrograms];
                updateSelectedPrograms();
                renderSelectedPrograms();
            }
        }
        
        // Update current client display
        function updateCurrentClientDisplay() {
            const client = clientManager.getCurrentClient();
            
            // Check if elements exist (may not exist in CM Tracker view)
            const avatarEl = document.getElementById('currentClientAvatar');
            const nameEl = document.getElementById('currentClientName');
            const kipuEl = document.getElementById('currentClientKipu');
            
            if (!avatarEl || !nameEl || !kipuEl) {
                // Old UI elements don't exist, likely using CM Tracker
                return;
            }
            
            if (!client) {
                avatarEl.textContent = '--';
                nameEl.textContent = 'No Client Selected';
                kipuEl.textContent = 'Select a client to begin';
                return;
            }
            
            avatarEl.textContent = client.initials;
            nameEl.textContent = `${client.initials} - ${client.status}`;
            kipuEl.textContent = `Kipu ID: ${client.kipuId}`;
        }
        
        // Edit current client
        function editCurrentClient() {
            const client = clientManager.getCurrentClient();
            if (!client) {
                showAlert('No client selected', 'error');
                return;
            }
            
            // Create edit dialog
            const newStatus = prompt(`Change status for ${client.initials}:\n1. active\n2. waitlist\n3. discharged`, client.status);
            
            if (newStatus && ['active', 'waitlist', 'discharged'].includes(newStatus)) {
                clientManager.updateClientStatus(client.id, newStatus).then(() => {
                    showAlert('Client status updated', 'success');
                    refreshClientsList();
                    updateCurrentClientDisplay();
                });
            }
        }
        
        // Clear current client
        function clearCurrentClient() {
            clientManager.setCurrentClient(null);
            updateCurrentClientDisplay();
            // Clear selected programs
            selectedPrograms = [];
            updateSelectedPrograms();
            renderSelectedPrograms();
        }
        
        // Override the original handleProgramClick to link with current client
        const originalHandleProgramClick = window.handleProgramClick;
        window.handleProgramClick = function(programId, isSubProgram = false, parentId = null) {
            // Call original function
            if (originalHandleProgramClick) {
                originalHandleProgramClick(programId, isSubProgram, parentId);
            }
            
            // Track program selection for current client if clientManager is available
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client) {
                    if (selectedPrograms.includes(programId)) {
                        clientManager.addProgramToClient(client.id, programId, {
                            isSubProgram,
                            parentId,
                            addedFrom: 'program-list'
                        });
                    } else {
                        clientManager.removeProgramFromClient(client.id, programId);
                    }
                }
            }
        };
        
        // Override generateDocument to track for current client
        const originalGenerateDocument = window.generateDocument;
        window.generateDocument = function() {
            // Track for current client if clientManager is available
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client && selectedPrograms.length > 0) {
                    // Track document generation
                    clientManager.addDocumentRecord(client.id, {
                        type: documentType,
                        programIds: [...selectedPrograms],
                        settings: {
                            includeAtHome,
                            includeAlumni
                        },
                        fileName: `CareConnect_${client.initials}_${new Date().toISOString().split('T')[0]}.docx`
                    });
                }
            }
            
            // Call original function
            if (originalGenerateDocument) {
                return originalGenerateDocument();
            }
        };
        
        // Helper function to show alerts
        function showAlert(message, type = 'info') {
            // You can customize this to use your preferred notification system
            const alertClass = type === 'error' ? 'error-alert' : 'success-alert';
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.textContent = message;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'error' ? '#ef4444' : '#10b981'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // Export client data
        async function exportClientData() {
            try {
                const clients = await clientManager.getAllClients();
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    clients: clients
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `clients-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showAlert(`Exported ${clients.length} clients`, 'success');
            } catch (error) {
                showAlert('Failed to export clients', 'error');
                console.error(error);
            }
        }
        
        // Import client data
        async function importClientData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.clients || !Array.isArray(data.clients)) {
                        throw new Error('Invalid client data format');
                    }
                    
                    let imported = 0;
                    for (const client of data.clients) {
                        try {
                            await clientManager.importClient(client);
                            imported++;
                        } catch (err) {
                            console.warn(`Failed to import client ${client.initials}:`, err);
                        }
                    }
                    
                    await refreshClientsList();
                    showAlert(`Imported ${imported} clients`, 'success');
                } catch (error) {
                    showAlert('Failed to import clients', 'error');
                    console.error(error);
                }
            };
            
            input.click();
        }
        
        // Toggle recent clients dropdown
        function toggleRecentClients() {
            const dropdown = document.getElementById('recentClientsDropdown');
            if (dropdown.style.display === 'none') {
                loadRecentClients();
                dropdown.style.display = 'block';
                // Close on click outside
                setTimeout(() => {
                    document.addEventListener('click', closeRecentClientsOnClickOutside);
                }, 100);
            } else {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeRecentClientsOnClickOutside);
            }
        }
        
        // Close dropdown on click outside
        function closeRecentClientsOnClickOutside(e) {
            const dropdown = document.getElementById('recentClientsDropdown');
            if (!dropdown.contains(e.target) && !e.target.closest('button[onclick*="toggleRecentClients"]')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeRecentClientsOnClickOutside);
            }
        }
        
        // Load recent clients
        async function loadRecentClients() {
            const dropdown = document.getElementById('recentClientsDropdown');
            
            // Check if clientManager exists
            if (!window.clientManager) {
                dropdown.innerHTML = `
                    <div style="padding: 12px; color: #6b7280; text-align: center;">
                        Client manager not initialized yet
                    </div>
                `;
                return;
            }
            
            const recentClients = await clientManager.getRecentClients(5);
            const currentClient = clientManager.getCurrentClient();
            
            if (recentClients.length === 0) {
                dropdown.innerHTML = `
                    <div style="padding: 12px; color: #6b7280; text-align: center;">
                        No recent clients
                    </div>
                `;
                return;
            }
            
            dropdown.innerHTML = recentClients.map(client => {
                const isActive = currentClient?.id === client.id;
                const programCount = client.programHistory?.filter(p => p.status === 'selected').length || 0;
                return `
                    <div onclick="quickSelectClient('${client.id}')" 
                         style="padding: 10px; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: background 0.2s; ${isActive ? 'background: #ede9fe;' : ''}"
                         onmouseover="this.style.background='#f3f4f6'" 
                         onmouseout="this.style.background='${isActive ? '#ede9fe' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #1f2937;">${client.initials}</strong>
                                <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Kipu: ${client.kipuId}</span>
                            </div>
                            <span style="background: ${client.status === 'active' ? '#d1fae5' : client.status === 'waitlist' ? '#fef3c7' : '#f3f4f6'}; 
                                         color: ${client.status === 'active' ? '#065f46' : client.status === 'waitlist' ? '#92400e' : '#6b7280'}; 
                                         padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${client.status}
                            </span>
                        </div>
                        <div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">
                            ${programCount} programs ‚Ä¢ Last modified: ${new Date(client.lastModified).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Quick select client from dropdown
        async function quickSelectClient(clientId) {
            if (!window.clientManager) {
                showAlert('Client manager not ready yet', 'error');
                return;
            }
            
            await selectClient(clientId);
            document.getElementById('recentClientsDropdown').style.display = 'none';
            document.removeEventListener('click', closeRecentClientsOnClickOutside);
            
            // Update current client indicator
            const currentClient = clientManager.getCurrentClient();
            const button = document.querySelector('button[onclick*="toggleRecentClients"]');
            if (currentClient && button) {
                button.innerHTML = `‚ö° ${currentClient.initials} (${currentClient.kipuId}) ‚ñº`;
            }
        }
        
        // Manage favorite programs
        function manageFavorites() {
            const favorites = JSON.parse(localStorage.getItem('favoritePrograms') || '[]');
            
            // Create a modal for managing favorites
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                z-index: 10001;
                max-width: 600px;
                width: 90%;
                max-height: 70vh;
                overflow-y: auto;
            `;
            modal.classList.add('floating-modal');
            
            modal.innerHTML = `
                <h3 style="margin-top: 0;">‚≠ê Manage Favorite Programs</h3>
                <p style="color: #6b7280; font-size: 14px;">Select programs to add to favorites for quick access:</p>
                <div id="favoritesSelection" style="margin: 20px 0;">
                    ${programs.slice(0, 20).map(program => `
                        <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="checkbox" value="${program.id}" 
                                   ${favorites.includes(program.id) ? 'checked' : ''} 
                                   style="margin-right: 8px;">
                            ${program.name}
                        </label>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="window.closeModal()" 
                            style="padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveFavorites()" 
                            style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Save Favorites
                    </button>
                </div>
            `;
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop';
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
            `;
            backdrop.onclick = () => window.closeModal();
            
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }
        
        // Save favorite programs
        function saveFavorites() {
            const checkboxes = document.querySelectorAll('#favoritesSelection input[type="checkbox"]');
            const favorites = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    favorites.push(checkbox.value);
                }
            });
            
            localStorage.setItem('favoritePrograms', JSON.stringify(favorites));
            loadFavoritePrograms();
            
            // Close modal
            window.closeModal();
            
            showAlert('Favorites saved!', 'success');
        }
        
        // Load favorite programs
        function loadFavoritePrograms() {
            const favorites = JSON.parse(localStorage.getItem('favoritePrograms') || '[]');
            const container = document.getElementById('favoritePrograms');
            const list = document.getElementById('favoriteProgramsList');
            
            if (!container || !list) {
                return; // Elements don't exist, skip
            }
            
            if (favorites.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = favorites.map(programId => {
                const program = programs.find(p => p.id === programId);
                if (!program) return '';
                
                const isSelected = selectedPrograms.includes(programId);
                return `
                    <button onclick="toggleFavoriteProgram('${programId}')" 
                            style="padding: 6px 12px; 
                                   background: ${isSelected ? '#065f46' : '#f59e0b'}; 
                                   color: white; 
                                   border: none; 
                                   border-radius: 4px; 
                                   cursor: pointer; 
                                   font-size: 12px;
                                   transition: all 0.2s;">
                        ${isSelected ? '‚úì' : '+'} ${program.name}
                    </button>
                `;
            }).join('');
        }
        
        // Toggle favorite program
        function toggleFavoriteProgram(programId) {
            if (selectedPrograms.includes(programId)) {
                // Remove if already selected
                const index = selectedPrograms.indexOf(programId);
                selectedPrograms.splice(index, 1);
            } else {
                // Add to selection
                selectedPrograms.push(programId);
            }
            
            updateSelectedPrograms();
            renderSelectedPrograms();
            loadFavoritePrograms(); // Refresh the favorites display
            
            // Track for current client
            if (window.clientManager) {
                const client = clientManager.getCurrentClient();
                if (client) {
                    if (selectedPrograms.includes(programId)) {
                        clientManager.addProgramToClient(client.id, programId, { addedFrom: 'favorites' });
                    } else {
                        clientManager.removeProgramFromClient(client.id, programId);
                    }
                }
            }
        }
        
        // Initialize workflow features on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure tab navigation is visible immediately
            ensureTabNavigationVisible();
            
            setTimeout(() => {
                loadFavoritePrograms();
                
                // Ensure tab navigation is still visible after delay
                ensureTabNavigationVisible();
                
                // Check if clientManager is initialized
                if (!window.clientManager) {
                    console.warn('ClientManager not initialized after 2 seconds');
                    // Show warning if on clients tab
                    const clientsTab = document.getElementById('clientsTab');
                    if (clientsTab && clientsTab.classList.contains('active')) {
                        const statusDiv = document.getElementById('clientManagerStatus');
                        if (statusDiv) {
                            statusDiv.style.display = 'block';
                        }
                    }
                } else {
                    console.log('ClientManager is available:', window.clientManager);
                    // Update recent clients button with current client if any
                    const currentClient = clientManager.getCurrentClient();
                    if (currentClient) {
                        const button = document.querySelector('button[onclick*="toggleRecentClients"]');
                        if (button) {
                            button.innerHTML = `‚ö° ${currentClient.initials} (${currentClient.kipuId}) ‚ñº`;
                        }
                    }
                }
            }, 2000); // Increased timeout to ensure clientManager is initialized
        });
        // CM Tracker Functions
        // Show add client modal - make globally available
        window.showAddClientModal = async function showAddClientModal() {
            const houses = await housesManager.getActiveHouses();
            const currentHouse = houses.find(h => h.id === currentHouseId) || houses[0];
            
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <h3>Add New Client</h3>
                        <form id="addClientForm" onsubmit="handleAddClient(event)">
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>Client Initials *</label>
                                    <input type="text" name="initials" maxlength="4" required 
                                           style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Kipu ID *</label>
                                    <input type="text" name="kipuId" required style="width: 100%;">
                                </div>
                                <div>
                                    <label>House *</label>
                                    <select name="houseId" required style="width: 100%;">
                                        ${houses.map(h => `
                                            <option value="${h.id}" ${h.id === currentHouse.id ? 'selected' : ''}>
                                                ${h.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label>Admission Date</label>
                                    <input type="date" name="admissionDate" style="width: 100%;">
                                </div>
                                <div>
                                    <label>Clinical Coach</label>
                                    <input type="text" name="clinicalCoachInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Case Manager</label>
                                    <input type="text" name="caseManagerInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                                <div>
                                    <label>Primary Therapist</label>
                                    <input type="text" name="primaryTherapistInitials" maxlength="4" 
                                           placeholder="Initials" style="text-transform: uppercase; width: 100%;">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                                <button type="button" onclick="window.closeModal()" 
                                        style="padding: 10px 20px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Add Client
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add keyboard listener for ESC key
            document.addEventListener('keydown', handleModalKeydown);
            
            // Fix overlay click handling
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeModal();
                    }
                });
            }
        }
        
        // Handle add client form submission
        async function handleAddClient(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
                const clientData = {
                initials: formData.get('initials'),
                kipuId: formData.get('kipuId'),
                houseId: formData.get('houseId'),
                admissionDate: formData.get('admissionDate') || new Date().toISOString().split('T')[0],  // Default to today if not provided
                clinicalCoachInitials: formData.get('clinicalCoachInitials') || '',
                caseManagerInitials: formData.get('caseManagerInitials') || '',
                primaryTherapistInitials: formData.get('primaryTherapistInitials') || '',
                status: 'active'  // Explicitly set active status
            };
            
            try {
                const newClient = await window.clientManager.createClient(clientData);
                
                // Initialize milestones for the new client
                await milestonesManager.initializeClientMilestones(newClient.id);
                
                showAlert('Client added successfully!', 'success');
                closeModal();
                await loadHouseView(currentHouseId);
                await buildHouseNavigation(); // Update counts
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        // View client details with modern design
        // NOTE: Accepts either a client ID (string) or a full client object
        async function viewClientDetails(clientOrId) {
            try {
                let clientId = null;
                let client = null;
                
                // Support being called with either an ID or a client object
                if (typeof clientOrId === 'string') {
                    clientId = clientOrId;
                } else if (clientOrId && typeof clientOrId === 'object') {
                    clientId = clientOrId.id;
                    client = clientOrId;
                }
                
                // Guard against invalid IDs (prevents IndexedDB DataError)
                if (!clientId) {
                    console.error('viewClientDetails called without a valid clientId:', clientOrId);
                    showAlert('Client not found', 'error');
                    return;
                }
                
                // Load client from ClientManager if we weren't given the full object
                if (!client) {
                    client = await window.clientManager.getClient(clientId);
                }
                
                if (!client) {
                    showAlert('Client not found', 'error');
                    return;
                }
                
                // Get related data
                const house = housesManager.getHouseById(client.houseId);
                const milestones = await milestonesManager.getClientMilestones(client.id);
                const aftercareOptions = await aftercareManager.getClientAftercareOptions(client.id);
                const daysInCare = window.clientManager.calculateDaysInCare(client);
                const hoursElapsed = window.clientManager.calculateHoursElapsed(client);
                
                console.log('Debug - Days in care calculation:', {
                    clientInitials: client.initials,
                    admissionDate: client.admissionDate, 
                    daysInCare: daysInCare
                });
                
                // Calculate completion percentages based on tracking fields
                const trackingFields = [
                    'needsAssessment', 'healthPhysical', 'aftercareThreadSent',
                    'optionsDocUploaded', 'dischargePacketUploaded', 'referralClosureCorrespondence',
                    'gadCompleted', 'phqCompleted', 'satisfactionSurvey', 
                    'dischargeSummary', 'dischargePlanningNote', 'dischargeASAM'
                ];
                const completed = trackingFields.filter(field => client[field]).length;
                const completionPercentage = trackingFields.length > 0 ? Math.round((completed / trackingFields.length) * 100) : 0;
                
                // Build modal HTML with modern design
                const modalHTML = `
                    <div class="modal-overlay">
                        <div class="modal-content modern-modal">
                            <!-- Header with key metrics -->
                            <div class="modal-header">
                                <div class="modal-header-left">
                                    <h2 class="client-name">${client.initials}</h2>
                                    <span class="client-id">${client.kipuId}</span>
                                    <span class="client-status status-${client.status}">${client.status === 'active' ? '‚óè Active' : '‚óã Discharged'}</span>
                                </div>
                                <div class="modal-header-right">
                                    <div class="metric-card">
                                        <div class="metric-value">${daysInCare || 0}</div>
                                        <div class="metric-label">Days in Care</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value">${completionPercentage || 0}%</div>
                                        <div class="metric-label">Completed</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value">${house ? house.name : 'N/A'}</div>
                                        <div class="metric-label">House</div>
                                    </div>
                                </div>
                                <button class="modal-close" onclick="window.closeModal()">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="modal-toolbar" style="display:flex; justify-content:flex-end; gap:12px; margin: 12px 0 20px 0;">
                                <button class="primary-action" onclick="generateClientDocument('${clientId}', { focusSearch: true })" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                                    <span>‚ú®</span>
                                    <span>Create Document for ${client.initials}</span>
                                </button>
                            </div>
                            
                            <!-- Main Content Area -->
                            <div class="modal-body">
                                <!-- Sidebar Navigation -->
                                <div class="sidebar-nav">
                                    <button class="nav-item active" onclick="switchDetailSection('tracking', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M9 2L2 7L9 12M2 7H18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>Tracking</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('assessments', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M9 11L3 17L1 15L7 9L9 11ZM16 3L19 6L13 12L11 10L16 3Z" fill="currentColor"/>
                                        </svg>
                                        <span>Assessments</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('aftercare', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18C5.58172 18 2 14.4183 2 10C2 5.58172 5.58172 2 10 2ZM10 5L7 9H9V13L13 9H11V5H10Z" fill="currentColor"/>
                                        </svg>
                                        <span>Aftercare</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('team', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M12 4.354C11.3687 3.72275 10.5687 3.375 9.69995 3.375C8.83119 3.375 8.0312 3.72275 7.39995 4.354C6.7687 4.98525 6.42095 5.78525 6.42095 6.654C6.42095 7.52275 6.7687 8.32275 7.39995 8.954C8.0312 9.58525 8.83119 9.933 9.69995 9.933C10.5687 9.933 11.3687 9.58525 11.9999 8.954C12.6312 8.32275 12.9789 7.52275 12.9789 6.654C12.9789 5.78525 12.6312 4.98525 12 4.354Z" fill="currentColor"/>
                                            <path d="M16.5 14.954C16.5 14.274 16.3679 13.6019 16.1124 12.975C15.857 12.3482 15.4831 11.7786 15.0104 11.2969C14.5376 10.8152 13.975 10.4305 13.3525 10.1636C12.73 9.89666 12.0596 9.75255 11.3789 9.73875C10.8262 10.1458 10.1842 10.4271 9.49997 10.5598C8.81578 10.4271 8.17378 10.1458 7.62108 9.73875C6.94036 9.75255 6.26999 9.89666 5.64749 10.1636C5.025 10.4305 4.46235 10.8152 3.98965 11.2969C3.51695 11.7786 3.14301 12.3482 2.88758 12.975C2.63214 13.6019 2.5 14.274 2.5 14.954V16.563H16.5V14.954Z" fill="currentColor"/>
                                        </svg>
                                        <span>Care Team</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('timeline', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M10 2C14.418 2 18 5.582 18 10S14.418 18 10 18S2 14.418 2 10S5.582 2 10 2ZM10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>Timeline</span>
                                    </button>
                                    <button class="nav-item" onclick="switchDetailSection('notes', event)">
                                        <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M4 5C4 4.44772 4.44772 4 5 4H11C11.5523 4 12 4.44772 12 5V16L8 14L4 16V5Z" fill="currentColor"/>
                                        </svg>
                                        <span>Notes</span>
                                    </button>
                                </div>
                            
                                
                                <!-- Content Area -->
                                <div class="content-area">
                                    <!-- Tracking Section -->
                                    <div id="trackingSection" class="section-content active">
                                        ${hoursElapsed < 48 && client.status === 'active' ? `
                                        <!-- 48-hour Admission Countdown -->
                                        <div class="admission-timer ${hoursElapsed >= 36 ? 'timer-urgent' : hoursElapsed >= 24 ? 'timer-warning' : ''}">
                                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" style="margin-right: 8px;">
                                                <path d="M10 2C14.418 2 18 5.582 18 10S14.418 18 10 18S2 14.418 2 10S5.582 2 10 2ZM10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            <span class="timer-text">
                                                <strong>${48 - hoursElapsed} hours remaining</strong> for admission assessments
                                                ${!client.needsAssessment || !client.healthPhysical ? `
                                                    <span class="timer-items">
                                                        ${!client.needsAssessment ? '‚Ä¢ Needs Assessment' : ''}
                                                        ${!client.healthPhysical ? '‚Ä¢ Health & Physical' : ''}
                                                    </span>
                                                ` : ''}
                                            </span>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- Tracking Cards -->
                                        <div class="tracking-grid">
                                            <!-- Admission & Assessment Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìã Admission & Assessment</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item" data-tracking="needs-assessment">
                                                        <input type="checkbox" 
                                                               id="needs-assessment-${clientId}" 
                                                               ${client.needsAssessment ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'needsAssessment', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Needs Assessment</span>
                                                        ${client.needsAssessmentDate ? `<span class="completion-date">${new Date(client.needsAssessmentDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="health-physical">
                                                        <input type="checkbox" 
                                                               id="health-physical-${clientId}" 
                                                               ${client.healthPhysical ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'healthPhysical', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Health & Physical Assessment</span>
                                                        ${client.healthPhysicalDate ? `<span class="completion-date">${new Date(client.healthPhysicalDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Aftercare Planning Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üéØ Aftercare Planning</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item ${daysInCare >= 14 && daysInCare <= 16 ? 'highlight-warning' : daysInCare > 16 ? 'highlight-danger' : ''}" data-tracking="aftercare-thread">
                                                        <input type="checkbox" 
                                                               id="aftercare-thread-${clientId}" 
                                                               ${client.aftercareThreadSent ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'aftercareThreadSent', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Aftercare Planning Thread Sent</span>
                                                        ${daysInCare >= 14 ? `<span class="days-indicator days-${daysInCare}">${daysInCare} days</span>` : ''}
                                                        ${client.aftercareThreadDate ? `<span class="completion-date">${new Date(client.aftercareThreadDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="options-doc">
                                                        <input type="checkbox" 
                                                               id="options-doc-${clientId}" 
                                                               ${client.optionsDocUploaded ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'optionsDocUploaded', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Options Document in Kipu</span>
                                                        ${client.optionsDocUploadedDate ? `<span class="completion-date">${new Date(client.optionsDocUploadedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="discharge-packet">
                                                        <input type="checkbox" 
                                                               id="discharge-packet-${clientId}" 
                                                               ${client.dischargePacketUploaded ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargePacketUploaded', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Discharge Packet in Kipu</span>
                                                        ${client.dischargePacketDate ? `<span class="completion-date">${new Date(client.dischargePacketDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="referral-closure">
                                                        <input type="checkbox" 
                                                               id="referral-closure-${clientId}" 
                                                               ${client.referralClosureCorrespondence ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'referralClosureCorrespondence', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Referral/Closure Correspondence</span>
                                                        ${client.referralClosureDate ? `<span class="completion-date">${new Date(client.referralClosureDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                                
                                                <!-- Aftercare Options Progress Tracking -->
                                                ${client.aftercareOptions && client.aftercareOptions.length > 0 ? `
                                                    <div class="aftercare-options-tracking">
                                                        <h4 style="font-size: 14px; margin: 16px 0 12px 0; font-weight: 600; color: #374151;">
                                                            Aftercare Options Progress
                                                        </h4>
                                                        ${client.aftercareOptions.map(option => `
                                                            <div class="aftercare-option-item">
                                                                <div class="option-header">
                                                                    <span class="option-name">${option.programName}</span>
                                                                    <span class="option-status status-${option.status}">${option.status}</span>
                                                                </div>
                                                                
                                                                <div class="progress-tracker">
                                                                    <div class="progress-step ${option.familyContacted ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'familyContacted', ${!option.familyContacted})">
                                                                        <span class="step-icon">
                                                                            ${option.familyContacted ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                '‚òéÔ∏è'}
                                                                        </span>
                                                                        <span class="step-label">Family Contacted</span>
                                                                    </div>
                                                                    <div class="progress-step ${option.recordsSent ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'recordsSent', ${!option.recordsSent})">
                                                                        <span class="step-icon">
                                                                            ${option.recordsSent ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                'üìÑ'}
                                                                        </span>
                                                                        <span class="step-label">Records Sent</span>
                                                                    </div>
                                                                    <div class="progress-step ${option.assessmentScheduled ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'assessmentScheduled', ${!option.assessmentScheduled})">
                                                                        <span class="step-icon">
                                                                            ${option.assessmentScheduled ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                'üìÖ'}
                                                                        </span>
                                                                        <span class="step-label">Assessment Set</span>
                                                                    </div>
                                                                    <div class="progress-step ${option.accepted ? 'completed' : ''}"
                                                                         onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'accepted', ${!option.accepted})">
                                                                        <span class="step-icon">
                                                                            ${option.accepted ? 
                                                                                '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                                                                '‚úÖ'}
                                                                        </span>
                                                                        <span class="step-label">Accepted</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            
                                            <!-- Clinical Assessments Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìä Clinical Assessments</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item" data-tracking="gad-completed">
                                                        <input type="checkbox" 
                                                               id="gad-completed-${clientId}" 
                                                               ${client.gadCompleted ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'gadCompleted', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">GAD-7 Completed (in Kipu)</span>
                                                        ${client.gadCompletedDate ? `<span class="completion-date">${new Date(client.gadCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="phq-completed">
                                                        <input type="checkbox" 
                                                               id="phq-completed-${clientId}" 
                                                               ${client.phqCompleted ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'phqCompleted', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">PHQ-9 Completed (in Kipu)</span>
                                                        ${client.phqCompletedDate ? `<span class="completion-date">${new Date(client.phqCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="satisfaction-survey">
                                                        <input type="checkbox" 
                                                               id="satisfaction-survey-${clientId}" 
                                                               ${client.satisfactionSurvey ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'satisfactionSurvey', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Satisfaction Survey Completed</span>
                                                        ${client.satisfactionSurveyDate ? `<span class="completion-date">${new Date(client.satisfactionSurveyDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Documentation Card -->
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìÑ Documentation</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item" data-tracking="discharge-summary">
                                                        <input type="checkbox" 
                                                               id="discharge-summary-${clientId}" 
                                                               ${client.dischargeSummary ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargeSummary', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Discharge Summary</span>
                                                        ${client.dischargeSummaryDate ? `<span class="completion-date">${new Date(client.dischargeSummaryDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="discharge-planning">
                                                        <input type="checkbox" 
                                                               id="discharge-planning-${clientId}" 
                                                               ${client.dischargePlanningNote ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargePlanningNote', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Final Discharge Planning Note</span>
                                                        ${client.dischargePlanningNoteDate ? `<span class="completion-date">${new Date(client.dischargePlanningNoteDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item" data-tracking="discharge-asam">
                                                        <input type="checkbox" 
                                                               id="discharge-asam-${clientId}" 
                                                               ${client.dischargeASAM ? 'checked' : ''}
                                                               onchange="updateTracking('${clientId}', 'dischargeASAM', this.checked)">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Discharge ASAM</span>
                                                        ${client.dischargeASAMDate ? `<span class="completion-date">${new Date(client.dischargeASAMDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Assessments Section -->
                                    <div id="assessmentsSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Assessment History</h2>
                                        </div>
                                        <div class="tracking-grid">
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìä Clinical Assessments Status</h3>
                                                <div class="checklist">
                                                    <label class="checklist-item">
                                                        <input type="checkbox" ${client.gadCompleted ? 'checked' : ''} style="pointer-events: none;">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">GAD-7 Completed (in Kipu)</span>
                                                        ${client.gadCompletedDate ? `<span class="completion-date">${new Date(client.gadCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item">
                                                        <input type="checkbox" ${client.phqCompleted ? 'checked' : ''} style="pointer-events: none;">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">PHQ-9 Completed (in Kipu)</span>
                                                        ${client.phqCompletedDate ? `<span class="completion-date">${new Date(client.phqCompletedDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                    <label class="checklist-item">
                                                        <input type="checkbox" ${client.satisfactionSurvey ? 'checked' : ''} style="pointer-events: none;">
                                                        <span class="checkbox-custom"></span>
                                                        <span class="item-text">Satisfaction Survey Completed</span>
                                                        ${client.satisfactionSurveyDate ? `<span class="completion-date">${new Date(client.satisfactionSurveyDate).toLocaleDateString()}</span>` : ''}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="tracking-card">
                                                <h3 class="card-title">üìù Notes</h3>
                                                <p style="color: #6b7280; padding: 20px;">All assessments are completed within Kipu. This tracking ensures completion status is documented.</p>
                                            </div>
                                        </div>
                                    </div>
                                
                                    
                                    <!-- Aftercare Section -->
                                    <div id="aftercareSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Aftercare Options</h2>
                                            <button class="btn-primary" onclick="addAftercareOption('${clientId}')">+ Add Option</button>
                                        </div>
                                        <div class="aftercare-grid">
                                            ${buildModernAftercareList(aftercareOptions, clientId)}
                                        </div>
                                    </div>
                                    
                                    <!-- Care Team Section -->
                                    <div id="teamSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Care Team Assignments</h2>
                                        </div>
                                        <div class="team-grid">
                                            <div class="team-member-card">
                                                <div class="member-icon">ü§ù</div>
                                                <label>Case Manager</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="caseManager" 
                                                       value="${client.caseManagerInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'caseManagerInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üè•</div>
                                                <label>Clinical Coach</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="clinicalCoach" 
                                                       value="${client.clinicalCoachInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'clinicalCoachInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üë®‚Äç‚öïÔ∏è</div>
                                                <label>Primary Therapist</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="primaryTherapist" 
                                                       value="${client.primaryTherapistInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'primaryTherapistInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üë•</div>
                                                <label>Primary Family Ambassador</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="familyAmbassador" 
                                                       value="${client.familyAmbassadorPrimaryInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'familyAmbassadorPrimaryInitials', this.value)">
                                            </div>
                                            <div class="team-member-card">
                                                <div class="member-icon">üë•</div>
                                                <label>Secondary Family Ambassador</label>
                                                <input type="text" 
                                                       class="team-input" 
                                                       id="familyAmbassador2" 
                                                       value="${client.familyAmbassadorSecondaryInitials || ''}" 
                                                       maxlength="4" 
                                                       placeholder="Initials"
                                                       onchange="updateTeamMember('${clientId}', 'familyAmbassadorSecondaryInitials', this.value)">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Timeline Section -->
                                    <div id="timelineSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Client Timeline</h2>
                                        </div>
                                        <div class="timeline-container">
                                            ${buildClientTimeline(client, milestones, daysInCare)}
                                        </div>
                                    </div>
                                    
                                    <!-- Notes Section -->
                                    <div id="notesSection" class="section-content" style="display: none;">
                                        <div class="section-header">
                                            <h2>Notes & Documentation</h2>
                                        </div>
                                        <div class="notes-container">
                                            <textarea class="notes-textarea" 
                                                      id="clientNotes" 
                                                      placeholder="Add notes about this client..."
                                                      oninput="autoSaveNotes('${clientId}', this.value)">${client.notes || ''}</textarea>
                                            <div class="notes-footer">
                                                <span id="noteSaveStatus" class="save-status">All changes saved</span>
                                                <span class="notes-timestamp">Last updated: ${client.notesUpdatedAt ? new Date(client.notesUpdatedAt).toLocaleString() : 'Never'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                // Add comprehensive modern styling
                const style = document.createElement('style');
                style.textContent = `
                    /* Modal Base Styles */
                    .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background-color: rgba(0, 0, 0, 0.6);
                        backdrop-filter: blur(4px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 999999;
                        cursor: pointer;
                        animation: fadeIn 0.2s ease;
                    }
                    .modal-content {
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
                        cursor: default;
                        overflow: hidden;
                        position: relative;
                    }
                    .modern-modal {
                        width: 1000px;
                        max-width: 95vw;
                        height: 75vh;
                        max-height: 700px;
                        display: flex;
                        flex-direction: column;
                        animation: slideIn 0.3s ease;
                    }
                    
                    /* Modal Header */
                    .modal-header {
                        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                        color: white;
                        padding: 24px;
                        display: flex;
                        align-items: center;
                        gap: 20px;
                        position: relative;
                    }
                    .modal-header-left {
                        flex: 1;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    .client-name {
                        font-size: 22px;
                        font-weight: 700;
                        margin: 0;
                    }
                    .client-id {
                        background: rgba(255,255,255,0.2);
                        padding: 4px 10px;
                        border-radius: 20px;
                        font-size: 13px;
                    }
                    .client-status {
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: 500;
                    }
                    .status-active {
                        background: #10b981;
                        color: white;
                    }
                    .status-discharged {
                        background: #ef4444;
                        color: white;
                    }
                    
                    /* Header Metrics */
                    .modal-header-right {
                        display: flex;
                        gap: 16px;
                    }
                    .metric-card {
                        background: rgba(255,255,255,0.15);
                        backdrop-filter: blur(10px);
                        padding: 12px 20px;
                        border-radius: 12px;
                        text-align: center;
                        min-width: 100px;
                    }
                    .metric-value {
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 4px;
                    }
                    .metric-label {
                        font-size: 12px;
                        opacity: 0.9;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    
                    /* Modal Close Button */
                    .modal-close {
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        color: white;
                    }
                    .modal-close:hover {
                        background: rgba(255,255,255,0.3);
                        transform: scale(1.1);
                    }
                    
                    /* Modal Body */
                    .modal-body {
                        flex: 1;
                        display: flex;
                        overflow: hidden;
                        background: #f8f9fa;
                    }
                    
                    /* Sidebar Navigation */
                    .sidebar-nav {
                        width: 180px;
                        background: white;
                        padding: 12px 6px;
                        border-right: 1px solid #e5e7eb;
                        display: flex;
                        flex-direction: column;
                        gap: 2px;
                    }
                    .nav-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px 12px;
                        border: none;
                        background: transparent;
                        color: #6b7280;
                        font-size: 13px;
                        font-weight: 500;
                        text-align: left;
                        cursor: pointer;
                        border-radius: 6px;
                        transition: all 0.2s ease;
                    }
                    .nav-item:hover {
                        background: #f3f4f6;
                        color: #1f2937;
                    }
                    .nav-item.active {
                        background: #6366f1;
                        color: white;
                    }
                    .nav-icon {
                        width: 20px;
                        height: 20px;
                        flex-shrink: 0;
                    }
                    
                    /* Content Area */
                    .content-area {
                        flex: 1;
                        overflow-y: auto;
                        padding: 24px;
                    }
                    .section-content {
                        display: none;
                    }
                    .section-content.active {
                        display: block;
                        animation: fadeIn 0.3s ease;
                    }
                    .section-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 24px;
                    }
                    .section-header h2 {
                        font-size: 24px;
                        font-weight: 700;
                        color: #1f2937;
                        margin: 0;
                    }
                    
                    /* Tracking Grid */
                    .tracking-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 16px;
                    }
                    .tracking-card {
                        background: white;
                        border-radius: 10px;
                        padding: 16px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
                        transition: all 0.2s ease;
                    }
                    .tracking-card:hover {
                        box-shadow: 0 3px 12px rgba(0,0,0,0.1);
                        transform: translateY(-1px);
                    }
                    
                    /* Admission Timer */
                    .admission-timer {
                        display: flex;
                        align-items: center;
                        background: #fef3c7;
                        border: 2px solid #f59e0b;
                        border-radius: 8px;
                        padding: 12px 16px;
                        margin-bottom: 16px;
                        font-size: 14px;
                        color: #92400e;
                    }
                    .admission-timer.timer-warning {
                        background: #fee2e2;
                        border-color: #ef4444;
                        color: #991b1b;
                    }
                    .admission-timer.timer-urgent {
                        background: #dc2626;
                        border-color: #991b1b;
                        color: white;
                        animation: pulse 2s infinite;
                    }
                    .timer-text {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }
                    .timer-items {
                        font-size: 12px;
                        opacity: 0.9;
                        margin-left: 28px;
                    }
                    
                    /* Aftercare Progress Tracking */
                    .aftercare-options-tracking {
                        margin-top: 16px;
                        border-top: 1px solid #e5e7eb;
                        padding-top: 12px;
                    }
                    .aftercare-option-item {
                        background: #f9fafb;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 12px;
                    }
                    .option-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                    }
                    .option-name {
                        font-weight: 600;
                        font-size: 14px;
                        color: #111827;
                    }
                    .option-status {
                        font-size: 12px;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-weight: 500;
                        text-transform: capitalize;
                    }
                    .status-exploring {
                        background: #dbeafe;
                        color: #1e40af;
                    }
                    .status-in-progress {
                        background: #fef3c7;
                        color: #92400e;
                    }
                    .status-accepted {
                        background: #d1fae5;
                        color: #065f46;
                    }
                    .status-declined {
                        background: #fee2e2;
                        color: #991b1b;
                    }
                    
                    /* Progress Tracker Steps */
                    .progress-tracker {
                        display: flex;
                        gap: 8px;
                        flex-wrap: wrap;
                    }
                    .progress-step {
                        flex: 1;
                        min-width: 100px;
                        background: white;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 8px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 4px;
                    }
                    .progress-step:hover {
                        border-color: #6366f1;
                        background: #eef2ff;
                    }
                    .progress-step.completed {
                        background: #10b981;
                        border-color: #10b981;
                        color: white;
                    }
                    .step-icon {
                        font-size: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: transform 0.2s ease;
                    }
                    
                    .progress-step:hover .step-icon {
                        transform: scale(1.1);
                    }
                    
                    .progress-step.completed .step-icon svg {
                        animation: svgCheckPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                    }
                    
                    @keyframes svgCheckPop {
                        0% {
                            transform: scale(0) rotate(-45deg);
                            opacity: 0;
                        }
                        50% {
                            transform: scale(1.2) rotate(5deg);
                        }
                        100% {
                            transform: scale(1) rotate(0deg);
                            opacity: 1;
                        }
                    }
                    .step-label {
                        font-size: 11px;
                        font-weight: 500;
                    }
                    
                    /* Day indicators */
                    .days-indicator {
                        background: #fbbf24;
                        color: #78350f;
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 11px;
                        font-weight: 600;
                        margin-left: auto;
                    }
                    .days-15, .days-16 {
                        background: #fb923c;
                        color: #7c2d12;
                    }
                    .days-17, .days-18, .days-19, .days-20 {
                        background: #ef4444;
                        color: white;
                    }
                    
                    /* Highlight states */
                    .highlight-warning {
                        background: #fef3c7 !important;
                    }
                    .highlight-danger {
                        background: #fee2e2 !important;
                    }
                    
                    @keyframes pulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.8; }
                        100% { opacity: 1; }
                    }
                    .card-title {
                        font-size: 15px;
                        font-weight: 600;
                        color: #1f2937;
                        margin: 0 0 12px 0;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    
                    /* Checklist Styles */
                    .checklist {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }
                    .checklist-item {
                        display: flex;
                        align-items: center;
                        cursor: pointer;
                        padding: 8px 10px;
                        border-radius: 6px;
                        transition: all 0.2s ease;
                        position: relative;
                        font-size: 13px;
                    }
                    .checklist-item:hover {
                        background: #f9fafb;
                    }
                    .checklist-item.highlight-warning {
                        background: #fef3c7;
                        border: 1px solid #fbbf24;
                    }
                    .checklist-item.highlight-danger {
                        background: #fee2e2;
                        border: 1px solid #ef4444;
                    }
                    .checklist-item input[type="checkbox"] {
                        position: absolute;
                        opacity: 0;
                        cursor: pointer;
                    }
                    
                    .checklist-item input[type="checkbox"][style*="pointer-events: none"] {
                        cursor: default;
                    }
                    .checkbox-custom {
                        width: 24px;
                        height: 24px;
                        border: 2.5px solid #e5e7eb;
                        border-radius: 6px;
                        margin-right: 12px;
                        position: relative;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        flex-shrink: 0;
                        background: white;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                        overflow: hidden;
                    }
                    
                    .checklist-item:hover .checkbox-custom {
                        border-color: #22c55e;
                        transform: scale(1.05);
                        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1),
                                    0 1px 3px rgba(0, 0, 0, 0.1);
                    }
                    
                    .checkbox-custom::before {
                        content: '';
                        position: absolute;
                        top: -1px;
                        left: -1px;
                        right: -1px;
                        bottom: -1px;
                        background: linear-gradient(135deg, #22c55e, #16a34a);
                        transform: scale(0);
                        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        border-radius: 4px;
                    }
                    
                    .checklist-item input:checked ~ .checkbox-custom,
                    .checklist-item input[checked] ~ .checkbox-custom {
                        border-color: transparent;
                        animation: checkPulse 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    }
                    
                    .checklist-item input:checked ~ .checkbox-custom::before,
                    .checklist-item input[checked] ~ .checkbox-custom::before {
                        transform: scale(1);
                    }
                    
                    .checklist-item input:checked ~ .checkbox-custom::after,
                    .checklist-item input[checked] ~ .checkbox-custom::after {
                        content: '';
                        position: absolute;
                        width: 7px;
                        height: 12px;
                        border: solid white;
                        border-width: 0 3px 3px 0;
                        top: 40%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(45deg) scale(1);
                        animation: checkmarkPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                        animation-delay: 0.1s;
                        animation-fill-mode: both;
                        z-index: 2;
                    }
                    
                    @keyframes checkPulse {
                        0% { 
                            transform: scale(1); 
                            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                        }
                        30% { 
                            transform: scale(0.95); 
                            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                        }
                        60% { 
                            transform: scale(1.1); 
                            box-shadow: 0 0 0 8px rgba(34, 197, 94, 0.15),
                                        0 2px 4px rgba(0, 0, 0, 0.1);
                        }
                        100% { 
                            transform: scale(1); 
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        }
                    }
                    
                    @keyframes checkmarkPop {
                        0% {
                            transform: translate(-50%, -50%) rotate(45deg) scale(0);
                            opacity: 0;
                        }
                        50% {
                            transform: translate(-50%, -50%) rotate(45deg) scale(1.3);
                            opacity: 1;
                        }
                        100% {
                            transform: translate(-50%, -50%) rotate(45deg) scale(1);
                            opacity: 1;
                        }
                    }
                    .item-text {
                        flex: 1;
                        color: #374151;
                        font-weight: 500;
                        font-size: 13px;
                    }
                    .checklist-item input:checked ~ .item-text,
                    .checklist-item input[checked] ~ .item-text {
                        color: #6b7280;
                        text-decoration: line-through;
                    }
                    .completion-date {
                        font-size: 11px;
                        color: #9ca3af;
                        margin-left: auto;
                    }
                    .days-indicator {
                        font-size: 12px;
                        font-weight: 600;
                        padding: 2px 8px;
                        border-radius: 12px;
                        margin-left: 8px;
                    }
                    .days-14, .days-15, .days-16 {
                        background: #fef3c7;
                        color: #92400e;
                    }
                    .days-indicator.days-17,
                    .days-indicator.days-18,
                    .days-indicator.days-19,
                    .days-indicator.days-20 {
                        background: #fee2e2;
                        color: #991b1b;
                    }
                    
                    /* Assessment Scores */
                    .assessment-scores {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                        margin-bottom: 16px;
                    }
                    .score-item {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }
                    .score-item label {
                        font-size: 14px;
                        font-weight: 600;
                        color: #374151;
                    }
                    .score-input {
                        padding: 8px 12px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        text-align: center;
                        transition: all 0.2s ease;
                    }
                    .score-input:focus {
                        outline: none;
                        border-color: #6366f1;
                        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                    }
                    
                    /* Team Grid */
                    .team-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 16px;
                    }
                    .team-member-card {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        transition: all 0.2s ease;
                    }
                    .team-member-card:hover {
                        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                        transform: translateY(-2px);
                    }
                    .member-icon {
                        font-size: 32px;
                        margin-bottom: 8px;
                    }
                    .team-member-card label {
                        display: block;
                        font-size: 14px;
                        font-weight: 600;
                        color: #374151;
                        margin-bottom: 8px;
                    }
                    .team-input {
                        width: 100%;
                        padding: 10px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        text-align: center;
                        font-size: 18px;
                        font-weight: 700;
                        text-transform: uppercase;
                        transition: all 0.2s ease;
                    }
                    .team-input:focus {
                        outline: none;
                        border-color: #6366f1;
                        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                    }
                    
                    /* Notes Section */
                    .notes-container {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                    }
                    .notes-textarea {
                        width: 100%;
                        min-height: 300px;
                        padding: 16px;
                        border: 2px solid #e5e7eb;
                        border-radius: 8px;
                        font-family: inherit;
                        font-size: 14px;
                        line-height: 1.5;
                        resize: vertical;
                        transition: all 0.2s ease;
                    }
                    .notes-textarea:focus {
                        outline: none;
                        border-color: #6366f1;
                        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                    }
                    .notes-footer {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 12px;
                    }
                    .save-status {
                        font-size: 12px;
                        color: #10b981;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    }
                    .save-status.saving {
                        color: #6366f1;
                    }
                    .notes-timestamp {
                        font-size: 12px;
                        color: #9ca3af;
                    }
                    
                    /* Buttons */
                    .btn-primary {
                        background: #6366f1;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .btn-primary:hover {
                        background: #4f46e5;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
                    }
                    
                    /* Animations */
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(20px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .detail-tab-content {
                        padding: 20px;
                    }
                    .milestone-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        margin-bottom: 8px;
                        background: #f9fafb;
                        border-radius: 8px;
                        border: 1px solid #e5e7eb;
                    }
                    .milestone-item:hover {
                        background: #f3f4f6;
                    }
                    .aftercare-item {
                        padding: 15px;
                        margin-bottom: 10px;
                        background: white;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                    }
                    
                    /* Visual indicator color coding */
                    .milestone-indicator {
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        min-width: 28px;
                        height: 28px;
                        border-radius: 6px;
                        font-size: 16px;
                        transition: all 0.2s ease;
                        cursor: pointer;
                        user-select: none;
                    }
                    
                    .milestone-indicator.complete {
                        background-color: #10b981;
                        color: white;
                    }
                    
                    .milestone-indicator.overdue {
                        background-color: #ef4444;
                        color: white;
                        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
                    }
                    
                    .milestone-indicator.due-today {
                        background-color: #f59e0b;
                        color: white;
                    }
                    
                    .milestone-indicator.due-soon {
                        background-color: #f59e0b;
                        color: white;
                        opacity: 0.8;
                    }
                    
                    .milestone-indicator.in-progress {
                        background-color: #3b82f6;
                        color: white;
                    }
                    
                    .milestone-indicator.pending {
                        background: #e5e7eb;
                        color: #6b7280;
                    }
                    
                    @keyframes pulse {
                        0%, 100% {
                            opacity: 1;
                        }
                        50% {
                            opacity: .8;
                        }
                    }
                    /* Days in care color coding */
                    .days-in-care {
                        font-weight: 500;
                    }
                    
                    td.days-in-care {
                        text-align: center;
                    }
                    
                    /* Color code days based on milestones */
                    .days-13 { color: #f59e0b; font-weight: 600; }
                    .days-14 { color: #f59e0b; font-weight: 600; }
                    .days-16plus { color: #ef4444; font-weight: 600; }
                `;
                document.head.appendChild(style);
                
                // Add keyboard listener for ESC key
                document.addEventListener('keydown', handleModalKeydown);
                
                // Fix overlay click handling
                const overlay = document.querySelector('.modal-overlay');
                if (overlay) {
                    overlay.addEventListener('click', function(event) {
                        if (event.target === this) {
                            closeModal();
                        }
                    });
                    
                    // Prevent clicks inside modal from bubbling up
                    const modalContent = overlay.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.addEventListener('click', function(event) {
                            event.stopPropagation();
                        });
                    }
                }
                
            } catch (error) {
                console.error('Failed to load client details:', error);
                showAlert('Failed to load client details', 'error');
            }
        }
        
        // Update tracking field for a client
        async function updateTracking(clientId, field, checked) {
            try {
                const update = {};
                update[field] = checked;
                
                // Add timestamp if checked
                if (checked) {
                    update[field + 'Date'] = new Date().toISOString();
                } else {
                    update[field + 'Date'] = null;
                }
                
                await window.clientManager.updateClient(clientId, update);
                
                // Visual feedback
                const checkbox = document.querySelector(`#${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-${clientId}`);
                if (checkbox) {
                    const label = checkbox.closest('.checklist-item');
                    if (label) {
                        label.style.background = checked ? '#d1fae5' : 'transparent';
                        setTimeout(() => {
                            label.style.background = '';
                        }, 500);
                    }
                }
                
                // Update completion percentage
                updateCompletionPercentage(clientId);
                
                // Show success message
                showAlert(`‚úÖ ${field} ${checked ? 'marked complete' : 'unchecked'}`, 'success');
            } catch (error) {
                console.error('Failed to update tracking:', error);
                showAlert('Failed to update tracking', 'error');
            }
        }
        
        // Update aftercare option progress
        async function updateAftercareProgress(clientId, programId, field, value) {
            try {
                const progressUpdate = {};
                progressUpdate[field] = value;
                
                // Add timestamp for certain fields
                if (value && ['familyContacted', 'recordsSent', 'assessmentScheduled', 'accepted'].includes(field)) {
                    progressUpdate[field + 'Date'] = new Date().toISOString();
                }
                
                // Update status based on progress
                if (field === 'accepted' && value) {
                    progressUpdate.status = 'accepted';
                } else if (field === 'assessmentScheduled' && value) {
                    progressUpdate.status = 'in-progress';
                }
                
                await window.clientManager.updateAftercareProgress(clientId, programId, progressUpdate);
                
                // Reload the section to show updated data
                const client = await window.clientManager.getClient(clientId);
                if (client && client.aftercareOptions) {
                    const aftercareHTML = client.aftercareOptions.map(option => `
                        <div class="aftercare-option-item">
                            <div class="option-header">
                                <span class="option-name">${option.programName}</span>
                                <span class="option-status status-${option.status}">${option.status}</span>
                            </div>
                            
                            <div class="progress-tracker">
                                <div class="progress-step ${option.familyContacted ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'familyContacted', ${!option.familyContacted})">
                                    <span class="step-icon">
                                        ${option.familyContacted ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            '‚òéÔ∏è'}
                                    </span>
                                    <span class="step-label">Family Contacted</span>
                                </div>
                                <div class="progress-step ${option.recordsSent ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'recordsSent', ${!option.recordsSent})">
                                    <span class="step-icon">
                                        ${option.recordsSent ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            'üìÑ'}
                                    </span>
                                    <span class="step-label">Records Sent</span>
                                </div>
                                <div class="progress-step ${option.assessmentScheduled ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'assessmentScheduled', ${!option.assessmentScheduled})">
                                    <span class="step-icon">
                                        ${option.assessmentScheduled ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            'üìÖ'}
                                    </span>
                                    <span class="step-label">Assessment Set</span>
                                </div>
                                <div class="progress-step ${option.accepted ? 'completed' : ''}"
                                     onclick="updateAftercareProgress('${clientId}', '${option.programId}', 'accepted', ${!option.accepted})">
                                    <span class="step-icon">
                                        ${option.accepted ? 
                                            '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 10.5L7.5 14L16 5.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : 
                                            '‚úÖ'}
                                    </span>
                                    <span class="step-label">Accepted</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Update just the aftercare tracking section
                    const trackingSection = document.querySelector('.aftercare-options-tracking');
                    if (trackingSection) {
                        trackingSection.innerHTML = `
                            <h4 style="font-size: 14px; margin: 16px 0 12px 0; font-weight: 600; color: #374151;">
                                Aftercare Options Progress
                            </h4>
                            ${aftercareHTML}
                        `;
                    }
                }
                
                showAlert(`‚úÖ Updated ${field} for aftercare option`, 'success');
            } catch (error) {
                console.error('Failed to update aftercare progress:', error);
                showAlert('Failed to update aftercare progress', 'error');
            }
        }
        
        // Update completion percentage in the header
        async function updateCompletionPercentage(clientId) {
            const client = await window.clientManager.getClient(clientId);
            if (!client) return;
            
            const trackingFields = [
                'needsAssessment', 'healthPhysical', 'aftercareThreadSent',
                'optionsDocUploaded', 'dischargePacketUploaded', 'referralClosureCorrespondence',
                'gadCompleted', 'phqCompleted', 'satisfactionSurvey', 
                'dischargeSummary', 'dischargePlanningNote', 'dischargeASAM'
            ];
            const completed = trackingFields.filter(field => client[field]).length;
            const completionPercentage = trackingFields.length > 0 ? Math.round((completed / trackingFields.length) * 100) : 0;
            
            // Update the percentage display
            const percentageDisplay = document.querySelector('.metric-value');
            if (percentageDisplay && percentageDisplay.nextElementSibling?.textContent === 'Completed') {
                percentageDisplay.textContent = `${completionPercentage}%`;
            }
        }
        
        // Build milestones list for client details
        async function buildMilestonesList(client, milestones, daysInCare) {
            let html = '<div>';
            
            for (const milestone of milestones) {
                const display = milestonesManager.getMilestoneDisplayStatus(milestone, daysInCare);
                const milestoneType = Object.values(milestonesManager.milestoneTypes).find(t => t.id === milestone.milestone);
                
                html += `
                    <div class="milestone-item">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${milestoneType.icon}</span>
                            <div>
                                <strong>${milestoneType.displayName}</strong>
                                <div style="font-size: 12px; color: #6b7280;">${milestoneType.description}</div>
                            </div>
                        </div>
                        <button onclick="toggleMilestone('${client.id}', '${milestone.milestone}')" 
                                class="milestone-indicator ${display.class}" 
                                style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; background: ${display.class === 'complete' ? '#10b981' : '#e5e7eb'}; color: ${display.class === 'complete' ? 'white' : '#374151'};">
                            ${display.icon} ${display.class === 'complete' ? 'Complete' : 'Mark Complete'}
                        </button>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Build aftercare list for client details
        function buildAftercareList(aftercareOptions, clientId) {
            if (aftercareOptions.length === 0) {
                return '<p style="color: #6b7280;">No aftercare options added yet.</p>';
            }
            
            let html = '<div>';
            
            for (const option of aftercareOptions) {
                const statusDisplay = aftercareManager.getStatusDisplay(option.status);
                
                html += `
                    <div class="aftercare-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 8px 0;">Option ${option.ordinal}: ${option.programName || 'Unnamed Program'}</h5>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <span style="padding: 4px 8px; background: ${statusDisplay.background}; color: ${statusDisplay.color}; border-radius: 4px; font-size: 12px;">
                                        ${statusDisplay.icon} ${statusDisplay.label}
                                    </span>
                                    ${option.dateProvidedToFamily ? `<span style="font-size: 12px; color: #6b7280;">Provided: ${option.dateProvidedToFamily}</span>` : ''}
                                </div>
                                ${option.notes ? `<p style="margin: 5px 0; font-size: 14px; color: #374151;">${option.notes}</p>` : ''}
                            </div>
                            <button onclick="editAftercareOption('${clientId}', ${option.ordinal})" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer;">
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Switch detail section
        function switchDetailSection(sectionName, event) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const sectionElement = document.getElementById(sectionName + 'Section');
            if (sectionElement) {
                sectionElement.classList.add('active');
            }
            
            // Add active class to selected nav item
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If no event, find the nav item by section name and activate it
                const navItem = document.querySelector(`.nav-item[onclick*="${sectionName}"]`);
                if (navItem) navItem.classList.add('active');
            }
        }
        
        // Save care team
        async function saveCareTeam(clientId) {
            try {
                const updates = {
                    clinicalCoachInitials: document.getElementById('clinicalCoach').value,
                    caseManagerInitials: document.getElementById('caseManager').value,
                    primaryTherapistInitials: document.getElementById('primaryTherapist').value,
                    familyAmbassadorPrimaryInitials: document.getElementById('familyAmbassador').value
                };
                
                await window.clientManager.updateClient(clientId, updates);
                showAlert('Care team updated successfully', 'success');
                
                // Refresh the table
                await loadHouseView(currentHouseId);
            } catch (error) {
                console.error('Failed to save care team:', error);
                showAlert('Failed to save care team', 'error');
            }
        }
        
        // Update tracking checkbox
        async function updateTracking(clientId, field, checked) {
            try {
                const updates = { [field]: checked };
                // Add timestamp if checked
                if (checked) {
                    updates[field + 'Date'] = new Date().toISOString();
                }
                
                await window.clientManager.updateClient(clientId, updates);
                
                // Visual feedback
                const checkbox = document.getElementById(`${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-${clientId}`);
                if (checkbox) {
                    const item = checkbox.closest('.checklist-item');
                    if (item) {
                        // Add completion animation
                        item.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            item.style.transform = 'scale(1)';
                        }, 200);
                    }
                }
                
                // Update completion percentage
                updateCompletionPercentage(clientId);
            } catch (error) {
                console.error('Failed to update tracking:', error);
                showAlert('Failed to update tracking', 'error');
                // Revert checkbox
                const checkbox = document.getElementById(`${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-${clientId}`);
                if (checkbox) checkbox.checked = !checked;
            }
        }
        
        // Update score
        async function updateScore(clientId, field, value) {
            try {
                const updates = { [field]: value ? parseInt(value) : null };
                await window.clientManager.updateClient(clientId, updates);
                
                // Visual feedback
                const input = document.getElementById(`${field.replace('Score', '-score')}-${clientId}`);
                if (input) {
                    input.style.borderColor = '#10b981';
                    setTimeout(() => {
                        input.style.borderColor = '#e5e7eb';
                    }, 1000);
                }
            } catch (error) {
                console.error('Failed to update score:', error);
                showAlert('Failed to update score', 'error');
            }
        }
        
        // Update team member
        async function updateTeamMember(clientId, field, value) {
            try {
                const updates = { [field]: value.toUpperCase() };
                await window.clientManager.updateClient(clientId, updates);
                
                // Visual feedback
                const input = event.target;
                if (input) {
                    input.style.borderColor = '#10b981';
                    setTimeout(() => {
                        input.style.borderColor = '#e5e7eb';
                    }, 1000);
                }
            } catch (error) {
                console.error('Failed to update team member:', error);
                showAlert('Failed to update team member', 'error');
            }
        }
        
        // Auto-save notes
        let noteSaveTimeout;
        async function autoSaveNotes(clientId, notes) {
            const statusElement = document.getElementById('noteSaveStatus');
            if (statusElement) {
                statusElement.textContent = 'Saving...';
                statusElement.classList.add('saving');
            }
            
            // Clear previous timeout
            clearTimeout(noteSaveTimeout);
            
            // Set new timeout
            noteSaveTimeout = setTimeout(async () => {
                try {
                    await window.clientManager.updateClient(clientId, { 
                        notes,
                        notesUpdatedAt: new Date().toISOString()
                    });
                    
                    if (statusElement) {
                        statusElement.textContent = 'All changes saved';
                        statusElement.classList.remove('saving');
                    }
                } catch (error) {
                    console.error('Failed to save notes:', error);
                    if (statusElement) {
                        statusElement.textContent = 'Failed to save';
                        statusElement.classList.remove('saving');
                        statusElement.style.color = '#ef4444';
                    }
                }
            }, 1000); // Save after 1 second of no typing
        }
        
        // Update completion percentage
        async function updateCompletionPercentage(clientId) {
            try {
                const client = await window.clientManager.getClient(clientId);
                const trackingFields = [
                    'needsAssessment', 'healthPhysical', 'aftercareThreadSent',
                    'optionsDocUploaded', 'dischargePacketUploaded', 'gadCompleted',
                    'phqCompleted', 'satisfactionSurvey', 'referralClosure', 
                    'dischargeSummary', 'dischargePlanningNote', 'dischargeASAM'
                ];
                
                const completed = trackingFields.filter(field => client[field]).length;
                const percentage = Math.round((completed / trackingFields.length) * 100);
                
                const percentageElement = document.querySelector('.metric-value');
                if (percentageElement) {
                    percentageElement.textContent = percentage + '%';
                    // Add animation
                    percentageElement.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        percentageElement.style.transform = 'scale(1)';
                    }, 300);
                }
            } catch (error) {
                console.error('Failed to update percentage:', error);
            }
        }
        
        // Build assessment history
        async function buildAssessmentHistory(clientId) {
            // This would fetch assessment history from your data source
            // For now, return a placeholder
            return `
                <div class="assessment-placeholder">
                    <p style="color: #6b7280; text-align: center; padding: 40px;">
                        No assessments recorded yet. Click "Add Assessment" to begin.
                    </p>
                </div>
            `;
        }
        
        // Build modern aftercare list
        function buildModernAftercareList(aftercareOptions, clientId) {
            if (!aftercareOptions || aftercareOptions.length === 0) {
                return `
                    <div class="aftercare-placeholder">
                        <p style="color: #6b7280; text-align: center; padding: 40px;">
                            No aftercare options added yet. Click "Add Option" to begin.
                        </p>
                    </div>
                `;
            }
            
            return aftercareOptions.map(option => `
                <div class="aftercare-card">
                    <div class="aftercare-header">
                        <h4>${option.programName}</h4>
                        <span class="aftercare-status status-${option.status}">${option.status}</span>
                    </div>
                    <div class="aftercare-details">
                        ${option.dateProvided ? `<p><strong>Date Provided:</strong> ${new Date(option.dateProvided).toLocaleDateString()}</p>` : ''}
                        ${option.notes ? `<p><strong>Notes:</strong> ${option.notes}</p>` : ''}
                    </div>
                    <button class="btn-secondary" onclick="removeAftercareOption('${clientId}', '${option.id}')">Remove</button>
                </div>
            `).join('');
        }
        
        // Build client timeline
        function buildClientTimeline(client, milestones, daysInCare) {
            const events = [];
            
            // Add admission event
            if (client.admissionDate) {
                events.push({
                    date: new Date(client.admissionDate),
                    type: 'admission',
                    title: 'Admitted',
                    description: `${client.initials} admitted to ${client.houseId || 'facility'}`
                });
            }
            
            // Add tracking events
            const trackingEvents = [
                { field: 'needsAssessmentDate', title: 'Needs Assessment Completed' },
                { field: 'healthPhysicalDate', title: 'Health & Physical Assessment Completed' },
                { field: 'aftercareThreadDate', title: 'Aftercare Planning Thread Sent' },
                { field: 'optionsDocDate', title: 'Options Document Uploaded' },
                { field: 'dischargePacketDate', title: 'Discharge Packet Uploaded' }
            ];
            
            trackingEvents.forEach(event => {
                if (client[event.field]) {
                    events.push({
                        date: new Date(client[event.field]),
                        type: 'tracking',
                        title: event.title
                    });
                }
            });
            
            // Add discharge event
            if (client.dischargeDate) {
                events.push({
                    date: new Date(client.dischargeDate),
                    type: 'discharge',
                    title: 'Discharged',
                    description: `After ${daysInCare} days in care`
                });
            }
            
            // Sort events by date
            events.sort((a, b) => a.date - b.date);
            
            // Build timeline HTML
            return `
                <div class="timeline">
                    ${events.map((event, index) => `
                        <div class="timeline-event ${event.type}">
                            <div class="timeline-date">${event.date.toLocaleDateString()}</div>
                            <div class="timeline-content">
                                <h4>${event.title}</h4>
                                ${event.description ? `<p>${event.description}</p>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Add aftercare option
        async function addAftercareOption(clientId) {
            // Get programs for selection
            const programs = JSON.parse(localStorage.getItem('therapyPrograms') || '[]');
            
            let programOptions = programs.map(p => 
                `<option value="${p.name}">${p.name}</option>`
            ).join('');
            
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal-content" style="width: 500px;">
                        <h3>Add Aftercare Option</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Program Name</label>
                            <select id="programSelect" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <option value="">Select a program...</option>
                                ${programOptions}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Status</label>
                            <select id="optionStatus" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                                <option value="pending">Pending</option>
                                <option value="sent">Sent to Family</option>
                                <option value="engaged">Family Engaged</option>
                                <option value="accepted">Accepted</option>
                                <option value="declined">Declined</option>
                                <option value="waitlist">Waitlist</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Date Provided to Family</label>
                            <input type="date" id="dateProvided" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Notes</label>
                            <textarea id="optionNotes" style="width: 100%; height: 80px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="window.closeModal()" style="padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="handleAddAftercareOption('${clientId}')" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Add Option
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add keyboard listener for ESC key
            document.addEventListener('keydown', handleModalKeydown);
            
            // Fix overlay click handling
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeModal();
                    }
                });
            }
        }
        
        // Handle add aftercare option
        async function handleAddAftercareOption(clientId) {
            try {
                const programName = document.getElementById('programSelect').value;
                const status = document.getElementById('optionStatus').value;
                const dateProvided = document.getElementById('dateProvided').value;
                const notes = document.getElementById('optionNotes').value;
                
                if (!programName) {
                    showAlert('Please select a program', 'error');
                    return;
                }
                
                await aftercareManager.addAftercareOption(clientId, {
                    programName,
                    status,
                    dateProvidedToFamily: dateProvided,
                    notes
                });
                
                showAlert('Aftercare option added successfully', 'success');
                closeModal();
                
                // Refresh the client details
                viewClientDetails(clientId);
                
                // Refresh the table
                await loadHouseView(currentHouseId);
            } catch (error) {
                console.error('Failed to add aftercare option:', error);
                showAlert(error.message || 'Failed to add aftercare option', 'error');
            }
        }
        
        // Edit client
        function editClient(clientId) {
            // This will be implemented
            console.log('Edit client:', clientId);
        }
        
        // Generate document for client
        async function generateClientDocument(clientId, options = {}) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    showAlert('Client not found', 'error');
                    return;
                }

                const contextPayload = {
                    clientId,
                    initials: client.initials || '',
                    kipuId: client.kipuId || null
                };

                window.__pendingProgramsDocsClientContext = contextPayload;

                await mountProgramsDocsModule();

                if (window.CareConnectProgramsDocs?.setClientContext) {
                    await window.CareConnectProgramsDocs.setClientContext(contextPayload);
                }

                window.__pendingProgramsDocsClientContext = null;

                if (window.clientManager?.setCurrentClient) {
                    await window.clientManager.setCurrentClient(clientId);
                }

                localStorage.setItem('currentClientId', clientId);
                switchTab('programs');

                if (options.focusSearch && window.CareConnectProgramsDocs?.focusSearch) {
                    window.CareConnectProgramsDocs.focusSearch();
                }

                if (window.CareConnect?.events) {
                    try {
                        window.CareConnect.events.emit('clients:programs-docs-opened', {
                            clientId,
                            initials: client.initials || ''
                        });
                    } catch (eventError) {
                        console.warn('Programs docs open event failed:', eventError);
                    }
                }

                showAlert(`Programs workspace ready for ${client.initials || 'client'}.`, 'success');
            } catch (error) {
                console.error('Failed to open Programs & Docs for client:', error);
                showAlert('Unable to open Programs & Docs. Please try again.', 'error');
            }
        }
        
        // Export current house
        async function exportCurrentHouse() {
            try {
                const houseData = await housesManager.exportHouseData(currentHouseId);
                const json = JSON.stringify(houseData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${houseData.house.name}_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showAlert('House data exported successfully!', 'success');
            } catch (error) {
                showAlert('Failed to export house data: ' + error.message, 'error');
            }
        }
        
        // Export all data
        function exportAllData() {
            // To be implemented with Excel export
            showAlert('Excel export will be implemented with the Excel export module', 'info');
        }
        
        // Show bulk import
        function showBulkImport() {
            // To be implemented with Excel import
            showAlert('Excel import will be implemented with the Excel import module', 'info');
        }
        
        // Show reports
        function showReports() {
            // To be implemented with reporting module
            showAlert('Reports will be implemented with the reporting module', 'info');
        }
        
        // Toggle milestone completion
        async function toggleMilestone(clientId, milestoneId) {
            try {
                await milestonesManager.toggleMilestone(clientId, milestoneId);
                await loadHouseView(currentHouseId); // Refresh the view
            } catch (error) {
                console.error('Failed to toggle milestone:', error);
                showAlert('Failed to update milestone', 'error');
            }
        }
        
        // Reset database
        async function resetDatabase() {
            if (confirm('This will clear all local data and reload the page. Continue?')) {
                try {
                    await clearIndexedDB();
                    localStorage.clear();
                    localStorage.clear();
                    showAlert('Database cleared. Reloading...', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } catch (error) {
                    showAlert('Failed to reset database: ' + error.message, 'error');
                }
            }
        }
    </script>
    <!-- Initialize Service Worker -->
    <script>
        // Function to clear IndexedDB if needed
        async function clearIndexedDB() {
            try {
                await indexedDB.deleteDatabase('CareConnectPro');
                console.log('Database cleared successfully');
                return true;
            } catch (error) {
                console.error('Failed to clear database:', error);
                return false;
            }
        }

        // Robust login handler
        (function() {
            function initLogin() {
                const forms = document.querySelectorAll('form');
                forms.forEach(form => {
                    const hasPassword = form.querySelector('input[type="password"]');
                    const hasUsername = form.querySelector('input[type="text"], input[name="username"]');
                    
                    if (hasPassword && hasUsername) {
                        // This is the login form
                        form.onsubmit = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const username = hasUsername.value;
                            const password = hasPassword.value;
                            
                            // Validate credentials - DISABLED (use proper handleLogin function)
                            // if ((username === 'MasterAdmin' || username === 'Doc121') && password === 'FFA121') {
                            //     localStorage.setItem('isLoggedIn', 'true');
                            //     localStorage.setItem('username', username);
                            //     localStorage.setItem('userRole', username === 'MasterAdmin' ? 'admin' : 'user');
                            //     location.reload();
                            // } else {
                            //     alert('Invalid username or password');
                            // }
                            
                            // Use the proper handleLogin function instead
                            if (typeof handleLogin === 'function') {
                                const event = { preventDefault: () => {}, target: form };
                                handleLogin(event);
                            } else {
                                alert('Login system not loaded. Please refresh the page.');
                            }
                            
                            return false;
                        };
                        
                        // Also handle button click
                        const submitBtn = form.querySelector('button[type="submit"], button.sign-in-btn, input[type="submit"]');
                        if (submitBtn) {
                            submitBtn.onclick = function(e) {
                                e.preventDefault();
                                form.onsubmit(e);
                                return false;
                            };
                        }
                    }
                });
            }
            
            // Initialize on multiple events to ensure it runs
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLogin);
            } else {
                initLogin();
            }
            
            // Also try on window load as backup
            window.addEventListener('load', initLogin);
        })();


        // Fix login form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Find the login form
            const loginForm = document.querySelector('form');
            if (loginForm && loginForm.querySelector('input[type="password"]')) {
                // Prevent default form submission
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get username and password
                    const username = document.querySelector('input[type="text"]').value;
                    const password = document.querySelector('input[type="password"]').value;
                    
                    // Call the login function
                    if (typeof handleLogin === 'function') {
                        handleLogin(username, password);
                    } else {
                        // Fallback login handling - DISABLED (use proper handleLogin function)
                        alert('Login system not loaded. Please refresh the page and try again.');
                    }
                    
                    return false;
                });
                
                // Also handle button click
                const signInButton = loginForm.querySelector('button[type="submit"]') || 
                                   loginForm.querySelector('.sign-in-btn') ||
                                   loginForm.querySelector('button');
                
                if (signInButton) {
                    signInButton.onclick = function(e) {
                        e.preventDefault();
                        loginForm.dispatchEvent(new Event('submit'));
                        return false;
                    };
                }
            }
        });

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js")
                .then(reg => console.log("Service Worker registered:", reg.scope))
                .catch(err => console.log("Service Worker registration failed:", err));
        }
    </script>
    
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Family First Adolescent Services - Document Creation Tool">
    <meta name="theme-color" content="#0099cc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FFAS Docs">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232196a6'/%3E%3Cpath d='M 20 15 Q 32 12 44 15 L 40 22 Q 32 20 24 22 Q 18 28 18 38 L 26 38 Q 26 32 29 29 Q 32 27 37 28 L 35 33 Q 32 32 30 33 Q 28 35 28 38 L 36 38 Q 36 35 37 33 Q 40 32 44 33 L 42 38 Q 38 37 37 38 Q 36 40 36 45 L 29 45 Q 29 42 26 42 L 18 45 Q 15 32 22 22 Q 26 18 32 15' fill='white'/%3E%3C/svg%3E">
    
    <style>
        /* Modern UI Enhancement Styles - Override Existing */
        
        /* Beautiful Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Override Program Cards for Better Look */
        .program-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%) !important;
            padding: 24px !important;
            border-radius: 16px !important;
            border: 2px solid transparent !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08) !important;
            animation: fadeIn 0.5s ease;
        }
        
        .program-card:hover {
            transform: translateY(-6px) scale(1.02) !important;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.18) !important;
            border-color: #667eea !important;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%) !important;
        }
        
        .program-card.selected {
            background: linear-gradient(135deg, #f0f4ff, #e5edff) !important;
            border: 2px solid #667eea !important;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.28) !important;
            transform: scale(1.02) !important;
        }
        
        /* Beautiful Buttons */
        .btn-primary, button[onclick*="generate"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 14px 28px !important;
            border: none !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            font-size: 15px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .btn-primary:hover, button[onclick*="generate"]:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.45) !important;
        }
        
        .btn-primary:active, button[onclick*="generate"]:active {
            transform: translateY(-1px) !important;
        }
        
        /* Modern Modal Overlay */
        .modal {
            background-color: rgba(0,0,0,0.7) !important;
            backdrop-filter: blur(10px) !important;
            animation: modalFadeIn 0.3s ease !important;
        }
        
        .modal-content {
            border-radius: 20px !important;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3) !important;
            animation: modalSlideIn 0.3s ease !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 25px 30px !important;
            border-radius: 20px 20px 0 0 !important;
        }
        
        .modal-header h2 {
            color: white !important;
            font-weight: 600 !important;
            font-size: 24px !important;
        }
        
        /* Input Field Styling */
        input[type="text"], input[type="email"], input[type="password"], textarea, select {
            padding: 12px 16px !important;
            border-radius: 10px !important;
            border: 2px solid #e5e7eb !important;
            font-size: 15px !important;
            transition: all 0.3s ease !important;
            background: white !important;
        }
        
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            border-color: #667eea !important;
            outline: none !important;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1) !important;
        }
        
        /* Checkbox and Radio Styling */
        input[type="checkbox"], input[type="radio"] {
            width: 20px !important;
            height: 20px !important;
            cursor: pointer !important;
            accent-color: #667eea !important;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46a2);
        }
        
        /* Loading Animation */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        /* Smooth Transitions for All Interactive Elements */
        button, a, input, textarea, select, .card, .panel {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        /* Responsive Design Improvements */
        @media screen and (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }
            
        .main-content {
                flex-direction: column;
            }
            
            .selection-panel {
                width: 100%;
                max-width: 100%;
                border-left: none;
                border-top: 2px solid #e5e7eb;
                margin-top: 20px;
                position: relative;
                top: 0;
            }
            
            .programs-panel {
                max-height: none;
            }
        }
        
        @media screen and (max-width: 768px) {
            .header {
                padding: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 24px !important;
            }
            
            .program-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 95vh;
            }
            
            .wizard-steps {
                gap: 8px;
            }
            
            .wizard-step-indicator {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .btn-primary, button[onclick*="generate"] {
                padding: 12px 20px !important;
                font-size: 14px !important;
            }
            
            .doc-type-buttons {
                flex-direction: column;
            }
            
            .doc-type-btn {
                width: 100%;
            }
        }
        
        @media screen and (max-width: 480px) {
            .programs-panel, .selection-panel {
                padding: 15px;
            }
            
            .program-card {
                padding: 16px !important;
            }
            
            input[type="text"], textarea, select {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            .modal-header {
                padding: 20px !important;
            }
            
            .modal-header h2 {
                font-size: 20px !important;
            }
            
            .wizard-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .wizard-actions button {
                width: 100%;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white !important;
            }
            
            .theme-toggle, .modal, button {
                display: none !important;
            }
            
            .container {
                box-shadow: none !important;
                max-width: 100% !important;
            }
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .program-card {
                border: 3px solid #000 !important;
            }
            
            .btn-primary {
                border: 2px solid #000 !important;
            }
            
            input, textarea, select {
                border: 2px solid #000 !important;
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Additional Polish */
        .guided-btn {
            background: linear-gradient(135deg, #34d399, #059669) !important;
            color: white !important;
            font-weight: 600 !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 14px 24px !important;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .guided-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 10px 28px rgba(5, 150, 105, 0.4) !important;
        }
        
        .wizard-back {
            background: #e5e7eb !important;
            color: #374151 !important;
        }
        
        .wizard-back:hover {
            background: #d1d5db !important;
        }
        
        .wizard-next {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: white !important;
        }
        
        .wizard-next:hover {
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4) !important;
        }
        
        .wizard-finish {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
        }
        
        .wizard-finish:hover {
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4) !important;
        }
        
        /* Fix overlapping elements */
        .selection-panel {
            z-index: 10;
            visibility: visible !important;
        }

        .parent-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04) !important;
            margin-bottom: 24px !important;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .parent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .parent-card:hover {
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.12) !important;
            transform: translateY(-4px);
            border-color: #cbd5e1 !important;
        }
        
        .parent-card:hover::before {
            transform: scaleX(1);
        }

        .parent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .parent-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .org-badge {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .expand-icon {
            font-size: 14px;
            color: #1d4ed8;
            transition: transform 0.2s ease;
        }

        .parent-expand-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: rgba(59, 130, 246, 0.08);
            color: #1d4ed8;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .parent-expand-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.35);
        }

        .parent-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .parent-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 13px;
            color: #475569;
            margin-bottom: 10px;
        }
        
        .parent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }
        
        .parent-tag {
            background: rgba(59, 130, 246, 0.08);
            color: #3b82f6;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(59, 130, 246, 0.15);
        }
        
        .parent-stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            font-size: 13px;
            color: #64748b;
        }
        
        .parent-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .parent-stat-icon {
            color: #3b82f6;
            font-weight: bold;
        }
        
        /* Interactive Profile Modal - Enhanced */
        .program-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            z-index: 10000;
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .program-profile-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .profile-container {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 100px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            animation: modalSlideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center bottom;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 32px 40px;
            position: relative;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15);
        }
        
        .profile-navigation {
            position: absolute;
            top: 24px;
            left: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .profile-back-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .profile-back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(-2px);
        }
        
        .profile-breadcrumb {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .profile-close {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05) rotate(90deg);
        }
        
        .profile-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 50px;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
        }
        
        .profile-subtitle {
            font-size: 16px;
            opacity: 0.95;
            display: flex;
            gap: 20px;
            align-items: center;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;
        }
        
        .profile-body {
            padding: 40px;
            overflow-y: auto;
            flex: 1;
            background: linear-gradient(to bottom, #ffffff 0%, #fafbfc 100%);
        }
        .profile-section {
            margin-bottom: 40px;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both;
        }
        .profile-section-title {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid transparent;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }
        
        .profile-section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 2px;
            animation: slideInLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.4s both;
        }
        
        .profile-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        }
        
        .profile-info-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .profile-info-item:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .profile-info-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        .profile-info-value {
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
        }
        
        .profile-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }
        
        .profile-feature {
            padding: 18px 20px;
            background: white;
            border-left: 4px solid transparent;
            background: linear-gradient(to right, white, white),
                        linear-gradient(135deg, #6366f1, #8b5cf6);
            background-clip: padding-box, border-box;
            background-origin: border-box;
            border: 1px solid transparent;
            border-left-width: 4px;
            border-radius: 12px;
            font-size: 15px;
            color: #334155;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        
        .profile-feature:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
        }

        .profile-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .profile-tag {
            background: rgba(59, 130, 246, 0.12);
            color: #1d4ed8;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .profile-overview-text {
            font-size: 15px;
            color: #1f2937;
            line-height: 1.6;
            background: #f8fafc;
            border-radius: 10px;
            padding: 16px 18px;
        }

        .profile-subprogram-section {
            margin-top: 10px;
        }

        .profile-subprogram-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .profile-subprogram-item {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .profile-subprogram-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-subprogram-item:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.1);
            border-color: #cbd5e1;
        }
        
        .profile-subprogram-item:hover::before {
            transform: scaleY(1);
        }

        .profile-subprogram-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .profile-subprogram-meta {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .profile-subprogram-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .profile-subprogram-actions button {
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }

        .profile-view-btn {
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
        }

        .profile-add-btn-inline {
            background: #10b981;
            color: white;
        }

        .profile-add-btn-inline.selected {
            background: #ef4444;
        }
        
        /* Loading state */
        .profile-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        .profile-loading.active {
            display: block;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .profile-container {
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
            }
            
            .profile-header {
                padding: 24px;
            }
            
            .profile-body {
                padding: 24px;
            }
            
            .profile-title {
                font-size: 24px;
            }
            
            .profile-features {
                grid-template-columns: 1fr;
            }
            
            .profile-info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .profile-actions {
            padding: 20px 30px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .profile-add-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 14px 36px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .profile-add-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .profile-add-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }
        
        .profile-add-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .profile-add-btn.added {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .profile-contact-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .profile-contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .profile-contact-icon {
            color: #667eea;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideUp {
            from { 
                transform: translateY(40px) scale(0.95);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                width: 0;
                opacity: 0;
            }
            to {
                width: 60px;
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .parent-overview {
            font-size: 14px;
            color: #334155;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .parent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .parent-tag {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .sub-programs-container {
            margin-top: 16px;
            display: grid;
            gap: 12px;
        }

        .sub-program-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .sub-program-card:hover {
            border-color: #2563eb;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.15);
        }

        .sub-program-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .sub-program-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .sub-program-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .sub-program-info {
            font-size: 13px;
            color: #475569;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .sub-program-badge {
            background: #f1f5f9;
            color: #0f172a;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .sub-program-features {
            margin: 0;
            padding-left: 18px;
            font-size: 12px;
            color: #4b5563;
        }

        .sub-program-features li {
            margin-bottom: 4px;
        }

        .sub-program-toggle {
            border: 1px solid #bfdbfe;
            background: #e0f2fe;
            color: #1d4ed8;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sub-program-toggle:hover {
            border-color: #2563eb;
            background: #dbeafe;
        }

        .sub-program-toggle.selected {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }

        .programs-panel {
            z-index: 5;
        }

        .header {
            z-index: 20;
        }
        
        /* Ensure text is readable */
        h1, h2, h3, h4, h5, h6 {
            line-height: 1.4;
            margin-bottom: 0.5em;
        }
        
        p {
            line-height: 1.6;
            margin-bottom: 1em;
        }
        
        /* Better focus states */
        a:focus, button:focus, input:focus, textarea:focus, select:focus {
            outline: 3px solid rgba(102, 126, 234, 0.5) !important;
            outline-offset: 2px;
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.95) 0%, rgba(147, 51, 234, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            animation: fadeIn 0.3s ease;
        }
        
        .loading-spinner {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 0 100px rgba(147, 51, 234, 0.3);
            min-width: 400px;
            max-width: 500px;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Modern Circular Progress */
        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 25px;
        }
        
        .progress-ring-circle {
            fill: transparent;
            stroke: #e5e7eb;
            stroke-width: 8;
        }
        
        .progress-ring-circle-progress {
            fill: transparent;
            stroke: url(#gradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
            transition: stroke-dashoffset 0.35s;
        }
        
        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Status Text */
        .loading-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .loading-status {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
            min-height: 40px;
        }
        
        .status-detail {
            font-size: 12px;
            color: #9ca3af;
            font-style: italic;
            margin-top: 4px;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Steps Indicator */
        .loading-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .loading-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .loading-step::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .loading-step.active::before {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }
        
        .loading-step.completed::before {
            background: #10b981;
        }
        
        .loading-step-label {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .loading-step.active .loading-step-label {
            color: #4f46e5;
            font-weight: 600;
        }
        
        /* Beautiful Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .notification-message {
            font-size: 14px;
            opacity: 0.95;
        }
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.5);
            animation: notificationProgress 3s linear;
        }
        @keyframes notificationProgress {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        /* Old spinner for backwards compatibility */
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0099cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    

        /* Enhanced Features CSS */
        .client-switcher {
            margin-bottom: 20px;
        }
        
        .natural-language-search {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .natural-language-search:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .filter-suggestions {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .smart-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .smart-preset {
            padding: 6px 12px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .smart-preset:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .match-score {
            display: inline-block;
            padding: 2px 8px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .data-quality-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }
        
        .data-quality-high { background: #10b981; }
        .data-quality-medium { background: #f59e0b; }
        .data-quality-low { background: #ef4444; }

    

        /* Map System Styles */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        .leaflet-popup-content {
            margin: 12px !important;
        }
        
        .program-marker {
            transition: transform 0.2s;
        }
        
        .program-marker:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        
        /* Custom map controls */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        .leaflet-control-zoom a {
            background: white !important;
            color: #374151 !important;
            border: none !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: #f3f4f6 !important;
        }
    </style>
    <style>
        /* Tab Navigation Styles */
        .tab-navigation {
            display: none !important;
            visibility: hidden !important;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tab-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .tab-btn.active {
            background: #6366f1;
            color: white;
            font-weight: 600;
        }
        
        .tab-btn.active:hover {
            background: #4f46e5;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Hide selection panel when dashboard is active */
        #dashboardTab.active ~ * .selection-panel,
        #dashboardTab.active ~ .selection-panel,
        body:has(#dashboardTab.active) .selection-panel,
        body:has(#dashboardTab.active) [class*="selection-panel"],
        body:has(#dashboardTab.active) aside:has-text("GENERATE DOCUMENT"),
        #dashboardTab.active ~ * aside {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Ensure dashboard gets full width */
        body:has(#dashboardTab.active) .main-content {
            grid-template-columns: 1fr !important;
        }
        
        /* Dashboard Styles */
        .dashboard-container {
            padding: 20px;
            background: #f9fafb;
            min-height: calc(100vh - 200px);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .dashboard-greeting {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
        }
        
        .dashboard-subtitle {
            font-size: 16px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .dashboard-headline {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 260px;
        }
        
        .dashboard-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            color: #6b7280;
        }
        
        .dashboard-view-toggle {
            display: inline-flex;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .dashboard-view-toggle button {
            padding: 8px 18px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        
        .dashboard-view-toggle button.active {
            background: #111827;
            color: white;
        }
        
        /* Make dashboard content wider so more information fits horizontally */
        body.dashboard-active .main-content {
            max-width: 1400px;
        }
        
        .dashboard-main-grid {
            margin-top: 24px;
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
            gap: 20px;
        }
        
        .dashboard-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .dashboard-empty-banner {
            margin-top: 12px;
            padding: 16px 20px;
            border: 1px dashed #d1d5db;
            border-radius: 12px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        
        .dashboard-empty-banner h4 {
            margin: 0 0 6px 0;
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }
        
        .dashboard-empty-banner p {
            margin: 0;
            color: #6b7280;
            font-size: 14px;
        }
        
        .banner-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .banner-actions button {
            border: none;
            border-radius: 999px;
            padding: 8px 18px;
            font-weight: 600;
            cursor: pointer;
            background: #111827;
            color: #fff;
        }
        
        .banner-actions button.ghost {
            background: #f3f4f6;
            color: #111827;
        }
        
        .dashboard-quick-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 280px;
        }
        
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .quick-actions__row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .quick-actions__btn {
            flex: 1;
            min-width: 120px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #fff;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            color: #111827;
            cursor: pointer;
        }
        
        .quick-actions__btn span {
            font-size: 20px;
        }
        
        .quick-actions__btn small {
            font-size: 12px;
            color: #6b7280;
        }
        
        .coach-schedule-widget .schedule-section {
            margin-bottom: 16px;
        }
        
        .schedule-section__title {
            font-size: 13px;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }
        
        .schedule-item {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }
        
        .schedule-item__main {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #111827;
        }
        
        .schedule-client {
            background: #111827;
            color: white;
            border-radius: 8px;
            padding: 2px 8px;
            font-size: 12px;
        }
        
        .schedule-item__meta {
            margin-top: 6px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: #6b7280;
        }
        
        .schedule-action {
            border: none;
            background: #6366f1;
            color: white;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .schedule-date {
            font-size: 13px;
            color: #6b7280;
        }
        
        @media (max-width: 1024px) {
            .dashboard-header {
                flex-direction: column;
            }
            
            .dashboard-main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Widget base styles */
        .dashboard-widget {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .widget-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .widget-skeleton {
            height: 200px;
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        .widget-empty {
            padding: 32px 24px;
            text-align: center;
            border: 1px dashed #d1d5db;
            border-radius: 16px;
            background: rgba(249, 250, 251, 0.9);
            color: #6b7280;
            font-size: 14px;
            line-height: 1.4;
        }

        .widget-empty p {
            margin: 0;
        }

        .widget-empty__action {
            margin-top: 12px;
            padding: 8px 18px;
            border-radius: 999px;
            border: none;
            background: #6366f1;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .widget-empty__action:hover {
            transform: translateY(-1px);
        }

        .widget-empty.widget-empty--inline {
            padding: 20px;
            margin: 12px 0;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Priority zones */
        .priority-zones {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .priority-zone {
            background: #f9fafb;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .zone-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
        }
        
        .zone-header:hover {
            background: #f3f4f6;
        }
        
        .zone-icon {
            font-size: 18px;
            margin-right: 12px;
        }
        
        .zone-title {
            flex: 1;
            font-weight: 500;
            color: #374151;
        }
        
        .zone-count {
            background: #374151;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .zone-red .zone-count { background: #ef4444; }
        .zone-purple .zone-count { background: #8b5cf6; }
        .zone-yellow .zone-count { background: #f59e0b; }
        .zone-green .zone-count { background: #10b981; }
        
        .zone-toggle {
            color: #6b7280;
            font-size: 12px;
        }
        
        .zone-content {
            padding: 0 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .zone-content.expanded {
            max-height: 500px;
            padding-bottom: 16px;
        }
        
        .priority-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .client-badge {
            display: inline-block;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            width: fit-content;
        }
        
        .item-message {
            font-size: 14px;
            color: #111827;
        }
        
        .due-date {
            font-size: 12px;
            color: #6b7280;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-action, .btn-quick-complete {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-action {
            background: #6366f1;
            color: white;
        }
        
        .btn-action:hover {
            background: #4f46e5;
        }
        
        .btn-quick-complete {
            background: white;
            color: #10b981;
            border: 1px solid #10b981;
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-quick-complete:hover {
            background: #10b981;
            color: white;
        }
        
        /* House weather cards */
        .house-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .house-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .house-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .house-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .weather-icon {
            font-size: 24px;
        }
        
        .house-name {
            font-weight: 600;
            color: #111827;
            flex: 1;
        }
        
        .trend {
            font-size: 14px;
            font-weight: 600;
        }
        
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #6b7280; }
        
        .house-score {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .score-value {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
        }
        
        .score-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        .house-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .client-count {
            color: #6b7280;
        }
        
        .issue-count {
            color: #ef4444;
            font-weight: 500;
            cursor: pointer;
        }
        
        .no-issues {
            color: #10b981;
            font-weight: 500;
        }
        
        /* Journey radar */
        .journey-timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .journey-segment {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .journey-segment.has-clients:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .segment-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .segment-count {
            font-size: 24px;
            font-weight: 600;
        }
        
        .segment-green { color: #10b981; }
        .segment-yellow { color: #f59e0b; }
        .segment-blue { color: #3b82f6; }
        .segment-orange { color: #f97316; }
        .segment-purple { color: #8b5cf6; }
        .segment-gray { color: #6b7280; }
        
        .journey-segment.critical-stage {
            border: 2px solid #fbbf24;
            background: #fef3c7;
        }
        
        .critical-indicator {
            margin-left: 4px;
            font-size: 16px;
        }
        
        .segment-connector {
            color: #d1d5db;
            font-size: 20px;
        }
        
        .segment-detail {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        /* Segment client list modal */
        .segment-clients-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .segment-client-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .segment-client-item:hover {
            background: #f9fafb;
        }
        
        .segment-client-item .client-initials {
            font-weight: 600;
            margin-right: 8px;
        }
        
        .segment-client-item .client-house {
            color: #6b7280;
            margin-right: 8px;
        }
        
        .segment-client-item .client-info {
            flex: 1;
            color: #6b7280;
        }
        
        .segment-client-item .status-indicator {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-indicator.urgent {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        .metric-item {
            text-align: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .metric-label {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .metric-detail {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .trend-indicator {
            font-size: 16px;
            font-weight: 600;
        }
        
        .trend-positive { color: #10b981; }
        .trend-negative { color: #ef4444; }
        
        /* Quick actions */
        .actions-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: #f9fafb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .action-icon {
            font-size: 20px;
        }
        
        .action-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* Responsive design */
        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        @media (min-width: 1280px) {
            .dashboard-grid {
                grid-template-columns: 3fr 2fr;
            }
        }
    </style>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
            background: #f5f6ff;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0.85;
            z-index: -1;
        }

        .container {
            max-width: 100%;
            margin: calc(var(--app-shell-total-header, 128px) + 20px) auto 60px;
            padding: 32px;
            background: white;
            min-height: calc(100vh - var(--app-shell-total-header, 128px) - 80px);
            border-radius: 28px;
            box-shadow: 0 25px 60px rgba(102, 126, 234, 0.25);
            overflow: hidden;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .demo-btn.active {
            background: #fbbf24;
            color: #1f2937;
            border-color: #f59e0b;
        }
        
        .demo-btn.active:hover {
            background: #f59e0b;
        }
        
        .demo-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #fbbf24;
            color: #1f2937;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
            z-index: 10000;
            display: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
            }
            50% {
                box-shadow: 0 4px 20px rgba(251, 191, 36, 0.8);
            }
            100% {
                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
            }
        }

        .main-content {
            display: grid !important;
            grid-template-columns: 1fr 440px; /* left: programs, right: controls */
            gap: 20px;
            min-height: 600px;
            position: relative;
            align-items: start;
            visibility: visible !important;
        }
        
        /* Dashboard-specific layout override */
        .dashboard-active .main-content {
            display: block !important;
            grid-template-columns: none !important;
        }
        
        .dashboard-active .selection-panel {
            display: none !important;
        }
        
        .dashboard-active .programs-panel {
            max-width: 100% !important;
            width: 100% !important;
        }
        
        .programs-panel {
            padding: 30px;
            overflow-y: auto;
            background: #ffffff;
            max-height: 85vh;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 1;
        }
        
        .selection-panel {
            width: 440px;
            min-width: 440px;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 20px;
            display: none; /* Hidden by default - only show for Programs tab */
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 12px;
            position: sticky;
            top: 10px;
            height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 10;
        }
        
        .document-type-selector {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .doc-type-buttons {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .doc-type-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #0099cc;
            background: white;
            color: #0099cc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .doc-type-btn.active {
            background: #0099cc;
            color: white;
        }

        .guided-btn {
            width: 100%;
            margin-bottom: 20px;
            padding: 12px 18px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #34d399, #059669);
            color: white;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .guided-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(5, 150, 105, 0.35);
        }

        .guided-btn:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .wizard-actions button {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .wizard-actions .wizard-back {
            background: #e5e7eb;
            color: #374151;
        }

        .wizard-actions .wizard-next {
            background: #4f46e5;
            color: white;
        }

        .wizard-actions .wizard-finish {
            background: #059669;
            color: white;
        }

        .wizard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .wizard-card {
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.08);
        }

        .wizard-program-list {
            display: grid;
            gap: 10px;
            max-height: 260px;
            overflow-y: auto;
        }

        .wizard-program-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
            transition: border-color 0.2s ease;
        }

        .wizard-program-item input[type="checkbox"] {
            margin-top: 4px;
            transform: scale(1.1);
        }

        .wizard-program-item.active {
            border-color: #4f46e5;
            box-shadow: 0 4px 14px rgba(79, 70, 229, 0.18);
            background: #eef2ff;
        }

        .wizard-program-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .wizard-program-meta .name {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-program-meta .location {
            font-size: 12px;
            color: #4b5563;
        }

        .wizard-program-meta .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .wizard-program-meta .chip {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .wizard-toggles {
            display: grid;
            gap: 10px;
        }

        .wizard-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
        }

        .wizard-toggle span {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-note {
            font-size: 13px;
            color: #4b5563;
            background: #ecfeff;
            border-left: 4px solid #0891b2;
            padding: 12px 14px;
            border-radius: 8px;
        }

        .wizard-no-results {
            text-align: center;
            padding: 30px 20px;
            color: #6b7280;
            font-size: 14px;
            border: 1px dashed #cbd5f5;
            border-radius: 10px;
            background: #f8fafc;
        }

        .input-error {
            border-color: #f87171 !important;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2) !important;
        }

        .document-preview-modal {
            max-width: 95%;
            width: 900px;
        }

        /* Document preview container - clean and simple */
        #documentPreviewContainer {
            background: white;
            margin: 0 auto;
            padding: 40px 60px;
            box-sizing: border-box;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        /* Ensure all document styles apply in preview */
        #documentPreviewContainer .doc-page {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        #documentPreviewContainer .doc-content {
            padding-bottom: 40px;
        }
        
        #documentPreviewContainer .doc-footer {
            position: relative;
            bottom: auto;
            margin-top: 40px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media screen and (max-width: 900px) {
            #documentPreviewContainer {
                padding: 20px 30px;
            }
        }
        
        .client-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .client-info h3 {
            color: #0c4a6e;
            margin-bottom: 14px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .client-info input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            margin-bottom: 0;
            font-family: -apple-system, 'Calibri', Arial, sans-serif;
            font-size: 15px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .client-info input:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        /* Checkbox specific styles */
        #includeAtHome {
            accent-color: #0099cc;
            transform: scale(1.1);
            margin-right: 2px;
        }
        
        #includeAtHome:hover {
            transform: scale(1.2);
        }
        
        .search-container {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
        }
        
        .search-box {
            width: 100%;
            padding: 14px 18px;
            padding-right: 120px; /* Space for button */
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        .search-indicator {
            display: none;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .add-program-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            background: linear-gradient(45deg, #0099cc, #00b4d8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 153, 204, 0.3);
            z-index: 10;
        }
        
        .add-program-btn.show {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .add-program-btn:hover {
            background: linear-gradient(45deg, #0088bb, #00a3c7);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 153, 204, 0.4);
        }
        
        .add-program-btn:active {
            transform: translateY(-50%) scale(0.98);
        }
        
        .search-animation {
            animation: searchPulse 2s infinite;
        }
        
        @keyframes searchPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .add-animation {
            animation: addSuccess 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes addSuccess {
            0% { transform: translateY(-50%) scale(1); }
            20% { transform: translateY(-50%) scale(1.2) rotate(5deg); }
            40% { transform: translateY(-50%) scale(0.9) rotate(-3deg); }
            60% { transform: translateY(-50%) scale(1.1) rotate(2deg); }
            80% { transform: translateY(-50%) scale(0.95) rotate(-1deg); }
            100% { transform: translateY(-50%) scale(1) rotate(0deg); }
        }
        
        .filter-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .filter-btn:hover {
            border-color: #0099cc;
            color: #0099cc;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .filter-btn.active {
            background: #0099cc;
            color: white;
            border-color: #0099cc;
            box-shadow: 0 2px 8px rgba(0,153,204,0.2);
        }
        
        .program-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            padding: 0;
            margin-top: 15px;
        }
        
        .program-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .program-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #cbd5e1;
        }
        
        .program-card.primary {
            border-color: #0099cc;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            box-shadow: 0 4px 12px rgba(0,153,204,0.15);
        }
        
        .program-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            background: #0099cc;
        }
        
        .program-name {
            font-weight: bold;
            font-size: 15px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .program-location {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .program-type {
            display: inline-block;
            padding: 2px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            margin-top: 5px;
        }
        
        .program-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #0099cc;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            z-index: 2;
            transition: all 0.3s;
        }
        
        .program-info-btn:hover {
            background: #0077aa;
            transform: scale(1.1);
        }
        
        .selected-section {
            flex: 0 1 auto;
            min-height: 120px;
            margin-bottom: 10px;
        }
        
        .section-title {
            font-weight: 600;
            margin: 20px 0 16px 0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            color: #1e40af;
            border-left: 4px solid #0099cc;
        }
        
        .selected-program {
            background: white;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            font-size: 13px;
            cursor: move;
            transition: all 0.3s;
        }
        
        .selected-program.dragging {
            opacity: 0.5;
            background: #f0f8ff;
        }
        
        .selected-program.drag-over {
            border-top: 3px solid #0099cc;
        }
        
        .drag-handle {
            cursor: move;
            color: #999;
            margin-right: 8px;
            font-size: 16px;
        }
        
        .program-order-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .order-btn {
            background: #0099cc;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .order-btn:hover {
            background: #0077aa;
        }
        
        .order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #0099cc, #0077aa);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,153,204,0.3);
            width: 100%;
            letter-spacing: 0.5px;
            min-height: 44px;
            max-height: 44px;
        }
        
        .generate-btn:hover {
            background: linear-gradient(135deg, #0077aa, #005588);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,153,204,0.4);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        .generate-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .instructions {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
            border: 1px solid #fbbf24;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(251,191,36,0.1);
        }
        
        .instructions h3 {
            color: #92400e;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .instructions ul {
            margin-left: 20px;
            color: #78350f;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .instructions ul li {
            margin-bottom: 6px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 15px;
            font-style: italic;
            font-size: 13px;
        }
        
        #selectedList {
            min-height: 80px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 10px;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }

        body.dark-mode .panel {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .program-card {
            background: #252538;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .program-card:hover {
            background: #2a2a3e;
            border-color: #4a4a5e;
        }

        body.dark-mode .program-card.selected {
            background: #2a3f5f;
            border-color: #3498db;
        }

        body.dark-mode input[type="text"],
        body.dark-mode select {
            background: #252538;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        body.dark-mode .modal-content {
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: static;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 999px;
            padding: 8px 14px;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: inherit;
            box-shadow: none;
        }
        
        .theme-toggle:hover,
        .theme-toggle:focus-visible {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.55);
        }
        
        body.dark-mode .theme-toggle {
            border-color: rgba(255, 255, 255, 0.35);
            color: #f3f4ff;
        }

        /* Comparison View Styles */
        .comparison-view {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            overflow: hidden;
        }

        .comparison-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-content {
            display: flex;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .comparison-column {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #ddd;
        }

        .comparison-column:last-child {
            border-right: none;
        }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .quick-action-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        body.dark-mode .quick-action-btn {
            background: #252538;
            border-color: #3a3a4e;
            color: #e0e0e0;
        }

        body.dark-mode .quick-action-btn:hover {
            background: #2a2a3e;
        }

        /* Document History Panel */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        
        .history-panel.active {
            display: block;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .history-item:hover {
            background: #f5f5f5;
        }

        body.dark-mode .history-panel {
            background: #1a1a2e;
        }

        body.dark-mode .history-item {
            border-bottom-color: #2a2a3e;
        }

        body.dark-mode .history-item:hover {
            background: #252538;
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .analytics-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .analytics-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #6366f1;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 80%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: #0099cc;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            position: relative;
            z-index: 1001;
            padding: 5px;
            line-height: 1;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            color: #f0f0f0;
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            min-height: 0; /* Important for flex children */
        }
        
        .preview-section {
            margin-bottom: 20px;
        }
        
        .preview-section h3 {
            color: #0099cc;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        
        .preview-features {
            list-style: none;
            padding: 0;
        }
        
        .preview-features li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .preview-features li strong {
            color: #333;
        }
        
        .preview-contact {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        
        .preview-contact div {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .modal-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .add-from-preview {
            background: #0099cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-from-preview:hover {
            background: #0077aa;
        }
        
        .add-from-preview.selected {
            background: #dc3545;
        }
        
        /* Print Styles - Professional Clean Document */
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .main-content { flex-direction: column; }
            .programs-panel, .selection-panel { width: 100%; max-width: 100%; }
            .program-grid { grid-template-columns: 1fr; }
            .filter-buttons, .quick-actions { flex-wrap: wrap; }
            .history-panel { width: 100%; }
            .comparison-view { width: 95%; }
            .comparison-content { flex-direction: column; }
        }
        
        @media print {
            @page {
                size: letter;
                margin: 1in 0.75in 1in 0.75in; /* Top, Right, Bottom, Left - content width ~6.5" */
            }
            
            /* Hide ALL UI elements during print */
            .theme-toggle,
            .history-panel,
            .comparison-view,
            .analytics-dashboard,
            .container,
            .modal,
            .quick-actions,
            #historyPanel,
            #comparisonView,
            #analyticsDashboard {
                display: none !important;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .container {
                display: none !important;
            }
            
            .document-output {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                color: black;
                font-family: Helvetica, Arial, "Segoe UI", sans-serif;
                font-size: 11pt;
                line-height: 1.6;
            }
            
            .doc-page {
                position: relative;
                width: 100%;
                padding: 0;
                page-break-inside: avoid;
                overflow: visible; /* ensure header image not clipped */
            }
            
            /* Hide web elements completely */
            .modal, .program-info-btn, .program-badge {
                display: none !important;
            }
        }
        
        /* Document output styles */
        .document-output {
            display: none;
            font-family: Helvetica, Arial, "Segoe UI", sans-serif;
            font-size: 11pt; /* Body size 11-12pt as specified */
            line-height: 1.6;
            color: #000;
        }
        
        .doc-page {
            background: white;
            position: relative;
            min-height: 100%;
            overflow: visible; /* allow header graphics to render fully */
            width: 720px; /* 7.5 inches of usable space at 96 DPI */
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .doc-content {
            padding-bottom: 100px; /* More space for footer to prevent overlap */
            padding-top: 0; /* Remove top padding */
            margin-top: 0;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: calc(100vh - 150px); /* Ensure proper page height */
        }
        
        /* Letterhead Header */
        .doc-letterhead {
            text-align: center;
                            margin-bottom: 20px;
            padding-bottom: 0;
                            margin-top: 0;
                            padding-top: 0;
                        }
                        .letterhead-image {
                            width: 100%;
                            max-width: 100%;
                            height: auto;
                            margin: 0 auto;
                            display: block;
        }
        
        .doc-letterhead-logo {
            height: 80px !important; /* fixed visual height to avoid partial decode/cropping */
            width: auto !important;
            max-width: 160px !important;
            margin: 0 auto 15px !important;
            display: block !important;
            object-fit: contain !important;
            object-position: center center !important;
            /* Ensure image loads properly in print */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .doc-logo {
            width: 200px;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }
        
        .doc-letterhead-lockup {
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }
        
        .doc-letterhead-icon {
            width: 40px;
            height: 40px;
            background: #0099cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        
        .doc-letterhead-text {
            text-align: center;
        }
        
        .doc-letterhead-text h1 {
            font-size: 24pt;
            color: #0099cc;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        
        .doc-letterhead-text p {
            font-size: 12pt;
            color: #000000;
            margin: 2px 0 0 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        /* Document Body */
        .doc-greeting {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: normal;
            margin-bottom: 8px;
        }
        
        .doc-intro {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-style: italic;
            text-decoration: underline;
            margin-bottom: 18pt;
            line-height: 1.4;
        }
        
        /* Section headers - CALIBRI 10PT BOLD (e.g., "Aftercare Options:") */
        .doc-section-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            margin: 18pt 0 14pt 0;
            text-align: left;
        }
        
        /* Category headers - CALIBRI 9PT BOLD (e.g., "PHP Options") */
        .doc-category-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: bold;
            margin: 14pt 0 10pt 0;
        }
        
        /* Program Cards */
        .doc-program {
            margin-bottom: 24pt; /* Two blank lines between programs */
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        /* Program title line with en dash - MUST BE CALIBRI 10PT BOLD */
        .doc-program-title {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            color: #000;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        /* Level of Care & Services section - MUST BE SINGLE PARAGRAPH, CALIBRI 9PT */
        .doc-program-descriptor {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-top: 12pt;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        .doc-program-descriptor strong {
            font-weight: bold;
        }
        
        /* Program Details heading - CALIBRI 9PT BOLD */
        .doc-program-details-heading {
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-size: 9pt;
            margin-bottom: 6pt;
            margin-top: 12pt;
        }
        
        /* Bullet lists - REAL BULLETS, CALIBRI 9PT */
        .doc-program-bullets {
            margin: 0 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-program-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-bottom: 4pt;
            position: relative;
            padding-left: 15px;
            line-height: 1.4;
        }
        
        .doc-program-bullets li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
        }
        
        /* Bold concept introductions in bullets */
        .doc-program-bullets li strong {
            font-weight: bold;
        }
        
        /* Sub-bullets with dashes */
        .doc-sub-bullets {
            margin: 4pt 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-sub-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            margin-bottom: 2pt;
            position: relative;
            padding-left: 15px;
        }
        
        .doc-sub-bullets li:before {
            content: "‚Äì";
            position: absolute;
            left: 0;
        }
        
        /* Contact Information block - CALIBRI 9PT */
        .doc-contact-section {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            line-height: 1.4;
            margin-top: 6pt;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .doc-contact-section strong {
            font-weight: bold;
        }
        
        .doc-contact-section a {
            word-break: break-all;
            color: #0066cc;
            text-decoration: none;
        }
        
        .doc-contact-section a:hover {
            text-decoration: underline;
        }
        
        /* Footer - stacked format */
        .doc-footer {
            position: fixed;
            bottom: 20px;
            left: 50px;
            right: 50px;
            text-align: center;
            font-size: 10pt;
            color: #333;
            background: white;
            padding: 15px 10px 10px 10px;
            border-top: 1px solid #ccc;
            z-index: 1000;
            box-shadow: 0 -2px 5px rgba(255,255,255,0.9);
            line-height: 1.4;
        }
        
        .doc-footer div {
            margin: 2px 0;
        }
        
        /* Mini card styles for AT HOME sections */
        .doc-mini-card {
            margin-bottom: 18pt;
            padding: 12pt;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafbfc;
        }
        .doc-mini-title {
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 8pt;
            color: #374151;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 4pt;
        }
        .doc-mini-blurb {
            font-size: 10pt;
            margin-bottom: 8pt;
            min-height: 24pt;
            border-bottom: 1px dotted #9ca3af;
            padding-bottom: 4pt;
            color: #6b7280;
        }
        
        .doc-mini-contact {
            font-size: 10pt;
            color: #374151;
        }
        
        .doc-mini-contact .contact-line {
            display: flex;
            align-items: center;
            margin-bottom: 4pt;
        }
        
        .doc-mini-contact .contact-label {
            font-weight: 600;
            min-width: 70px;
            color: #1f2937;
        }
        
        .doc-mini-contact .contact-fill {
            flex: 1;
            border-bottom: 1px solid #d1d5db;
            min-height: 16pt;
            margin-left: 8px;
        }
        
        /* Special emphasis for AT HOME Recommendation */
        .doc-emphasis-section {
            font-family: Calibri, Arial, sans-serif;
            font-size: 10pt;
            font-style: italic;
            text-decoration: underline;
        }
        
        /* Print-specific styles for blank lines */
        @media print {
            .doc-mini-title, .doc-mini-blurb, .doc-mini-contact {
                min-height: 1.2em;
            }
            
            .doc-footer {
                position: fixed;
                bottom: 0.5in;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 10pt;
                color: #333;
                background: white;
                padding: 10px 0;
                z-index: 100;
            }
            
            .doc-content {
                padding-bottom: 80px; /* More space for fixed footer */
            }
        }
        
        /* Delete button for custom programs */
        .program-delete-btn {
            position: absolute;
            top: 8px;
            right: 38px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: all 0.2s ease;
            z-index: 10;
            opacity: 0.8;
        }
        
        .program-delete-btn:hover {
            opacity: 1;
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .program-delete-btn:active {
            transform: scale(0.95);
        }
        
        /* Login Form Styles */
        .login-content .form-group {
            margin-bottom: 20px;
        }
        
        .login-content .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }
        
        .login-content .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .login-content .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-content .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-content .login-btn:hover {
            transform: translateY(-2px);
        }
        
        /* User Profile Button */
        .user-profile-btn {
            position: static;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6e7bff 0%, #8b5cf6 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(110, 123, 255, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-profile-btn:hover,
        .user-profile-btn:focus-visible {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(110, 123, 255, 0.45);
        }
        
        .user-profile-btn:active {
            transform: translateY(0);
        }
        
        /* User Menu Dropdown */
        .user-menu {
            position: fixed;
            top: 96px;
            right: 32px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 999;
            animation: slideDown 0.2s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Welcome Animation */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            animation: overlayFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: opacity, transform;
        }
        
        .welcome-overlay.fade-out {
            animation: overlayFadeOut 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes overlayFadeIn {
            from { 
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to { 
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }
        
        @keyframes overlayFadeOut {
            0% { 
                opacity: 1;
                backdrop-filter: blur(10px);
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                backdrop-filter: blur(5px);
                transform: scale(1.01);
            }
            100% { 
                opacity: 0;
                backdrop-filter: blur(0px);
                transform: scale(1.05);
            }
        }
        
        .welcome-message {
            color: white;
            text-align: center;
            animation: messageSlideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center center;
            will-change: transform, opacity;
        }
        
        .welcome-message.fade-out {
            animation: messageFadeDown 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .welcome-message h1 {
            font-size: 48px;
            margin: 0 0 15px 0;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.1);
            background: linear-gradient(90deg, #fff, rgba(255,255,255,0.8), #fff);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shimmerText 3s ease-in-out infinite;
        }
        
        .welcome-message p {
            font-size: 24px;
            margin: 0 0 30px 0;
            opacity: 0.95;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        @keyframes shimmerText {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }
        
        @media (max-width: 768px) {
            .welcome-message h1 {
                font-size: 32px;
            }
            
            .welcome-message p {
                font-size: 18px;
                margin: 0 0 20px 0;
            }
            
            .welcome-progress {
                width: 150px;
            }
        }
        
        .welcome-progress {
            width: 200px;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .welcome-progress-bar {
            height: 100%;
            background: white;
            border-radius: 3px;
            animation: progressFill 2.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        @keyframes messageSlideUp {
            0% {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            60% {
                opacity: 1;
                transform: translateY(-5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes messageFadeDown {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
        }
        
        @keyframes progressFill {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: #1a202c;
        }
        
        .user-username {
            font-size: 13px;
            color: #718096;
        }
        
        /* Landing Page Responsive Styles */
        @media (min-width: 768px) {
            .landing-left {
                display: block !important;
            }
            .mobile-branding {
                display: none !important;
            }
        }
        
        @media (max-width: 767px) {
            .landing-left {
                display: none !important;
            }
            .mobile-branding {
                display: block !important;
            }
            #loginScreen > div > div:last-child {
                flex: 1 1 100% !important;
                max-width: 100% !important;
            }
        }
        
        /* Enhanced input focus styles for ClearHive branding */
        #loginUsername:focus, #loginPassword:focus {
            outline: none;
            border-color: #0891b2 !important;
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1) !important;
        }
        
        /* Login button hover effect */
        .login-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(8, 145, 178, 0.4) !important;
        }
        
        .login-btn:active {
            transform: translateY(-1px) !important;
        }
        
        /* User Menu Dropdown Styles */
        .user-menu {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 240px;
            z-index: 10001;
            overflow: hidden;
            animation: slideDown 0.2s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-menu-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .user-menu-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .user-menu-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-menu-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-menu-username {
            font-size: 13px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-menu-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 8px 0;
        }
        
        .user-menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            font-size: 14px;
            color: #1a202c;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .user-menu-item:hover {
            background: #f7fafc;
        }
        
        .user-menu-item:active {
            background: #edf2f7;
        }
        
        .user-menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* User profile button styles */
        .user-profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .user-profile-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .user-profile-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    
    <!-- AUTO-LOGIN DISABLED FOR PRODUCTION -->
    <script>
        // Disabled: do not auto-login in production
        (function(){ /* intentionally empty */ })();
    </script>
    <!-- END AUTO-LOGIN (DISABLED) -->
    
    
                <!-- LEGACY MAP TOGGLE BUTTON REMOVED - Non-functional, used old purple gradient -->
    
    <!-- Login Screen -->
    <div id="loginScreen" class="auth-screen">
        <div class="auth-orb auth-orb--1"></div>
        <div class="auth-orb auth-orb--2"></div>
        <div class="auth-orb auth-orb--3"></div>

        <div class="auth-shell">
            <section class="auth-panel auth-panel--left">
                <header class="auth-brand">
                    <div class="auth-brand-text">
                        <div class="auth-brand-parent">ClearHive Health</div>
                        <div class="auth-brand-product">CareConnect</div>
                        <div class="auth-brand-org">for Family First Adolescent Services</div>
                    </div>
                    <img src="images/file.svg" alt="Family First" class="auth-logo" />
                </header>

                <div class="auth-copy">
                    <h1 class="auth-title">Clinician Workspace</h1>
                    <p class="auth-subtitle">
                        A secure space for therapists, case managers, and clinical coaches to manage
                        aftercare planning and documentation.
                    </p>
                    <ul class="auth-bullets">
                        <li>Build discharge and aftercare packets in minutes</li>
                        <li>Track aftercare planning tasks in one view</li>
                        <li>Keep documentation consistent across the team</li>
                    </ul>
                </div>

                <footer class="auth-footnote">
                    <p class="auth-footnote-main">
                        üîí All data stays on this device. CareConnect stores no PHI or full names.
                    </p>
                    <p class="auth-footnote-sub">
                        Internal use only ¬∑ Family First Adolescent Services
                    </p>
                </footer>
            </section>

            <section class="auth-panel auth-panel--right">
                <div class="auth-card">
                    <header class="auth-card-header">
                        <h2>Sign in to CareConnect</h2>
                        <p>
                            Use your assigned CareConnect credentials.<br>
                            This login is for Family First clinical staff only.
                        </p>
                    </header>
                
                    <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                        <div id="loginError" class="auth-alert" role="alert"></div>

                        <div class="auth-field">
                            <label for="loginUsername">Username</label>
                            <input
                                id="loginUsername"
                                name="username"
                                type="text"
                                autocomplete="username"
                                placeholder="e.g. cmolina"
                                required
                            >
                        </div>
                        
                        <div class="auth-field">
                            <label for="loginPassword">Password</label>
                            <input
                                id="loginPassword"
                                name="password"
                                type="password"
                                autocomplete="current-password"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                required
                            >
                        </div>
                        
                        <div class="auth-form-row">
                            <label class="auth-remember">
                                <input type="checkbox" id="rememberMe">
                                <span>Remember me on this device</span>
                            </label>
                            <button type="button" class="auth-link" onclick="alert('If you forgot your password, contact your supervisor or IT admin.');">
                                Forgot password?
                            </button>
                        </div>
                        
                        <button type="submit" class="auth-submit-btn">
                            Enter workspace
                        </button>

                        <p class="auth-small-print">
                            By signing in you confirm you are an authorized member of the Family First clinical team
                            and agree to follow all HIPAA and privacy policies.
                        </p>
                    </form>

                    <div class="auth-support">
                        <div class="auth-support-label">Need access?</div>
                        <p>
                            New to CareConnect or locked out of your account?<br>
                            Please contact your supervisor or designated CareConnect admin.
                        </p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" style="display: none;">
    <header class="app-header" id="appHeader" aria-label="CareConnect workspace navigation">
        <div class="app-header__top">
            <button type="button"
                    class="app-header__icon-btn app-header__menu-btn"
                    id="appNavToggle"
                    aria-label="Open navigation"
                    aria-controls="appNavDrawer"
                    aria-expanded="false">
                ‚ò∞
            </button>
            <div class="app-header__brand">
                <div class="app-header__brand-mark">CC</div>
                <div class="app-header__brand-text">
                    <strong>CareConnect</strong>
                    <span class="app-header__brand-subtitle">Family First Adolescent Services</span>
                </div>
            </div>
            <div class="app-header__top-actions">
                <button type="button"
                        class="app-header__icon-btn"
                        id="workspaceToolsButton"
                        aria-label="Open workspace tools"
                        aria-expanded="false"
                        aria-haspopup="true"
                        onclick="toggleMenu()">
                    ‚ãÆ
                </button>
                <button type="button"
                        class="app-header__icon-btn"
                        id="appHelpButton"
                        aria-label="Open help and shortcuts"
                        onclick="showHelp()">
                    ?
                </button>
                <button class="theme-toggle" type="button" onclick="toggleTheme()" aria-label="Toggle dark mode">
                    <span id="themeIcon">üåô</span>
                    <span class="app-header__action-label" id="themeText">Dark Mode</span>
                </button>
                <button class="user-profile-btn"
                        type="button"
                        onclick="toggleUserMenu()"
                        id="userProfileBtn"
                        title="User Profile"
                        aria-haspopup="true"
                        aria-expanded="false">
                    <span id="userInitials">?</span>
                </button>
            </div>
        </div>
        <div class="app-header__section" id="appSectionHeader"></div>
    </header>
    
    <!-- User Menu Dropdown -->
    <div id="userMenu" class="user-menu" style="display: none;" role="menu" aria-label="User menu">
        <div class="user-menu-header">
            <div class="user-menu-avatar" id="userMenuInitials">?</div>
            <div class="user-menu-info">
                <div class="user-menu-name" id="userMenuName">User</div>
                <div class="user-menu-username" id="userMenuUsername">@username</div>
            </div>
        </div>
        <div class="user-menu-divider"></div>
        <button type="button" class="user-menu-item" onclick="handleLogout()" role="menuitem">
            <span class="user-menu-icon">üö™</span>
            <span>Sign Out</span>
        </button>
    </div>
    
    <div class="app-drawer-overlay" id="appNavOverlay" tabindex="-1" aria-hidden="true"></div>
    <nav class="app-drawer" id="appNavDrawer" aria-hidden="true" aria-label="Primary navigation">
        <div class="app-drawer__header">
            <p class="app-drawer__title">Navigate</p>
            <div class="app-drawer__product">CareConnect</div>
            <button type="button" class="app-drawer__close" id="appNavClose" aria-label="Close navigation">√ó</button>
        </div>
        <div class="app-drawer__body">
            <button type="button" class="app-drawer__item" data-nav-target="dashboard">
                <span class="app-drawer__icon">üéØ</span>
                <span>Dashboard</span>
            </button>
            <button type="button" class="app-drawer__item" data-nav-target="programs">
                <span class="app-drawer__icon">üìë</span>
                <span>Programs &amp; Docs</span>
            </button>
            <button type="button" class="app-drawer__item" data-nav-target="clients">
                <span class="app-drawer__icon">üë•</span>
                <span>Clients</span>
            </button>
            <button type="button" class="app-drawer__item app-drawer__item--admin" data-nav-target="admin" data-admin-only="true" style="display:none;">
                <span class="app-drawer__icon">‚öôÔ∏è</span>
                <span>Admin Command Center</span>
            </button>
        </div>
    </nav>
    <script>
        (function() {
            const state = {
                header: document.getElementById('appHeader'),
                section: document.getElementById('appSectionHeader'),
                navDrawer: document.getElementById('appNavDrawer'),
                navOverlay: document.getElementById('appNavOverlay'),
                navToggle: document.getElementById('appNavToggle'),
                navClose: document.getElementById('appNavClose'),
                activeSection: null,
                lastFocus: null
            };

            const templates = {
                dashboard: `
                    <div class="section-header__content">
                        <div>
                            <p class="section-eyebrow">Coach overview</p>
                            <div class="section-header__title">Dashboard</div>
                        </div>
                        <div class="section-status">Live updates</div>
                    </div>
                    <div class="section-header__actions">
                        <button type="button" class="section-chip is-primary" data-demo-only="true" onclick="window.populateDemoClients && window.populateDemoClients(50)">Populate Demo Data</button>
                        <button type="button" class="section-chip" onclick="window.refreshDashboard && window.refreshDashboard(true)">Refresh</button>
                        <button type="button" class="section-chip" onclick="window.showSelectionPanel && window.showSelectionPanel()">Show Docs Panel</button>
                    </div>
                `,
                clients: `
                    <div class="section-header__content">
                        <div>
                            <p class="section-eyebrow">Client workspace</p>
                            <div class="section-header__title">Clients</div>
                        </div>
                        <div class="section-status">Roster sync enabled</div>
                    </div>
                    <div class="section-header__actions">
                        <button type="button" class="section-chip" onclick="window.refreshClientsList && window.refreshClientsList()">Refresh</button>
                        <button type="button" class="section-chip is-primary" onclick="window.showAddClientModal && window.showAddClientModal()">New Client</button>
                    </div>
                `,
                'programs-loading': `
                    <div class="section-header__content">
                        <div>
                            <p class="section-eyebrow">Programs workspace</p>
                            <div class="section-header__title">Programs &amp; Docs</div>
                        </div>
                        <div class="section-status">Loading latest module‚Ä¶</div>
                    </div>
                `,
                'programs-error': `
                    <div class="section-header__content">
                        <div>
                            <p class="section-eyebrow">Programs workspace</p>
                            <div class="section-header__title">Programs &amp; Docs</div>
                        </div>
                        <div class="section-status">Module unavailable. Try again.</div>
                    </div>
                    <div class="section-header__actions">
                        <button type="button" class="section-chip is-primary" onclick="window.mountProgramsDocsModule && window.mountProgramsDocsModule(true)">Retry</button>
                    </div>
                `,
                'programs': `
                    <!-- Programs section uses its own toolbar, so hide this header -->
                `,
                'admin': `
                    <div class="section-header__content">
                        <div>
                            <p class="section-eyebrow">Administration</p>
                            <div class="section-header__title">Command Center</div>
                        </div>
                        <div class="section-status">Admin access required</div>
                    </div>
                    <div class="section-header__actions">
                        <button type="button" class="section-chip" onclick="window.featureFlags && window.featureFlags.showPanel()">Feature Flags</button>
                        <button type="button" class="section-chip" onclick="window.refreshAdminAnalytics && window.refreshAdminAnalytics()">Refresh</button>
                    </div>
                `,
                default: `
                    <div class="section-header__content">
                        <div>
                            <p class="section-eyebrow">Workspace</p>
                            <div class="section-header__title">CareConnect</div>
                        </div>
                        <div class="section-status">Ready</div>
                    </div>
                `
            };
            const drawerFocusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';

            function updateTopOffset() {
                const topRow = state.header?.querySelector('.app-header__top');
                if (topRow) {
                    const height = Math.round(topRow.getBoundingClientRect().height);
                    document.documentElement.style.setProperty('--app-shell-top-offset', `${height}px`);
                }
                if (state.header) {
                    const totalHeight = Math.round(state.header.getBoundingClientRect().height);
                    document.documentElement.style.setProperty('--app-shell-total-header', `${totalHeight}px`);
                }
            }

            function setSectionState(section) {
                if (!state.section) return;
                state.activeSection = section;
                const templateKey = templates[section] ? section : 'default';
                const bodySection = section || 'default';
                document.body.dataset.ccSection = bodySection;
                document.body.classList.toggle('cc-section-programs', section === 'programs');
                state.section.dataset.section = bodySection;

                if (section === 'programs') {
                    state.section.classList.add('is-hidden');
                    state.section.innerHTML = '';
                } else {
                    state.section.innerHTML = templates[templateKey];
                    state.section.classList.remove('is-hidden');
                }

                updateTopOffset();
            }

            function setActiveNavItem(target) {
                const buttons = state.navDrawer?.querySelectorAll('[data-nav-target]');
                if (!buttons) return;
                buttons.forEach(btn => {
                    const isMatch = btn.getAttribute('data-nav-target') === target;
                    btn.classList.toggle('is-active', isMatch);
                });
            }

            function openNav() {
                document.body.classList.add('app-nav-open');
                state.navDrawer?.setAttribute('aria-hidden', 'false');
                state.navOverlay?.setAttribute('aria-hidden', 'false');
                state.navToggle?.setAttribute('aria-expanded', 'true');
                state.lastFocus = document.activeElement;
                setTimeout(() => {
                    const firstItem = state.navDrawer?.querySelector('[data-nav-target]');
                    firstItem?.focus();
                }, 10);
            }

            function closeNav() {
                document.body.classList.remove('app-nav-open');
                state.navDrawer?.setAttribute('aria-hidden', 'true');
                state.navOverlay?.setAttribute('aria-hidden', 'true');
                state.navToggle?.setAttribute('aria-expanded', 'false');
                state.lastFocus?.focus?.();
            }

            function toggleNav() {
                if (document.body.classList.contains('app-nav-open')) {
                    closeNav();
                } else {
                    openNav();
                }
            }

            state.navToggle?.addEventListener('click', toggleNav);
            state.navClose?.addEventListener('click', closeNav);
            state.navOverlay?.addEventListener('click', closeNav);

            state.navDrawer?.addEventListener('click', (event) => {
                const target = event.target.closest('[data-nav-target]');
                if (!target) return;
                const tab = target.getAttribute('data-nav-target');
                if (tab) {
                    if (typeof window.switchTab === 'function') {
                        window.switchTab(tab);
                    } else {
                        console.warn('switchTab not available yet, will retry...');
                        setTimeout(() => {
                            if (typeof window.switchTab === 'function') {
                                window.switchTab(tab);
                            } else {
                                console.error('switchTab still not available');
                            }
                        }, 100);
                    }
                }
                closeNav();
            });

            state.navDrawer?.addEventListener('keydown', (event) => {
                if (event.key !== 'Tab' || !document.body.classList.contains('app-nav-open')) {
                    return;
                }
                const focusableItems = state.navDrawer.querySelectorAll(drawerFocusableSelector);
                if (!focusableItems.length) return;
                const first = focusableItems[0];
                const last = focusableItems[focusableItems.length - 1];
                if (!event.shiftKey && document.activeElement === last) {
                    event.preventDefault();
                    first.focus();
                } else if (event.shiftKey && document.activeElement === first) {
                    event.preventDefault();
                    last.focus();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeNav();
                } else if ((event.ctrlKey || event.metaKey) && (event.key === 'm' || event.key === 'M')) {
                    event.preventDefault();
                    toggleNav();
                }
            });

            window.addEventListener('resize', () => window.requestAnimationFrame(updateTopOffset));

            window.ccShell = {
                setSectionState,
                setActiveNavItem,
                openNav,
                closeNav,
                toggleNav,
                updateTopOffset
            };

            const initialTab = localStorage.getItem('lastActiveTab') || 'programs';
            setActiveNavItem(initialTab);
            setSectionState(initialTab === 'programs' ? 'programs-loading' : initialTab);
            window.__pendingInitialTab = initialTab;
            updateTopOffset();
        })();
    </script>
    <script>
        window.toggleMenu = window.toggleMenu || function toggleMenu(forceState) {
            const menu = document.getElementById('slideMenu');
            const overlay = document.getElementById('menuOverlay');
            const toolsButton = document.getElementById('workspaceToolsButton');
            if (!menu || !overlay) return;
            const shouldOpen = typeof forceState === 'boolean'
                ? forceState
                : !menu.classList.contains('active');
            menu.classList.toggle('active', shouldOpen);
            overlay.classList.toggle('active', shouldOpen);
            document.body.classList.toggle('tools-menu-open', shouldOpen);
            if (toolsButton) {
                toolsButton.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
            }
        };

        // History panel toggle (document history drawer)
        window.toggleHistory = window.toggleHistory || function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            if (!panel) return;
            panel.classList.toggle('active');
            panel.classList.toggle('open');
            // When opened, refresh contents if helper exists
            if (panel.classList.contains('open') && typeof updateHistoryPanel === 'function') {
                try {
                    updateHistoryPanel().catch?.(console.error);
                } catch (err) {
                    console.error('Error updating history panel:', err);
                }
            }
        };

        // Close comparison view panel
        window.closeComparison = window.closeComparison || function closeComparison() {
            const view = document.getElementById('comparisonView');
            if (view) {
                view.style.display = 'none';
            }
        };
    </script>
    
    <!-- User Menu Dropdown -->
    <div class="user-menu" id="userMenu" style="display: none;">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">?</div>
            <div class="user-details">
                <div class="user-name" id="displayFullName">User</div>
                <div class="user-username" id="displayUsername">@username</div>
            </div>
        </div>
        <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">
        <button onclick="logout()" style="width: 100%; padding: 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
            üö™ Logout
        </button>
    </div>
    
    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>Document History</h3>
            <button onclick="toggleHistory()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div id="historyContent"></div>
    </div>
    
    <!-- Comparison View -->
    <div class="comparison-view" id="comparisonView">
        <div class="comparison-header">
            <h3>Program Comparison</h3>
            <button onclick="closeComparison()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
        </div>
        <div class="comparison-content" id="comparisonContent"></div>
    </div>
    
    <!-- Slide-out Menu -->
    <div id="slideMenu" class="slide-menu">
        <div class="menu-header">
            <h3>Menu</h3>
            <button class="close-menu" onclick="toggleMenu()">√ó</button>
        </div>
        <div class="menu-content">
            <div class="menu-section">
                <h4>Tools</h4>
                <button class="menu-item" onclick="showTemplates(); toggleMenu();">
                    <span class="menu-icon">üìã</span>
                    <span>Templates</span>
                </button>
                <button class="menu-item" onclick="showAnalytics().catch(console.error); toggleMenu();">
                    <span class="menu-icon">üìä</span>
                    <span>Analytics</span>
                </button>
                <button class="menu-item" onclick="showHelp(); toggleMenu();">
                    <span class="menu-icon">‚ùì</span>
                    <span>Help & Shortcuts</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Data</h4>
                <button class="menu-item" onclick="exportData(); toggleMenu();">
                    <span class="menu-icon">üì§</span>
                    <span>Export Data</span>
                </button>
                <button class="menu-item" onclick="importData(); toggleMenu();">
                    <span class="menu-icon">üì•</span>
                    <span>Import Data</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Program Database</h4>
                <button class="menu-item" onclick="openProgramManager(); toggleMenu();">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <span>Manage Programs</span>
                </button>
            </div>
            <div class="menu-section">
                <h4>Actions</h4>
                <button class="menu-item" onclick="saveAsTemplate(); toggleMenu();">
                    <span class="menu-icon">üíæ</span>
                    <span>Save as Template</span>
                </button>
                <button class="menu-item" onclick="clearAllPrograms(); toggleMenu();">
                    <span class="menu-icon">üóëÔ∏è</span>
                    <span>Clear All Programs</span>
                </button>
            </div>
        </div>
    </div>
    
    <style>
        .slide-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        
        .slide-menu.active {
            right: 0;
        }
        
        .menu-header {
            background: #0099cc;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close-menu {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-content {
            padding: 20px;
        }
        
        .menu-section {
            margin-bottom: 30px;
        }
        
        .menu-section h4 {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .menu-item {
            width: 100%;
            padding: 12px 15px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .menu-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* Dark mode styles for menu */
        body.dark-mode .slide-menu {
            background: #2a2a2a;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .menu-header {
            background: #1a1a2a;
        }
        
        body.dark-mode .menu-section h4 {
            color: #999;
            border-color: #444;
        }
        
        body.dark-mode .menu-item {
            background: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .menu-item:hover {
            background: #404040;
        }
        
        /* Menu overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 9998;
        }
        
        .menu-overlay.active {
            display: block;
        }

        :root {
            --app-shell-top-offset: 72px;
            --app-shell-header-z: 120;
        }

        .app-header {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            z-index: var(--app-shell-header-z, 120);
            background: rgba(15, 16, 32, 0.95);
            color: #f8fbff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
            box-shadow: 0 12px 32px rgba(15, 16, 32, 0.32);
        }

        .app-header__top {
            display: flex;
            align-items: center;
            gap: 18px;
            min-height: 64px;
            padding: 14px clamp(16px, 3vw, 36px);
        }

        .app-header__brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-header__brand-mark {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #6e7bff, #c9ceff);
            color: #0f1020;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.08em;
        }

        .app-header__brand-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .app-header__brand-text strong {
            font-size: 1rem;
            letter-spacing: 0.04em;
        }

        .app-header__brand-subtitle {
            font-size: 0.76rem;
            opacity: 0.7;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        .app-header__top-actions {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .app-header__icon-btn {
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.08);
            color: inherit;
            border-radius: 999px;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .app-header__icon-btn:hover,
        .app-header__icon-btn:focus-visible {
            background: rgba(255, 255, 255, 0.22);
            border-color: rgba(255, 255, 255, 0.45);
            transform: translateY(-1px);
        }

        .app-header__menu-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 1.3rem;
            background: rgba(255, 255, 255, 0.12);
        }

        .app-header__action-label {
            font-size: 0.8rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .app-header__section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px clamp(16px, 3vw, 36px) 14px;
            background: rgba(24, 26, 60, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .app-header__section.is-hidden {
            display: none;
        }

        .section-header__content {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .section-eyebrow {
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            font-size: 0.7rem;
            opacity: 0.65;
        }

        .section-header__title {
            margin: 2px 0 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .section-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
        }

        .section-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8d97ff;
            animation: pulse 1.2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.7; }
        }

        .section-header__actions {
            display: inline-flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-chip {
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 999px;
            padding: 6px 14px;
            background: transparent;
            color: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .section-chip:hover,
        .section-chip:focus-visible {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.12);
        }

        .section-chip.is-primary {
            background: linear-gradient(135deg, #6e7bff, #8b5cf6);
            border-color: transparent;
            color: #0f1020;
        }

        .app-drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 12, 32, 0.55);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: calc(var(--app-shell-header-z, 120) + 5);
        }

        .app-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            max-width: 86vw;
            height: 100vh;
            background: #0f1020;
            color: #f7f8ff;
            box-shadow: 8px 0 30px rgba(5, 7, 20, 0.6);
            transform: translateX(-105%);
            transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: calc(var(--app-shell-header-z, 120) + 10);
            display: flex;
            flex-direction: column;
        }

        .app-drawer__header {
            padding: 22px 24px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .app-drawer__title {
            margin: 0;
            font-size: 0.85rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            opacity: 0.6;
        }

        .app-drawer__product {
            margin: 6px 0 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .app-drawer__body {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .app-drawer__item {
            border: none;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.04);
            color: inherit;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s ease, transform 0.2s ease;
            text-align: left;
        }

        .app-drawer__item:hover,
        .app-drawer__item:focus-visible {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(4px);
        }

        .app-drawer__item.is-active {
            background: linear-gradient(135deg, rgba(110, 123, 255, 0.28), rgba(110, 123, 255, 0.18));
            border: 1px solid rgba(110, 123, 255, 0.45);
        }

        .app-drawer__icon {
            font-size: 1.2rem;
            width: 28px;
            text-align: center;
        }

        .app-drawer__close {
            margin-left: auto;
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: transparent;
            color: inherit;
            border-radius: 10px;
            width: 38px;
            height: 38px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .app-drawer__close:hover,
        .app-drawer__close:focus-visible {
            background: rgba(255, 255, 255, 0.12);
        }

        body.app-nav-open .app-drawer {
            transform: translateX(0);
        }

        body.app-nav-open .app-drawer-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        @media (max-width: 768px) {
            .app-header__top {
                flex-wrap: wrap;
                padding: 12px 18px;
            }

            .app-header__top-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .app-header__action-label {
                display: none;
            }

            .app-header__section {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        /* ============= DASHBOARD STYLES ============= */
        .tab-navigation {
            display: none !important;
            visibility: hidden !important;
        }

        body.tab-nav-fallback .tab-navigation {
            display: none !important;
            visibility: hidden !important;
        }

        .tab-btn {
            padding: 12px 24px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn:hover {
            background: #e0e0e0;
            border-color: #999;
        }

        .tab-btn.active {
            background: #0099cc;
            color: white;
            border-color: #0099cc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Admin Command Center Styles */
        .admin-command-center {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .admin-header {
            margin-bottom: 30px;
        }
        
        .admin-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 8px 0;
        }
        
        .admin-subtitle {
            color: #6b7280;
            font-size: 16px;
            margin: 0;
        }
        
        .admin-sections {
            display: grid;
            gap: 24px;
        }
        
        .admin-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }
        
        .admin-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 12px 0;
        }
        
        .admin-section p {
            color: #6b7280;
            font-size: 14px;
            margin: 0 0 16px 0;
        }
        
        .admin-btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .admin-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .admin-btn.primary {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .admin-btn.primary:hover {
            background: #4f46e5;
        }
        
        .admin-btn.warning {
            background: #fef3c7;
            color: #92400e;
            border-color: #fcd34d;
        }
        
        .admin-btn.warning:hover {
            background: #fde68a;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .analytics-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .analytics-value {
            font-size: 32px;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 4px;
        }
        
        .analytics-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }
        
        .admin-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .system-info {
            background: #f8fafc;
            border-radius: 10px;
            padding: 16px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row span:first-child {
            color: #64748b;
            font-weight: 500;
        }
        
        .info-row span:last-child {
            color: #1f2937;
            font-weight: 600;
        }

        /* Flight Plan Widget */
        .priority-zones {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .priority-zone {
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        .zone-red {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .zone-purple {
            border-color: #6f42c1;
            background: #f8f5ff;
        }

        .zone-yellow {
            border-color: #ffc107;
            background: #fffef5;
        }

        .zone-green {
            border-color: #28a745;
            background: #f5fff8;
        }

        .zone-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 600;
            background: rgba(255,255,255,0.5);
        }

        .zone-icon {
            font-size: 20px;
        }

        .zone-title {
            flex: 1;
            color: #333;
        }

        .zone-count {
            background: rgba(0,0,0,0.1);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .zone-toggle {
            font-size: 12px;
            color: #666;
        }

        .zone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .zone-content.expanded {
            max-height: 2000px;
        }

        .priority-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .priority-item:last-child {
            border-bottom: none;
        }

        .priority-item-content {
            flex: 1;
        }

        .priority-item-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .priority-item-subtitle {
            font-size: 13px;
            color: #666;
        }

        .priority-item-action {
            padding: 6px 12px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .priority-item-action:hover {
            background: #0077aa;
        }

        .empty-zone {
            padding: 20px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        /* House Weather Widget */
        .house-card {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .house-card:hover {
            border-color: #0099cc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .house-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .weather-icon {
            font-size: 24px;
        }

        .house-name {
            flex: 1;
            font-weight: 600;
            font-size: 18px;
            color: #1a1a1a;
        }

        .house-score {
            text-align: center;
            margin: 12px 0;
        }

        .score-value {
            font-size: 36px;
            font-weight: bold;
            color: #0099cc;
        }

        .score-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .house-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        /* Metrics Widget */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .metric-card {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
        }

        /* Missions Widget */
        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mission-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #0099cc;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .mission-item.completed {
            background: #f0fdf4;
            border-left-color: #22c55e;
            opacity: 0.8;
        }
        
        .mission-item .mission-content {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            flex: 1;
        }
        
        .mission-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #22c55e;
            transition: transform 0.2s ease;
        }
        
        .mission-checkbox:checked {
            transform: scale(1.1);
        }
        
        .mission-task.task-complete {
            text-decoration: line-through;
            color: #6b7280;
        }
        
        .progress-circle {
            display: inline-flex;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin: 0 2px;
            border: 2px solid #e5e7eb;
            color: #9ca3af;
            background: white;
            transition: all 0.3s ease;
        }
        
        .progress-circle.completed {
            border-color: #22c55e;
            background: #22c55e;
            color: white;
        }
        
        @keyframes missionComplete {
            0% {
                transform: translateX(0);
                background: #f8f9fa;
            }
            50% {
                transform: translateX(5px);
                background: #dcfce7;
            }
            100% {
                transform: translateX(0);
                background: #f0fdf4;
            }
        }

        /* Health Bar Styles */
        .health-bar-container {
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .health-bar {
            flex: 1;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        .health-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,255,255,0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s ease-out infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .score-text {
            font-weight: 700;
            font-size: 18px;
            min-width: 45px;
            text-align: right;
        }
        
        .house-card.score-excellent .health-bar-fill {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }
        
        .house-card.score-good .health-bar-fill {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }
        
        .house-card.score-fair .health-bar-fill {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .house-card.score-critical .health-bar-fill {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        
        .house-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .house-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        /* Zone Content Styling */
        .zone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .zone-content.expanded {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Quick Actions Widget */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .quick-action-button {
            padding: 16px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .quick-action-button:hover {
            border-color: #0099cc;
            background: #e6f7ff;
            transform: translateY(-2px);
        }

        .quick-action-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .quick-action-label {
            font-weight: 600;
            color: #1a1a1a;
        }
    </style>
    
    <!-- Menu Overlay -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>
    
    <div class="container">
        <div class="main-content">
            <!-- Left Panel: Program List -->
            <div class="programs-panel">
                
                <!-- Tab Navigation - Hidden (using drawer navigation instead) -->
                <div class="tab-navigation" style="display: none !important;">
                    <button class="tab-btn" data-tab-target="dashboard" onclick="window.switchTab && window.switchTab('dashboard')">
                        <span>üéØ Dashboard</span>
                    </button>
                    <button class="tab-btn active" data-tab-target="programs" onclick="window.switchTab && window.switchTab('programs')">
                        <span>üìë Programs &amp; Docs</span>
                    </button>
                    <button class="tab-btn" data-tab-target="clients" onclick="window.switchTab && window.switchTab('clients')">
                        <span>üë• Clients</span>
                    </button>
                </div>
                
                <!-- Dashboard Tab Content -->
                <div id="dashboardTab" class="tab-content">
                    <div class="dashboard-container">
                        <div class="dashboard-header">
                            <div class="dashboard-headline">
                                <div class="dashboard-greeting" id="dashboardGreeting">Good morning</div>
                                <div class="dashboard-subtitle" id="dashboardSubtitle">Here's your morning priorities</div>
                                <div class="dashboard-meta">
                                    <span id="coachIndicator">Coach: --</span>
                                    <span id="lastUpdateTime">Last updated: --</span>
                                </div>
                                <div class="dashboard-view-toggle">
                                    <button class="active" data-view="myClients" onclick="window.setDashboardView && window.setDashboardView('myClients')">My Clients</button>
                                    <button data-view="allClients" onclick="window.setDashboardView && window.setDashboardView('allClients')">All Clients</button>
                                </div>
                            </div>
                            <div id="quickActionsWidget" class="dashboard-quick-actions"></div>
                        </div>

                        <div id="dashboardEmptyState" class="dashboard-empty-banner" style="display: none;">
                            <div class="banner-copy">
                                <h4>No clients yet</h4>
                                <p>Load sample data or add your first client to unlock Coach Mission Control.</p>
                            </div>
                            <div class="banner-actions">
                                <button class="ghost" data-demo-only="true" onclick="window.populateDemoClients && window.populateDemoClients(40)">Load sample data</button>
                                <button onclick="window.showAddClientModal && window.showAddClientModal()">Add client</button>
                            </div>
                        </div>

                        <div class="dashboard-main-grid">
                            <div class="dashboard-column dashboard-column--primary">
                                <div id="flightPlanWidget" class="dashboard-widget widget-flight-plan"></div>
                            </div>
                            <div class="dashboard-column dashboard-column--secondary">
                                <div id="journeyRadarWidget" class="dashboard-widget widget-journey"></div>
                                <div id="coachScheduleWidget" class="dashboard-widget widget-schedule"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                    // Tab switching function - make globally available
                    window.switchTab = function switchTab(tab) {
                        try {
                            console.log('Switching to tab:', tab);
                            console.trace('Tab switch called from:');
                            
                            // Don't block manual tab switches - only auto-switches at load
                            // if (window.blockTabSwitches && tab !== 'clients' && tab !== 'dashboard') {
                            //     console.warn('üõë BLOCKED tab switch to:', tab);
                            //     return;
                            // }
                            
                            // Update shell UI
                            if (window.ccShell?.setActiveNavItem) {
                                window.ccShell.setActiveNavItem(tab);
                            }
                            if (tab === 'programs' && window.ccShell?.setSectionState) {
                                window.ccShell.setSectionState('programs-loading');
                            } else if (window.ccShell?.setSectionState) {
                                window.ccShell.setSectionState(tab);
                            }
                            
                            // Remove active class from all tabs and buttons, and hide them
                            document.querySelectorAll('.tab-content').forEach(t => {
                                if (t) {
                                    t.classList.remove('active');
                                    // Explicitly hide inactive tabs
                                    if (t.id !== tab + 'Tab') {
                                        t.style.display = 'none';
                                    }
                                }
                            });
                            document.querySelectorAll('.tab-btn').forEach(b => {
                                if (b) b.classList.remove('active');
                            });
                            
                            // Add active class to selected tab and ensure it's visible
                            const tabElement = document.getElementById(tab + 'Tab');
                            if (tabElement) {
                                tabElement.classList.add('active');
                                // Explicitly show the active tab
                                tabElement.style.display = 'block';
                                tabElement.style.visibility = 'visible';
                                tabElement.style.opacity = '1';
                                console.log('Activated tab:', tab + 'Tab');
                            } else {
                                console.warn('Tab element not found:', tab + 'Tab');
                            }
                            
                            // Add active class to corresponding button
                            const tabButtons = document.querySelectorAll('.tab-btn');
                            tabButtons.forEach(btn => {
                                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tab)) {
                                    btn.classList.add('active');
                                    console.log('Activated button for:', tab);
                                }
                            });
                            
                            // Special handling for dashboard tab
                            if (tab === 'dashboard') {
                                // Add class to body for dashboard-specific styles
                                document.body.classList.add('dashboard-active');
                                
                                // Force dashboard tab to be visible
                                if (tabElement) {
                                    tabElement.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important; position: relative !important; z-index: 9999 !important;';
                                    console.log('‚úÖ Forced dashboard tab visibility');
                                }
                                
                                // Ensure dashboard container exists and is visible before rendering
                                const dashboardContainer = document.querySelector('.dashboard-container');
                                if (dashboardContainer) {
                                    dashboardContainer.style.display = 'block';
                                    dashboardContainer.style.visibility = 'visible';
                                    dashboardContainer.style.opacity = '1';
                                    dashboardContainer.style.background = '#f8f9fa';
                                    dashboardContainer.style.color = '#1a1a1a';
                                }
                                
                                // Ensure body is visible
                                document.body.style.display = 'block';
                                document.body.style.visibility = 'visible';
                                document.body.style.opacity = '1';
                                if (document.body.classList.contains('programs-docs-v2-active')) {
                                    document.body.style.background = '';
                                    document.body.style.color = '';
                                } else {
                                    document.body.style.background = 'white';
                                    document.body.style.color = '#1a1a1a';
                                }
                                
                                // Initialize dashboard if not already done
                                setTimeout(() => {
                                    // Double-check tab is visible
                                    if (tabElement) {
                                        tabElement.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important; position: relative !important; z-index: 9999 !important;';
                                    }
                                    
                                    if (window.dashboardManager) {
                                        if (!window.dashboardManager.initialized) {
                                            initializeDashboard();
                                        } else {
                                            // Re-render widgets if already initialized - ensure containers exist first
                                            const widgetContainers = [
                                                'flightPlanWidget',
                                                'journeyRadarWidget',
                                                'coachScheduleWidget',
                                                'quickActionsWidget'
                                            ];
                                            
                                            const allContainersExist = widgetContainers.every(id => {
                                                const container = document.getElementById(id);
                                                return container !== null;
                                            });
                                            
                                            if (allContainersExist && window.dashboardWidgets && window.dashboardWidgets.renderAll) {
                                                window.dashboardWidgets.renderAll().then(() => {
                                                    console.log('‚úÖ Dashboard widgets re-rendered');
                                                }).catch(error => {
                                                    console.error('‚ùå Failed to re-render widgets:', error);
                                                    // Re-initialize if render fails
                                                    if (window.dashboardWidgets && window.dashboardWidgets.initialize) {
                                                        window.dashboardWidgets.initialize().then(() => {
                                                            return window.dashboardWidgets.renderAll();
                                                        }).catch(console.error);
                                                    }
                                                });
                                            } else {
                                                console.warn('‚ö†Ô∏è Widget containers missing, re-initializing...');
                                                initializeDashboard();
                                            }
                                        }
                                    } else {
                                        console.log('Dashboard manager not available, will retry...');
                                        setTimeout(() => {
                                            if (window.dashboardManager) {
                                                initializeDashboard();
                                            }
                                        }, 1000);
                                    }
                                }, 200);
                                
                                // IMPORTANT: Hide the document generation panel for Dashboard tab
                                const selectionPanel = document.querySelector('.selection-panel');
                                if (selectionPanel) {
                                    selectionPanel.style.display = 'none';
                                    selectionPanel.style.visibility = 'hidden';
                                    console.log('‚úÖ Hidden selection panel for Dashboard tab');
                                }
                                
                                // Adjust main content layout to full width
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr';
                                    mainContent.style.maxWidth = '100%';
                                }
                            } else if (tab === 'programs') {
                                // Remove dashboard mode
                                document.body.classList.remove('dashboard-active');
                                
                                // Ensure programs tab is visible
                                if (tabElement) {
                                    tabElement.style.display = 'block';
                                    tabElement.style.visibility = 'visible';
                                    tabElement.style.opacity = '1';
                                }
                                
                                // Load Programs & Docs module if needed
                                if (typeof shouldUseProgramsDocs === 'function' && shouldUseProgramsDocs()) {
                                    if (typeof mountProgramsDocsModule === 'function') {
                                        console.log('[Programs & Docs] Attempting to mount module...');
                                        mountProgramsDocsModule()
                                            .then(() => {
                                                window.ccShell?.setSectionState?.('programs');
                                            })
                                            .catch(error => {
                                                window.ccShell?.setSectionState?.('programs-error');
                                                console.error('[Programs & Docs] Failed to mount:', error);
                                            });
                                    } else {
                                        console.warn('[Programs & Docs] mountProgramsDocsModule function not available');
                                        window.ccShell?.setSectionState?.('programs-error');
                                    }
                                } else {
                                    console.log('[Programs & Docs] Feature flag disabled or function not available');
                                    window.ccShell?.setSectionState?.('programs-error');
                                }
                                
                                // Hide selection panel for Programs & Docs module (it has its own UI)
                                const selectionPanel = document.querySelector('.selection-panel');
                                if (selectionPanel) {
                                    selectionPanel.style.display = 'none';
                                    selectionPanel.style.visibility = 'hidden';
                                    console.log('‚úÖ Hidden selection panel for Programs & Docs module');
                                }
                                
                                // Make main content full width for Programs & Docs module
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr';
                                    mainContent.style.maxWidth = '100%';
                                }
                                
                                // Initialize client selector when programs tab is shown
                                setTimeout(() => {
                                    initializeClientSelector();
                                }, 100);
                            } else if (tab === 'clients') {
                                // For clients tab, keep full width but HIDE selection panel
                                document.body.classList.remove('dashboard-active');
                                
                                // Ensure clients tab is visible
                                if (tabElement) {
                                    tabElement.style.display = 'block';
                                    tabElement.style.visibility = 'visible';
                                    tabElement.style.opacity = '1';
                                }
                                
                                // IMPORTANT: Hide the document generation panel for Clients tab
                                const selectionPanel = document.querySelector('.selection-panel');
                                if (selectionPanel) {
                                    selectionPanel.style.display = 'none';
                                    selectionPanel.style.visibility = 'hidden';
                                    console.log('‚úÖ Hidden selection panel for Clients tab');
                                }
                                
                                // Full width layout for clients
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr';
                                }

                                // Initialize CM Tracker / Clients view so house tabs + table populate
                                try {
                                    if (typeof initializeClientTracker === 'function') {
                                        initializeClientTracker();
                                    } else if (typeof initializeCMTracker === 'function') {
                                        initializeCMTracker();
                                    } else {
                                        console.warn('Client tracker initialization functions not available');
                                    }
                                } catch (cmInitError) {
                                    console.error('Error initializing client tracker:', cmInitError);
                                }
                            }
                            
                            // Save preference
                            localStorage.setItem('lastActiveTab', tab);
                        } catch (error) {
                            console.error('Error switching tabs:', error);
                        }
                    }
                    
                    // Function to show selection panel (document generation UI)
                    if (window.__pendingInitialTab) {
                        const pendingTab = window.__pendingInitialTab;
                        delete window.__pendingInitialTab;
                        setTimeout(() => {
                            try {
                                switchTab(pendingTab);
                            } catch (initialTabError) {
                                console.error('Initial tab activation failed:', initialTabError);
                            }
                        }, 0);
                    }
                    
                    // Function to show selection panel (document generation UI) - make globally available
                    window.showSelectionPanel = function showSelectionPanel() {
                        // Restore all elements marked as hidden by dashboard
                        const hiddenElements = document.querySelectorAll('[data-dashboard-hidden="true"]');
                        hiddenElements.forEach(el => {
                            el.style.display = '';
                            el.style.visibility = '';
                            el.removeAttribute('data-dashboard-hidden');
                        });
                        console.log('‚úÖ Restored selection panel');
                    }
                    
                    // Function to hide selection panel (document generation UI)
                    // IMPORTANT: Only target the actual .selection-panel element to avoid affecting dashboard
                    function hideSelectionPanel() {
                        // ONLY target the specific selection panel element
                        const selectionPanel = document.querySelector('.selection-panel');
                        if (selectionPanel) {
                            // Double-check it's not inside dashboard tab
                            if (!selectionPanel.closest('#dashboardTab') && !selectionPanel.closest('.dashboard-container')) {
                                selectionPanel.style.display = 'none';
                                selectionPanel.style.visibility = 'hidden';
                                selectionPanel.setAttribute('data-dashboard-hidden', 'true');
                                console.log('‚úÖ Hidden selection panel (document generation UI)');
                            } else {
                                console.log('‚ö†Ô∏è Selection panel is inside dashboard - skipping hide');
                            }
                        }
                    }
                    
                    // EMERGENCY: Simple dashboard fallback
                    window.injectSimpleDashboard = function(reason = 'unspecified') {
                        if (!canUseFallbackDashboard(reason) && window.dashboardState?.mode !== 'fallback') {
                            return false;
                        }
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (!dashboardTab) {
                            console.error('Dashboard tab not found!');
                            return false;
                        }
                        
                        if (window.dashboardState?.mode === 'fallback' && window.dashboardState.fallbackInjected) {
                            console.warn(`Re-rendering fallback dashboard (${reason}).`);
                        } else {
                            console.warn(`Injecting fallback dashboard (${reason}).`);
                        }
                        
                        dashboardTab.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important;';
                        dashboardTab.innerHTML = `
                            <div class="dashboard-container" style="padding: 20px; background: #f8f9fa !important; min-height: 600px; display: block !important;">
                                <h1 style="color: #111827 !important; margin-bottom: 20px;">üéØ Coach Dashboard (Fallback Mode)</h1>
                                <p style="color: #dc2626 !important; padding: 10px; background: #fee2e2; border-radius: 6px;">
                                    ‚ö†Ô∏è Dashboard widgets failed - showing emergency fallback
                                </p>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <h3 style="color: #374151 !important;">üìä Dashboard Status</h3>
                                        <p style="color: #059669 !important;">‚úÖ Fallback dashboard loaded</p>
                                        <p style="color: #4b5563 !important;">Time: ${new Date().toLocaleTimeString()}</p>
                                    </div>
                                    
                                    <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <h3 style="color: #374151 !important;">üîß Quick Fix</h3>
                                        <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                            üîÑ Reload Page
                                        </button>
                                        <button onclick="window.clearCacheAndReload()" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                                            üóëÔ∏è Clear Cache & Reload
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 30px; padding: 20px; background: #dbeafe; border-radius: 8px;">
                                    <h3 style="color: #1e40af !important;">‚ÑπÔ∏è What Happened?</h3>
                                    <p style="color: #1e40af !important;">The dashboard widgets failed to render. This fallback ensures you can still see something.</p>
                                    <p style="color: #1e40af !important; margin-top: 10px;">To fix: Try clearing browser cache or using a different browser.</p>
                                </div>
                            </div>
                        `;
                        
                        setDashboardMode('fallback', reason);
                        console.log('‚úÖ Simple fallback dashboard injected successfully');
                        return true;
                    }
                    
                    // Auto-inject fallback if main dashboard fails
                    setTimeout(() => {
                        if (window.dashboardState?.mode === 'modern') {
                            return;
                        }
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (dashboardTab && dashboardTab.classList.contains('active')) {
                            const widgets = document.querySelectorAll('.dashboard-widget');
                            if (widgets.length === 0) {
                                console.warn('‚ö†Ô∏è No dashboard widgets found after 3 seconds, injecting fallback');
                                window.injectSimpleDashboard('timeout-no-widgets');
                            }
                        }
                    }, 3000);
                    
                    let dashboardWidgetsInitialized = false;
                    
                    async function waitForDashboardDependencies(timeout = 15000) {
                        const start = Date.now();
                        while (Date.now() - start < timeout) {
                            const hasClientManager = !!(window.clientManager?.getAllClients);
                            const hasHousesManager = !!(window.housesManager?.getHouses);
                            if (hasClientManager && hasHousesManager) {
                                return true;
                            }
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                        console.warn('Dashboard dependencies not ready within timeout', {
                            clientManager: !!window.clientManager,
                            housesManager: !!window.housesManager,
                            milestonesManager: !!window.milestonesManager
                        });
                        return false;
                    }
                    
                    function updateDashboardShell() {
                        if (!window.dashboardManager) return;
                        const greeting = dashboardManager.getTimeAwareGreeting();
                        const greetingEl = document.getElementById('dashboardGreeting');
                        const subtitleEl = document.getElementById('dashboardSubtitle');
                        const coachEl = document.getElementById('coachIndicator');
                        const updateEl = document.getElementById('lastUpdateTime');
                        
                        if (greetingEl) greetingEl.textContent = greeting.greeting;
                        if (subtitleEl) subtitleEl.textContent = greeting.focus;
                        if (coachEl) coachEl.textContent = `Coach: ${dashboardManager.currentCoach?.initials || '--'}`;
                        if (updateEl) {
                            const timestamp = dashboardManager.lastUpdate || new Date();
                            updateEl.textContent = `Last updated: ${timestamp.toLocaleTimeString()}`;
                        }
                        
                        document.querySelectorAll('.dashboard-view-toggle button').forEach(button => {
                            const view = button.getAttribute('data-view');
                            button.classList.toggle('active', view === dashboardManager.currentView);
                        });
                        
                        const emptyBanner = document.getElementById('dashboardEmptyState');
                        if (emptyBanner) {
                            const activeClients = dashboardManager.cache?.metrics?.activeClients || 0;
                            emptyBanner.style.display = activeClients > 0 ? 'none' : 'flex';
                        }
                    }
                    
                    async function initializeDashboard(forceRefresh = false) {
                        if (!window.dashboardManager || !window.dashboardWidgets) {
                            console.log('Dashboard scripts not ready, retrying initializeDashboard...');
                            setTimeout(() => initializeDashboard(forceRefresh), 400);
                            return;
                        }
                        
                        setDashboardMode('loading', forceRefresh ? 'force-refresh' : 'initializeDashboard');
                        
                        await waitForDashboardDependencies();
                        
                        if (!window.milestonesManager) {
                            console.warn('MilestonesManager not available - dashboard schedule will be limited');
                        }
                        
                        try {
                            if (!dashboardManager.initialized) {
                                await dashboardManager.initialize();
                            } else if (forceRefresh) {
                                await dashboardManager.refreshDashboard();
                            } else {
                                await dashboardManager.loadDashboardData();
                            }
                            
                            // Check if we have any clients, if not and in demo mode, auto-populate demo data
                            if (window.clientManager && window.ccConfig?.demoMode) {
                                const clients = await window.clientManager.getAllClients();
                                console.log('Current client count:', clients.length);
                                
                                if (clients.length === 0) {
                                    console.log('No clients found in dev mode, auto-populating demo data...');
                                    
                                    // Auto-populate demo data
                                    if (window.demoDataGenerator && window.clientManager.generateDemoClients) {
                                        try {
                                            const created = await window.clientManager.generateDemoClients(40);
                                            console.log('‚úÖ Auto-populated', created.length, 'demo clients');
                                            
                                            // Reload dashboard data after creating clients
                                            await dashboardManager.loadDashboardData();
                                        } catch (error) {
                                            console.error('Failed to auto-populate demo data:', error);
                                        }
                                    }
                                }
                            }
                            
                            if (!dashboardWidgetsInitialized) {
                                await window.dashboardWidgets.initialize();
                                dashboardWidgetsInitialized = true;
                            }
                            
                            await window.dashboardWidgets.renderAll();
                            updateDashboardShell();
                            setDashboardMode('modern', 'widgets-rendered');
                            
                            const selectionPanel = document.querySelector('.selection-panel');
                            if (selectionPanel && !selectionPanel.closest('#dashboardTab')) {
                                selectionPanel.style.display = 'none';
                                selectionPanel.style.visibility = 'hidden';
                            }
                            
                            console.log('‚úÖ Dashboard initialized successfully');
                        } catch (error) {
                            console.error('Failed to initialize dashboard:', error);
                            setDashboardMode('error', 'initialize-dashboard-failed');
                        }
                    }
                    
                    // Manual function to force demo data creation and dashboard refresh
                    window.forceDemoData = async function() {
                        if (!window.ccConfig?.demoMode) {
                            window.showNotification('Demo data is disabled in this environment.', 'info');
                            return;
                        }

                        console.log('Forcing demo data creation...');
                        
                        if (!window.clientManager || !window.demoDataGenerator) {
                            console.error('Required components not loaded');
                            return;
                        }
                        
                        try {
                            // Clear existing demo clients first
                            const existingClients = await window.clientManager.getAllClients();
                            const demoClients = existingClients.filter(c => c.isDemo);
                            
                            for (const client of demoClients) {
                                await window.clientManager.deleteClient(client.id);
                            }
                            console.log('Cleared', demoClients.length, 'existing demo clients');
                            
                            // Create new demo clients
                            const created = await window.clientManager.generateDemoClients(40);
                            console.log('‚úÖ Created', created.length, 'new demo clients');
                            
                            // Force complete dashboard refresh
                            await dashboardManager.initialize();
                            await dashboardManager.loadDashboardData();
                            await window.dashboardWidgets.renderAll();
                            updateDashboardShell();
                            
                            console.log('‚úÖ Dashboard refreshed with demo data');
                        } catch (error) {
                            console.error('Failed to force demo data:', error);
                        }
                    };
                    
                    window.setDashboardView = async function(view) {
                        if (!window.dashboardManager || !view) return;
                        if (dashboardManager.currentView === view) {
                            return;
                        }
                        dashboardManager.currentView = view;
                        dashboardManager.savePreferences?.();
                        document.querySelectorAll('.dashboard-view-toggle button').forEach(button => {
                            const buttonView = button.getAttribute('data-view');
                            button.classList.toggle('active', buttonView === view);
                        });
                        await dashboardManager.refreshDashboard();
                        if (window.dashboardWidgets?.renderAll) {
                            await window.dashboardWidgets.renderAll();
                        }
                        updateDashboardShell();
                    };
                    
                    // Set programs as default on page load
                    document.addEventListener('DOMContentLoaded', function() {
                        // Start with Programs tab as default
                        const defaultTab = 'programs';
                        
                        // Initially hide the selection panel
                        const selectionPanel = document.querySelector('.selection-panel');
                        if (selectionPanel) {
                            selectionPanel.style.display = 'none';
                            selectionPanel.style.visibility = 'hidden';
                        }
                        
                        // Hide demo-only UI when demo mode is off
                        if (!window.ccConfig?.demoMode) {
                            document.querySelectorAll('[data-demo-only=\"true\"]').forEach(el => {
                                el.style.display = 'none';
                            });
                        }
                        
                        // Load programs tab by default
                        setTimeout(() => {
                            switchTab(defaultTab);
                        }, 100);
                        
                        // Diagnostic scripts removed - no longer needed
                        // These were temporary fixes that caused console noise
                        
                        /* Commented out diagnostic scripts:
                        // Run diagnostics after a delay
                        setTimeout(() => {
                            const script = document.createElement('script');
                            script.src = 'dashboard-diagnostics-fix.js?v=' + Date.now();
                            document.body.appendChild(script);
                        }, 2000);
                        
                        // Apply visibility fix
                        setTimeout(() => {
                            const fixScript = document.createElement('script');
                            fixScript.src = 'dashboard-visibility-fix.js?v=' + Date.now();
                            document.body.appendChild(fixScript);
                        }, 2500);
                        
                        // Apply parent visibility fix immediately
                        setTimeout(() => {
                            const parentFixScript = document.createElement('script');
                            parentFixScript.src = 'parent-visibility-fix.js?v=' + Date.now();
                            document.body.appendChild(parentFixScript);
                        }, 500);
                        */
                    });
                    
                    // Helper function for notifications
                    function showNotification(message, type = 'info') {
                        const notification = document.createElement('div');
                        notification.className = `notification notification-${type}`;
                        notification.innerHTML = `
                            <div class="notification-content">
                                <div class="notification-message">${message}</div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                        
                        // Add styles if not already present
                        if (!document.querySelector('#notificationStyles')) {
                            const style = document.createElement('style');
                            style.id = 'notificationStyles';
                            style.textContent = `
                                .notification {
                                    position: fixed;
                                    top: 20px;
                                    right: 20px;
                                    padding: 16px 24px;
                                    border-radius: 8px;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                    z-index: 10000;
                                    animation: slideIn 0.3s ease-out;
                                }
                                .notification-success { background: #10b981; color: white; }
                                .notification-error { background: #ef4444; color: white; }
                                .notification-info { background: #3b82f6; color: white; }
                                @keyframes slideIn {
                                    from { transform: translateX(100%); opacity: 0; }
                                    to { transform: translateX(0); opacity: 1; }
                                }
                            `;
                            document.head.appendChild(style);
                        }
                        
                        setTimeout(() => notification.remove(), 3000);
                    }
                    
                    // Helper function for modals
                    function showModal(options) {
                        const modal = document.createElement('div');
                        modal.className = 'modal cc-generic-modal';
                        modal.style.display = 'block';
                        modal.innerHTML = `
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2>${options.title}</h2>
                                    <button class="modal-close" onclick="window.closeModal(this.closest('.cc-generic-modal'))">&times;</button>
                                </div>
                                <div class="modal-body">
                                    ${options.content}
                                </div>
                                <div class="modal-actions">
                                    ${options.buttons.map(btn => 
                                        `<button onclick="${btn.action}; window.closeModal(this.closest('.cc-generic-modal'))">${btn.text}</button>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                </script>
                
                <!-- Programs Tab Content -->
                <div id="programsTab" class="tab-content active">
                    <div id="programsDocsLoader" class="programs-docs-loader" role="status" aria-live="polite">
                        <span class="loader-spinner" aria-hidden="true"></span>
                        <span class="loader-copy">Loading Programs &amp; Docs workspace‚Ä¶</span>
                    </div>
                    <div id="programsDocsContainer" class="programs-docs-container" hidden></div>
                    <div id="programsDocsError" class="programs-docs-error" hidden role="alert">
                        <h3>Programs workspace unavailable</h3>
                        <p>Please retry loading or switch back to the legacy module if needed.</p>
                        <div class="programs-docs-error-actions">
                            <button type="button" class="btn btn-primary" onclick="retryProgramsDocsMount()">Retry load</button>
                            <button type="button" class="btn" onclick="toggleLegacyPrograms(true)">Open legacy Programs view</button>
                        </div>
                    </div>
                    <div id="legacyProgramsWrapper" class="legacy-programs-wrapper" hidden aria-live="polite"></div>
                </div> <!-- End of programsTab -->
                
                <!-- Clients Tab Content -->
                <div id="clientsTab" class="tab-content">
                    <div class="cm-tracker-container">
                        <!-- House Navigation -->
                        <div class="house-navigation">
                            <div class="house-tabs" id="houseTabs">
                                <!-- House tabs will be dynamically generated -->
                            </div>
                        </div>
                        
                        <!-- House Content Area -->
                        <div class="house-content" id="houseContent">
                            <div class="cm-quick-actions">
                                <button class="cm-action-btn primary" onclick="window.showAddClientModal && window.showAddClientModal()">
                                    ‚ûï Add Client
                                </button>
                                <button class="cm-action-btn" onclick="showBulkImport()">
                                    üì• Import Excel
                                </button>
                                <button class="cm-action-btn" onclick="exportCurrentHouse()">
                                    üíæ Export House
                                </button>
                                <button class="cm-action-btn" onclick="exportAllData()">
                                    üìä Export All
                                </button>
                                <button class="cm-action-btn" onclick="showReports()">
                                    üìà Reports
                                </button>
                                <button class="cm-action-btn" onclick="window.switchTab && window.switchTab('programs')" style="background: #f3f4f6;" data-tab-target="programs">
                                    üìë Programs &amp; Docs
                                </button>
                            </div>
                            
                            <div id="houseClientsList">
                                <!-- Client table will be dynamically generated here -->
                            </div>
                        </div>
                        
                    </div>
                </div> <!-- End of clientsTab -->
                
                <!-- Admin Command Center Tab (Admin Only) -->
                <div id="adminTab" class="tab-content" data-admin-only="true" style="display:none;">
                    <div class="admin-command-center">
                        <div class="admin-header">
                            <h2>‚öôÔ∏è Admin Command Center</h2>
                            <p class="admin-subtitle">Manage features, view analytics, and configure the application</p>
                        </div>
                        
                        <div class="admin-sections">
                            <!-- Feature Flags Section -->
                            <div class="admin-section">
                                <h3>üéõÔ∏è Feature Management</h3>
                                <p>Enable or disable features across the application. Changes take effect immediately.</p>
                                <button class="admin-btn primary" onclick="window.featureFlags && window.featureFlags.showPanel()">
                                    Open Feature Flags Panel
                                </button>
                            </div>
                            
                            <!-- App Analytics Section -->
                            <div class="admin-section">
                                <h3>üìä Application Analytics</h3>
                                <div class="analytics-grid" id="adminAnalytics">
                                    <div class="analytics-card">
                                        <div class="analytics-value" id="totalClients">--</div>
                                        <div class="analytics-label">Total Clients</div>
                                    </div>
                                    <div class="analytics-card">
                                        <div class="analytics-value" id="activeUsers">--</div>
                                        <div class="analytics-label">Active Users</div>
                                    </div>
                                    <div class="analytics-card">
                                        <div class="analytics-value" id="totalPrograms">--</div>
                                        <div class="analytics-label">Programs in DB</div>
                                    </div>
                                    <div class="analytics-card">
                                        <div class="analytics-value" id="docsGenerated">--</div>
                                        <div class="analytics-label">Docs Generated</div>
                                    </div>
                                </div>
                                <button class="admin-btn" onclick="window.refreshAdminAnalytics && window.refreshAdminAnalytics()">
                                    Refresh Analytics
                                </button>
                            </div>
                            
                            <!-- Data Management Section -->
                            <div class="admin-section">
                                <h3>üíæ Data Management</h3>
                                <div class="admin-actions">
                                    <button class="admin-btn" onclick="window.exportAllData && window.exportAllData()">
                                        üì§ Export All Data
                                    </button>
                                    <button class="admin-btn" onclick="document.getElementById('importDataInput').click()">
                                        üì• Import Data
                                    </button>
                                    <input type="file" id="importDataInput" accept=".json" style="display:none" onchange="window.importData && window.importData(this.files[0])">
                                    <button class="admin-btn warning" onclick="if(confirm('Clear all demo data? This cannot be undone.')) window.clearDemoData && window.clearDemoData()">
                                        üóëÔ∏è Clear Demo Data
                                    </button>
                                </div>
                            </div>
                            
                            <!-- System Info Section -->
                            <div class="admin-section">
                                <h3>‚ÑπÔ∏è System Information</h3>
                                <div class="system-info">
                                    <div class="info-row"><span>Version:</span><span>v12.4 REVAMPED PROFILE</span></div>
                                    <div class="info-row"><span>Build:</span><span>dashboard-refresh-01</span></div>
                                    <div class="info-row"><span>Environment:</span><span id="envMode">--</span></div>
                                    <div class="info-row"><span>Storage Used:</span><span id="storageUsed">--</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End of adminTab -->
                
            </div>
            
    <!-- ClearHive Branding -->
    <div style="text-align: center; padding: 20px; border-top: 1px solid #eee; margin-top: 40px; color: #999; font-size: 12px;">
        Document Creator by <strong>ClearHive Health LLC</strong>
    </div>

    <!-- Programs Data Loader - Load before other scripts -->
    <script src="js/programs-loader.js"></script>
    <script src="js/programs-init.js"></script>

    <!-- Session Management & Data Persistence Scripts - MUST BE LOADED LAST -->
    <script src="js/auth/login-robust.js"></script>
    <script src="js/data-persistence.js"></script>
    <script src="session-fix.js"></script>
    
    <!-- User Menu Functions -->
    <script>
        (function() {
            'use strict';
            
            let userMenuOpen = false;
            const userMenu = document.getElementById('userMenu');
            const userProfileBtn = document.getElementById('userProfileBtn');
            
            // Toggle user menu
            window.toggleUserMenu = function() {
                if (!userMenu || !userProfileBtn) return;
                
                userMenuOpen = !userMenuOpen;
                
                if (userMenuOpen) {
                    userMenu.style.display = 'block';
                    userProfileBtn.setAttribute('aria-expanded', 'true');
                    updateUserMenuInfo();
                } else {
                    userMenu.style.display = 'none';
                    userProfileBtn.setAttribute('aria-expanded', 'false');
                }
            };
            
            // Update user menu with current user info
            window.updateUserMenuInfo = function() {
                if (!userMenu) return;
                
                const username = localStorage.getItem('username') || 'User';
                const fullName = localStorage.getItem('fullName') || username;
                const initials = localStorage.getItem('userInitials') || username.slice(0, 2).toUpperCase();
                
                const menuInitials = document.getElementById('userMenuInitials');
                const menuName = document.getElementById('userMenuName');
                const menuUsername = document.getElementById('userMenuUsername');
                const headerInitials = document.getElementById('userInitials');
                
                if (menuInitials) menuInitials.textContent = initials;
                if (menuName) menuName.textContent = fullName;
                if (menuUsername) menuUsername.textContent = '@' + username;
                if (headerInitials) headerInitials.textContent = initials;
            };
            
            // Handle logout
            window.handleLogout = function() {
                if (typeof window.logout === 'function') {
                    window.logout();
                    userMenuOpen = false;
                    if (userMenu) userMenu.style.display = 'none';
                    if (userProfileBtn) userProfileBtn.setAttribute('aria-expanded', 'false');
                } else {
                    console.error('Logout function not available');
                }
            };
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (userMenuOpen && userMenu && userProfileBtn) {
                    if (!userMenu.contains(event.target) && !userProfileBtn.contains(event.target)) {
                        userMenuOpen = false;
                        userMenu.style.display = 'none';
                        userProfileBtn.setAttribute('aria-expanded', 'false');
                    }
                }
            });
            
            // Update menu info when user logs in
            if (typeof window.addEventListener !== 'undefined') {
                window.addEventListener('storage', function(e) {
                    if (e.key === 'username' || e.key === 'fullName') {
                        updateUserMenuInfo();
                    }
                });
                
                // Update on page load if already logged in
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    setTimeout(updateUserMenuInfo, 500);
                } else {
                    document.addEventListener('DOMContentLoaded', function() {
                        setTimeout(updateUserMenuInfo, 500);
                    });
                }
            }
        })();
    </script>
    
    <!-- Session migration is handled by login-robust.js -->
    <!-- No additional migration script needed - login-robust.js is the single source of truth -->
    <script defer src="map-v2-dist/assets/map-v2.js"></script>
    
    <!-- Admin Command Center Functions -->
    <script>
        (function() {
            'use strict';
            
            // Check if user is admin and show admin-only elements
            function checkAdminAccess() {
                const userRole = localStorage.getItem('userRole');
                const isAdmin = userRole === 'admin';
                
                // Show/hide admin-only elements
                document.querySelectorAll('[data-admin-only="true"]').forEach(el => {
                    el.style.display = isAdmin ? '' : 'none';
                });
                
                console.log('Admin access check:', isAdmin ? '‚úÖ Admin' : 'üë§ User');
            }
            
            // Refresh admin analytics
            window.refreshAdminAnalytics = async function() {
                try {
                    // Total clients
                    if (window.clientManager) {
                        const clients = await window.clientManager.getAllClients();
                        const totalEl = document.getElementById('totalClients');
                        if (totalEl) totalEl.textContent = clients.length;
                    }
                    
                    // Total programs
                    if (window.programsData) {
                        const programsEl = document.getElementById('totalPrograms');
                        if (programsEl) programsEl.textContent = window.programsData.length || 0;
                    }
                    
                    // Active users (from session storage or estimate)
                    const activeEl = document.getElementById('activeUsers');
                    if (activeEl) activeEl.textContent = '1'; // Current user
                    
                    // Docs generated (from localStorage counter)
                    const docsCount = localStorage.getItem('docsGeneratedCount') || '0';
                    const docsEl = document.getElementById('docsGenerated');
                    if (docsEl) docsEl.textContent = docsCount;
                    
                    // Environment mode
                    const envEl = document.getElementById('envMode');
                    if (envEl) {
                        const host = window.location.hostname;
                        envEl.textContent = (host === 'localhost' || host === '127.0.0.1') ? 'Development' : 'Production';
                    }
                    
                    // Storage used
                    const storageEl = document.getElementById('storageUsed');
                    if (storageEl && navigator.storage && navigator.storage.estimate) {
                        const estimate = await navigator.storage.estimate();
                        const usedMB = ((estimate.usage || 0) / (1024 * 1024)).toFixed(2);
                        storageEl.textContent = usedMB + ' MB';
                    } else if (storageEl) {
                        storageEl.textContent = 'N/A';
                    }
                    
                    console.log('‚úÖ Admin analytics refreshed');
                } catch (error) {
                    console.error('Failed to refresh admin analytics:', error);
                }
            };
            
            // Run on page load
            document.addEventListener('DOMContentLoaded', function() {
                // Check admin access after a short delay to ensure login state is loaded
                setTimeout(checkAdminAccess, 500);
                
                // Also check when storage changes (login/logout)
                window.addEventListener('storage', function(e) {
                    if (e.key === 'userRole' || e.key === 'isLoggedIn') {
                        checkAdminAccess();
                    }
                });
            });
            
            // Refresh analytics when admin tab is shown
            const originalSwitchTab = window.switchTab;
            if (originalSwitchTab) {
                window.switchTab = function(tab) {
                    originalSwitchTab(tab);
                    if (tab === 'admin') {
                        window.refreshAdminAnalytics();
                    }
                };
            }
        })();
    </script>
</body>
</html>
