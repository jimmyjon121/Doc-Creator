<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Diagnostic Test - Find the Issue</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        button { padding: 10px; margin: 5px; background: #333; color: #0f0; border: 1px solid #0f0; cursor: pointer; }
        button:hover { background: #555; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .success { color: #0f0; }
    </style>
</head>
<body>
    <h1>üîç Diagnostic Test</h1>
    <button onclick="runDiagnostic()">Run Full Diagnostic</button>
    <button onclick="testSingleClient()">Test Single Client Creation</button>
    <button onclick="testBatchCreation()">Test Batch Creation</button>
    <pre id="output"></pre>
    
    <script src="indexed-db-manager.js"></script>
    <script src="client-manager.js"></script>
    <script src="houses-manager.js"></script>
    <script src="dashboard-manager.js"></script>
    <script src="js/demo-data.js"></script>
    
    <script>
        const output = document.getElementById('output');
        const log = (msg, type = '') => {
            const line = document.createElement('div');
            line.className = type;
            line.textContent = msg;
            output.appendChild(line);
            console.log(msg);
        };

        window.ccConfig = {
            demoMode: true,
            currentUser: { initials: 'JH', role: 'Coach' }
        };

        async function initialize() {
            log('Initializing...');
            window.dbManager = new IndexedDBManager('DiagnosticDB', 2);
            await window.dbManager.init([
                { name: 'clients', keyPath: 'id' },
                { name: 'houses', keyPath: 'id' }
            ]);
            await window.dbManager.initializeHouses();
            window.clientManager = new ClientManager(window.dbManager);
            window.housesManager = new HousesManager(window.dbManager);
            await window.housesManager.initialize();
            log('Initialization complete', 'success');
        }

        async function testSingleClient() {
            await initialize();
            log('\n=== TESTING SINGLE CLIENT CREATION ===', 'warning');
            
            // Test each stage
            const stages = ['pre-admission', 'early', 'mid', 'late', 'discharged'];
            
            for (const stage of stages) {
                log(`\nTesting ${stage} client:`);
                try {
                    const clientData = window.DemoDataGenerator.generateClient(1, stage);
                    log(`Generated data: ${JSON.stringify(clientData, null, 2)}`);
                    
                    const client = await window.clientManager.createClient(clientData);
                    log(`‚úÖ Created ${stage} client: ${client.id}`, 'success');
                } catch (e) {
                    log(`‚ùå Failed to create ${stage} client: ${e.message}`, 'error');
                    log(`Stack: ${e.stack}`, 'error');
                }
            }
        }

        async function testBatchCreation() {
            await initialize();
            log('\n=== TESTING BATCH CREATION (20 clients) ===', 'warning');
            
            // Clear existing
            const existing = await window.clientManager.getAllClients();
            for (const client of existing) {
                await window.clientManager.deleteClient(client.id);
            }
            
            let successCount = 0;
            let failCount = 0;
            const failures = [];
            
            for (let i = 1; i <= 20; i++) {
                const stage = i <= 2 ? 'pre-admission' :
                            i <= 8 ? 'early' :
                            i <= 13 ? 'mid' :
                            i <= 17 ? 'late' : 'discharged';
                
                try {
                    const clientData = window.DemoDataGenerator.generateClient(i, stage);
                    const client = await window.clientManager.createClient(clientData);
                    successCount++;
                    log(`‚úÖ Client ${i} (${stage}): ${client.initials}`, 'success');
                } catch (e) {
                    failCount++;
                    failures.push({ index: i, stage, error: e.message });
                    log(`‚ùå Client ${i} (${stage}): ${e.message}`, 'error');
                }
            }
            
            log(`\n=== RESULTS ===`, 'warning');
            log(`Success: ${successCount}/20`, successCount === 20 ? 'success' : 'error');
            log(`Failed: ${failCount}/20`, failCount > 0 ? 'error' : 'success');
            
            if (failures.length > 0) {
                log('\nFailure Analysis:', 'warning');
                const errorTypes = {};
                failures.forEach(f => {
                    errorTypes[f.error] = (errorTypes[f.error] || 0) + 1;
                });
                Object.entries(errorTypes).forEach(([error, count]) => {
                    log(`  ${error}: ${count} times`, 'error');
                });
            }
        }

        async function runDiagnostic() {
            output.innerHTML = '';
            await initialize();
            
            log('=== FULL DIAGNOSTIC ===', 'warning');
            
            // 1. Check DemoDataGenerator
            log('\n1. Checking DemoDataGenerator:', 'warning');
            try {
                const testData = window.DemoDataGenerator.generateClient(1, 'early');
                log('‚úÖ DemoDataGenerator.generateClient works', 'success');
                log(`Sample data keys: ${Object.keys(testData).join(', ')}`);
            } catch (e) {
                log(`‚ùå DemoDataGenerator.generateClient failed: ${e.message}`, 'error');
            }
            
            // 2. Check ClientManager
            log('\n2. Checking ClientManager:', 'warning');
            try {
                const methods = ['createClient', 'getAllClients', 'getActiveClients', 'getDischargedClients', 'getClientsByHouse'];
                methods.forEach(method => {
                    if (typeof window.clientManager[method] === 'function') {
                        log(`‚úÖ ClientManager.${method} exists`, 'success');
                    } else {
                        log(`‚ùå ClientManager.${method} missing`, 'error');
                    }
                });
            } catch (e) {
                log(`‚ùå ClientManager check failed: ${e.message}`, 'error');
            }
            
            // 3. Check Houses
            log('\n3. Checking Houses:', 'warning');
            const houses = window.housesManager.getActiveHouses();
            log(`Found ${houses.length} houses:`, 'success');
            houses.forEach(h => log(`  - ${h.id}: ${h.name}`));
            
            // 4. Try creating one client of each type
            log('\n4. Testing client creation by stage:', 'warning');
            const stages = ['pre-admission', 'early', 'mid', 'late', 'discharged'];
            let createResults = {};
            
            for (const stage of stages) {
                try {
                    const data = window.DemoDataGenerator.generateClient(100 + stages.indexOf(stage), stage);
                    const client = await window.clientManager.createClient(data);
                    createResults[stage] = 'success';
                    log(`‚úÖ ${stage}: Created ${client.initials}`, 'success');
                } catch (e) {
                    createResults[stage] = e.message;
                    log(`‚ùå ${stage}: ${e.message}`, 'error');
                }
            }
            
            // 5. Check what's actually in the database
            log('\n5. Database contents:', 'warning');
            const allClients = await window.clientManager.getAllClients();
            log(`Total clients in DB: ${allClients.length}`);
            
            const byStage = {};
            allClients.forEach(c => {
                const stage = c._demoStage || 'unknown';
                byStage[stage] = (byStage[stage] || 0) + 1;
            });
            
            Object.entries(byStage).forEach(([stage, count]) => {
                log(`  ${stage}: ${count} clients`);
            });
            
            // 6. Final verdict
            log('\n=== DIAGNOSIS ===', 'warning');
            if (Object.values(createResults).every(r => r === 'success')) {
                log('‚úÖ All client types can be created successfully', 'success');
                log('The issue is likely in the batch generation logic', 'warning');
            } else {
                log('‚ùå Some client types fail to create:', 'error');
                Object.entries(createResults).forEach(([stage, result]) => {
                    if (result !== 'success') {
                        log(`  ${stage}: ${result}`, 'error');
                    }
                });
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            log('Diagnostic tool ready. Click a button to start.', 'success');
        });
    </script>
</body>
</html>
