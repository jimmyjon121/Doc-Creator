<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect Pro â€” Programs & Document Creator</title>
    <meta name="description" content="Three-pane Programs and Document Creator workspace for CareConnect Pro.">
    <style>
        :root {
            --navy-900: #0F1020;
            --navy-700: #151633;
            --navy-500: #1F2145;
            --accent-500: #6E7BFF;
            --accent-400: #8D97FF;
            --accent-200: #C9CEFF;
            --neutral-50: #F7F8FF;
            --neutral-100: #E9ECFF;
            --neutral-200: #D7DBF8;
            --neutral-400: #9FA6D7;
            --surface: #FFFFFF;
            --surface-alt: rgba(239, 241, 255, 0.75);
            --text-strong: #151633;
            --text-subtle: #48508A;
            --success: #4CAF9F;
            --warning: #FFB347;
            --danger: #FF6B6B;
            --shadow-soft: 0 12px 30px rgba(15, 16, 32, 0.18);
            --shadow-card: 0 16px 40px rgba(15, 16, 32, 0.12);
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --transition-fast: 160ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-medium: 260ms cubic-bezier(0.22, 1, 0.36, 1);
            --programs-toolbar-height: clamp(100px, 12vh, 148px);
        }

        /* Dark mode variables */
        body.dark-mode {
            --navy-900: #E9ECFF;
            --navy-700: #D7DBF8;
            --navy-500: #9FA6D7;
            --text-strong: #E9ECFF;
            --text-subtle: #B8BFE8;
            --surface: #1F2145;
            --surface-alt: rgba(31, 33, 69, 0.85);
            --neutral-50: #2A2D5A;
            --accent-500: #8D97FF;
            --accent-400: #A8B0FF;
            --accent-200: #C9CEFF;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Segoe UI", "Inter", "Helvetica Neue", Arial, sans-serif;
            color: var(--text-strong);
            /* LEGACY PURPLE GRADIENT REMOVED - Using clean background */
            background: #f8f9fa;
        }

        /* Removed body::before overlay to prevent foggy appearance */

        body.dark-mode {
            background: linear-gradient(145deg, #151633 0%, #1F2145 100%);
            color: var(--text-strong);
        }

        body.dark-mode .program-card {
            background: rgba(31, 33, 69, 0.95);
            border-color: rgba(141, 151, 255, 0.2);
            color: var(--text-strong);
        }

        body.dark-mode .badge {
            background: rgba(141, 151, 255, 0.2);
            color: var(--accent-200);
        }

        body.dark-mode .program-card__tag {
            background: rgba(141, 151, 255, 0.15);
            color: var(--accent-200);
        }

        body.dark-mode .toolbar {
            background: rgba(21, 22, 51, 0.95);
            border-color: rgba(141, 151, 255, 0.2);
        }

        .toolbar {
            position: sticky;
            top: var(--app-shell-top-offset, 64px);
            z-index: 90;
            padding: 18px clamp(20px, 3vw, 32px);
            display: grid;
            grid-template-columns: 320px 1fr auto;
            gap: 18px;
            align-items: center;
            background: rgba(15, 16, 32, 0.88);
            color: #fff;
            backdrop-filter: blur(14px);
            border-bottom: 1px solid rgba(233, 236, 255, 0.16);
            box-shadow: 0 12px 32px rgba(10, 12, 32, 0.24);
            width: min(1280px, 100%);
            margin: 0 auto clamp(12px, 2vh, 28px);
            margin-top: 0;
            border-radius: 0 0 20px 20px;
        }

        .toolbar__brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .toolbar__brand span {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            font-weight: 700;
        }

        .toolbar__search {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar__search label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(233, 236, 255, 0.14);
            border-radius: 999px;
            width: 100%;
            border: 1px solid transparent;
            transition: border var(--transition-fast), background var(--transition-fast);
        }

        .toolbar__search label:focus-within {
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.26);
        }

        .toolbar__search input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.95rem;
            background: transparent;
            color: #fff;
        }

        .toolbar__search input::placeholder {
            color: rgba(255, 255, 255, 0.65);
        }

        .toolbar__actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar__document-toggle {
            display: inline-flex;
            align-items: center;
            padding: 4px;
            gap: 6px;
            border-radius: 999px;
            border: 1px solid rgba(233, 236, 255, 0.2);
            background: rgba(233, 236, 255, 0.12);
        }

        .toolbar__document-toggle-btn {
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.78);
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .toolbar__document-toggle-btn:is(:hover, :focus-visible) {
            color: #fff;
            background: rgba(233, 236, 255, 0.18);
            transform: translateY(-1px);
        }

        .toolbar__document-toggle-btn.is-active {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(110, 123, 255, 0.3);
        }

        .toolbar__preferences-btn {
            border: none;
            background: rgba(233, 236, 255, 0.16);
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .toolbar__preferences-btn:is(:hover, :focus-visible) {
            background: rgba(233, 236, 255, 0.28);
            transform: translateY(-1px);
            outline: none;
        }

        .preferences-overlay[hidden],
        .preferences-modal[hidden] {
            display: none !important;
        }

        .preferences-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 16, 32, 0.45);
            backdrop-filter: blur(4px);
            z-index: 1100;
        }

        .preferences-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(720px, calc(100% - 40px));
            max-height: calc(100vh - 120px);
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 24px 60px rgba(15, 16, 32, 0.25);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            z-index: 1200;
        }

        .preferences-modal header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .preferences-modal header h2 {
            font-size: 1.2rem;
            margin: 0;
            color: var(--navy-700);
        }

        .preferences-close-btn {
            border: none;
            background: rgba(21, 22, 51, 0.08);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .preferences-close-btn:is(:hover, :focus-visible) {
            background: rgba(21, 22, 51, 0.16);
            transform: translateY(-1px);
        }

        .preferences-tabs {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .preferences-tabs button {
            border: none;
            background: rgba(21, 22, 51, 0.06);
            color: var(--navy-700);
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .preferences-tabs button.is-active {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            box-shadow: 0 10px 20px rgba(110, 123, 255, 0.15);
        }

        .preferences-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .preferences-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preferences-panel section {
            padding: 14px;
            border-radius: 14px;
            background: rgba(233, 236, 255, 0.45);
            border: 1px solid rgba(110, 123, 255, 0.18);
        }

        .preferences-modal footer {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .preferences-modal footer button {
            border: none;
            border-radius: 10px;
            padding: 10px 18px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        }

        .preferences-modal footer button:is(:hover, :focus-visible) {
            transform: translateY(-1px);
        }

        .preferences-reset-btn {
            background: rgba(21, 22, 51, 0.08);
            color: var(--navy-700);
        }

        .preferences-save-btn {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            box-shadow: 0 10px 24px rgba(110, 123, 255, 0.22);
        }

        body.prefs-high-contrast {
            background: #0f1020;
            color: #f7f8ff;
        }

        body.prefs-high-contrast .pane {
            background: rgba(26, 29, 58, 0.95);
            color: #f7f8ff;
        }

        body.prefs-high-contrast .program-card {
            background: rgba(26, 29, 58, 0.92);
            color: #f7f8ff;
            border-color: rgba(147, 155, 255, 0.35);
        }

        body.prefs-reduce-motion *,
        body.prefs-reduce-motion *::before,
        body.prefs-reduce-motion *::after {
            animation-duration: 1ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0s !important;
            scroll-behavior: auto !important;
        }

        body.prefs-keyboard-hints .view-toggle button::after {
            content: attr(data-shortcut);
            margin-left: 6px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            align-items: flex-start;
        }

        .preferences-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-subtle);
        }

        .preferences-field label span,
        .preferences-field span.preference-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--navy-700);
        }

        .preferences-field select,
        .preferences-field input[type="number"] {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            background: rgba(233, 236, 255, 0.28);
            font-size: 0.9rem;
            color: var(--navy-700);
        }

        .preferences-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--navy-700);
        }

        .preferences-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .preferences-note {
            font-size: 0.8rem;
            color: var(--text-subtle);
            margin: 6px 0 0 0;
        }

        body.preferences-open {
            overflow: hidden;
        }

        @media (max-width: 720px) {
            .preferences-modal {
                padding: 20px;
                width: calc(100% - 24px);
                max-height: calc(100vh - 80px);
            }
            .preferences-tabs {
                gap: 8px;
            }
            .preferences-modal footer {
                flex-direction: column;
                align-items: stretch;
            }
            .preferences-modal footer button {
                width: 100%;
            }
        }

        .toolbar__audience-toggle {
            display: inline-flex;
            align-items: center;
            padding: 4px;
            gap: 6px;
            border-radius: 999px;
            border: 1px solid rgba(233, 236, 255, 0.2);
            background: rgba(233, 236, 255, 0.1);
        }

        .toolbar__audience-toggle-btn {
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.78);
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .toolbar__audience-toggle-btn:is(:hover, :focus-visible) {
            color: #fff;
            background: rgba(233, 236, 255, 0.2);
            transform: translateY(-1px);
        }

        .toolbar__audience-toggle-btn.is-active {
            background: #ffffff;
            color: var(--navy-700);
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(110, 123, 255, 0.28);
        }

        button,
        select {
            font: inherit;
        }

        .pill-button {
            padding: 10px 18px;
            border-radius: 999px;
            border: 1px solid rgba(233, 236, 255, 0.24);
            background: rgba(233, 236, 255, 0.08);
            color: #fff;
            cursor: pointer;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
        }

        .pill-button:is(:hover, :focus-visible) {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(110, 123, 255, 0.36);
            background: rgba(233, 236, 255, 0.18);
        }

        .pill-button.is-primary {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            font-weight: 600;
        }

        .pill-button.is-primary:is(:hover, :focus-visible) {
            background: linear-gradient(135deg, var(--accent-400), var(--accent-200));
        }

        .toolbar__document-select {
            border-radius: 999px;
            padding: 10px 18px;
            border: 1px solid rgba(233, 236, 255, 0.2);
            background: rgba(233, 236, 255, 0.08);
            color: #fff;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 280px minmax(520px, 1fr) 360px;
            gap: 24px;
            padding: 32px 28px 80px;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
        }

        .pane {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            min-height: 540px;
        }

        h1, h2, h3, h4 {
            font-family: "Segoe UI", "Inter", sans-serif;
            margin: 0;
        }

        .filters h2,
        .builder h2 {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            margin-bottom: 8px;
        }

        .filters {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .filters > p {
            font-size: 0.82rem !important;
            line-height: 1.4;
            margin: 0 0 16px 0 !important;
        }

        .filters__group {
            margin-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filters__group h3 {
            font-size: 0.7rem !important;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-subtle);
            margin: 0 0 4px 0;
            font-weight: 600;
            opacity: 0.6;
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .chip-row[data-empty="true"]::after {
            content: "Type state abbreviation to filter";
            font-size: 0.75rem;
            color: var(--text-subtle);
            opacity: 0.4;
            font-style: italic;
        }

        .chip {
            padding: 5px 10px;
            border-radius: 6px;
            background: rgba(233, 236, 255, 0.3);
            border: 1px solid rgba(110, 123, 255, 0.12);
            color: var(--navy-700);
            font-size: 0.78rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .chip:is(:hover, :focus-visible) {
            transform: translateY(-1px);
            background: rgba(110, 123, 255, 0.1);
            border-color: rgba(110, 123, 255, 0.3);
            box-shadow: 0 2px 6px rgba(110, 123, 255, 0.15);
        }

        .chip.is-active {
            background: linear-gradient(135deg, rgba(110, 123, 255, 0.2), rgba(110, 123, 255, 0.12));
            border-color: #6E7BFF;
            color: #6E7BFF;
            font-weight: 600;
            box-shadow: 0 1px 4px rgba(110, 123, 255, 0.2);
        }

        /* Special handling for state chips */
        .filters__group[aria-label="State"] .chip-row {
            max-height: 150px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2px;
        }

        .filters__group[aria-label="State"] .chip {
            padding: 3px 8px;
            font-size: 0.72rem;
        }

        /* Scrollbar styling for state list */
        .filters__group[aria-label="State"] .chip-row::-webkit-scrollbar {
            width: 4px;
        }

        .filters__group[aria-label="State"] .chip-row::-webkit-scrollbar-track {
            background: rgba(110, 123, 255, 0.05);
            border-radius: 2px;
        }

        .filters__group[aria-label="State"] .chip-row::-webkit-scrollbar-thumb {
            background: rgba(110, 123, 255, 0.2);
            border-radius: 2px;
        }

        .filters__group[aria-label="State"] .chip-row::-webkit-scrollbar-thumb:hover {
            background: rgba(110, 123, 255, 0.3);
        }

        .filters__meta {
            margin-top: auto;
            padding-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-top: 1px solid rgba(21, 22, 51, 0.08);
        }

        .filters__meta small {
            color: var(--text-subtle);
        }

        .results {
            position: relative;
            gap: 24px;
        }

        .results__header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 12px;
        }

        .results__header-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .results__count {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .results__filters {
            color: var(--text-subtle);
            font-size: 0.85rem;
        }

        .results__controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .results-controls-bar {
            position: sticky;
            top: calc(var(--app-shell-top-offset, 64px) + var(--programs-toolbar-height, 128px) + 8px);
            z-index: 85;
            margin-bottom: 18px;
            background: #ffffff;
            border: 1px solid rgba(21, 22, 51, 0.06);
            border-radius: 18px;
            padding: 12px 18px;
            box-shadow: 0 12px 32px rgba(15, 16, 32, 0.08);
            backdrop-filter: blur(12px);
        }

        .results__pagination {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            font-size: 0.85rem;
            padding: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(110, 123, 255, 0.1);
        }

        .results__pagination.is-disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .pagination-button {
            width: 36px;
            height: 36px;
            border-radius: 999px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            background: var(--neutral-50);
            color: var(--navy-700);
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .pagination-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-button:is(:hover, :focus-visible):not(:disabled) {
            background: rgba(110, 123, 255, 0.12);
            color: var(--navy-900);
            transform: translateY(-1px);
        }

        .pagination-status {
            white-space: nowrap;
            color: var(--text-subtle);
        }

        .pagination-size {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding-left: 12px;
            border-left: 1px solid rgba(21, 22, 51, 0.08);
        }

        .pagination-size select {
            border: 1px solid rgba(21, 22, 51, 0.12);
            border-radius: 999px;
            padding: 6px 24px 6px 12px;
            background: var(--neutral-50);
            color: var(--text-strong);
            font-size: 0.85rem;
        }

        .view-toggle {
            display: inline-flex;
            padding: 4px;
            border-radius: 999px;
            background: var(--neutral-50);
            border: 1px solid rgba(21, 22, 51, 0.08);
            gap: 6px;
        }

        .view-toggle button {
            border: none;
            background: transparent;
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 0.85rem;
            color: var(--text-subtle);
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .view-toggle button.is-active {
            background: #e2e8f0;
            color: var(--navy-700);
            font-weight: 600;
            transform: translateY(-1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .results select {
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid rgba(21, 22, 51, 0.08);
            background: var(--neutral-50);
            color: var(--text-strong);
        }

        .results__grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            align-items: stretch;
        }

        .results__grid.is-compact {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 18px;
        }

        .results__map {
            display: none;
            width: 100%;
            flex: 1;
            min-height: 420px;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-card);
        }

        .results__map.is-visible {
            display: block;
        }

        .map-legend {
            position: absolute;
            top: 120px;
            right: 24px;
            padding: 12px 16px;
            background: #ffffff;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
            display: none;
            flex-direction: column;
            gap: 8px;
            font-size: 0.78rem;
            color: var(--text-subtle);
            z-index: 10;
        }

        .map-legend.is-visible {
            display: flex;
        }

        .map-legend__title {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-subtle);
        }

        .map-legend__row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-legend__count {
            margin-left: auto;
            font-weight: 600;
            color: var(--text-strong);
        }

        .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 6px rgba(15, 16, 32, 0.2);
        }

        .legend-swatch--onsite {
            background: #6E7BFF;
        }

        .legend-swatch--hybrid {
            background: linear-gradient(135deg, #6E7BFF, #4CAF9F);
        }

        .legend-swatch--virtual {
            background: #10B981;
        }

        .legend-swatch--telehealth {
            background: #FFA94D;
        }

        .results__map {
            display: none;
            flex-direction: column;
            gap: 12px;
            min-height: 480px;
            position: relative;
        }

        .results__map.is-visible {
            display: flex;
        }

        .map-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            background: rgba(233, 236, 255, 0.4);
            border: 1px solid rgba(110, 123, 255, 0.16);
            color: var(--text-subtle);
            font-size: 0.85rem;
        }

        .map-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-canvas {
            flex: 1;
            min-height: 440px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid rgba(110, 123, 255, 0.18);
            box-shadow: var(--shadow-soft);
        }

        .leaflet-container {
            width: 100%;
            height: 100%;
        }

        .map-legend {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .map-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .map-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-subtle);
        }

        .map-control__input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-control__input-row input {
            flex: 1;
        }

        .map-control span strong {
            color: var(--navy-700);
        }

        .map-control input[type="text"],
        .map-control select,
        .map-control input[type="range"] {
            border-radius: 10px;
            border: 1px solid rgba(110, 123, 255, 0.24);
            background: rgba(255, 255, 255, 0.85);
            color: var(--text-strong);
            font-size: 0.82rem;
            padding: 6px 10px;
        }

        .map-control input[type="text"]:focus,
        .map-control select:focus {
            outline: none;
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.9);
        }

        .map-control--radius input[type="range"] {
            width: 160px;
            padding: 0;
            background: transparent;
        }

        .map-control__button {
            border: none;
            border-radius: 999px;
            background: rgba(110, 123, 255, 0.2);
            color: var(--navy-700);
            padding: 6px 14px;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .map-control__button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.32);
            transform: translateY(-1px);
        }

        .map-control--presets {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .map-control--presets-label {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            color: var(--text-subtle);
        }

        .map-control__preset {
            border: none;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(110, 123, 255, 0.18);
            color: var(--navy-700);
            cursor: pointer;
            transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
        }

        .map-control__preset:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.32);
            transform: translateY(-1px);
        }

        .map-control__preset.is-active {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            box-shadow: 0 8px 18px rgba(110, 123, 255, 0.25);
        }

        .map-legend__item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78rem;
            color: var(--text-subtle);
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(21, 22, 51, 0.08);
        }

        .map-marker-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-500);
        }

        .results__compare {
            display: none;
            flex-direction: column;
            gap: 16px;
        }

        .results__compare.is-visible {
            display: flex;
        }

        .compare-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(110, 123, 255, 0.16);
            background: rgba(233, 236, 255, 0.4);
        }

        .compare-status {
            font-size: 0.85rem;
            color: var(--text-subtle);
        }

        .compare-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .compare-action__button {
            border: none;
            border-radius: 999px;
            padding: 6px 14px;
            background: rgba(110, 123, 255, 0.2);
            color: var(--navy-700);
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .compare-action__button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.32);
            transform: translateY(-1px);
        }

        .compare-grid {
            display: grid;
            gap: 16px;
            overflow-x: auto;
        }

        .compare-grid--columns-1 {
            grid-template-columns: minmax(240px, 320px);
        }

        .compare-grid--columns-2 {
            grid-template-columns: repeat(2, minmax(240px, 1fr));
        }

        .compare-grid--columns-3 {
            grid-template-columns: repeat(3, minmax(240px, 1fr));
        }

        .compare-grid--columns-4 {
            grid-template-columns: repeat(4, minmax(240px, 1fr));
        }

        .compare-card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(110, 123, 255, 0.2);
            box-shadow: var(--shadow-soft);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }

        .compare-card header {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .compare-header-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .compare-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.74rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            background: rgba(110, 123, 255, 0.16);
            color: var(--navy-700);
        }

        .compare-tag.is-different {
            background: rgba(255, 196, 0, 0.28);
            color: #5b4200;
            box-shadow: 0 6px 18px rgba(255, 196, 0, 0.28);
        }

        .compare-remove {
            position: absolute;
            top: 12px;
            right: 12px;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            background: rgba(21, 22, 51, 0.1);
            color: var(--navy-700);
            cursor: pointer;
            font-weight: 600;
        }

        .compare-remove:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.25);
        }

        .compare-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .compare-meta__item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.72rem;
            color: var(--navy-700);
            background: rgba(110, 123, 255, 0.18);
        }

        .compare-meta__item.is-different {
            background: rgba(16, 185, 129, 0.22);
            color: #0f5c46;
            box-shadow: 0 6px 18px rgba(16, 185, 129, 0.18);
        }

        .compare-meta__item--lane {
            border: 1px dashed rgba(110, 123, 255, 0.35);
            background: rgba(233, 236, 255, 0.35);
            color: var(--navy-700);
            font-weight: 600;
        }

        .compare-meta__item--lane.is-empty {
            background: rgba(255, 143, 143, 0.24);
            border-color: rgba(255, 143, 143, 0.45);
            color: #7a1e1e;
        }

        .compare-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
            border-radius: 12px;
            padding: 8px 10px;
        }

        .compare-section--diff {
            border-left: 3px solid var(--accent-500);
            background: rgba(110, 123, 255, 0.12);
            box-shadow: inset 0 0 0 1px rgba(110, 123, 255, 0.12);
        }

        .compare-section h4 {
            margin: 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-subtle);
        }

        .compare-list {
            margin: 0;
            padding-left: 18px;
            display: grid;
            gap: 4px;
            font-size: 0.82rem;
            color: var(--text-subtle);
        }

        .compare-empty {
            padding: 24px;
            border: 1px dashed rgba(110, 123, 255, 0.35);
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-subtle);
            background: rgba(233, 236, 255, 0.35);
        }

        .program-card.is-compared {
            border-color: rgba(110, 123, 255, 0.6);
            box-shadow: 0 16px 40px rgba(110, 123, 255, 0.18);
        }

        .program-card__actions .compare-toggle {
            background: rgba(21, 22, 51, 0.08);
        }

        .program-card__actions .compare-toggle.is-active {
            background: linear-gradient(135deg, rgba(110, 123, 255, 0.22), rgba(110, 123, 255, 0.08));
            color: var(--navy-700);
        }

        .virtual-sentinel {
            width: 100%;
            height: 24px;
        }

        .map-cluster-icon {
            background: linear-gradient(135deg, rgba(110, 123, 255, 0.9), rgba(110, 123, 255, 0.75));
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 14px 28px rgba(15, 16, 32, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.85);
        }

        .leaflet-popup-button {
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 999px;
            background: linear-gradient(135deg, var(--accent-500), var(--accent-200));
            color: var(--navy-900);
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }

        .leaflet-popup-button:is(:hover, :focus-visible) {
            background: linear-gradient(135deg, var(--accent-400), var(--accent-200));
        }


        .program-card {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 20px;
            border-radius: var(--radius-md);
            background: #ffffff;
            border: 1px solid rgba(145, 153, 225, 0.18);
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
            transform: translateY(6px);
            opacity: 0;
            animation: cardIn var(--transition-medium) forwards;
            min-height: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            height: 100%;
        }

        .program-card::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(circle at top right, rgba(110, 123, 255, 0.12), transparent 45%);
        }

        .program-card__header {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .program-card__title {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .program-card__title h3 {
            font-size: 1.05rem;
            line-height: 1.3;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .program-card__meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(110, 123, 255, 0.15);
            color: var(--navy-700);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }

        .badge--neutral {
            background: rgba(21, 22, 51, 0.08);
            color: var(--text-subtle);
        }

        .badge--distance {
            background: rgba(110, 123, 255, 0.22);
            color: var(--navy-700);
        }

        .badge--note {
            background: rgba(255, 196, 0, 0.24);
            color: #5b4200;
        }

        .program-card__summary {
            font-size: 0.92rem;
            color: var(--text-subtle);
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin: 0;
            min-height: 3em;
            max-height: 3em;
        }

        .program-card__tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .program-card__tag {
            font-size: 0.75rem;
            padding: 4px 12px;
            background: rgba(233, 236, 255, 0.7);
            border-radius: 999px;
            color: var(--navy-500);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }

        .program-card__actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-top: auto;
            padding-top: 12px;
        }

        .program-card__actions select {
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            background: var(--neutral-50);
            color: var(--text-strong);
        }

        .program-card__actions .pill-button {
            /* Make card actions feel lighter and less dominant */
            flex: 0 0 auto;
            justify-content: center;
            text-align: center;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 999px;
        }

        .program-card__actions .compare-toggle {
            border: 1.5px solid #6E7BFF;
            background: transparent;
            color: #6E7BFF;
            font-weight: 600;
        }

        .program-card__actions .compare-toggle:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.1);
            border-color: #8D97FF;
            box-shadow: 0 4px 12px rgba(110, 123, 255, 0.2);
        }

        .program-card__actions .compare-toggle.is-active {
            background: #6E7BFF;
            border-color: #6E7BFF;
            color: white;
            box-shadow: 0 8px 20px rgba(110, 123, 255, 0.35);
        }

        .program-card__actions .compare-toggle:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .program-card__actions button[data-action="details"] {
            border: 1.5px solid #6E7BFF;
            background: transparent;
            color: #6E7BFF;
            font-weight: 600;
        }

        .program-card__actions button[data-action="details"]:hover {
            background: rgba(110, 123, 255, 0.1);
            border-color: #8D97FF;
        }

        .builder {
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .builder header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
        }

        .builder__meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-subtle);
        }

        .builder__context {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px dashed rgba(110, 123, 255, 0.35);
            background: rgba(233, 236, 255, 0.6);
            color: var(--text-subtle);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .builder__context strong {
            color: var(--navy-700);
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .builder__context span {
            font-size: 0.78rem;
        }

        .builder__context.is-empty {
            border-style: dotted;
            background: rgba(233, 236, 255, 0.35);
        }

        .builder__lanes {
            display: flex;
            flex-direction: column;
            gap: 18px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .builder-tile--manual {
            border: 1px solid rgba(110, 123, 255, 0.22);
            background: rgba(255, 255, 255, 0.94);
        }

        .builder-program-heading {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .builder-track-chip {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            background: rgba(110, 123, 255, 0.16);
            color: var(--navy-700);
            white-space: nowrap;
        }

        .builder-track-chip[data-track="strong-alt"] {
            background: rgba(255, 196, 0, 0.2);
            color: #805002;
        }

        .builder-track-chip[data-track="local-step-down"] {
            background: rgba(76, 175, 159, 0.24);
            color: #1f5f54;
        }

        .builder-track-chip[data-track="at-home-support"] {
            background: rgba(111, 207, 221, 0.24);
            color: #166b78;
        }

        .builder-track-chip[data-track="alumni"] {
            background: rgba(135, 123, 255, 0.2);
            color: #2f3180;
        }

        .builder-track-select {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-subtle);
        }

        .track-select-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .track-select-row select {
            border-radius: 12px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            padding: 8px 12px;
            background: rgba(233, 236, 255, 0.28);
            font-size: 0.85rem;
            color: var(--text-strong);
        }

        .track-select-row select:focus {
            outline: none;
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.4);
        }

        .track-apply-button {
            border: none;
            background: rgba(110, 123, 255, 0.18);
            color: var(--navy-700);
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .track-apply-button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.32);
            transform: translateY(-1px);
        }

        .builder-manual-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .builder-manual-header input[type="text"] {
            border: 1px solid rgba(21, 22, 51, 0.12);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 0.85rem;
            background: rgba(233, 236, 255, 0.28);
            transition: border var(--transition-fast), background var(--transition-fast);
        }

        .builder-manual-header input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.4);
        }

        .builder-manual-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .builder-manual-meta input[type="text"] {
            flex: 1;
            min-width: 140px;
        }

        .lane {
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius-md);
            border: 1px solid rgba(145, 153, 225, 0.22);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .builder-editor {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .editor-toolbar button {
            border: none;
            background: rgba(21, 22, 51, 0.08);
            color: var(--navy-700);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast), color var(--transition-fast);
        }

        .editor-toolbar button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.2);
            color: var(--navy-500);
            transform: translateY(-1px);
        }

        .editor-surface {
            min-height: 96px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            border-radius: 12px;
            padding: 10px 12px;
            background: rgba(233, 236, 255, 0.22);
            font-size: 0.85rem;
            line-height: 1.45;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .editor-surface:focus {
            outline: none;
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.32);
        }

        .editor-surface:empty::before {
            content: attr(data-placeholder);
            color: var(--text-subtle);
            pointer-events: none;
        }

        .lane__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .lane__title {
            display: flex;
            flex-direction: column;
        }

        .lane__title span {
            font-size: 0.8rem;
            color: var(--text-subtle);
        }

        .lane__add {
            border: none;
            background: rgba(110, 123, 255, 0.1);
            color: var(--navy-700);
            border-radius: 999px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            gap: 6px;
            align-items: center;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .lane__add:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.22);
            transform: translateY(-1px);
        }

        .lane__list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .builder-tile {
            background: var(--surface);
            border-radius: 16px;
            padding: 14px 16px 16px;
            border: 1px solid rgba(110, 123, 255, 0.16);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 12px;
            animation: tileIn var(--transition-medium) forwards;
        }

        .builder-tile__title {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .builder-tile__title small {
            color: var(--text-subtle);
            font-size: 0.75rem;
        }

        .builder-tile label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-subtle);
        }

        .builder-tile input,
        .builder-tile textarea {
            border-radius: 12px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            padding: 8px 10px;
            font-size: 0.85rem;
            font-family: inherit;
            color: var(--text-strong);
            background: rgba(233, 236, 255, 0.2);
            transition: border var(--transition-fast), background var(--transition-fast);
        }

        .builder-tile textarea {
            resize: vertical;
            min-height: 56px;
        }

        .builder-clinician-note {
            background: rgba(233, 236, 255, 0.32);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 0.8rem;
            line-height: 1.45;
            color: var(--navy-700);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .builder-clinician-note strong {
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-subtle);
        }

        .builder-clinician-note[data-empty="true"] {
            background: rgba(233, 236, 255, 0.18);
            color: var(--text-subtle);
        }

        .builder-tile input:focus,
        .builder-tile textarea:focus {
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.35);
            outline: none;
        }

        .builder-tile__actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .tile-actions {
            display: inline-flex;
            gap: 6px;
        }

        .tile-actions button {
            border: none;
            background: rgba(21, 22, 51, 0.08);
            color: var(--navy-700);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background var(--transition-fast), transform var(--transition-fast);
        }

        .tile-actions button:is(:hover, :focus-visible) {
            background: rgba(110, 123, 255, 0.16);
            transform: translateY(-1px);
        }

        .builder-hint {
            font-size: 0.72rem;
            color: var(--text-subtle);
        }

        .details-panel {
            position: fixed;
            top: 88px;
            right: -640px;
            width: 520px;
            max-width: min(640px, 100% - 80px);
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 28px 60px rgba(15, 16, 32, 0.26);
            padding: 28px 28px 18px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 120; /* Above the in-module toolbar (z-index 90) */
            transition: right var(--transition-medium);
            max-height: calc(100vh - 104px);
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .details-panel.is-open {
            right: 40px;
        }

        .details-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 16, 32, 0.45);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
            z-index: 110; /* Below panel, above toolbar and content */
        }

        .details-overlay.is-active {
            opacity: 1;
            pointer-events: all;
        }

        .details-panel header {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .details-panel header h2 {
            font-size: 1.25rem;
            line-height: 1.3;
        }

        .details-panel__meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .details-panel__section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .details-panel__section h3 {
            font-size: 0.8rem;
            color: var(--text-subtle);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .details-panel__list {
            padding-left: 18px;
            margin: 0;
            display: grid;
            gap: 6px;
            color: var(--text-subtle);
        }

        .details-panel__notes {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .details-panel__notes textarea {
            border-radius: 12px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            padding: 10px 12px;
            font-size: 0.9rem;
            font-family: inherit;
            color: var(--text-strong);
            background: rgba(233, 236, 255, 0.2);
            resize: vertical;
            min-height: 96px;
        }

        .details-panel__notes textarea:focus {
            outline: none;
            border-color: var(--accent-400);
            background: rgba(233, 236, 255, 0.35);
        }

        .details-panel__notes-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-subtle);
        }

        .details-panel__notes-clear {
            border: none;
            background: transparent;
            color: var(--accent-500);
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            padding: 0;
        }

        .details-panel__notes-clear:is(:hover, :focus-visible) {
            text-decoration: underline;
            color: var(--accent-400);
        }

        .details-panel__contact-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .details-panel__contact-grid a,
        .details-panel__contact-grid span {
            font-size: 0.85rem;
        }

        .details-panel__contact-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .details-panel__actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .details-close {
            position: absolute;
            top: 16px;
            right: 16px;
            border: none;
            background: rgba(21, 22, 51, 0.08);
            border-radius: 999px;
            width: 34px;
            height: 34px;
            cursor: pointer;
            font-weight: 600;
            color: var(--navy-700);
        }

        .quick-add {
            position: fixed;
            bottom: 28px;
            right: 32px;
            width: 340px;
            max-width: calc(100% - 48px);
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 48px rgba(15, 16, 32, 0.28);
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 40;
        }

        .quick-add.is-visible {
            display: flex;
        }

        .quick-add select {
            width: 100%;
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(21, 22, 51, 0.12);
            background: rgba(233, 236, 255, 0.35);
        }

        .quick-add__actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .app-footer {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            margin-top: 40px;
            padding: 18px 28px;
            color: var(--text-subtle);
            font-size: 0.8rem;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            opacity: 0.5;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(139, 92, 246, 0.9));
            color: #fff;
            padding: 12px 18px;
            border-radius: 12px;
            box-shadow: 0 18px 36px rgba(15, 16, 32, 0.32);
            transform: translateY(-18px);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast), transform var(--transition-fast);
            z-index: 60;
        }

        .toast.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .sr-announcer {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @keyframes cardIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes tileIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1380px) {
            .app-shell {
                grid-template-columns: 260px minmax(420px, 1fr) 320px;
            }

            .toolbar {
                grid-template-columns: 1fr;
                grid-auto-rows: auto;
            }

            .toolbar__brand {
                order: 1;
            }

            .toolbar__search {
                order: 2;
            }

            .toolbar__actions {
                order: 3;
                justify-content: flex-end;
            }
        }

        @media (max-width: 1120px) {
            .app-shell {
                grid-template-columns: minmax(0, 1fr);
            }

            .filters {
                order: 1;
                flex-direction: column;
            }

            .results {
                order: 2;
            }

            .builder {
                order: 3;
                position: relative;
            }

            .details-panel {
                top: 80px;
                right: 16px;
                width: calc(100% - 32px);
                max-width: none;
                max-height: calc(100vh - 96px);
            }

            .results-controls-bar {
                position: sticky;
                top: calc(var(--app-shell-top-offset, 64px) + var(--programs-toolbar-height, 132px));
                flex-direction: column;
                gap: 12px;
            }

            .results__controls {
                width: 100%;
                flex-wrap: wrap;
                justify-content: space-between;
            }

            .results__pagination {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 1200px) {
            .results__grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .results__grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .program-card__actions {
                flex-direction: column;
            }
            
            .program-card__actions .pill-button {
                width: 100%;
            }
        }

        @media (max-width: 720px) {
            .toolbar {
                padding: 16px;
            }

            .app-shell {
                padding: 24px 18px 72px;
            }

            .pane {
                padding: 18px;
            }

            .results-controls-bar {
                position: static;
                box-shadow: none;
            }

            .results__controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .results__pagination {
                flex-wrap: wrap;
                justify-content: flex-start;
                gap: 12px;
            }

            .pagination-size {
                border-left: none;
                padding-left: 0;
            }

            .view-toggle {
                width: 100%;
                justify-content: space-between;
            }

            .results__grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }

            .app-footer {
                padding: 24px 18px 64px;
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 1ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 1ms !important;
                scroll-behavior: auto !important;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(233, 236, 255, 0.4);
            border-radius: 999px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(110, 123, 255, 0.45);
            border-radius: 999px;
        }
    </style>
</head>
<body>
    <div class="sr-announcer" id="srAnnouncer" aria-live="polite"></div>
    <div class="details-overlay" id="detailsOverlay" aria-hidden="true"></div>
    <header class="toolbar" role="banner">
        <div class="toolbar__brand">
            <span>CC</span>
            <div>
                CareConnect
                <div style="font-size:0.75rem; opacity:0.7;">Programs + Document Creator</div>
            </div>
        </div>
        <div class="toolbar__search">
            <label for="globalSearch" aria-label="Search programs">
                ðŸ”
                <input id="globalSearch" type="search" placeholder="Search programs, modalities, or keywords (press `/` to focus)">
            </label>
        </div>
        <div class="toolbar__actions">
            <button type="button"
                    class="toolbar__preferences-btn"
                    id="openPreferencesButton"
                    aria-label="Open preferences"
                    aria-haspopup="dialog"
                    aria-controls="preferencesModal"
                    aria-expanded="false">
                âš™ï¸
            </button>
            <div class="toolbar__document-toggle" role="group" aria-label="Document type">
                <button type="button" class="toolbar__document-toggle-btn is-active" data-doc-type="aftercare-options" aria-pressed="true">
                    Aftercare Options
                </button>
                <button type="button" class="toolbar__document-toggle-btn" data-doc-type="aftercare-plan" aria-pressed="false">
                    Aftercare Plan
                </button>
            </div>
            <div class="toolbar__audience-toggle" role="group" aria-label="Audience view mode">
                <button type="button" class="toolbar__audience-toggle-btn is-active" data-audience="clinician" aria-pressed="true">
                    Clinician
                </button>
                <button type="button" class="toolbar__audience-toggle-btn" data-audience="family" aria-pressed="false">
                    Family
                </button>
            </div>
            <button class="pill-button" type="button" id="saveDraftButton">Save Draft</button>
            <button class="pill-button is-primary" type="button" id="generateDocumentButton">Generate Document</button>
        </div>
    </header>

    <main class="app-shell">
        <aside class="pane filters" aria-label="Program filters">
            <h2>Filter Programs</h2>
            <p>
                Narrow by focus, delivery format, or alignment to insurance resources. Filters stack to refine results.
            </p>

            <section class="filters__group" aria-label="Focus areas">
                <h3>Focus</h3>
                <div class="chip-row">
                    <button class="chip" data-group="focus" data-value="Intensive Outpatient">Intensive Outpatient</button>
                    <button class="chip" data-group="focus" data-value="Partial Hospitalization">Partial Hospitalization</button>
                    <button class="chip" data-group="focus" data-value="Family Systems">Family Systems</button>
                </div>
            </section>

            <section class="filters__group" aria-label="Format">
                <h3>Format</h3>
                <div class="chip-row">
                    <button class="chip" data-group="format" data-value="Hybrid">Hybrid</button>
                    <button class="chip" data-group="format" data-value="Onsite">Onsite</button>
                    <button class="chip" data-group="format" data-value="Virtual">Virtual</button>
                </div>
            </section>

            <section class="filters__group" aria-label="Insurance alignment">
                <h3>Insurance Alignment</h3>
                <div class="chip-row">
                    <button class="chip" data-group="insurance" data-value="In-Network">In-Network</button>
                    <button class="chip" data-group="insurance" data-value="OON w/ Negotiation">OON with Negotiation</button>
                    <button class="chip" data-group="insurance" data-value="Scholarship Track">Scholarship Track</button>
                </div>
            </section>

            <section class="filters__group" aria-label="State">
                <h3>State</h3>
                <div class="chip-row" id="stateFilterChips" data-empty="true"></div>
            </section>

            <section class="filters__group" aria-label="Quick toggles">
                <h3>Quick Toggles</h3>
                <div class="chip-row">
                    <button class="chip" data-group="flag" data-value="Immediate">Immediate Starts</button>
                    <button class="chip" data-group="flag" data-value="Openings">Openings this Week</button>
                    <button class="chip" data-group="flag" data-value="Family">Includes Family Work</button>
                </div>
            </section>

            <div class="filters__meta">
                <small id="activeFiltersLabel">No filters active</small>
                <button class="pill-button" type="button" id="clearFiltersButton">Clear Filters</button>
            </div>
        </aside>

        <section class="pane results" aria-labelledby="resultsHeading">
            <div class="results__header">
                <div class="results__header-info">
                    <div class="results__count" id="resultsHeading">Programs Ready for Next Step</div>
                    <div class="results__filters" id="resultsSummary">Loading programsâ€¦</div>
                </div>
            </div>
            <div class="results-controls-bar" role="region" aria-label="Program layout and sorting controls">
                <div class="results__controls">
                    <div class="view-toggle" role="group" aria-label="Change program layout">
                        <button type="button" class="is-active" data-view="grid" aria-pressed="true">Grid</button>
                        <button type="button" data-view="rows" aria-pressed="false">Rows</button>
                        <button type="button" data-view="compare" aria-pressed="false">Compare</button>
                        <button type="button" data-view="map" aria-pressed="false">Map</button>
                    </div>
                    <label for="sortSelect" style="font-size:0.85rem; color: var(--text-subtle); display:flex; gap:8px; align-items:center;">
                        Sort
                        <select id="sortSelect">
                            <option value="availability" selected>Availability (Soonest)</option>
                            <option value="acuity">Acuity (High â†’ Low)</option>
                            <option value="distance">Distance (Nearest)</option>
                        </select>
                    </label>
                    <div class="results__pagination" id="paginationControls" role="group" aria-label="Program pagination controls">
                        <button type="button" class="pagination-button" id="paginationPrevButton" aria-label="Previous page">&lsaquo;</button>
                        <span class="pagination-status" id="paginationStatus">Loadingâ€¦</span>
                        <button type="button" class="pagination-button" id="paginationNextButton" aria-label="Next page">&rsaquo;</button>
                        <label class="pagination-size" for="paginationPageSize">
                            Per page
                            <select id="paginationPageSize" aria-label="Programs per page">
                                <option value="12">12</option>
                                <option value="24" selected>24</option>
                                <option value="48">48</option>
                                <option value="all">All</option>
                            </select>
                        </label>
                    </div>
                </div>
            </div>
            <div class="results__grid" id="resultsGrid" role="list"></div>
            <section class="results__map" id="resultsMapContainer" aria-label="Program map workspace">
                <div class="map-toolbar">
                    <div class="map-status" id="mapStatusLabel" role="status" aria-live="polite">
                        Map view ready. Adjust filters or tap markers to explore programs.
                    </div>
                    <div class="map-controls" id="mapControls">
                        <label class="map-control">
                            <span>Home ZIP</span>
                            <div class="map-control__input-row">
                                <input type="text" id="mapZipInput" inputmode="numeric" pattern="\\d*" maxlength="5" placeholder="e.g. 33458" aria-label="Set home ZIP code">
                                <button type="button" class="map-control__button" id="mapHomeSaveButton" aria-label="Save home ZIP for distance calculations">Set Home</button>
                            </div>
                        </label>
                        <label class="map-control map-control--radius">
                            <span>Radius <strong id="mapRadiusValue">50 mi</strong></span>
                            <input type="range" id="mapRadiusInput" min="5" max="500" value="50" step="5" aria-label="Adjust search radius in miles">
                        </label>
                        <div class="map-control map-control--presets" role="group" aria-label="Radius presets">
                            <span class="map-control--presets-label">Presets</span>
                            <button type="button" class="map-control__preset is-active" data-radius-preset="local">Local Â· 25 mi</button>
                            <button type="button" class="map-control__preset" data-radius-preset="regional">Regional Â· 75 mi</button>
                            <button type="button" class="map-control__preset" data-radius-preset="national">Nationwide</button>
                        </div>
                        <label class="map-control">
                            <span>Focus</span>
                            <select id="mapDistanceFilter" aria-label="Filter map by service focus">
                                <option value="all" selected>All resources</option>
                                <option value="therapy">Therapy / Counseling</option>
                                <option value="psychiatry">Psychiatry</option>
                                <option value="iop">IOP / Day Programs</option>
                                <option value="virtual">Virtual Support</option>
                            </select>
                        </label>
                        <button type="button" class="map-control__button" id="mapLocateButton" aria-label="Use my current location">My Location</button>
                    </div>
                    <div class="map-legend" id="mapLegend"></div>
                </div>
                <div class="map-canvas" id="resultsMapCanvas" role="presentation"></div>
            </section>
            <section class="results__compare" id="resultsCompareContainer" aria-label="Program comparison workspace">
                <header class="compare-toolbar">
                    <div class="compare-status" id="compareStatusLabel" role="status" aria-live="polite">Select up to four programs to compare.</div>
                    <div class="compare-actions">
                        <button type="button" class="compare-action__button" id="compareAddAllButton">Add All to Builder</button>
                        <button type="button" class="compare-action__button" id="compareExportButton">Export Snapshot</button>
                        <button type="button" class="compare-action__button" id="comparePrintButton">Print</button>
                    </div>
                </header>
                <div class="compare-grid" id="compareGrid"></div>
            </section>
        </section>

        <aside class="pane builder" aria-label="Document builder">
            <header>
                <h2>Document Builder</h2>
                <div class="builder__meta">
                    <span id="builderSummary" aria-live="polite">No programs added yet</span>
                    <span id="draftStatus" aria-live="polite">Draft not saved</span>
                </div>
            </header>
            <div class="builder__context" id="builderClientContext" role="status" aria-live="polite"></div>
            <div class="builder__lanes" id="builderLanes" aria-live="polite"></div>
        </aside>
    </main>

    <section class="details-panel" id="detailsPanel" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
        <button class="details-close" type="button" aria-label="Close details" id="closeDetailsButton">Ã—</button>
        <header>
            <h2 id="detailsTitle">Select a program</h2>
            <p id="detailsSubtitle" style="margin:0; color: var(--text-subtle); font-size:0.88rem;">
                View licensing, clinical programming, outcomes, and contacts without leaving the workflow.
            </p>
            <div class="details-panel__meta" id="detailsMeta"></div>
        </header>
        <div id="detailsBody" class="details-panel__body" style="display:flex; flex-direction:column; gap:18px;">
            <p style="color: var(--text-subtle);">
                Select any program card to view deeper details, clinical highlights, and handoff guidance. Keyboard: press <strong>C</strong> to open the highlighted program.
            </p>
        </div>
        <div class="details-panel__section details-panel__notes" id="detailsNotesSection" hidden>
            <h3>Clinician Notes</h3>
            <textarea id="detailsNotesInput" placeholder="Capture family context, payor guardrails, or warm handoff steps."></textarea>
            <div class="details-panel__notes-footer">
                <span id="detailsNotesStatus">Autosaves to this device</span>
                <button type="button" class="details-panel__notes-clear" id="detailsNotesClearButton">Clear</button>
            </div>
        </div>
        <div class="details-panel__actions">
            <button class="pill-button" type="button" id="detailsAddButton">Add to Builder</button>
            <button class="pill-button" type="button" id="detailsCompareNetworkButton" style="display:none;">Compare Network</button>
            <button class="pill-button is-primary" type="button" id="detailsGenerateButton">Generate with This Program</button>
        </div>
    </section>

    <section class="quick-add" id="quickAddSheet" aria-hidden="true" aria-label="Quick add program to builder">
        <h3 style="margin:0; font-size:1rem;">Quick Add</h3>
        <label style="display:flex; flex-direction:column; gap:6px; font-size:0.85rem; color: var(--text-subtle);">
            Program
            <select id="quickAddProgram"></select>
        </label>
        <label style="display:flex; flex-direction:column; gap:6px; font-size:0.85rem; color: var(--text-subtle);">
            Lane
            <select id="quickAddLane">
                <option value="stabilize">Stabilize (0â€“7 days)</option>
                <option value="bridge">Bridge (Week 2â€“4)</option>
                <option value="sustain">Sustain (30+ days)</option>
            </select>
        </label>
        <div class="quick-add__actions">
            <button class="pill-button" type="button" id="quickAddCancel">Cancel</button>
            <button class="pill-button is-primary" type="button" id="quickAddConfirm">Add</button>
        </div>
    </section>

    <div class="preferences-overlay" id="preferencesOverlay" hidden></div>
    <section class="preferences-modal" id="preferencesModal" role="dialog" aria-modal="true" aria-labelledby="preferencesTitle" hidden tabindex="-1">
        <header>
            <h2 id="preferencesTitle">âš™ï¸ Preferences</h2>
            <button type="button" class="preferences-close-btn" id="closePreferencesButton" aria-label="Close preferences">
                Ã—
            </button>
        </header>
        <nav class="preferences-tabs" role="tablist" aria-label="Preferences categories">
            <button type="button" class="is-active" id="preferences-tab-view" data-panel="preferences-view-panel" role="tab" aria-selected="true" aria-controls="preferences-view-panel" tabindex="0">
                View &amp; Layout
            </button>
            <button type="button" id="preferences-tab-documents" data-panel="preferences-documents-panel" role="tab" aria-selected="false" aria-controls="preferences-documents-panel" tabindex="-1">
                Documents
            </button>
            <button type="button" id="preferences-tab-map" data-panel="preferences-map-panel" role="tab" aria-selected="false" aria-controls="preferences-map-panel" tabindex="-1">
                Map Settings
            </button>
            <button type="button" id="preferences-tab-accessibility" data-panel="preferences-accessibility-panel" role="tab" aria-selected="false" aria-controls="preferences-accessibility-panel" tabindex="-1">
                Accessibility
            </button>
        </nav>
        <div class="preferences-content">
            <div class="preferences-panel" id="preferences-view-panel" role="tabpanel" aria-labelledby="preferences-tab-view" tabindex="0">
                <section>
                    <h3 style="margin:0 0 8px 0;">Layout preferences</h3>
                    <div class="preferences-grid">
                        <label class="preferences-field">
                            <span class="preference-label">Default view mode</span>
                            <select id="pref-default-view">
                                <option value="grid">Grid (cards)</option>
                                <option value="rows">Rows (table)</option>
                                <option value="compare">Compare (side-by-side)</option>
                                <option value="map">Map</option>
                            </select>
                        </label>
                        <label class="preferences-field">
                            <span class="preference-label">Default sort order</span>
                            <select id="pref-sort-order">
                                <option value="availability">Availability (Soonest)</option>
                                <option value="acuity">Acuity (High â†’ Low)</option>
                                <option value="distance">Distance (Nearest)</option>
                            </select>
                        </label>
                        <label class="preferences-field">
                            <span class="preference-label">Programs per page</span>
                            <select id="pref-programs-per-page">
                                <option value="12">12 programs</option>
                                <option value="24">24 programs</option>
                                <option value="48">48 programs</option>
                                <option value="all">Show all</option>
                            </select>
                        </label>
                        <label class="preferences-checkbox">
                            <input type="checkbox" id="pref-restore-filters">
                            <span>Restore my last filter selections automatically</span>
                        </label>
                    </div>
                    <p class="preferences-note">
                        Preferences are saved per user when available; otherwise they fall back to device storage.
                    </p>
                </section>
            </div>
            <div class="preferences-panel" id="preferences-documents-panel" role="tabpanel" aria-labelledby="preferences-tab-documents" tabindex="0" hidden>
                <section>
                    <h3 style="margin:0 0 8px 0;">Document preferences</h3>
                    <div class="preferences-grid">
                        <label class="preferences-field">
                            <span class="preference-label">Default document type</span>
                            <select id="pref-document-type">
                                <option value="aftercare-options">Aftercare Options</option>
                                <option value="aftercare-plan">Aftercare Plan</option>
                            </select>
                        </label>
                        <label class="preferences-field">
                            <span class="preference-label">Auto-save interval</span>
                            <select id="pref-autosave-interval">
                                <option value="60">Every 1 minute</option>
                                <option value="180">Every 3 minutes</option>
                                <option value="300">Every 5 minutes</option>
                                <option value="never">Never (manual saves only)</option>
                            </select>
                        </label>
                        <label class="preferences-field">
                            <span class="preference-label">Write-up length preference</span>
                            <select id="pref-writeup-length">
                                <option value="concise">Concise</option>
                                <option value="standard">Standard</option>
                                <option value="detailed">Detailed</option>
                            </select>
                        </label>
                        <label class="preferences-checkbox">
                            <input type="checkbox" id="pref-include-rationale">
                            <span>Include rationale notes in generated documents</span>
                        </label>
                    </div>
                    <p class="preferences-note">
                        Document preferences influence the defaults shown in the builder and generator.
                    </p>
                </section>
            </div>
            <div class="preferences-panel" id="preferences-map-panel" role="tabpanel" aria-labelledby="preferences-tab-map" tabindex="0" hidden>
                <section>
                    <h3 style="margin:0 0 8px 0;">Map defaults</h3>
                    <div class="preferences-grid">
                        <label class="preferences-field">
                            <span class="preference-label">Default search radius</span>
                            <select id="pref-map-radius">
                                <option value="10">10 miles</option>
                                <option value="25">25 miles</option>
                                <option value="50">50 miles</option>
                                <option value="100">100 miles</option>
                                <option value="150">150 miles</option>
                                <option value="250">250 miles</option>
                            </select>
                        </label>
                        <label class="preferences-field">
                            <span class="preference-label">Default focus</span>
                            <select id="pref-map-focus">
                                <option value="all">All resources</option>
                                <option value="therapy">Therapy / Counseling</option>
                                <option value="psychiatry">Psychiatry</option>
                                <option value="iop">IOP / Day Programs</option>
                                <option value="virtual">Virtual Support</option>
                            </select>
                        </label>
                        <label class="preferences-checkbox">
                            <input type="checkbox" id="pref-map-auto-location">
                            <span>Automatically center map on my saved location</span>
                        </label>
                        <label class="preferences-checkbox">
                            <input type="checkbox" id="pref-map-show-distance">
                            <span>Show distance labels on program cards</span>
                        </label>
                    </div>
                    <p class="preferences-note">
                        Map preferences help tailor the distance calculations and default filters each time you open the map workspace.
                    </p>
                </section>
            </div>
            <div class="preferences-panel" id="preferences-accessibility-panel" role="tabpanel" aria-labelledby="preferences-tab-accessibility" tabindex="0" hidden>
                <section>
                    <h3 style="margin:0 0 8px 0;">Accessibility</h3>
                    <div class="preferences-grid">
                        <label class="preferences-field">
                            <span class="preference-label">Font size multiplier</span>
                            <select id="pref-font-scale">
                                <option value="0.8">0.8Ã—</option>
                                <option value="1">1Ã— (default)</option>
                                <option value="1.2">1.2Ã—</option>
                                <option value="1.5">1.5Ã—</option>
                            </select>
                        </label>
                        <label class="preferences-checkbox">
                            <input type="checkbox" id="pref-high-contrast">
                            <span>Enable high contrast mode</span>
                        </label>
                        <label class="preferences-checkbox">
                            <input type="checkbox" id="pref-reduce-motion">
                            <span>Reduce animations and transitions</span>
                        </label>
                        <label class="preferences-checkbox">
                            <input type="checkbox" id="pref-keyboard-hints">
                            <span>Show keyboard hints and shortcuts</span>
                        </label>
                    </div>
                    <p class="preferences-note">
                        Accessibility preferences will shape typography, contrast, and motion once applied.
                    </p>
                </section>
            </div>
        </div>
        <footer>
            <button type="button" class="preferences-reset-btn" id="resetPreferencesButton">
                Reset to defaults
            </button>
            <button type="button" class="preferences-save-btn" id="savePreferencesButton">
                Save preferences
            </button>
        </footer>
    </section>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <footer class="app-footer">
        <div>ClearHive palette â€¢ Navy #0F1020 Â· Accent #6E7BFF Â· Neutral #E9ECFF</div>
        <div id="versionFooter">UX Preview Â· Draft not saved</div>
    </footer>

    <script>
        (function () {
            // Use programs data from main app loader instead of embedded fallback
            const LEGACY_PROGRAMS_FALLBACK = [];
            /* Original fallback data commented out - now using v2 data
                {
                    id: "prg-harbor",
                    name: "Harbor Haven Intensive Outpatient",
                    focus: "Intensive Outpatient",
                    format: "Hybrid",
                    insurance: ["In-Network", "OON w/ Negotiation"],
                    flags: ["Immediate", "Family"],
                    acuity: 8,
                    availabilityDays: 2,
                    summary: "Staged handoff for clients stepping down from residential with 5-day clinical wraparound, embedded family intensives, and on-call psychiatric support.",
                    tags: ["Adolescent", "Dual-Diagnosis", "Medication Management", "Family Intensives"],
                    weeklyStructure: [
                        "5-day clinical schedule with 18 hours of group",
                        "Daily psychiatry consults during first week",
                        "Family reset weekend with on-site apartments"
                    ],
                    defaultTrack: "primary",
                    tracks: [
                        { id: "primary", label: "Primary Recommendation" },
                        { id: "strong-alt", label: "Strong Alternative" },
                        { id: "local-step-down", label: "Local / Step-Down" }
                    ],
                    location: {
                        address: "1840 Ocean Ridge Blvd",
                        city: "Delray Beach",
                        state: "FL",
                        zip: "33444",
                        lat: 26.4615,
                        lng: -80.0728,
                        region: "Southeast",
                        distanceFromFamilyMiles: 32
                    },
                    serviceRadiusMiles: 60,
                    contacts: {
                        director: "Jamie Collins, LMHC",
                        phone: "(561) 555-3201",
                        email: "jamie.collins@harborhaven.org"
                    },
                    outcomes: [
                        "78% 6-month sobriety maintenance",
                        "Reduced readmission to residential by 42%",
                        "Family cohesion scores improve +3.1 within 14 days"
                    ],
                    highlights: [
                        "Dedicated transition mentor assigned within 2 hours",
                        "Evening stabilization groups for school reintegration",
                        "Telehealth bridge sessions if travel delayed"
                    ]
                },
                {
                    id: "prg-aurora",
                    name: "Aurora Transitions Partial Hospitalization",
                    focus: "Partial Hospitalization",
                    format: "Onsite",
                    insurance: ["In-Network"],
                    flags: ["Openings"],
                    acuity: 9,
                    availabilityDays: 4,
                    summary: "Bridge-level PHP with medical coordination, academic coaching, and attachment-based family repair series tailored to post-detox stabilization.",
                    tags: ["Co-Occurring", "Psychiatry", "Academic Support", "Family Systems"],
                    weeklyStructure: [
                        "6-hour PHP days with 1:1 psychiatry weekly",
                        "Academic coaching 3x week to transition back to school",
                        "Boundaries & repair track for caregivers"
                    ],
                    defaultTrack: "primary",
                    tracks: [
                        { id: "primary", label: "Primary Recommendation" },
                        { id: "strong-alt", label: "Strong Alternative" },
                        { id: "local-step-down", label: "Local / Step-Down" }
                    ],
                    location: {
                        address: "6112 Sunrise Bay Rd",
                        city: "Miami",
                        state: "FL",
                        zip: "33101",
                        lat: 25.7617,
                        lng: -80.1918,
                        region: "Southeast",
                        distanceFromFamilyMiles: 48
                    },
                    serviceRadiusMiles: 45,
                    contacts: {
                        director: "Elena Ramirez, LCSW",
                        phone: "(305) 555-4412",
                        email: "elena.ramirez@auroratransitions.org"
                    },
                    outcomes: [
                        "Average GAD-7 reduction of 6.2 within 21 days",
                        "88% retention through full 21-day protocol",
                        "90% caregiver satisfaction with transition plan"
                    ],
                    highlights: [
                        "Dedicated medical navigator for complex medication tapers",
                        "Embedded academic liaison communicates with school teams",
                        "Real-time shared dashboard for CareConnect updates"
                    ]
                },
                {
                    id: "prg-cedar",
                    name: "Cedar Path Family System Coaching Collective",
                    focus: "Family Systems",
                    format: "Virtual",
                    insurance: ["Scholarship Track", "OON w/ Negotiation"],
                    flags: ["Family"],
                    acuity: 6,
                    availabilityDays: 1,
                    summary: "Virtual family system coaching for sustainment phase with HIPAA-secure whiteboards, capacity planning, and relapse signal rehearsals.",
                    tags: ["Family Coaching", "Virtual Delivery", "Relapse Planning"],
                    weeklyStructure: [
                        "2x week coaching with between-session micro-drills",
                        "HIPAA-safe digital family agreements & signatures",
                        "Bi-directional alerts into CareConnect tracker"
                    ],
                    location: {
                        address: "Virtual Practice",
                        city: "Remote",
                        state: "NC",
                        zip: "27511",
                        lat: 35.7596,
                        lng: -79.0193,
                        region: "National Telehealth",
                        distanceFromFamilyMiles: 0
                    },
                    defaultTrack: "at-home-support",
                    tracks: [
                        { id: "at-home-support", label: "At-Home Support" },
                        { id: "alumni", label: "Alumni Follow-Up" },
                        { id: "strong-alt", label: "Strong Alternative" }
                    ],
                    location: {
                        address: "Remote",
                        city: "Virtual Services",
                        state: "NA",
                        zip: "00000",
                        lat: 0,
                        lng: 0,
                        region: "Telehealth"
                    },
                    serviceRadiusMiles: 0,
                    contacts: {
                        director: "Morgan Blake, LMFT",
                        phone: "(845) 555-2087",
                        email: "morgan.blake@cedarpath.co"
                    },
                    outcomes: [
                        "94% families report improved conflict recovery",
                        "Average 2.6 fewer high-alert tracker pings per month",
                        "Families sustain agreements for 90 days avg."
                    ],
                    highlights: [
                        "Builder-ready collaborative documents exported to PDF",
                        "Coaches join discharge huddles within 12 hours",
                        "HIPAA-initials only with encrypted note syncs"
                    ]
                }
            ];
*/
            // Get programs from the main app's loader
            let PROGRAMS = window.programsData || window.PROGRAMS || window.programs || [];
            const PROGRAMS_STORAGE_KEY = "ccpro-transformed-programs-v1";
            const PROGRAMS_DATA_STATUS = {
                loaded: false,
                source: "fallback"
            };

            const PROGRAM_NOTES_STORAGE_KEY = "ccpro-program-notes-index";
            const PROGRAM_NOTE_KEY_PREFIX = "ccpro-program-note:";
            const AUDIENCE_STORAGE_KEY = "ccpro-programs-view-mode";
            const HOME_STORAGE_KEY = "ccpro-map-home";
            const RADIUS_PRESETS = {
                local: { radius: 25, label: "Local Â· 25 mi" },
                regional: { radius: 75, label: "Regional Â· 75 mi" },
                national: { radius: 500, label: "Nationwide" }
            };
            const RADIUS_PRESET_ORDER = ["local", "regional", "national"];
            const US_STATE_CODES = new Set([
                "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA",
                "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD",
                "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ",
                "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC",
                "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY",
                "DC", "PR"
            ]);
            const US_STATE_NAME_TO_CODE = {
                "ALABAMA": "AL",
                "ALASKA": "AK",
                "ARIZONA": "AZ",
                "ARKANSAS": "AR",
                "CALIFORNIA": "CA",
                "COLORADO": "CO",
                "CONNECTICUT": "CT",
                "DELAWARE": "DE",
                "FLORIDA": "FL",
                "GEORGIA": "GA",
                "HAWAII": "HI",
                "HAWAI'I": "HI",
                "IDAHO": "ID",
                "ILLINOIS": "IL",
                "INDIANA": "IN",
                "IOWA": "IA",
                "KANSAS": "KS",
                "KENTUCKY": "KY",
                "LOUISIANA": "LA",
                "MAINE": "ME",
                "MARYLAND": "MD",
                "MASSACHUSETTS": "MA",
                "MICHIGAN": "MI",
                "MINNESOTA": "MN",
                "MISSISSIPPI": "MS",
                "MISSOURI": "MO",
                "MONTANA": "MT",
                "NEBRASKA": "NE",
                "NEVADA": "NV",
                "NEW HAMPSHIRE": "NH",
                "NEW JERSEY": "NJ",
                "NEW MEXICO": "NM",
                "NEW YORK": "NY",
                "NORTH CAROLINA": "NC",
                "NORTH DAKOTA": "ND",
                "OHIO": "OH",
                "OKLAHOMA": "OK",
                "OREGON": "OR",
                "PENNSYLVANIA": "PA",
                "RHODE ISLAND": "RI",
                "SOUTH CAROLINA": "SC",
                "SOUTH DAKOTA": "SD",
                "TENNESSEE": "TN",
                "TEXAS": "TX",
                "UTAH": "UT",
                "VERMONT": "VT",
                "VIRGINIA": "VA",
                "WASHINGTON": "WA",
                "WEST VIRGINIA": "WV",
                "WISCONSIN": "WI",
                "WYOMING": "WY",
                "DISTRICT OF COLUMBIA": "DC",
                "WASHINGTON DC": "DC",
                "WASHINGTON, DC": "DC",
                "WASHINGTON D.C.": "DC",
                "PUERTO RICO": "PR"
            };
            const SPECIAL_STATE_LABELS = {
                VIRTUAL: "Virtual / Telehealth",
                NATIONAL: "Nationwide"
            };

            function getCandidateDataUrls() {
                const candidates = ["programs.v2.json", "./programs.v2.json", "dist/programs.v2.json"];
                try {
                    const currentPath = window.location.pathname || "";
                    if (currentPath) {
                        const segments = currentPath.split("/").filter(Boolean);
                        segments.pop();
                        const base = segments.length ? `/${segments.join("/")}/` : "/";
                        candidates.push(`${base}programs.v2.json`);
                        candidates.push(`${base}dist/programs.v2.json`);
                    }
                } catch {
                    // ignore path errors
                }
                return candidates;
            }

            function loadProgramsFromStorage() {
                try {
                    const cached = localStorage.getItem(PROGRAMS_STORAGE_KEY);
                    if (!cached) return null;
                    const parsed = JSON.parse(cached);
                    if (Array.isArray(parsed) && parsed.length) {
                        PROGRAMS_DATA_STATUS.source = "storage";
                        return parsed;
                    }
                } catch (error) {
                    console.warn("Programs storage parse failed", error);
                }
                return null;
            }

            function saveProgramsToStorage(programs) {
                try {
                    localStorage.setItem(PROGRAMS_STORAGE_KEY, JSON.stringify(programs));
                } catch (error) {
                    console.warn("Programs storage save failed", error);
                }
            }

            async function fetchProgramsFromUrl(url) {
                if (!url) return null;
                try {
                    const response = await fetch(url, { credentials: "same-origin" });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    if (Array.isArray(data) && data.length) {
                        PROGRAMS_DATA_STATUS.source = `network:${url}`;
                        return data;
                    }
                } catch (error) {
                    console.warn(`Programs fetch failed for ${url}:`, error.message || error);
                }
                return null;
            }

            async function ensureProgramsLoaded() {
                if (PROGRAMS_DATA_STATUS.loaded) {
                    return PROGRAMS;
                }

                // LEGACY LOADER DISABLED - Only use main app's data
                console.warn('[CLEANUP] Legacy programs loader disabled - using main app data only');
                
                // Check if programs are already loaded by main app
                if (window.programsData && window.programsData.length > 0) {
                    PROGRAMS = window.programsData;
                    PROGRAMS.forEach(assignProgramMetadata);
                    PROGRAMS_DATA_STATUS.loaded = true;
                    PROGRAMS_DATA_STATUS.source = "main-app";
                    console.log(`[Programs Module] Using ${PROGRAMS.length} programs from main app`);
                    return PROGRAMS;
                }

                // LEGACY LOADING CODE DISABLED - Start of disabled section
                /* 
                // Force V2 data loading
                window.featureFlags = window.featureFlags || {};
                window.featureFlags.programsV2Data = true;
                console.log('[V2 Enabled] Feature flag set to true');

                const stored = loadProgramsFromStorage();
                if (stored) {
                    PROGRAMS = stored;
                    PROGRAMS.forEach(assignProgramMetadata);
                    PROGRAMS_DATA_STATUS.loaded = true;
                    return PROGRAMS;
                }

                const candidates = getCandidateDataUrls();
                for (const url of candidates) {
                    const remote = await fetchProgramsFromUrl(url);
                    if (remote) {
                        PROGRAMS = remote;
                        PROGRAMS.forEach(assignProgramMetadata);
                        PROGRAMS_DATA_STATUS.loaded = true;
                        saveProgramsToStorage(remote);
                        return PROGRAMS;
                    }
                }
                */
                // LEGACY LOADING CODE DISABLED - End of disabled section

                // If main app data not available, wait and try again
                console.error('[CRITICAL] No programs data from main app - waiting...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (window.programsData && window.programsData.length > 0) {
                    PROGRAMS = window.programsData;
                } else {
                    console.error('[CRITICAL] Still no programs data - using empty array');
                    PROGRAMS = [];
                }
                PROGRAMS.forEach(assignProgramMetadata);
                PROGRAMS_DATA_STATUS.loaded = true;
                PROGRAMS_DATA_STATUS.source = PROGRAMS.length > 0 ? "main-app-delayed" : "empty";
                return PROGRAMS;
            }

            const STORAGE_KEY = "ccpro-program-builder-v2";
            const LEGACY_STORAGE_KEYS = ["ccpro-program-builder-v1"];
            const TRACK_LIBRARY = [
                { id: "primary", label: "Primary Recommendation" },
                { id: "strong-alt", label: "Strong Alternative" },
                { id: "local-step-down", label: "Local / Step-Down" },
                { id: "at-home-support", label: "At-Home Support" },
                { id: "alumni", label: "Alumni Follow-Up" }
            ];
            const DOCUMENT_TYPE_LABELS = {
                "aftercare-options": "Aftercare Options",
                "aftercare-plan": "Aftercare Plan"
            };
            const DISTANCE_FILTER_LABELS = {
                all: "All resources",
                therapy: "Therapy focus",
                psychiatry: "Psychiatry focus",
                iop: "IOP / Day programs",
                virtual: "Virtual support"
            };

            const USER_PREFERENCES_STORAGE_ROOT = "ccpro-user-prefs-v1";
            const ALLOWED_VIEW_MODES = ["grid", "rows", "compare", "map"];
            const ALLOWED_SORT_ORDERS = ["availability", "acuity", "distance"];
            const PROGRAMS_PER_PAGE_OPTIONS = [12, 24, 48, "all"];
            const ALLOWED_DOC_TYPES = ["aftercare-options", "aftercare-plan"];
            const AUTOSAVE_INTERVAL_OPTIONS = [60, 180, 300, "never"];
            const WRITEUP_LENGTH_OPTIONS = ["concise", "standard", "detailed"];
            const MAP_RADIUS_OPTIONS = [10, 25, 50, 100, 150, 250];
            const MAP_FOCUS_OPTIONS = ["all", "therapy", "psychiatry", "iop", "virtual"];
            const FONT_SCALE_OPTIONS = [0.8, 1, 1.2, 1.5];
            const VIRTUAL_CHUNK_SIZE = 24;

            const PREFERENCES_DEFAULTS = {
                view: "grid",
                sort: "availability",
                restoreFilters: true,
                programsPerPage: 24,
                documentType: "aftercare-options",
                autosaveInterval: 180,
                includeRationale: true,
                writeUpLength: "standard",
                mapRadius: 50,
                mapAutoLocation: false,
                mapFocus: "all",
                mapShowDistanceLabels: true,
                accessibility: {
                    fontScale: 1,
                    highContrast: false,
                    reduceMotion: false,
                    keyboardHints: false
                }
            };

            function clonePreferences(source) {
                try {
                    return typeof structuredClone === "function"
                        ? structuredClone(source)
                        : JSON.parse(JSON.stringify(source));
                } catch {
                    return JSON.parse(JSON.stringify(source));
                }
            }

            function getPreferencesStorageKey() {
                const user = window.currentUser || window.USER_CONTEXT || {};
                if (user && typeof user === "object") {
                    if (user.id) {
                        return `${USER_PREFERENCES_STORAGE_ROOT}:${user.id}`;
                    }
                    if (user.email) {
                        return `${USER_PREFERENCES_STORAGE_ROOT}:${String(user.email).toLowerCase()}`;
                    }
                }
                return `${USER_PREFERENCES_STORAGE_ROOT}:default`;
            }

            function sanitizeProgramsPerPage(value) {
                if (value === "all") return "all";
                const num = Number(value);
                return PROGRAMS_PER_PAGE_OPTIONS.includes(num) ? num : PREFERENCES_DEFAULTS.programsPerPage;
            }

            function sanitizeAutosave(value) {
                if (value === "never") return "never";
                const num = Number(value);
                return AUTOSAVE_INTERVAL_OPTIONS.includes(num) ? num : PREFERENCES_DEFAULTS.autosaveInterval;
            }

            function sanitizeFontScale(value) {
                const num = Number(value);
                return FONT_SCALE_OPTIONS.includes(num) ? num : PREFERENCES_DEFAULTS.accessibility.fontScale;
            }

            function mergePreferences(partial = {}) {
                const merged = clonePreferences(PREFERENCES_DEFAULTS);
                if (!partial || typeof partial !== "object") {
                    return merged;
                }

                if (ALLOWED_VIEW_MODES.includes(partial.view)) {
                    merged.view = partial.view;
                }
                if (ALLOWED_SORT_ORDERS.includes(partial.sort)) {
                    merged.sort = partial.sort;
                }
                if (typeof partial.restoreFilters === "boolean") {
                    merged.restoreFilters = partial.restoreFilters;
                }
                if (typeof partial.programsPerPage !== "undefined") {
                    merged.programsPerPage = sanitizeProgramsPerPage(partial.programsPerPage);
                }
                if (ALLOWED_DOC_TYPES.includes(partial.documentType)) {
                    merged.documentType = partial.documentType;
                }
                if (typeof partial.autosaveInterval !== "undefined") {
                    merged.autosaveInterval = sanitizeAutosave(partial.autosaveInterval);
                }
                if (typeof partial.includeRationale === "boolean") {
                    merged.includeRationale = partial.includeRationale;
                }
                if (WRITEUP_LENGTH_OPTIONS.includes(partial.writeUpLength)) {
                    merged.writeUpLength = partial.writeUpLength;
                }
                if (MAP_RADIUS_OPTIONS.includes(Number(partial.mapRadius))) {
                    merged.mapRadius = Number(partial.mapRadius);
                }
                if (typeof partial.mapAutoLocation === "boolean") {
                    merged.mapAutoLocation = partial.mapAutoLocation;
                }
                if (MAP_FOCUS_OPTIONS.includes(partial.mapFocus)) {
                    merged.mapFocus = partial.mapFocus;
                }
                if (typeof partial.mapShowDistanceLabels === "boolean") {
                    merged.mapShowDistanceLabels = partial.mapShowDistanceLabels;
                }
                if (partial.accessibility && typeof partial.accessibility === "object") {
                    const acc = partial.accessibility;
                    merged.accessibility.fontScale = sanitizeFontScale(acc.fontScale);
                    if (typeof acc.highContrast === "boolean") {
                        merged.accessibility.highContrast = acc.highContrast;
                    }
                    if (typeof acc.reduceMotion === "boolean") {
                        merged.accessibility.reduceMotion = acc.reduceMotion;
                    }
                    if (typeof acc.keyboardHints === "boolean") {
                        merged.accessibility.keyboardHints = acc.keyboardHints;
                    }
                }

                return merged;
            }

            function loadLegacyPreferences(base) {
                const merged = clonePreferences(base);
                try {
                    const legacyView = localStorage.getItem("ccpro-preferred-view");
                    if (legacyView && ALLOWED_VIEW_MODES.includes(legacyView)) {
                        merged.view = legacyView;
                    }
                } catch (error) {
                    console.warn("Preferences legacy load failed", error);
                }
                return merged;
            }

            function loadUserPreferences() {
                let parsed = null;
                try {
                    const raw = localStorage.getItem(getPreferencesStorageKey());
                    if (raw) {
                        parsed = JSON.parse(raw);
                    }
                } catch (error) {
                    console.warn("Preferences load failed", error);
                }

                const merged = mergePreferences(parsed || {});
                return loadLegacyPreferences(merged);
            }

            function saveUserPreferences(preferences) {
                try {
                    localStorage.setItem(getPreferencesStorageKey(), JSON.stringify(preferences));
                    localStorage.setItem("ccpro-preferred-view", preferences.view);
                } catch (error) {
                    console.warn("Preferences save failed", error);
                }
            }

            let preferencesState = loadUserPreferences();
            let preferencesDraft = null;
            let preferencesDirty = false;
            let programsState = null;

            function getActivePreferences() {
                return preferencesDraft || preferencesState;
            }

            function setPreferenceDraftValue(path, value) {
                if (!preferencesDraft) {
                    preferencesDraft = clonePreferences(preferencesState);
                }
                const keys = Array.isArray(path) ? path : [path];
                let target = preferencesDraft;
                for (let index = 0; index < keys.length - 1; index += 1) {
                    const key = keys[index];
                    if (typeof target[key] !== "object" || target[key] === null) {
                        target[key] = {};
                    }
                    target = target[key];
                }
                target[keys[keys.length - 1]] = value;
                preferencesDirty = true;
            }

            function syncPreferencesForm() {
                if (!preferencesElements.inputs) return;
                const data = getActivePreferences();
                const accessibility = data.accessibility || PREFERENCES_DEFAULTS.accessibility;

                if (preferencesElements.inputs.defaultView) {
                    preferencesElements.inputs.defaultView.value = data.view;
                }
                if (preferencesElements.inputs.sortOrder) {
                    preferencesElements.inputs.sortOrder.value = data.sort;
                }
                if (preferencesElements.inputs.restoreFilters) {
                    preferencesElements.inputs.restoreFilters.checked = Boolean(data.restoreFilters);
                }
                if (preferencesElements.inputs.programsPerPage) {
                    preferencesElements.inputs.programsPerPage.value = data.programsPerPage === "all" ? "all" : String(data.programsPerPage);
                }
                if (preferencesElements.inputs.documentType) {
                    preferencesElements.inputs.documentType.value = data.documentType;
                }
                if (preferencesElements.inputs.autosaveInterval) {
                    preferencesElements.inputs.autosaveInterval.value = data.autosaveInterval === "never" ? "never" : String(data.autosaveInterval);
                }
                if (preferencesElements.inputs.includeRationale) {
                    preferencesElements.inputs.includeRationale.checked = Boolean(data.includeRationale);
                }
                if (preferencesElements.inputs.writeUpLength) {
                    preferencesElements.inputs.writeUpLength.value = data.writeUpLength;
                }
                if (preferencesElements.inputs.mapRadius) {
                    preferencesElements.inputs.mapRadius.value = String(data.mapRadius);
                }
                if (preferencesElements.inputs.mapAutoLocation) {
                    preferencesElements.inputs.mapAutoLocation.checked = Boolean(data.mapAutoLocation);
                }
                if (preferencesElements.inputs.mapFocus) {
                    preferencesElements.inputs.mapFocus.value = data.mapFocus;
                }
                if (preferencesElements.inputs.mapShowDistance) {
                    preferencesElements.inputs.mapShowDistance.checked = Boolean(data.mapShowDistanceLabels);
                }
                if (preferencesElements.inputs.fontScale) {
                    preferencesElements.inputs.fontScale.value = String(accessibility.fontScale);
                }
                if (preferencesElements.inputs.highContrast) {
                    preferencesElements.inputs.highContrast.checked = Boolean(accessibility.highContrast);
                }
                if (preferencesElements.inputs.reduceMotion) {
                    preferencesElements.inputs.reduceMotion.checked = Boolean(accessibility.reduceMotion);
                }
                if (preferencesElements.inputs.keyboardHints) {
                    preferencesElements.inputs.keyboardHints.checked = Boolean(accessibility.keyboardHints);
                }
            }

            const srAnnouncer = document.getElementById("srAnnouncer");
            const overlays = {
                overlay: document.getElementById("detailsOverlay"),
                panel: document.getElementById("detailsPanel"),
                quickAdd: document.getElementById("quickAddSheet")
            };

            const savedDraft = loadDraft();

            const elements = {
                resultsGrid: document.getElementById("resultsGrid"),
                paginationControls: document.getElementById("paginationControls"),
                paginationStatus: document.getElementById("paginationStatus"),
                paginationPrevButton: document.getElementById("paginationPrevButton"),
                paginationNextButton: document.getElementById("paginationNextButton"),
                paginationPageSize: document.getElementById("paginationPageSize"),
                mapContainer: document.getElementById("resultsMapContainer"),
                mapCanvas: document.getElementById("resultsMapCanvas"),
                mapLegend: document.getElementById("mapLegend"),
                mapStatusLabel: document.getElementById("mapStatusLabel"),
                mapZipInput: document.getElementById("mapZipInput"),
                mapHomeSaveButton: document.getElementById("mapHomeSaveButton"),
                mapRadiusInput: document.getElementById("mapRadiusInput"),
                mapRadiusValue: document.getElementById("mapRadiusValue"),
                mapDistanceFilter: document.getElementById("mapDistanceFilter"),
                mapLocateButton: document.getElementById("mapLocateButton"),
                stateFilterContainer: document.getElementById("stateFilterChips"),
                compareContainer: document.getElementById("resultsCompareContainer"),
                compareGrid: document.getElementById("compareGrid"),
                compareStatusLabel: document.getElementById("compareStatusLabel"),
                compareAddAllButton: document.getElementById("compareAddAllButton"),
                compareExportButton: document.getElementById("compareExportButton"),
                comparePrintButton: document.getElementById("comparePrintButton"),
                resultsSummary: document.getElementById("resultsSummary"),
                filtersLabel: document.getElementById("activeFiltersLabel"),
                sortSelect: document.getElementById("sortSelect"),
                searchInput: document.getElementById("globalSearch"),
                builderLanes: document.getElementById("builderLanes"),
                builderSummary: document.getElementById("builderSummary"),
                draftStatus: document.getElementById("draftStatus"),
                versionFooter: document.getElementById("versionFooter"),
                 builderClientContext: document.getElementById("builderClientContext"),
                toast: document.getElementById("toast"),
                detailsTitle: document.getElementById("detailsTitle"),
                detailsSubtitle: document.getElementById("detailsSubtitle"),
                detailsMeta: document.getElementById("detailsMeta"),
                detailsBody: document.getElementById("detailsBody"),
                detailsAddButton: document.getElementById("detailsAddButton"),
                detailsCompareNetworkButton: document.getElementById("detailsCompareNetworkButton"),
                detailsGenerateButton: document.getElementById("detailsGenerateButton"),
                detailsNotesSection: document.getElementById("detailsNotesSection"),
                detailsNotesInput: document.getElementById("detailsNotesInput"),
                detailsNotesStatus: document.getElementById("detailsNotesStatus"),
                detailsNotesClearButton: document.getElementById("detailsNotesClearButton"),
                quickAddProgram: document.getElementById("quickAddProgram"),
                quickAddLane: document.getElementById("quickAddLane")
            };

            let filterButtons = [];
            const viewToggleButtons = Array.from(document.querySelectorAll(".view-toggle button"));
            const audienceToggleButtons = Array.from(document.querySelectorAll(".toolbar__audience-toggle-btn"));
            const documentTypeButtons = Array.from(document.querySelectorAll(".toolbar__document-toggle-btn"));
            const mapRadiusPresetButtons = Array.from(document.querySelectorAll(".map-control__preset"));
            const clearFiltersButton = document.getElementById("clearFiltersButton");
            const saveDraftButton = document.getElementById("saveDraftButton");
            const generateButton = document.getElementById("generateDocumentButton");
            const closeDetailsButton = document.getElementById("closeDetailsButton");
            const quickAddCancel = document.getElementById("quickAddCancel");
            const quickAddConfirm = document.getElementById("quickAddConfirm");
            const preferencesElements = {
                button: document.getElementById("openPreferencesButton"),
                overlay: document.getElementById("preferencesOverlay"),
                modal: document.getElementById("preferencesModal"),
                close: document.getElementById("closePreferencesButton"),
                tabs: Array.from(document.querySelectorAll(".preferences-tabs button")),
                panels: Array.from(document.querySelectorAll(".preferences-panel")),
                reset: document.getElementById("resetPreferencesButton"),
                save: document.getElementById("savePreferencesButton")
            };

            const laneConfig = {
                stabilize: {
                    label: "Stabilize (0â€“7 days)",
                    description: "Immediate continuity resources during first week after discharge."
                },
                bridge: {
                    label: "Bridge (Week 2â€“4)",
                    description: "Programming to maintain gains and prep for sustainment."
                },
                sustain: {
                    label: "Sustain (30+ days)",
                    description: "Longer-term anchors and relapse signal rehearsals."
                },
                atHome: {
                    label: "At-Home Supports",
                    description: "Local therapy, psychiatry, and alumni resources for home environment."
                }
            };

            function createEmptyBuilder() {
                return {
                    lanes: {
                        stabilize: [],
                        bridge: [],
                        sustain: [],
                        atHome: []
                    },
                 associatedClientId: null,
                 lastSaved: null
                };
            }

            const storedAudience = (() => {
                try {
                    const value = localStorage.getItem(AUDIENCE_STORAGE_KEY);
                    return value === "family" ? "family" : "clinician";
                } catch (error) {
                    return "clinician";
                }
            })();

            const persistedHome = (() => {
                try {
                    const raw = localStorage.getItem(HOME_STORAGE_KEY);
                    if (!raw) return null;
                    const parsed = JSON.parse(raw);
                    if (parsed && typeof parsed.lat === "number" && typeof parsed.lng === "number") {
                        return parsed;
                    }
                } catch (error) {
                    console.warn("Programs home ZIP restore failed", error);
                }
                return null;
            })();

            const preferredView = ALLOWED_VIEW_MODES.includes(preferencesState.view)
                ? preferencesState.view
                : PREFERENCES_DEFAULTS.view;
            const preferredSort = ALLOWED_SORT_ORDERS.includes(preferencesState.sort)
                ? preferencesState.sort
                : PREFERENCES_DEFAULTS.sort;
            const preferredProgramsPerPage = sanitizeProgramsPerPage(preferencesState.programsPerPage);
            const preferredPageSize = preferredProgramsPerPage === "all"
                ? Number.MAX_SAFE_INTEGER
                : Number(preferredProgramsPerPage);
            const preferredDocumentType = ALLOWED_DOC_TYPES.includes(preferencesState.documentType)
                ? preferencesState.documentType
                : PREFERENCES_DEFAULTS.documentType;
            const preferredAutosave = sanitizeAutosave(preferencesState.autosaveInterval);
            const preferredMapRadius = MAP_RADIUS_OPTIONS.includes(Number(preferencesState.mapRadius))
                ? Number(preferencesState.mapRadius)
                : PREFERENCES_DEFAULTS.mapRadius;
            const preferredMapFocus = MAP_FOCUS_OPTIONS.includes(preferencesState.mapFocus)
                ? preferencesState.mapFocus
                : PREFERENCES_DEFAULTS.mapFocus;

            const state = {
                filters: {
                    focus: new Set(),
                    format: new Set(),
                    insurance: new Set(),
                    flag: new Set(),
                    state: new Set()
                },
                searchTerm: "",
                sort: preferredSort,
                view: preferredView,
                viewMode: storedAudience,
                documentType: savedDraft?.documentType || preferredDocumentType,
                builder: savedDraft?.builder || createEmptyBuilder(),
                 clientContext: savedDraft?.clientContext || null,
                pagination: {
                    pageSizeOption: preferredProgramsPerPage,
                    pageSizeValue: preferredPageSize,
                    currentPage: 1,
                    totalPages: 1,
                    totalResults: 0,
                    visibleRange: { start: 0, end: 0 },
                    lastSignature: null
                },
                notes: new Map(),
                map: {
                    center: (() => {
                        const primaryProgram = PROGRAMS.find(p => p.location && typeof p.location.lat === "number" && typeof p.location.lng === "number");
                        if (primaryProgram?.location) {
                            return {
                                lat: primaryProgram.location.lat,
                                lng: primaryProgram.location.lng,
                                source: "default"
                            };
                        }
                        return { lat: 37.0902, lng: -95.7129, source: "default" }; // USA centroid fallback
                    })(),
                    defaultRadius: preferredMapRadius,
                    radiusMiles: preferredMapRadius,
                    distanceFilter: preferredMapFocus,
                    applyFiltersGlobally: false,
                    geocodeCache: {},
                    radiusPreset: "local",
                    home: persistedHome,
                    lastError: null,
                    isReady: false,
                    showDistanceLabels: Boolean(preferencesState.mapShowDistanceLabels),
                    autoLocateOnLoad: Boolean(preferencesState.mapAutoLocation)
                },
                comparison: {
                    programIds: [],
                    limit: 4
                },
                virtual: {
                    enabled: false,
                    chunkSize: VIRTUAL_CHUNK_SIZE,
                    renderedCount: 0,
                    observer: null,
                    sentinel: null,
                    data: []
                },
                autosaveInterval: preferredAutosave,
                selectedProgramId: null,
                quickAddLane: "stabilize"
            };

            state.globalListenersRegistered = false;
            state._eventBusRetryCount = 0;
            state._eventBusUnsubscribers = [];
            state.notesLoaded = false;
            programsState = state;

         if (state.clientContext?.clientId && !state.builder.associatedClientId) {
             state.builder.associatedClientId = state.clientContext.clientId;
         } else if (!state.clientContext && state.builder.associatedClientId) {
             state.clientContext = {
                 clientId: state.builder.associatedClientId,
                 initials: "",
                 kipuId: null
             };
         }

            if (savedDraft?.comparisonProgramIds?.length) {
                state.comparison.programIds = savedDraft.comparisonProgramIds
                    .slice(0, state.comparison.limit)
                    .filter(id => typeof id === "string");
            }

            if (savedDraft?.mapState) {
                if (typeof savedDraft.mapState.radiusMiles === "number") {
                    state.map.radiusMiles = savedDraft.mapState.radiusMiles;
                }
                if (typeof savedDraft.mapState.distanceFilter === "string") {
                    state.map.distanceFilter = savedDraft.mapState.distanceFilter;
                }
                if (savedDraft.mapState.center && typeof savedDraft.mapState.center.lat === "number" && typeof savedDraft.mapState.center.lng === "number") {
                    state.map.center = {
                        lat: savedDraft.mapState.center.lat,
                        lng: savedDraft.mapState.center.lng,
                        source: savedDraft.mapState.center.source || "restored"
                    };
                }
                if (typeof savedDraft.mapState.applyFiltersGlobally === "boolean") {
                    state.map.applyFiltersGlobally = savedDraft.mapState.applyFiltersGlobally;
                }
                if (typeof savedDraft.mapState.radiusPreset === "string") {
                    state.map.radiusPreset = savedDraft.mapState.radiusPreset;
                }
                if (savedDraft.mapState.home && typeof savedDraft.mapState.home.lat === "number" && typeof savedDraft.mapState.home.lng === "number") {
                    state.map.home = {
                        zip: savedDraft.mapState.home.zip || savedDraft.mapState.home.postal || null,
                        lat: savedDraft.mapState.home.lat,
                        lng: savedDraft.mapState.home.lng,
                        label: savedDraft.mapState.home.label || savedDraft.mapState.home.displayName || savedDraft.mapState.home.zip || "Home"
                    };
                }
            }

            const matchedPreset = getRadiusPresetForMiles(state.map.radiusMiles);
            if (matchedPreset && state.map.radiusPreset !== "custom") {
                state.map.radiusPreset = matchedPreset;
            }

            let autosaveTimer = null;
            let leafletLoader = null;
            let builderBroadcastTimer = null;
            const mapState = {
                instance: null,
                markersLayer: null,
                circleLayer: null,
                homeMarker: null,
                legendControl: null,
                groups: [],
                lastStats: null,
                lastError: null,
                isReady: false
            };
            const refreshMapDebounced = debounce(() => {
                if (state.view === "map") {
                    updateMap(state.filteredPrograms || PROGRAMS);
                }
            }, 260);

            function debounce(fn, delay = 250) {
                let timeout;
                return function (...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = window.setTimeout(() => fn.apply(context, args), delay);
                };
            }

            function announce(message) {
                srAnnouncer.textContent = "";
                window.requestAnimationFrame(() => {
                    srAnnouncer.textContent = message;
                });
            }

            function showToast(message) {
                elements.toast.textContent = message;
                elements.toast.classList.add("is-visible");
                announce(message);
                window.setTimeout(() => {
                    elements.toast.classList.remove("is-visible");
                }, 2800);
            }

            function applyPreferences(reason = "load") {
                const prefs = preferencesState || PREFERENCES_DEFAULTS;
                const accessibility = prefs.accessibility || PREFERENCES_DEFAULTS.accessibility;
                const root = document.documentElement;
                const body = document.body;

                if (root) {
                    root.style.fontSize = `${(accessibility.fontScale || 1) * 100}%`;
                }
                if (body) {
                    body.classList.toggle("prefs-high-contrast", Boolean(accessibility.highContrast));
                    body.classList.toggle("prefs-reduce-motion", Boolean(accessibility.reduceMotion));
                    body.classList.toggle("prefs-keyboard-hints", Boolean(accessibility.keyboardHints));
                }

                const stateRef = programsState;
                let shouldRerender = false;
                if (stateRef) {
                    if (ALLOWED_VIEW_MODES.includes(prefs.view) && stateRef.view !== prefs.view) {
                        if (prefs.view === "compare" && !stateRef.comparison.programIds.length) {
                            setView("grid");
                        } else {
                            setView(prefs.view);
                        }
                        shouldRerender = false;
                    }
                    if (ALLOWED_SORT_ORDERS.includes(prefs.sort) && stateRef.sort !== prefs.sort) {
                        stateRef.sort = prefs.sort;
                        if (elements.sortSelect) {
                            elements.sortSelect.value = prefs.sort;
                        }
                        shouldRerender = true;
                    }
                    stateRef.restoreFilters = Boolean(prefs.restoreFilters);
                    const newDocType = ALLOWED_DOC_TYPES.includes(prefs.documentType)
                        ? prefs.documentType
                        : stateRef.documentType;
                    if (stateRef.documentType !== newDocType) {
                        setDocumentType(newDocType, { silent: true });
                    }
                    stateRef.map.defaultRadius = MAP_RADIUS_OPTIONS.includes(Number(prefs.mapRadius))
                        ? Number(prefs.mapRadius)
                        : stateRef.map.defaultRadius;
                    stateRef.map.radiusMiles = stateRef.map.defaultRadius;
                    stateRef.map.distanceFilter = MAP_FOCUS_OPTIONS.includes(prefs.mapFocus)
                        ? prefs.mapFocus
                        : stateRef.map.distanceFilter;
                    stateRef.map.showDistanceLabels = Boolean(prefs.mapShowDistanceLabels);
                    stateRef.map.autoLocateOnLoad = Boolean(prefs.mapAutoLocation);
                    const presetMatch = getRadiusPresetForMiles(stateRef.map.radiusMiles);
                    if (presetMatch) {
                        stateRef.map.radiusPreset = presetMatch;
                    }

                    const programsSetting = sanitizeProgramsPerPage(prefs.programsPerPage);
                    const pageSizeValue = programsSetting === "all"
                        ? Number.MAX_SAFE_INTEGER
                        : Number(programsSetting);
                    stateRef.pagination.pageSizeOption = programsSetting;
                    stateRef.pagination.pageSizeValue = pageSizeValue;
                    stateRef.pagination.currentPage = 1;
                    stateRef.pagination.lastSignature = null;
                    if (elements.paginationPageSize) {
                        elements.paginationPageSize.value = programsSetting === "all"
                            ? "all"
                            : String(programsSetting);
                    }
                    shouldRerender = true;
                    stateRef.autosaveInterval = sanitizeAutosave(prefs.autosaveInterval);

                    if (elements.mapRadiusInput) {
                        elements.mapRadiusInput.value = String(stateRef.map.radiusMiles);
                    }
                    if (elements.mapRadiusValue) {
                        elements.mapRadiusValue.textContent = `${stateRef.map.radiusMiles} mi`;
                    }
                    if (elements.mapDistanceFilter) {
                        elements.mapDistanceFilter.value = stateRef.map.distanceFilter;
                    }
                    if (elements.mapLocateButton && stateRef.map.autoLocateOnLoad) {
                        window.requestAnimationFrame(() => handleLocateButton());
                    }
                    shouldRerender = true;
                }

                if (shouldRerender) {
                    renderPrograms();
                }

                console.debug("[Programs Preferences] applied", { reason, preferences: prefs });
            }

            function activatePreferencesTab(panelId) {
                if (!panelId || !preferencesElements.panels.length) return;
                preferencesElements.tabs.forEach(button => {
                    const isActive = button.dataset.panel === panelId;
                    button.classList.toggle("is-active", isActive);
                    button.setAttribute("aria-selected", isActive ? "true" : "false");
                    button.setAttribute("tabindex", isActive ? "0" : "-1");
                });
                preferencesElements.panels.forEach(panel => {
                    const match = panel.id === panelId;
                    panel.hidden = !match;
                    panel.setAttribute("tabindex", match ? "0" : "-1");
                    panel.setAttribute("aria-hidden", match ? "false" : "true");
                });
            }

            function openPreferencesModal() {
                if (!preferencesElements.modal) return;
                preferencesDraft = clonePreferences(preferencesState);
                preferencesDirty = false;
                syncPreferencesForm();
                const defaultPanelId = preferencesElements.tabs[0]?.dataset.panel || "";
                if (defaultPanelId) {
                    activatePreferencesTab(defaultPanelId);
                }
                preferencesElements.modal.hidden = false;
                preferencesElements.modal.removeAttribute("hidden");
                preferencesElements.overlay?.removeAttribute("hidden");
                document.body.classList.add("preferences-open");
                preferencesElements.button?.setAttribute("aria-expanded", "true");
                preferencesElements.modal.setAttribute("aria-hidden", "false");
                const activeTab = preferencesElements.tabs.find(button => button.classList.contains("is-active"));
                (activeTab || preferencesElements.modal).focus();
            }

            function closePreferencesModal() {
                if (!preferencesElements.modal) return;
                preferencesDraft = null;
                preferencesDirty = false;
                preferencesElements.modal.hidden = true;
                preferencesElements.modal.setAttribute("hidden", "");
                preferencesElements.modal.setAttribute("aria-hidden", "true");
                preferencesElements.overlay?.setAttribute("hidden", "");
                document.body.classList.remove("preferences-open");
                preferencesElements.button?.setAttribute("aria-expanded", "false");
                preferencesElements.button?.focus();
            }

            function bindPreferencesEvents() {
                if (!preferencesElements.modal || preferencesElements.modal.dataset.initialized === "true") {
                    return;
                }

                const defaultPanelId = preferencesElements.tabs[0]?.dataset.panel || "";
                if (defaultPanelId) {
                    activatePreferencesTab(defaultPanelId);
                }

                preferencesElements.button?.addEventListener("click", () => openPreferencesModal());
                preferencesElements.overlay?.addEventListener("click", () => closePreferencesModal());
                preferencesElements.close?.addEventListener("click", () => closePreferencesModal());
                preferencesElements.modal.addEventListener("keydown", event => {
                    if (event.key === "Escape") {
                        event.preventDefault();
                        closePreferencesModal();
                    }
                });
                preferencesElements.tabs.forEach(button => {
                    button.addEventListener("click", () => activatePreferencesTab(button.dataset.panel));
                });
                preferencesElements.inputs = {
                    defaultView: document.getElementById("pref-default-view"),
                    sortOrder: document.getElementById("pref-sort-order"),
                    restoreFilters: document.getElementById("pref-restore-filters"),
                    programsPerPage: document.getElementById("pref-programs-per-page"),
                    documentType: document.getElementById("pref-document-type"),
                    autosaveInterval: document.getElementById("pref-autosave-interval"),
                    includeRationale: document.getElementById("pref-include-rationale"),
                    writeUpLength: document.getElementById("pref-writeup-length"),
                    mapRadius: document.getElementById("pref-map-radius"),
                    mapAutoLocation: document.getElementById("pref-map-auto-location"),
                    mapFocus: document.getElementById("pref-map-focus"),
                    mapShowDistance: document.getElementById("pref-map-show-distance"),
                    fontScale: document.getElementById("pref-font-scale"),
                    highContrast: document.getElementById("pref-high-contrast"),
                    reduceMotion: document.getElementById("pref-reduce-motion"),
                    keyboardHints: document.getElementById("pref-keyboard-hints")
                };

                preferencesElements.inputs.defaultView?.addEventListener("change", event => {
                    const value = event.target.value;
                    if (!ALLOWED_VIEW_MODES.includes(value)) {
                        event.target.value = getActivePreferences().view;
                        return;
                    }
                    setPreferenceDraftValue("view", value);
                });
                preferencesElements.inputs.sortOrder?.addEventListener("change", event => {
                    const value = event.target.value;
                    if (!ALLOWED_SORT_ORDERS.includes(value)) {
                        event.target.value = getActivePreferences().sort;
                        return;
                    }
                    setPreferenceDraftValue("sort", value);
                });
                preferencesElements.inputs.restoreFilters?.addEventListener("change", event => {
                    setPreferenceDraftValue("restoreFilters", Boolean(event.target.checked));
                });
                preferencesElements.inputs.programsPerPage?.addEventListener("change", event => {
                    const value = event.target.value;
                    const normalized = value === "all" ? "all" : Number(value);
                    if (value !== "all" && !PROGRAMS_PER_PAGE_OPTIONS.includes(Number(normalized))) {
                        event.target.value = getActivePreferences().programsPerPage === "all"
                            ? "all"
                            : String(getActivePreferences().programsPerPage);
                        return;
                    }
                    setPreferenceDraftValue("programsPerPage", normalized);
                });
                preferencesElements.inputs.documentType?.addEventListener("change", event => {
                    const value = event.target.value;
                    if (ALLOWED_DOC_TYPES.includes(value)) {
                        setPreferenceDraftValue("documentType", value);
                    }
                });
                preferencesElements.inputs.autosaveInterval?.addEventListener("change", event => {
                    const value = event.target.value;
                    const normalized = value === "never" ? "never" : Number(value);
                    if (value !== "never" && !AUTOSAVE_INTERVAL_OPTIONS.includes(normalized)) {
                        event.target.value = getActivePreferences().autosaveInterval === "never"
                            ? "never"
                            : String(getActivePreferences().autosaveInterval);
                        return;
                    }
                    setPreferenceDraftValue("autosaveInterval", normalized);
                });
                preferencesElements.inputs.includeRationale?.addEventListener("change", event => {
                    setPreferenceDraftValue("includeRationale", Boolean(event.target.checked));
                });
                preferencesElements.inputs.writeUpLength?.addEventListener("change", event => {
                    const value = event.target.value;
                    if (WRITEUP_LENGTH_OPTIONS.includes(value)) {
                        setPreferenceDraftValue("writeUpLength", value);
                    }
                });
                preferencesElements.inputs.mapRadius?.addEventListener("change", event => {
                    const value = Number(event.target.value);
                    if (!MAP_RADIUS_OPTIONS.includes(value)) {
                        event.target.value = String(getActivePreferences().mapRadius);
                        return;
                    }
                    setPreferenceDraftValue("mapRadius", value);
                });
                preferencesElements.inputs.mapAutoLocation?.addEventListener("change", event => {
                    setPreferenceDraftValue("mapAutoLocation", Boolean(event.target.checked));
                });
                preferencesElements.inputs.mapFocus?.addEventListener("change", event => {
                    const value = event.target.value;
                    if (MAP_FOCUS_OPTIONS.includes(value)) {
                        setPreferenceDraftValue("mapFocus", value);
                    }
                });
                preferencesElements.inputs.mapShowDistance?.addEventListener("change", event => {
                    setPreferenceDraftValue("mapShowDistanceLabels", Boolean(event.target.checked));
                });
                preferencesElements.inputs.fontScale?.addEventListener("change", event => {
                    const value = sanitizeFontScale(event.target.value);
                    setPreferenceDraftValue(["accessibility", "fontScale"], value);
                    event.target.value = String(value);
                });
                preferencesElements.inputs.highContrast?.addEventListener("change", event => {
                    setPreferenceDraftValue(["accessibility", "highContrast"], Boolean(event.target.checked));
                });
                preferencesElements.inputs.reduceMotion?.addEventListener("change", event => {
                    setPreferenceDraftValue(["accessibility", "reduceMotion"], Boolean(event.target.checked));
                });
                preferencesElements.inputs.keyboardHints?.addEventListener("change", event => {
                    setPreferenceDraftValue(["accessibility", "keyboardHints"], Boolean(event.target.checked));
                });

                preferencesElements.reset?.addEventListener("click", () => {
                    preferencesDraft = clonePreferences(PREFERENCES_DEFAULTS);
                    preferencesDirty = true;
                    syncPreferencesForm();
                    showToast("Preferences reset to defaults. Save to apply.");
                });
                preferencesElements.save?.addEventListener("click", () => {
                    if (!preferencesDraft && !preferencesDirty) {
                        closePreferencesModal();
                        return;
                    }
                    preferencesState = mergePreferences(preferencesDraft || preferencesState);
                    saveUserPreferences(preferencesState);
                    applyPreferences("manual-save");
                    preferencesDraft = null;
                    preferencesDirty = false;
                    showToast("Preferences saved");
                    closePreferencesModal();
                });

                preferencesElements.modal.dataset.initialized = "true";
                syncPreferencesForm();
            }

            function refreshFilterButtons() {
                filterButtons.forEach(button => {
                    if (button._filterHandler) {
                        button.removeEventListener("click", button._filterHandler);
                    }
                });
                filterButtons = Array.from(document.querySelectorAll(".chip"));
                filterButtons.forEach(button => {
                    const handler = () => toggleFilter(button);
                    button._filterHandler = handler;
                    button.addEventListener("click", handler);
                });
            }

            function isFamilyView() {
                return state.viewMode === "family";
            }

            function persistAudienceMode(mode) {
                try {
                    localStorage.setItem(AUDIENCE_STORAGE_KEY, mode);
                } catch (error) {
                    console.warn("Unable to persist audience mode", error);
                }
            }

            function updateAudienceToggleButtons() {
                audienceToggleButtons.forEach(button => {
                    const isActive = button.dataset.audience === state.viewMode;
                    button.classList.toggle("is-active", isActive);
                    button.setAttribute("aria-pressed", isActive ? "true" : "false");
                });
                elements.detailsNotesStatus.textContent = isFamilyView()
                    ? "Notes hidden for family documents"
                    : "Autosaves to this device";
            }

            function setAudienceMode(mode, options = {}) {
                const normalized = mode === "family" ? "family" : "clinician";
                if (state.viewMode === normalized) return;
                state.viewMode = normalized;
                updateAudienceToggleButtons();
                persistAudienceMode(normalized);
                if (!options.silent) {
                    announce(`${normalized === "family" ? "Family" : "Clinician"} view activated`);
                }
                renderPrograms();
                if (state.selectedProgramId) {
                    openDetails(state.selectedProgramId);
                }
            }

            function deriveStateCode(rawValue) {
                if (!rawValue) return null;
                const upper = String(rawValue).toUpperCase().replace(/[^\w\s]/g, " ").trim();
                if (!upper) return null;
                if (US_STATE_CODES.has(upper)) {
                    return upper;
                }
                if (US_STATE_NAME_TO_CODE[upper]) {
                    return US_STATE_NAME_TO_CODE[upper];
                }
                const twoLetterMatch = upper.match(/\b[A-Z]{2}\b/);
                if (twoLetterMatch && US_STATE_CODES.has(twoLetterMatch[0])) {
                    return twoLetterMatch[0];
                }
                return null;
            }

            function formatStateLabel(code) {
                if (!code) return null;
                if (SPECIAL_STATE_LABELS[code]) {
                    return SPECIAL_STATE_LABELS[code];
                }
                return code;
            }

            function getProgramStateValues(program) {
                if (program._stateCodes) {
                    return program._stateCodes;
                }
                const codes = [];
                const location = program.location || {};
                const directCode = deriveStateCode(location.state);
                if (directCode) {
                    codes.push(directCode);
                }
                const regionCode = deriveStateCode(location.region);
                if (regionCode && !codes.includes(regionCode)) {
                    codes.push(regionCode);
                }
                if (!codes.length) {
                    const isVirtual = String(program.format || "").toLowerCase().includes("virtual") ||
                        (program.tags || []).some(tag => String(tag).toLowerCase().includes("virtual") || String(tag).toLowerCase().includes("telehealth"));
                    if (isVirtual) {
                        codes.push("VIRTUAL");
                    }
                }
                if (!codes.length && (program.flags || []).includes("national")) {
                    codes.push("NATIONAL");
                }
                if (!codes.length && location.state) {
                    const fallbackMatch = String(location.state).toUpperCase().match(/\b[A-Z]{2}\b/);
                    if (fallbackMatch) {
                        codes.push(fallbackMatch[0]);
                    }
                }
                if (!codes.length) {
                    program._stateCodes = [];
                    return program._stateCodes;
                }
                program._stateCodes = codes;
                return codes;
            }

            function assignProgramMetadata(program) {
                if (!program) return;
                // Leave insurance empty if we don't have good data yet; avoid placeholder noise like "Information pending"
                if (!Array.isArray(program.insurance)) {
                    program.insurance = [];
                }
                if (!Array.isArray(program.flags)) {
                    program.flags = [];
                }
                if (typeof program.acuity !== "number" || Number.isNaN(program.acuity)) {
                    program.acuity = 5;
                }
                if (typeof program.availabilityDays !== "number" || Number.isNaN(program.availabilityDays)) {
                    program.availabilityDays = 7;
                }
                if (!program.summary && program.overview) {
                    program.summary = String(program.overview).split(".").shift()?.trim() || "";
                }
                const codes = getProgramStateValues(program);
                program._primaryState = codes[0] || null;
            }

            function populateStateFilters() {
                if (!elements.stateFilterContainer) return;
                const counts = new Map();
                PROGRAMS.forEach(program => {
                    const codes = getProgramStateValues(program);
                    if (!codes.length) return;
                    codes.forEach(code => {
                        counts.set(code, (counts.get(code) || 0) + 1);
                    });
                });
                const entries = Array.from(counts.entries())
                    .map(([code, count]) => ({ code, label: formatStateLabel(code) || code, count }))
                    .filter(entry => entry.label)
                    .sort((a, b) => a.label.localeCompare(b.label));
                const fragment = document.createDocumentFragment();
                entries.forEach(({ code, label, count }) => {
                    const button = document.createElement("button");
                    button.className = "chip";
                    button.dataset.group = "state";
                    button.dataset.value = code;
                    button.textContent = `${label} (${count})`;
                    fragment.appendChild(button);
                });
                elements.stateFilterContainer.innerHTML = "";
                elements.stateFilterContainer.appendChild(fragment);
                elements.stateFilterContainer.dataset.empty = entries.length ? "false" : "true";
                refreshFilterButtons();
            }

            function hasHomeLocation() {
                const home = state.map.home;
                return Boolean(home && typeof home.lat === "number" && typeof home.lng === "number");
            }

            function getRadiusPresetForMiles(miles) {
                if (typeof miles !== "number" || Number.isNaN(miles)) {
                    return null;
                }
                return RADIUS_PRESET_ORDER.find(key => RADIUS_PRESETS[key].radius === Math.round(miles)) || null;
            }

            function updateRadiusPresetUi() {
                mapRadiusPresetButtons.forEach(button => {
                    const preset = button.dataset.radiusPreset;
                    const isActive = preset === state.map.radiusPreset ||
                        (!state.map.radiusPreset && preset === "local");
                    button.classList.toggle("is-active", isActive);
                });
            }

            function updateDistanceSortAvailability() {
                if (!elements.sortSelect) return;
                const option = elements.sortSelect.querySelector('option[value="distance"]');
                if (!option) return;
                const enabled = hasHomeLocation();
                option.disabled = !enabled;
                if (!enabled && state.sort === "distance") {
                    state.sort = "availability";
                    elements.sortSelect.value = state.sort;
                }
            }

            function setRadiusPreset(preset, options = {}) {
                if (!preset || !RADIUS_PRESETS[preset]) {
                    state.map.radiusPreset = "custom";
                    updateRadiusPresetUi();
                    return;
                }
                state.map.radiusPreset = preset;
                setMapRadiusMiles(RADIUS_PRESETS[preset].radius, { preset, silent: options.silent });
                if (!options.noRender) {
                    if (state.view === "map") {
                        refreshMapDebounced();
                    } else {
                        renderPrograms();
                    }
                }
                if (!options.noSave) {
                    scheduleAutosave();
                }
            }

            function updateProgramDistances() {
                if (!hasHomeLocation()) {
                    PROGRAMS.forEach(program => {
                        delete program.distanceFromHomeMiles;
                    });
                    updateDistanceSortAvailability();
                    return;
                }
                const { lat, lng } = state.map.home;
                PROGRAMS.forEach(program => {
                    const loc = program.location;
                    if (loc && typeof loc.lat === "number" && typeof loc.lng === "number") {
                        program.distanceFromHomeMiles = computeDistanceMiles(lat, lng, loc.lat, loc.lng);
                    } else {
                        program.distanceFromHomeMiles = null;
                    }
                });
                updateDistanceSortAvailability();
            }

            function formatDistanceBadge(program) {
                if (!hasHomeLocation()) return null;
                const miles = program?.distanceFromHomeMiles;
                if (typeof miles !== "number" || Number.isNaN(miles)) return null;
                if (miles < 1) {
                    return "Under 1 mi";
                }
                if (miles < 100) {
                    return `${Math.round(miles)} mi`;
                }
                return `${Math.round(miles / 10) * 10}+ mi`;
            }

            function formatDistanceForDocument(miles) {
                if (typeof miles !== "number" || Number.isNaN(miles)) return null;
                if (miles < 1) {
                    return "Under 1 mile from home";
                }
                return `${Math.round(miles)} miles from home`;
            }

            async function copyTextToClipboard(text) {
                if (!text) return false;
                if (navigator.clipboard?.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } catch (error) {
                        console.warn("Clipboard write failed", error);
                    }
                }
                const textarea = document.createElement("textarea");
                textarea.value = text;
                textarea.style.position = "fixed";
                textarea.style.opacity = "0";
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                let success = false;
                try {
                    success = document.execCommand("copy");
                } catch (error) {
                    console.warn("Clipboard fallback failed", error);
                }
                document.body.removeChild(textarea);
                return success;
            }

            function loadStoredProgramNotes() {
                if (state.notesLoaded) return;
                state.notesLoaded = true;
                let ids = [];
                try {
                    const raw = localStorage.getItem(PROGRAM_NOTES_STORAGE_KEY);
                    if (raw) {
                        const parsed = JSON.parse(raw);
                        if (Array.isArray(parsed)) {
                            ids = parsed.filter(value => typeof value === "string");
                        }
                    }
                } catch (error) {
                    console.warn("Program notes index parse failed", error);
                }
                ids.forEach(id => {
                    try {
                        const note = localStorage.getItem(`${PROGRAM_NOTE_KEY_PREFIX}${id}`);
                        if (typeof note === "string" && note.trim()) {
                            state.notes.set(id, note);
                        }
                    } catch (error) {
                        console.warn(`Program note load failed for ${id}`, error);
                    }
                });
            }

            function persistProgramNotesIndex() {
                try {
                    localStorage.setItem(PROGRAM_NOTES_STORAGE_KEY, JSON.stringify(Array.from(state.notes.keys())));
                } catch (error) {
                    console.warn("Program notes index persist failed", error);
                }
            }

            function persistProgramNote(programId, note) {
                if (!programId) return;
                const trimmed = (note || "").trim();
                if (!trimmed) {
                    state.notes.delete(programId);
                    try {
                        localStorage.removeItem(`${PROGRAM_NOTE_KEY_PREFIX}${programId}`);
                    } catch (error) {
                        console.warn("Program note remove failed", error);
                    }
                } else {
                    state.notes.set(programId, trimmed);
                    try {
                        localStorage.setItem(`${PROGRAM_NOTE_KEY_PREFIX}${programId}`, trimmed);
                    } catch (error) {
                        console.warn("Program note persist failed", error);
                    }
                }
                persistProgramNotesIndex();
                updateProgramNoteIndicators(programId);
                applyNotesToBuilder(programId, trimmed);
                scheduleAutosave();
            }

            function updateProgramNoteIndicators(programId) {
                if (!programId) return;
                renderPrograms();
            }

            function applyNotesToBuilder(programId, note) {
                if (!elements.builderLanes) return;
                const safeId = String(programId).replace(/"/g, '\\"');
                const nodes = elements.builderLanes.querySelectorAll(`.builder-clinician-note[data-program-id="${safeId}"]`);
                nodes.forEach(node => {
                    node.dataset.empty = note ? "false" : "true";
                    const body = node.querySelector("span");
                    if (body) {
                        body.textContent = note || "No clinician note saved";
                    }
                });
            }

            let noteSaveTimer = null;

            function flushDetailsNoteSave(programId, value) {
                if (!programId) return;
                if (noteSaveTimer) {
                    window.clearTimeout(noteSaveTimer);
                    noteSaveTimer = null;
                }
                persistProgramNote(programId, value);
                if (elements.detailsNotesStatus) {
                    elements.detailsNotesStatus.textContent = value.trim() ? "Saved" : "Cleared";
                }
            }

            function handleDetailsNotesInput() {
                if (!elements.detailsNotesInput) return;
                const programId = elements.detailsNotesInput.dataset.programId;
                if (!programId) return;
                const value = elements.detailsNotesInput.value || "";
                if (elements.detailsNotesStatus) {
                    elements.detailsNotesStatus.textContent = value.trim() ? "Savingâ€¦" : "Clearingâ€¦";
                }
                if (noteSaveTimer) {
                    window.clearTimeout(noteSaveTimer);
                }
                noteSaveTimer = window.setTimeout(() => {
                    flushDetailsNoteSave(programId, value);
                }, 360);
            }

            function handleDetailsNotesBlur() {
                if (!elements.detailsNotesInput) return;
                const programId = elements.detailsNotesInput.dataset.programId;
                if (!programId) return;
                const value = elements.detailsNotesInput.value || "";
                flushDetailsNoteSave(programId, value);
            }

            function handleDetailsNotesClear() {
                if (!elements.detailsNotesInput) return;
                const programId = elements.detailsNotesInput.dataset.programId;
                if (!programId) return;
                elements.detailsNotesInput.value = "";
                flushDetailsNoteSave(programId, "");
            }

            function saveHomeToStorage(home) {
                try {
                    if (home) {
                        localStorage.setItem(HOME_STORAGE_KEY, JSON.stringify(home));
                    } else {
                        localStorage.removeItem(HOME_STORAGE_KEY);
                    }
                } catch (error) {
                    console.warn("Programs home ZIP persist failed", error);
                }
            }

            function setHomeLocation(home, options = {}) {
                if (!home) {
                    state.map.home = null;
                    saveHomeToStorage(null);
                    updateProgramDistances();
                    updateHomeMarker();
                    updateDistanceSortAvailability();
                    return;
                }
                state.map.home = {
                    zip: home.zip || null,
                    lat: home.lat,
                    lng: home.lng,
                    label: home.label || home.displayName || home.zip || "Home"
                };
                saveHomeToStorage(state.map.home);
                if (elements.mapZipInput && state.map.home.zip) {
                    elements.mapZipInput.value = state.map.home.zip;
                }
                updateProgramDistances();
                updateHomeMarker();
                if (!options.skipPreset && state.map.radiusPreset === "custom") {
                    const preset = getRadiusPresetForMiles(state.map.radiusMiles);
                    if (preset) {
                        state.map.radiusPreset = preset;
                    }
                }
                scheduleAutosave();
            }

            async function handleHomeZipSubmit() {
                const zip = elements.mapZipInput?.value?.trim();
                if (!zip) {
                    showToast("Enter a ZIP code");
                    return;
                }
                elements.mapStatusLabel.textContent = `Locating ${zip}â€¦`;
                try {
                    const result = await geocodeZip(zip);
                    setHomeLocation({
                        zip,
                        lat: result.lat,
                        lng: result.lng,
                        label: result.displayName || zip
                    });
                    setMapCenter(result.lat, result.lng, "home");
                    state.map.applyFiltersGlobally = true;
                    if (!state.map.radiusPreset || state.map.radiusPreset === "custom") {
                        setRadiusPreset("local", { noRender: true, noSave: true, silent: true });
                        state.map.radiusPreset = "local";
                        updateRadiusPresetUi();
                        state.map.radiusMiles = RADIUS_PRESETS.local.radius;
                        if (elements.mapRadiusValue) {
                            elements.mapRadiusValue.textContent = `${state.map.radiusMiles} mi`;
                        }
                        if (elements.mapRadiusInput) {
                            elements.mapRadiusInput.value = String(state.map.radiusMiles);
                        }
                    }
                    updateDistanceSortAvailability();
                    renderPrograms();
                    elements.mapStatusLabel.textContent = `Home set to ${result.displayName || zip}`;
                    if (state.view === "map") {
                        refreshMapDebounced();
                    }
                } catch (error) {
                    console.error("Home ZIP geocode failed", error);
                    elements.mapStatusLabel.textContent = `Unable to locate ZIP ${zip}`;
                    showToast(error.message || "Could not locate ZIP code");
                }
            }

            function clearHomeFromStorage() {
                setHomeLocation(null);
                renderPrograms();
            }

            function updateHomeMarker() {
                if (!mapState.instance) return;
                if (mapState.homeMarker) {
                    mapState.instance.removeLayer(mapState.homeMarker);
                    mapState.homeMarker = null;
                }
                if (!hasHomeLocation()) return;
                const { lat, lng, label } = state.map.home;
                const marker = window.L.circleMarker([lat, lng], {
                    radius: 8,
                    color: "#FFB048",
                    weight: 2,
                    fillColor: "#FFC96B",
                    fillOpacity: 0.9
                });
                marker.bindTooltip(`Home â€¢ ${label || ""}`, { permanent: false });
                marker.addTo(mapState.instance);
                mapState.homeMarker = marker;
            }

         function updateClientContextDisplay() {
             const banner = elements.builderClientContext;
             if (!banner) return;
             const ctx = state.clientContext;
             if (ctx && ctx.clientId) {
                 banner.classList.remove("is-empty");
                 banner.innerHTML = `
                     <strong>Client ${escapeHtml(ctx.initials || "")}</strong>
                     <span>Drafts and documents will associate with this client automatically.</span>
                 `;
             } else {
                 banner.classList.add("is-empty");
                 banner.innerHTML = `
                     <strong>No client selected</strong>
                     <span>Open the Clients tab and choose â€œCreate Documentâ€ to link a client.</span>
                 `;
             }
         }

         function applyClientInitialsToBuilder(initials) {
             const normalized = (initials || "").toUpperCase();
             if (!normalized) return false;
             let changed = false;
             Object.values(state.builder.lanes).forEach(laneItems => {
                 laneItems.forEach(item => {
                     if (item.programId && !item.client) {
                         item.client = normalized;
                         changed = true;
                     }
                 });
             });
             return changed;
         }

         function emitProgramEvent(eventName, payload = {}) {
             try {
                 if (window.eventBus?.emit) {
                     window.eventBus.emit(eventName, payload);
                 }
             } catch (error) {
                 console.warn(`Programs docs eventBus emit failed for ${eventName}:`, error);
             }
             if (window.CareConnect?.events?.emit) {
                 try {
                     window.CareConnect.events.emit(eventName, payload);
                 } catch (error) {
                     console.warn(`CareConnect events emit failed for ${eventName}:`, error);
                 }
             }
         }

        function setClientContext(context = {}, options = {}) {
            const clientId = typeof context?.clientId === "string" && context.clientId.trim() ? context.clientId.trim() : null;
            const initials = (context?.initials || "").toUpperCase().slice(0, 12);
            const kipuId = context?.kipuId || null;
            const previous = state.clientContext;

            if (!clientId) {
                if (previous) {
                    state.clientContext = null;
                    if (state.builder) {
                        state.builder.associatedClientId = null;
                    }
                    updateClientContextDisplay();
                    if (options.save !== false) {
                        scheduleAutosave();
                    }
                    queueBuilderBroadcast("client-cleared");
                    emitProgramEvent("programs:clientContextCleared", { previousClientId: previous.clientId || null });
                    emitProgramEvent("programs-docs:client-context-cleared", { previousClientId: previous.clientId || null });
                    return { applied: true, context: null };
                }
                updateClientContextDisplay();
                return { applied: false, context: null };
            }

            const hasChanged =
                !previous ||
                previous.clientId !== clientId ||
                (initials && previous.initials !== initials) ||
                previous.kipuId !== kipuId;

            state.clientContext = {
                clientId,
                initials,
                kipuId
            };
            if (state.builder) {
                state.builder.associatedClientId = clientId;
            }

            const prefilled = applyClientInitialsToBuilder(initials);
            if (prefilled) {
                renderBuilder();
            } else {
                updateClientContextDisplay();
            }

            if (options.announce !== false) {
                announce(`Programs workspace linked to client ${initials || clientId}.`);
            }

            if (options.save !== false) {
                scheduleAutosave();
            }

            if (clientId && window.clientManager?.setCurrentClient) {
                Promise.resolve(window.clientManager.setCurrentClient(clientId)).catch(error => {
                    console.warn("Failed to sync client manager current client:", error);
                });
            }

            const payload = {
                clientId,
                initials,
                kipuId
            };
            emitProgramEvent("programs:clientContextSet", payload);
            emitProgramEvent("programs-docs:client-context-set", payload);
            queueBuilderBroadcast("client-context");

            return { applied: hasChanged || prefilled, context: state.clientContext };
        }

            function updateResultsSummary(filteredPrograms) {
                const activeFilterButtons = countActiveFilters();
                const summaryParts = [];
                if (state.view !== "map" && state.view !== "compare") {
                    if (!filteredPrograms.length) {
                        summaryParts.push("No programs ready");
                    } else if (state.pagination.pageSizeOption === "all") {
                        summaryParts.push(`${filteredPrograms.length} program${filteredPrograms.length !== 1 ? "s" : ""} ready`);
                    } else {
                        const range = state.pagination.visibleRange;
                        if (range.start && range.end) {
                            summaryParts.push(`${range.start}â€“${range.end} of ${filteredPrograms.length} programs`);
                        } else {
                            summaryParts.push(`${filteredPrograms.length} program${filteredPrograms.length !== 1 ? "s" : ""} ready`);
                        }
                    }
                } else {
                    summaryParts.push(`${filteredPrograms.length} program${filteredPrograms.length !== 1 ? "s" : ""} ready`);
                }
                if (state.searchTerm) {
                    summaryParts.push(`Matching â€œ${state.searchTerm}â€`);
                }
                if (activeFilterButtons.length) {
                    summaryParts.push(`${activeFilterButtons.length} filter${activeFilterButtons.length > 1 ? "s" : ""} active`);
                }
                const mapFiltering = state.map.applyFiltersGlobally || state.view === "map";
                const radiusMiles = Number.isFinite(state.map.radiusMiles) ? state.map.radiusMiles : state.map.defaultRadius;
                const radiusLabel = `Radius ${radiusMiles} mi`;
                if (mapFiltering) {
                    summaryParts.push(radiusLabel);
                    if (state.map.distanceFilter && state.map.distanceFilter !== "all") {
                        summaryParts.push(DISTANCE_FILTER_LABELS[state.map.distanceFilter] || state.map.distanceFilter);
                    }
                }
                if (!summaryParts.length) {
                    summaryParts.push(`${filteredPrograms.length} program${filteredPrograms.length !== 1 ? "s" : ""} ready`);
                }
                elements.resultsSummary.textContent = summaryParts.join(" Â· ");
                const filterLabels = activeFilterButtons.map(button => button.textContent.trim());
                if (mapFiltering) {
                    filterLabels.push(radiusLabel);
                    if (state.map.distanceFilter && state.map.distanceFilter !== "all") {
                        filterLabels.push(DISTANCE_FILTER_LABELS[state.map.distanceFilter] || state.map.distanceFilter);
                    }
                }
                elements.filtersLabel.textContent = filterLabels.length
                    ? `Active filters: ${filterLabels.join(", ")}`
                    : "No filters active";
            }

            function updatePaginationUi() {
                if (!elements.paginationControls) return;
                const listViewActive = state.view !== "map" && state.view !== "compare";
                elements.paginationControls.classList.toggle("is-disabled", !listViewActive);
                const totalResults = state.pagination.totalResults || 0;
                const pageSizeOption = state.pagination.pageSizeOption;
                const range = state.pagination.visibleRange || { start: 0, end: 0 };
                let statusText = "";

                if (!listViewActive) {
                    statusText = state.view === "map" ? "Map view active" : "Compare view active";
                } else if (!totalResults) {
                    statusText = "No programs to show";
                } else if (pageSizeOption === "all") {
                    statusText = `Showing all ${totalResults} program${totalResults !== 1 ? "s" : ""}`;
                } else {
                    statusText = `Showing ${range.start}â€“${range.end} of ${totalResults}`;
                }

                if (elements.paginationStatus) {
                    elements.paginationStatus.textContent = statusText;
                }

                const totalPages = state.pagination.totalPages || 1;
                const disableNav = !listViewActive || !totalResults || pageSizeOption === "all";
                if (elements.paginationPrevButton) {
                    const disablePrev = disableNav || state.pagination.currentPage <= 1;
                    elements.paginationPrevButton.disabled = disablePrev;
                }
                if (elements.paginationNextButton) {
                    const disableNext = disableNav || state.pagination.currentPage >= totalPages;
                    elements.paginationNextButton.disabled = disableNext;
                }

                if (elements.paginationPageSize) {
                    const targetValue = pageSizeOption === "all"
                        ? "all"
                        : String(pageSizeOption);
                    if (elements.paginationPageSize.value !== targetValue) {
                        elements.paginationPageSize.value = targetValue;
                    }
                    elements.paginationPageSize.disabled = !listViewActive;
                }
            }

            function countActiveFilters() {
                return filterButtons.filter(btn => btn.classList.contains("is-active"));
            }

            function serializeFilterSet(set) {
                if (!set || typeof set.forEach !== "function") return "";
                return Array.from(set).sort().join("|");
            }

            function buildPaginationSignature() {
                const center = state.map?.center || {};
                const mapDescriptor = (state.map.applyFiltersGlobally || state.view === "map")
                    ? `${state.map.distanceFilter}|${state.map.radiusMiles}|${Number(center.lat || 0).toFixed(2)}|${Number(center.lng || 0).toFixed(2)}`
                    : "map-off";
                return [
                    state.searchTerm || "",
                    serializeFilterSet(state.filters.focus),
                    serializeFilterSet(state.filters.format),
                    serializeFilterSet(state.filters.insurance),
                    serializeFilterSet(state.filters.flag),
                    serializeFilterSet(state.filters.state),
                    state.viewMode,
                    mapDescriptor
                ].join("||");
            }

            function getDocumentTypeLabel(value) {
                return DOCUMENT_TYPE_LABELS[value] || DOCUMENT_TYPE_LABELS["aftercare-options"];
            }

            function updateDocumentTypeButtons() {
                documentTypeButtons.forEach(button => {
                    const isActive = button.dataset.docType === state.documentType;
                    button.classList.toggle("is-active", isActive);
                    button.setAttribute("aria-pressed", isActive ? "true" : "false");
                });
            }

            function updateDraftMeta() {
                const label = getDocumentTypeLabel(state.documentType);
                if (state.builder.lastSaved) {
                    const timestamp = new Date(state.builder.lastSaved).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
                    elements.draftStatus.textContent = `Draft saved ${timestamp}`;
                    elements.versionFooter.textContent = `Programs workspace â€¢ ${label} â€¢ Last saved ${timestamp}`;
                } else {
                    elements.draftStatus.textContent = "Draft not saved";
                    elements.versionFooter.textContent = `Programs workspace â€¢ ${label} â€¢ Draft not saved`;
                }
            }

            function refreshGenerationLabels() {
                const label = getDocumentTypeLabel(state.documentType);
                generateButton.textContent = `Generate ${label}`;
                elements.detailsGenerateButton.textContent = `Generate ${label}`;
            }

            function setDocumentType(type, options = {}) {
                const normalized = type === "aftercare-plan" ? "aftercare-plan" : "aftercare-options";
                const previous = state.documentType;
                state.documentType = normalized;
                updateDocumentTypeButtons();
                refreshGenerationLabels();
                updateDraftMeta();
                if (options.announce !== false && previous !== normalized) {
                    announce(`Document type set to ${getDocumentTypeLabel(normalized)}`);
                }
                if (options.scheduleSave !== false && previous !== normalized) {
                    scheduleAutosave();
                }
                if (previous !== normalized) {
                    queueBuilderBroadcast("document-type");
                }
            }

            function sanitizeTextForExport(text = "") {
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

         function escapeHtml(text = "") {
             return text
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#39;");
         }

            function escapeAttribute(value = "") {
                return value
                    .replace(/&/g, "&amp;")
                    .replace(/"/g, "&quot;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            function formatTextForExport(text = "") {
                const sanitized = sanitizeTextForExport(text);
                return sanitized.replace(/\r\n|\r|\n/g, "<br>");
            }

            function sanitizeRichText(html = "") {
                if (!html) return "";
                let normalized = html
                    .replace(/<\/?b>/gi, tag => tag.startsWith("</") ? "</strong>" : "<strong>")
                    .replace(/<\/?i>/gi, tag => tag.startsWith("</") ? "</em>" : "<em>");
                const container = document.createElement("div");
                container.innerHTML = normalized;
                const allowed = new Set(["STRONG", "EM", "UL", "OL", "LI", "BR"]);
                const walker = document.createTreeWalker(container, NodeFilter.SHOW_ELEMENT, null);
                const toClean = [];
                while (walker.nextNode()) {
                    const node = walker.currentNode;
                    if (!allowed.has(node.tagName)) {
                        toClean.push(node);
                    }
                }
                toClean.forEach(node => {
                    const parent = node.parentNode;
                    if (!parent) return;
                    if (node.childNodes.length) {
                        const fragment = document.createDocumentFragment();
                        while (node.firstChild) {
                            fragment.appendChild(node.firstChild);
                        }
                        parent.replaceChild(fragment, node);
                    } else {
                        parent.removeChild(node);
                    }
                });
                normalized = container.innerHTML.replace(/&nbsp;/g, " ");
                return normalized;
            }

            function getPlainTextFromHtml(html = "") {
                if (!html) return "";
                const temp = document.createElement("div");
                temp.innerHTML = html;
                return temp.textContent?.trim() || "";
            }

            function formatDocTimestamp(value) {
                if (!value) return null;
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return null;
                return date.toLocaleString(undefined, {
                    dateStyle: "medium",
                    timeStyle: "short"
                });
            }

            function collectBuilderSnapshot(focusProgramId = null) {
                const lanes = {};
                Object.entries(state.builder.lanes).forEach(([laneKey, items]) => {
                    lanes[laneKey] = items.map(item => {
                        if (!item.programId || laneKey === "atHome") {
                            return {
                                type: "manual",
                                resourceName: item.name || "",
                                city: item.city || "",
                                focus: item.focus || "",
                                notesHtml: item.notesHtml || "",
                                notesText: item.notesText || "",
                                addedAt: item.addedAt || null,
                                lastEdited: item.lastEdited || null
                            };
                        }
                        const program = getProgramById(item.programId);
                        return {
                            type: "program",
                            programId: item.programId,
                            programName: program?.name || "",
                            focus: program?.focus || "",
                            format: program?.format || "",
                            availabilityDays: program?.availabilityDays ?? null,
                            acuity: program?.acuity ?? null,
                            clientInitials: item.client || "",
                            reason: item.reason || "",
                            reasonFormatted: formatTextForExport(item.reason || ""),
                            track: item.track || getDefaultTrackId(item.programId),
                            trackLabel: getTrackLabel(item.track || getDefaultTrackId(item.programId), item.programId),
                            addedAt: item.addedAt || null,
                            programNote: state.notes.get(item.programId) || "",
                            distanceFromHome: program?.distanceFromHomeMiles ?? null
                        };
                    });
                });
                return {
                    documentType: state.documentType,
                    generatedAt: new Date().toISOString(),
                    focusProgramId,
                    lanes,
                    audience: state.viewMode,
                    clientContext: state.clientContext ? {
                        clientId: state.clientContext.clientId,
                        initials: state.clientContext.initials,
                        kipuId: state.clientContext.kipuId || null
                    } : null
                };
            }

            function getBuilderSummary() {
                const laneCounts = Object.fromEntries(Object.keys(state.builder.lanes).map(key => [key, state.builder.lanes[key]?.length || 0]));
                const total = Object.values(laneCounts).reduce((sum, value) => sum + value, 0);
                const manualResources = state.builder.lanes.atHome?.filter(item => !item.programId).length || 0;
                return {
                    laneCounts,
                    total,
                    manualResources,
                    documentType: state.documentType,
                    clientId: state.clientContext?.clientId || null,
                    clientInitials: state.clientContext?.initials || "",
                    timestamp: Date.now()
                };
            }

            function queueBuilderBroadcast(reason = "update") {
                clearTimeout(builderBroadcastTimer);
                builderBroadcastTimer = window.setTimeout(() => {
                    const summary = getBuilderSummary();
                    const snapshot = collectBuilderSnapshot();
                    emitProgramEvent("programs:builderUpdated", {
                        reason,
                        summary,
                        snapshot
                    });
                    builderBroadcastTimer = null;
                }, 160);
            }

            function formatFamilyReason(text = "") {
                const lines = String(text)
                    .split(/\r?\n+/)
                    .map(line => line.trim())
                    .filter(Boolean)
                    .slice(0, 4);
                if (!lines.length) return "";
                return `<ul>${lines.map(line => `<li>${escapeHtml(line)}</li>`).join("")}</ul>`;
            }

            function renderDocumentHtml(snapshot) {
                const label = getDocumentTypeLabel(snapshot.documentType);
                const generatedAt = new Date(snapshot.generatedAt).toLocaleString();
                const laneOrder = ["stabilize", "bridge", "sustain", "atHome"];
                const laneNames = {
                    stabilize: "Stabilize (0â€“7 days)",
                    bridge: "Bridge (Week 2â€“4)",
                    sustain: "Sustain (30+ days)",
                    atHome: "At-Home Supports"
                };
                const isFamilyAudience = snapshot.audience === "family";
                const familyCss = isFamilyAudience ? `
                            body { font-size: 0.92rem; }
                            .doc-card { font-size: 0.85rem; }
                            .doc-card h3 { font-size: 0.95rem; }
                        ` : "";

                const docIntro = (() => {
                    if (snapshot.documentType === "aftercare-plan") {
                        return "This individualized Aftercare Plan highlights the primary placement and supporting services staged across the next 30 days.";
                    }
                    if (snapshot.documentType === "aftercare-options") {
                        return "Use this curated Aftercare Options grid to compare recommended programs and capture family feedback.";
                    }
                    return "";
                })();
                const introHtml = docIntro ? `<p class="doc-intro">${sanitizeTextForExport(docIntro)}</p>` : "";
                const clientHtml = snapshot.clientContext?.initials
                    ? `<div class="doc-client">Client: ${sanitizeTextForExport(snapshot.clientContext.initials)}</div>`
                    : "";

                const sections = laneOrder.map(laneKey => {
                    const entries = snapshot.lanes[laneKey] || [];
                    if (!entries.length) return "";
                    const laneEntries = isFamilyAudience ? entries.slice(0, 4) : entries;
                    const entryHtml = laneEntries.map(entry => {
                        if (entry.type === "manual") {
                            const badges = [];
                            if (entry.city) {
                                badges.push(sanitizeTextForExport(entry.city));
                            }
                            if (entry.focus) {
                                badges.push(sanitizeTextForExport(entry.focus));
                            }
                            const logged = formatDocTimestamp(entry.addedAt);
                            if (logged) {
                                badges.push(`Logged ${sanitizeTextForExport(logged)}`);
                            }
                            if (entry.lastEdited && entry.lastEdited !== entry.addedAt) {
                                const updated = formatDocTimestamp(entry.lastEdited);
                                if (updated) {
                                    badges.push(`Updated ${sanitizeTextForExport(updated)}`);
                                }
                            }
                            const manualNotes = isFamilyAudience ? "" : entry.notesHtml;
                            const metaHtml = badges.length
                                ? `<div class="doc-meta">${badges.map(label => `<span>${label}</span>`).join("")}</div>`
                                : "";
                            return `
                                <article class="doc-card">
                                    <h3>${sanitizeTextForExport(entry.resourceName || "Resource")}</h3>
                                    ${metaHtml}
                                    ${manualNotes ? `<div class="doc-notes">${manualNotes}</div>` : ""}
                                </article>
                            `;
                        }
                        const badges = [];
                        if (entry.focus) {
                            badges.push(sanitizeTextForExport(entry.focus));
                        }
                        if (entry.format) {
                            badges.push(sanitizeTextForExport(entry.format));
                        }
                        const distanceLabel = formatDistanceForDocument(entry.distanceFromHome);
                        if (distanceLabel) {
                            badges.push(sanitizeTextForExport(distanceLabel));
                        }
                        if (!isFamilyAudience && entry.trackLabel) {
                            badges.push(`Track Â· ${sanitizeTextForExport(entry.trackLabel)}`);
                        }
                        if (!isFamilyAudience && entry.clientInitials) {
                            badges.push(`Client Â· ${sanitizeTextForExport(entry.clientInitials)}`);
                        }
                        const logged = formatDocTimestamp(entry.addedAt);
                        if (!isFamilyAudience && logged) {
                            badges.push(`Logged ${sanitizeTextForExport(logged)}`);
                        }
                        const metaHtml = badges.length
                            ? `<div class="doc-meta">${badges.map(label => `<span>${label}</span>`).join("")}</div>`
                            : "";
                        const focusBadge = snapshot.focusProgramId && entry.programId === snapshot.focusProgramId
                            ? `<span class="doc-badge doc-badge--primary">${snapshot.documentType === "aftercare-plan" ? "Primary Program" : "Highlighted"}</span>`
                            : "";
                        const reasonHtml = entry.reason
                            ? (isFamilyAudience ? formatFamilyReason(entry.reason) : entry.reasonFormatted)
                            : "";
                        const noteHtml = (!isFamilyAudience && entry.programNote)
                            ? `<div class="doc-notes doc-notes--clinician">${formatTextForExport(entry.programNote)}</div>`
                            : "";
                        return `
                            <article class="doc-card${focusBadge ? " doc-card--focus" : ""}">
                                <h3>${sanitizeTextForExport(entry.programName || "Program")}${focusBadge}</h3>
                                ${metaHtml}
                                ${
                                    reasonHtml
                                        ? `<div class="doc-notes">${reasonHtml}</div>`
                                        : ""
                                }
                                ${noteHtml}
                            </article>
                        `;
                    }).join("");
                    return `
                        <section>
                            <h2>${laneNames[laneKey]}</h2>
                            <div class="doc-grid">${entryHtml}</div>
                        </section>
                    `;
                }).join("");

                return `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>${sanitizeTextForExport(label)} â€¢ ${generatedAt}</title>
                        <style>
                            body { font-family: "Segoe UI", Arial, sans-serif; margin: 32px; background: #f7f8ff; color: #151633; }
                            ${familyCss}
                            header { margin-bottom: 24px; }
                            h1 { margin: 0; font-size: 1.6rem; }
                            .doc-meta { margin-top: 6px; color: #48508A; font-size: 0.9rem; }
                            .doc-client { margin-top: 6px; color: #48508A; font-size: 0.88rem; font-weight: 500; }
                            .doc-intro { margin-top: 12px; font-size: 0.95rem; color: #3a3f7a; line-height: 1.5; }
                            section { margin-bottom: 24px; }
                            section h2 { margin-bottom: 12px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.08em; color: #48508A; }
                            .doc-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
                            .doc-card { background: #fff; border: 1px solid #c9ceff; border-radius: 16px; padding: 16px; box-shadow: 0 12px 24px rgba(15,16,32,0.08); }
                            .doc-card h3 { margin: 0 0 6px; font-size: 1.05rem; }
                            .doc-card .doc-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.8rem; color: #6970a0; }
                            .doc-card .doc-notes { margin-top: 10px; font-size: 0.9rem; color: #43497d; line-height: 1.5; }
                            .doc-notes--clinician { background: #eef0ff; border-radius: 12px; padding: 10px 12px; }
                        </style>
                    </head>
                    <body>
                        <header>
                            <h1>${sanitizeTextForExport(label)}</h1>
                            <div class="doc-meta">Generated ${generatedAt}</div>
                            ${clientHtml}
                            ${introHtml}
                        </header>
                        ${sections}
                    </body>
                    </html>
                `;
            }

            function generateAtHomeId() {
                if (window.crypto?.randomUUID) {
                    return window.crypto.randomUUID();
                }
                return `athome-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            }

            function normalizeProgramEntry(entry = {}) {
                return {
                    programId: entry.programId || "",
                 client: entry.client ? String(entry.client).toUpperCase() : "",
                    reason: entry.reason || "",
                    track: entry.track || getDefaultTrackId(entry.programId),
                    addedAt: entry.addedAt || entry.timestamp || new Date().toISOString()
                };
            }

            function normalizeAtHomeEntry(entry = {}) {
                const notesHtml = sanitizeRichText(entry.notesHtml || entry.notes || "");
                return {
                    id: entry.id || generateAtHomeId(),
                    name: entry.name || "",
                    city: entry.city || "",
                    focus: entry.focus || "",
                    notesHtml,
                    notesText: getPlainTextFromHtml(notesHtml),
                    addedAt: entry.addedAt || new Date().toISOString(),
                    lastEdited: entry.lastEdited || entry.addedAt || null
                };
            }

            function getProgramTrackOptions(programId) {
                if (!programId) return TRACK_LIBRARY;
                const program = getProgramById(programId);
                if (program?.tracks?.length) {
                    return program.tracks;
                }
                return TRACK_LIBRARY;
            }

            function getDefaultTrackId(programId) {
                const program = getProgramById(programId);
                if (program?.defaultTrack) {
                    return program.defaultTrack;
                }
                const options = getProgramTrackOptions(programId);
                return options[0]?.id || TRACK_LIBRARY[0].id;
            }

            function getTrackLabel(trackId, programId = null) {
                if (!trackId) return "Unassigned";
                const scopedOptions = programId ? getProgramTrackOptions(programId) : TRACK_LIBRARY;
                const match = scopedOptions.find(option => option.id === trackId) || TRACK_LIBRARY.find(option => option.id === trackId);
                return match?.label || "Unassigned";
            }

            function loadLeafletAssets() {
                if (window.L && typeof window.L.map === "function") {
                    return Promise.resolve();
                }
                if (leafletLoader) {
                    return leafletLoader;
                }
                leafletLoader = new Promise((resolve, reject) => {
                    const existingScript = document.querySelector('script[data-leaflet]');
                    if (existingScript) {
                        existingScript.addEventListener("load", resolve);
                        existingScript.addEventListener("error", reject);
                        return;
                    }
                    const link = document.createElement("link");
                    link.rel = "stylesheet";
                    link.href = "libs/leaflet.css";
                    link.dataset.leaflet = "true";
                    document.head.appendChild(link);

                    const script = document.createElement("script");
                    script.src = "libs/leaflet.js";
                    script.async = true;
                    script.dataset.leaflet = "true";
                    script.onload = resolve;
                    script.onerror = () => reject(new Error("Failed to load Leaflet assets"));
                    document.head.appendChild(script);
                });
                return leafletLoader;
            }

            function ensureMapLegend() {
                if (mapState.legendControl) return;
                mapState.legendControl = window.L.control({ position: "bottomright" });
                mapState.legendControl.onAdd = () => {
                    const div = window.L.DomUtil.create("div", "map-legend-control");
                    div.innerHTML = `
                        <div class="map-legend">
                            <span class="map-legend__item">
                                <span class="map-marker-dot"></span>
                                Program location
                            </span>
                            <span class="map-legend__item">
                                <span class="map-marker-dot" style="background:#6FD8A6;"></span>
                                Within radius
                            </span>
                            <span class="map-legend__item">
                                Cluster size indicates number of nearby programs
                            </span>
                        </div>
                    `;
                    return div;
                };
                mapState.legendControl.addTo(mapState.instance);
            }

            function updateMapLegendPrograms(groups, stats = {}) {
                if (!elements.mapLegend) return;
                const formatCounts = {
                    onsite: 0,
                    hybrid: 0,
                    virtual: 0,
                    telehealth: 0
                };
                let total = 0;
                groups.forEach(group => {
                    group.programs.forEach(entry => {
                        total += 1;
                        const format = (entry.program.format || "").toLowerCase();
                        if (format.includes("virtual")) {
                            formatCounts.virtual += 1;
                        } else if (format.includes("hybrid")) {
                            formatCounts.hybrid += 1;
                        } else if (format.includes("telehealth")) {
                            formatCounts.telehealth += 1;
                        } else {
                            formatCounts.onsite += 1;
                        }
                    });
                });
                const missing = stats.missingLocation || 0;
                const filterExcluded = stats.filterExcluded || 0;
                const distanceExcluded = stats.distanceExcluded || 0;
                elements.mapLegend.innerHTML = `
                    <span class="map-legend__item">
                        <span class="legend-swatch legend-swatch--onsite"></span>
                        Onsite
                        <span class="map-legend__count">${formatCounts.onsite}</span>
                    </span>
                    <span class="map-legend__item">
                        <span class="legend-swatch legend-swatch--hybrid"></span>
                        Hybrid
                        <span class="map-legend__count">${formatCounts.hybrid}</span>
                    </span>
                    <span class="map-legend__item">
                        <span class="legend-swatch legend-swatch--virtual"></span>
                        Virtual
                        <span class="map-legend__count">${formatCounts.virtual}</span>
                    </span>
                    <span class="map-legend__item">
                        <span class="legend-swatch legend-swatch--telehealth"></span>
                        Telehealth
                        <span class="map-legend__count">${formatCounts.telehealth}</span>
                    </span>
                    <span class="map-legend__item">
                        Showing ${total} program${total === 1 ? "" : "s"}
                    </span>
                    ${missing ? `<span class="map-legend__item">Missing location data: ${missing}</span>` : ""}
                    ${filterExcluded ? `<span class="map-legend__item">Filtered out: ${filterExcluded}</span>` : ""}
                    ${distanceExcluded ? `<span class="map-legend__item">Outside radius: ${distanceExcluded}</span>` : ""}
                `;
            }

            function computeDistanceMiles(lat1, lon1, lat2, lon2) {
                const toRad = Math.PI / 180;
                const dLat = (lat2 - lat1) * toRad;
                const dLon = (lon2 - lon1) * toRad;
                const a = Math.sin(dLat / 2) ** 2 +
                    Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) * Math.sin(dLon / 2) ** 2;
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return 3958.8 * c; // Earth radius in miles
            }

            function matchesDistanceFilter(program) {
                const filter = state.map.distanceFilter;
                if (!filter || filter === "all") return true;
                const tags = (program.tags || []).map(tag => tag.toLowerCase());
                const focus = (program.focus || "").toLowerCase();
                const format = (program.format || "").toLowerCase();
                switch (filter) {
                    case "therapy":
                        return focus.includes("therapy") ||
                            tags.some(tag => tag.includes("therapy") || tag.includes("family") || tag.includes("counsel"));
                    case "psychiatry":
                        return focus.includes("psychi") ||
                            tags.some(tag => tag.includes("psychi") || tag.includes("medication"));
                    case "iop":
                        return focus.includes("intensive") || focus.includes("partial") ||
                            tags.some(tag => tag.includes("iop") || tag.includes("day program"));
                    case "virtual":
                        return format.includes("virtual") ||
                            tags.some(tag => tag.includes("virtual") || tag.includes("telehealth"));
                    default:
                        return true;
                }
            }

            function buildMapGroups(programs) {
                const groups = new Map();
                const center = state.map.center;
                const radius = state.map.radiusMiles;
                let missingLocation = 0;
                let filterExcluded = 0;
                let distanceExcluded = 0;
                programs.forEach(program => {
                    const loc = program.location;
                    if (!loc || typeof loc.lat !== "number" || typeof loc.lng !== "number") {
                        missingLocation += 1;
                        return;
                    }
                    if (!matchesDistanceFilter(program)) {
                        filterExcluded += 1;
                        return;
                    }
                    let distanceMiles = null;
                    if (typeof center.lat === "number" && typeof center.lng === "number") {
                        distanceMiles = computeDistanceMiles(center.lat, center.lng, loc.lat, loc.lng);
                        if (radius && distanceMiles > radius) {
                            distanceExcluded += 1;
                            return;
                        }
                    }
                    const key = `${loc.lat.toFixed(2)}|${loc.lng.toFixed(2)}`;
                    if (!groups.has(key)) {
                        groups.set(key, { lat: loc.lat, lng: loc.lng, programs: [] });
                    }
                    groups.get(key).programs.push({ program, distanceMiles });
                });
                return {
                    groups: Array.from(groups.values()),
                    stats: {
                        missingLocation,
                        filterExcluded,
                        distanceExcluded
                    }
                };
            }

            function createMarker(group) {
                const count = group.programs.length;
                if (count === 0) return null;
                const [lat, lng] = [group.lat, group.lng];
                if (count === 1) {
                    const entry = group.programs[0];
                    const program = entry.program;
                    const marker = window.L.marker([lat, lng]);
                    marker.bindPopup(`
                        <div style="min-width:200px;">
                            <strong>${program.name}</strong><br>
                            <span style="color:var(--text-subtle); font-size:0.8rem;">${program.focus} Â· ${program.format}</span><br>
                            ${program.location?.city ? `<span style="font-size:0.78rem; color:var(--text-subtle);">${program.location.city}, ${program.location.state}</span><br>` : ""}
                            ${typeof entry.distanceMiles === "number" ? `<span style="font-size:0.75rem; color:var(--text-subtle);">${entry.distanceMiles.toFixed(1)} mi away</span><br>` : ""}
                            <button class="leaflet-popup-button" data-program-id="${program.id}">View details</button>
                        </div>
                    `);
                    marker.on("popupopen", () => {
                        const btn = document.querySelector(".leaflet-popup-button");
                        if (btn) {
                            btn.addEventListener("click", () => openDetails(program.id), { once: true });
                        }
                    });
                    return marker;
                }

            const icon = window.L.divIcon({
                    html: `<div class="map-cluster-icon">${count}</div>`,
                    className: "",
                    iconSize: [42, 42]
                });
                const marker = window.L.marker([lat, lng], { icon });
                marker.bindPopup(`
                    <div style="min-width:220px;">
                        <strong>${count} programs nearby</strong>
                        <ul style="margin:8px 0 0 16px; padding:0; font-size:0.8rem; color:var(--text-subtle);">
                            ${group.programs.slice(0, 4).map(entry => `<li>${entry.program.name}</li>`).join("")}
                        </ul>
                        ${count > 4 ? `<div style="font-size:0.75rem; margin-top:4px; color:var(--text-subtle);">+${count - 4} more</div>` : ""}
                    </div>
                `);
                return marker;
            }

            async function ensureMapReady() {
                if (mapState.isReady && mapState.instance) {
                    return mapState.instance;
                }
                await loadLeafletAssets();
                const { lat, lng } = state.map.center;
                mapState.instance = window.L.map(elements.mapCanvas, {
                    center: [lat, lng],
                    zoom: 7,
                    scrollWheelZoom: true,
                    doubleClickZoom: false
                });
                window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(mapState.instance);
                mapState.markersLayer = window.L.layerGroup().addTo(mapState.instance);
                mapState.circleLayer = window.L.circle([lat, lng], {
                    radius: state.map.radiusMiles * 1609.34,
                    color: "#6E7BFF",
                fillColor: "#6E7BFF",
                    fillOpacity: 0.12,
                    weight: 1.5
                }).addTo(mapState.instance);
                updateHomeMarker();
                ensureMapLegend();
                mapState.isReady = true;
                elements.mapStatusLabel.textContent = "Map view ready. Drag to explore programs.";
                mapState.instance.on("moveend", () => {
                    const center = mapState.instance.getCenter();
                    state.map.center = { lat: center.lat, lng: center.lng, source: "pan" };
                    if (mapState.circleLayer) {
                        mapState.circleLayer.setLatLng(center);
                    }
                });
                mapState.instance.on("dblclick", event => {
                    setMapCenter(event.latlng.lat, event.latlng.lng, "dblclick");
                    state.map.applyFiltersGlobally = true;
                    elements.mapStatusLabel.textContent = `Center moved to ${event.latlng.lat.toFixed(3)}, ${event.latlng.lng.toFixed(3)}`;
                    renderPrograms();
                });
                return mapState.instance;
            }

            function updateMapCircle() {
                if (!mapState.circleLayer || !mapState.instance) return;
                const center = state.map.center;
                mapState.circleLayer.setLatLng([center.lat, center.lng]);
                mapState.circleLayer.setRadius(state.map.radiusMiles * 1609.34);
            }

            async function updateMap(programs) {
                await ensureMapReady();
                mapState.markersLayer.clearLayers();
                const { groups, stats } = buildMapGroups(programs);
                mapState.lastStats = stats;
                groups.forEach(group => {
                    const marker = createMarker(group);
                    if (marker) {
                        mapState.markersLayer.addLayer(marker);
                    }
                });
                if (!groups.length) {
                    elements.mapStatusLabel.textContent = "No mappable programs with the current filters. Try expanding the radius or removing a filter.";
                    updateMapLegendPrograms([], stats);
                    mapState.groups = [];
                    return;
                }
                updateMapCircle();
                updateHomeMarker();
                updateMapLegendPrograms(groups, stats);
                mapState.groups = groups;
                if (groups.length === 1) {
                    const group = groups[0];
                    mapState.instance.flyTo([group.lat, group.lng], Math.max(mapState.instance.getZoom(), 9), { duration: 0.6 });
                } else if (groups.length > 1) {
                    const bounds = window.L.latLngBounds(groups.map(group => [group.lat, group.lng]));
                    mapState.instance.flyToBounds(bounds.pad(0.12), { duration: 0.6 });
                }
            }

            function setMapCenter(lat, lng, source = "manual") {
                if (typeof lat !== "number" || typeof lng !== "number") return;
                state.map.center = { lat, lng, source };
                if (state.view === "map" && mapState.instance) {
                    mapState.instance.panTo([lat, lng], { animate: true });
                    updateMapCircle();
                }
            }

            function setMapRadiusMiles(miles, options = {}) {
                if (typeof miles !== "number" || Number.isNaN(miles)) return;
                const clamped = Math.min(RADIUS_PRESETS.national.radius, Math.max(5, Math.round(miles)));
                state.map.radiusMiles = clamped;
                if (elements.mapRadiusInput) {
                    elements.mapRadiusInput.value = String(clamped);
                }
                if (elements.mapRadiusValue) {
                    elements.mapRadiusValue.textContent = `${clamped} mi`;
                }
                if (options.preset) {
                    state.map.radiusPreset = options.preset;
                } else if (options.source === "slider") {
                    state.map.radiusPreset = "custom";
                }
                updateRadiusPresetUi();
                if (!options.silent) {
                    state.map.applyFiltersGlobally = true;
                }
                updateMapCircle();
            }

            async function geocodeZip(zip) {
                const trimmed = (zip || "").trim();
                if (!/^\d{5}$/.test(trimmed)) {
                    throw new Error("ZIP must be 5 digits");
                }
                if (state.map.geocodeCache[trimmed]) {
                    return state.map.geocodeCache[trimmed];
                }
                const url = `https://nominatim.openstreetmap.org/search?countrycodes=us&format=json&postalcode=${trimmed}&limit=1`;
                const response = await fetch(url, {
                    headers: {
                        "Accept": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error("Geocoding request failed");
                }
                const data = await response.json();
                if (!Array.isArray(data) || !data.length) {
                    throw new Error("ZIP not found");
                }
                const result = {
                    lat: Number(data[0].lat),
                    lng: Number(data[0].lon),
                    displayName: data[0].display_name || trimmed
                };
                state.map.geocodeCache[trimmed] = result;
                return result;
            }

            async function centerMapByZip(zip) {
                const cleaned = (zip || "").trim();
                if (!cleaned) {
                    showToast("Enter a ZIP code to center the map");
                    return;
                }
                elements.mapStatusLabel.textContent = `Searching for ${cleaned}â€¦`;
                try {
                    const result = await geocodeZip(cleaned);
                    setMapCenter(result.lat, result.lng, "zip");
                    state.map.applyFiltersGlobally = true;
                    elements.mapStatusLabel.textContent = `Centered near ${result.displayName}`;
                    renderPrograms();
                } catch (error) {
                    console.error("Geocoding error:", error);
                    elements.mapStatusLabel.textContent = `Unable to locate ZIP ${cleaned}`;
                    showToast(error.message || "Could not locate ZIP code");
                }
            }

            function handleLocateButton() {
                if (!navigator.geolocation) {
                    showToast("Current location not supported on this device");
                    return;
                }
                elements.mapStatusLabel.textContent = "Locatingâ€¦";
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude } = position.coords;
                        setMapCenter(latitude, longitude, "geolocation");
                        state.map.applyFiltersGlobally = true;
                        elements.mapStatusLabel.textContent = "Centered on your location";
                        renderPrograms();
                    },
                    error => {
                        console.error("Geolocation error:", error);
                        elements.mapStatusLabel.textContent = "Unable to get current location";
                        showToast("Unable to access current location");
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
                );
            }

            function isProgramCompared(programId) {
                return state.comparison.programIds.includes(programId);
            }

            function updateComparisonStatus() {
                const count = state.comparison.programIds.length;
                if (elements.compareStatusLabel) {
                    elements.compareStatusLabel.textContent = count
                        ? `${count} program${count === 1 ? "" : "s"} selected.`
                        : "Select up to four programs to compare.";
                }
                if (state.view === "compare") {
                    elements.resultsSummary.textContent = count
                        ? `${count} program${count === 1 ? "" : "s"} in comparison`
                        : "No programs selected for comparison";
                }
            }

            function addProgramToComparison(programId) {
                if (isProgramCompared(programId)) return;
                if (state.comparison.programIds.length >= state.comparison.limit) {
                    showToast(`Comparison limited to ${state.comparison.limit} programs.`);
                    return;
                }
                state.comparison.programIds.push(programId);
                updateComparisonStatus();
                if (state.view === "compare") {
                    renderComparisonView();
                } else {
                    renderPrograms();
                }
            }

            function removeProgramFromComparison(programId) {
                const before = state.comparison.programIds.length;
                state.comparison.programIds = state.comparison.programIds.filter(id => id !== programId);
                if (state.comparison.programIds.length !== before) {
                    updateComparisonStatus();
                    if (state.view === "compare") {
                        renderComparisonView();
                    } else {
                        renderPrograms();
                    }
                }
            }

            function toggleProgramComparison(programId) {
                if (isProgramCompared(programId)) {
                    removeProgramFromComparison(programId);
                } else {
                    addProgramToComparison(programId);
                }
            }

            function handleDetailsCompareNetwork() {
                const button = elements.detailsCompareNetworkButton;
                if (!button) return;
                const baseProgramId = button.dataset.programId;
                let relatedIds = [];
                try {
                    relatedIds = JSON.parse(button.dataset.relatedPrograms || "[]");
                } catch {
                    relatedIds = [];
                }
                const includeSelf = button.dataset.includeSelf === "1";
                const idSet = new Set();
                relatedIds.forEach(id => {
                    if (id) idSet.add(id);
                });
                if (includeSelf && baseProgramId) {
                    idSet.add(baseProgramId);
                }
                if (!idSet.size) {
                    showToast("No additional network programs available.");
                    return;
                }
                let addedAny = false;
                idSet.forEach(programId => {
                    if (!isProgramCompared(programId)) {
                        addProgramToComparison(programId);
                        addedAny = true;
                    }
                });
                if (!addedAny) {
                    showToast("All network programs are already in comparison.");
                }
                setView("compare");
            }

            function hasVariance(values = []) {
                const normalized = values.map(value => {
                    if (Array.isArray(value)) {
                        return JSON.stringify(value);
                    }
                    if (value && typeof value === "object") {
                        return JSON.stringify(value);
                    }
                    const str = value == null ? "" : String(value).trim();
                    return str.toLowerCase();
                });
                return new Set(normalized).size > 1;
            }

            function findProgramLane(programId) {
                for (const [laneKey, items] of Object.entries(state.builder.lanes)) {
                    if (items.some(item => item.programId === programId)) {
                        return laneKey;
                    }
                }
                return null;
            }

            function renderComparisonView() {
                if (!elements.compareGrid) return;
                const selectedPrograms = state.comparison.programIds
                    .map(id => getProgramById(id))
                    .filter(Boolean);

                if (!selectedPrograms.length) {
                    elements.compareGrid.className = "compare-grid compare-grid--columns-1";
                    elements.compareGrid.innerHTML = `
                        <div class="compare-empty">
                            Select programs from the grid or rows view to start a side-by-side comparison.
                        </div>
                    `;
                    updateComparisonStatus();
                    return;
                }

                const columns = Math.min(selectedPrograms.length, 4);
                elements.compareGrid.className = `compare-grid compare-grid--columns-${columns}`;
                const focusDiff = hasVariance(selectedPrograms.map(program => program.focus));
                const formatDiff = hasVariance(selectedPrograms.map(program => program.format));
                const locationDiff = hasVariance(selectedPrograms.map(program => program.location ? `${program.location.city}, ${program.location.state}` : "Location not provided"));
                const acuityDiff = hasVariance(selectedPrograms.map(program => program.acuity)); // kept for potential analytics, not surfaced in UI
                const summaryDiff = hasVariance(selectedPrograms.map(program => program.summary));
                const weeklyDiff = hasVariance(selectedPrograms.map(program => program.weeklyStructure || []));
                const outcomesDiff = hasVariance(selectedPrograms.map(program => program.outcomes || []));
                const highlightsDiff = hasVariance(selectedPrograms.map(program => program.highlights || []));
                const contactsDiff = hasVariance(selectedPrograms.map(program => program.contacts || {}));

                elements.compareGrid.innerHTML = selectedPrograms.map(program => {
                    const location = program.location
                        ? `${program.location.city}, ${program.location.state}`
                        : "Location not provided";
                    const summaryClass = summaryDiff ? "compare-section compare-section--diff" : "compare-section";
                    const weeklyClass = weeklyDiff ? "compare-section compare-section--diff" : "compare-section";
                    const outcomesClass = outcomesDiff ? "compare-section compare-section--diff" : "compare-section";
                    const highlightsClass = highlightsDiff ? "compare-section compare-section--diff" : "compare-section";
                    const contactsClass = contactsDiff ? "compare-section compare-section--diff" : "compare-section";
                    const laneKey = findProgramLane(program.id);
                    const laneLabel = laneKey ? laneConfig[laneKey]?.label || laneKey : null;
                    const laneBadge = laneKey
                        ? `<span class="compare-meta__item compare-meta__item--lane">In builder Â· ${laneLabel}</span>`
                        : `<span class="compare-meta__item compare-meta__item--lane is-empty">Not yet staged</span>`;
                    return `
                        <article class="compare-card" data-program-id="${program.id}">
                            <button type="button" class="compare-remove" aria-label="Remove ${program.name} from comparison">Ã—</button>
                            <header>
                                <h3>${program.name}</h3>
                                <div class="compare-header-tags">
                                    <span class="compare-tag${focusDiff ? " is-different" : ""}">${program.focus}</span>
                                    <span class="compare-tag${formatDiff ? " is-different" : ""}">${program.format}</span>
                                </div>
                            </header>
                            <div class="compare-meta">
                                <span class="compare-meta__item${locationDiff ? " is-different" : ""}">Location Â· ${location}</span>
                                ${laneBadge}
                            </div>
                            <div class="${summaryClass}">
                                <h4>Overview</h4>
                                <div style="font-size:0.85rem; color:var(--text-subtle);">${program.summary}</div>
                            </div>
                            <div class="${weeklyClass}">
                                <h4>Weekly Structure</h4>
                                <div class="compare-list">
                                    ${program.weeklyStructure.map(item => `<div>â€¢ ${item}</div>`).join("")}
                                </div>
                            </div>
                            <div class="${outcomesClass}">
                                <h4>Outcomes</h4>
                                <div class="compare-list">
                                    ${program.outcomes.map(item => `<div>â€¢ ${item}</div>`).join("")}
                                </div>
                            </div>
                            <div class="${highlightsClass}">
                                <h4>Highlights</h4>
                                <div class="compare-list">
                                    ${program.highlights.map(item => `<div>â€¢ ${item}</div>`).join("")}
                                </div>
                            </div>
                            <div class="${contactsClass}">
                                <h4>Contact</h4>
                                <div style="font-size:0.82rem; color:var(--text-subtle);">
                                    ${program.contacts?.director ? `${program.contacts.director}<br>` : ""}
                                    ${program.contacts?.phone ? `${program.contacts.phone}<br>` : ""}
                                    ${program.contacts?.email ? `${program.contacts.email}` : ""}
                                </div>
                            </div>
                        </article>
                    `;
                }).join("");
                updateComparisonStatus();
            }

            function exportComparisonSnapshot(mode = "preview") {
                const selectedPrograms = state.comparison.programIds
                    .map(id => getProgramById(id))
                    .filter(Boolean);
                if (!selectedPrograms.length) {
                    showToast("Add programs to comparison before exporting.");
                    return;
                }
                const focusDiff = hasVariance(selectedPrograms.map(program => program.focus));
                const formatDiff = hasVariance(selectedPrograms.map(program => program.format));
                const locationDiff = hasVariance(selectedPrograms.map(program => program.location ? `${program.location.city}, ${program.location.state}` : "Location not provided"));
                const acuityDiff = hasVariance(selectedPrograms.map(program => program.acuity));
                const availabilityValues = selectedPrograms.map(program => program.availabilityDays <= 0
                    ? "Immediate start"
                    : `Start in ${program.availabilityDays} day${program.availabilityDays === 1 ? "" : "s"}`);
                const availabilityDiff = hasVariance(availabilityValues);
                const summaryDiff = hasVariance(selectedPrograms.map(program => program.summary));
                const weeklyDiff = hasVariance(selectedPrograms.map(program => program.weeklyStructure || []));
                const outcomesDiff = hasVariance(selectedPrograms.map(program => program.outcomes || []));
                const highlightsDiff = hasVariance(selectedPrograms.map(program => program.highlights || []));
                const contactsDiff = hasVariance(selectedPrograms.map(program => program.contacts || {}));
                const title = `CareConnect Comparison â€“ ${selectedPrograms.length} Program${selectedPrograms.length === 1 ? "" : "s"}`;
                const html = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>${title}</title>
                        <style>
                            body { font-family: "Segoe UI", Arial, sans-serif; margin: 24px; color: #1f2145; }
                            h1 { margin-bottom: 6px; }
                            .meta { color: #48508A; margin-bottom: 18px; font-size: 0.9rem; }
                            .grid { display: grid; gap: 16px; }
                            .grid.columns-1 { grid-template-columns: minmax(260px, 340px); }
                            .grid.columns-2 { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
                            .grid.columns-3 { grid-template-columns: repeat(3, minmax(240px, 1fr)); }
                            .grid.columns-4 { grid-template-columns: repeat(4, minmax(220px, 1fr)); }
                            .card { border: 1px solid #c9ceff; border-radius: 16px; padding: 16px; background: #fff; box-shadow: 0 8px 24px rgba(15,16,32,0.12); }
                            .card h2 { margin: 0 0 4px; font-size: 1.1rem; }
                            .sub { color: #48508A; font-size: 0.85rem; }
                            .section { margin-top: 14px; }
                            .section h3 { margin: 0 0 6px; font-size: 0.8rem; text-transform: uppercase; color: #6970a0; letter-spacing: 0.08em; }
                            ul { margin: 0; padding-left: 18px; color: #48508A; }
                            .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 999px; font-size: 0.74rem; font-weight: 600; margin-right: 6px; margin-top: 4px; background: rgba(110,123,255,0.16); color: #1f2145; }
                            .badge.diff { background: rgba(255,196,0,0.28); color: #5b4200; box-shadow: 0 6px 18px rgba(255,196,0,0.22); }
                            .chip { display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 999px; font-size: 0.72rem; background: rgba(110,123,255,0.18); color: #1f2145; margin-right: 6px; margin-top: 4px; }
                            .chip.diff { background: rgba(16,185,129,0.22); color: #125946; box-shadow: 0 6px 18px rgba(16,185,129,0.18); }
                            .section.diff { border-left: 3px solid #6E7BFF; background: #eef1ff; padding: 8px 12px; border-radius: 12px; }
                        </style>
                    </head>
                    <body>
                        <h1>${title}</h1>
                        <div class="meta">Generated ${new Date().toLocaleString()}</div>
                        <div class="grid columns-${Math.min(selectedPrograms.length, 4)}">
                            ${selectedPrograms.map(program => `
                                <article class="card">
                                    <h2>${program.name}</h2>
                                    <div>
                                        <span class="badge${focusDiff ? " diff" : ""}">${program.focus}</span>
                                        <span class="badge${formatDiff ? " diff" : ""}">${program.format}</span>
                                    </div>
                                    <div>
                                        <span class="chip${locationDiff ? " diff" : ""}">${program.location ? `${program.location.city}, ${program.location.state}` : "Location not provided"}</span>
                                        <span class="chip${acuityDiff ? " diff" : ""}">Acuity ${program.acuity}/10</span>
                                        <span class="chip${availabilityDiff ? " diff" : ""}">${program.availabilityDays <= 0 ? "Immediate start" : `Start in ${program.availabilityDays} day${program.availabilityDays === 1 ? "" : "s"}`}</span>
                                    </div>
                                    <div class="section${summaryDiff ? " diff" : ""}">
                                        <h3>Overview</h3>
                                        <p>${program.summary}</p>
                                    </div>
                                    <div class="section${weeklyDiff ? " diff" : ""}">
                                        <h3>Weekly Structure</h3>
                                        <ul>${program.weeklyStructure.map(item => `<li>${item}</li>`).join("")}</ul>
                                    </div>
                                    <div class="section${outcomesDiff ? " diff" : ""}">
                                        <h3>Outcomes</h3>
                                        <ul>${program.outcomes.map(item => `<li>${item}</li>`).join("")}</ul>
                                    </div>
                                    <div class="section${highlightsDiff ? " diff" : ""}">
                                        <h3>Highlights</h3>
                                        <ul>${program.highlights.map(item => `<li>${item}</li>`).join("")}</ul>
                                    </div>
                                    <div class="section${contactsDiff ? " diff" : ""}">
                                        <h3>Contact</h3>
                                        <p>
                                            ${program.contacts?.director ? `${program.contacts.director}<br>` : ""}
                                            ${program.contacts?.phone ? `${program.contacts.phone}<br>` : ""}
                                            ${program.contacts?.email ? `${program.contacts.email}` : ""}
                                        </p>
                                    </div>
                                </article>
                            `).join("")}
                        </div>
                    </body>
                    </html>
                `;
                const win = window.open("", "_blank", "noopener,width=1080,height=720");
                if (!win) {
                    showToast("Enable pop-ups to export comparison.");
                    return;
                }
                win.document.write(html);
                win.document.close();
                if (mode === "print") {
                    win.focus();
                    setTimeout(() => win.print(), 400);
                }
            }

            function addComparisonProgramsToBuilder() {
                const selected = state.comparison.programIds.slice();
                if (!selected.length) {
                    showToast("Add programs to comparison before sending to the builder.");
                    return;
                }
                const targetLane = "bridge";
                let added = 0;
                selected.forEach(programId => {
                    const laneItems = state.builder.lanes[targetLane] || [];
                    const exists = laneItems.some(item => item.programId === programId);
                    if (!exists) {
                        addToBuilder(programId, targetLane, { silent: true });
                        added += 1;
                    }
                });
                if (added > 0) {
                    showToast(`Added ${added} program${added === 1 ? "" : "s"} to ${laneConfig[targetLane].label}`);
                } else {
                    showToast("All compared programs are already staged in the builder.");
                }
                if (state.view === "compare") {
                    renderComparisonView();
                }
            }

            function handleCompareGridClick(event) {
                const button = event.target;
                if (!(button instanceof HTMLButtonElement)) return;
                if (!button.classList.contains("compare-remove")) return;
                const card = button.closest(".compare-card");
                if (!card) return;
                const programId = card.dataset.programId;
                if (programId) {
                    removeProgramFromComparison(programId);
                }
            }

            function createProgramCard(program) {
                const card = document.createElement("article");
                card.className = "program-card";
                card.setAttribute("role", "listitem");
                card.dataset.programId = program.id;
                const isCompared = isProgramCompared(program.id);
                const comparisonLimitReached = !isCompared && state.comparison.programIds.length >= state.comparison.limit;
                if (isCompared) {
                    card.classList.add("is-compared");
                }
                const familyView = isFamilyView();
                const distanceBadge = formatDistanceBadge(program);
                const hasNotes = !familyView && state.notes.has(program.id);
                const metaBadges = [
                    `<span class="badge badge--neutral">${escapeHtml(program.focus)}</span>`,
                    `<span class="badge badge--neutral">${escapeHtml(program.format)}</span>`
                ];
                if (!familyView) {
                    const insuranceBadges = (program.insurance || [])
                        .filter(entry => entry && entry !== "Information pending")
                        .slice(0, 2)
                        .map(entry => `<span class="badge">${escapeHtml(entry)}</span>`);
                    metaBadges.push(...insuranceBadges);
                }
                if (distanceBadge) {
                    metaBadges.push(`<span class="badge badge--distance">${escapeHtml(distanceBadge)}</span>`);
                }
                if (hasNotes) {
                    metaBadges.push(`<span class="badge badge--note">Clinician note</span>`);
                }
                card.innerHTML = `
                    <div class="program-card__header">
                        <div class="program-card__title">
                            <h3>${escapeHtml(program.name)}</h3>
                            <div class="program-card__meta">
                                ${metaBadges.join("")}
                            </div>
                        </div>
                    </div>
                    <p class="program-card__summary">${escapeHtml(program.summary || "")}</p>
                    <div class="program-card__tags">
                        ${(program.tags || []).map(tag => `<span class="program-card__tag">${escapeHtml(tag)}</span>`).join("")}
                    </div>
                    <div class="program-card__actions">
                        <button class="pill-button compare-toggle ${isCompared ? "is-active" : ""}" data-action="compare" type="button" aria-pressed="${isCompared ? "true" : "false"}" ${comparisonLimitReached ? "disabled" : ""}>
                            ${isCompared ? "In Compare" : "Compare"}
                        </button>
                        <select aria-label="Select builder lane" data-program-lane>
                            <option value="stabilize">Stabilize (0â€“7 days)</option>
                            <option value="bridge">Bridge (Week 2â€“4)</option>
                            <option value="sustain">Sustain (30+ days)</option>
                        </select>
                        <button class="pill-button is-primary" data-action="add" type="button">
                            Add to Builder
                        </button>
                        <button class="pill-button" data-action="details" type="button">
                            View Details
                        </button>
                    </div>
                `;
                return card;
            }

            function resetVirtualization() {
                if (state.virtual.observer) {
                    state.virtual.observer.disconnect();
                    state.virtual.observer = null;
                }
                if (state.virtual.sentinel) {
                    state.virtual.sentinel.remove();
                    state.virtual.sentinel = null;
                }
                state.virtual.enabled = false;
                state.virtual.data = [];
                state.virtual.renderedCount = 0;
            }

            function appendVirtualChunk(start, end) {
                const fragment = document.createDocumentFragment();
                for (let i = start; i < end && i < state.virtual.data.length; i++) {
                    fragment.appendChild(createProgramCard(state.virtual.data[i]));
                }
                elements.resultsGrid.appendChild(fragment);
                state.virtual.renderedCount = Math.min(end, state.virtual.data.length);
            }

            function setupVirtualization(programs) {
                resetVirtualization();
                state.virtual.enabled = true;
                state.virtual.data = programs;
                const initialEnd = Math.min(state.virtual.chunkSize, programs.length);
                appendVirtualChunk(0, initialEnd);
                const sentinel = document.createElement("div");
                sentinel.className = "virtual-sentinel";
                sentinel.setAttribute("aria-hidden", "true");
                elements.resultsGrid.appendChild(sentinel);
                state.virtual.sentinel = sentinel;
                state.virtual.observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const nextEnd = state.virtual.renderedCount + state.virtual.chunkSize;
                            appendVirtualChunk(state.virtual.renderedCount, nextEnd);
                            if (state.virtual.renderedCount >= state.virtual.data.length) {
                                resetVirtualization();
                            }
                        }
                    });
                }, { root: null, threshold: 0.1 });
                state.virtual.observer.observe(sentinel);
            }

            async function renderPrograms() {
                const filtered = applyFilters(PROGRAMS);
                const sorted = sortPrograms(filtered.slice());
                state.filteredPrograms = sorted;
                state.pagination.totalResults = sorted.length;

                if (state.view !== "map" && state.view !== "compare") {
                    const signature = buildPaginationSignature();
                    if (signature !== state.pagination.lastSignature) {
                        state.pagination.lastSignature = signature;
                        state.pagination.currentPage = 1;
                    }
                }

                if (state.view === "compare") {
                    resetVirtualization();
                    renderComparisonView();
                    updateComparisonStatus();
                    updatePaginationUi();
                    updateResultsSummary(sorted);
                    return;
                }

                if (state.view === "map") {
                    resetVirtualization();
                    elements.resultsGrid.innerHTML = "";
                    if (!sorted.length) {
                        elements.mapStatusLabel.textContent = "No programs match these filters yet. Adjust filters or radius to widen results.";
                        if (mapState.markersLayer) {
                            mapState.markersLayer.clearLayers();
                        }
                        state.pagination.visibleRange = { start: 0, end: 0 };
                        updatePaginationUi();
                        updateResultsSummary(sorted);
                        return;
                    }
                    elements.mapStatusLabel.textContent = "Map view ready. Drag, zoom, or double-click to explore.";
                    try {
                        await updateMap(sorted);
                        mapState.lastError = null;
                        state.pagination.visibleRange = { start: 1, end: sorted.length };
                        updatePaginationUi();
                        updateResultsSummary(sorted);
                    } catch (error) {
                        mapState.lastError = error;
                        console.error("Map rendering error:", error);
                        elements.mapStatusLabel.textContent = "Map unavailable. Switching back to list view.";
                        showToast("Map temporarily unavailable. Showing list view instead.");
                        state.map.applyFiltersGlobally = false;
                        setView("grid");
                    }
                    return;
                }

                elements.resultsGrid.innerHTML = "";

                if (!sorted.length) {
                    resetVirtualization();
                    const emptyState = document.createElement("div");
                    emptyState.setAttribute("role", "status");
                    emptyState.style.background = "rgba(233,236,255,0.6)";
                    emptyState.style.borderRadius = "18px";
                    emptyState.style.padding = "32px";
                    emptyState.style.textAlign = "center";
                    emptyState.style.color = "var(--text-subtle)";
                    emptyState.innerHTML = `
                        <strong>No programs match these filters yet.</strong>
                        <div style="margin-top:8px;">Try removing a filter or widening the focus area.</div>
                    `;
                    elements.resultsGrid.appendChild(emptyState);
                    state.pagination.totalPages = 1;
                    state.pagination.visibleRange = { start: 0, end: 0 };
                    updatePaginationUi();
                    updateResultsSummary(sorted);
                    return;
                }

                const usesPagination = state.pagination.pageSizeOption !== "all";

                if (usesPagination) {
                    resetVirtualization();
                    const pageSize = Math.max(1, state.pagination.pageSizeValue || PREFERENCES_DEFAULTS.programsPerPage);
                    const totalPages = Math.max(1, Math.ceil(sorted.length / pageSize));
                    state.pagination.totalPages = totalPages;
                    if (state.pagination.currentPage > totalPages) {
                        state.pagination.currentPage = totalPages;
                    }
                    if (state.pagination.currentPage < 1) {
                        state.pagination.currentPage = 1;
                    }
                    const startIndex = (state.pagination.currentPage - 1) * pageSize;
                    const endIndex = Math.min(sorted.length, startIndex + pageSize);
                    let pageItems = sorted.slice(startIndex, endIndex);
                    if (!pageItems.length && sorted.length) {
                        state.pagination.currentPage = 1;
                        state.pagination.visibleRange = {
                            start: 1,
                            end: Math.min(pageSize, sorted.length)
                        };
                        pageItems = sorted.slice(0, pageSize);
                    } else {
                        state.pagination.visibleRange = {
                            start: startIndex + 1,
                            end: endIndex
                        };
                    }
                    const fragment = document.createDocumentFragment();
                    pageItems.forEach(program => fragment.appendChild(createProgramCard(program)));
                    elements.resultsGrid.appendChild(fragment);
                    updatePaginationUi();
                    updateResultsSummary(sorted);
                    return;
                }

                state.pagination.totalPages = 1;
                state.pagination.visibleRange = { start: 1, end: sorted.length };
                const shouldVirtualize = sorted.length > state.virtual.chunkSize * 2;
                if (shouldVirtualize) {
                    setupVirtualization(sorted);
                } else {
                    resetVirtualization();
                    const fragment = document.createDocumentFragment();
                    sorted.forEach(program => fragment.appendChild(createProgramCard(program)));
                    elements.resultsGrid.appendChild(fragment);
                }
                updatePaginationUi();
                updateResultsSummary(sorted);
            }

            function applyFilters(programs) {
                return programs.filter(program => {
                    if (state.filters.focus.size && !state.filters.focus.has(program.focus)) {
                        return false;
                    }
                    if (state.filters.format.size && !state.filters.format.has(program.format)) {
                        return false;
                    }
                    if (state.filters.insurance.size) {
                        const matchesInsurance = program.insurance.some(ins => state.filters.insurance.has(ins));
                        if (!matchesInsurance) return false;
                    }
                    if (state.filters.flag.size) {
                        const matchesFlag = program.flags?.some(flag => state.filters.flag.has(flag));
                        if (!matchesFlag) return false;
                    }
                    if (state.filters.state.size) {
                        const stateMatches = getProgramStateValues(program);
                        const hasMatch = stateMatches.some(value => state.filters.state.has(value));
                        if (!hasMatch) return false;
                    }
                    if (state.searchTerm) {
                        const term = state.searchTerm.toLowerCase();
                        const haystack = [
                            program.name,
                            program.summary,
                            ...(program.tags || []),
                            program.focus,
                            program.format
                        ].join(" ").toLowerCase();
                        if (!haystack.includes(term)) return false;
                    }
                    const applyMapFilters = state.map.applyFiltersGlobally || state.view === "map";
                    if (applyMapFilters) {
                        if (!matchesDistanceFilter(program)) {
                            return false;
                        }
                        const loc = program.location;
                        if (!loc || typeof loc.lat !== "number" || typeof loc.lng !== "number") {
                            return false;
                        }
                        const center = state.map.center;
                        if (typeof center.lat === "number" && typeof center.lng === "number") {
                            const distance = computeDistanceMiles(center.lat, center.lng, loc.lat, loc.lng);
                            if (distance > state.map.radiusMiles) {
                                return false;
                            }
                        }
                    }
                    return true;
                });
            }

            function sortPrograms(programs) {
                const sortKey = state.sort;
                return programs.sort((a, b) => {
                    if (sortKey === "distance") {
                        if (!hasHomeLocation()) {
                            return a.name.localeCompare(b.name);
                        }
                        const distA = typeof a.distanceFromHomeMiles === "number" ? a.distanceFromHomeMiles : Number.POSITIVE_INFINITY;
                        const distB = typeof b.distanceFromHomeMiles === "number" ? b.distanceFromHomeMiles : Number.POSITIVE_INFINITY;
                        if (distA === distB) {
                            return a.name.localeCompare(b.name);
                        }
                        return distA - distB;
                    }
                    if (sortKey === "acuity") {
                        return b.acuity - a.acuity;
                    }
                    if (sortKey === "availability") {
                        return a.availabilityDays - b.availabilityDays;
                    }
                    return a.name.localeCompare(b.name);
                });
            }

            function renderBuilder() {
                elements.builderLanes.innerHTML = "";
                Object.entries(laneConfig).forEach(([laneKey, laneInfo]) => {
                    const lane = document.createElement("section");
                    lane.className = "lane";
                    lane.dataset.lane = laneKey;
                    const items = state.builder.lanes[laneKey] || [];

                    lane.innerHTML = `
                        <div class="lane__header">
                            <div class="lane__title">
                                <strong>${laneInfo.label}</strong>
                                <span>${laneInfo.description}</span>
                            </div>
                            <button class="lane__add" data-lane="${laneKey}" type="button" aria-haspopup="true">
                                ${laneKey === "atHome" ? "ï¼‹ Add Resource" : "ï¼‹ Add Program"}
                            </button>
                        </div>
                        <div class="lane__list" id="lane-${laneKey}" role="list">
                            ${items.length ? "" : `<div class="builder-hint" role="note">${laneKey === "atHome" ? "No resources added yet. Use Add Resource to capture local supports." : "No programs added yet. Use Add Program or from a card."}</div>`}
                        </div>
                    `;

                    elements.builderLanes.appendChild(lane);

                    const listElement = lane.querySelector(".lane__list");
                    items.forEach((item, index) => {
                        const tile = document.createElement("article");
                        tile.dataset.lane = laneKey;
                        tile.dataset.index = index.toString();

                        if (laneKey === "atHome" || !item.programId) {
                            const addedStamp = item.addedAt
                                ? new Date(item.addedAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
                                : "just now";
                            tile.className = "builder-tile builder-tile--manual";
                            tile.setAttribute("role", "listitem");
                            tile.dataset.resourceId = item.id || "";
                            tile.innerHTML = `
                                <div class="builder-manual-header">
                                    <input type="text" data-field="name" value="${escapeAttribute(item.name || "")}" placeholder="Resource name (e.g., Dr. Smith, LCSW)" aria-label="Resource name">
                                    <div class="builder-manual-meta">
                                        <input type="text" data-field="city" value="${escapeAttribute(item.city || "")}" placeholder="City / Telehealth" aria-label="Location or delivery">
                                        <input type="text" data-field="focus" value="${escapeAttribute(item.focus || "")}" placeholder="Focus or service type" aria-label="Service focus">
                                    </div>
                                </div>
                                <div class="builder-editor">
                                    <div class="editor-toolbar" role="toolbar" aria-label="Formatting options">
                                        <button type="button" data-editor-command="bold" aria-label="Bold">B</button>
                                        <button type="button" data-editor-command="italic" aria-label="Italic"><em>I</em></button>
                                        <button type="button" data-editor-command="bullet" aria-label="Bulleted list">â€¢</button>
                                        <button type="button" data-editor-command="clear" aria-label="Clear formatting">âœ•</button>
                                    </div>
                                    <div class="editor-surface" data-field="notes" contenteditable="true" role="textbox" aria-multiline="true" data-placeholder="Type family-friendly notes, availability, or contact instructions.">${item.notesHtml || ""}</div>
                                </div>
                                <div class="builder-tile__actions">
                                    <div class="tile-actions">
                                        <button type="button" data-action="up" aria-label="Move up">â–²</button>
                                        <button type="button" data-action="down" aria-label="Move down">â–¼</button>
                                        <button type="button" data-action="remove" aria-label="Remove resource">âœ•</button>
                                    </div>
                                    <span class="builder-hint">Auto-saves Â· added ${addedStamp}</span>
                                </div>
                            `;
                            listElement.appendChild(tile);
                            return;
                        }

                        const program = getProgramById(item.programId);
                        if (!program) return;
                        const trackOptions = getProgramTrackOptions(item.programId);
                        const currentTrack = item.track || getDefaultTrackId(item.programId);
                        const trackOptionsHtml = trackOptions.map(option => `
                            <option value="${option.id}" ${option.id === currentTrack ? "selected" : ""}>${option.label}</option>
                        `).join("");
                        const trackLabel = getTrackLabel(currentTrack, item.programId);
                        const programNote = state.notes.get(program.id) || "";
                        const noteHtml = `
                            <div class="builder-clinician-note" data-program-id="${escapeAttribute(program.id)}" data-empty="${programNote ? "false" : "true"}">
                                <strong>Clinician note</strong>
                                <span>${programNote ? escapeHtml(programNote) : "No clinician note saved"}</span>
                            </div>
                        `;
                        tile.className = "builder-tile";
                        tile.setAttribute("role", "listitem");
                        tile.dataset.programId = program.id;
                        tile.innerHTML = `
                            <div class="builder-tile__title">
                                <div class="builder-program-heading">
                                    <strong>${program.name}</strong>
                                    <small>${program.focus} Â· ${program.format}</small>
                                </div>
                                <span class="builder-track-chip" data-track="${currentTrack}">${trackLabel}</span>
                            </div>
                            <label class="builder-track-select">
                                Track emphasis
                                <div class="track-select-row">
                                    <select data-field="track" aria-label="Select track emphasis">
                                        ${trackOptionsHtml}
                                    </select>
                                    <button type="button" class="track-apply-button" data-track-apply="lane" aria-label="Apply track to entire lane">Apply to lane</button>
                                </div>
                            </label>
                            <label>
                                Client initials
                                <input type="text" maxlength="8" value="${item.client || ""}" placeholder="e.g., JD" aria-label="Client initials">
                            </label>
                            <label>
                                Why this program?
                                <textarea rows="2" placeholder="Add clinical rationale">${item.reason || ""}</textarea>
                            </label>
                            ${noteHtml}
                            <div class="builder-tile__actions">
                                <div class="tile-actions">
                                    <button type="button" data-action="up" aria-label="Move up">â–²</button>
                                    <button type="button" data-action="down" aria-label="Move down">â–¼</button>
                                    <button type="button" data-action="remove" aria-label="Remove from builder">âœ•</button>
                                </div>
                                <span class="builder-hint">Auto-saves Â· added ${new Date(item.addedAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
                            </div>
                        `;
                        listElement.appendChild(tile);
                    });
                });

                updateBuilderSummary();
                updateClientContextDisplay();
                queueBuilderBroadcast("render");
            }

            function updateBuilderSummary() {
                const laneKeys = Object.keys(laneConfig);
                const counts = laneKeys.map(key => state.builder.lanes[key]?.length || 0);
                const total = counts.reduce((sum, value) => sum + value, 0);
                elements.builderSummary.textContent = total
                    ? `${total} entr${total === 1 ? "y" : "ies"} staged across ${counts.map((count, idx) => {
                        const laneKey = laneKeys[idx];
                        const label = laneConfig[laneKey].label.split(" ")[0];
                        return `${count} ${label}`;
                    }).join(", ")}`
                    : "No entries staged yet";
            }

            function openDetails(id) {
                const program = getProgramById(id);
                if (!program) return;

                state.selectedProgramId = program.id;
                const familyView = isFamilyView();

                const isNetworkParent = Array.isArray(program.flags) && program.flags.includes("network-parent");
                const parentProgram = program.parentProgramId ? getProgramById(program.parentProgramId) : null;
                const parentName = program.parentProgramName || parentProgram?.name || null;

                const renderListSection = (title, items) => {
                    if (!Array.isArray(items) || !items.length) return "";
                    const entries = items
                        .filter(Boolean)
                        .map(item => `<li>${escapeHtml(String(item))}</li>`)
                        .join("");
                    if (!entries) return "";
                    return `
                        <div class="details-panel__section">
                            <h3>${escapeHtml(title)}</h3>
                            <ul class="details-panel__list">${entries}</ul>
                        </div>
                    `;
                };

                const renderParagraphSection = (title, text) => {
                    if (!text) return "";
                    const paragraphs = String(text)
                        .split(/\n{2,}|\r\n\r\n/)
                        .map(chunk => chunk.trim())
                        .filter(Boolean)
                        .map(chunk => `<p>${escapeHtml(chunk)}</p>`)
                        .join("");
                    if (!paragraphs) return "";
                    return `
                        <div class="details-panel__section">
                            <h3>${escapeHtml(title)}</h3>
                            ${paragraphs}
                        </div>
                    `;
                };

                const renderInfoSection = () => {
                    const infoItems = [];
                    const locationParts = [
                        program.location?.city,
                        program.location?.state
                    ].filter(Boolean);
                    const locationLine = locationParts.length ? locationParts.join(", ") : (program.location?.address || null);
                    if (locationLine) {
                        infoItems.push({ label: "Location", value: locationLine });
                    }
                    if (program.programCategory) {
                        infoItems.push({ label: "Program Category", value: program.programCategory });
                    }
                if (!familyView && typeof program.costRange === "string" && program.costRange.trim()) {
                        infoItems.push({ label: "Investment", value: program.costRange });
                    }
                    if (program.genderServed) {
                        infoItems.push({ label: "Gender Served", value: program.genderServed });
                    }
                    if (program.ageRange) {
                        if (typeof program.ageRange === "string") {
                            infoItems.push({ label: "Age Range", value: program.ageRange });
                        } else {
                            const min = (typeof program.ageRange.min === "number") ? program.ageRange.min : "?";
                            const max = (typeof program.ageRange.max === "number") ? program.ageRange.max : "?";
                            infoItems.push({ label: "Age Range", value: `Ages ${min}-${max}` });
                        }
                    }
                    if (!infoItems.length) return "";
                    const rows = infoItems
                        .filter(item => item.value)
                        .map(item => `<li><strong>${escapeHtml(item.label)}:</strong> ${escapeHtml(String(item.value))}</li>`)
                        .join("");
                    if (!rows) return "";
                    return `
                        <div class="details-panel__section">
                            <h3>Program Snapshot</h3>
                            <ul class="details-panel__list details-panel__list--info">${rows}</ul>
                        </div>
                    `;
                };

                const renderContactsSection = () => {
                    const contact = program.contacts || {};
                    const rows = [];
                    if (contact.director || contact.name) {
                        rows.push(`<span>${escapeHtml(contact.director || contact.name)}</span>`);
                    }
                    if (contact.phone) {
                        const telDigits = contact.phone.replace(/[^\d+]/g, "");
                        if (telDigits) {
                            const telHref = `tel:${telDigits}`;
                            rows.push(`<a href="${escapeAttribute(telHref)}">${escapeHtml(contact.phone)}</a>`);
                        } else {
                            rows.push(`<span>${escapeHtml(contact.phone)}</span>`);
                        }
                    }
                    if (contact.email) {
                        const mailHref = `mailto:${contact.email}`;
                        rows.push(`<a href="${escapeAttribute(mailHref)}">${escapeHtml(contact.email)}</a>`);
                    }
                    if (contact.website) {
                        const hasProtocol = /^https?:\/\//i.test(contact.website);
                        const href = hasProtocol ? contact.website : `https://${contact.website}`;
                        rows.push(`<a href="${escapeAttribute(href)}" target="_blank" rel="noopener">Website</a>`);
                    }
                    if (!rows.length) return "";
                    return `
                        <div class="details-panel__section">
                            <h3>Contacts</h3>
                            <div class="details-panel__contact-grid">${rows.join("")}</div>
                            <div class="details-panel__contact-actions">
                                <button type="button" class="details-panel__notes-clear" data-action="copy-contacts">Copy contact card</button>
                            </div>
                        </div>
                    `;
                };

                const networkEntries = [];
                if (isNetworkParent) {
                    PROGRAMS.forEach(candidate => {
                        if (candidate.parentProgramId === program.id) {
                            networkEntries.push(candidate);
                        }
                    });
                } else if (program.parentProgramId) {
                    if (parentProgram) {
                        networkEntries.push(Object.assign({ __isParent: true }, parentProgram));
                    }
                    PROGRAMS.forEach(candidate => {
                        if (candidate.parentProgramId === program.parentProgramId && candidate.id !== program.id) {
                            networkEntries.push(candidate);
                        }
                    });
                }

                const uniqueNetworkEntries = [];
                const seenNetworkIds = new Set();
                networkEntries.forEach(entry => {
                    if (entry && entry.id && !seenNetworkIds.has(entry.id)) {
                        seenNetworkIds.add(entry.id);
                        uniqueNetworkEntries.push(entry);
                    }
                });

                const renderNetworkSection = () => {
                    if (!uniqueNetworkEntries.length) return "";
                    const listItems = uniqueNetworkEntries.map(entry => {
                        const metaBits = [];
                        if (entry.__isParent) metaBits.push("Network Parent");
                        if (entry.focus) metaBits.push(entry.focus);
                        if (entry.location?.state) metaBits.push(entry.location.state);
                        return `
                            <li>
                                <button type="button" class="network-program-link" data-network-program-id="${escapeAttribute(entry.id)}">
                                    ${escapeHtml(entry.name)}
                                </button>
                                ${metaBits.length ? `<div class="details-panel__note">${escapeHtml(metaBits.join(" â€¢ "))}</div>` : ""}
                            </li>
                        `;
                    }).join("");
                    const leadIn = parentName
                        ? `Other programs in the ${escapeHtml(parentName)} network.`
                        : "Related network programs.";
                    return `
                        <div class="details-panel__section">
                            <h3>Network Programs</h3>
                            <p style="margin:0; color:var(--text-subtle); font-size:0.85rem;">${leadIn}</p>
                            <ul class="details-panel__list details-panel__list--network">
                                ${listItems}
                            </ul>
                        </div>
                    `;
                };

                state.selectedProgramId = program.id;
                elements.detailsTitle.textContent = program.name;
                elements.detailsSubtitle.textContent = program.summary || program.overview || "Detailed program information";

                const metaBadges = [];
                if (program.focus) metaBadges.push(`<span class="badge badge--neutral">${escapeHtml(program.focus)}</span>`);
                if (program.format) metaBadges.push(`<span class="badge badge--neutral">${escapeHtml(program.format)}</span>`);
                metaBadges.push(`<span class="badge badge--neutral">Starts ${program.availabilityDays <= 0 ? "now" : `in ${program.availabilityDays} day${program.availabilityDays > 1 ? "s" : ""}`}</span>`);
                if (parentName && parentName !== program.name) {
                    metaBadges.push(`<span class="badge badge--neutral">Part of ${escapeHtml(parentName)}</span>`);
                } else if (isNetworkParent) {
                    metaBadges.push(`<span class="badge badge--neutral">Network Parent</span>`);
                }
                elements.detailsMeta.innerHTML = metaBadges.join("");

                const overviewText = program.overview || (parentProgram && parentProgram.overview) || null;

                const clinicianSections = [
                    renderParagraphSection("Program Overview", overviewText),
                    renderInfoSection(),
                    renderParagraphSection("Clinical Focus", program.levelOfCare),
                    renderListSection("Programming Cadence", program.weeklyStructure),
                    renderListSection("Highlights", program.highlights),
                    renderListSection("Outcomes & Analytics", program.outcomes),
                    renderContactsSection(),
                    renderNetworkSection()
                ];

                const familySections = [
                    renderParagraphSection("Program Overview", overviewText),
                    renderInfoSection(),
                    renderListSection("Programming Cadence", program.weeklyStructure),
                    renderContactsSection(),
                    renderNetworkSection()
                ];

                const detailsHtml = (familyView ? familySections : clinicianSections)
                    .filter(Boolean)
                    .join("");
                elements.detailsBody.innerHTML = detailsHtml || `
                    <div class="details-panel__section">
                        <p style="color:var(--text-subtle);">Detailed write-up unavailable for this program.</p>
                    </div>
                `;
                if (elements.detailsNotesSection && elements.detailsNotesInput && elements.detailsNotesStatus) {
                    if (noteSaveTimer) {
                        window.clearTimeout(noteSaveTimer);
                        noteSaveTimer = null;
                    }
                    if (familyView) {
                        elements.detailsNotesSection.hidden = true;
                        elements.detailsNotesInput.dataset.programId = "";
                        elements.detailsNotesInput.value = "";
                        elements.detailsNotesStatus.textContent = "Notes hidden in family view";
                    } else {
                        const existingNote = state.notes.get(program.id) || "";
                        elements.detailsNotesSection.hidden = false;
                        elements.detailsNotesInput.value = existingNote;
                        elements.detailsNotesInput.dataset.programId = program.id;
                        elements.detailsNotesStatus.textContent = existingNote ? "Saved" : "Autosaves to this device";
                    }
                }
                const copyContactsButton = elements.detailsBody.querySelector("[data-action=\"copy-contacts\"]");
                if (copyContactsButton) {
                    copyContactsButton.addEventListener("click", async () => {
                        const contact = program.contacts || {};
                        const location = program.location || {};
                        const cityState = [location.city, location.state].filter(Boolean).join(", ");
                        const addressLine = location.address && cityState
                            ? `${location.address}, ${cityState}`
                            : (location.address || cityState || "");
                        const lines = [
                            program.name,
                            contact.director || contact.name || "",
                            addressLine,
                            location.zip || "",
                            contact.phone ? `Phone: ${contact.phone}` : "",
                            contact.email ? `Email: ${contact.email}` : "",
                            contact.website ? `Website: ${contact.website}` : ""
                        ].filter(Boolean);
                        if (!lines.length) {
                            showToast("No contact details available to copy");
                            return;
                        }
                        const success = await copyTextToClipboard(lines.join("\n"));
                        showToast(success ? "Contact details copied" : "Unable to copy contact details");
                    });
                }

                if (elements.detailsCompareNetworkButton) {
                    const relatedIds = uniqueNetworkEntries.map(entry => entry.id);
                    if (relatedIds.length) {
                        const includeSelf = !isNetworkParent;
                        elements.detailsCompareNetworkButton.style.display = "";
                        elements.detailsCompareNetworkButton.dataset.programId = program.id;
                        elements.detailsCompareNetworkButton.dataset.relatedPrograms = JSON.stringify(relatedIds);
                        elements.detailsCompareNetworkButton.dataset.includeSelf = includeSelf ? "1" : "0";
                        elements.detailsCompareNetworkButton.disabled = false;
                    } else {
                        elements.detailsCompareNetworkButton.style.display = "none";
                        elements.detailsCompareNetworkButton.dataset.programId = "";
                        elements.detailsCompareNetworkButton.dataset.relatedPrograms = "[]";
                        elements.detailsCompareNetworkButton.dataset.includeSelf = "0";
                    }
                }

                elements.detailsBody.querySelectorAll(".network-program-link").forEach(button => {
                    button.addEventListener("click", () => {
                        const targetId = button.dataset.networkProgramId;
                        if (targetId) {
                            openDetails(targetId);
                        }
                    });
                });

                overlays.overlay.classList.add("is-active");
                overlays.panel.classList.add("is-open");
                overlays.overlay.setAttribute("aria-hidden", "false");
                elements.detailsAddButton.disabled = false;
                elements.detailsGenerateButton.disabled = false;
                elements.detailsAddButton.setAttribute("data-program-id", program.id);
                elements.detailsGenerateButton.setAttribute("data-program-id", program.id);
                announce(`Details open for ${program.name}`);
            }

            function closeDetails() {
                overlays.overlay.classList.remove("is-active");
                overlays.panel.classList.remove("is-open");
                overlays.overlay.setAttribute("aria-hidden", "true");
                elements.detailsAddButton.removeAttribute("data-program-id");
                elements.detailsGenerateButton.removeAttribute("data-program-id");
                if (elements.detailsNotesSection && elements.detailsNotesInput && elements.detailsNotesStatus) {
                    elements.detailsNotesSection.hidden = true;
                    elements.detailsNotesInput.dataset.programId = "";
                    elements.detailsNotesInput.value = "";
                    elements.detailsNotesStatus.textContent = "Autosaves to this device";
                }
                if (noteSaveTimer) {
                    window.clearTimeout(noteSaveTimer);
                    noteSaveTimer = null;
                }
                state.selectedProgramId = null;
            }

            function toggleFilter(button) {
                const group = button.dataset.group;
                const value = button.dataset.value;
                const active = button.classList.toggle("is-active");
                const targetSet = state.filters[group];
                if (!targetSet) return;
                if (active) {
                    targetSet.add(value);
                } else {
                    targetSet.delete(value);
                }
                renderPrograms();
            }

            function setView(view) {
                if (!view) return;
                state.view = view;
                viewToggleButtons.forEach(btn => {
                    btn.classList.toggle("is-active", btn.dataset.view === view);
                    btn.setAttribute("aria-pressed", btn.dataset.view === view ? "true" : "false");
                });
                const isRows = view === "rows";
                const isMap = view === "map";
                const isCompare = view === "compare";
                elements.resultsGrid.classList.toggle("is-compact", isRows);
                elements.resultsGrid.style.display = (isMap || isCompare) ? "none" : "grid";
                elements.mapContainer.classList.toggle("is-visible", isMap);
                elements.compareContainer.classList.toggle("is-visible", isCompare);
                if (isMap) {
                    if (elements.mapRadiusInput) {
                        elements.mapRadiusInput.value = String(state.map.radiusMiles);
                    }
                    if (elements.mapRadiusValue) {
                        elements.mapRadiusValue.textContent = `${state.map.radiusMiles} mi`;
                    }
                    if (elements.mapDistanceFilter) {
                        elements.mapDistanceFilter.value = state.map.distanceFilter || "all";
                    }
                }
                if (isCompare) {
                    renderComparisonView();
                }
                try {
                    localStorage.setItem("ccpro-preferred-view", view);
                } catch (error) {
                    console.warn("Unable to persist preferred view", error);
                }
                renderPrograms();
            }

            function goToPage(pageNumber) {
                if (state.pagination.pageSizeOption === "all") return;
                const totalPages = state.pagination.totalPages || 1;
                const clamped = Math.max(1, Math.min(pageNumber, totalPages));
                if (clamped === state.pagination.currentPage) return;
                state.pagination.currentPage = clamped;
                renderPrograms();
            }

            function changePage(delta) {
                goToPage(state.pagination.currentPage + delta);
            }

            function setPaginationPageSize(option, { persist = true } = {}) {
                let normalized = option === "all" ? "all" : Number(option);
                if (normalized !== "all" && !PROGRAMS_PER_PAGE_OPTIONS.includes(normalized)) {
                    normalized = PREFERENCES_DEFAULTS.programsPerPage;
                }
                if (state.pagination.pageSizeOption === normalized) {
                    return;
                }
                state.pagination.pageSizeOption = normalized;
                state.pagination.pageSizeValue = normalized === "all" ? Number.MAX_SAFE_INTEGER : Number(normalized);
                state.pagination.currentPage = 1;
                state.pagination.lastSignature = null;
                if (persist) {
                    preferencesState = {
                        ...preferencesState,
                        programsPerPage: normalized
                    };
                    saveUserPreferences(preferencesState);
                }
                renderPrograms();
            }

            function getProgramById(id) {
                return PROGRAMS.find(program => program.id === id);
            }

            function addToBuilder(programId, lane, options = {}) {
                const program = getProgramById(programId);
                if (!program) {
                    showToast("Program not found");
                    return;
                }
                const laneItems = state.builder.lanes[lane];
                if (!laneItems) {
                    showToast("Lane unavailable");
                    return;
                }
                const alreadyExists = laneItems.some(item => item.programId === programId);
                if (alreadyExists) {
                    if (!options.silent) {
                        showToast(`${program.name} is already in ${laneConfig[lane].label}`);
                    }
                    return;
                }
             const defaultInitials = (state.clientContext?.initials || "").toUpperCase();
                laneItems.push({
                    programId,
                 client: defaultInitials,
                    reason: "",
                    track: getDefaultTrackId(programId),
                    addedAt: new Date().toISOString()
                });
                renderBuilder();
                scheduleAutosave();
                queueBuilderBroadcast("add");
                if (!options.silent) {
                    showToast(`${program.name} added to ${laneConfig[lane].label}`);
                }
            }

            function addManualAtHomeResource(entryOverrides = null, options = null) {
                const overrides = entryOverrides && typeof entryOverrides === "object" ? { ...entryOverrides } : {};
                const opts = options && typeof options === "object" ? { ...options } : {};
                const timestamp = new Date().toISOString();
                if (!overrides.addedAt) {
                    overrides.addedAt = timestamp;
                }
                if (!overrides.id) {
                    overrides.id = generateAtHomeId();
                }
                const entry = normalizeAtHomeEntry(overrides);
                state.builder.lanes.atHome.push(entry);
                renderBuilder();
                scheduleAutosave();
                queueBuilderBroadcast(opts.reason || "add-manual");
                const suppressToast = opts.silent || opts.toast === false;
                if (!suppressToast) {
                    const toastMessage = typeof opts.toast === "string" ? opts.toast : "At-home resource added";
                    showToast(toastMessage);
                }
                const shouldFocus = opts.focus !== undefined ? opts.focus : !opts.silent;
                if (shouldFocus) {
                    window.requestAnimationFrame(() => {
                        const newIndex = state.builder.lanes.atHome.length - 1;
                        const editor = elements.builderLanes.querySelector(`.builder-tile[data-lane="atHome"][data-index="${newIndex}"] .editor-surface`);
                        if (editor) {
                            editor.focus();
                        }
                    });
                }
                return entry;
            }

            function handleBuilderInput(event) {
                const target = event.target;
                const tile = target.closest(".builder-tile");
                if (!tile) return;
                const lane = tile.dataset.lane;
                const index = Number(tile.dataset.index);
                const laneItems = state.builder.lanes[lane];
                if (!laneItems || laneItems[index] == null) return;
                const item = laneItems[index];

                if (lane === "atHome") {
                    if (target instanceof HTMLInputElement && target.dataset.field) {
                        item[target.dataset.field] = target.value;
                        item.lastEdited = new Date().toISOString();
                        scheduleAutosave();
                    } else if (target instanceof HTMLElement && target.dataset.field === "notes") {
                        const sanitized = sanitizeRichText(target.innerHTML);
                        if (sanitized !== target.innerHTML) {
                            target.innerHTML = sanitized;
                        }
                        if (!sanitized) {
                            target.innerHTML = "";
                        }
                        item.notesHtml = sanitized;
                        item.notesText = getPlainTextFromHtml(sanitized);
                        item.lastEdited = new Date().toISOString();
                        scheduleAutosave();
                    }
                    queueBuilderBroadcast("at-home-edit");
                    return;
                }

                if (target instanceof HTMLSelectElement && target.dataset.field === "track") {
                    item.track = target.value;
                    item.addedAt = item.addedAt || new Date().toISOString();
                    renderBuilder();
                    scheduleAutosave();
                    queueBuilderBroadcast("track-change");
                    return;
                }

                if (target instanceof HTMLInputElement) {
                    item.client = target.value.toUpperCase();
                    item.addedAt = item.addedAt || new Date().toISOString();
                    scheduleAutosave();
                    queueBuilderBroadcast("tile-edit");
                } else if (target instanceof HTMLTextAreaElement) {
                    item.reason = target.value;
                    item.addedAt = item.addedAt || new Date().toISOString();
                    scheduleAutosave();
                    queueBuilderBroadcast("tile-edit");
                }
            }

            function applyEditorCommand(tile, command) {
                const editor = tile.querySelector(".editor-surface");
                if (!editor) return;
                editor.focus();
                if (command === "clear") {
                    editor.innerHTML = "";
                    const syntheticClear = new Event("input", { bubbles: true });
                    editor.dispatchEvent(syntheticClear);
                    return;
                }
                const execCommand = command === "bullet" ? "insertUnorderedList" : command;
                try {
                    document.execCommand(execCommand);
                } catch (error) {
                    console.warn("Formatting command failed:", command, error);
                }
                const synthetic = new Event("input", { bubbles: true });
                editor.dispatchEvent(synthetic);
            }

            function applyTrackToLane(lane, trackId) {
                if (!trackId || lane === "atHome") return;
                const laneItems = state.builder.lanes[lane];
                if (!laneItems || !laneItems.length) return;
                laneItems.forEach(item => {
                    if (item.programId) {
                        item.track = trackId;
                    }
                });
                renderBuilder();
                scheduleAutosave();
                const laneLabel = laneConfig[lane]?.label || "Lane";
                showToast(`${laneLabel} set to ${getTrackLabel(trackId)}`);
                queueBuilderBroadcast("track-apply-lane");
            }

            function handleTileAction(event) {
                const button = event.target;
                if (!(button instanceof HTMLButtonElement)) return;
                const tile = button.closest(".builder-tile");
                if (!tile) return;
                const lane = tile.dataset.lane;
                const index = Number(tile.dataset.index);
                const laneItems = state.builder.lanes[lane];
                if (!laneItems) return;
                const editorCommand = button.dataset.editorCommand;
                if (editorCommand) {
                    applyEditorCommand(tile, editorCommand);
                    return;
                }
                const trackApply = button.dataset.trackApply;
                if (trackApply === "lane") {
                    const item = laneItems[index];
                    if (item?.track) {
                        applyTrackToLane(lane, item.track);
                    }
                    return;
                }
                const action = button.dataset.action;
                if (action === "remove") {
                    const removed = laneItems.splice(index, 1)[0];
                    renderBuilder();
                    scheduleAutosave();
                    queueBuilderBroadcast("tile-remove");
                    if (removed) {
                        if (removed.programId) {
                            const program = getProgramById(removed.programId);
                            showToast(`${program?.name ?? "Program"} removed from builder`);
                        } else {
                            showToast(`${removed.name || "Resource"} removed from builder`);
                        }
                    }
                } else if (action === "up" && index > 0) {
                    [laneItems[index - 1], laneItems[index]] = [laneItems[index], laneItems[index - 1]];
                    renderBuilder();
                    scheduleAutosave();
                    queueBuilderBroadcast("tile-move-up");
                } else if (action === "down" && index < laneItems.length - 1) {
                    [laneItems[index], laneItems[index + 1]] = [laneItems[index + 1], laneItems[index]];
                    renderBuilder();
                    scheduleAutosave();
                    queueBuilderBroadcast("tile-move-down");
                }
            }

            function saveDraft(trigger = "auto") {
                state.builder.lastSaved = new Date().toISOString();
                const payload = {
                    version: 2,
                    documentType: state.documentType,
                    builder: {
                        lanes: state.builder.lanes,
                        lastSaved: state.builder.lastSaved,
                        associatedClientId: state.builder.associatedClientId || null
                    },
                    clientContext: state.clientContext ? {
                        clientId: state.clientContext.clientId,
                        initials: state.clientContext.initials,
                        kipuId: state.clientContext.kipuId || null
                    } : null,
                    comparison: {
                        programIds: state.comparison.programIds.slice(0, state.comparison.limit)
                    },
                    map: {
                        radiusMiles: state.map.radiusMiles,
                        distanceFilter: state.map.distanceFilter,
                        applyFiltersGlobally: state.map.applyFiltersGlobally,
                        center: state.map.center,
                        radiusPreset: state.map.radiusPreset,
                        home: state.map.home
                    }
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                updateDraftMeta();
                const draftEvent = {
                    clientId: state.clientContext?.clientId || null,
                    savedAt: state.builder.lastSaved,
                    documentType: state.documentType
                };
                emitProgramEvent("programs:draftSaved", draftEvent);
                emitProgramEvent("programs-docs:draft-saved", draftEvent);
                if (state.clientContext?.clientId && window.eventBus?.emit) {
                    try {
                        window.eventBus.emit("cache:invalidateClient", { clientId: state.clientContext.clientId });
                    } catch (error) {
                        console.warn("Programs docs cache event failed:", error);
                    }
                }
                queueBuilderBroadcast(trigger === "manual" ? "save-manual" : "save-auto");
                if (trigger === "manual") {
                    showToast("Draft saved");
                }
            }

            function scheduleAutosave() {
                if (state.autosaveInterval === "never") {
                    return;
                }
                const delaySeconds = typeof state.autosaveInterval === "number"
                    ? Math.max(state.autosaveInterval, 10)
                    : PREFERENCES_DEFAULTS.autosaveInterval;
                const delay = delaySeconds * 1000;
                if (autosaveTimer) {
                    clearTimeout(autosaveTimer);
                }
                autosaveTimer = window.setTimeout(() => saveDraft("auto"), delay);
            }

            function loadDraft() {
                try {
                    const storageKeys = [STORAGE_KEY, ...LEGACY_STORAGE_KEYS];
                    let sourceKey = null;
                    let raw = null;
                    for (const key of storageKeys) {
                        try {
                            raw = localStorage.getItem(key);
                        } catch {
                            raw = null;
                        }
                        if (raw) {
                            sourceKey = key;
                            break;
                        }
                    }
                    if (!raw) return null;
                    const data = JSON.parse(raw);
                    if (!data) return null;

                    let builder;
                    if (data.builder) {
                        builder = {
                            lanes: {
                                stabilize: (data.builder.lanes?.stabilize || []).map(normalizeProgramEntry),
                                bridge: (data.builder.lanes?.bridge || []).map(normalizeProgramEntry),
                                sustain: (data.builder.lanes?.sustain || []).map(normalizeProgramEntry),
                                atHome: (data.builder.lanes?.atHome || []).map(normalizeAtHomeEntry)
                            },
                            lastSaved: data.builder.lastSaved || data.lastSaved || null
                        };
                        builder.associatedClientId = data.builder.associatedClientId || data.associatedClientId || null;
                    } else if (data.lanes) {
                        builder = {
                            lanes: {
                                stabilize: (data.lanes.stabilize || []).map(normalizeProgramEntry),
                                bridge: (data.lanes.bridge || []).map(normalizeProgramEntry),
                                sustain: (data.lanes.sustain || []).map(normalizeProgramEntry),
                                atHome: []
                            },
                            lastSaved: data.lastSaved || null
                        };
                        builder.associatedClientId = data.associatedClientId || null;
                    } else {
                        builder = null;
                    }

                    if (sourceKey && sourceKey !== STORAGE_KEY) {
                        try {
                            localStorage.removeItem(sourceKey);
                        } catch (error) {
                            console.warn("Unable to remove legacy draft key", error);
                        }
                    }

                    if (!builder) return null;

                    const comparisonProgramIds = Array.isArray(data.comparison?.programIds)
                        ? data.comparison.programIds.filter(id => typeof id === "string")
                        : [];

                    const mapState = data.map && typeof data.map === "object"
                        ? {
                            radiusMiles: typeof data.map.radiusMiles === "number" ? data.map.radiusMiles : undefined,
                            distanceFilter: typeof data.map.distanceFilter === "string" ? data.map.distanceFilter : undefined,
                            applyFiltersGlobally: Boolean(data.map.applyFiltersGlobally),
                            center: data.map.center && typeof data.map.center.lat === "number" && typeof data.map.center.lng === "number"
                                ? data.map.center
                                : undefined
                        }
                        : null;

                    let clientContext = null;
                    if (data.clientContext && typeof data.clientContext === "object") {
                        const normalizedId = typeof data.clientContext.clientId === "string" && data.clientContext.clientId.trim()
                            ? data.clientContext.clientId.trim()
                            : builder?.associatedClientId || null;
                        const normalizedInitials = data.clientContext.initials
                            ? String(data.clientContext.initials).toUpperCase().slice(0, 12)
                            : "";
                        if (normalizedId) {
                            clientContext = {
                                clientId: normalizedId,
                                initials: normalizedInitials,
                                kipuId: data.clientContext.kipuId || null
                            };
                        }
                    } else if (builder?.associatedClientId) {
                        clientContext = {
                            clientId: builder.associatedClientId,
                            initials: "",
                            kipuId: null
                        };
                    }

                    return {
                        builder,
                        documentType: data.documentType === "aftercare-plan" ? "aftercare-plan" : "aftercare-options",
                        comparisonProgramIds,
                        mapState,
                        clientContext
                    };
                } catch (error) {
                    console.warn("Unable to load draft", error);
                    return null;
                }
            }

            function generateDocument(docType = state.documentType, programId) {
                const builderItems = Object.values(state.builder.lanes).flat();
                if (!builderItems.length && !programId) {
                    showToast("Add at least one program before generating");
                    return;
                }
                const usedPrograms = programId
                    ? [getProgramById(programId)]
                    : builderItems.map(item => getProgramById(item.programId)).filter(Boolean);
                const names = usedPrograms.map(p => p?.name).filter(Boolean);
                saveDraft("manual");
                const snapshot = collectBuilderSnapshot(programId || null);
                window.latestGeneratedDocument = snapshot;
                const label = getDocumentTypeLabel(docType);
                const summary = names.length ? names.join(", ") : (programId ? "selected program" : "current builder entries");
                const html = renderDocumentHtml(snapshot);
                const docWindow = window.open("", "_blank", "noopener,width=980,height=720");
                if (!docWindow) {
                    showToast("Enable pop-ups to preview the document.");
                    return;
                }
                docWindow.document.write(html);
                docWindow.document.close();
                docWindow.focus();
                const generatedEvent = {
                    clientId: state.clientContext?.clientId || null,
                    documentType: docType,
                    generatedAt: snapshot.generatedAt,
                    snapshot
                };
                emitProgramEvent("document:generated", generatedEvent);
                emitProgramEvent("programs-docs:document-generated", generatedEvent);
                showToast(`${label} generated with ${summary}`);
            }

            function populateQuickAddOptions() {
                const frag = document.createDocumentFragment();
                PROGRAMS.forEach(program => {
                    const option = document.createElement("option");
                    option.value = program.id;
                    option.textContent = program.name;
                    frag.appendChild(option);
                });
                elements.quickAddProgram.innerHTML = "";
                elements.quickAddProgram.appendChild(frag);
                elements.quickAddLane.value = state.quickAddLane;
            }

            function showQuickAdd(lane) {
                state.quickAddLane = lane;
                overlays.quickAdd.classList.add("is-visible");
                overlays.quickAdd.setAttribute("aria-hidden", "false");
                elements.quickAddLane.value = lane;
                populateQuickAddOptions();
            }

            function hideQuickAdd() {
                overlays.quickAdd.classList.remove("is-visible");
                overlays.quickAdd.setAttribute("aria-hidden", "true");
            }

            function clearFilters() {
                filterButtons.forEach(btn => btn.classList.remove("is-active"));
                Object.values(state.filters).forEach(set => set.clear());
                state.map.distanceFilter = "all";
                state.map.applyFiltersGlobally = false;
                setRadiusPreset("local", { silent: true, noRender: true, noSave: true });
                if (elements.mapDistanceFilter) {
                    elements.mapDistanceFilter.value = "all";
                }
                if (elements.mapRadiusValue) {
                    elements.mapRadiusValue.textContent = `${state.map.defaultRadius} mi`;
                }
                renderPrograms();
            }

            function handleProgramCardClick(event) {
                const button = event.target;
                if (!(button instanceof HTMLButtonElement)) return;
                const card = button.closest(".program-card");
                if (!card) return;
                const programId = card.dataset.programId;
                if (!programId) return;
                if (button.dataset.action === "details") {
                    openDetails(programId);
                    return;
                }
                if (button.dataset.action === "add") {
                    const select = card.querySelector("[data-program-lane]");
                    const lane = select?.value || "stabilize";
                    addToBuilder(programId, lane);
                    return;
                }
                if (button.dataset.action === "compare") {
                    toggleProgramComparison(programId);
                    return;
                }
            }

            function handleLaneAddClick(event) {
                const button = event.target;
                if (!(button instanceof HTMLButtonElement)) return;
                if (!button.classList.contains("lane__add")) return;
                const lane = button.dataset.lane || "stabilize";
                if (lane === "atHome") {
                    addManualAtHomeResource();
                    return;
                }
                showQuickAdd(lane);
            }

            function handleKeyboardShortcuts(event) {
                const tag = event.target.tagName;
                if (["INPUT", "TEXTAREA", "SELECT"].includes(tag)) {
                    return;
                }
                if (event.key === "/") {
                    event.preventDefault();
                    elements.searchInput.focus();
                } else if (event.key.toLowerCase() === "a") {
                    event.preventDefault();
                    showQuickAdd("stabilize");
                } else if (event.key.toLowerCase() === "c") {
                    event.preventDefault();
                    const firstCard = elements.resultsGrid.querySelector(".program-card");
                    if (firstCard) {
                        const programId = firstCard.dataset.programId;
                        openDetails(programId);
                    }
                } else if (event.key.toLowerCase() === "g") {
                    event.preventDefault();
                    generateDocument(state.documentType, state.selectedProgramId);
                }
            }

            function hydrateFromDraft() {
                setDocumentType(state.documentType, { announce: false, scheduleSave: false });
             if (state.clientContext?.initials) {
                 applyClientInitialsToBuilder(state.clientContext.initials);
             }
                renderBuilder();
             updateClientContextDisplay();
            }

            function registerGlobalEventListeners() {
                if (state.globalListenersRegistered) {
                    return;
                }
                const bus = window.eventBus;
                if (!bus?.on) {
                    if (state._eventBusRetryCount < 25) {
                        state._eventBusRetryCount += 1;
                        window.setTimeout(registerGlobalEventListeners, 150);
                    }
                    return;
                }

                state.globalListenersRegistered = true;
                state._eventBusRetryCount = 0;

                const unsubscribers = [];

                const handleClientDeleted = (data = {}) => {
                    if (!data?.clientId) return;
                    if (state.clientContext?.clientId === data.clientId) {
                        setClientContext(null, { announce: true, save: true });
                        renderBuilder();
                        showToast("Client removed. Builder reset.");
                        queueBuilderBroadcast("client-deleted");
                    }
                };

                const handleClientUpdated = (data = {}) => {
                    if (!data?.clientId || state.clientContext?.clientId !== data.clientId) {
                        return;
                    }
                    let changed = false;
                    if (data.newData?.initials) {
                        const incomingInitials = String(data.newData.initials).toUpperCase();
                        if (incomingInitials !== state.clientContext.initials) {
                            state.clientContext.initials = incomingInitials;
                            if (applyClientInitialsToBuilder(incomingInitials)) {
                                renderBuilder();
                            } else {
                                updateClientContextDisplay();
                            }
                            changed = true;
                        }
                    }
                    if (data.newData?.kipuId && data.newData.kipuId !== state.clientContext.kipuId) {
                        state.clientContext.kipuId = data.newData.kipuId;
                        changed = true;
                    }
                    if (changed) {
                        queueBuilderBroadcast("client-updated");
                    }
                };

                const handleTrackerUpdated = (data = {}) => {
                    if (!data?.clientId || state.clientContext?.clientId !== data.clientId) {
                        return;
                    }
                    queueBuilderBroadcast("tracker-updated");
                };

                unsubscribers.push(bus.on("client:deleted", handleClientDeleted));
                unsubscribers.push(bus.on("client:updated", handleClientUpdated));
                unsubscribers.push(bus.on("tracker:updated", handleTrackerUpdated));

                unsubscribers.push(bus.on("programs-docs:set-context", eventData => {
                    if (!eventData || typeof eventData !== "object") {
                        return;
                    }
                    setClientContext(eventData, {
                        announce: eventData.announce,
                        save: eventData.save
                    });
                }));

                unsubscribers.push(bus.on("programs-docs:clear-context", eventData => {
                    setClientContext(null, {
                        announce: eventData?.announce !== false,
                        save: eventData?.save !== false
                    });
                }));

                unsubscribers.push(bus.on("programs-docs:set-document-type", eventData => {
                    if (!eventData || typeof eventData !== "object") return;
                    if (!eventData.documentType) return;
                    setDocumentType(eventData.documentType, {
                        announce: eventData.announce,
                        scheduleSave: eventData.scheduleSave
                    });
                }));

                unsubscribers.push(bus.on("programs-docs:add-program", eventData => {
                    if (!eventData || typeof eventData !== "object") return;
                    if (!eventData.programId) return;
                    const requestedLane = typeof eventData.lane === "string" && state.builder.lanes[eventData.lane]
                        ? eventData.lane
                        : "stabilize";
                    addToBuilder(eventData.programId, requestedLane, {
                        silent: Boolean(eventData.silent)
                    });
                }));

                unsubscribers.push(bus.on("programs-docs:add-at-home-resource", eventData => {
                    if (!eventData || typeof eventData !== "object") {
                        addManualAtHomeResource();
                        return;
                    }
                    const entryData = eventData.entry && typeof eventData.entry === "object"
                        ? eventData.entry
                        : (
                            ("name" in eventData || "focus" in eventData || "notesHtml" in eventData || "notes" in eventData || "city" in eventData)
                                ? {
                                    name: eventData.name,
                                    focus: eventData.focus,
                                    city: eventData.city,
                                    notesHtml: eventData.notesHtml,
                                    notes: eventData.notes
                                }
                                : {}
                        );
                    addManualAtHomeResource(entryData, {
                        silent: Boolean(eventData.silent),
                        toast: eventData.toast,
                        focus: eventData.focus,
                        reason: eventData.reason || "add-manual-event"
                    });
                }));

                const respondToBuilderRequest = (eventData = {}) => {
                    const summary = getBuilderSummary();
                    const snapshot = collectBuilderSnapshot();
                    emitProgramEvent("programs:builderUpdated", {
                        reason: eventData.reason || "requested",
                        summary,
                        snapshot,
                        requestId: eventData.requestId || null
                    });
                };

                unsubscribers.push(bus.on("programs:request-builder-summary", respondToBuilderRequest));
                unsubscribers.push(bus.on("programs-docs:request-builder", respondToBuilderRequest));

                unsubscribers.push(bus.on("programs-docs:refresh", () => {
                    renderPrograms();
                    renderBuilder();
                    queueBuilderBroadcast("refresh-event");
                }));

                state._eventBusUnsubscribers = unsubscribers;

                console.info("Programs & Docs: subscribed to global event bus", unsubscribers.length);
                queueBuilderBroadcast("listeners-registered");
            }

            function init() {
                loadStoredProgramNotes();
                populateStateFilters();
                updateProgramDistances();
                updateAudienceToggleButtons();
                updateRadiusPresetUi();
                updateDistanceSortAvailability();
                if (hasHomeLocation() && elements.mapZipInput) {
                    elements.mapZipInput.value = state.map.home.zip || "";
                }
                hydrateFromDraft();
                populateQuickAddOptions();
                updateComparisonStatus();
             if (window.__pendingProgramsDocsClientContext) {
                 setClientContext(window.__pendingProgramsDocsClientContext, { announce: false, save: false });
                 delete window.__pendingProgramsDocsClientContext;
             } else {
                 updateClientContextDisplay();
             }
             registerGlobalEventListeners();

                documentTypeButtons.forEach(button => {
                    button.addEventListener("click", () => setDocumentType(button.dataset.docType));
                });
                setDocumentType(state.documentType, { silent: true });
                if (elements.paginationPageSize) {
                    elements.paginationPageSize.value = state.pagination.pageSizeOption === "all"
                        ? "all"
                        : String(state.pagination.pageSizeOption);
                }
                audienceToggleButtons.forEach(button => {
                    button.addEventListener("click", () => setAudienceMode(button.dataset.audience));
                });
                viewToggleButtons.forEach(button => button.addEventListener("click", () => setView(button.dataset.view)));
                mapRadiusPresetButtons.forEach(button => {
                    button.addEventListener("click", () => setRadiusPreset(button.dataset.radiusPreset));
                });
                clearFiltersButton.addEventListener("click", clearFilters);
                elements.searchInput.addEventListener("input", event => {
                    state.searchTerm = event.target.value.trim();
                    renderPrograms();
                });
                elements.sortSelect.value = state.sort;
                elements.sortSelect.addEventListener("change", event => {
                    const value = event.target.value;
                    if (value === "distance" && !hasHomeLocation()) {
                        showToast("Set a home ZIP to sort by distance");
                        event.target.value = state.sort;
                        return;
                    }
                    state.sort = value;
                    renderPrograms();
                });
                elements.resultsGrid.addEventListener("click", handleProgramCardClick);
                elements.builderLanes.addEventListener("click", handleLaneAddClick);
                elements.builderLanes.addEventListener("input", handleBuilderInput);
                elements.builderLanes.addEventListener("change", handleBuilderInput);
                elements.builderLanes.addEventListener("click", handleTileAction);
                elements.paginationPrevButton?.addEventListener("click", () => changePage(-1));
                elements.paginationNextButton?.addEventListener("click", () => changePage(1));
                elements.paginationPageSize?.addEventListener("change", event => {
                    setPaginationPageSize(event.target.value);
                });
                elements.builderLanes.addEventListener("mousedown", event => {
                    const target = event.target;
                    if (target instanceof HTMLButtonElement && target.dataset.editorCommand) {
                        event.preventDefault();
                    }
                });
                if (elements.mapRadiusInput) {
                    elements.mapRadiusInput.value = String(state.map.radiusMiles);
                    elements.mapRadiusValue.textContent = `${state.map.radiusMiles} mi`;
                    elements.mapRadiusInput.addEventListener("input", event => {
                        const value = Number(event.target.value);
                        if (!Number.isNaN(value)) {
                            setMapRadiusMiles(value, { source: "slider" });
                            if (state.view === "map") {
                                refreshMapDebounced();
                            } else {
                                renderPrograms();
                            }
                            scheduleAutosave();
                        }
                    });
                }
                if (elements.mapDistanceFilter) {
                    elements.mapDistanceFilter.value = state.map.distanceFilter || "all";
                    elements.mapDistanceFilter.addEventListener("change", event => {
                        state.map.distanceFilter = event.target.value;
                        state.map.applyFiltersGlobally = true;
                        renderPrograms();
                    });
                }
                if (elements.mapZipInput) {
                    elements.mapZipInput.addEventListener("keydown", event => {
                        if (event.key === "Enter") {
                            event.preventDefault();
                            handleHomeZipSubmit();
                        }
                    });
                }
                if (elements.mapHomeSaveButton) {
                    elements.mapHomeSaveButton.addEventListener("click", () => handleHomeZipSubmit());
                }
                if (elements.mapLocateButton) {
                    elements.mapLocateButton.addEventListener("click", handleLocateButton);
                }
                if (elements.detailsNotesInput) {
                    elements.detailsNotesInput.addEventListener("input", handleDetailsNotesInput);
                    elements.detailsNotesInput.addEventListener("blur", handleDetailsNotesBlur);
                }
                if (elements.detailsNotesClearButton) {
                    elements.detailsNotesClearButton.addEventListener("click", event => {
                        event.preventDefault();
                        handleDetailsNotesClear();
                    });
                }
                if (elements.compareGrid) {
                    elements.compareGrid.addEventListener("click", handleCompareGridClick);
                }
                if (elements.compareAddAllButton) {
                    elements.compareAddAllButton.addEventListener("click", addComparisonProgramsToBuilder);
                }
                if (elements.compareExportButton) {
                    elements.compareExportButton.addEventListener("click", () => exportComparisonSnapshot("preview"));
                }
                if (elements.comparePrintButton) {
                    elements.comparePrintButton.addEventListener("click", () => exportComparisonSnapshot("print"));
                }
                overlays.overlay.addEventListener("click", closeDetails);
                closeDetailsButton.addEventListener("click", closeDetails);
                document.addEventListener("keydown", handleKeyboardShortcuts);

                bindPreferencesEvents();

                saveDraftButton.addEventListener("click", () => saveDraft("manual"));
                generateButton.addEventListener("click", () => generateDocument());
                if (elements.detailsCompareNetworkButton) {
                    elements.detailsCompareNetworkButton.addEventListener("click", handleDetailsCompareNetwork);
                }
                elements.detailsAddButton.addEventListener("click", event => {
                    const programId = event.currentTarget.getAttribute("data-program-id") || state.selectedProgramId;
                    if (!programId) return;
                    addToBuilder(programId, "bridge");
                });
                elements.detailsGenerateButton.addEventListener("click", event => {
                    const programId = event.currentTarget.getAttribute("data-program-id");
                    if (!programId) return;
                    generateDocument(state.documentType, programId);
                });

                quickAddCancel.addEventListener("click", hideQuickAdd);
                quickAddConfirm.addEventListener("click", () => {
                    const programId = elements.quickAddProgram.value;
                    const lane = elements.quickAddLane.value;
                    if (programId && lane) {
                        addToBuilder(programId, lane);
                        hideQuickAdd();
                    }
                });

                const initialView = state.view;
                if (initialView === "compare" && state.comparison.programIds.length === 0) {
                    setView("grid");
                } else {
                    setView(initialView);
                }
                if (elements.sortSelect) {
                    elements.sortSelect.value = state.sort;
                }
                applyPreferences("init");

                announce("Programs workspace ready");
                emitProgramEvent("programs:ready", { timestamp: Date.now() });
                emitProgramEvent("programs-docs:ready", { timestamp: Date.now() });
            }

         const programsDocsAPI = {
             setClientContext(context = {}) {
                 return Promise.resolve(setClientContext(context));
             },
             getClientContext() {
                 if (!state.clientContext) {
                     return null;
                 }
                 return {
                     clientId: state.clientContext.clientId,
                     initials: state.clientContext.initials,
                     kipuId: state.clientContext.kipuId || null
                 };
             },
             focusSearch() {
                 if (elements.searchInput) {
                     elements.searchInput.focus();
                 }
             },
             refresh() {
                 renderPrograms();
                 renderBuilder();
             }
         };

         window.CareConnectProgramsDocs = Object.assign(window.CareConnectProgramsDocs || {}, programsDocsAPI);

         window.openDetails = openDetails;
         window.addToBuilder = addToBuilder;
         window.generateDocument = generateDocument;
         window.saveDraft = saveDraft;

            async function bootstrap() {
                try {
                    await ensureProgramsLoaded();
                } catch (error) {
                    console.error("Programs data load failed; using fallback dataset.", error);
                }
                init();
                if (window.CareConnectProgramsDocs) {
                    window.CareConnectProgramsDocs.dataSource = PROGRAMS_DATA_STATUS.source;
                    window.CareConnectProgramsDocs.ready = true;
                }
                window.CareConnectProgramsDocsReady = true;
            }

            bootstrap();
        }());
    </script>
</body>
</html>


