<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programs Data Test - CareConnect Pro</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .status-box {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .status-item {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-label {
            font-weight: bold;
            color: #4a5568;
        }
        .status-value {
            color: #2d3748;
            font-family: monospace;
            background: #edf2f7;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .success {
            color: #22543d;
            background: #c6f6d5;
        }
        .error {
            color: #742a2a;
            background: #fed7d7;
        }
        .warning {
            color: #744210;
            background: #feebc8;
        }
        .programs-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px;
        }
        .program-item {
            padding: 8px;
            margin: 4px 0;
            background: #f7fafc;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .program-name {
            font-weight: bold;
            color: #2d3748;
        }
        .program-details {
            font-size: 14px;
            color: #718096;
            margin-top: 4px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #5a67d8;
        }
        .log-box {
            background: #1a202c;
            color: #68d391;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 2px 0;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #e2e8f0;
        }
        .comparison-table th {
            background: #edf2f7;
            font-weight: bold;
        }
        .check-mark {
            color: #22543d;
            font-weight: bold;
        }
        .x-mark {
            color: #742a2a;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Programs Data Loading Test</h1>
        
        <div class="status-box">
            <h2>Loading Status</h2>
            <div class="status-item">
                <span class="status-label">Programs Loader Script:</span>
                <span class="status-value" id="loaderStatus">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Programs Data (window.programsData):</span>
                <span class="status-value" id="dataStatus">Checking...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Programs Count:</span>
                <span class="status-value" id="programCount">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">Data Source:</span>
                <span class="status-value" id="dataSource">Unknown</span>
            </div>
            <div class="status-item">
                <span class="status-label">LocalStorage Cache:</span>
                <span class="status-value" id="cacheStatus">Checking...</span>
            </div>
        </div>

        <div class="status-box">
            <h2>Data Comparison</h2>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Data Source</th>
                        <th>Status</th>
                        <th>Program Count</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody">
                    <tr>
                        <td>Loading...</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="margin: 20px 0;">
            <button onclick="reloadPrograms()">Reload Programs</button>
            <button onclick="clearCache()">Clear Cache</button>
            <button onclick="showSamplePrograms()">Show Sample Programs</button>
            <button onclick="testModuleLoad()">Test Module Load</button>
        </div>

        <div class="log-box" id="logBox">
            <div class="log-entry">Initializing test...</div>
        </div>

        <div class="programs-list" id="programsList" style="display: none;">
            <h3>Sample Programs (First 10)</h3>
            <div id="programItems"></div>
        </div>
    </div>

    <!-- Load the programs loader -->
    <script src="js/programs-loader.js"></script>
    <script src="js/programs-init.js"></script>

    <script>
        function log(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.color = type === 'error' ? '#fc8181' : type === 'warning' ? '#f6e05e' : '#68d391';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(message);
        }

        function updateStatus() {
            // Check loader status
            const loaderEl = document.getElementById('loaderStatus');
            if (window.loadProgramsData) {
                loaderEl.textContent = 'Loaded ‚úì';
                loaderEl.className = 'status-value success';
            } else {
                loaderEl.textContent = 'Not Found ‚úó';
                loaderEl.className = 'status-value error';
            }

            // Check data status
            const dataEl = document.getElementById('dataStatus');
            const countEl = document.getElementById('programCount');
            
            if (window.programsData && Array.isArray(window.programsData)) {
                dataEl.textContent = 'Loaded ‚úì';
                dataEl.className = 'status-value success';
                countEl.textContent = window.programsData.length;
                countEl.className = window.programsData.length > 100 ? 'status-value success' : 
                                    window.programsData.length > 0 ? 'status-value warning' : 'status-value error';
            } else {
                dataEl.textContent = 'Not Found ‚úó';
                dataEl.className = 'status-value error';
                countEl.textContent = '0';
                countEl.className = 'status-value error';
            }

            // Check cache status
            const cacheEl = document.getElementById('cacheStatus');
            const cached = localStorage.getItem('careconnect_programs');
            if (cached) {
                try {
                    const parsed = JSON.parse(cached);
                    cacheEl.textContent = `Cached (${parsed.length} items) ‚úì`;
                    cacheEl.className = 'status-value success';
                } catch (e) {
                    cacheEl.textContent = 'Invalid Cache ‚úó';
                    cacheEl.className = 'status-value error';
                }
            } else {
                cacheEl.textContent = 'No Cache';
                cacheEl.className = 'status-value warning';
            }

            updateComparison();
        }

        function updateComparison() {
            const tbody = document.getElementById('comparisonBody');
            tbody.innerHTML = '';

            // Check window.programsData
            const programsDataRow = document.createElement('tr');
            programsDataRow.innerHTML = `
                <td>window.programsData</td>
                <td>${window.programsData ? '<span class="check-mark">‚úì Loaded</span>' : '<span class="x-mark">‚úó Missing</span>'}</td>
                <td>${window.programsData ? window.programsData.length : 0}</td>
                <td>${window.programsData && window.programsData.length > 100 ? 'Full v2 dataset' : 
                      window.programsData && window.programsData.length > 0 ? 'Partial data' : 'No data'}</td>
            `;
            tbody.appendChild(programsDataRow);

            // Check localStorage
            const cached = localStorage.getItem('careconnect_programs');
            let cachedCount = 0;
            let cacheValid = false;
            if (cached) {
                try {
                    const parsed = JSON.parse(cached);
                    cachedCount = parsed.length;
                    cacheValid = true;
                } catch (e) {}
            }
            
            const cacheRow = document.createElement('tr');
            cacheRow.innerHTML = `
                <td>localStorage cache</td>
                <td>${cacheValid ? '<span class="check-mark">‚úì Valid</span>' : '<span class="x-mark">‚úó Invalid/Missing</span>'}</td>
                <td>${cachedCount}</td>
                <td>${cachedCount > 100 ? 'Full dataset cached' : cachedCount > 0 ? 'Partial cache' : 'Empty'}</td>
            `;
            tbody.appendChild(cacheRow);

            // Check for legacy fallback
            const legacyRow = document.createElement('tr');
            const hasLegacy = window.LEGACY_PROGRAMS_FALLBACK !== undefined;
            legacyRow.innerHTML = `
                <td>Legacy Fallback</td>
                <td>${hasLegacy ? '<span class="x-mark">‚úó Still Present</span>' : '<span class="check-mark">‚úì Removed</span>'}</td>
                <td>${hasLegacy ? (Array.isArray(window.LEGACY_PROGRAMS_FALLBACK) ? window.LEGACY_PROGRAMS_FALLBACK.length : 'N/A') : '0'}</td>
                <td>${hasLegacy ? 'Should be removed!' : 'Good - not found'}</td>
            `;
            tbody.appendChild(legacyRow);

            // Check aliases
            const aliasRow = document.createElement('tr');
            const hasAliases = window.programs === window.programsData && window.PROGRAMS === window.programsData;
            aliasRow.innerHTML = `
                <td>Aliases (window.programs, PROGRAMS)</td>
                <td>${hasAliases ? '<span class="check-mark">‚úì Set</span>' : '<span class="x-mark">‚úó Missing</span>'}</td>
                <td>-</td>
                <td>${hasAliases ? 'Properly aliased' : 'Aliases not set'}</td>
            `;
            tbody.appendChild(aliasRow);
        }

        async function reloadPrograms() {
            log('Reloading programs...');
            if (window.loadProgramsData) {
                await window.loadProgramsData();
                log('Programs reloaded');
                updateStatus();
            } else {
                log('Loader function not found!', 'error');
            }
        }

        function clearCache() {
            log('Clearing cache...');
            localStorage.removeItem('careconnect_programs');
            localStorage.removeItem('ccpro-transformed-programs-v1');
            log('Cache cleared');
            updateStatus();
        }

        function showSamplePrograms() {
            const listEl = document.getElementById('programsList');
            const itemsEl = document.getElementById('programItems');
            
            if (window.programsData && window.programsData.length > 0) {
                listEl.style.display = 'block';
                const sample = window.programsData.slice(0, 10);
                itemsEl.innerHTML = sample.map(p => `
                    <div class="program-item">
                        <div class="program-name">${p.name || p.title || 'Unnamed'}</div>
                        <div class="program-details">
                            ${p.focus || p.type || 'No focus'} | 
                            ${p.format || 'No format'} | 
                            ${p.state || p.location?.state || 'No state'}
                        </div>
                    </div>
                `).join('');
                log(`Showing ${sample.length} sample programs`);
            } else {
                log('No programs data available', 'error');
            }
        }

        async function testModuleLoad() {
            log('Testing module load behavior...');
            
            // Simulate what the programs-docs-module would do
            if (window.programsData && window.programsData.length > 0) {
                log(`Module would use ${window.programsData.length} programs from main app`, 'info');
            } else {
                log('Module would not find programs from main app!', 'warning');
                log('Module might fall back to legacy data', 'warning');
            }
            
            // Check feature flag
            window.featureFlags = window.featureFlags || {};
            window.featureFlags.programsV2Data = true;
            log(`Feature flag programsV2Data: ${window.featureFlags.programsV2Data}`);
        }

        // Listen for programs loaded event
        window.addEventListener('programs-loaded', function(e) {
            log(`Programs loaded event fired: ${e.detail.count} programs`);
            updateStatus();
        });

        // Initial check
        setTimeout(() => {
            log('Initial status check...');
            updateStatus();
            
            // Determine source
            const sourceEl = document.getElementById('dataSource');
            if (window.programsData) {
                if (window.programsData.length >= 140) {
                    sourceEl.textContent = 'programs.v2.json (Full)';
                    sourceEl.className = 'status-value success';
                } else if (window.programsData.length > 10) {
                    sourceEl.textContent = 'Partial v2 data';
                    sourceEl.className = 'status-value warning';
                } else {
                    sourceEl.textContent = 'Legacy/Fallback';
                    sourceEl.className = 'status-value error';
                }
            }
        }, 1000);
    </script>
</body>
</html>
