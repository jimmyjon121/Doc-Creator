<!DOCTYPE html>
<!-- 
    CareConnect Pro v13.0.0-beta
    Build: Cleaned Beta Release (v13-beta)
    Copyright (c) ClearHive Health LLC
    
    ARCHITECTURE NOTE:
    This file acts as the main Single Page Application (SPA) shell.
    It orchestrates:
      - Navigation & Layout
      - Module Loading (Programs, Dashboard, Clients)
      - Global Event Bus
      - Authentication Guards
    
    Modules are loaded via <script> tags to support offline-first deployment.
-->
<!-- OFFICIAL ACTIVE APP – v13.0.0-beta | ClearHive Health LLC. Programs module: programs-docs-module.html, dataset: programs.v2.json -->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect Pro v13.0.0-beta</title>
    
    <!-- Content Security Policy for enhanced security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https://tile.openstreetmap.org https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://tile.openstreetmap.fr https://a.tile.openstreetmap.fr https://b.tile.openstreetmap.fr https://c.tile.openstreetmap.fr https://server.arcgisonline.com https://services.arcgisonline.com https://*.opentopomap.org https://*.basemaps.cartocdn.com; font-src 'self' data:; connect-src 'self' https://nominatim.openstreetmap.org https://tile.openstreetmap.org https://a.tile.openstreetmap.org https://b.tile.openstreetmap.org https://c.tile.openstreetmap.org https://tile.openstreetmap.fr https://a.tile.openstreetmap.fr https://b.tile.openstreetmap.fr https://c.tile.openstreetmap.fr https://server.arcgisonline.com https://services.arcgisonline.com https://*.opentopomap.org https://*.basemaps.cartocdn.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none';">
    
    <!-- PDF Libraries for document merging -->
    <!-- Libraries loaded locally for HIPAA compliance - no external CDN -->
    <script src="libs/pdf-lib.min.js"></script>
    <script src="libs/jspdf.umd.min.js"></script>
    <script src="libs/html2canvas.min.js"></script>
    
    <!-- GSAP Animation Library for onboarding intro (already loaded at line 139) -->
    
    <link rel="stylesheet" href="css/theme-tokens.css">
    <link rel="stylesheet" href="css/client-profile.css">
    <link rel="stylesheet" href="css/programs-explorer.css">
    <link rel="stylesheet" href="css/app-layout.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="css/first-login.css">
    <link rel="stylesheet" href="css/onboarding.css">
    <style>
        /* SECURITY: Main app visibility controlled by inline styles + JS */
        /* The ccAuth system manages display via enforceAuthUI() */
        
        .acc-kpi__header,
        .acc-card__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .acc-card__header-meta {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .widget-header-actions {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .acc-kpi__info,
        .acc-card__info,
        .metric-info {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            font-size: 10px;
            line-height: 1;
            color: #9ca3af;
            cursor: help;
        }

        .acc-kpi__info:hover,
        .acc-card__info:hover,
        .metric-info:hover {
            background: rgba(148, 163, 184, 0.16);
            color: #e5e7eb;
        }

        .metric-tooltip {
            position: fixed;
            z-index: 9999;
            max-width: 280px;
            padding: 10px 12px;
            border-radius: 10px;
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(30, 41, 59, 0.96));
            color: #e2e8f0;
            font-size: 0.8rem;
            line-height: 1.4;
            border: 1px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 18px 35px rgba(2, 6, 23, 0.45);
            pointer-events: none;
            opacity: 0;
            transform: translateY(4px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            display: none;
        }

        .metric-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .metric-tooltip::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: inherit;
            border-left: inherit;
            border-bottom: inherit;
            transform: rotate(45deg);
            bottom: -6px;
            left: calc(50% - 5px);
        }

        .metric-tooltip.metric-tooltip--below::after {
            bottom: auto;
            top: -6px;
            border-left: none;
            border-bottom: none;
            border-right: inherit;
            border-top: inherit;
        }
    </style>
    
    <!-- Enhanced Features Libraries -->
    <script src="libs/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="libs/select2.min.css">
    <script src="libs/select2.min.js"></script>
    <link rel="stylesheet" href="libs/leaflet.css">
    <!-- NOTE: map-v2-dist CSS removed - it conflicts with programs-docs-module Leaflet map -->
    <script src="libs/leaflet.js"></script>
    <script src="libs/chart.min.js"></script>
    <script src="libs/d3.v7.min.js"></script>
    <script src="libs/gsap.min.js"></script>
    <script src="js/utils/date-helpers.js"></script>
    
    <!-- Programs Data Loader - MUST load before other modules -->
    <script src="js/programs-loader.js"></script>
    <script src="js/programs-init.js"></script>
    
    <!-- Database Management -->
    <script src="indexed-db-manager.js"></script>

    <!-- Task Schema & Services -->
    <script src="configs/task-schema.js"></script>
    
    <!-- Client Management -->
    <script src="client-manager.js"></script>
    <script src="js/task-service.js"></script>
    
    <!-- Demo Data Generator (Development Only) -->
    <script src="js/demo-data.js"></script>
    
    <!-- CM Tracker for Clients Tab -->
    <script src="cm-tracker.js"></script>

    <!-- Client Profile Manager (Modern Modal) -->
    <script src="client-profile-manager.js"></script>
    
    <!-- Outcome Tracking Modal -->
    <script src="outcome-tracking-modal.js"></script>
    
    <!-- Discharged Clients View -->
    <script src="discharged-clients-view.js"></script>
    
    <!-- Extracted Enhancement Widgets (formerly inline) -->
    <!-- See js/widgets/ and js/ui/ for module documentation -->
    <script src="js/widgets/compliance-widget.js"></script>
    <script src="js/ui/document-hub.js"></script>
    <script src="js/ui/global-helpers.js"></script>
    
    <!-- Initialize Client Management System -->
    <script>
        (async function() {
            'use strict';
            
            // Initialize database manager
            window.dbManager = new IndexedDBManager('CareConnectDB', 2);
            
            // Initialize database with stores
            await window.dbManager.init([
                { name: 'clients', keyPath: 'id' },
                { name: 'documents', keyPath: 'id' },
                { name: 'programs', keyPath: 'id' },
                { name: 'settings', keyPath: 'key' }
            ]);
            
            // Initialize client manager
            window.clientManager = new ClientManager(window.dbManager);
            await window.clientManager.initialize();

            // Initialize task service (ensures TaskSchema state is populated)
            if (typeof ClientTaskService !== 'undefined') {
                window.taskService = new ClientTaskService(window.clientManager, window.TaskSchema);
                await window.taskService.initialize();
            }
            
            console.log('✅ Client management system initialized');
            
            // Dispatch event to notify that client manager is ready
            window.dispatchEvent(new CustomEvent('clientManagerReady', { 
                detail: { 
                    clientManager: window.clientManager,
                    taskService: window.taskService
                } 
            }));
        })();
    </script>
    
    <!-- ═══════════════════════════════════════════════════════════════════════════
         BOOTSTRAP & INITIALIZATION BLOCK (~515 lines)
         
         CRITICAL INLINE CODE - DO NOT EXTRACT without careful testing.
         
         This block contains:
           1. Global error handler (prevents white screen on script errors)
           2. dashboardState tracking (fallback vs modern dashboard coordination)
           3. ccAuth security system (session management, UI enforcement)
           4. ccConfig global settings (demo mode, currentUser)
           5. metricHelp registry (tooltip descriptions for KPIs)
           6. metricTooltip system (hover tooltips for metrics)
           7. Debug logging configuration (cc-debug flag)
           8. Dynamic script loading (loadScript with retry)
           9. Script load sequence (core → dashboard → enhanced features)
         
         DEPENDENCIES: None (this runs first)
         DEPENDENTS: All other modules depend on ccAuth, ccConfig, loadScript
         
         EXTRACTION STATUS: Deferred to Phase 3 (requires careful refactoring)
         LAST REVIEWED: December 2025
         ═══════════════════════════════════════════════════════════════════════════ -->
    <script>
        // Global error handler to prevent white screen
        window.addEventListener('error', function(e) {
            const errorMsg = e.error?.message || e.message || '';
            
            // Suppress benign ResizeObserver errors (common in complex layouts)
            if (errorMsg.includes('ResizeObserver loop')) {
                return true; // Suppress this error
            }
            
            console.error('🔥 Global error caught:', errorMsg);
            
            // Prevent white screen by showing error message
            if (e.error && e.error.message) {
                if (errorMsg.includes('is not defined') || errorMsg.includes('is not a constructor')) {
                    console.error('⚠️ Critical script loading error detected');
                    // Don't reload automatically, just log
                }
            }
            return false; // Prevent default error handling
        });

        // Track which dashboard mode is currently active
        window.dashboardState = window.dashboardState || {
            mode: 'loading',
            lastReason: 'bootstrap',
            fallbackInjected: false,
            lastUpdated: Date.now()
        };

        function setDashboardMode(mode, reason = 'unspecified') {
            window.dashboardState = window.dashboardState || {};
            window.dashboardState.mode = mode;
            window.dashboardState.lastReason = reason;
            window.dashboardState.lastUpdated = Date.now();
            if (mode === 'fallback') {
                window.dashboardState.fallbackInjected = true;
            }
        }

        function canUseFallbackDashboard(reason = 'unspecified') {
            const state = window.dashboardState || {};
            if (state.mode === 'modern') {
                console.warn(`Skipping fallback dashboard (${reason}) because modern dashboard is active.`);
                return false;
            }
            return true;
        }
        
        // SECURITY: Authentication guard - ensures app content is hidden until authenticated
        window.ccAuth = {
            isAuthenticated: false,
            
            // Check if user has valid session
            checkSession: function() {
                try {
                    const sessionToken = sessionStorage.getItem('ccSessionToken');
                    const loginTime = sessionStorage.getItem('ccLoginTime');
                    const username = localStorage.getItem('username');
                    
                    // Must have all three for valid session
                    if (!sessionToken || !loginTime || !username) {
                        return false;
                    }
                    
                    // Check session isn't expired (8 hour max)
                    const loginTimestamp = parseInt(loginTime, 10);
                    const now = Date.now();
                    const maxAge = 8 * 60 * 60 * 1000; // 8 hours
                    
                    if (now - loginTimestamp > maxAge) {
                        this.clearSession();
                        return false;
                    }
                    
                    return true;
                } catch (e) {
                    console.error('[Security] Session check failed:', e);
                    return false;
                }
            },
            
            // Create new session on login
            createSession: function(username) {
                const token = crypto.randomUUID ? crypto.randomUUID() : 
                    'cc-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('ccSessionToken', token);
                sessionStorage.setItem('ccLoginTime', Date.now().toString());
                this.isAuthenticated = true;
                return token;
            },
            
            // Clear session on logout
            clearSession: function() {
                sessionStorage.removeItem('ccSessionToken');
                sessionStorage.removeItem('ccLoginTime');
                this.isAuthenticated = false;
            },
            
            // Enforce auth state in UI
            enforceAuthUI: function() {
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');
                
                console.log('[Security] Enforcing auth UI, authenticated:', this.isAuthenticated);
                
                if (this.isAuthenticated) {
                    if (loginScreen) {
                        loginScreen.style.display = 'none';
                        loginScreen.style.visibility = 'hidden';
                    }
                    if (mainApp) {
                        mainApp.style.display = 'block';
                        mainApp.style.visibility = 'visible';
                        console.log('[Security] Main app shown');
                    }
                } else {
                    if (mainApp) {
                        mainApp.style.display = 'none';
                        mainApp.style.visibility = 'hidden';
                    }
                    if (loginScreen) {
                        loginScreen.style.display = '';
                        loginScreen.style.visibility = 'visible';
                    }
                    console.log('[Security] Login screen shown, app hidden');
                }
            }
        };
        
        // Ensure body is always visible once DOM is ready (but app content controlled by auth)
        window.addEventListener('DOMContentLoaded', function() {
            document.body.style.opacity = '1';
            document.body.style.visibility = 'visible';
            document.body.style.display = 'block';
            
            // SECURITY: Check auth state on load
            // If localStorage says logged in but no session token, this is a page reload - trust localStorage
            const hasLocalStorageLogin = localStorage.getItem('isLoggedIn') === 'true' && localStorage.getItem('username');
            
            if (window.ccAuth.checkSession()) {
                // Valid session token exists
                window.ccAuth.isAuthenticated = true;
                console.log('[Security] Valid session found');
            } else if (hasLocalStorageLogin) {
                // No session token but localStorage says logged in - create session (page was reloaded)
                window.ccAuth.createSession(localStorage.getItem('username'));
                console.log('[Security] Restored session from localStorage');
            } else {
                // Not logged in
                window.ccAuth.isAuthenticated = false;
                console.log('[Security] No valid session');
            }
            
            window.ccAuth.enforceAuthUI();
        });
        
        // Aggressive cache busting with random component
        const cacheBust = Date.now() + '-' + Math.random().toString(36).substring(7);
        
        // Global config (demo vs production behavior)
        window.ccConfig = window.ccConfig || {};
        if (typeof window.ccConfig.demoMode === 'undefined') {
            // Default: demo mode on for local development only
            const host = window.location.hostname;
            window.ccConfig.demoMode = (host === 'localhost' || host === '127.0.0.1');
        }

        // Central registry of metric descriptions (admin analytics vs coach dashboards)
        window.metricHelp = {
            // Admin Command Center KPIs
            acc_aftercare_plans: 'Number of aftercare planning documents created in the selected date range.',
            acc_successful_placements: 'Clients whose aftercare outcome is a confirmed program placement or home-with-supports transition.',
            acc_placement_rate: 'Successful placements divided by total aftercare plans in this date range.',
            acc_doc_compliance: 'Percent of required documents completed on or before their due date.',
            acc_discharge_packets: 'Clients whose discharge packet is completed and uploaded during this period.',
            acc_tasks_completed: 'Tasks marked complete during the selected date range.',
            acc_active_census: 'Active clients compared to total bed capacity across all houses.',

            // Admin panels
            acc_doc_panel: 'On-time, late, and overdue documents, grouped by document type using due versus completion dates.',
            acc_packets_panel: 'Completion and upload status for discharge packets and aftercare documents.',
            acc_auth_panel: 'Authorization requests grouped by payer: requests, approvals, denials, approval rate, and average decision time.',
            acc_journey_panel: 'Current census, average length of stay, and discharge destinations for clients.',
            acc_house_occupancy_panel: 'Real-time bed usage and capacity by house, using occupancy data from Houses Manager.',

            // Dashboard metrics (coach tone)
            dash_tracker_overall: 'Big picture of how many key checkboxes are turned on for your houses (admission, clinical, aftercare, docs). Higher = fewer loose ends.',
            dash_tracker_critical: 'Out of the urgent checklist items (48-hour admission tasks, aftercare steps, discharge docs), what percent are done on time.',
            dash_tracker_at_risk: 'Kids who are close to discharge and still missing something important. These are the cases to look at first.',
            dash_tracker_strong: 'Houses where most trackers are green - roughly 80% or more complete.',
            dash_flight_plan: 'Today is to-do list grouped by urgency: red = must act now, purple = discharge prep, yellow = due today, green = coming up soon.',
            dash_journey_radar: 'Counts of clients in each phase (Week 1, Day 14-16, Day 30, 45+ days, discharge pipeline, recently discharged) to show who needs aftercare or discharge work.',
            dash_changes_today: 'Recent milestones and events: new admissions, clients approaching Day 14 aftercare window, and upcoming discharges within 7 days.',
            dash_pipeline: 'Upcoming intakes scheduled within 3 days and discharges planned within the next 14 days. Helps you prepare for transitions.',
            dash_gaps: 'Clients missing critical data: discharge dates, aftercare providers, care team assignments, or parent contact info. Click to see who needs attention.',
            dash_program_spotlight: 'Random program from the database to help you learn about placement options. Click Learn More to see full details in the Programs tab.',
            dash_house_health: 'Compliance scores for each house based on documentation completion, tracker status, and task completion rates. Click a house to filter your Flight Plan.',

            // Client profile metrics
            client_days_in_care: 'How long this client has been in treatment, from admission to today (or to discharge for past clients).',
            client_completion_pct: 'Percent of this client key trackers that are checked off (admission, clinical, aftercare, discharge). Higher = fewer open items before discharge.'
        };

        const metricTooltip = (() => {
            let tooltipEl;

            function ensureTooltipElement() {
                if (tooltipEl) return tooltipEl;
                tooltipEl = document.createElement('div');
                tooltipEl.className = 'metric-tooltip';
                tooltipEl.setAttribute('role', 'tooltip');
                tooltipEl.addEventListener('transitionend', (event) => {
                    if (event.propertyName === 'opacity' && !tooltipEl.classList.contains('visible')) {
                        tooltipEl.style.display = 'none';
                    }
                });
                document.body.appendChild(tooltipEl);
                return tooltipEl;
            }

            function clamp(value, min, max) {
                return Math.max(min, Math.min(value, max));
            }

            function show(text, anchor) {
                if (!text || !anchor) return;
                const el = ensureTooltipElement();
                el.textContent = text;
                el.style.display = 'block';
                el.classList.remove('visible', 'metric-tooltip--below');
                el.dataset.visibleFor = anchor.getAttribute('data-metric') || '';

                // Force layout to measure size with new content
                const anchorRect = anchor.getBoundingClientRect();
                const tooltipRect = el.getBoundingClientRect();

                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const margin = 12;

                let top = anchorRect.top - tooltipRect.height - margin;
                let left = anchorRect.left + (anchorRect.width / 2) - (tooltipRect.width / 2);

                let renderBelow = false;
                if (top < 8) {
                    top = anchorRect.bottom + margin;
                    renderBelow = true;
                }

                left = clamp(left, 8, viewportWidth - tooltipRect.width - 8);
                if (renderBelow && top + tooltipRect.height > viewportHeight - 8) {
                    top = viewportHeight - tooltipRect.height - 8;
                }

                el.style.left = `${Math.round(left)}px`;
                el.style.top = `${Math.round(top)}px`;

                if (renderBelow) {
                    el.classList.add('metric-tooltip--below');
                }

                requestAnimationFrame(() => {
                    el.classList.add('visible');
                });
            }

            function hide(anchor) {
                if (!tooltipEl) return;
                if (anchor && tooltipEl.dataset.visibleFor && anchor.getAttribute('data-metric') !== tooltipEl.dataset.visibleFor) {
                    return;
                }
                tooltipEl.classList.remove('visible');
                tooltipEl.dataset.visibleFor = '';
            }

            return { show, hide };
        })();

        window.attachMetricTooltips = function attachMetricTooltips(root) {
            if (!window.metricHelp) return;
            const scope = root || document;
            scope.querySelectorAll('[data-metric]').forEach((el) => {
                const key = el.getAttribute('data-metric');
                const text = window.metricHelp[key];
                if (!text) return;

                el.removeAttribute('title');
                el.setAttribute('aria-label', text);

                if (el.dataset.metricTooltipBound === 'true') {
                    return;
                }

                const showHandler = () => metricTooltip.show(text, el);
                const hideHandler = () => metricTooltip.hide(el);

                el.addEventListener('mouseenter', showHandler);
                el.addEventListener('mouseleave', hideHandler);
                el.addEventListener('focus', showHandler);
                el.addEventListener('blur', hideHandler);

                el.dataset.metricTooltipBound = 'true';
            });
        };
        
        // Auto-attach tooltips when dashboard widgets render
        if (window.MutationObserver) {
            const tooltipObserver = new MutationObserver(() => {
                window.attachMetricTooltips();
            });
            
            // Wait for dashboard to be ready
            const startObserving = () => {
                const dashboardContainer = document.querySelector('.dashboard-container');
                if (dashboardContainer) {
                    tooltipObserver.observe(dashboardContainer, {
                        childList: true,
                        subtree: true
                    });
                } else {
                    setTimeout(startObserving, 100);
                }
            };
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', startObserving);
            } else {
                startObserving();
            }
        }

        // Restore unified current user context from localStorage on hard refresh
        (function restoreUserContext() {
            try {
                const stored = localStorage.getItem('currentUser');
                if (stored) {
                    window.ccConfig.currentUser = JSON.parse(stored);
                }
            } catch (e) {
                console.warn('[CareConnect] Could not restore currentUser from storage:', e);
            }
        })();

        // Dev helper docs: see DEV-TOOLS.md for reset/test workflows.

        // Debug logging flag (default controlled by ?debug=1 or localStorage `cc-debug`)
        if (typeof window.DEBUG === 'undefined') {
            const params = new URLSearchParams(window.location.search);
            const debugFromQuery = params.get('debug');
            const debugFromStorage = localStorage.getItem('cc-debug');
            window.DEBUG = debugFromQuery === '1' || debugFromStorage === 'true';
        }

        (function configureDebugLogging() {
            const originalLog = console.log.bind(console);
            const originalInfo = console.info ? console.info.bind(console) : originalLog;

            window.setCareConnectDebugLogging = function(enabled) {
                window.DEBUG = Boolean(enabled);
                localStorage.setItem('cc-debug', window.DEBUG ? 'true' : 'false');
            };

            console.log = (...args) => {
                if (window.DEBUG) {
                    originalLog(...args);
                }
            };

            if (console.info) {
                console.info = (...args) => {
                    if (window.DEBUG) {
                        originalInfo(...args);
                    }
                };
            }
        })();

        // One-time cleanup for legacy demo/test localStorage keys
        (function cleanupLegacyDemoKeys() {
            try {
                const legacyPrefixes = ['demo_', 'test_'];
                const legacySubstrings = ['demoClients', 'demoData'];
                const keysToRemove = [];
                
                for (let i = 0; i < localStorage.length; i += 1) {
                    const key = localStorage.key(i);
                    if (!key) continue;
                    if (legacyPrefixes.some(prefix => key.startsWith(prefix)) ||
                        legacySubstrings.some(fragment => key.includes(fragment))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach((key) => localStorage.removeItem(key));
                if (keysToRemove.length > 0) {
                    console.log(`🧹 Removed ${keysToRemove.length} legacy demo keys from localStorage`);
                }
            } catch (error) {
                console.warn('Legacy demo key cleanup skipped:', error);
            }
        })();
        
        // Function to clear all caches and reload
        window.clearCacheAndReload = function() {
            console.log('🧹 Clearing all caches...');
            // Clear IndexedDB
            if ('indexedDB' in window) {
                indexedDB.databases().then(databases => {
                    databases.forEach(db => {
                        indexedDB.deleteDatabase(db.name);
                        console.log('Deleted IndexedDB:', db.name);
                    });
                });
            }
            // Clear localStorage (but preserve login session)
            const sessionKeys = ['isLoggedIn', 'username', 'fullName', 'userRole', 'isMaster', 'loginExpires'];
            const savedSession = {};
            sessionKeys.forEach(key => {
                savedSession[key] = localStorage.getItem(key);
            });
            localStorage.clear();
            // Restore session after clear
            Object.keys(savedSession).forEach(key => {
                if (savedSession[key] !== null) {
                    localStorage.setItem(key, savedSession[key]);
                }
            });
            // Clear service worker cache
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(registration => registration.unregister());
                });
            }
            // Force reload with cache bypass
            window.location.reload(true);
        };
        
        // Function to load script with retry
        function loadScript(src, retries = 3) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${src}?v=${cacheBust}`;
                script.onload = () => {
                    console.log(`✅ Loaded: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    if (retries > 0) {
                        console.warn(`⚠️ Retrying ${src}... (${retries} attempts left)`);
                        setTimeout(() => loadScript(src, retries - 1).then(resolve).catch(reject), 500);
                    } else {
                        console.error(`❌ Failed to load: ${src}`);
                        reject(new Error(`Failed to load ${src}`));
                    }
                };
                document.head.appendChild(script);
            });
        }
        
        // Load core scripts
        const scripts = [
            'morning-review-dashboard.js', // Morning Review Dashboard
            
            // ACTIVE FILES:
            // 'indexed-db-manager.js', // DUPLICATE: Already loaded in <head>
            // 'client-manager.js', // DUPLICATE: Already loaded in <head>
            'tracker-engine.js',
            'tracker-timeline.js',
            'tracker-bulk-update.js',
            'tracker-aftercare-cascade.js',
            'discharge-checklist.js',
            'houses-manager.js',
            'milestones-manager.js',
            'aftercare-manager.js',
            'document-generator.js'
        ];
        
        // Load scripts sequentially to ensure proper order
        Promise.all(scripts.map(src => loadScript(src))).then(() => {
            console.log('✅ All core scripts loaded');
            
            // Load dashboard scripts after core scripts
            const dashboardScripts = [
                'dashboard-manager.js',
                'dashboard-widgets.js'
            ];
            return Promise.all(dashboardScripts.map(src => loadScript(src)));
        }).then(() => {
            console.log('✅ All dashboard scripts loaded');
            
            // Make dashboard manager globally available
            if (typeof dashboardManager !== 'undefined') {
                window.dashboardManager = dashboardManager;
            }
            if (typeof dashboardWidgets !== 'undefined') {
                window.dashboardWidgets = dashboardWidgets;
            }
            
            // Handle IndexedDB version errors - Handled gracefully in initializeEnhancedFeatures
            // window.addEventListener('error', function(event) {
            //    if (event.message && event.message.includes('VersionError')) {
            //        console.error('🔄 IndexedDB version mismatch detected. Please clear cache.');
            //        if (confirm('IndexedDB version mismatch detected. Clear cache and reload?')) {
            //            window.clearCacheAndReload();
            //        }
            //    }
            // });
            
            // Initialize enhanced features now that all scripts are loaded
            return initializeEnhancedFeatures();
        }).catch(error => {
            console.error('❌ Script loading error:', error);
        });
    </script>
    <!-- ═══════════════════════════════════════════════════════════════════════════
         GLOBAL HELPERS BLOCK (~9,616 lines)
         
         ⚠️  LARGE INLINE BLOCK - Extraction planned for Phase 1.3
         
         This block contains multiple systems that ARE actively used:
         
         CONTENTS (approximate line ranges):
         ├── NOTIFICATION SYSTEM (lines 773-828) → js/ui/notification.js
         ├── MODAL SYSTEM (lines 829-1027) → js/ui/modal.js
         ├── NAVIGATION HELPERS (lines 1028-1105) → js/core/navigation.js
         ├── UTILITY HELPERS (lines 1106-1186) → merge into DateHelpers
         ├── CSS STYLES (lines 1187-1410) → css/components.css
         ├── EVENT SYSTEM (lines 1411-1500) → js/core/EventBus.js
         ├── House helpers, tab logic, UI handlers... (lines 1500+)
         └── Client validation (lines 8600+) → js/services/validation.js
         
         USAGE AUDIT (December 2025):
         - window.eventBus: 24 usages across 3 files (ACTIVE)
         - debounce(): 8 usages across 2 files (ACTIVE)
         - daysBetween(): 14 usages - SHOULD migrate to DateHelpers
         - showNotification(): Core UI function (ACTIVE)
         - showModal(): Core UI function (ACTIVE)
         
         EXTRACTION STRATEGY:
         1. Extract small, self-contained sections one at a time
         2. Test after each extraction
         3. Keep window.* exports for compatibility
         4. Target: <300 lines remaining inline by Phase 1 completion
         
         LAST REVIEWED: December 2025
         ═══════════════════════════════════════════════════════════════════════════ -->
    <!-- ═══════════════════════════════════════════════════════════════════════════
         GLOBAL HELPERS - EXTRACTED TO EXTERNAL MODULE
         
         The global helper functions (~630 lines) have been extracted to:
         js/ui/global-helpers.js (loaded at line 183)
         
         Extraction Date: December 7, 2025
         
         Exported functions:
         - window.showNotification(message, type, title, duration)
         - window.closeModal(target) / window.closeAllModals()
         - window.showModal(content, options)
         - Modal CSS styles
         
         See js/ui/global-helpers.js for full documentation.
         ═══════════════════════════════════════════════════════════════════════════ -->
    
    <!-- ═══════════════════════════════════════════════════════════════════════════
         CORE INFRASTRUCTURE (Phase 1 of Master Refactor Plan)
         
         These are foundational modules that other code depends on.
         Load order matters - ServiceRegistry first, then EventBus.
         ═══════════════════════════════════════════════════════════════════════════ -->
    
    <!-- Phase 1.1: ServiceRegistry - Dependency Injection Container -->
    <script src="js/core/ServiceRegistry.js"></script>
    
    <!-- Phase 1.2: EventBus - Pub/Sub Messaging System -->
    <script src="js/core/EventBus.js"></script>
    
    <script>
// ═══════════════════════════════════════════════════════════════════════════
// EVENT SYSTEM INITIALIZATION
//
// NOTE: The core EventBus has been EXTRACTED to: js/core/EventBus.js
// This block sets up subscriptions and manager enhancements.
// See REFACTOR-MASTER-PLAN.md Phase 1.2
// ═══════════════════════════════════════════════════════════════════════════

(function() {
    'use strict';
    
    // Use EventBus from external file, or create inline fallback if not loaded
    if (!window.eventBus) {
        console.warn('[EventBus] External file not loaded, creating inline fallback');
        window.eventBus = {
            listeners: new Map(),
            on(eventName, callback, options = {}) {
                if (!this.listeners.has(eventName)) {
                    this.listeners.set(eventName, new Set());
                }
                const listener = { callback, once: options.once || false, priority: options.priority || 0 };
                this.listeners.get(eventName).add(listener);
                return () => { const l = this.listeners.get(eventName); if (l) l.delete(listener); };
            },
            once(eventName, callback) { return this.on(eventName, callback, { once: true }); },
            emit(eventName, data) {
                const listeners = this.listeners.get(eventName);
                if (!listeners || listeners.size === 0) return;
                Array.from(listeners).sort((a, b) => b.priority - a.priority).forEach(l => {
                    try { l.callback(data); if (l.once) listeners.delete(l); }
                    catch (e) { console.error(`Error in event listener for ${eventName}:`, e); }
                });
                if (eventName !== '*') this.emit('*', { eventName, data });
            },
            off(eventName) { this.listeners.delete(eventName); },
            getListeners(eventName) { return this.listeners.get(eventName) || new Set(); }
        };
    }
    
    // Enhance clientManager with events
    function enhanceClientManager() {
        if (!window.clientManager) return;
        
        const originalUpdateClient = window.clientManager.updateClient;
        window.clientManager.updateClient = async function(clientId, updates) {
            const oldClient = await this.getClient(clientId);
            const result = await originalUpdateClient.call(this, clientId, updates);
            const newClient = await this.getClient(clientId);
            
            // Emit update event
            window.eventBus.emit('client:updated', {
                clientId,
                oldData: oldClient,
                newData: newClient,
                changes: updates
            });
            
            // Check for specific tracker updates
            const trackerFields = Object.keys(updates).filter(key => 
                key.includes('Assessment') || 
                key.includes('Doc') || 
                key.includes('Packet') ||
                key.includes('discharge') ||
                key.includes('aftercare')
            );
            
            if (trackerFields.length > 0) {
                window.eventBus.emit('tracker:updated', {
                    clientId,
                    fields: trackerFields,
                    updates
                });
            }
            
            return result;
        };
        
        const originalCreateClient = window.clientManager.createClient;
        window.clientManager.createClient = async function(clientData) {
            const result = await originalCreateClient.call(this, clientData);
            
            // Emit create event
            window.eventBus.emit('client:created', {
                client: result
            });
            
            return result;
        };
        
        const originalDeleteClient = window.clientManager.deleteClient;
        if (originalDeleteClient) {
            window.clientManager.deleteClient = async function(clientId) {
                const client = await this.getClient(clientId);
                const result = await originalDeleteClient.call(this, clientId);
                
                // Emit delete event
                window.eventBus.emit('client:deleted', {
                    clientId,
                    client
                });
                
                return result;
            };
        }
    }
    
    // Subscribe to events for dashboard updates
    function setupDashboardSubscriptions() {
        // Debounce dashboard refresh
        let refreshTimeout;
        const debouncedRefresh = () => {
            clearTimeout(refreshTimeout);
            refreshTimeout = setTimeout(() => {
                if (window.dashboardManager?.refreshDashboard) {
                    window.dashboardManager.refreshDashboard();
                }
            }, 300); // Wait 300ms before refreshing
        };
        
        // Listen for client updates
        window.eventBus.on('client:updated', (data) => {
            // Invalidate cache
            if (window.dashboardManager?.cache) {
                delete window.dashboardManager.cache.clients;
                delete window.dashboardManager.cache.priorities;
            }
            
            // Refresh dashboard
            debouncedRefresh();
        });
        
        // Listen for tracker updates
        window.eventBus.on('tracker:updated', (data) => {
            
            // Update specific widgets if they exist
            if (window.dashboardWidgets?.widgets) {
                const flightPlan = window.dashboardWidgets.widgets.get('flightPlan');
                if (flightPlan?.refresh) {
                    flightPlan.refresh();
                }
                
                const journeyRadar = window.dashboardWidgets.widgets.get('journeyRadar');
                if (journeyRadar?.refresh) {
                    journeyRadar.refresh();
                }
            }
        });
        
        // Listen for document events
        window.eventBus.on('document:generated', (data) => {
            // Show success notification
            window.showNotification('Document generated and tracker updated', 'success');
            
            // Update relevant widgets
            debouncedRefresh();
        });
        
        // Listen for all events in dev mode
        if (window.featureFlags && typeof window.featureFlags.isEnabled === 'function' && window.featureFlags.isEnabled('devMode')) {
            window.eventBus.on('*', (event) => {
                console.log(`[Event] ${event.eventName}:`, event.data);
            });
        }
    }
    
    // Enhance widget refresh capabilities
    function enhanceWidgetRefresh() {
        if (!window.dashboardWidgets?.widgets) return;
        
        // Add refresh method to all widgets
        window.dashboardWidgets.widgets.forEach((widget, name) => {
            if (!widget.refresh) {
                widget.refresh = function() {
                    const container = this.container;
                    if (container) {
                        // Re-render the widget
                        container.innerHTML = this.render();
                        console.log(`Refreshed widget: ${name}`);
                    }
                };
            }
        });
    }
    
    // Setup cache invalidation
    window.cacheManager = {
        invalidate(key) {
            if (window.dashboardManager?.cache) {
                if (key) {
                    delete window.dashboardManager.cache[key];
                    console.log(`Cache invalidated: ${key}`);
                } else {
                    // Clear all cache
                    Object.keys(window.dashboardManager.cache).forEach(k => {
                        delete window.dashboardManager.cache[k];
                    });
                    console.log('All cache cleared');
                }
            }
        },
        
        invalidateClient(clientId) {
            // Invalidate specific client-related caches
            this.invalidate('clients');
            this.invalidate('priorities');
            this.invalidate(`client-${clientId}`);
        },
        
        invalidateAll() {
            this.invalidate();
        }
    };
    
    // Listen for cache invalidation events
    window.eventBus.on('cache:invalidate', (data) => {
        window.cacheManager.invalidate(data.key);
    });
    
    window.eventBus.on('cache:invalidateClient', (data) => {
        window.cacheManager.invalidateClient(data.clientId);
    });
    
    function ensureDashboardTheme() {
        const dashboardTab = document.getElementById('dashboardTab');
        if (dashboardTab && dashboardTab.classList.contains('active')) {
            document.body.classList.add('dashboard-active');
            document.body.classList.remove('programs-docs-v2-active');
            document.body.style.background = 'white';
            document.body.style.color = '#1a1a1a';
        }
    }
    window.ensureDashboardTheme = ensureDashboardTheme;
    
    // Add global refresh function
    window.refreshDashboard = function(immediate = false) {
        ensureDashboardTheme();
        if (immediate) {
            window.cacheManager.invalidateAll();
            if (typeof initializeDashboard === 'function') {
                initializeDashboard(true);
            }
        } else {
            window.eventBus.emit('dashboard:refresh');
        }
    };

    window.populateDemoClients = async function(count = 50) {
        // In non-demo mode, treat this as a no-op to prevent accidental demo data in production
        if (!window.ccConfig?.demoMode) {
            window.showNotification('Demo data is disabled in this environment.', 'info');
            return;
        }
        
        // Wait for ClientManager to be ready
        let retries = 10;
        while (!window.clientManager && retries > 0) {
            await new Promise(resolve => setTimeout(resolve, 500));
            retries--;
        }
        
        window.pendingDemoClientCount = count;
        
        if (!window.clientManager?.generateDemoClients) {
            window.showNotification('Client manager not ready yet—will retry automatically.', 'warning');
            return;
        }
        
        const confirmed = window.confirm(
            `Populate demo clients?\n\nThis will remove existing demo clients and create ${count} fresh records for testing.`
        );
        if (!confirmed) {
            delete window.pendingDemoClientCount;
            return;
        }
        
        try {
            window.showNotification('🎭 Creating demo clients…', 'info');
            const created = await window.clientManager.generateDemoClients(count);
            window.showNotification(`✅ Added ${created.length} demo clients`, 'success');
            delete window.pendingDemoClientCount;
            
            // Force dashboard refresh
            if (window.dashboardManager) {
                await window.dashboardManager.refreshDashboard();
            }
            
            if (typeof initializeDashboard === 'function') {
                await initializeDashboard(true);
            }
            
            // Also refresh widgets directly
            if (window.dashboardWidgets?.renderAll) {
                await window.dashboardWidgets.renderAll();
            }

            // If the Clients tab is active, refresh the CM Tracker view too
            const clientsTab = document.getElementById('clientsTab');
            if (clientsTab && clientsTab.classList.contains('active')) {
                if (typeof initializeCMTracker === 'function') {
                    await initializeCMTracker();
                } else if (typeof initializeClientTracker === 'function') {
                    initializeClientTracker();
                }
            }
        } catch (error) {
            window.showNotification('Failed to generate demo clients: ' + error.message, 'error');
        }
    };
    
    // Listen for refresh requests
    let globalRefreshTimeout;
    window.eventBus.on('dashboard:refresh', () => {
        clearTimeout(globalRefreshTimeout);
        globalRefreshTimeout = setTimeout(() => {
            window.cacheManager.invalidateAll();
            if (typeof initializeDashboard === 'function') {
                initializeDashboard(true);
            }
        }, 300);
    });
    
    // Wait for dependencies and initialize
    function initialize() {
        enhanceClientManager();
        setupDashboardSubscriptions();
        enhanceWidgetRefresh();
        
        console.log('✅ Event system initialized');
    }
    
    // Check if dependencies are loaded
    if (window.clientManager && window.dashboardManager) {
        initialize();
    } else {
        // Wait for dependencies
        const checkInterval = setInterval(() => {
            if (window.clientManager && window.dashboardManager) {
                clearInterval(checkInterval);
                initialize();
            }
        }, 100);
        
        // Timeout after 10 seconds
        setTimeout(() => {
            clearInterval(checkInterval);
            console.warn('Event system: Some dependencies not loaded');
            initialize(); // Try anyway
        }, 10000);
    }
    
    // Expose event system info
    window.eventSystemInfo = {
        getEventCount() {
            let count = 0;
            window.eventBus.listeners.forEach(listeners => {
                count += listeners.size;
            });
            return count;
        },
        
        getEvents() {
            return Array.from(window.eventBus.listeners.keys());
        },
        
        debugEvent(eventName) {
            const listeners = window.eventBus.getListeners(eventName);
            console.log(`Event "${eventName}" has ${listeners.size} listeners:`, listeners);
        }
    };
    
})();





// Enhancement: bugfixes.js
// Bugfixes for CareConnect Pro - ES6+ Modernized

console.log('🔧 Bugfixes loaded');

// Fix for missing initializeEnhancedFeatures function
window.initializeEnhancedFeatures ??= function initializeEnhancedFeatures() {
    if (window.__enhancedFeaturesPromise) {
        return window.__enhancedFeaturesPromise;
    }
    
    window.__enhancedFeaturesPromise = (async () => {
        console.log('🚀 Initializing enhanced features...');
        try {
            // Feature flags
            if (typeof FeatureFlagManager !== 'undefined' && !window.featureFlags) {
                window.featureFlags = new FeatureFlagManager();
                console.log('✅ Feature flags initialized');
            }
            
            // Performance monitor
            if (typeof PerformanceMonitor !== 'undefined' && !window.performanceMonitor) {
                window.performanceMonitor = new PerformanceMonitor();
            }
            
            // IndexedDB manager
            if (typeof IndexedDBManager !== 'undefined' && !window.dbManager) {
                const dbManager = new IndexedDBManager();
                try {
                    await dbManager.init();
                } catch (error) {
                    if (error?.name === 'VersionError' && typeof clearIndexedDB === 'function') {
                        console.warn('Database version mismatch, clearing IndexedDB...');
                        await clearIndexedDB();
                        await dbManager.init();
                    } else {
                        throw error;
                    }
                }
                window.dbManager = dbManager;
                console.log('✅ IndexedDB Manager initialized');
            }
            
            if (!window.dbManager) {
                throw new Error('IndexedDB Manager not available');
            }
            
            // Client manager
            if (typeof ClientManager !== 'undefined' && !window.clientManager) {
                window.clientManager = new ClientManager(window.dbManager);
                if (typeof window.clientManager.initialize === 'function') {
                    await window.clientManager.initialize();
                }
                console.log('✅ ClientManager initialized');
            }
            
            // Houses manager
            if (typeof HousesManager !== 'undefined' && !window.housesManager) {
                const housesManager = new HousesManager(window.dbManager);
                if (typeof housesManager.initialize === 'function') {
                    await housesManager.initialize();
                }
                window.housesManager = housesManager;
            }
            
            // Milestones manager
            if (typeof MilestonesManager !== 'undefined' && !window.milestonesManager) {
                const milestonesManager = new MilestonesManager(window.dbManager);
                if (typeof milestonesManager.initialize === 'function') {
                    await milestonesManager.initialize();
                }
                window.milestonesManager = milestonesManager;
            }
            
            // Aftercare manager
            if (typeof AftercareManager !== 'undefined' && !window.aftercareManager) {
                const aftercareManager = new AftercareManager(window.dbManager);
                if (typeof aftercareManager.initialize === 'function') {
                    await aftercareManager.initialize();
                }
                window.aftercareManager = aftercareManager;
            }
            
            // Dashboard manager
            if (typeof DashboardManager !== 'undefined' && !window.dashboardManager) {
                window.dashboardManager = new DashboardManager();
                if (typeof window.dashboardManager.initialize === 'function') {
                    await window.dashboardManager.initialize();
                }
            }
            
            console.log('✅ Enhanced features initialized');
        } catch (error) {
            console.error('❌ Failed to initialize enhanced features:', error);
            throw error;
        }
    })();
    
    return window.__enhancedFeaturesPromise;
};

// Fix for database initialization issues
document.addEventListener('DOMContentLoaded', () => {
    // Ensure programs are loaded (use programsData as the canonical source)
    if (!window.programsData?.length) {
        console.warn('⚠️ Programs not loaded, attempting to initialize...');
        
        // Check again after a delay
        setTimeout(() => {
            if (!window.programsData?.length) {
                console.error('❌ Programs still not loaded - check main HTML file');
            } else {
                // Provide legacy alias for compatibility
                window.programs = window.programsData;
                console.log('✅ Programs loaded:', window.programsData.length, 'programs');
            }
        }, 1000);
    } else {
        window.programs = window.programsData; // maintain legacy alias
        console.log('✅ Programs already loaded:', window.programsData.length, 'programs');
    }
    
    // Fix for dashboard not showing
    const dashboardTab = document.getElementById('dashboardTab');
    if (dashboardTab?.style.display === 'none') {
        console.log('🔧 Fixing hidden dashboard tab');
        dashboardTab.style.display = '';
    }
});

// Fix for Chrome extension file:// protocol issues
if (window.location.protocol === 'file:') {
    // Disable service worker registration for file protocol
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register = () => {
            console.log('Service Worker registration disabled for file:// protocol');
            return Promise.reject(new Error('Service Worker not supported on file:// protocol'));
        };
    }
}

// Login screen visibility is now managed entirely by login-robust.js
// Removed conflicting ensureLoginScreenVisible function to prevent conflicts

console.log('✅ Bugfixes applied');

// Enhancement: features.js

// Custom Features - Add your custom JavaScript here

// Example: Add a custom keyboard shortcut
/*
document.addEventListener('keydown', function(e) {
    // Ctrl+Shift+S to quick save
    if (e.ctrlKey && e.shiftKey && e.key === 'S') {
        e.preventDefault();
        console.log('Quick save triggered!');
        // Add your save logic here
    }
});
*/

// Example: Add custom logging
console.log('CareConnect Pro v13.0.0-beta - ClearHive Health LLC');


// Enhancement: coach-profiles.js
// Enhanced Coach Profile System for CareConnect Pro - ES6+ Modernized
// Links user accounts to coach profiles with caseload management

(() => {
    'use strict';
    
    console.log('👥 Coach Profile Enhancement loaded');
    
    // Coach profile storage key
    const COACH_PROFILES_KEY = 'careconnect_coach_profiles';
    
    // Coach profile management
    const CoachProfiles = {
        // Get all coach profiles
        getAll() {
            const stored = localStorage.getItem(COACH_PROFILES_KEY);
            return stored ? JSON.parse(stored) : {};
        },
        
        // Save coach profiles
        saveAll(profiles) {
            localStorage.setItem(COACH_PROFILES_KEY, JSON.stringify(profiles));
        },
        
        // Create or update coach profile
        update(username, profileData) {
            const profiles = this.getAll();
            profiles[username] = {
                ...profiles[username],
                ...profileData,
                lastUpdated: new Date().toISOString()
            };
            this.saveAll(profiles);
            return profiles[username];
        },
        
        // Get coach profile for username
        get(username) {
            const profiles = this.getAll();
            return profiles[username] || null;
        }
    };
    
    // Generate initials from name
    const generateInitials = (name, max = 2) => {
        if (!name) return '';
        
        const parts = name.trim().split(/\s+/);
        return parts
            .map(part => part[0]?.toUpperCase() || '')
            .filter(Boolean)
            .slice(0, max)
            .join('') || name.substring(0, 2).toUpperCase();
    };
    
    // Enhanced getCurrentCoach that uses actual user data
    window.getEnhancedCurrentCoach = () => {
        const username = localStorage.getItem('username');
        const fullName = localStorage.getItem('fullName');
        const userRole = localStorage.getItem('userRole') || 'coach';
        const isMaster = localStorage.getItem('isMaster') === 'true';
        
        // Get stored profile
        let profile = CoachProfiles.get(username);
        
        // If no profile exists, create default from session data
        if (!profile && username) {
            profile = CoachProfiles.update(username, {
                username,
                fullName: fullName || username,
                initials: generateInitials(fullName || username),
                role: userRole,
                isAdmin: userRole === 'admin' || isMaster,
                department: '',
                phoneExtension: '',
                specializations: [],
                maxCaseload: 12,
                currentCaseload: 0
            });
        }
        
        return profile || {
            username: 'guest',
            fullName: 'Guest User',
            initials: 'GU',
            role: 'viewer',
            isAdmin: false
        };
    };
    
    // Enhanced profile setup dialog
    window.showCoachProfileSetup = (isFirstTime = false) => {
        const currentProfile = window.getEnhancedCurrentCoach();
        
        const dialogHtml = `
            <div class="modal-overlay" id="coachProfileModal">
                <div class="modal-content" style="max-width: 500px;">
                    <h2 style="margin-bottom: 20px;">
                        ${isFirstTime ? '👋 Complete Your Coach Profile' : '⚙️ Update Coach Profile'}
                    </h2>
                    
                    ${isFirstTime ? `
                        <p style="color: #666; margin-bottom: 20px;">
                            Let's set up your coach profile to personalize your experience and manage your caseload effectively.
                        </p>
                    ` : ''}
                    
                    <form id="coachProfileForm">
                        <div class="form-group">
                            <label>Full Name <span class="required">*</span></label>
                            <input type="text" id="profileFullName" value="${currentProfile.fullName}" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Coach Initials <span class="required">*</span></label>
                            <input type="text" id="profileInitials" value="${currentProfile.initials}" maxlength="3" required 
                                style="text-transform: uppercase;" placeholder="e.g., JD">
                            <small>Used to identify your clients in the system</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Department</label>
                            <select id="profileDepartment">
                                <option value="">Select Department</option>
                                <option value="clinical" ${currentProfile.department === 'clinical' ? 'selected' : ''}>Clinical</option>
                                <option value="residential" ${currentProfile.department === 'residential' ? 'selected' : ''}>Residential</option>
                                <option value="education" ${currentProfile.department === 'education' ? 'selected' : ''}>Education</option>
                                <option value="admin" ${currentProfile.department === 'admin' ? 'selected' : ''}>Administration</option>
                                <option value="support" ${currentProfile.department === 'support' ? 'selected' : ''}>Support Services</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Extension</label>
                            <input type="text" id="profileExtension" value="${currentProfile.phoneExtension || ''}" 
                                placeholder="e.g., 1234" maxlength="10">
                        </div>
                        
                        <div class="form-group">
                            <label>Role</label>
                            <select id="profileRole">
                                <option value="coach" ${currentProfile.role === 'coach' ? 'selected' : ''}>Coach</option>
                                <option value="supervisor" ${currentProfile.role === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                                <option value="admin" ${currentProfile.role === 'admin' ? 'selected' : ''}>Administrator</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Max Caseload</label>
                            <input type="number" id="profileMaxCaseload" value="${currentProfile.maxCaseload || 12}" 
                                min="1" max="50" required>
                            <small>Maximum number of clients you can manage</small>
                        </div>
                        
                        <div class="button-group" style="margin-top: 30px;">
                            <button type="submit" class="primary-button" style="flex: 1;">
                                ${isFirstTime ? 'Create Profile' : 'Update Profile'}
                            </button>
                            ${!isFirstTime ? `
                                <button type="button" onclick="closeCoachProfileModal()" class="secondary-button">
                                    Cancel
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Add dialog to page
        const existingModal = document.getElementById('coachProfileModal');
        existingModal?.remove();
        
        document.body.insertAdjacentHTML('beforeend', dialogHtml);
        
        // Handle form submission
        document.getElementById('coachProfileForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const username = localStorage.getItem('username');
            const profileData = {
                username,
                fullName: document.getElementById('profileFullName').value,
                initials: document.getElementById('profileInitials').value.toUpperCase(),
                role: document.getElementById('profileRole').value,
                department: document.getElementById('profileDepartment').value,
                phoneExtension: document.getElementById('profileExtension').value,
                maxCaseload: parseInt(document.getElementById('profileMaxCaseload').value),
                isAdmin: document.getElementById('profileRole').value === 'admin'
            };
            
            // Update profile
            CoachProfiles.update(username, profileData);
            
            // Update session storage
            localStorage.setItem('fullName', profileData.fullName);
            localStorage.setItem('userRole', profileData.role);
            
            // Show success message
            showNotification('Profile updated successfully!', 'success');
            
            // Close modal
            closeCoachProfileModal();
            
            // Refresh any UI elements that display coach info
            const coachDisplay = document.querySelector('.coach-info, .user-info');
            if (coachDisplay) {
                coachDisplay.textContent = `${profileData.fullName} (${profileData.initials})`;
            }
            
            // If first time, trigger any onboarding completion
            if (isFirstTime && window.onCoachProfileComplete) {
                window.onCoachProfileComplete();
            }
        };
    };
    
    // Close modal function
    window.closeCoachProfileModal = () => {
        const modal = document.getElementById('coachProfileModal');
        modal?.remove();
    };
    
    // Override getCurrentCoach if it exists
    if (typeof window.getCurrentCoach === 'function') {
        window._originalGetCurrentCoach = window.getCurrentCoach;
    }
    window.getCurrentCoach = window.getEnhancedCurrentCoach;
    
    // Add coach indicator to clients
    const enhanceClientDisplay = () => {
        const clients = document.querySelectorAll('.client-row, .client-card, .client-item');
        const currentCoach = window.getEnhancedCurrentCoach();
        
        clients.forEach(client => {
            const initials = client.dataset.clientInitials || client.textContent.match(/^([A-Z]{2,3})\s-/)?.[1];
            
            if (initials === currentCoach.initials) {
                client.classList.add('my-client');
                
                if (!client.querySelector('.coach-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'coach-indicator';
                    indicator.innerHTML = '👤';
                    indicator.title = 'Your Client';
                    client.appendChild(indicator);
                }
            }
        });
    };
    
    // Add profile button to UI
    const addProfileButton = () => {
        const userInfo = document.querySelector('.user-info, .header-right, .nav-right');
        if (!userInfo || document.getElementById('profileSettingsBtn')) return;
        
        const profileBtn = document.createElement('button');
        profileBtn.id = 'profileSettingsBtn';
        profileBtn.className = 'profile-settings-btn';
        profileBtn.innerHTML = '👤 Profile';
        profileBtn.onclick = () => window.showCoachProfileSetup(false);
        userInfo.appendChild(profileBtn);
    };
    
    // Show notification
    const showNotification = (message, type = 'info') => {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    };
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        // Add profile button
        setTimeout(addProfileButton, 1000);
        
        // Enhance client displays
        setTimeout(enhanceClientDisplay, 1500);
        
        // Check if first-time setup needed - but only when explicitly triggered
        const username = localStorage.getItem('username');
        if (username && !CoachProfiles.get(username)) {
            console.log('Coach profile not found for:', username, '- will create when requested');
        }
    });
    
    // Re-enhance on dynamic content changes
    if (window.MutationObserver) {
        const observer = new MutationObserver(() => {
            enhanceClientDisplay();
        });
        
        const waitForBody = () => {
            const target = document.body;
            if (!target) {
                setTimeout(waitForBody, 50);
                return;
            }
            observer.observe(target, {
                childList: true,
                subtree: true
            });
        };

        waitForBody();
    }
    
    // Export functions for external use
    window.CoachProfiles = {
        get: username => CoachProfiles.get(username),
        update: (username, data) => CoachProfiles.update(username, data),
        getAll: () => CoachProfiles.getAll(),
        showSetup: (isFirstTime) => window.showCoachProfileSetup(isFirstTime)
    };
    
    console.log('✅ Coach Profile Enhancement ready');
})();

// Enhancement: login-fix.js
// Fix for login screen not showing

console.log('🔐 Login fix applied');

// Early proxy: ensure handleLogin always exists and queues attempts until ready
// Account registry and account creation helpers
(function() {
    const STORAGE_KEY = 'ccpro-user-accounts-v1';
    const DEFAULT_USERS = [
        { username: 'MasterAdmin', password: 'FFA@dm1n2025!', role: 'admin', fullName: 'Master Administrator', isOwner: true },
        { username: 'LegacyDev', password: 'FFA121', role: 'admin', fullName: 'Legacy Developer', isOwner: true },
        { username: 'Doc232', password: 'FFA121', role: 'admin', fullName: 'Document Creator' }
    ];
    let memoryFallback = [];

    function normalizeAccount(raw) {
        if (!raw || typeof raw !== 'object') {
            return null;
        }
        const username = typeof raw.username === 'string' ? raw.username.trim() : '';
        const password = typeof raw.password === 'string' ? raw.password : '';
        if (!username || !password) {
            return null;
        }
        const role = typeof raw.role === 'string' && raw.role.toLowerCase() === 'admin' ? 'admin' : 'user';
        const fullName = typeof raw.fullName === 'string' && raw.fullName.trim() ? raw.fullName.trim() : username;
        return { username, password, role, fullName };
    }

    function mergeDefaults(accounts) {
        const list = Array.isArray(accounts) ? accounts.slice() : [];
        DEFAULT_USERS.forEach(defaultUser => {
            const exists = list.some(acc => acc.username.toLowerCase() === defaultUser.username.toLowerCase());
            if (!exists) {
                list.push({ ...defaultUser });
            }
        });
        return list;
    }

    function loadAccounts() {
        let parsed = [];
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const raw = JSON.parse(stored);
                if (Array.isArray(raw)) {
                    parsed = raw.map(normalizeAccount).filter(Boolean);
                }
            }
        } catch (error) {
            console.warn('Unable to load stored accounts, falling back to memory copy', error);
            parsed = memoryFallback.slice();
        }
        if (!parsed.length && memoryFallback.length) {
            parsed = memoryFallback.slice();
        }
        parsed = mergeDefaults(parsed);
        memoryFallback = parsed.slice();
        return parsed;
    }

    function saveAccounts(accounts) {
        const normalized = Array.isArray(accounts) ? accounts.map(normalizeAccount).filter(Boolean) : [];
        memoryFallback = normalized.slice();
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
        } catch (error) {
            console.warn('Unable to persist accounts, using in-memory fallback only', error);
        }
    }

    function addAccount(account) {
        const normalized = normalizeAccount(account);
        if (!normalized) {
            throw new Error('Invalid account details. Please try again.');
        }
        const accounts = loadAccounts();
        const exists = accounts.some(acc => acc.username.toLowerCase() === normalized.username.toLowerCase());
        if (exists) {
            throw new Error('Username already exists. Please choose a different one.');
        }
        accounts.push(normalized);
        saveAccounts(accounts);
        return normalized;
    }

    function getInitials(nameOrUsername) {
        const source = (nameOrUsername || '').trim();
        if (!source) {
            return 'U';
        }
        const parts = source.split(/\s+/).filter(Boolean);
        if (!parts.length) {
            return source.slice(0, 2).toUpperCase();
        }
        const initials = parts.slice(0, 2).map(part => part.charAt(0).toUpperCase()).join('');
        return initials || source.slice(0, 2).toUpperCase();
    }

    function updateAccountRole(username, newRole) {
        const accounts = loadAccounts();
        const targetIndex = accounts.findIndex(acc => acc.username.toLowerCase() === username.toLowerCase());
        if (targetIndex === -1) {
            throw new Error(`User "${username}" not found.`);
        }
        accounts[targetIndex].role = newRole;
        saveAccounts(accounts);
        return accounts[targetIndex];
    }

    function isCurrentUserAdmin() {
        const currentRole = localStorage.getItem('userRole');
        return currentRole === 'admin';
    }

    function getAllUsers() {
        return loadAccounts().map(acc => ({
            username: acc.username,
            fullName: acc.fullName,
            role: acc.role,
            isOwner: acc.isOwner || false
        }));
    }

    window.ccAccountRegistry = {
        load: loadAccounts,
        save: saveAccounts,
        add: addAccount,
        updateRole: updateAccountRole,
        isAdmin: isCurrentUserAdmin,
        getAllUsers: getAllUsers,
        storageKey: STORAGE_KEY,
        getInitials
    };

    // User Management Panel for Admins
    window.showUserManagement = function() {
        if (!isCurrentUserAdmin()) {
            alert('Access denied. Only administrators can manage users.');
            return;
        }

        const users = getAllUsers();
        const currentUser = localStorage.getItem('username');
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'modal-overlay user-mgmt-modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); color: white; padding: 24px 28px; margin: -30px -30px 20px -30px; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; font-size: 22px; font-weight: 600;">👥 User Management</h2>
                    <button class="btn-close" onclick="this.closest('.modal-overlay').remove()" style="color: white; opacity: 0.8;">×</button>
                </div>
                
                <div class="user-mgmt-content" style="padding: 0 20px 20px;">
                    <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">Manage user accounts and admin access to the Command Center.</p>
                    
                    <div class="user-list" style="display: flex; flex-direction: column; gap: 12px;">
                        ${users.map(u => {
                            const isSelf = u.username.toLowerCase() === currentUser?.toLowerCase();
                            const isAdmin = u.role === 'admin';
                            const canModify = !u.isOwner && !isSelf;
                            
                            return `
                                <div class="user-card" style="
                                    background: ${isAdmin ? 'rgba(59, 130, 246, 0.05)' : 'rgba(255, 255, 255, 0.95)'};
                                    border: 2px solid ${isAdmin ? 'rgba(59, 130, 246, 0.3)' : 'rgba(229, 231, 235, 0.8)'};
                                    border-radius: 10px;
                                    padding: 16px 20px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: space-between;
                                    transition: all 0.2s ease;
                                ">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
                                            <span style="font-size: 20px;">${isAdmin ? '👑' : '👤'}</span>
                                            <strong style="font-size: 16px; color: #1f2937;">${u.username}</strong>
                                            ${u.isOwner ? '<span style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 6px;">OWNER</span>' : ''}
                                            ${isSelf ? '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 6px;">YOU</span>' : ''}
                                        </div>
                                        <div style="font-size: 13px; color: #6b7280;">${u.fullName}</div>
                                        <div style="font-size: 12px; color: ${isAdmin ? '#2563eb' : '#9ca3af'}; margin-top: 4px; font-weight: 600;">
                                            ${isAdmin ? '✓ Admin Access' : 'Standard User'}
                                        </div>
                                    </div>
                                    ${canModify ? `
                                        <button 
                                            onclick="toggleUserRole('${u.username}')" 
                                            class="btn-toggle-role"
                                            style="
                                                background: ${isAdmin ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : 'linear-gradient(135deg, #10b981 0%, #059669 100%)'};
                                                color: white;
                                                border: none;
                                                padding: 8px 16px;
                                                border-radius: 6px;
                                                font-size: 13px;
                                                font-weight: 600;
                                                cursor: pointer;
                                                transition: all 0.2s ease;
                                                white-space: nowrap;
                                            "
                                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                                            onmouseout="this.style.transform=''; this.style.boxShadow='';"
                                        >
                                            ${isAdmin ? '↓ Revoke Admin' : '↑ Grant Admin'}
                                        </button>
                                    ` : `
                                        <span style="color: #9ca3af; font-size: 12px; font-style: italic;">
                                            ${u.isOwner ? 'Protected' : 'Current User'}
                                        </span>
                                    `}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button 
                            onclick="this.closest('.modal-overlay').remove()" 
                            style="
                                width: 100%;
                                background: #f3f4f6;
                                color: #374151;
                                border: none;
                                padding: 10px;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            "
                            onmouseover="this.style.background='#e5e7eb';"
                            onmouseout="this.style.background='#f3f4f6';"
                        >
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add toggle function to window
        window.toggleUserRole = function(username) {
            const users = getAllUsers();
            const targetUser = users.find(u => u.username.toLowerCase() === username.toLowerCase());
            
            if (!targetUser) return;
            
            const newRole = targetUser.role === 'admin' ? 'user' : 'admin';
            
            try {
                updateAccountRole(username, newRole);
                // Refresh the modal
                modal.remove();
                window.showUserManagement();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        };
    };

    window.showAccountCreation = function() {
        try {
            const usernameInput = prompt('Choose a username (3-20 characters, letters/numbers/._- only):');
            if (!usernameInput) {
                alert('Account creation cancelled.');
                return;
            }
            const username = usernameInput.trim();
            if (!/^[A-Za-z0-9._-]{3,20}$/.test(username)) {
                alert('Username must be 3-20 characters and contain only letters, numbers, periods, underscores, or hyphens.');
                return;
            }

            const passwordInput = prompt('Choose a password (minimum 6 characters):');
            if (!passwordInput) {
                alert('Account creation cancelled.');
                return;
            }
            const password = passwordInput.trim();
            if (password.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }

            const fullNameInput = prompt('Enter a display name for this user (optional):', username);
            const roleInput = prompt('Enter role for this user (admin/user). Leave blank for standard user:', 'user');
            const role = roleInput && roleInput.trim().toLowerCase() === 'admin' ? 'admin' : 'user';

            const account = window.ccAccountRegistry.add({
                username,
                password,
                fullName: fullNameInput && fullNameInput.trim() ? fullNameInput.trim() : username,
                role
            });

            alert(`Account created for ${account.username}. You can now sign in with these credentials.`);
        } catch (error) {
            console.error('Failed to create account', error);
            alert(error && error.message ? error.message : 'Failed to create account. Please try again.');
        }
    };

    // Ensure defaults are present in storage
    saveAccounts(loadAccounts());
})();

// Define handleLogin function if it doesn't exist
// Run immediately, not waiting for DOMContentLoaded
(function() {
    const existing = typeof window.handleLogin === 'function' ? window.handleLogin : null;
    const isProxy = Boolean(existing && existing.__ccHandleLoginProxy);

    if (existing && !isProxy) {
        console.log('✅ handleLogin already defined');
        return;
    }

    console.log('🔐 Creating handleLogin function');

    const queue = isProxy && Array.isArray(existing.__queue) ? existing.__queue : [];

    const realHandleLogin = async function(eventOrUsername, password) {
        try {
            let username, pwd;
            
            // Handle both event object and direct username/password
            if (eventOrUsername && typeof eventOrUsername === 'object' && eventOrUsername.preventDefault) {
                // Event object passed
                eventOrUsername.preventDefault();
                const form = eventOrUsername.target || eventOrUsername.currentTarget;
                const usernameInput = form.querySelector('input[type="text"], input[name="username"], #loginUsername');
                const passwordInput = form.querySelector('input[type="password"], input[name="password"], #loginPassword');
                
                if (!usernameInput || !passwordInput) {
                    // Try global selectors as fallback
                    username = document.querySelector('#loginUsername, input[type="text"]')?.value || '';
                    pwd = document.querySelector('#loginPassword, input[type="password"]')?.value || '';
                } else {
                    username = usernameInput.value.trim();
                    pwd = passwordInput.value;
                }
            } else {
                // Direct username/password passed
                username = String(eventOrUsername || '').trim();
                pwd = String(password || '');
            }
            
            // Clear any previous error
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            
            // Validate inputs
            if (!username || !pwd) {
                const errorMsg = 'Please enter both username and password';
                if (errorDiv) {
                    errorDiv.textContent = errorMsg;
                    errorDiv.style.display = 'block';
                } else {
                    alert(errorMsg);
                }
                return false;
            }
            
            // Validate credentials
            const registry = window.ccAccountRegistry;
            const accounts = registry ? registry.load() : [];
            const normalizedUsername = username.toLowerCase();
            const account = accounts.find(acc => acc.username.toLowerCase() === normalizedUsername);

            if (!account || account.password !== pwd) {
                const errorMsg = 'Invalid username or password';
                if (errorDiv) {
                    errorDiv.textContent = errorMsg;
                    errorDiv.style.display = 'block';
                } else {
                    alert(errorMsg);
                }
                return false;
            }

            const fullName = account.fullName || account.username;
            const initials = registry && typeof registry.getInitials === 'function'
                ? registry.getInitials(fullName)
                : (fullName || account.username).slice(0, 2).toUpperCase();

            // SECURITY: Create authenticated session
            if (window.ccAuth) {
                window.ccAuth.createSession(account.username);
            }
            
            // Successful login - store user data
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('username', account.username);
            localStorage.setItem('userRole', account.role || 'user');
            localStorage.setItem('fullName', fullName);
            localStorage.setItem('userInitials', initials);
            localStorage.setItem('manualLogin', 'true');
            
            console.log('✅ Login successful:', account.username);
            
            // SECURITY: Use auth system to show/hide UI
            if (window.ccAuth) {
                window.ccAuth.isAuthenticated = true;
                window.ccAuth.enforceAuthUI();
            } else {
                // Fallback if ccAuth not available
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');
                
                if (loginScreen) {
                    loginScreen.style.display = 'none';
                    loginScreen.style.visibility = 'hidden';
                }
                
                if (mainApp) {
                    mainApp.style.display = 'block';
                    mainApp.style.visibility = 'visible';
                }
            }
            
            // Update user profile button if it exists
            const userProfileBtn = document.getElementById('userProfileBtn');
            if (userProfileBtn) {
                const usernameDisplay = userProfileBtn.querySelector('.username-display');
                if (usernameDisplay) {
                    usernameDisplay.textContent = account.username;
                }
            }

            const displayFullName = document.getElementById('displayFullName');
            if (displayFullName) {
                displayFullName.textContent = fullName;
            }

            const displayUsername = document.getElementById('displayUsername');
            if (displayUsername) {
                displayUsername.textContent = `@${account.username}`;
            }

            const userInitials = document.getElementById('userInitials');
            if (userInitials) {
                userInitials.textContent = initials;
            }

            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.textContent = initials;
            }

            // Show/hide admin elements based on role
            const isAdmin = account.role === 'admin';
            const adminElements = document.querySelectorAll('[data-admin-only="true"]');
            adminElements.forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });
            
            if (isAdmin) {
                console.log('👑 Admin access granted - Admin Command Center available');
            }
            
            return true;
        } catch (error) {
            console.error('❌ Login error:', error);
            const errorDiv = document.getElementById('loginError');
            const errorMsg = 'An error occurred during login. Please try again.';
            if (errorDiv) {
                errorDiv.textContent = errorMsg;
                errorDiv.style.display = 'block';
            } else {
                alert(errorMsg);
            }
            return false;
        }
    };

    realHandleLogin.__ccHandleLoginReady = true;

    if (isProxy) {
        existing.__impl = realHandleLogin;
        existing.__isReady = true;
        window.handleLogin = existing;
    } else {
        window.handleLogin = realHandleLogin;
    }

    if (Array.isArray(queue) && queue.length) {
        const queuedCalls = queue.splice(0, queue.length);
        queuedCalls.forEach(entry => {
            if (!entry) return;
            setTimeout(() => {
                try {
                    realHandleLogin.apply(entry.context || window, entry.args || []);
                } catch (err) {
                    console.error('Queued login attempt failed:', err);
                }
            }, 0);
        });
    }

    console.log('✅ handleLogin function created');
})();


// Enhancement: tracker-ui.js
/**
 * Tracker UI Enhancements
 * Adds completion indicators and tracker intelligence to dashboard
 */

(function() {
    'use strict';
    
    console.log('[TrackerUI] Initializing tracker UI enhancements...');
    
    // Wait for dependencies
    const waitForDependencies = () => {
        return new Promise((resolve) => {
            const checkInterval = setInterval(() => {
                if (window.trackerEngine && window.dashboardManager) {
                    clearInterval(checkInterval);
                    resolve();
                }
            }, 100);
        });
    };
    
    // Enhance client card with tracker completion
    const enhanceClientCard = (card, client) => {
        // Check if already enhanced
        if (card.querySelector('.tracker-status')) return;
        
        // Get completion score
        const score = window.trackerEngine.getCompletionScore(client);
        
        // Create tracker status element
        const trackerStatus = document.createElement('div');
        trackerStatus.className = 'tracker-status';
        trackerStatus.innerHTML = `
            <div class="tracker-completion">
                <div class="completion-bar">
                    <div class="completion-fill" style="width: ${score.overallPercentage}%"></div>
                </div>
                <div class="completion-text">
                    <span class="completion-percentage">📊 Chart: ${score.overallPercentage}% Complete</span>
                    ${score.missingCritical.length > 0 ? 
                        `<span class="critical-missing">⚠️ ${score.missingCritical.length} critical items missing</span>` : 
                        ''
                    }
                </div>
            </div>
            ${score.missingCritical.length > 0 ? 
                `<div class="missing-items">
                    Missing: ${score.missingCritical.slice(0, 3).map(item => item.label).join(', ')}
                    ${score.missingCritical.length > 3 ? ` +${score.missingCritical.length - 3} more` : ''}
                </div>` : 
                ''
            }
        `;
        
        // Add risk level class
        trackerStatus.classList.add(`risk-${score.riskLevel}`);
        
        // Find insertion point (after client info, before actions)
        const clientInfo = card.querySelector('.client-info');
        if (clientInfo && clientInfo.nextSibling) {
            clientInfo.parentNode.insertBefore(trackerStatus, clientInfo.nextSibling);
        } else {
            card.appendChild(trackerStatus);
        }
        
        // Add click handler for detailed view
        trackerStatus.addEventListener('click', (e) => {
            e.stopPropagation();
            showTrackerDetails(client);
        });
    };
    
    // Show detailed tracker modal
    const showTrackerDetails = (client) => {
        const score = window.trackerEngine.getCompletionScore(client);
        const upcoming = window.trackerEngine.getUpcomingDeadlines(client);
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'tracker-modal-overlay';
        modal.innerHTML = `
            <div class="tracker-modal">
                <div class="tracker-modal-header">
                    <h3>Tracker Status: ${client.initials}</h3>
                    <button class="close-btn" onclick="window.closeModal(this.closest('.tracker-modal-overlay'))">×</button>
                </div>
                <div class="tracker-modal-content">
                    <div class="tracker-summary">
                        <div class="summary-stat">
                            <span class="stat-label">Overall</span>
                            <span class="stat-value">${score.overallPercentage}%</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Critical</span>
                            <span class="stat-value">${score.criticalPercentage}%</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Complete</span>
                            <span class="stat-value">${score.completedItems}/${score.totalItems}</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Days to Discharge</span>
                            <span class="stat-value">${score.daysToDischarge}</span>
                        </div>
                    </div>
                    
                    ${score.missingCritical.length > 0 ? `
                        <div class="missing-critical-section">
                            <h4>⚠️ Missing Critical Items</h4>
                            <ul class="missing-list">
                                ${score.missingCritical.map(item => `
                                    <li class="missing-item">
                                        <span class="item-label">${item.label}</span>
                                        <span class="item-due">Due by day ${item.dueByDay}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${upcoming.length > 0 ? `
                        <div class="upcoming-section">
                            <h4>📅 Upcoming Deadlines</h4>
                            <ul class="upcoming-list">
                                ${upcoming.map(item => `
                                    <li class="upcoming-item">
                                        <span class="item-label">${item.label}</span>
                                        <span class="item-due">Due in ${item.daysUntilDue} days</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="tracker-actions">
                        <button class="btn-primary" onclick="openBulkUpdate('${client.id}')">Quick Update</button>
                        <button class="btn-secondary" onclick="generateTrackerTasks('${client.id}')">Generate Tasks</button>
                        <button class="btn-secondary" onclick="openTrackerTimeline('${client.id}')">View Timeline</button>
                        <button class="btn-secondary" onclick="aftercareCascade.open('${client.id}')">Aftercare Options</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Close on overlay click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    };
    
    // Intercept dashboard rendering to enhance cards
    const interceptDashboardRender = () => {
        const originalRenderClients = window.dashboardManager.renderClients;
        
        window.dashboardManager.renderClients = async function(clients, container) {
            // Call original render
            await originalRenderClients.call(this, clients, container);
            
            // Enhance each card
            const cards = container.querySelectorAll('.client-card');
            cards.forEach((card, index) => {
                if (clients[index]) {
                    enhanceClientCard(card, clients[index]);
                }
            });
        };
    };
    
    // Add tracker tasks to flight plan
    const enhanceFlightPlan = () => {
        const originalLoadPriorities = window.dashboardManager.loadPriorities;
        
        window.dashboardManager.loadPriorities = async function() {
            // Call original
            const priorities = await originalLoadPriorities.call(this);
            
            // Add tracker-generated tasks
            try {
                const clients = await this.getRelevantClients();
                const trackerTasks = [];
                
                for (const client of clients) {
                    const tasks = window.trackerEngine.generateTasksFromGaps(client);
                    trackerTasks.push(...tasks);
                }
                
                // Merge tracker tasks into priorities
                for (const task of trackerTasks) {
                    let zone = 'green';
                    if (task.priority === 'critical') zone = 'red';
                    else if (task.priority === 'high') zone = 'purple';
                    else if (task.priority === 'medium') zone = 'yellow';
                    
                    const item = {
                        type: task.type,
                        client: {
                            id: task.clientId,
                            initials: task.clientInitials,
                            houseId: task.houseId
                        },
                        message: task.title,
                        action: 'Mark Complete',
                        dueDate: task.dueDate,
                        trackerId: task.trackerId,
                        autoGenerated: true,
                        isTrackerTask: true  // Flag to identify tracker tasks
                    };
                    
                    if (!priorities[zone]) priorities[zone] = [];
                    priorities[zone].push(item);
                }
                
                return priorities;
            } catch (error) {
                console.error('[TrackerUI] Error generating tracker tasks:', error);
                return priorities;
            }
        };
    };
    
    // Global functions for modal actions
    window.openBulkUpdate = async (clientId) => {
        // This will be implemented in the bulk update phase
        console.log('[TrackerUI] Bulk update requested for client:', clientId);
        alert('Bulk update feature coming soon!');
    };
    
    window.openTrackerTimeline = async (clientId) => {
        try {
            const client = await window.clientManager.getClient(clientId);
            
            // Create timeline modal
            const modal = document.createElement('div');
            modal.className = 'tracker-modal-overlay timeline-modal-overlay';
            modal.innerHTML = `
                <div class="tracker-modal timeline-modal-large">
                    <div class="tracker-modal-header">
                        <h3>Tracker Timeline</h3>
                        <button class="close-btn" onclick="window.closeModal(this.closest('.tracker-modal-overlay'))">×</button>
                    </div>
                    <div class="tracker-modal-content">
                        <div id="timeline-container"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Render timeline
            const container = modal.querySelector('#timeline-container');
            if (window.trackerTimeline) {
                await window.trackerTimeline.render(client, container);
            } else {
                container.innerHTML = '<p>Timeline component not loaded</p>';
            }
            
            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
        } catch (error) {
            console.error('[TrackerUI] Error opening timeline:', error);
            alert('Error loading timeline. Check console for details.');
        }
    };
    
    window.generateTrackerTasks = async (clientId) => {
        try {
            const client = await window.clientManager.getClient(clientId);
            const tasks = window.trackerEngine.generateTasksFromGaps(client);
            
            if (tasks.length === 0) {
                alert('No tasks to generate - all requirements are on track!');
                return;
            }
            
            if (!window.taskManager?.createTask) {
                console.warn('Task manager not available - tasks logged only');
                console.log('Generated tasks (task manager missing):', tasks);
                alert(`Generated ${tasks.length} tasks (task manager not configured)`);
                return;
            }
            
            // Create tasks using task manager
            for (const task of tasks) {
                await window.taskManager.createTask({
                    title: task.title,
                    description: task.description,
                    priority: task.priority,
                    dueDate: task.dueDate,
                    category: 'tracker-generated',
                    clientId: task.clientId,
                    metadata: {
                        trackerId: task.trackerId,
                        autoGenerated: true
                    }
                });
            }
            
            alert(`Generated ${tasks.length} tasks from tracker gaps`);
            
            // Emit event for onboarding checklist
            if (window.OnboardingEvents?.emit) {
                OnboardingEvents.emit('cc:flightPlan:taskCreated', { count: tasks.length });
            }
            window.dispatchEvent(new CustomEvent('cc:flightPlan:taskCreated', { detail: { count: tasks.length } }));
            console.log('[Tasks] Emitted cc:flightPlan:taskCreated to window');
            
            // Refresh dashboard
            if (window.dashboardManager.loadData) {
                await window.dashboardManager.loadData();
            }
            
            // Close modal
            const modal = document.querySelector('.tracker-modal-overlay');
            if (modal) modal.remove();
            
        } catch (error) {
            console.error('[TrackerUI] Error generating tasks:', error);
            alert('Error generating tasks. Check console for details.');
        }
    };
    
    // Initialize enhancements
    const initialize = async () => {
        console.log('[TrackerUI] Waiting for dependencies...');
        await waitForDependencies();
        
        console.log('[TrackerUI] Enhancing dashboard...');
        interceptDashboardRender();
        enhanceFlightPlan();
        
        // Trigger re-render if dashboard is already loaded
        if (window.dashboardManager.initialized) {
            console.log('[TrackerUI] Refreshing dashboard with tracker enhancements...');
            await window.dashboardManager.loadData();
        }
        
        console.log('[TrackerUI] Tracker UI enhancements ready');
    };
    
    // Start initialization
    initialize();
    
})();


// ═══════════════════════════════════════════════════════════════════════════
// EXTRACTED: tracker-compliance-widget.js
// This code has been extracted to: js/widgets/compliance-widget.js
// The external script is loaded via <script src=""> in the <head> section.
// Original inline code removed to prevent double-execution.
// Extraction Date: December 6, 2025
// ═══════════════════════════════════════════════════════════════════════════

if (false) { // ORIGINAL INLINE CODE - NOW LOADED FROM EXTERNAL FILE
// Enhancement: tracker-compliance-widget.js
// Tracker Compliance Dashboard Widget
// House-level view of tracker completion across all clients

(function() {
    'use strict';
    
    console.log('[ComplianceWidget] Initializing compliance widget...');
    
    // Compliance Widget Class
    class ComplianceWidget {
        constructor(container) {
            this.container = container;
            this.initialized = false;
            this.data = null;
        }
        
        async render() {
            if (!window.trackerEngine) {
                this.container.innerHTML = '<div class="widget-error">Tracker engine not loaded</div>';
                return;
            }
            
            try {
                // Get all clients grouped by house
                const clientsByHouse = await this.getClientsByHouse();
                
                // Calculate compliance for each house
                const houseStats = [];
                for (const [houseId, clients] of Object.entries(clientsByHouse)) {
                    if (clients.length > 0) {
                        const stats = window.trackerEngine.getHouseCompliance(clients);
                        houseStats.push(stats);
                    }
                }
                
                // Calculate overall compliance
                const overallStats = this.calculateOverallStats(houseStats);
                
                // Render the widget
                this.container.innerHTML = `
                    <div class="compliance-widget">
                        <div class="widget-header">
                            <h3>📊 House Tracker Compliance</h3>
                            <div class="widget-header-actions">
                                <span class="metric-info" data-metric="dash_tracker_overall">i</span>
                                <button class="refresh-btn" onclick="dashboardWidgets.widgets.get('compliance')?.render()">
                                    <span class="refresh-icon">↻</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="compliance-overview">
                            <div class="overall-score">
                                <div class="score-circle" style="--percentage: ${overallStats.overall}">
                                    <svg viewBox="0 0 36 36" class="circular-chart">
                                        <path class="circle-bg"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        />
                                        <path class="circle"
                                            stroke-dasharray="${overallStats.overall}, 100"
                                            d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        />
                                    </svg>
                                    <div class="percentage">
                                        <span class="value">${overallStats.overall}%</span>
                                        <span class="label">Overall</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="compliance-metrics">
                                <div class="metric">
                                    <span class="metric-value">${overallStats.critical}%</span>
                                    <span class="metric-label">
                                        Critical Items
                                        <span class="metric-info" data-metric="dash_tracker_critical">i</span>
                                    </span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">${overallStats.atRisk}</span>
                                    <span class="metric-label">
                                        At Risk Clients
                                        <span class="metric-info" data-metric="dash_tracker_at_risk">i</span>
                                    </span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">${overallStats.strong}</span>
                                    <span class="metric-label">
                                        Strong Performers
                                        <span class="metric-info" data-metric="dash_tracker_strong">i</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="house-compliance-list">
                            ${houseStats.map(stats => this.renderHouseCard(stats)).join('')}
                        </div>
                        
                        ${overallStats.atRiskDetails.length > 0 ? `
                            <div class="at-risk-section">
                                <h4>⚠️ Immediate Attention Required</h4>
                                <div class="at-risk-list">
                                    ${overallStats.atRiskDetails.map(client => `
                                        <div class="at-risk-item">
                                            <span class="client-info">${client.message}</span>
                                            <button class="action-btn" onclick="openBulkUpdate('${client.client.id}')">
                                                Update
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                if (window.attachMetricTooltips) {
                    window.attachMetricTooltips(this.container);
                }
                
            } catch (error) {
                console.error('[ComplianceWidget] Render error:', error);
                this.container.innerHTML = '<div class="widget-error">Failed to load compliance data</div>';
            }
        }
        
        renderHouseCard(stats) {
            const riskClass = stats.overallCompliance >= 80 ? 'good' : 
                             stats.overallCompliance >= 60 ? 'warning' : 'danger';
            
            // Get proper house display name
            const houseName = this.getHouseDisplayName(stats.houseId);
            
            return `
                <div class="house-card ${riskClass}">
                    <div class="house-header">
                        <h4>${houseName}</h4>
                        <span class="house-score">${stats.overallCompliance}%</span>
                    </div>
                    <div class="house-details">
                        <div class="detail-row">
                            <span>Clients:</span>
                            <span>${stats.totalClients}</span>
                        </div>
                        <div class="detail-row">
                            <span>Critical:</span>
                            <span>${stats.criticalCompliance}%</span>
                        </div>
                        <div class="detail-row">
                            <span>At Risk:</span>
                            <span class="${stats.atRiskClients.length > 0 ? 'text-danger' : ''}">${stats.atRiskClients.length}</span>
                        </div>
                    </div>
                    <div class="category-breakdown">
                        ${Object.entries(stats.byCategory).map(([cat, data]) => `
                            <div class="category-bar">
                                <div class="cat-label">${this.getCategoryLabel(cat)}</div>
                                <div class="cat-progress">
                                    <div class="cat-fill" style="width: ${data.percentage}%"></div>
                                </div>
                                <div class="cat-value">${data.percentage}%</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        getCategoryLabel(category) {
            const labels = {
                admission: 'Admission',
                clinical: 'Clinical',
                aftercare: 'Aftercare',
                documentation: 'Docs'
            };
            return labels[category] || category;
        }
        
        /**
         * Get display name for a house ID
         * @param {string} houseId - The house ID (e.g., 'house_nest')
         * @returns {string} The display name (e.g., 'NEST')
         */
        getHouseDisplayName(houseId) {
            if (!houseId) return 'Unassigned';
            
            // Try to get from housesManager
            if (window.housesManager && typeof window.housesManager.getHouseById === 'function') {
                const house = window.housesManager.getHouseById(houseId);
                if (house && house.name) {
                    return house.name;
                }
            }
            
            // Fallback: extract name from ID (e.g., 'house_nest' -> 'Nest')
            const match = houseId.match(/^house_(.+)$/);
            if (match) {
                return match[1].charAt(0).toUpperCase() + match[1].slice(1);
            }
            
            return houseId;
        }
        
        async getClientsByHouse() {
            let clients = [];
            
            // Prefer the same data pipeline the main dashboard uses
            if (window.dashboardManager?.getRelevantClients) {
                try {
                    clients = await window.dashboardManager.getRelevantClients();
                } catch (err) {
                    console.warn('[ComplianceWidget] Falling back to clientManager.getAllClients()', err);
                }
            }
            
            // Fallback if dashboardManager path fails
            if ((!clients || clients.length === 0) && window.clientManager?.getAllClients) {
                clients = await window.clientManager.getAllClients();
            }
            
            if (!Array.isArray(clients) || clients.length === 0) {
                return {};
            }
            
            const activeClients = clients.filter(c => c.status === 'active');
            
            const byHouse = {};
            activeClients.forEach(client => {
                const house = client.houseId || 'Unassigned';
                if (!byHouse[house]) byHouse[house] = [];
                byHouse[house].push(client);
            });
            
            return byHouse;
        }
        
        calculateOverallStats(houseStats) {
            let totalCompliance = 0;
            let totalCritical = 0;
            let totalAtRisk = 0;
            let totalStrong = 0;
            let allAtRisk = [];
            
            houseStats.forEach(stats => {
                totalCompliance += stats.overallCompliance;
                totalCritical += stats.criticalCompliance;
                totalAtRisk += stats.atRiskClients.length;
                totalStrong += stats.strongClients.length;
                allAtRisk.push(...stats.atRiskClients);
            });
            
            const houseCount = houseStats.length || 1;
            
            return {
                overall: Math.round(totalCompliance / houseCount),
                critical: Math.round(totalCritical / houseCount),
                atRisk: totalAtRisk,
                strong: totalStrong,
                atRiskDetails: allAtRisk.slice(0, 5) // Top 5 most at risk
            };
        }
    }
    
    // Wait for dependencies and inject widget
    const injectComplianceWidget = () => {
        const checkInterval = setInterval(() => {
            if (window.dashboardWidgets && window.trackerEngine && window.clientManager) {
                clearInterval(checkInterval);
                
                // Find or create container for compliance widget
                let container = document.querySelector('.compliance-widget-container');
                if (!container) {
                    const dashboardContainer = document.querySelector('.dashboard-container');
                    const mainGrid = dashboardContainer?.querySelector('.dashboard-main-grid');
                    
                    if (dashboardContainer) {
                        container = document.createElement('div');
                        container.className = 'widget-container compliance-widget-container';
                        
                        // Insert as a full-width section directly below the main grid
                        if (mainGrid && mainGrid.parentElement) {
                            mainGrid.parentElement.insertBefore(container, mainGrid.nextSibling);
                        } else {
                            dashboardContainer.appendChild(container);
                        }
                    }
                }
                
                if (container) {
                    // Create and register widget
                    const complianceWidget = new ComplianceWidget(container);
                    window.dashboardWidgets.widgets.set('compliance', complianceWidget);
                    
                    // Initial render
                    complianceWidget.render();
                    
                    console.log('[ComplianceWidget] Widget injected and rendered');
                } else {
                    console.warn('[ComplianceWidget] Could not find suitable container');
                }
            }
        }, 100);
    };
    
    // Start injection process
    injectComplianceWidget();
    
})();
} // END OF EXTRACTED COMPLIANCE WIDGET


// ═══════════════════════════════════════════════════════════════════════════
// EXTRACTED: tracker-document-hub.js  
// This code has been extracted to: js/ui/document-hub.js
// The external script is loaded via <script src=""> in the <head> section.
// Original inline code removed to prevent double-execution.
// Extraction Date: December 6, 2025
// ═══════════════════════════════════════════════════════════════════════════

if (false) { // ORIGINAL INLINE CODE - NOW LOADED FROM EXTERNAL FILE
// Enhancement: tracker-document-hub.js
// Tracker Document Hub Enhancement
// Visual status indicators and centralized document tracking

(function() {
    'use strict';
    
    console.log('[DocumentHub] Initializing document hub enhancements...');
    
    // Document definitions with metadata
    const documentDefinitions = [
        {
            id: 'needsAssessment',
            category: 'admission',
            label: 'Needs Assessment',
            required: true,
            dueByDay: 2,
            template: true
        },
        {
            id: 'healthPhysical',
            category: 'admission',
            label: 'Health & Physical',
            required: true,
            dueByDay: 2,
            template: true
        },
        {
            id: 'optionsDoc',
            category: 'aftercare',
            label: 'Aftercare Options Document',
            required: true,
            dueByDay: 21,
            template: true,
            requiresSignature: true
        },
        {
            id: 'dischargePacket',
            category: 'aftercare',
            label: 'Discharge Packet',
            required: true,
            dueByDay: 25,
            multipart: true
        },
        {
            id: 'dischargeSummary',
            category: 'discharge',
            label: 'Discharge Summary',
            required: true,
            dueByDay: 28,
            template: true
        },
        {
            id: 'dischargePlanningNote',
            category: 'discharge',
            label: 'Discharge Planning Note',
            required: true,
            dueByDay: 26,
            template: true
        },
        {
            id: 'dischargeASAM',
            category: 'discharge',
            label: 'Discharge ASAM',
            required: true,
            dueByDay: 28,
            template: false
        },
        {
            id: 'satisfactionSurvey',
            category: 'feedback',
            label: 'Satisfaction Survey',
            required: false,
            dueByDay: 25,
            template: true
        }
    ];
    
    // Document Hub Class
    class DocumentHub {
        constructor() {
            this.currentClient = null;
            this.initialized = false;
        }
        
        /**
         * Get document status for a client
         */
        getDocumentStatus(client, docDef) {
            const fieldName = docDef.id === 'optionsDoc' ? 'optionsDocUploaded' : 
                             docDef.id === 'dischargePacket' ? 'dischargePacketUploaded' :
                             docDef.id;
            
            const isComplete = client[fieldName];
            const completedDate = client[fieldName + 'Date'];
            const daysInCare = this.calculateDaysInCare(client.admissionDate);
            const daysToDischarge = this.calculateDaysToDischarge(client);
            
            let status = 'pending';
            let statusMessage = '';
            
            if (isComplete) {
                status = 'complete';
                statusMessage = completedDate ? 
                    `Completed ${new Date(completedDate).toLocaleDateString()}` : 
                    'Completed';
            } else if (daysInCare > docDef.dueByDay) {
                status = 'overdue';
                const daysOverdue = daysInCare - docDef.dueByDay;
                statusMessage = `Overdue by ${daysOverdue} days`;
            } else if (daysToDischarge <= 7 && docDef.required) {
                status = 'urgent';
                statusMessage = `Due in ${docDef.dueByDay - daysInCare} days`;
            } else {
                status = 'pending';
                statusMessage = `Due by day ${docDef.dueByDay}`;
            }
            
            return {
                status,
                statusMessage,
                isComplete,
                completedDate,
                daysUntilDue: docDef.dueByDay - daysInCare
            };
        }
        
        /**
         * Render document hub for a client
         */
        async renderDocumentHub(clientId) {
            try {
                this.currentClient = await window.clientManager.getClient(clientId);
                if (!this.currentClient) return;
                
                // Group documents by category
                const docsByCategory = this.groupDocumentsByCategory();
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'document-hub-overlay';
                modal.innerHTML = `
                    <div class="document-hub-modal">
                        <div class="document-hub-header">
                            <h3>📄 Document Status: ${this.currentClient.initials}</h3>
                            <button class="close-btn" onclick="window.closeModal(this.closest('.document-hub-overlay'))">×</button>
                        </div>
                        
                        <div class="document-hub-content">
                            <div class="document-summary">
                                ${this.renderDocumentSummary()}
                            </div>
                            
                            <div class="document-categories">
                                ${Object.entries(docsByCategory).map(([category, docs]) => 
                                    this.renderDocumentCategory(category, docs)
                                ).join('')}
                            </div>
                            
                            <div class="document-actions">
                                <button class="btn-primary" onclick="documentHub.generateMissing()">
                                    Generate Missing Documents
                                </button>
                                <button class="btn-secondary" onclick="documentHub.bulkUpload()">
                                    Bulk Upload
                                </button>
                                <button class="btn-secondary" onclick="documentHub.exportChecklist()">
                                    Export Checklist
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                console.error('[DocumentHub] Error rendering:', error);
                alert('Error loading document hub');
            }
        }
        
        /**
         * Render document summary stats
         */
        renderDocumentSummary() {
            let totalDocs = 0;
            let completedDocs = 0;
            let overdueDocs = 0;
            let urgentDocs = 0;
            
            documentDefinitions.forEach(docDef => {
                if (docDef.required) {
                    totalDocs++;
                    const status = this.getDocumentStatus(this.currentClient, docDef);
                    if (status.isComplete) completedDocs++;
                    if (status.status === 'overdue') overdueDocs++;
                    if (status.status === 'urgent') urgentDocs++;
                }
            });
            
            const percentage = totalDocs > 0 ? Math.round((completedDocs / totalDocs) * 100) : 0;
            
            return `
                <div class="summary-grid">
                    <div class="summary-stat">
                        <div class="stat-value">${percentage}%</div>
                        <div class="stat-label">Complete</div>
                    </div>
                    <div class="summary-stat">
                        <div class="stat-value">${completedDocs}/${totalDocs}</div>
                        <div class="stat-label">Documents</div>
                    </div>
                    <div class="summary-stat ${overdueDocs > 0 ? 'danger' : ''}">
                        <div class="stat-value">${overdueDocs}</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                    <div class="summary-stat ${urgentDocs > 0 ? 'warning' : ''}">
                        <div class="stat-value">${urgentDocs}</div>
                        <div class="stat-label">Urgent</div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Group documents by category
         */
        groupDocumentsByCategory() {
            const groups = {};
            
            documentDefinitions.forEach(docDef => {
                if (!groups[docDef.category]) {
                    groups[docDef.category] = [];
                }
                groups[docDef.category].push(docDef);
            });
            
            return groups;
        }
        
        /**
         * Render document category section
         */
        renderDocumentCategory(category, docs) {
            const categoryLabels = {
                admission: '48-Hour Admission',
                aftercare: 'Aftercare Planning',
                discharge: 'Discharge Documentation',
                feedback: 'Feedback & Surveys'
            };
            
            return `
                <div class="document-category">
                    <h4>${categoryLabels[category] || category}</h4>
                    <div class="document-list">
                        ${docs.map(doc => this.renderDocumentItem(doc)).join('')}
                    </div>
                </div>
            `;
        }
        
        /**
         * Render individual document item
         */
        renderDocumentItem(docDef) {
            const status = this.getDocumentStatus(this.currentClient, docDef);
            const statusIcon = this.getStatusIcon(status.status);
            const statusClass = `document-item ${status.status}`;
            
            return `
                <div class="${statusClass}">
                    <div class="document-icon">${statusIcon}</div>
                    <div class="document-info">
                        <div class="document-name">
                            ${docDef.label}
                            ${docDef.required ? '<span class="required-badge">Required</span>' : ''}
                            ${docDef.requiresSignature ? '<span class="signature-badge">Needs Signature</span>' : ''}
                        </div>
                        <div class="document-status">${status.statusMessage}</div>
                    </div>
                    <div class="document-actions">
                        ${status.isComplete ? `
                            <button class="btn-icon" title="View Document" onclick="documentHub.viewDocument('${docDef.id}')">
                                👁️
                            </button>
                            <button class="btn-icon" title="Replace Document" onclick="documentHub.uploadDocument('${docDef.id}')">
                                📤
                            </button>
                        ` : `
                            ${docDef.template ? `
                                <button class="btn-small" onclick="documentHub.generateDocument('${docDef.id}')">
                                    Generate
                                </button>
                            ` : ''}
                            <button class="btn-small primary" onclick="documentHub.uploadDocument('${docDef.id}')">
                                Upload
                            </button>
                        `}
                    </div>
                </div>
            `;
        }
        
        /**
         * Get status icon
         */
        getStatusIcon(status) {
            switch (status) {
                case 'complete': return '✅';
                case 'overdue': return '❌';
                case 'urgent': return '⚠️';
                default: return '○';
            }
        }
        
        /**
         * Generate missing documents
         */
        async generateMissing() {
            const missing = documentDefinitions.filter(doc => {
                const status = this.getDocumentStatus(this.currentClient, doc);
                return !status.isComplete && doc.template;
            });
            
            if (missing.length === 0) {
                alert('No missing documents with templates available');
                return;
            }
            
            alert(`Generating ${missing.length} document templates:\n${missing.map(d => d.label).join('\n')}`);
            
            // In real implementation, this would generate actual documents
            console.log('[DocumentHub] Would generate:', missing);
        }
        
        /**
         * Handle document upload
         */
        uploadDocument(docId) {
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.doc,.docx';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                console.log(`[DocumentHub] Would upload ${file.name} for ${docId}`);
                
                // Update client record (in real implementation, would also upload file)
                const fieldName = docId === 'optionsDoc' ? 'optionsDocUploaded' : 
                                 docId === 'dischargePacket' ? 'dischargePacketUploaded' :
                                 docId;
                
                const updates = {
                    [fieldName]: true,
                    [fieldName + 'Date']: new Date().toISOString()
                };
                
                await window.clientManager.updateClient(this.currentClient.id, updates);
                
                // Refresh modal
                document.querySelector('.document-hub-overlay').remove();
                this.renderDocumentHub(this.currentClient.id);
                
                // Show success
                this.showNotification(`${file.name} uploaded successfully`, 'success');
            };
            
            input.click();
        }
        
        /**
         * View document (placeholder)
         */
        viewDocument(docId) {
            alert(`Viewing document: ${docId}\n(In real implementation, would open document viewer)`);
        }
        
        /**
         * Generate document from template (placeholder)
         */
        generateDocument(docId) {
            const doc = documentDefinitions.find(d => d.id === docId);
            alert(`Generating ${doc.label} from template...\n(In real implementation, would create document)`);
        }
        
        /**
         * Bulk upload interface (placeholder)
         */
        bulkUpload() {
            alert('Bulk upload interface coming soon!');
        }
        
        /**
         * Export checklist (placeholder)
         */
        exportChecklist() {
            const checklist = documentDefinitions.map(doc => {
                const status = this.getDocumentStatus(this.currentClient, doc);
                return `${status.isComplete ? '☑' : '☐'} ${doc.label} - ${status.statusMessage}`;
            }).join('\n');
            
            alert(`Document Checklist for ${this.currentClient.initials}:\n\n${checklist}`);
        }
        
        /**
         * Show notification
         */
        showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `document-notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('visible');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('visible');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Helper methods
        calculateDaysInCare(admissionDate) {
            if (!admissionDate) return 0;
            const admission = new Date(admissionDate);
            const today = new Date();
            const diffTime = Math.abs(today - admission);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
        
        calculateDaysToDischarge(client) {
            if (!client.dischargeDate) {
                return Math.max(0, 30 - this.calculateDaysInCare(client.admissionDate));
            }
            const discharge = new Date(client.dischargeDate);
            const today = new Date();
            const diffTime = discharge - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }
    }
    
    // Create global instance
    window.documentHub = new DocumentHub();
    
    // Add document hub button to client cards
    const addDocumentHubButtons = () => {
        const originalRenderClients = window.dashboardManager?.renderClients;
        
        if (originalRenderClients) {
            window.dashboardManager.renderClients = async function(clients, container) {
                // Call original
                await originalRenderClients.call(this, clients, container);
                
                // Add document hub buttons
                const cards = container.querySelectorAll('.client-card');
                cards.forEach((card, index) => {
                    if (clients[index] && !card.querySelector('.document-hub-btn')) {
                        const actionsContainer = card.querySelector('.client-actions') || card;
                        const btn = document.createElement('button');
                        btn.className = 'btn-small document-hub-btn';
                        btn.innerHTML = '📄 Documents';
                        btn.onclick = () => window.documentHub.renderDocumentHub(clients[index].id);
                        actionsContainer.appendChild(btn);
                    }
                });
            };
        }
    };
    
    // Initialize when dependencies are ready
    const initInterval = setInterval(() => {
        if (window.dashboardManager && window.clientManager) {
            clearInterval(initInterval);
            addDocumentHubButtons();
            console.log('[DocumentHub] Document hub enhancements ready');
        }
    }, 100);
    
})();
} // END OF EXTRACTED DOCUMENT HUB


// Enhancement: discharge-checklist.js
/**
 * Discharge Checklist UI Enhancement
 * Adds discharge checklist button to client cards and integrates with dashboard
 */

(function() {
    'use strict';
    
    // Wait for dashboard to be ready
    function waitForDashboard() {
        if (!window.dashboardWidgets || !window.dischargeChecklistManager) {
            setTimeout(waitForDashboard, 100);
            return;
        }
        
        enhanceClientCards();
    }
    
    /**
     * Add discharge checklist button to client cards
     */
    function enhanceClientCards() {
        // Override the renderClientCard method to add discharge checklist button
        const originalRenderCard = window.dashboardWidgets.renderClientCard;
        
        window.dashboardWidgets.renderClientCard = function(client) {
            const cardHtml = originalRenderCard.call(this, client);
            
            // Calculate days to discharge
            const daysToDischarge = client.dischargeDate ? 
                Math.ceil((new Date(client.dischargeDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
            
            // Only show discharge checklist button if discharge is within 7 days or past
            if (daysToDischarge !== null && daysToDischarge <= 7) {
                // Insert discharge checklist button before the closing client-actions div
                const insertPoint = '</div>\n            </div>';
                const dischargeButton = `
                    <button class="btn-discharge-checklist" 
                            onclick="dischargeChecklistManager.renderChecklistModal('${client.id}')"
                            title="Open FFAS Discharge Checklist">
                        📋 Discharge Checklist
                    </button>
                `;
                
                return cardHtml.replace(insertPoint, dischargeButton + insertPoint);
            }
            
            return cardHtml;
        };
        
        // Also add to the discharge prep alerts
        const originalRenderPriority = window.dashboardWidgets.renderPriorityItem;
        
        window.dashboardWidgets.renderPriorityItem = function(item, zoneColor) {
            const html = originalRenderPriority.call(this, item, zoneColor);
            
            // If this is a discharge prep item, add a link to the checklist
            if (item.type === 'discharge_prep') {
                const checklistLink = `
                    <button class="btn-link" 
                            onclick="dischargeChecklistManager.renderChecklistModal('${item.client.id}')"
                            style="margin-left: 8px; color: #7c3aed; text-decoration: underline; background: none; border: none; cursor: pointer;">
                        📋 Open Full Checklist
                    </button>
                `;
                
                // Insert after the action button
                return html.replace('</div>\n                </div>', checklistLink + '</div>\n                </div>');
            }
            
            return html;
        };
    }
    
    // Initialize when ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDashboard);
    } else {
        waitForDashboard();
    }
})();


if (false) {
// Enhancement: missions-redesign.js
/**
 * Missions Widget Redesign
 * Modern, beautiful redesign of the Today's Missions widget
 */

(function() {
    'use strict';
    
    // Wait for dashboard to be ready
    function waitForDashboard() {
        if (!window.dashboardWidgets || !window.dashboardManager) {
            setTimeout(waitForDashboard, 100);
            return;
        }
        
        enhanceMissionsWidget();
    }
    
    /**
     * Enhance the missions widget with modern design
     */
    function enhanceMissionsWidget() {
        // Wait for MissionsWidget to be available
        const checkForWidget = setInterval(() => {
            // Find the missions widget instance
            const widgetsManager = window.dashboardWidgets;
            if (widgetsManager && widgetsManager.widgets) {
                const missionsWidget = widgetsManager.widgets.get('missions');
                if (missionsWidget) {
                    clearInterval(checkForWidget);
                    
                    // Override the render method
                    const originalRender = missionsWidget.render.bind(missionsWidget);
                    missionsWidget.render = async function() {
                        try {
                            // Get the data first
                            const alerts = await window.dashboardManager.loadCriticalAlerts();
                            
                            // Use our modern rendering
                            const modernHtml = renderModernMissions(alerts);
                            
                            // Update the container
                            if (this.container) {
                                this.container.innerHTML = modernHtml;
                            }
                        } catch (error) {
                            console.error('Error rendering modern missions:', error);
                            // Fallback to original
                            return originalRender();
                        }
                    };
                    
                    // Trigger a re-render
                    missionsWidget.render();
                }
            }
        }, 100);
        
        // Also create the widget if it doesn't exist
        setTimeout(() => {
            clearInterval(checkForWidget);
            createMissionsWidgetIfMissing();
        }, 5000);
    }
    
    function createMissionsWidgetIfMissing() {
        // Check if there's a container for missions but no widget
        const container = document.querySelector('[data-widget="missions"], .missions-container');
        if (container && window.dashboardWidgets && !window.dashboardWidgets.widgets.get('missions')) {
            // Create a custom missions widget
            const missionsWidget = {
                id: 'missions',
                container: container,
                render: async function() {
                    const alerts = await window.dashboardManager.loadCriticalAlerts();
                    container.innerHTML = renderModernMissions(alerts);
                }
            };
            
            window.dashboardWidgets.widgets.set('missions', missionsWidget);
            missionsWidget.render();
        }
    }
    
    /**
     * Render modern missions widget
     */
    function renderModernMissions(data) {
        // Get missions from red and yellow zones
        const primaryMissions = data.red || [];
        const secondaryMissions = data.yellow || [];
        const totalMissions = primaryMissions.length + secondaryMissions.length;
        const completedCount = 0; // Would need to track this in actual implementation
        
        let html = `
            <div class="missions-widget">
                <!-- Header -->
                <div class="missions-header">
                    <div class="missions-title">
                        Today's Missions
                    </div>
                    <div class="missions-progress">
                        <div class="progress-circles">
                            ${Array(Math.max(2, totalMissions)).fill().map((_, i) => 
                                `<div class="progress-circle ${i < completedCount ? 'completed' : ''}"></div>`
                            ).join('')}
                        </div>
                        <span>${completedCount}/${totalMissions} Complete</span>
                    </div>
                </div>
        `;
        
        if (totalMissions === 0) {
            html += `
                <div class="missions-empty">
                    <div class="missions-empty-icon">🎉</div>
                    <div class="missions-empty-text">All missions complete! Great work!</div>
                </div>
            `;
        } else {
            // Primary Objectives
            if (primaryMissions.length > 0) {
                html += `
                    <div class="mission-section primary">
                        <div class="mission-section-header">
                            <div class="mission-label">
                                <div class="icon">🎯</div>
                                Primary Objective
                            </div>
                            <div class="mission-time">Est. ${primaryMissions.length * 5} min</div>
                        </div>
                        <div class="mission-items">
                `;
                
                primaryMissions.forEach(mission => {
                    const clientInfo = mission.client ? 
                        `<span class="mission-client">${mission.client.initials || 'Client'}</span>` : '';
                    
                    html += `
                        <div class="mission-item critical">
                            <div class="mission-checkbox">
                                <input type="checkbox" 
                                       id="mission-${mission.type}-${mission.client?.id}"
                                       ${mission.isTrackerTask ? 
                                         `onclick="dashboardWidgets.completeTrackerItem('${mission.client?.id}', '${mission.trackerId}')"` :
                                         `onclick="dashboardWidgets.completeMission('${mission.type}', '${mission.client?.id}')"` 
                                       }>
                            </div>
                            <div class="mission-content">
                                ${clientInfo}
                                <span class="mission-text">${mission.message}</span>
                                ${mission.priority === 'red' ? '<span class="mission-critical">CRITICAL</span>' : ''}
                            </div>
                            ${mission.action && mission.action !== 'Mark Complete' ? 
                                `<button class="mission-action" onclick="dashboardWidgets.takeAction('${mission.type}', '${mission.client?.id}')">
                                    ${mission.action}
                                </button>` : ''
                            }
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Secondary Objectives
            if (secondaryMissions.length > 0) {
                html += `
                    <div class="mission-section secondary">
                        <div class="mission-section-header">
                            <div class="mission-label">
                                <div class="icon">🎪</div>
                                Secondary Objectives
                            </div>
                            <div class="mission-time">Est. ${secondaryMissions.length * 5} min</div>
                        </div>
                        <div class="mission-items">
                `;
                
                secondaryMissions.forEach(mission => {
                    const clientInfo = mission.client ? 
                        `<span class="mission-client">${mission.client.initials || 'Client'}</span>` : '';
                    
                    html += `
                        <div class="mission-item">
                            <div class="mission-checkbox">
                                <input type="checkbox" 
                                       id="mission-${mission.type}-${mission.client?.id}"
                                       ${mission.isTrackerTask ? 
                                         `onclick="dashboardWidgets.completeTrackerItem('${mission.client?.id}', '${mission.trackerId}')"` :
                                         `onclick="dashboardWidgets.completeMission('${mission.type}', '${mission.client?.id}')"` 
                                       }>
                            </div>
                            <div class="mission-content">
                                ${clientInfo}
                                <span class="mission-text">${mission.message}</span>
                            </div>
                            ${mission.action && mission.action !== 'Mark Complete' ? 
                                `<button class="mission-action" onclick="dashboardWidgets.takeAction('${mission.type}', '${mission.client?.id}')">
                                    ${mission.action}
                                </button>` : ''
                            }
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
        }
        
        html += `
            </div>
            
            <!-- Quick Actions Bar -->
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="dashboardWidgets.openAddClient()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        ➕
                    </div>
                    <span class="quick-action-label">Add Client</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.openGenerateDoc()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                        📄
                    </div>
                    <span class="quick-action-label">Generate Doc</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.showAllAlerts()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        🔔
                    </div>
                    <span class="quick-action-label">All Alerts</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.exportReport()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        📊
                    </div>
                    <span class="quick-action-label">Export Report</span>
                </button>
                
                <button class="quick-action-btn" onclick="dashboardWidgets.toggleFocusMode()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                        🎯
                    </div>
                    <span class="quick-action-label">Focus Mode</span>
                </button>
                
                <button class="quick-action-btn" onclick="location.reload()">
                    <div class="quick-action-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                        🔄
                    </div>
                    <span class="quick-action-label">Refresh</span>
                </button>
            </div>
        `;
        
        return html;
    }
    
    // Add mission completion handler if it doesn't exist
    if (window.dashboardWidgets && !window.dashboardWidgets.completeMission) {
        window.dashboardWidgets.completeMission = async function(missionType, clientId) {
            // Mark mission as complete
            console.log('Completing mission:', missionType, clientId);
            
            // Add completion animation
            const checkbox = document.querySelector(`#mission-${missionType}-${clientId}`);
            if (checkbox) {
                checkbox.checked = true;
                const missionItem = checkbox.closest('.mission-item');
                if (missionItem) {
                    missionItem.style.opacity = '0.5';
                    missionItem.style.textDecoration = 'line-through';
                }
            }
            
            // Update progress
            setTimeout(() => {
                window.dashboardManager.refreshDashboard();
            }, 500);
        };
    }
    
    // Add placeholder methods for quick actions if they don't exist
    const placeholderMethods = {
        openAddClient: () => console.log('Open Add Client modal'),
        openGenerateDoc: () => {
            // Try to open document creator if available
            const docBtn = document.querySelector('[onclick*="showDocumentCreator"]');
            if (docBtn) docBtn.click();
            else console.log('Open Generate Doc');
        },
        showAllAlerts: () => {
            // Show all zones if collapsed
            document.querySelectorAll('.zone-content.collapsed').forEach(zone => {
                zone.classList.remove('collapsed');
            });
        },
        exportReport: () => {
            // Try to trigger export if available
            if (window.exportDashboardData) {
                window.exportDashboardData();
            } else {
                console.log('Export Report');
            }
        },
        toggleFocusMode: () => {
            // Hide all except missions widget
            document.body.classList.toggle('focus-mode');
            if (document.body.classList.contains('focus-mode')) {
                // Hide other widgets
                document.querySelectorAll('.widget-card').forEach(widget => {
                    if (!widget.querySelector('.missions-widget')) {
                        widget.style.display = 'none';
                    }
                });
            } else {
                // Show all widgets
                document.querySelectorAll('.widget-card').forEach(widget => {
                    widget.style.display = '';
                });
            }
        }
    };
    
    // Add methods if they don't exist
    Object.keys(placeholderMethods).forEach(method => {
        if (window.dashboardWidgets && !window.dashboardWidgets[method]) {
            window.dashboardWidgets[method] = placeholderMethods[method];
        }
    });
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDashboard);
    } else {
        waitForDashboard();
    }
})();
}


// Enhancement: morning-review.js
/**
 * Morning Review Dashboard UI Enhancement
 * Adds morning review button and functionality
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.morningReview || !window.dashboardManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        addMorningReviewButton();
        checkAutoShowMorningReview();
    }
    
    /**
     * Add morning review button to dashboard
     */
    function addMorningReviewButton() {
        // Check every second for dashboard controls
        const checkInterval = setInterval(() => {
            const dashboardControls = document.querySelector('.dashboard-controls');
            if (dashboardControls) {
                clearInterval(checkInterval);
                
                // Check if button already exists
                if (document.querySelector('.btn-morning-review')) return;
                
                // Add the button
                const morningBtn = document.createElement('button');
                morningBtn.className = 'btn-morning-review';
                morningBtn.innerHTML = '☀️ Morning Review';
                morningBtn.onclick = () => window.morningReview.renderMorningReview();
                
                // Insert before other buttons
                const firstButton = dashboardControls.querySelector('button');
                if (firstButton && firstButton.parentNode === dashboardControls) {
                    try {
                        dashboardControls.insertBefore(morningBtn, firstButton);
                    } catch (err) {
                        console.warn('Could not insert Morning Review button:', err);
                        dashboardControls.appendChild(morningBtn);
                    }
                } else {
                    dashboardControls.appendChild(morningBtn);
                }
                
                // Add notification badge if tasks are overdue
                checkForNotificationBadge();
            }
        }, 1000);
        
        // Stop checking after 30 seconds
        setTimeout(() => clearInterval(checkInterval), 30000);
    }
    
    /**
     * Check if we should auto-show morning review
     */
    function checkAutoShowMorningReview() {
        const hour = new Date().getHours();
        const lastShown = localStorage.getItem('lastMorningReviewDate');
        const today = new Date().toDateString();
        
        // Show automatically once per day in the morning (6am - 10am)
        if (hour >= 6 && hour <= 10 && lastShown !== today) {
            // Wait for dashboard to load
            setTimeout(() => {
                window.morningReview.renderMorningReview();
                localStorage.setItem('lastMorningReviewDate', today);
            }, 3000);
        }
    }
    
    /**
     * Add notification badge if there are overdue items
     */
    async function checkForNotificationBadge() {
        try {
            const clients = await window.clientManager.getAllClients();
            let overdueCount = 0;
            
            for (const client of clients) {
                if (client.status !== 'active') continue;
                
                const score = window.trackerEngine?.getCompletionScore(client);
                if (score && score.missingCritical) {
                    const daysInCare = window.trackerEngine.calculateDaysInCare(client.admissionDate);
                    const overdue = score.missingCritical.filter(item => daysInCare > item.dueByDay);
                    overdueCount += overdue.length;
                }
            }
            
            if (overdueCount > 0) {
                const morningBtn = document.querySelector('.btn-morning-review');
                if (morningBtn && !morningBtn.querySelector('.notification-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = overdueCount;
                    morningBtn.appendChild(badge);
                }
            }
        } catch (error) {
            console.error('Error checking for overdue items:', error);
        }
    }
    
    /**
     * Add keyboard shortcut
     */
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + M for Morning Review
        if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
            e.preventDefault();
            if (window.morningReview) {
                window.morningReview.renderMorningReview();
            }
        }
    });
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();

// Add notification badge styles
if (!document.querySelector('#morning-review-badge-styles')) {
    const style = document.createElement('style');
    style.id = 'morning-review-badge-styles';
    style.textContent = `
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
        
        .btn-morning-review {
            position: relative;
        }
    `;
    document.head.appendChild(style);
}


// Enhancement: quick-actions-complete.js
/**
 * Dashboard Quick Actions Enhancement
 * Completes implementation of all quick action buttons
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardWidgets || !window.clientManager || !window.showModal) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceQuickActions();
    }
    
    function waitForElement(getter, timeout = 4000) {
        return new Promise((resolve, reject) => {
            const start = Date.now();
            (function check() {
                const value = typeof getter === 'function' ? getter() : document.querySelector(getter);
                if (value) {
                    resolve(value);
                    return;
                }
                if (Date.now() - start > timeout) {
                    reject(new Error('Timeout waiting for element'));
                    return;
                }
                requestAnimationFrame(check);
            })();
        });
    }
    
    function enhanceQuickActions() {
        // Override quickGenerateDoc with full client-centric workflow
        window.dashboardWidgets.quickGenerateDoc = async function() {
            try {
                // Step 1: Select client
                const clients = await window.clientManager.getAllClients();
                const activeClients = clients.filter(c => c.status === 'active');
                
                if (activeClients.length === 0) {
                    window.showNotification('No active clients found', 'warning');
                    return;
                }
                
                // Build client selection HTML
                let clientOptionsHtml = `
                    <div class="client-selection-grid">
                        ${activeClients.map(client => {
                            const daysInCare = window.daysBetween(client.admissionDate) || 0;
                            // Get real tracker percentage
                            let trackerPercent = 0;
                            if (window.trackerEngine?.getCompletionScore) {
                                try {
                                    const score = window.trackerEngine.getCompletionScore(client);
                                    trackerPercent = score?.overallPercentage || 0;
                                } catch (e) { /* ignore */ }
                            }
                            return `
                                <label class="client-option">
                                    <input type="radio" name="selectedClient" value="${client.id}">
                                    <div class="client-card-mini">
                                        <span class="client-initials">${client.initials}</span>
                                        <span class="client-house">${client.houseId || 'No House'}</span>
                                        <span class="client-days">Day ${daysInCare}</span>
                                        <span class="client-tracker">Tracker: ${trackerPercent}%</span>
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>
                `;
                
                let selectedClientId = null;
                
                window.showModal({
                    title: '📄 Generate Document - Select Client',
                    content: clientOptionsHtml,
                    size: 'large',
                    buttons: [
                        {
                            text: 'Next',
                            primary: true,
                            action: () => {
                                const selected = document.querySelector('input[name="selectedClient"]:checked');
                                if (!selected) {
                                    window.showNotification('Please select a client', 'warning');
                                    return;
                                }
                                selectedClientId = selected.value;
                                window.closeModal();
                                selectDocumentType(selectedClientId);
                            }
                        },
                        {
                            text: 'Cancel',
                            action: () => window.closeModal()
                        }
                    ]
                });
                
            } catch (error) {
                console.error('Error in quickGenerateDoc:', error);
                window.showNotification('Failed to start document generation', 'error');
            }
        };
        
        window.dashboardWidgets.openDischargedClients = async function() {
            try {
                window.showNotification?.('Loading discharged archive…', 'info');
                
                if (typeof window.switchTab === 'function') {
                    window.switchTab('clients');
                }
                
                await waitForElement(() => document.getElementById('dischargedClientsView'));
                
                if (window.showDischargedClientsView) {
                    await window.showDischargedClientsView();
                    setTimeout(() => {
                        document.getElementById('dischargedClientsView')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 150);
                } else {
                    throw new Error('showDischargedClientsView unavailable');
                }
            } catch (error) {
                console.error('openDischargedClients error:', error);
                window.showNotification?.('Unable to open discharged archive right now.', 'error');
            }
        };
        
        // Step 2: Select document type
        async function selectDocumentType(clientId) {
            const client = await window.clientManager.getClient(clientId);
            const daysInCare = window.daysBetween(client.admissionDate) || 0;
            
            const documentTypes = [
                {
                    id: 'aftercare-options',
                    name: 'Aftercare Options',
                    icon: '📋',
                    description: 'Compare aftercare programs for family',
                    recommended: daysInCare >= 14
                },
                {
                    id: 'aftercare-plan',
                    name: 'Aftercare Plan',
                    icon: '📄',
                    description: 'Detailed placement plan',
                    recommended: daysInCare >= 21
                },
                {
                    id: 'discharge-packet',
                    name: 'Discharge Packet',
                    icon: '📦',
                    description: 'Complete discharge documentation',
                    recommended: daysInCare >= 25 || client.dischargeDate
                }
            ];
            
            const typeOptionsHtml = `
                <div class="selected-client-info">
                    <strong>Client:</strong> ${client.initials} - ${client.houseId} (Day ${daysInCare})
                </div>
                <div class="document-type-grid">
                    ${documentTypes.map(type => `
                        <label class="document-type-option ${type.recommended ? 'recommended' : ''}">
                            <input type="radio" name="documentType" value="${type.id}">
                            <div class="type-card">
                                <span class="type-icon">${type.icon}</span>
                                <span class="type-name">${type.name}</span>
                                <span class="type-description">${type.description}</span>
                                ${type.recommended ? '<span class="recommended-badge">Recommended</span>' : ''}
                            </div>
                        </label>
                    `).join('')}
                </div>
            `;
            
            window.showModal({
                title: '📄 Select Document Type',
                content: typeOptionsHtml,
                size: 'medium',
                buttons: [
                    {
                        text: 'Next',
                        primary: true,
                        action: async () => {
                            const selected = document.querySelector('input[name="documentType"]:checked');
                            if (!selected) {
                                window.showNotification('Please select a document type', 'warning');
                                return;
                            }
                            
                            // Clinical Workflow Check: Aftercare Plan requires Aftercare Options first
                            if (selected.value === 'aftercare-plan') {
                                // Check if client has an Aftercare Options document
                                const hasOptionsDoc = client.optionsDocUploaded || client.aftercareOptionsCreated;
                                
                                if (!hasOptionsDoc) {
                                    window.closeModal();
                                    showAftercarePlanWarning(client, daysInCare);
                                    return;
                                }
                            }
                            
                            window.closeModal();
                            
                            // For discharge packet, go directly to generation
                            if (selected.value === 'discharge-packet') {
                                generateDischargePacket(client);
                            } else {
                                // For other types, select programs
                                selectPrograms(client, selected.value);
                            }
                        }
                    },
                    {
                        text: 'Back',
                        action: () => {
                            window.closeModal();
                            window.dashboardWidgets.quickGenerateDoc();
                        }
                    }
                ]
            });
        }
        
        // Clinical Workflow Warning: Aftercare Plan without Options Doc
        function showAftercarePlanWarning(client, daysInCare) {
            const warningHtml = `
                <div class="workflow-warning">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-content">
                        <h4>Clinical Workflow Reminder</h4>
                        <p>Before creating an <strong>Aftercare Plan</strong>, the clinical process requires:</p>
                        <ol>
                            <li>Create an <strong>Aftercare Options</strong> document first</li>
                            <li>Present options to the family for review</li>
                            <li>Upload the Aftercare Options document to <strong>KIPU</strong></li>
                        </ol>
                        <p class="warning-note">If this step was approved to skip by a supervisor, please confirm with your CareConnect admin.</p>
                    </div>
                </div>
            `;
            
            window.showModal({
                title: '📋 Aftercare Workflow Check',
                content: warningHtml,
                size: 'medium',
                buttons: [
                    {
                        text: 'Create Options Doc First',
                        primary: true,
                        action: () => {
                            window.closeModal();
                            selectPrograms(client, 'aftercare-options');
                        }
                    },
                    {
                        text: 'Supervisor Approved - Continue',
                        action: () => {
                            // Log this bypass for audit
                            console.log('[Workflow] Supervisor approval bypass for Aftercare Plan:', client.initials);
                            if (window.clientManager?.updateClient) {
                                window.clientManager.updateClient(client.id, {
                                    aftercarePlanBypassDate: new Date().toISOString(),
                                    aftercarePlanBypassNote: 'Supervisor approved skip of Aftercare Options'
                                });
                            }
                            window.closeModal();
                            selectPrograms(client, 'aftercare-plan');
                        }
                    },
                    {
                        text: 'Go Back',
                        action: () => {
                            window.closeModal();
                            selectDocumentType(client.id);
                        }
                    }
                ]
            });
        }
        
        // Step 3: Select programs (for non-discharge documents)
        async function selectPrograms(client, documentType) {
            // Switch to programs tab to ensure programs are loaded
            window.switchTab('programs');
            
            // Wait for programs to load
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Pre-select client in the Programs module document model
            if (window.ccDocumentModel?.setClient) {
                window.ccDocumentModel.setClient(client.id, client.initials);
            }
            
            // Also update the client selector dropdown if it exists
            const clientSelector = document.getElementById('clientSelector');
            if (clientSelector) {
                clientSelector.value = client.id;
                // Trigger change event to update UI
                clientSelector.dispatchEvent(new Event('change'));
            }
            
            // Set document type in the model
            if (window.ccDocumentModel?.setDocumentType) {
                const docTypeMap = {
                    'aftercare-options': 'AFTERCARE_OPTIONS',
                    'aftercare-plan': 'AFTERCARE_PLAN'
                };
                window.ccDocumentModel.setDocumentType(docTypeMap[documentType] || 'AFTERCARE_OPTIONS');
            }
            
            // Show helpful notification
            window.showNotification(`Client ${client.initials} selected. Add programs to the builder, then click Generate.`, 'success', '', 5000);
            
            // Store context for document generation
            window.documentGenerationContext = {
                clientId: client.id,
                client: client,
                documentType: documentType
            };
        }
        
        // Generate discharge packet
        async function generateDischargePacket(client) {
            window.showNotification('Generating discharge packet...', 'info');
            
            // Switch to programs tab and trigger discharge packet creation
            window.switchTab('programs');
            
            // Store context
            window.documentGenerationContext = {
                clientId: client.id,
                client: client,
                documentType: 'discharge-packet'
            };
            
            // Wait for tab to load then trigger
            setTimeout(() => {
                if (window.createDischargePacket) {
                    window.createDischargePacket();
                }
            }, 500);
        }
        
        // Enhanced viewAllAlerts with filtering and actions
        window.dashboardWidgets.viewAllAlerts = async function() {
            const alerts = window.dashboardManager.cache.priorities;
            let currentFilter = 'all';
            
            function renderAlertsModal() {
                const zones = ['red', 'purple', 'yellow', 'green'];
                let filteredAlerts = {};
                
                // Apply filter
                if (currentFilter === 'all') {
                    filteredAlerts = alerts;
                } else {
                    filteredAlerts[currentFilter] = alerts[currentFilter] || [];
                }
                
                let content = `
                    <div class="alerts-modal-header">
                        <div class="alert-filters">
                            <button class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" 
                                    onclick="window.filterAlerts('all')">All Zones</button>
                            ${zones.map(zone => `
                                <button class="filter-btn zone-${zone} ${currentFilter === zone ? 'active' : ''}" 
                                        onclick="window.filterAlerts('${zone}')">
                                    ${zone.charAt(0).toUpperCase() + zone.slice(1)} (${(alerts[zone] || []).length})
                                </button>
                            `).join('')}
                        </div>
                        <div class="alert-actions">
                            <button class="btn btn-sm" onclick="window.exportAlerts()">
                                📊 Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="alerts-content">
                `;
                
                let hasAlerts = false;
                
                for (const [zone, items] of Object.entries(filteredAlerts)) {
                    if (!items || items.length === 0) continue;
                    hasAlerts = true;
                    
                    content += `
                        <div class="alert-zone-section">
                            <h4 class="zone-header zone-${zone}">
                                ${zone.charAt(0).toUpperCase() + zone.slice(1)} Zone
                            </h4>
                            <div class="alert-items">
                    `;
                    
                    for (const item of items) {
                        content += `
                            <div class="alert-item" onclick="window.navigateToAlert('${item.client.id}', '${item.type}')">
                                <div class="alert-client">
                                    <span class="client-badge">${item.client.initials}</span>
                                    <span class="house-badge">${item.client.houseId}</span>
                                </div>
                                <div class="alert-details">
                                    <div class="alert-message">${item.message}</div>
                                    ${item.dueDate ? `<div class="alert-due">Due: ${item.dueDate}</div>` : ''}
                                </div>
                                <div class="alert-actions">
                                    ${item.isTrackerTask ? 
                                        `<button class="btn btn-sm btn-success" 
                                                onclick="event.stopPropagation(); window.completeAlert('${item.client.id}', '${item.trackerId}')">
                                            ✓ Complete
                                        </button>` : 
                                        `<button class="btn btn-sm" 
                                                onclick="event.stopPropagation(); window.takeAlertAction('${item.type}', '${item.client.id}')">
                                            ${item.action || 'View'}
                                        </button>`
                                    }
                                </div>
                            </div>
                        `;
                    }
                    
                    content += `
                            </div>
                        </div>
                    `;
                }
                
                if (!hasAlerts) {
                    content += `
                        <div class="empty-state">
                            <p>No alerts found${currentFilter !== 'all' ? ' in ' + currentFilter + ' zone' : ''}</p>
                        </div>
                    `;
                }
                
                content += '</div>';
                
                return content;
            }
            
            // Global functions for modal interactions
            window.filterAlerts = function(filter) {
                currentFilter = filter;
                const modalBody = document.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.innerHTML = renderAlertsModal();
                }
            };
            
            window.navigateToAlert = function(clientId, type) {
                // Emit event for onboarding checklist
                if (window.OnboardingEvents) {
                    OnboardingEvents.emit('cc:flightPlan:taskOpened', { clientId, type });
                }
                window.dispatchEvent(new CustomEvent('cc:flightPlan:taskOpened', { detail: { clientId, type } }));
                console.log('[FlightPlan] Emitted cc:flightPlan:taskOpened to window (navigateToAlert)');
                
                window.closeModal();
                window.viewClientDetails(clientId);
            };
            
            window.completeAlert = async function(clientId, trackerId) {
                await window.dashboardWidgets.completeTrackerItem(clientId, trackerId);
                // Refresh modal
                window.dashboardManager.refreshDashboard();
                window.filterAlerts(currentFilter);
            };
            
            window.takeAlertAction = function(type, clientId) {
                window.closeModal();
                window.dashboardWidgets.takeAction(`action-${type}-${clientId}`, type, clientId);
            };
            
            window.exportAlerts = function() {
                const csv = generateAlertsCSV(alerts);
                downloadCSV(csv, `alerts-${new Date().toISOString().split('T')[0]}.csv`);
                window.showNotification('Alerts exported successfully', 'success');
            };
            
            // Show modal
            window.showModal({
                title: '🔔 All Alerts',
                content: renderAlertsModal(),
                size: 'large',
                buttons: [
                    {
                        text: 'Close',
                        action: () => window.closeModal()
                    }
                ]
            });
        };
        
        // Enhanced exportDashboard
        window.dashboardWidgets.exportDashboard = async function() {
            try {
                const data = {
                    exportDate: new Date().toISOString(),
                    coach: window.getCurrentCoach?.() || 'Unknown',
                    summary: {
                        totalClients: 0,
                        activeClients: 0,
                        criticalAlerts: 0,
                        todayTasks: 0
                    },
                    alerts: window.dashboardManager.cache.priorities,
                    clients: [],
                    milestones: []
                };
                
                // Gather all data
                const clients = await window.clientManager.getAllClients();
                data.summary.totalClients = clients.length;
                data.summary.activeClients = clients.filter(c => c.status === 'active').length;
                data.summary.criticalAlerts = (data.alerts.red || []).length;
                
                // Calculate today's tasks
                for (const zone of Object.values(data.alerts)) {
                    data.summary.todayTasks += zone.filter(item => 
                        item.dueDate && item.dueDate.includes('today')
                    ).length;
                }
                
                // Add client details
                for (const client of clients) {
                    const clientData = {
                        initials: client.initials,
                        house: client.houseId,
                        status: client.status,
                        admissionDate: client.admissionDate,
                        daysInCare: window.daysBetween(client.admissionDate),
                        trackerCompletion: 0
                    };
                    
                    // Calculate tracker completion
                    if (window.trackerEngine) {
                        const score = window.trackerEngine.getCompletionScore(client);
                        clientData.trackerCompletion = score.percentage;
                    }
                    
                    data.clients.push(clientData);
                }
                
                // Generate CSV
                const csv = generateDashboardCSV(data);
                downloadCSV(csv, `dashboard-export-${new Date().toISOString().split('T')[0]}.csv`);
                
                window.showNotification('Dashboard exported successfully', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                window.showNotification('Failed to export dashboard', 'error');
            }
        };
        
        // Enhanced enterFocusMode
        window.dashboardWidgets.enterFocusMode = function() {
            // Check if already in focus mode
            if (document.body.classList.contains('focus-mode')) {
                exitFocusMode();
                return;
            }
            
            // Enter focus mode
            document.body.classList.add('focus-mode');
            
            // Hide non-essential elements
            const elementsToHide = [
                '.header-controls',
                '.dashboard-controls',
                '#quickActionsWidget',
                '#missionsWidget',
                '.zone-yellow',
                '.zone-green'
            ];
            
            elementsToHide.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    el.dataset.focusHidden = 'true';
                    el.style.display = 'none';
                });
            });
            
            // Expand critical zones
            const redZone = document.querySelector('.zone-red');
            const purpleZone = document.querySelector('.zone-purple');
            
            if (redZone) {
                const content = redZone.querySelector('.zone-content');
                if (content) content.classList.add('expanded');
            }
            
            if (purpleZone) {
                const content = purpleZone.querySelector('.zone-content');
                if (content) content.classList.add('expanded');
            }
            
            // Add focus mode indicator
            const indicator = document.createElement('div');
            indicator.className = 'focus-mode-indicator';
            indicator.innerHTML = `
                <span>🎯 Focus Mode Active</span>
                <button onclick="window.dashboardWidgets.enterFocusMode()">Exit</button>
            `;
            document.body.appendChild(indicator);
            
            window.showNotification('Focus mode activated - showing only critical tasks', 'info');
        };
        
        function exitFocusMode() {
            document.body.classList.remove('focus-mode');
            
            // Restore hidden elements
            document.querySelectorAll('[data-focus-hidden="true"]').forEach(el => {
                el.style.display = '';
                delete el.dataset.focusHidden;
            });
            
            // Remove indicator
            const indicator = document.querySelector('.focus-mode-indicator');
            if (indicator) indicator.remove();
            
            window.showNotification('Focus mode deactivated', 'info');
        }
        
        // Helper functions
        function generateAlertsCSV(alerts) {
            let csv = 'Zone,Client,House,Message,Due Date,Type\n';
            
            for (const [zone, items] of Object.entries(alerts)) {
                for (const item of items) {
                    csv += `"${zone}","${item.client.initials}","${item.client.houseId}",`;
                    csv += `"${item.message.replace(/"/g, '""')}","${item.dueDate || ''}","${item.type}"\n`;
                }
            }
            
            return csv;
        }
        
        function generateDashboardCSV(data) {
            let csv = 'Dashboard Export\n';
            csv += `Export Date,${data.exportDate}\n`;
            csv += `Coach,${data.coach}\n\n`;
            
            csv += 'Summary\n';
            csv += `Total Clients,${data.summary.totalClients}\n`;
            csv += `Active Clients,${data.summary.activeClients}\n`;
            csv += `Critical Alerts,${data.summary.criticalAlerts}\n`;
            csv += `Today's Tasks,${data.summary.todayTasks}\n\n`;
            
            csv += 'Client Details\n';
            csv += 'Initials,House,Status,Admission Date,Days in Care,Tracker Completion\n';
            
            for (const client of data.clients) {
                csv += `${client.initials},${client.house},${client.status},`;
                csv += `${client.admissionDate},${client.daysInCare},${client.trackerCompletion}%\n`;
            }
            
            return csv;
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Add styles
        if (!document.querySelector('#quick-actions-styles')) {
            const styles = document.createElement('style');
            styles.id = 'quick-actions-styles';
            styles.textContent = `
                /* Client Selection Grid */
                .client-selection-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                    gap: 12px;
                    max-height: 400px;
                    overflow-y: auto;
                    padding: 4px;
                }
                
                .client-option {
                    cursor: pointer;
                }
                
                .client-option input {
                    position: absolute;
                    opacity: 0;
                }
                
                .client-card-mini {
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 12px;
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    transition: all 0.2s;
                }
                
                .client-option input:checked + .client-card-mini {
                    border-color: var(--ccp-primary-500);
                    background: var(--ccp-primary-100);
                }
                
                .client-card-mini:hover {
                    border-color: var(--ccp-primary-300);
                }
                
                .client-tracker {
                    font-size: 12px;
                    color: #6b7280;
                    padding-top: 4px;
                    border-top: 1px solid #e5e7eb;
                    margin-top: 4px;
                }
                
                /* Workflow Warning */
                .workflow-warning {
                    display: flex;
                    gap: 16px;
                    padding: 20px;
                    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                    border-radius: 12px;
                    border-left: 4px solid #f59e0b;
                }
                
                .workflow-warning .warning-icon {
                    font-size: 32px;
                    flex-shrink: 0;
                }
                
                .workflow-warning .warning-content h4 {
                    margin: 0 0 12px 0;
                    color: #92400e;
                    font-size: 18px;
                }
                
                .workflow-warning .warning-content p {
                    margin: 0 0 12px 0;
                    color: #78350f;
                }
                
                .workflow-warning .warning-content ol {
                    margin: 0 0 16px 0;
                    padding-left: 20px;
                    color: #78350f;
                }
                
                .workflow-warning .warning-content ol li {
                    margin-bottom: 8px;
                }
                
                .workflow-warning .warning-note {
                    font-size: 13px;
                    font-style: italic;
                    color: #92400e;
                    padding: 10px;
                    background: rgba(255,255,255,0.5);
                    border-radius: 6px;
                    margin-bottom: 0 !important;
                }
                
                /* Document Type Selection */
                .selected-client-info {
                    padding: 12px;
                    background: #f3f4f6;
                    border-radius: 6px;
                    margin-bottom: 16px;
                }
                
                .document-type-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 16px;
                }
                
                .document-type-option input {
                    position: absolute;
                    opacity: 0;
                }
                
                .type-card {
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 16px;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                    position: relative;
                }
                
                .document-type-option input:checked + .type-card {
                    border-color: var(--ccp-primary-500);
                    background: var(--ccp-primary-100);
                }
                
                .document-type-option.recommended .type-card {
                    border-color: var(--ccp-success-500);
                }
                
                .type-icon {
                    font-size: 32px;
                    text-align: center;
                }
                
                .type-name {
                    font-weight: 600;
                    font-size: 16px;
                }
                
                .type-description {
                    font-size: 14px;
                    color: #6b7280;
                }
                
                .recommended-badge {
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background: var(--ccp-success-500);
                    color: white;
                    font-size: 11px;
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-weight: 600;
                }
                
                /* Alerts Modal */
                .alerts-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 16px;
                    border-bottom: 1px solid #e5e7eb;
                }
                
                .alert-filters {
                    display: flex;
                    gap: 8px;
                }
                
                .filter-btn {
                    padding: 6px 12px;
                    border: 1px solid #e5e7eb;
                    background: white;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .filter-btn.active {
                    background: var(--ccp-primary-500);
                    color: white;
                    border-color: var(--ccp-primary-500);
                }
                
                .filter-btn.zone-red.active {
                    background: #ef4444;
                    border-color: #ef4444;
                }
                
                .filter-btn.zone-purple.active {
                    background: #a855f7;
                    border-color: #a855f7;
                }
                
                .filter-btn.zone-yellow.active {
                    background: #eab308;
                    border-color: #eab308;
                }
                
                .filter-btn.zone-green.active {
                    background: #22c55e;
                    border-color: #22c55e;
                }
                
                .alerts-content {
                    max-height: 500px;
                    overflow-y: auto;
                }
                
                .alert-zone-section {
                    margin-bottom: 24px;
                }
                
                .zone-header {
                    font-size: 16px;
                    font-weight: 600;
                    margin-bottom: 12px;
                    padding-left: 12px;
                    border-left: 4px solid;
                }
                
                .zone-header.zone-red {
                    border-left-color: #ef4444;
                    color: #dc2626;
                }
                
                .zone-header.zone-purple {
                    border-left-color: #a855f7;
                    color: #9333ea;
                }
                
                .zone-header.zone-yellow {
                    border-left-color: #eab308;
                    color: #ca8a04;
                }
                
                .zone-header.zone-green {
                    border-left-color: #22c55e;
                    color: #16a34a;
                }
                
                .alert-item {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 12px;
                    border: 1px solid #e5e7eb;
                    border-radius: 6px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .alert-item:hover {
                    background: #f9fafb;
                    border-color: #d1d5db;
                }
                
                .alert-client {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                    flex-shrink: 0;
                }
                
                .alert-details {
                    flex: 1;
                }
                
                .alert-message {
                    font-size: 14px;
                }
                
                .alert-due {
                    font-size: 12px;
                    color: #6b7280;
                    margin-top: 2px;
                }
                
                /* Focus Mode */
                .focus-mode-indicator {
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #1f2937;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                }
                
                .focus-mode-indicator button {
                    background: white;
                    color: #1f2937;
                    border: none;
                    padding: 4px 12px;
                    border-radius: 12px;
                    cursor: pointer;
                    font-size: 12px;
                }
                
                body.focus-mode .dashboard-widget:not(#flightPlanWidget) {
                    opacity: 0.3;
                }
                
                body.focus-mode #flightPlanWidget {
                    transform: scale(1.05);
                    transition: transform 0.3s;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('✅ Quick actions enhanced successfully');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: document-generator-ui.js
/**
 * Document Generator UI Integration
 * Adds document generation buttons throughout the UI
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.documentGenerator || !window.dashboardWidgets || !window.clientManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        integrateDocumentGenerator();
    }
    
    function integrateDocumentGenerator() {
        // Add document generation button to dashboard header
        let dashboardButtonAdded = false;
        const addDashboardButton = () => {
            if (dashboardButtonAdded) return;
            
            const dashboardControls = document.querySelector('.dashboard-controls');
            if (dashboardControls && !document.querySelector('#btnGenerateDoc')) {
                const button = document.createElement('button');
                button.id = 'btnGenerateDoc';
                button.className = 'btn btn-primary';
                button.innerHTML = '📄 Generate Document';
                button.onclick = () => window.generateDocument();
                
                // Insert before the first button
                const firstButton = dashboardControls.querySelector('button');
                if (firstButton && firstButton.parentNode === dashboardControls) {
                    try {
                        dashboardControls.insertBefore(button, firstButton);
                        dashboardButtonAdded = true;
                    } catch (err) {
                        console.warn('Could not insert button before first button:', err);
                        dashboardControls.appendChild(button);
                        dashboardButtonAdded = true;
                    }
                } else {
                    dashboardControls.appendChild(button);
                    dashboardButtonAdded = true;
                }
            }
        };
        
        // Enhance client cards with quick document generation
        const originalRenderClient = window.dashboardWidgets?.renderClient;
        if (originalRenderClient) {
            window.dashboardWidgets.renderClient = function(client) {
                let html = originalRenderClient.call(this, client);
                
                // Add document generation button to client card actions
                const daysInCare = window.daysBetween(client.admissionDate) || 0;
                const hasRecommendedDocs = window.documentGenerator.getRecommendedDocuments(client, daysInCare).length > 0;
                
                if (hasRecommendedDocs) {
                    const buttonHtml = `
                        <button class="btn-doc-gen-quick" 
                                onclick="window.generateDocument('${client.id}')"
                                title="Generate document for ${client.initials}">
                            📄
                        </button>
                    `;
                    
                    // Insert button before the last closing div
                    const insertPos = html.lastIndexOf('</div>');
                    html = html.slice(0, insertPos) + buttonHtml + html.slice(insertPos);
                }
                
                return html;
            };
        }
        
        // Override the quickGenerateDoc to use our new system
        if (window.dashboardWidgets?.quickGenerateDoc) {
            window.dashboardWidgets.quickGenerateDoc = function() {
                window.generateDocument();
            };
        }
        
        // Add keyboard shortcut (Ctrl+D for document)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                window.generateDocument();
            }
        });
        
        // Listen for document generation events to refresh dashboard
        window.addEventListener('document:generated', (e) => {
            console.log('Document generated:', e.detail);
            
            // Refresh dashboard if available
            if (window.dashboardManager) {
                window.dashboardManager.refreshDashboard();
            }
            
            // Update tracker display if visible
            const trackerModal = document.querySelector('.tracker-modal');
            if (trackerModal) {
                const clientId = e.detail.clientId;
                // Refresh tracker display
                if (window.TrackerBulkUpdate?.instance) {
                    window.TrackerBulkUpdate.instance.loadClients();
                }
            }
        });
        
        // Add document generation to client details modal
        const originalShowClientDetailsModal = window.showClientDetailsModal;
        if (originalShowClientDetailsModal) {
            window.showClientDetailsModal = async function(client) {
                // Call original function
                await originalShowClientDetailsModal.call(this, client);
                
                // Add document section to the modal after a delay
                setTimeout(() => {
                    const modalBody = document.querySelector('.modal-body');
                    if (modalBody && !modalBody.querySelector('.client-documents-section')) {
                        const documents = window.documentGenerator.getClientDocuments(client.id);
                        const daysInCare = window.daysBetween(client.admissionDate) || 0;
                        const recommended = window.documentGenerator.getRecommendedDocuments(client, daysInCare);
                        
                        const documentsHtml = `
                            <div class="client-documents-section">
                                <h4>📄 Documents</h4>
                                
                                ${recommended.length > 0 ? `
                                    <div class="recommended-documents">
                                        <h5>Recommended Documents</h5>
                                        <div class="doc-recommendations">
                                            ${recommended.map(doc => `
                                                <button class="btn-doc-recommend" 
                                                        onclick="window.generateDocument('${client.id}', '${doc.key}')">
                                                    ${doc.icon} ${doc.name}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="document-history">
                                    <h5>Document History</h5>
                                    ${documents.length > 0 ? `
                                        <div class="doc-history-list">
                                            ${documents.map(doc => `
                                                <div class="doc-history-item">
                                                    <span class="doc-icon">${window.documentGenerator.documentTypes[doc.type]?.icon || '📄'}</span>
                                                    <span class="doc-name">${doc.name}</span>
                                                    <span class="doc-date">${window.formatDate(doc.createdAt)}</span>
                                                    <button class="btn-doc-action" onclick="window.documentGenerator.viewDocument('${doc.id}')">View</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : '<p class="no-documents">No documents generated yet</p>'}
                                    
                                    <button class="btn btn-primary btn-sm" onclick="window.generateDocument('${client.id}')">
                                        Generate New Document
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        modalBody.insertAdjacentHTML('beforeend', documentsHtml);
                    }
                }, 200);
            };
        }
        
        // Add styles
        if (!document.querySelector('#document-generator-ui-styles')) {
            const styles = document.createElement('style');
            styles.id = 'document-generator-ui-styles';
            styles.textContent = `
                /* Dashboard button */
                #btnGenerateDoc {
                    margin-right: 8px;
                }
                
                /* Client card quick button */
                .btn-doc-gen-quick {
                    position: absolute;
                    top: 8px;
                    right: 40px;
                    background: var(--ccp-primary-100);
                    border: 1px solid var(--ccp-primary-300);
                    border-radius: 6px;
                    padding: 4px 8px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .btn-doc-gen-quick:hover {
                    background: var(--ccp-primary-200);
                    transform: translateY(-1px);
                }
                
                /* Client documents section */
                .client-documents-section {
                    margin-top: 24px;
                    padding-top: 24px;
                    border-top: 2px solid #e5e7eb;
                }
                
                .client-documents-section h4 {
                    margin: 0 0 16px 0;
                    color: #1f2937;
                }
                
                .client-documents-section h5 {
                    margin: 0 0 12px 0;
                    color: #374151;
                    font-size: 16px;
                }
                
                .recommended-documents {
                    background: #f0f9ff;
                    padding: 16px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                }
                
                .doc-recommendations {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                }
                
                .btn-doc-recommend {
                    background: white;
                    border: 1px solid #3b82f6;
                    color: #3b82f6;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-size: 14px;
                }
                
                .btn-doc-recommend:hover {
                    background: #3b82f6;
                    color: white;
                }
                
                .document-history {
                    background: #f9fafb;
                    padding: 16px;
                    border-radius: 8px;
                }
                
                .doc-history-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    margin-bottom: 16px;
                }
                
                .doc-history-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px;
                    background: white;
                    border-radius: 6px;
                    border: 1px solid #e5e7eb;
                }
                
                .doc-history-item .doc-icon {
                    font-size: 20px;
                }
                
                .doc-history-item .doc-name {
                    flex: 1;
                    font-size: 14px;
                }
                
                .doc-history-item .doc-date {
                    font-size: 12px;
                    color: #6b7280;
                }
                
                .btn-doc-action {
                    background: none;
                    border: 1px solid #e5e7eb;
                    padding: 4px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .btn-doc-action:hover {
                    background: #f3f4f6;
                    border-color: #d1d5db;
                }
                
                .no-documents {
                    text-align: center;
                    color: #6b7280;
                    font-style: italic;
                    margin: 16px 0;
                }
            `;
            document.head.appendChild(styles);
        }
        
        // Initialize dashboard button after DOM updates
        setTimeout(addDashboardButton, 500);
        
        // Re-add button when dashboard refreshes
        const observer = new MutationObserver(() => {
            addDashboardButton();
        });
        
        const dashboardContainer = document.querySelector('#dashboardTab');
        if (dashboardContainer) {
            observer.observe(dashboardContainer, { childList: true, subtree: true });
        }
        
        console.log('✅ Document Generator UI integration complete');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: client-document-storage.js
/**
 * Client Document Storage Enhancement
 * Adds document storage to client records and document management features
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.clientManager || !window.documentGenerator) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceClientStorage();
    }
    
    function enhanceClientStorage() {
        // Extend client schema to include documents
        const originalCreateClient = window.clientManager.createClient;
        window.clientManager.createClient = async function(clientData) {
            // Ensure documents array exists
            clientData.documents = clientData.documents || [];
            return originalCreateClient.call(this, clientData);
        };
        
        // Extend update to handle documents
        const originalUpdateClient = window.clientManager.updateClient;
        window.clientManager.updateClient = async function(clientId, updates) {
            // If documents are being updated, handle special logic
            if (updates.documents) {
                const client = await this.getClient(clientId);
                if (client) {
                    // Merge documents arrays if adding
                    if (updates.$addToDocuments) {
                        updates.documents = [...(client.documents || []), ...updates.$addToDocuments];
                        delete updates.$addToDocuments;
                    }
                }
            }
            
            return originalUpdateClient.call(this, clientId, updates);
        };
        
        // Add method to add document to client
        window.clientManager.addDocument = async function(clientId, document) {
            const client = await this.getClient(clientId);
            if (!client) {
                throw new Error('Client not found');
            }
            
            // Ensure documents array exists
            if (!client.documents) {
                client.documents = [];
            }
            
            // Add document
            client.documents.push({
                ...document,
                addedAt: new Date().toISOString()
            });
            
            // Update client
            await this.updateClient(clientId, { documents: client.documents });
            
            return document;
        };
        
        // Add method to get client documents
        window.clientManager.getClientDocuments = async function(clientId) {
            const client = await this.getClient(clientId);
            return client?.documents || [];
        };
        
        // Override document generator to store with client
        const originalGenerateDocument = window.documentGenerator.generateDocument;
        window.documentGenerator.generateDocument = async function() {
            // Call original
            await originalGenerateDocument.call(this);
            
            // Get the generated document
            const workflow = this.activeWorkflow;
            if (workflow && workflow.client) {
                const lastDocument = this.generatedDocuments[this.generatedDocuments.length - 1];
                if (lastDocument) {
                    // Store with client
                    await window.clientManager.addDocument(workflow.client.id, lastDocument);
                    
                    // Fire event
                    window.dispatchEvent(new CustomEvent('client:documentAdded', {
                        detail: {
                            clientId: workflow.client.id,
                            document: lastDocument
                        }
                    }));
                }
            }
        };
        
        // Override getClientDocuments to use client storage
        window.documentGenerator.getClientDocuments = function(clientId) {
            // First check in-memory storage
            const inMemory = this.generatedDocuments.filter(doc => doc.clientId === clientId);
            
            // Then check client storage (async, so return promise)
            return window.clientManager.getClientDocuments(clientId).then(stored => {
                // Merge and deduplicate by ID
                const allDocs = [...inMemory];
                stored.forEach(doc => {
                    if (!allDocs.find(d => d.id === doc.id)) {
                        allDocs.push(doc);
                    }
                });
                
                // Sort by date (newest first)
                allDocs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                return allDocs;
            }).catch(() => inMemory); // Fallback to in-memory if error
        };
        
        // Add document vault functionality
        window.documentVault = {
            async getAllDocuments() {
                const clients = await window.clientManager.getAllClients();
                const allDocuments = [];
                
                for (const client of clients) {
                    const documents = await window.clientManager.getClientDocuments(client.id);
                    documents.forEach(doc => {
                        allDocuments.push({
                            ...doc,
                            clientInitials: client.initials,
                            clientHouse: client.houseId,
                            clientStatus: client.status
                        });
                    });
                }
                
                // Sort by date (newest first)
                allDocuments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                return allDocuments;
            },
            
            async searchDocuments(searchTerm) {
                const allDocs = await this.getAllDocuments();
                const term = searchTerm.toLowerCase();
                
                return allDocs.filter(doc => 
                    doc.name.toLowerCase().includes(term) ||
                    doc.clientInitials.toLowerCase().includes(term) ||
                    doc.type.toLowerCase().includes(term) ||
                    (doc.clientHouse && doc.clientHouse.toLowerCase().includes(term))
                );
            },
            
            async getDocumentsByType(type) {
                const allDocs = await this.getAllDocuments();
                return allDocs.filter(doc => doc.type === type);
            },
            
            async getDocumentsByDateRange(startDate, endDate) {
                const allDocs = await this.getAllDocuments();
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                return allDocs.filter(doc => {
                    const docDate = new Date(doc.createdAt);
                    return docDate >= start && docDate <= end;
                });
            },
            
            showVault() {
                window.showModal({
                    title: '🗃️ Document Vault',
                    content: '<div id="documentVaultContent">Loading...</div>',
                    size: 'large',
                    buttons: [
                        {
                            text: 'Export All',
                            action: () => this.exportAll()
                        },
                        {
                            text: 'Close',
                            primary: true,
                            action: () => window.closeModal()
                        }
                    ]
                });
                
                // Load vault content
                this.loadVaultContent();
            },
            
            async loadVaultContent() {
                const contentEl = document.getElementById('documentVaultContent');
                if (!contentEl) return;
                
                try {
                    const documents = await this.getAllDocuments();
                    
                    contentEl.innerHTML = `
                        <div class="vault-header">
                            <div class="vault-stats">
                                <span class="stat-item">📄 ${documents.length} Total Documents</span>
                            </div>
                            <div class="vault-search">
                                <input type="text" id="vaultSearch" placeholder="Search documents..." class="vault-search-input">
                                <select id="vaultTypeFilter" class="vault-filter">
                                    <option value="">All Types</option>
                                    <option value="aftercare-options">Aftercare Options</option>
                                    <option value="aftercare-plan">Aftercare Plan</option>
                                    <option value="discharge-packet">Discharge Packet</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="vault-documents" id="vaultDocumentsList">
                            ${documents.length > 0 ? documents.map(doc => `
                                <div class="vault-doc-item">
                                    <div class="vault-doc-icon">${window.documentGenerator.documentTypes[doc.type]?.icon || '📄'}</div>
                                    <div class="vault-doc-info">
                                        <div class="vault-doc-name">${doc.name}</div>
                                        <div class="vault-doc-meta">
                                            <span class="meta-item">👤 ${doc.clientInitials}</span>
                                            <span class="meta-item">🏠 ${doc.clientHouse || 'No House'}</span>
                                            <span class="meta-item">📅 ${window.formatDate(doc.createdAt)}</span>
                                            <span class="meta-item">✍️ ${doc.createdBy}</span>
                                        </div>
                                    </div>
                                    <div class="vault-doc-actions">
                                        <button class="btn btn-sm" onclick="window.documentGenerator.viewDocument('${doc.id}')">View</button>
                                        <button class="btn btn-sm" onclick="window.documentGenerator.printDocument('${doc.id}')">Print</button>
                                    </div>
                                </div>
                            `).join('') : '<p class="vault-empty">No documents in vault</p>'}
                        </div>
                    `;
                    
                    // Add search functionality
                    const searchInput = document.getElementById('vaultSearch');
                    const typeFilter = document.getElementById('vaultTypeFilter');
                    
                    const filterDocuments = async () => {
                        const searchTerm = searchInput.value;
                        const typeValue = typeFilter.value;
                        
                        let filtered = documents;
                        
                        if (searchTerm) {
                            filtered = await this.searchDocuments(searchTerm);
                        }
                        
                        if (typeValue) {
                            filtered = filtered.filter(doc => doc.type === typeValue);
                        }
                        
                        // Update list
                        const listEl = document.getElementById('vaultDocumentsList');
                        if (filtered.length > 0) {
                            listEl.innerHTML = filtered.map(doc => `
                                <div class="vault-doc-item">
                                    <div class="vault-doc-icon">${window.documentGenerator.documentTypes[doc.type]?.icon || '📄'}</div>
                                    <div class="vault-doc-info">
                                        <div class="vault-doc-name">${doc.name}</div>
                                        <div class="vault-doc-meta">
                                            <span class="meta-item">👤 ${doc.clientInitials}</span>
                                            <span class="meta-item">🏠 ${doc.clientHouse || 'No House'}</span>
                                            <span class="meta-item">📅 ${window.formatDate(doc.createdAt)}</span>
                                            <span class="meta-item">✍️ ${doc.createdBy}</span>
                                        </div>
                                    </div>
                                    <div class="vault-doc-actions">
                                        <button class="btn btn-sm" onclick="window.documentGenerator.viewDocument('${doc.id}')">View</button>
                                        <button class="btn btn-sm" onclick="window.documentGenerator.printDocument('${doc.id}')">Print</button>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            listEl.innerHTML = '<p class="vault-empty">No documents match your search</p>';
                        }
                    };
                    
                    searchInput.addEventListener('input', window.debounce(filterDocuments, 300));
                    typeFilter.addEventListener('change', filterDocuments);
                    
                } catch (error) {
                    console.error('Error loading vault:', error);
                    contentEl.innerHTML = '<p class="vault-error">Error loading documents</p>';
                }
            },
            
            async exportAll() {
                try {
                    const documents = await this.getAllDocuments();
                    
                    let csv = 'Document Name,Type,Client,House,Created Date,Created By\n';
                    
                    documents.forEach(doc => {
                        csv += `"${doc.name}","${doc.type}","${doc.clientInitials}",`;
                        csv += `"${doc.clientHouse || ''}","${window.formatDate(doc.createdAt)}","${doc.createdBy}"\n`;
                    });
                    
                    // Download CSV
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `document-vault-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    window.showNotification('Document vault exported successfully', 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    window.showNotification('Failed to export document vault', 'error');
                }
            }
        };
        
        // Add styles
        if (!document.querySelector('#client-document-storage-styles')) {
            const styles = document.createElement('style');
            styles.id = 'client-document-storage-styles';
            styles.textContent = `
                /* Document Vault Styles */
                .vault-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 16px;
                    border-bottom: 2px solid #e5e7eb;
                }
                
                .vault-stats {
                    display: flex;
                    gap: 20px;
                }
                
                .stat-item {
                    font-size: 16px;
                    font-weight: 500;
                    color: #374151;
                }
                
                .vault-search {
                    display: flex;
                    gap: 12px;
                }
                
                .vault-search-input {
                    width: 250px;
                    padding: 8px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                }
                
                .vault-filter {
                    padding: 8px 12px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-size: 14px;
                    background: white;
                }
                
                .vault-documents {
                    max-height: 500px;
                    overflow-y: auto;
                }
                
                .vault-doc-item {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                    padding: 16px;
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    transition: all 0.2s;
                }
                
                .vault-doc-item:hover {
                    background: #f9fafb;
                    border-color: #d1d5db;
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                }
                
                .vault-doc-icon {
                    font-size: 32px;
                    flex-shrink: 0;
                }
                
                .vault-doc-info {
                    flex: 1;
                }
                
                .vault-doc-name {
                    font-weight: 600;
                    font-size: 16px;
                    color: #1f2937;
                    margin-bottom: 4px;
                }
                
                .vault-doc-meta {
                    display: flex;
                    gap: 16px;
                    font-size: 13px;
                    color: #6b7280;
                }
                
                .meta-item {
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }
                
                .vault-doc-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .vault-empty {
                    text-align: center;
                    color: #6b7280;
                    font-style: italic;
                    padding: 40px;
                }
                
                .vault-error {
                    text-align: center;
                    color: #ef4444;
                    padding: 40px;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('✅ Client document storage enhanced');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: document-vault-ui.js
/**
 * Document Vault UI Enhancement
 * Adds vault button to dashboard and integrates document storage UI
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.documentVault || !window.dashboardWidgets) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        integrateVaultUI();
    }
    
    function integrateVaultUI() {
        // Add vault button to dashboard header
        const addVaultButton = () => {
            const dashboardControls = document.querySelector('.dashboard-controls');
            if (dashboardControls && !document.querySelector('#btnDocumentVault')) {
                // Find the morning review button as reference point
                const morningReviewBtn = dashboardControls.querySelector('.btn-morning-review');
                
                const button = document.createElement('button');
                button.id = 'btnDocumentVault';
                button.className = 'btn btn-secondary';
                button.innerHTML = '🗃️ Document Vault';
                button.onclick = () => window.documentVault.showVault();
                button.title = 'View all generated documents';
                
                if (morningReviewBtn) {
                    morningReviewBtn.parentNode.insertBefore(button, morningReviewBtn.nextSibling);
                } else {
                    dashboardControls.appendChild(button);
                }
            }
        };
        
        // Add vault to quick actions
        const originalRender = window.dashboardWidgets.widgets.get('quickActions')?.render;
        if (originalRender) {
            window.dashboardWidgets.widgets.get('quickActions').render = function() {
                let html = originalRender.call(this);
                
                // Add vault action
                const vaultAction = `
                    <button class="quick-action-btn" onclick="window.documentVault.showVault()">
                        <span class="action-icon">🗃️</span>
                        <span class="action-label">Document Vault</span>
                    </button>
                `;
                
                // Insert before last closing div
                const insertPos = html.lastIndexOf('</div></div>');
                html = html.slice(0, insertPos) + vaultAction + html.slice(insertPos);
                
                return html;
            };
        }
        
        // Override document generator UI to update vault count
        const originalShowModal = window.documentGenerator.showModal;
        if (originalShowModal) {
            window.documentGenerator.showModal = async function(...args) {
                const result = originalShowModal.call(this, ...args);
                
                // Update vault button with document count
                const vaultBtn = document.querySelector('#btnDocumentVault');
                if (vaultBtn && window.documentVault) {
                    try {
                        const docs = await window.documentVault.getAllDocuments();
                        vaultBtn.innerHTML = `🗃️ Vault (${docs.length})`;
                    } catch (e) {
                        console.error('Error updating vault count:', e);
                    }
                }
                
                return result;
            };
        }
        
        // Listen for document generation to update count
        window.addEventListener('client:documentAdded', async (e) => {
            const vaultBtn = document.querySelector('#btnDocumentVault');
            if (vaultBtn && window.documentVault) {
                try {
                    const docs = await window.documentVault.getAllDocuments();
                    vaultBtn.innerHTML = `🗃️ Vault (${docs.length})`;
                } catch (e) {
                    console.error('Error updating vault count:', e);
                }
            }
        });
        
        // Add keyboard shortcut (Ctrl+V for vault)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'v' && !e.shiftKey) {
                e.preventDefault();
                window.documentVault.showVault();
            }
        });
        
        // Initialize vault button
        setTimeout(async () => {
            addVaultButton();
            
            // Update with initial count
            const vaultBtn = document.querySelector('#btnDocumentVault');
            if (vaultBtn && window.documentVault) {
                try {
                    const docs = await window.documentVault.getAllDocuments();
                    if (docs.length > 0) {
                        vaultBtn.innerHTML = `🗃️ Vault (${docs.length})`;
                    }
                } catch (e) {
                    console.error('Error loading initial vault count:', e);
                }
            }
        }, 500);
        
        // Re-add button when dashboard refreshes
        const observer = new MutationObserver(() => {
            addVaultButton();
        });
        
        const dashboardContainer = document.querySelector('#dashboardTab');
        if (dashboardContainer) {
            observer.observe(dashboardContainer, { childList: true, subtree: true });
        }
        
        // Add styles for vault button
        if (!document.querySelector('#document-vault-ui-styles')) {
            const styles = document.createElement('style');
            styles.id = 'document-vault-ui-styles';
            styles.textContent = `
                #btnDocumentVault {
                    margin-left: 8px;
                    position: relative;
                }
                
                #btnDocumentVault.has-new::after {
                    content: '';
                    position: absolute;
                    top: -4px;
                    right: -4px;
                    width: 8px;
                    height: 8px;
                    background: #ef4444;
                    border-radius: 50%;
                    animation: pulse 2s infinite;
                }
                
                @keyframes pulse {
                    0% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.7; transform: scale(1.1); }
                    100% { opacity: 1; transform: scale(1); }
                }
                
                /* Quick action styling */
                .quick-action-btn[onclick*="documentVault"] {
                    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
                }
                
                .quick-action-btn[onclick*="documentVault"]:hover {
                    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('✅ Document Vault UI integrated');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: empty-states-errors.js
/**
 * Empty States and Error Handling Enhancement
 * Adds contextual empty states, loading indicators, and error recovery
 */

(function() {
    'use strict';
    
    // Loading state manager
    window.loadingManager = {
        activeLoaders: new Set(),
        
        show(id, message = 'Loading...') {
            this.activeLoaders.add(id);
            
            // Find container element
            const element = document.getElementById(id) || document.querySelector(`[data-widget="${id}"]`);
            if (!element) return;
            
            // Store original content
            if (!element.dataset.originalContent) {
                element.dataset.originalContent = element.innerHTML;
            }
            
            // Show loading state
            element.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p class="loading-message">${message}</p>
                </div>
            `;
            
            element.classList.add('is-loading');
        },
        
        hide(id) {
            this.activeLoaders.delete(id);
            
            const element = document.getElementById(id) || document.querySelector(`[data-widget="${id}"]`);
            if (!element) return;
            
            // Restore original content if available
            if (element.dataset.originalContent) {
                element.innerHTML = element.dataset.originalContent;
                delete element.dataset.originalContent;
            }
            
            element.classList.remove('is-loading');
        },
        
        isLoading(id) {
            return this.activeLoaders.has(id);
        }
    };
    
    // Empty state configurations
    const emptyStateConfigs = {
        flightPlan: {
            title: 'All Clear!',
            message: 'No urgent tasks at the moment. Great job staying on top of everything!',
            icon: '✅',
            action: {
                text: 'View All Clients',
                handler: () => window.dashboardManager?.setView('allClients')
            }
        },
        missions: {
            title: 'Mission Complete!',
            message: 'All tasks for today have been completed. Take a moment to review tomorrow\'s schedule.',
            icon: '🎯',
            action: {
                text: 'Morning Review',
                handler: () => window.morningReview?.show()
            }
        },
        journeyRadar: {
            title: 'No Active Clients',
            message: 'There are no active clients to display. Add a new client to get started.',
            icon: '👥',
            action: {
                text: 'Add Client',
                handler: () => window.showAddClientModal?.()
            }
        },
        houseWeather: {
            title: 'No House Data',
            message: 'House weather information will appear here once clients are assigned to houses.',
            icon: '🏠'
        },
        default: {
            title: 'No Data Available',
            message: 'This section will populate once relevant data is available.',
            icon: 'ℹ️'
        }
    };
    
    // Error recovery strategies
    const errorRecovery = {
        async retry(fn, maxAttempts = 3, delay = 1000) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    lastError = error;
                    console.warn(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, delay * attempt));
                    }
                }
            }
            
            throw lastError;
        },
        
        handleError(widgetName, error, container) {
            console.error(`Error in ${widgetName}:`, error);
            
            const errorConfig = {
                title: 'Something went wrong',
                message: error.message || 'An unexpected error occurred',
                icon: '⚠️',
                actions: [
                    {
                        text: 'Retry',
                        handler: () => window.dashboardManager?.refreshDashboard()
                    }
                ]
            };
            
            if (container) {
                container.innerHTML = this.renderErrorState(errorConfig);
            }
            
            // Report to error tracking if available
            if (window.errorTracker) {
                window.errorTracker.report(error, { widget: widgetName });
            }
        },
        
        renderErrorState(config) {
            return `
                <div class="error-state">
                    <div class="error-icon">${config.icon}</div>
                    <h3 class="error-title">${config.title}</h3>
                    <p class="error-message">${config.message}</p>
                    ${config.actions ? `
                        <div class="error-actions">
                            ${config.actions.map(action => `
                                <button class="btn btn-primary" onclick="(${action.handler})()">
                                    ${action.text}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
    };
    
    // Enhance widget rendering with empty states
    function enhanceWidgets() {
        if (!window.dashboardWidgets?.widgets) return;
        
        // Enhance each widget
        window.dashboardWidgets.widgets.forEach((widget, name) => {
            const originalRender = widget.render;
            if (!originalRender) return;
            
            widget.render = function() {
                const container = this.container;
                let widgetName = name;
                
                try {
                    // Show loading state
                    if (container) {
                        window.loadingManager.show(container.id || widgetName, `Loading ${widgetName}...`);
                    }
                    
                    // Call original render
                    let content = originalRender.call(this);
                    
                    // Check if content is empty or indicates no data
                    const isEmptyContent = !content || 
                        (typeof content === 'string' && content.trim() === '') || 
                        (typeof content === 'string' && content.includes('No data')) ||
                        (typeof content === 'string' && content.includes('no items')) ||
                        (typeof content === 'string' && (content.match(/<div/g) || []).length <= 2); // Just wrapper divs
                    
                    if (isEmptyContent) {
                        const config = emptyStateConfigs[widgetName] || emptyStateConfigs.default;
                        content = renderEmptyState(config);
                    }
                    
                    // Hide loading state
                    if (container) {
                        window.loadingManager.hide(container.id || widgetName);
                    }
                    
                    return content;
                    
                } catch (error) {
                    // Hide loading state
                    if (container) {
                        window.loadingManager.hide(container.id || widgetName);
                    }
                    
                    // Handle error
                    errorRecovery.handleError(widgetName, error, container);
                    return errorRecovery.renderErrorState({
                        title: 'Widget Error',
                        message: `Failed to load ${widgetName}`,
                        icon: '❌',
                        actions: [{
                            text: 'Retry',
                            handler: () => this.refresh?.()
                        }]
                    });
                }
            };
            
            // Add retry capability
            if (!widget.retry) {
                widget.retry = async function() {
                    try {
                        await errorRecovery.retry(() => {
                            if (this.container) {
                                this.container.innerHTML = this.render();
                            }
                        });
                    } catch (error) {
                        errorRecovery.handleError(name, error, this.container);
                    }
                };
            }
        });
    }
    
    // Render empty state
    function renderEmptyState(config) {
        return `
            <div class="empty-state">
                <div class="empty-icon">${config.icon}</div>
                <h3 class="empty-title">${config.title}</h3>
                <p class="empty-message">${config.message}</p>
                ${config.action ? `
                    <button class="btn btn-primary empty-action" onclick="(${config.action.handler})()">
                        ${config.action.text}
                    </button>
                ` : ''}
            </div>
        `;
    }
    
    // Enhance data loading functions
    function enhanceDataLoading() {
        // Enhance clientManager
        if (window.clientManager) {
            const originalGetAllClients = window.clientManager.getAllClients;
            window.clientManager.getAllClients = async function() {
                return errorRecovery.retry(async () => {
                    const result = await originalGetAllClients.call(this);
                    if (!result) throw new Error('Failed to load clients');
                    return result;
                });
            };
        }
        
        // Enhance dashboard data loading
        if (window.dashboardManager) {
            const originalLoadDashboardData = window.dashboardManager.loadDashboardData;
            window.dashboardManager.loadDashboardData = async function() {
                const widgetContainer = document.querySelector('.dashboard-grid');
                if (widgetContainer) {
                    widgetContainer.classList.add('loading');
                }
                
                try {
                    const result = await errorRecovery.retry(() => 
                        originalLoadDashboardData.call(this)
                    );
                    
                    if (widgetContainer) {
                        widgetContainer.classList.remove('loading');
                    }
                    
                    return result;
                } catch (error) {
                    if (widgetContainer) {
                        widgetContainer.classList.remove('loading');
                    }
                    
                    // Show error notification
                    window.showNotification(
                        'Failed to load dashboard data. Please refresh the page.',
                        'error',
                        'Dashboard Error'
                    );
                    
                    throw error;
                }
            };
        }
    }
    
    // Add contextual help
    window.contextualHelp = {
        show(context) {
            const helpTexts = {
                'empty-flight-plan': 'The Daily Flight Plan shows urgent tasks that need attention. When it\'s empty, all critical items are handled!',
                'empty-missions': 'Today\'s Missions tracks your daily goals. Complete all missions to maintain excellent care standards.',
                'loading-error': 'If loading issues persist, try refreshing the page or clearing your browser cache.',
                'no-clients': 'Add your first client to start tracking their aftercare journey.'
            };
            
            const text = helpTexts[context] || 'Need help? Contact support for assistance.';
            
            window.showNotification(text, 'info', 'Tip', 5000);
        }
    };
    
    // Add loading states CSS
    if (!document.querySelector('#empty-states-errors-styles')) {
        const styles = document.createElement('style');
        styles.id = 'empty-states-errors-styles';
        styles.textContent = `
            /* Loading States */
            .loading-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                padding: 40px;
                text-align: center;
            }
            
            .loading-spinner {
                width: 48px;
                height: 48px;
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-top-color: var(--ccp-primary-500);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 16px;
            }
            
            .loading-message {
                color: #6b7280;
                font-size: 14px;
                margin: 0;
            }
            
            .is-loading {
                position: relative;
                pointer-events: none;
                opacity: 0.8;
            }
            
            .dashboard-grid.loading {
                opacity: 0.7;
                pointer-events: none;
            }
            
            /* Empty States */
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                padding: 40px 20px;
                text-align: center;
                animation: fadeIn 0.3s ease;
            }
            
            .empty-icon {
                font-size: 64px;
                margin-bottom: 16px;
                opacity: 0.7;
            }
            
            .empty-title {
                margin: 0 0 8px 0;
                font-size: 20px;
                font-weight: 600;
                color: #1f2937;
            }
            
            .empty-message {
                margin: 0 0 24px 0;
                color: #6b7280;
                font-size: 14px;
                max-width: 300px;
                line-height: 1.5;
            }
            
            .empty-action {
                margin-top: 8px;
            }
            
            /* Error States */
            .error-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                padding: 40px 20px;
                text-align: center;
                background: #fef2f2;
                border-radius: 8px;
                margin: 16px;
            }
            
            .error-icon {
                font-size: 48px;
                margin-bottom: 16px;
                color: #ef4444;
            }
            
            .error-title {
                margin: 0 0 8px 0;
                font-size: 18px;
                font-weight: 600;
                color: #991b1b;
            }
            
            .error-message {
                margin: 0 0 16px 0;
                color: #7f1d1d;
                font-size: 14px;
            }
            
            .error-actions {
                display: flex;
                gap: 12px;
                margin-top: 8px;
            }
            
            /* Animations */
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            /* Skeleton Loading */
            .skeleton {
                background: linear-gradient(
                    90deg,
                    #f3f4f6 25%,
                    #e5e7eb 50%,
                    #f3f4f6 75%
                );
                background-size: 200% 100%;
                animation: skeleton 1.5s infinite;
                border-radius: 4px;
            }
            
            .skeleton-text {
                height: 16px;
                margin-bottom: 8px;
            }
            
            .skeleton-title {
                height: 24px;
                width: 60%;
                margin-bottom: 16px;
            }
            
            @keyframes skeleton {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
            
            /* Help Tooltips */
            .help-tip {
                position: absolute;
                top: 8px;
                right: 8px;
                width: 20px;
                height: 20px;
                background: #e5e7eb;
                border-radius: 50%;
                cursor: help;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                color: #6b7280;
                transition: all 0.2s;
            }
            
            .help-tip:hover {
                background: #d1d5db;
                color: #374151;
            }
            
            /* Contextual Empty States */
            .zone-red .empty-state .empty-icon {
                color: #ef4444;
            }
            
            .zone-purple .empty-state .empty-icon {
                color: #a855f7;
            }
            
            .zone-yellow .empty-state .empty-icon {
                color: #eab308;
            }
            
            .zone-green .empty-state .empty-icon {
                color: #22c55e;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Initialize enhancements
    function initialize() {
        enhanceWidgets();
        enhanceDataLoading();
        
        console.log('✅ Empty states and error handling initialized');
    }
    
    // Wait for dependencies
    if (window.dashboardWidgets && window.clientManager) {
        initialize();
    } else {
        const checkInterval = setInterval(() => {
            if (window.dashboardWidgets && window.clientManager) {
                clearInterval(checkInterval);
                initialize();
            }
        }, 100);
        
        setTimeout(() => clearInterval(checkInterval), 10000);
    }
})();





// Enhancement: alert-actionability.js
/**
 * Alert Actionability Enhancement
 * Makes alerts clickable, adds bulk actions, filters, and detailed alert modals
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardWidgets || !window.dashboardManager || !window.showModal) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceAlerts();
    }
    
    function enhanceAlerts() {
        // Enhance Flight Plan widget to make alerts clickable
        const flightPlanWidget = window.dashboardWidgets?.widgets?.get('flightPlan');
        if (flightPlanWidget) {
            const originalRenderPriorityItem = flightPlanWidget.renderPriorityItem;
            
            flightPlanWidget.renderPriorityItem = function(item, zone) {
                let html = originalRenderPriorityItem.call(this, item, zone);
                
                // Make the entire item clickable
                const itemWrapper = html.match(/<div[^>]*class="[^"]*priority-item[^"]*"[^>]*>/);
                if (itemWrapper) {
                    // Add click handler and cursor pointer
                    html = html.replace(
                        /<div([^>]*class="[^"]*priority-item[^"]*"[^>]*)>/,
                        '<div$1 onclick="window.handleAlertClick(event, \'' + item.client.id + '\', \'' + item.type + '\', \'' + zone + '\')" style="cursor: pointer;">'
                    );
                    
                    // Add hover effect class
                    html = html.replace(
                        /class="([^"]*priority-item[^"]*)"/,
                        'class="$1 alert-clickable"'
                    );
                }
                
                return html;
            };
        }
        
        // Global alert click handler
        window.handleAlertClick = function(event, clientId, alertType, zone) {
            // Prevent default if clicking on action buttons
            if (event.target.closest('button')) {
                return;
            }
            
            console.log('[FlightPlan] Task clicked:', clientId, alertType, zone);
            
            // Emit event for onboarding checklist - dispatch to WINDOW
            var eventDetail = { clientId: clientId, alertType: alertType, zone: zone };
            window.dispatchEvent(new CustomEvent('cc:flightPlan:taskOpened', { detail: eventDetail }));
            console.log('[FlightPlan] Emitted cc:flightPlan:taskOpened to window');
            
            // Also emit via OnboardingEvents if available
            if (window.OnboardingEvents) {
                OnboardingEvents.emit('cc:flightPlan:taskOpened', eventDetail);
            }
            
            // Show alert details modal
            showAlertDetailsModal(clientId, alertType, zone);
        };
        
        // Show alert details modal
        async function showAlertDetailsModal(clientId, alertType, zone) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                // Get alert details
                const alert = getAlertDetails(client, alertType, zone);
                
                // Build modal content
                const content = `
                    <div class="alert-details-modal">
                        <div class="alert-header">
                            <div class="alert-client-info">
                                <span class="client-badge-large">${client.initials}</span>
                                <div class="client-details">
                                    <div class="client-name">${client.initials}</div>
                                    <div class="client-meta">
                                        <span>🏠 ${client.houseId || 'No House'}</span>
                                        <span>📅 Day ${window.daysBetween(client.admissionDate) || 0}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="alert-zone-badge zone-${zone}">
                                ${zone.charAt(0).toUpperCase() + zone.slice(1)} Zone
                            </div>
                        </div>
                        
                        <div class="alert-content">
                            <div class="alert-message-section">
                                <h4>Alert Details</h4>
                                <p class="alert-message">${alert.message}</p>
                                ${alert.dueDate ? `<p class="alert-due"><strong>Due:</strong> ${alert.dueDate}</p>` : ''}
                                ${alert.description ? `<p class="alert-description">${alert.description}</p>` : ''}
                            </div>
                            
                            ${alert.trackerItem ? `
                                <div class="tracker-context">
                                    <h4>Tracker Context</h4>
                                    <div class="tracker-info">
                                        <span class="tracker-label">${alert.trackerItem.label}</span>
                                        <span class="tracker-status">${alert.trackerItem.complete ? '✅ Complete' : '⏳ Pending'}</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="client-context">
                                <h4>Client Context</h4>
                                <div class="context-grid">
                                    <div class="context-item">
                                        <span class="context-label">Admission Date:</span>
                                        <span class="context-value">${window.formatDate(client.admissionDate)}</span>
                                    </div>
                                    ${client.dischargeDate ? `
                                        <div class="context-item">
                                            <span class="context-label">Discharge Date:</span>
                                            <span class="context-value">${window.formatDate(client.dischargeDate)}</span>
                                        </div>
                                    ` : ''}
                                    ${window.trackerEngine ? (() => {
                                        const score = window.trackerEngine.getCompletionScore(client);
                                        return `
                                            <div class="context-item">
                                                <span class="context-label">Tracker Completion:</span>
                                                <span class="context-value">${score.percentage}%</span>
                                            </div>
                                        `;
                                    })() : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert-actions-section">
                            <h4>Quick Actions</h4>
                            <div class="action-buttons-grid">
                                ${alert.isTrackerTask ? `
                                    <button class="btn btn-success" onclick="window.completeAlertFromModal('${clientId}', '${alert.trackerId}')">
                                        ✓ Mark Complete
                                    </button>
                                ` : ''}
                                <button class="btn btn-primary" onclick="window.viewClientFromAlert('${clientId}')">
                                    👤 View Client Details
                                </button>
                                ${alert.canGenerateDoc ? `
                                    <button class="btn btn-secondary" onclick="window.generateDocFromAlert('${clientId}', '${alert.docType}')">
                                        📄 Generate Document
                                    </button>
                                ` : ''}
                                ${alert.canOpenTracker ? `
                                    <button class="btn btn-secondary" onclick="window.openTrackerFromAlert('${clientId}')">
                                        📊 Open Tracker
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: '🔔 Alert Details',
                    content: content,
                    size: 'large',
                    buttons: [
                        {
                            text: 'Close',
                            primary: true,
                            action: () => window.closeModal()
                        }
                    ]
                });
                
            } catch (error) {
                console.error('Error showing alert details:', error);
                window.showNotification('Failed to load alert details', 'error');
            }
        }
        
        // Get alert details
        function getAlertDetails(client, alertType, zone) {
            const daysInCare = window.daysBetween(client.admissionDate) || 0;
            
            // Map alert types to details
            const alertMap = {
                'discharge-soon': {
                    message: `Discharge scheduled in ${daysInCare} days`,
                    dueDate: client.dischargeDate ? window.formatDate(client.dischargeDate) : null,
                    description: 'Ensure all discharge requirements are completed',
                    canGenerateDoc: true,
                    docType: 'discharge-packet',
                    canOpenTracker: true
                },
                'missing-critical': {
                    message: 'Critical tracker items are missing',
                    description: 'Complete critical items to ensure smooth discharge',
                    canOpenTracker: true,
                    isTrackerTask: true
                },
                'aftercare-due': {
                    message: 'Aftercare options document due',
                    dueDate: daysInCare >= 14 ? 'Due now' : `Due in ${14 - daysInCare} days`,
                    description: 'Generate aftercare options document for family review',
                    canGenerateDoc: true,
                    docType: 'aftercare-options'
                }
            };
            
            return alertMap[alertType] || {
                message: 'Action required',
                canOpenTracker: true
            };
        }
        
        // Action handlers
        window.completeAlertFromModal = async function(clientId, trackerId) {
            try {
                await window.dashboardWidgets.completeTrackerItem(clientId, trackerId);
                window.closeModal();
                window.showNotification('Alert item completed', 'success');
                window.dashboardManager.refreshDashboard();
            } catch (error) {
                console.error('Error completing alert:', error);
                window.showNotification('Failed to complete item', 'error');
            }
        };
        
        window.viewClientFromAlert = function(clientId) {
            window.closeModal();
            window.viewClientDetails(clientId);
        };
        
        window.generateDocFromAlert = function(clientId, docType) {
            window.closeModal();
            window.generateDocument(clientId, docType);
        };
        
        window.openTrackerFromAlert = function(clientId) {
            window.closeModal();
            // Open tracker bulk update for this client
            if (window.openBulkUpdate) {
                window.openBulkUpdate(clientId);
            } else {
                window.viewClientDetails(clientId);
            }
        };
        
        // Enhance bulk actions in viewAllAlerts
        const originalViewAllAlerts = window.dashboardWidgets.viewAllAlerts;
        window.dashboardWidgets.viewAllAlerts = async function() {
            // Call original to get the modal
            await originalViewAllAlerts.call(this);
            
            // Wait for modal to render
            setTimeout(() => {
                enhanceAlertsModal();
            }, 100);
        };
        
        function enhanceAlertsModal() {
            const modal = document.getElementById('globalModal');
            if (!modal) return;
            
            // Add bulk action controls
            const alertsContent = modal.querySelector('.alerts-content');
            if (!alertsContent) return;
            
            // Add checkbox to each alert item
            const alertItems = alertsContent.querySelectorAll('.alert-item');
            alertItems.forEach((item, index) => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'alert-select-checkbox';
                checkbox.dataset.index = index;
                item.insertBefore(checkbox, item.firstChild);
            });
            
            // Add bulk action bar
            const bulkBar = document.createElement('div');
            bulkBar.className = 'bulk-actions-bar';
            bulkBar.innerHTML = `
                <div class="bulk-info">
                    <span id="selectedCount">0</span> selected
                </div>
                <div class="bulk-buttons">
                    <button class="btn btn-sm" onclick="window.selectAllAlerts()">Select All</button>
                    <button class="btn btn-sm" onclick="window.deselectAllAlerts()">Deselect None</button>
                    <button class="btn btn-sm btn-success" onclick="window.bulkCompleteAlerts()" id="bulkCompleteBtn" disabled>
                        ✓ Complete Selected
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="window.bulkViewClients()" id="bulkViewBtn" disabled>
                        👤 View Selected Clients
                    </button>
                </div>
            `;
            
            alertsContent.insertBefore(bulkBar, alertsContent.firstChild);
            
            // Add selection handlers
            alertItems.forEach(item => {
                const checkbox = item.querySelector('.alert-select-checkbox');
                if (checkbox) {
                    checkbox.addEventListener('change', updateBulkActions);
                }
            });
        }
        
        // Bulk action functions
        window.selectAllAlerts = function() {
            document.querySelectorAll('.alert-select-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateBulkActions();
        };
        
        window.deselectAllAlerts = function() {
            document.querySelectorAll('.alert-select-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateBulkActions();
        };
        
        function updateBulkActions() {
            const selected = Array.from(document.querySelectorAll('.alert-select-checkbox:checked'));
            const count = selected.length;
            
            document.getElementById('selectedCount').textContent = count;
            
            const bulkCompleteBtn = document.getElementById('bulkCompleteBtn');
            const bulkViewBtn = document.getElementById('bulkViewBtn');
            
            if (bulkCompleteBtn) bulkCompleteBtn.disabled = count === 0;
            if (bulkViewBtn) bulkViewBtn.disabled = count === 0;
        }
        
        window.bulkCompleteAlerts = async function() {
            const selected = Array.from(document.querySelectorAll('.alert-select-checkbox:checked'));
            if (selected.length === 0) return;
            
            const confirmed = confirm(`Complete ${selected.length} selected alert(s)?`);
            if (!confirmed) return;
            
            let completed = 0;
            let failed = 0;
            
            for (const checkbox of selected) {
                const alertItem = checkbox.closest('.alert-item');
                const clientId = alertItem.dataset.clientId;
                const trackerId = alertItem.dataset.trackerId;
                
                if (clientId && trackerId) {
                    try {
                        await window.dashboardWidgets.completeTrackerItem(clientId, trackerId);
                        completed++;
                    } catch (error) {
                        failed++;
                    }
                }
            }
            
            window.showNotification(
                `Completed ${completed} alert(s)${failed > 0 ? `, ${failed} failed` : ''}`,
                completed > 0 ? 'success' : 'error'
            );
            
            window.dashboardManager.refreshDashboard();
            window.dashboardWidgets.viewAllAlerts();
        };
        
        window.bulkViewClients = function() {
            const selected = Array.from(document.querySelectorAll('.alert-select-checkbox:checked'));
            const clientIds = selected.map(cb => {
                const alertItem = cb.closest('.alert-item');
                return alertItem.dataset.clientId;
            }).filter(id => id);
            
            if (clientIds.length === 0) return;
            
            // Show client list modal
            window.showModal({
                title: `Selected Clients (${clientIds.length})`,
                content: `
                    <div class="bulk-clients-list">
                        ${clientIds.map(id => `
                            <div class="bulk-client-item">
                                <button class="btn btn-sm" onclick="window.viewClientFromAlert('${id}')">
                                    View Client ${id}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `,
                size: 'medium',
                buttons: [
                    {
                        text: 'Close',
                        action: () => window.closeModal()
                    }
                ]
            });
        };
        
        // Add styles
        if (!document.querySelector('#alert-actionability-styles')) {
            const styles = document.createElement('style');
            styles.id = 'alert-actionability-styles';
            styles.textContent = `
                /* Clickable alerts */
                .alert-clickable {
                    transition: all 0.2s;
                }
                
                .alert-clickable:hover {
                    background: #f9fafb !important;
                    transform: translateX(4px);
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                
                /* Alert details modal */
                .alert-details-modal {
                    padding: 0;
                }
                
                .alert-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    background: #f9fafb;
                    border-bottom: 2px solid #e5e7eb;
                }
                
                .alert-client-info {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                }
                
                .client-badge-large {
                    width: 56px;
                    height: 56px;
                    border-radius: 50%;
                    background: var(--ccp-primary-500);
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 24px;
                    font-weight: 600;
                }
                
                .client-details {
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                }
                
                .client-name {
                    font-size: 18px;
                    font-weight: 600;
                    color: #1f2937;
                }
                
                .client-meta {
                    display: flex;
                    gap: 16px;
                    font-size: 14px;
                    color: #6b7280;
                }
                
                .alert-zone-badge {
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-weight: 600;
                    font-size: 14px;
                }
                
                .alert-zone-badge.zone-red {
                    background: #fee2e2;
                    color: #991b1b;
                }
                
                .alert-zone-badge.zone-purple {
                    background: #f3e8ff;
                    color: #6b21a8;
                }
                
                .alert-zone-badge.zone-yellow {
                    background: #fef9c3;
                    color: #854d0e;
                }
                
                .alert-zone-badge.zone-green {
                    background: #dcfce7;
                    color: #166534;
                }
                
                .alert-content {
                    padding: 24px;
                }
                
                .alert-content h4 {
                    margin: 0 0 12px 0;
                    font-size: 16px;
                    color: #1f2937;
                }
                
                .alert-message-section {
                    margin-bottom: 24px;
                    padding-bottom: 24px;
                    border-bottom: 1px solid #e5e7eb;
                }
                
                .alert-message {
                    font-size: 16px;
                    color: #374151;
                    margin: 0 0 8px 0;
                }
                
                .alert-due {
                    color: #dc2626;
                    font-weight: 500;
                    margin: 8px 0;
                }
                
                .alert-description {
                    color: #6b7280;
                    font-size: 14px;
                    margin: 8px 0 0 0;
                }
                
                .tracker-context,
                .client-context {
                    margin-bottom: 24px;
                }
                
                .tracker-info {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px;
                    background: #f9fafb;
                    border-radius: 6px;
                }
                
                .tracker-label {
                    font-weight: 500;
                }
                
                .tracker-status {
                    font-size: 14px;
                }
                
                .context-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 12px;
                }
                
                .context-item {
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                }
                
                .context-label {
                    font-size: 12px;
                    color: #6b7280;
                }
                
                .context-value {
                    font-weight: 500;
                    color: #1f2937;
                }
                
                .alert-actions-section {
                    padding: 20px;
                    background: #f9fafb;
                    border-top: 2px solid #e5e7eb;
                }
                
                .action-buttons-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 12px;
                }
                
                /* Bulk actions */
                .bulk-actions-bar {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px 16px;
                    background: #f3f4f6;
                    border-radius: 8px;
                    margin-bottom: 16px;
                }
                
                .bulk-info {
                    font-weight: 500;
                    color: #374151;
                }
                
                .bulk-buttons {
                    display: flex;
                    gap: 8px;
                }
                
                .alert-select-checkbox {
                    margin-right: 12px;
                    cursor: pointer;
                }
                
                .bulk-clients-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    max-height: 400px;
                    overflow-y: auto;
                }
                
                .bulk-client-item {
                    padding: 12px;
                    background: #f9fafb;
                    border-radius: 6px;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('✅ Alert actionability enhanced');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: tracker-completion-enhancement.js
/**
 * Tracker Completion Enhancement
 * Adds confirmation dialogs, optional notes, undo/redo, and bulk update capabilities
 */

(function() {
    'use strict';
    
    // History stack for undo/redo
    window.trackerHistory = {
        stack: [],
        currentIndex: -1,
        maxSize: 50,
        
        push(action) {
            // Remove any actions after current index (when undoing then doing new action)
            this.stack = this.stack.slice(0, this.currentIndex + 1);
            
            // Add new action
            this.stack.push({
                ...action,
                timestamp: new Date().toISOString()
            });
            
            // Limit stack size
            if (this.stack.length > this.maxSize) {
                this.stack.shift();
            } else {
                this.currentIndex++;
            }
            
            // Save to localStorage
            this.save();
        },
        
        undo() {
            if (this.currentIndex < 0) return null;
            
            const action = this.stack[this.currentIndex];
            this.currentIndex--;
            this.save();
            
            return action;
        },
        
        redo() {
            if (this.currentIndex >= this.stack.length - 1) return null;
            
            this.currentIndex++;
            const action = this.stack[this.currentIndex];
            this.save();
            
            return action;
        },
        
        canUndo() {
            return this.currentIndex >= 0;
        },
        
        canRedo() {
            return this.currentIndex < this.stack.length - 1;
        },
        
        save() {
            try {
                localStorage.setItem('tracker_history', JSON.stringify({
                    stack: this.stack,
                    currentIndex: this.currentIndex
                }));
            } catch (e) {
                console.warn('Failed to save tracker history:', e);
            }
        },
        
        load() {
            try {
                const saved = localStorage.getItem('tracker_history');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.stack = data.stack || [];
                    this.currentIndex = data.currentIndex || -1;
                }
            } catch (e) {
                console.warn('Failed to load tracker history:', e);
            }
        }
    };
    
    // Load history on init
    window.trackerHistory.load();
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardWidgets || !window.clientManager || !window.showModal) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        enhanceTrackerCompletion();
    }
    
    function enhanceTrackerCompletion() {
        // Override completeTrackerItem with enhanced version
        const originalCompleteTrackerItem = window.dashboardWidgets.completeTrackerItem;
        
        window.dashboardWidgets.completeTrackerItem = async function(clientId, trackerId, skipConfirm = false) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                // Get tracker item info
                const trackerItem = getTrackerItemInfo(client, trackerId);
                if (!trackerItem) {
                    window.showNotification('Tracker item not found', 'error');
                    return;
                }
                
                // Show confirmation dialog unless skipped
                if (!skipConfirm) {
                    const confirmed = await showCompletionDialog(client, trackerItem);
                    if (!confirmed) return;
                }
                
                // Store state for undo
                const beforeState = {
                    clientId,
                    trackerId,
                    value: client[trackerItem.field],
                    dateValue: client[trackerItem.dateField]
                };
                
                // Perform completion
                const updates = {};
                updates[trackerItem.field] = true;
                if (trackerItem.dateField) {
                    updates[trackerItem.dateField] = new Date().toISOString();
                }
                
                await window.clientManager.updateClient(clientId, updates);
                
                // Store in history
                window.trackerHistory.push({
                    type: 'complete',
                    beforeState,
                    afterState: {
                        clientId,
                        trackerId,
                        value: true,
                        dateValue: updates[trackerItem.dateField]
                    },
                    note: window.lastCompletionNote || null
                });
                
                // Clear note
                window.lastCompletionNote = null;
                
                // Show success
                window.showNotification(`${trackerItem.label} marked as complete`, 'success');
                
                // Refresh dashboard
                if (window.dashboardManager) {
                    window.dashboardManager.refreshDashboard();
                }
                
            } catch (error) {
                console.error('Error completing tracker item:', error);
                window.showNotification('Failed to complete tracker item', 'error');
            }
        };
        
        // Show completion confirmation dialog
        async function showCompletionDialog(client, trackerItem) {
            return new Promise((resolve) => {
                const content = `
                    <div class="completion-dialog">
                        <div class="completion-header">
                            <h4>Complete Tracker Item</h4>
                        </div>
                        
                        <div class="completion-info">
                            <div class="info-row">
                                <span class="label">Client:</span>
                                <span class="value">${client.initials} - ${client.houseId || 'No House'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Item:</span>
                                <span class="value">${trackerItem.label}</span>
                            </div>
                            ${trackerItem.critical ? '<div class="critical-badge">⚠️ Critical Item</div>' : ''}
                        </div>
                        
                        <div class="completion-note-section">
                            <label for="completionNote">Add Note (Optional)</label>
                            <textarea 
                                id="completionNote" 
                                class="completion-note-input" 
                                placeholder="Add any notes about this completion..."
                                rows="3"
                            ></textarea>
                        </div>
                        
                        <div class="completion-actions">
                            <button class="btn btn-secondary" onclick="window.completionDialogCancel()">Cancel</button>
                            <button class="btn btn-primary" onclick="window.completionDialogConfirm()">Confirm</button>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: '✓ Complete Tracker Item',
                    content: content,
                    size: 'small',
                    closeOnOverlay: false,
                    buttons: []
                });
                
                // Set up handlers
                window.completionDialogConfirm = () => {
                    const note = document.getElementById('completionNote').value.trim();
                    if (note) {
                        window.lastCompletionNote = note;
                    }
                    window.closeModal();
                    resolve(true);
                };
                
                window.completionDialogCancel = () => {
                    window.closeModal();
                    resolve(false);
                };
            });
        }
        
        // Get tracker item info
        function getTrackerItemInfo(client, trackerId) {
            if (!window.trackerEngine) return null;
            
            const requirements = window.trackerEngine.requirements || [];
            const item = requirements.find(r => r.id === trackerId);
            
            if (!item) return null;
            
            // Map to client field
            const fieldMap = {
                'needs_assessment': { field: 'needsAssessment', dateField: 'needsAssessmentDate' },
                'health_physical': { field: 'healthPhysical', dateField: 'healthPhysicalDate' },
                'aftercare_thread': { field: 'aftercareThread', dateField: 'aftercareThreadDate' },
                'options_doc': { field: 'optionsDocUploaded', dateField: 'optionsDocUploadedDate' },
                'discharge_packet': { field: 'dischargePacketUploaded', dateField: 'dischargePacketUploadedDate' }
            };
            
            const mapping = fieldMap[trackerId] || { field: trackerId, dateField: null };
            
            return {
                id: trackerId,
                label: item.label,
                critical: item.critical || false,
                field: mapping.field,
                dateField: mapping.dateField
            };
        }
        
        // Undo last completion
        window.undoTrackerCompletion = async function() {
            if (!window.trackerHistory.canUndo()) {
                window.showNotification('Nothing to undo', 'info');
                return;
            }
            
            const action = window.trackerHistory.undo();
            if (!action || action.type !== 'complete') {
                window.showNotification('Cannot undo this action', 'warning');
                return;
            }
            
            try {
                const updates = {};
                const trackerItem = getTrackerItemInfo(
                    await window.clientManager.getClient(action.beforeState.clientId),
                    action.beforeState.trackerId
                );
                
                if (trackerItem) {
                    updates[trackerItem.field] = action.beforeState.value;
                    if (trackerItem.dateField) {
                        updates[trackerItem.dateField] = action.beforeState.dateValue;
                    }
                    
                    await window.clientManager.updateClient(action.beforeState.clientId, updates);
                    window.showNotification('Action undone', 'success');
                    
                    if (window.dashboardManager) {
                        window.dashboardManager.refreshDashboard();
                    }
                }
            } catch (error) {
                console.error('Error undoing:', error);
                window.showNotification('Failed to undo', 'error');
            }
        };
        
        // Redo last undone action
        window.redoTrackerCompletion = async function() {
            if (!window.trackerHistory.canRedo()) {
                window.showNotification('Nothing to redo', 'info');
                return;
            }
            
            const action = window.trackerHistory.redo();
            if (!action || action.type !== 'complete') {
                window.showNotification('Cannot redo this action', 'warning');
                return;
            }
            
            try {
                await window.dashboardWidgets.completeTrackerItem(
                    action.afterState.clientId,
                    action.afterState.trackerId,
                    true // Skip confirm
                );
                window.showNotification('Action redone', 'success');
            } catch (error) {
                console.error('Error redoing:', error);
                window.showNotification('Failed to redo', 'error');
            }
        };
        
        // Add bulk update button to Flight Plan widget
        const flightPlanWidget = window.dashboardWidgets?.widgets?.get('flightPlan');
        if (flightPlanWidget) {
            const originalRender = flightPlanWidget.render;
            
            flightPlanWidget.render = function() {
                let html = originalRender.call(this);
                
                // Add bulk update button to header
                const headerMatch = html.match(/(<div[^>]*class="[^"]*widget-header[^"]*"[^>]*>)/);
                if (headerMatch) {
                    const bulkButton = `
                        <button class="btn btn-sm btn-secondary bulk-update-btn" onclick="window.showBulkTrackerUpdate()">
                            📋 Bulk Update
                        </button>
                    `;
                    html = html.replace(headerMatch[0], headerMatch[0] + bulkButton);
                }
                
                // Add undo/redo buttons
                const undoRedoButtons = `
                    <div class="undo-redo-controls">
                        <button class="btn-icon" onclick="window.undoTrackerCompletion()" 
                                title="Undo (Ctrl+Z)" ${!window.trackerHistory.canUndo() ? 'disabled' : ''}>
                            ↶ Undo
                        </button>
                        <button class="btn-icon" onclick="window.redoTrackerCompletion()" 
                                title="Redo (Ctrl+Y)" ${!window.trackerHistory.canRedo() ? 'disabled' : ''}>
                            ↷ Redo
                        </button>
                    </div>
                `;
                
                html = html.replace('</div></div>', undoRedoButtons + '</div></div>');
                
                return html;
            };
        }
        
        // Bulk tracker update modal
        window.showBulkTrackerUpdate = async function() {
            try {
                const clients = await window.clientManager.getAllClients();
                const activeClients = clients.filter(c => c.status === 'active');
                
                if (activeClients.length === 0) {
                    window.showNotification('No active clients found', 'warning');
                    return;
                }
                
                // Get tracker requirements
                const requirements = window.trackerEngine?.requirements || [];
                
                const content = `
                    <div class="bulk-tracker-update">
                        <div class="bulk-header">
                            <p>Select clients and tracker items to complete in bulk.</p>
                        </div>
                        
                        <div class="bulk-selection">
                            <div class="bulk-clients-section">
                                <h5>Clients</h5>
                                <div class="bulk-clients-list">
                                    ${activeClients.map(client => `
                                        <label class="bulk-client-checkbox">
                                            <input type="checkbox" class="bulk-client-select" value="${client.id}">
                                            <span>${client.initials} - ${client.houseId || 'No House'}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="bulk-items-section">
                                <h5>Tracker Items</h5>
                                <div class="bulk-items-list">
                                    ${requirements.map(req => `
                                        <label class="bulk-item-checkbox">
                                            <input type="checkbox" class="bulk-item-select" value="${req.id}">
                                            <span>${req.label} ${req.critical ? '⚠️' : ''}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bulk-summary">
                            <span id="bulkSummary">0 clients, 0 items selected</span>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: '📋 Bulk Tracker Update',
                    content: content,
                    size: 'large',
                    buttons: [
                        {
                            text: 'Cancel',
                            action: () => window.closeModal()
                        },
                        {
                            text: 'Complete Selected',
                            primary: true,
                            action: () => executeBulkUpdate()
                        }
                    ]
                });
                
                // Update summary on selection change
                document.querySelectorAll('.bulk-client-select, .bulk-item-select').forEach(cb => {
                    cb.addEventListener('change', updateBulkSummary);
                });
                
                updateBulkSummary();
                
            } catch (error) {
                console.error('Error showing bulk update:', error);
                window.showNotification('Failed to load bulk update', 'error');
            }
        };
        
        function updateBulkSummary() {
            const selectedClients = document.querySelectorAll('.bulk-client-select:checked').length;
            const selectedItems = document.querySelectorAll('.bulk-item-select:checked').length;
            
            const summary = document.getElementById('bulkSummary');
            if (summary) {
                summary.textContent = `${selectedClients} clients, ${selectedItems} items selected`;
            }
        }
        
        async function executeBulkUpdate() {
            const selectedClients = Array.from(document.querySelectorAll('.bulk-client-select:checked')).map(cb => cb.value);
            const selectedItems = Array.from(document.querySelectorAll('.bulk-item-select:checked')).map(cb => cb.value);
            
            if (selectedClients.length === 0 || selectedItems.length === 0) {
                window.showNotification('Please select at least one client and one item', 'warning');
                return;
            }
            
            const confirmed = confirm(`Complete ${selectedItems.length} item(s) for ${selectedClients.length} client(s)?`);
            if (!confirmed) return;
            
            let completed = 0;
            let failed = 0;
            
            window.showNotification('Processing bulk update...', 'info');
            
            for (const clientId of selectedClients) {
                for (const itemId of selectedItems) {
                    try {
                        await window.dashboardWidgets.completeTrackerItem(clientId, itemId, true);
                        completed++;
                    } catch (error) {
                        failed++;
                    }
                }
            }
            
            window.closeModal();
            window.showNotification(
                `Bulk update complete: ${completed} items completed${failed > 0 ? `, ${failed} failed` : ''}`,
                completed > 0 ? 'success' : 'error'
            );
            
            if (window.dashboardManager) {
                window.dashboardManager.refreshDashboard();
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                window.undoTrackerCompletion();
            }
            
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                window.redoTrackerCompletion();
            }
        });
        
        // Add styles
        if (!document.querySelector('#tracker-completion-enhancement-styles')) {
            const styles = document.createElement('style');
            styles.id = 'tracker-completion-enhancement-styles';
            styles.textContent = `
                /* Completion Dialog */
                .completion-dialog {
                    padding: 0;
                }
                
                .completion-header h4 {
                    margin: 0 0 16px 0;
                    color: #1f2937;
                }
                
                .completion-info {
                    margin-bottom: 20px;
                }
                
                .info-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 8px;
                }
                
                .info-row .label {
                    font-weight: 500;
                    color: #6b7280;
                }
                
                .info-row .value {
                    color: #1f2937;
                }
                
                .critical-badge {
                    display: inline-block;
                    margin-top: 8px;
                    padding: 4px 8px;
                    background: #fef2f2;
                    color: #991b1b;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 500;
                }
                
                .completion-note-section {
                    margin-bottom: 20px;
                }
                
                .completion-note-section label {
                    display: block;
                    margin-bottom: 8px;
                    font-weight: 500;
                    color: #374151;
                }
                
                .completion-note-input {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    font-family: inherit;
                    font-size: 14px;
                    resize: vertical;
                }
                
                .completion-actions {
                    display: flex;
                    justify-content: flex-end;
                    gap: 12px;
                }
                
                /* Bulk Update */
                .bulk-update-btn {
                    margin-left: auto;
                }
                
                .undo-redo-controls {
                    display: flex;
                    gap: 8px;
                    padding: 12px;
                    background: #f9fafb;
                    border-top: 1px solid #e5e7eb;
                }
                
                .btn-icon {
                    background: white;
                    border: 1px solid #d1d5db;
                    padding: 6px 12px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s;
                }
                
                .btn-icon:hover:not(:disabled) {
                    background: #f3f4f6;
                    border-color: #9ca3af;
                }
                
                .btn-icon:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                
                .bulk-tracker-update {
                    padding: 0;
                }
                
                .bulk-header {
                    margin-bottom: 20px;
                    color: #6b7280;
                }
                
                .bulk-selection {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 24px;
                    margin-bottom: 20px;
                }
                
                .bulk-clients-section h5,
                .bulk-items-section h5 {
                    margin: 0 0 12px 0;
                    color: #1f2937;
                }
                
                .bulk-clients-list,
                .bulk-items-list {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    max-height: 300px;
                    overflow-y: auto;
                    padding: 8px;
                    background: #f9fafb;
                    border-radius: 6px;
                }
                
                .bulk-client-checkbox,
                .bulk-item-checkbox {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px;
                    background: white;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                }
                
                .bulk-client-checkbox:hover,
                .bulk-item-checkbox:hover {
                    background: #f3f4f6;
                }
                
                .bulk-summary {
                    padding: 12px;
                    background: #eff6ff;
                    border-radius: 6px;
                    text-align: center;
                    font-weight: 500;
                    color: #1e40af;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('✅ Tracker completion enhancement initialized');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();





// Enhancement: client-data-validation.js
/**
 * Client Data Validation Enhancement
 * Adds validation for client creation/updates, duplicate checking, date validation, and error display
 */

(function() {
    'use strict';
    
    // Validation rules
    const validationRules = {
        initials: {
            required: true,
            minLength: 2,
            maxLength: 10,
            pattern: /^[A-Z]{2,10}$/,
            message: 'Initials must be 2-10 uppercase letters'
        },
        houseId: {
            required: false,
            pattern: /^[A-Z0-9_\s-]+$/i,
            message: 'House ID can only contain letters, numbers, spaces, underscores, and hyphens'
        },
        admissionDate: {
            required: true,
            validate: (date) => {
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'Invalid date';
                if (d > new Date()) return 'Admission date cannot be in the future';
                return null;
            }
        },
        dischargeDate: {
            required: false,
            validate: (date, client) => {
                if (!date) return null;
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'Invalid date';
                if (client.admissionDate) {
                    const admission = new Date(client.admissionDate);
                    if (d < admission) return 'Discharge date must be after admission date';
                }
                return null;
            }
        },
        status: {
            required: true,
            allowedValues: ['active', 'discharged', 'archived'],
            message: 'Status must be active, discharged, or archived'
        }
    };
    
    // Validation engine
    window.clientValidator = {
        /**
         * Validate client data
         * @param {Object} clientData - Client data to validate
         * @param {Object} existingClient - Existing client data (for updates)
         * @returns {Object} Validation result { valid: boolean, errors: Object }
         */
        validate(clientData, existingClient = null) {
            const errors = {};
            let isValid = true;
            
            // Validate each field
            for (const [field, rules] of Object.entries(validationRules)) {
                const value = clientData[field];
                
                // Required check
                if (rules.required && (!value || value === '')) {
                    errors[field] = `${field} is required`;
                    isValid = false;
                    continue;
                }
                
                // Skip if empty and not required
                if (!value || value === '') continue;
                
                // Min length check
                if (rules.minLength && value.length < rules.minLength) {
                    errors[field] = `${field} must be at least ${rules.minLength} characters`;
                    isValid = false;
                    continue;
                }
                
                // Max length check
                if (rules.maxLength && value.length > rules.maxLength) {
                    errors[field] = `${field} must be no more than ${rules.maxLength} characters`;
                    isValid = false;
                    continue;
                }
                
                // Pattern check
                if (rules.pattern && !rules.pattern.test(value)) {
                    errors[field] = rules.message || `${field} format is invalid`;
                    isValid = false;
                    continue;
                }
                
                // Custom validation
                if (rules.validate) {
                    const customError = rules.validate(value, clientData);
                    if (customError) {
                        errors[field] = customError;
                        isValid = false;
                    }
                }
                
                // Allowed values check
                if (rules.allowedValues && !rules.allowedValues.includes(value)) {
                    errors[field] = rules.message || `${field} must be one of: ${rules.allowedValues.join(', ')}`;
                    isValid = false;
                }
            }
            
            return { valid: isValid, errors };
        },
        
        /**
         * Check for duplicate client
         * @param {string} initials - Client initials
         * @param {string} houseId - House ID
         * @param {string} excludeId - Client ID to exclude (for updates)
         * @returns {boolean} True if duplicate exists
         */
        async checkDuplicate(initials, houseId, excludeId = null) {
            if (!window.clientManager) return false;
            
            try {
                const clients = await window.clientManager.getAllClients();
                return clients.some(client => 
                    client.id !== excludeId &&
                    client.initials === initials &&
                    client.houseId === houseId
                );
            } catch (error) {
                console.error('Error checking duplicate:', error);
                return false;
            }
        },
        
        /**
         * Validate date range
         * @param {string} startDate - Start date
         * @param {string} endDate - End date
         * @returns {string|null} Error message or null
         */
        validateDateRange(startDate, endDate) {
            if (!startDate || !endDate) return null;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (isNaN(start.getTime())) return 'Invalid start date';
            if (isNaN(end.getTime())) return 'Invalid end date';
            if (end < start) return 'End date must be after start date';
            
            return null;
        },
        
        /**
         * Format validation errors for display
         * @param {Object} errors - Validation errors
         * @returns {string} Formatted error message
         */
        formatErrors(errors) {
            if (!errors || Object.keys(errors).length === 0) return '';
            
            return Object.entries(errors)
                .map(([field, message]) => `${field}: ${message}`)
                .join('\n');
        }
    };
    
    // Enhance clientManager with validation
    function enhanceClientManager() {
        if (!window.clientManager) return;
        
        // Wrap createClient
        const originalCreateClient = window.clientManager.createClient;
        window.clientManager.createClient = async function(clientData) {
            const normalizedClient = { ...clientData };
            if (!normalizedClient.status) {
                normalizedClient.status = normalizedClient.dischargeDate ? 'discharged' : 'active';
            }
            
            // Validate
            const validation = window.clientValidator.validate(normalizedClient);
            
            if (!validation.valid) {
                const errorMsg = window.clientValidator.formatErrors(validation.errors);
                throw new Error(`Validation failed:\n${errorMsg}`);
            }
            
            // Check duplicate
            if (!normalizedClient.isDemo && normalizedClient.initials && normalizedClient.houseId) {
                const isDuplicate = await window.clientValidator.checkDuplicate(
                    normalizedClient.initials,
                    normalizedClient.houseId
                );
                
                if (isDuplicate) {
                    throw new Error(`Client with initials "${normalizedClient.initials}" already exists in ${normalizedClient.houseId}`);
                }
            }
            
            // Call original
            return originalCreateClient.call(this, normalizedClient);
        };
        
        // Wrap updateClient
        const originalUpdateClient = window.clientManager.updateClient;
        window.clientManager.updateClient = async function(clientId, updates) {
            // Get existing client
            const existingClient = await this.getClient(clientId);
            if (!existingClient) {
                throw new Error('Client not found');
            }
            
            // Merge updates with existing data for validation
            const mergedData = { ...existingClient, ...updates };
            if (!mergedData.status) {
                mergedData.status = mergedData.dischargeDate ? 'discharged' : 'active';
            }
            
            // Validate
            const validation = window.clientValidator.validate(mergedData, existingClient);
            
            if (!validation.valid) {
                const errorMsg = window.clientValidator.formatErrors(validation.errors);
                throw new Error(`Validation failed:\n${errorMsg}`);
            }
            
            // Check duplicate if initials or houseId changed
            if (!mergedData.isDemo && (updates.initials || updates.houseId)) {
                const newInitials = updates.initials || existingClient.initials;
                const newHouseId = updates.houseId || existingClient.houseId;
                
                const isDuplicate = await window.clientValidator.checkDuplicate(
                    newInitials,
                    newHouseId,
                    clientId
                );
                
                if (isDuplicate) {
                    throw new Error(`Client with initials "${newInitials}" already exists in ${newHouseId}`);
                }
            }
            
            // Call original
            return originalUpdateClient.call(this, clientId, updates);
        };
    }
    
    // Add validation UI helpers
    window.showValidationErrors = function(errors, container) {
        if (!container) return;
        
        // Remove existing errors
        container.querySelectorAll('.validation-error').forEach(el => el.remove());
        
        // Add error messages
        for (const [field, message] of Object.entries(errors)) {
            const errorEl = document.createElement('div');
            errorEl.className = 'validation-error';
            errorEl.textContent = `${field}: ${message}`;
            container.appendChild(errorEl);
        }
    };
    
    window.clearValidationErrors = function(container) {
        if (!container) return;
        container.querySelectorAll('.validation-error').forEach(el => el.remove());
    };
    
    // Enhance showAddClientModal with validation
    function enhanceAddClientModal() {
        const originalShowAddClientModal = window.showAddClientModal;
        if (!originalShowAddClientModal) return;
        
        window.showAddClientModal = async function() {
            // Call original
            await originalShowAddClientModal.call(this);
            
            // Wait for modal to render
            setTimeout(() => {
                addValidationToModal();
            }, 100);
        };
        
        function addValidationToModal() {
            const modal = document.getElementById('globalModal');
            if (!modal) return;
            
            const form = modal.querySelector('form') || modal.querySelector('.client-form');
            if (!form) return;
            
            // Add real-time validation
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('blur', () => {
                    validateField(input);
                });
                
                input.addEventListener('input', () => {
                    clearFieldError(input);
                });
            });
            
            // Enhance submit handler
            const submitBtn = form.querySelector('button[type="submit"]') || 
                            form.querySelector('.btn-primary');
            
            if (submitBtn) {
                const originalClick = submitBtn.onclick;
                submitBtn.onclick = async function(e) {
                    e.preventDefault();
                    
                    // Validate all fields
                    const formData = new FormData(form);
                    const clientData = Object.fromEntries(formData.entries());
                    
                    // Convert dates
                    if (clientData.admissionDate) {
                        clientData.admissionDate = new Date(clientData.admissionDate).toISOString();
                    }
                    if (clientData.dischargeDate) {
                        clientData.dischargeDate = new Date(clientData.dischargeDate).toISOString();
                    }
                    
                    const validation = window.clientValidator.validate(clientData);
                    
                    if (!validation.valid) {
                        showValidationErrors(validation.errors, form);
                        window.showNotification('Please fix validation errors', 'error');
                        return;
                    }
                    
                    // Check duplicate
                    try {
                        const isDuplicate = await window.clientValidator.checkDuplicate(
                            clientData.initials,
                            clientData.houseId
                        );
                        
                        if (isDuplicate) {
                            window.showNotification(
                                `Client with initials "${clientData.initials}" already exists in ${clientData.houseId}`,
                                'error'
                            );
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking duplicate:', error);
                    }
                    
                    // Call original handler
                    if (originalClick) {
                        originalClick.call(this, e);
                    }
                };
            }
        }
        
        function validateField(input) {
            const field = input.name || input.id;
            const value = input.value;
            
            const rules = validationRules[field];
            if (!rules) return;
            
            const clientData = { [field]: value };
            const validation = window.clientValidator.validate(clientData);
            
            if (validation.errors[field]) {
                showFieldError(input, validation.errors[field]);
            } else {
                clearFieldError(input);
            }
        }
        
        function showFieldError(input, message) {
            clearFieldError(input);
            
            input.classList.add('validation-error-field');
            
            const errorEl = document.createElement('div');
            errorEl.className = 'validation-error-message';
            errorEl.textContent = message;
            
            input.parentNode.insertBefore(errorEl, input.nextSibling);
        }
        
        function clearFieldError(input) {
            input.classList.remove('validation-error-field');
            const errorMsg = input.parentNode.querySelector('.validation-error-message');
            if (errorMsg) {
                errorMsg.remove();
            }
        }
    }
    
    // Add styles
    if (!document.querySelector('#client-data-validation-styles')) {
        const styles = document.createElement('style');
        styles.id = 'client-data-validation-styles';
        styles.textContent = `
            /* Validation Errors */
            .validation-error {
                padding: 8px 12px;
                margin: 8px 0;
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-left: 4px solid #ef4444;
                border-radius: 4px;
                color: #991b1b;
                font-size: 14px;
            }
            
            .validation-error-field {
                border-color: #ef4444 !important;
                box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
            }
            
            .validation-error-message {
                margin-top: 4px;
                font-size: 12px;
                color: #ef4444;
            }
            
            /* Success state */
            .validation-success-field {
                border-color: #22c55e !important;
                box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Initialize
    function initialize() {
        enhanceClientManager();
        enhanceAddClientModal();
        
        console.log('✅ Client data validation initialized');
    }
    
    // Wait for dependencies
    if (window.clientManager) {
        initialize();
    } else {
        const checkInterval = setInterval(() => {
            if (window.clientManager) {
                clearInterval(checkInterval);
                initialize();
            }
        }, 100);
        
        setTimeout(() => clearInterval(checkInterval), 10000);
    }
})();





// Enhancement: discharge-packet-integration.js
/**
 * Discharge Packet Integration Enhancement
 * Adds discharge packet button to client details, auto-populates with client data, updates tracker on completion
 */

(function() {
    'use strict';
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.documentGenerator || !window.showClientDetailsModal || !window.clientManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        integrateDischargePacket();
    }
    
    function integrateDischargePacket() {
        // Override showClientDetailsModal to add discharge packet button
        const originalShowClientDetailsModal = window.showClientDetailsModal;
        
        window.showClientDetailsModal = async function(client) {
            // Call original function
            await originalShowClientDetailsModal.call(this, client);
            
            // Wait for modal to render
            setTimeout(() => {
                addDischargePacketButton(client);
            }, 200);
        };
        
        /**
         * Add discharge packet button to client details modal
         */
        function addDischargePacketButton(client) {
            const modal = document.getElementById('globalModal') || document.querySelector('.modal');
            if (!modal) return;
            
            // Check if button already exists
            if (modal.querySelector('.discharge-packet-btn')) return;
            
            // Find a good place to add the button - look for action buttons or document section
            const actionsSection = modal.querySelector('.client-actions') || 
                                 modal.querySelector('.modal-actions') ||
                                 modal.querySelector('.client-documents-section');
            
            let buttonContainer;
            
            if (actionsSection) {
                // Add button to existing actions section
                buttonContainer = actionsSection;
            } else {
                // Create new actions section
                const modalBody = modal.querySelector('.modal-body') || modal.querySelector('.modal-content');
                if (modalBody) {
                    buttonContainer = document.createElement('div');
                    buttonContainer.className = 'discharge-packet-section';
                    modalBody.appendChild(buttonContainer);
                } else {
                    return; // Can't find a place to add it
                }
            }
            
            // Check if discharge packet is already completed
            const daysInCare = window.daysBetween(client.admissionDate) || 0;
            const isCompleted = client.dischargePacketUploaded;
            const isRecommended = daysInCare >= 25; // Discharge packet min day
            
            // Create button
            const button = document.createElement('button');
            button.className = `btn discharge-packet-btn ${isCompleted ? 'btn-success' : 'btn-primary'}`;
            button.innerHTML = isCompleted 
                ? '✅ Discharge Packet Generated' 
                : '📦 Generate Discharge Packet';
            button.title = isCompleted 
                ? 'Discharge packet already generated'
                : 'Generate discharge packet for this client';
            
            if (!isCompleted && isRecommended) {
                button.onclick = () => generateDischargePacketForClient(client);
            } else if (!isCompleted) {
                button.disabled = true;
                button.title = `Discharge packet available after day 25 (currently day ${daysInCare})`;
            } else {
                button.onclick = () => {
                    window.showNotification('Discharge packet already generated', 'info');
                };
            }
            
            // Insert button
            if (buttonContainer.classList.contains('discharge-packet-section')) {
                buttonContainer.innerHTML = `
                    <h4>📦 Discharge Packet</h4>
                    <p class="discharge-packet-info">
                        ${isCompleted 
                            ? `Generated on ${window.formatDate(client.dischargePacketUploadedDate)}`
                            : isRecommended
                                ? 'Ready to generate discharge packet'
                                : `Available after day 25 (currently day ${daysInCare})`
                        }
                    </p>
                `;
                buttonContainer.appendChild(button);
            } else {
                // Insert at beginning of container
                buttonContainer.insertBefore(button, buttonContainer.firstChild);
            }
        }
        
        /**
         * Generate discharge packet for a specific client (skips client selection)
         */
        async function generateDischargePacketForClient(client) {
            try {
                // Verify client still exists and is active
                const currentClient = await window.clientManager.getClient(client.id);
                if (!currentClient) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                if (currentClient.status !== 'active') {
                    window.showNotification('Can only generate discharge packets for active clients', 'warning');
                    return;
                }
                
                // Check if already completed
                if (currentClient.dischargePacketUploaded) {
                    const confirmed = confirm('Discharge packet already generated. Generate another?');
                    if (!confirmed) return;
                }
                
                // Close client details modal
                window.closeModal();
                
                // Show confirmation dialog
                const daysInCare = window.daysBetween(currentClient.admissionDate) || 0;
                const confirmed = await showDischargePacketConfirmation(currentClient, daysInCare);
                
                if (!confirmed) return;
                
                // Start workflow directly with client and document type pre-selected
                window.documentGenerator.activeWorkflow = {
                    clientId: currentClient.id,
                    client: currentClient,
                    documentType: 'discharge-packet',
                    programs: [] // Will be selected in next step
                };
                
                // Skip to program selection (step 3)
                await window.documentGenerator.selectPrograms();
                
            } catch (error) {
                console.error('Error generating discharge packet:', error);
                window.showNotification('Failed to generate discharge packet', 'error');
            }
        }
        
        /**
         * Show confirmation dialog for discharge packet generation
         */
        async function showDischargePacketConfirmation(client, daysInCare) {
            return new Promise((resolve) => {
                const content = `
                    <div class="discharge-packet-confirmation">
                        <div class="confirmation-header">
                            <h4>📦 Generate Discharge Packet</h4>
                        </div>
                        
                        <div class="client-summary">
                            <div class="summary-row">
                                <span class="label">Client:</span>
                                <span class="value">${client.initials}</span>
                            </div>
                            <div class="summary-row">
                                <span class="label">House:</span>
                                <span class="value">${client.houseId || 'No House'}</span>
                            </div>
                            <div class="summary-row">
                                <span class="label">Days in Care:</span>
                                <span class="value">${daysInCare}</span>
                            </div>
                            ${client.dischargeDate ? `
                                <div class="summary-row">
                                    <span class="label">Discharge Date:</span>
                                    <span class="value">${window.formatDate(client.dischargeDate)}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="confirmation-info">
                            <p>This will generate a complete discharge packet for <strong>${client.initials}</strong>.</p>
                            <p>The following will be included:</p>
                            <ul>
                                <li>Discharge summary</li>
                                <li>Treatment completion details</li>
                                <li>Aftercare recommendations</li>
                                <li>Follow-up instructions</li>
                            </ul>
                            <p class="tracker-note">✓ The client tracker will be automatically updated upon completion.</p>
                        </div>
                    </div>
                `;
                
                window.showModal({
                    title: 'Generate Discharge Packet',
                    content: content,
                    size: 'medium',
                    buttons: [
                        {
                            text: 'Cancel',
                            action: () => {
                                window.closeModal();
                                resolve(false);
                            }
                        },
                        {
                            text: 'Continue',
                            primary: true,
                            action: () => {
                                window.closeModal();
                                resolve(true);
                            }
                        }
                    ]
                });
            });
        }
        
        // Also add quick access from client cards if they exist
        if (window.dashboardWidgets) {
            const originalRenderClient = window.dashboardWidgets.renderClient;
            if (originalRenderClient) {
                window.dashboardWidgets.renderClient = function(client) {
                    let html = originalRenderClient.call(this, client);
                    
                    // Add discharge packet quick button if eligible
                    const daysInCare = window.daysBetween(client.admissionDate) || 0;
                    const isEligible = daysInCare >= 25 && !client.dischargePacketUploaded;
                    
                    if (isEligible) {
                        const buttonHtml = `
                            <button class="btn-discharge-packet-quick" 
                                    onclick="window.generateDischargePacketQuick('${client.id}')"
                                    title="Generate discharge packet for ${client.initials}">
                                📦
                            </button>
                        `;
                        
                        // Insert button in client card actions
                        const insertPos = html.lastIndexOf('</div>');
                        if (insertPos > 0) {
                            html = html.slice(0, insertPos) + buttonHtml + html.slice(insertPos);
                        }
                    }
                    
                    return html;
                };
            }
        }
        
        // Quick access function for client cards
        window.generateDischargePacketQuick = async function(clientId) {
            try {
                const client = await window.clientManager.getClient(clientId);
                if (!client) {
                    window.showNotification('Client not found', 'error');
                    return;
                }
                
                await generateDischargePacketForClient(client);
            } catch (error) {
                console.error('Error generating discharge packet:', error);
                window.showNotification('Failed to generate discharge packet', 'error');
            }
        };
        
        // Add styles
        if (!document.querySelector('#discharge-packet-integration-styles')) {
            const styles = document.createElement('style');
            styles.id = 'discharge-packet-integration-styles';
            styles.textContent = `
                /* Discharge Packet Section */
                .discharge-packet-section {
                    margin-top: 20px;
                    padding: 16px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border: 1px solid #e5e7eb;
                }
                
                .discharge-packet-section h4 {
                    margin: 0 0 8px 0;
                    color: #1f2937;
                    font-size: 16px;
                }
                
                .discharge-packet-info {
                    margin: 0 0 12px 0;
                    color: #6b7280;
                    font-size: 14px;
                }
                
                .discharge-packet-btn {
                    width: 100%;
                    margin-top: 8px;
                    padding: 12px;
                    font-size: 15px;
                    font-weight: 500;
                }
                
                .discharge-packet-btn:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                }
                
                /* Quick button in client cards */
                .btn-discharge-packet-quick {
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 6px 10px;
                    cursor: pointer;
                    font-size: 16px;
                    transition: all 0.2s;
                    margin-left: 4px;
                }
                
                .btn-discharge-packet-quick:hover {
                    background: #5568d3;
                    transform: scale(1.05);
                }
                
                /* Confirmation Dialog */
                .discharge-packet-confirmation {
                    padding: 0;
                }
                
                .confirmation-header {
                    margin-bottom: 20px;
                }
                
                .confirmation-header h4 {
                    margin: 0;
                    color: #1f2937;
                }
                
                .client-summary {
                    background: #f9fafb;
                    padding: 16px;
                    border-radius: 6px;
                    margin-bottom: 20px;
                }
                
                .summary-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 8px;
                }
                
                .summary-row:last-child {
                    margin-bottom: 0;
                }
                
                .summary-row .label {
                    font-weight: 500;
                    color: #6b7280;
                }
                
                .summary-row .value {
                    color: #1f2937;
                    font-weight: 500;
                }
                
                .confirmation-info {
                    margin-bottom: 20px;
                }
                
                .confirmation-info p {
                    margin-bottom: 12px;
                    color: #374151;
                    line-height: 1.6;
                }
                
                .confirmation-info ul {
                    margin: 12px 0 12px 20px;
                    color: #374151;
                }
                
                .confirmation-info li {
                    margin-bottom: 6px;
                }
                
                .tracker-note {
                    margin-top: 16px;
                    padding: 12px;
                    background: #eff6ff;
                    border-left: 4px solid #3b82f6;
                    border-radius: 4px;
                    color: #1e40af;
                    font-weight: 500;
                }
            `;
            document.head.appendChild(styles);
        }
        
        console.log('✅ Discharge packet integration initialized');
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
})();




// Enhancement: widget-rendering-optimization.js
/**
 * Widget Rendering Optimization Enhancement
 * Implements selective widget updates, virtual scrolling for long lists, debounce search inputs
 */

(function() {
    'use strict';
    
    // Debounce utility (if not already available)
    if (!window.debounce) {
        window.debounce = function(func, wait, immediate) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                const later = function() {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        };
    }
    
    // Track which widgets need updates
    const widgetUpdateQueue = new Set();
    let updateScheduled = false;
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.dashboardManager || !window.dashboardWidgets) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        optimizeWidgetRendering();
        addVirtualScrolling();
        debounceSearchInputs();
    }
    
    /**
     * Optimize widget rendering with selective updates
     */
    function optimizeWidgetRendering() {
        const originalRefreshDashboard = window.dashboardManager.refreshDashboard;
        
        // Override refreshDashboard to support selective updates
        window.dashboardManager.refreshDashboard = async function(widgetIds = null) {
            try {
                console.log('🔄 Refreshing dashboard' + (widgetIds ? ` (selective: ${widgetIds.join(', ')})` : ' (full)'));
                
                // If specific widgets requested, only update those
                if (widgetIds && Array.isArray(widgetIds)) {
                    for (const widgetId of widgetIds) {
                        const widget = this.widgets.get(widgetId);
                        if (widget && widget.refresh) {
                            await widget.refresh();
                        }
                    }
                    return true;
                }
                
                // Full refresh - invalidate cache
                this.cache.lastCacheTime = 0;
                await this.loadDashboardData();
                
                // Notify all widgets to update
                for (const [widgetId, widget] of this.widgets) {
                    if (widget.refresh) {
                        await widget.refresh();
                    }
                }
                
                console.log('✅ Dashboard refreshed');
                return true;
            } catch (error) {
                console.error('Failed to refresh dashboard:', error);
                return false;
            }
        };
        
        // Add method to queue widget updates
        window.dashboardManager.queueWidgetUpdate = function(widgetId) {
            widgetUpdateQueue.add(widgetId);
            scheduleWidgetUpdates();
        };
        
        // Schedule batched widget updates
        function scheduleWidgetUpdates() {
            if (updateScheduled) return;
            
            updateScheduled = true;
            requestAnimationFrame(() => {
                if (widgetUpdateQueue.size > 0) {
                    const widgetsToUpdate = Array.from(widgetUpdateQueue);
                    widgetUpdateQueue.clear();
                    window.dashboardManager.refreshDashboard(widgetsToUpdate);
                }
                updateScheduled = false;
            });
        }
        
        // Enhance event system to trigger selective updates
        if (window.publish) {
            const originalPublish = window.publish;
            window.publish = function(event, data) {
                originalPublish.call(this, event, data);
                
                // Map events to widgets that need updating
                const eventWidgetMap = {
                    'client:updated': ['flightPlan', 'journeyRadar', 'missions'],
                    'tracker:updated': ['flightPlan', 'compliance'],
                    'document:generated': ['flightPlan', 'documentHub'],
                    'milestone:completed': ['journeyRadar', 'missions']
                };
                
                const widgetsToUpdate = eventWidgetMap[event] || [];
                if (widgetsToUpdate.length > 0) {
                    widgetsToUpdate.forEach(widgetId => {
                        window.dashboardManager.queueWidgetUpdate(widgetId);
                    });
                }
            };
        }
    }
    
    /**
     * Add virtual scrolling for long lists
     */
    function addVirtualScrolling() {
        // Virtual scrolling implementation for long lists
        window.VirtualScroller = class {
            constructor(container, items, itemHeight = 60, renderItem) {
                this.container = container;
                this.items = items;
                this.itemHeight = itemHeight;
                this.renderItem = renderItem;
                this.scrollTop = 0;
                this.containerHeight = container.clientHeight;
                this.visibleCount = Math.ceil(this.containerHeight / this.itemHeight) + 2; // Buffer
                
                this.init();
            }
            
            init() {
                // Create scroll container
                this.scrollContainer = document.createElement('div');
                this.scrollContainer.className = 'virtual-scroll-container';
                this.scrollContainer.style.height = `${this.containerHeight}px`;
                this.scrollContainer.style.overflowY = 'auto';
                this.scrollContainer.style.position = 'relative';
                
                // Create content spacer
                this.spacer = document.createElement('div');
                this.spacer.style.height = `${this.items.length * this.itemHeight}px`;
                
                // Create visible items container
                this.itemsContainer = document.createElement('div');
                this.itemsContainer.className = 'virtual-items-container';
                this.itemsContainer.style.position = 'absolute';
                this.itemsContainer.style.top = '0';
                this.itemsContainer.style.width = '100%';
                
                this.scrollContainer.appendChild(this.spacer);
                this.scrollContainer.appendChild(this.itemsContainer);
                
                // Replace original container content
                this.container.innerHTML = '';
                this.container.appendChild(this.scrollContainer);
                
                // Add scroll listener
                this.scrollContainer.addEventListener('scroll', () => {
                    this.scrollTop = this.scrollContainer.scrollTop;
                    this.render();
                });
                
                // Initial render
                this.render();
            }
            
            render() {
                const startIndex = Math.floor(this.scrollTop / this.itemHeight);
                const endIndex = Math.min(startIndex + this.visibleCount, this.items.length);
                
                // Update spacer position
                this.itemsContainer.style.top = `${startIndex * this.itemHeight}px`;
                
                // Render visible items
                const visibleItems = this.items.slice(startIndex, endIndex);
                this.itemsContainer.innerHTML = visibleItems.map((item, idx) => {
                    return this.renderItem(item, startIndex + idx);
                }).join('');
            }
            
            updateItems(newItems) {
                this.items = newItems;
                this.spacer.style.height = `${this.items.length * this.itemHeight}px`;
                this.render();
            }
        };
        
        // Enhance widgets that render long lists
        if (window.dashboardWidgets) {
            const originalRenderClient = window.dashboardWidgets.renderClient;
            if (originalRenderClient) {
                // Store original for non-virtual rendering
                window.dashboardWidgets.renderClientOriginal = originalRenderClient;
                
                // Add virtual scrolling option
                window.dashboardWidgets.renderClientList = function(clients, container, useVirtual = false) {
                    if (!useVirtual || clients.length < 20) {
                        // Use regular rendering for small lists
                        container.innerHTML = clients.map(client => originalRenderClient.call(this, client)).join('');
                        return;
                    }
                    
                    // Use virtual scrolling for long lists
                    const itemHeight = 80; // Approximate client card height
                    const renderItem = (client, index) => originalRenderClient.call(this, client);
                    
                    if (!container.virtualScroller) {
                        container.virtualScroller = new window.VirtualScroller(
                            container,
                            clients,
                            itemHeight,
                            renderItem
                        );
                    } else {
                        container.virtualScroller.updateItems(clients);
                    }
                };
            }
        }
    }
    
    /**
     * Debounce search inputs throughout the app
     */
    function debounceSearchInputs() {
        // Find and debounce all search inputs
        function debounceSearchInputsInContainer(container) {
            const searchInputs = container.querySelectorAll('input[type="search"], input[placeholder*="Search" i], input[placeholder*="Filter" i]');
            
            searchInputs.forEach(input => {
                // Skip if already debounced
                if (input.dataset.debounced === 'true') return;
                
                input.dataset.debounced = 'true';
                
                // Get original oninput handler if exists
                const originalHandler = input.oninput;
                
                // Create debounced handler
                const debouncedHandler = window.debounce((e) => {
                    if (originalHandler) {
                        originalHandler.call(input, e);
                    }
                    
                    // Trigger custom event for search
                    const searchEvent = new CustomEvent('search', {
                        detail: { value: e.target.value },
                        bubbles: true
                    });
                    input.dispatchEvent(searchEvent);
                }, 300); // 300ms debounce
                
                // Replace oninput
                input.addEventListener('input', debouncedHandler);
            });
        }
        
        // Debounce existing inputs
        debounceSearchInputsInContainer(document);
        
        // Watch for new inputs added dynamically
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        debounceSearchInputsInContainer(node);
                    }
                });
            });
        });
        
        const attachObserver = () => {
            const target = document.body;
            if (!target) {
                setTimeout(attachObserver, 50);
                return;
            }
            observer.observe(target, {
                childList: true,
                subtree: true
            });
        };

        attachObserver();
        
        // Enhance client search specifically
        if (window.clientManager) {
            const originalSearchClients = window.clientManager.searchClients;
            if (originalSearchClients) {
                window.clientManager.searchClients = window.debounce(originalSearchClients, 300);
            }
        }
    }
    
    // Add performance monitoring
    function addPerformanceMonitoring() {
        if (window.performance && window.performance.mark) {
            // Mark widget render times
            const originalRender = window.dashboardWidgets?.widgets?.get('flightPlan')?.render;
            if (originalRender) {
                const flightPlanWidget = window.dashboardWidgets.widgets.get('flightPlan');
                flightPlanWidget.render = async function() {
                    window.performance.mark('widget-render-start');
                    await originalRender.call(this);
                    window.performance.mark('widget-render-end');
                    window.performance.measure('widget-render', 'widget-render-start', 'widget-render-end');
                    
                    const measure = window.performance.getEntriesByName('widget-render')[0];
                    if (measure.duration > 100) {
                        console.warn(`Widget render took ${measure.duration.toFixed(2)}ms`);
                    }
                };
            }
        }
    }
    
    // Add styles for virtual scrolling
    if (!document.querySelector('#widget-rendering-optimization-styles')) {
        const styles = document.createElement('style');
        styles.id = 'widget-rendering-optimization-styles';
        styles.textContent = `
            /* Virtual Scrolling */
            .virtual-scroll-container {
                position: relative;
            }
            
            .virtual-items-container {
                will-change: transform;
            }
            
            /* Optimize rendering */
            .dashboard-widget {
                contain: layout style paint;
            }
            
            /* Smooth scrolling */
            .virtual-scroll-container {
                scroll-behavior: smooth;
            }
            
            /* Loading states */
            .widget-updating {
                opacity: 0.7;
                pointer-events: none;
            }
        `;
        document.head.appendChild(styles);
    }
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
    
    // Add performance monitoring after a delay
    setTimeout(addPerformanceMonitoring, 1000);
    
    console.log('✅ Widget rendering optimization initialized');
})();




// Enhancement: indexeddb-optimization.js
/**
 * IndexedDB Optimization Enhancement
 * Adds indexes on frequently queried fields (houseId, status, dates), implements query result caching
 */

(function() {
    'use strict';
    
    // Query cache
    const queryCache = new Map();
    const CACHE_DURATION = 30000; // 30 seconds
    
    // Wait for dependencies
    function waitForDependencies() {
        if (!window.indexedDBManager) {
            setTimeout(waitForDependencies, 100);
            return;
        }
        
        addIndexes();
        addQueryCaching();
    }
    
    /**
     * Add indexes to existing stores
     */
    function addIndexes() {
        // Check if we need to upgrade the database
        const currentVersion = indexedDBManager.version || 4;
        const targetVersion = currentVersion + 1;
        
        // We'll enhance the existing methods rather than upgrading
        // This is safer and doesn't require a migration
        
        // Enhance getAllClients to use indexes
        const originalGetAll = indexedDBManager.getAll;
        if (originalGetAll) {
            indexedDBManager.getAll = async function(storeName, indexName = null, query = null) {
                try {
                    const db = await this.getDB();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    
                    let request;
                    
                    // Use index if provided and exists
                    if (indexName && store.indexNames.contains(indexName)) {
                        const index = store.index(indexName);
                        if (query !== null && query !== undefined) {
                            request = index.getAll(query);
                        } else {
                            request = index.openCursor();
                        }
                    } else {
                        request = store.getAll();
                    }
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => {
                            resolve(request.result || []);
                        };
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('Error in getAll:', error);
                    // Fallback to original if available
                    if (originalGetAll) {
                        return originalGetAll.call(this, storeName);
                    }
                    throw error;
                }
            };
        }
        
        // Add query method with index support
        indexedDBManager.query = async function(storeName, filters = {}) {
            try {
                const db = await this.getDB();
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                
                // Build query based on available indexes
                let indexName = null;
                let queryValue = null;
                
                // Prefer indexed fields
                if (filters.houseId && store.indexNames.contains('houseId')) {
                    indexName = 'houseId';
                    queryValue = filters.houseId;
                } else if (filters.status && store.indexNames.contains('status')) {
                    indexName = 'status';
                    queryValue = filters.status;
                }
                
                let results = [];
                
                if (indexName) {
                    // Use index for faster query
                    const index = store.index(indexName);
                    const request = index.getAll(queryValue);
                    
                    results = await new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => reject(request.error);
                    });
                } else {
                    // Fallback to full scan with filtering
                    const request = store.getAll();
                    results = await new Promise((resolve, reject) => {
                        request.onsuccess = () => {
                            let filtered = request.result || [];
                            
                            // Apply filters
                            if (filters.houseId) {
                                filtered = filtered.filter(item => item.houseId === filters.houseId);
                            }
                            if (filters.status) {
                                filtered = filtered.filter(item => item.status === filters.status);
                            }
                            if (filters.admissionDateFrom) {
                                const fromDate = new Date(filters.admissionDateFrom);
                                filtered = filtered.filter(item => {
                                    if (!item.admissionDate) return false;
                                    return new Date(item.admissionDate) >= fromDate;
                                });
                            }
                            if (filters.admissionDateTo) {
                                const toDate = new Date(filters.admissionDateTo);
                                filtered = filtered.filter(item => {
                                    if (!item.admissionDate) return false;
                                    return new Date(item.admissionDate) <= toDate;
                                });
                            }
                            
                            resolve(filtered);
                        };
                        request.onerror = () => reject(request.error);
                    });
                }
                
                return results;
            } catch (error) {
                console.error('Error in query:', error);
                throw error;
            }
        };
    }
    
    /**
     * Add query result caching
     */
    function addQueryCaching() {
        // Cache key generator
        function getCacheKey(storeName, filters) {
            return `${storeName}:${JSON.stringify(filters)}`;
        }
        
        // Check if cache entry is valid
        function isCacheValid(entry) {
            if (!entry) return false;
            const age = Date.now() - entry.timestamp;
            return age < CACHE_DURATION;
        }
        
        // Enhanced getAllClients with caching
        if (indexedDBManager.getAllClients) {
            const originalGetAllClients = indexedDBManager.getAllClients;
            
            indexedDBManager.getAllClients = async function(filters = {}) {
                const cacheKey = getCacheKey('clients', filters);
                const cached = queryCache.get(cacheKey);
                
                if (isCacheValid(cached)) {
                    console.log('📦 Using cached clients query');
                    return cached.data;
                }
                
                // Execute query
                let results;
                if (Object.keys(filters).length > 0) {
                    results = await this.query('clients', filters);
                } else {
                    results = await originalGetAllClients.call(this);
                }
                
                // Cache results
                queryCache.set(cacheKey, {
                    data: results,
                    timestamp: Date.now()
                });
                
                return results;
            };
        }
        
        // Enhanced getClientsByHouse with caching
        if (indexedDBManager.getClientsByHouse) {
            const originalGetClientsByHouse = indexedDBManager.getClientsByHouse;
            
            indexedDBManager.getClientsByHouse = async function(houseId) {
                const cacheKey = getCacheKey('clients', { houseId });
                const cached = queryCache.get(cacheKey);
                
                if (isCacheValid(cached)) {
                    console.log(`📦 Using cached clients for house ${houseId}`);
                    return cached.data;
                }
                
                const results = await originalGetClientsByHouse.call(this, houseId);
                
                queryCache.set(cacheKey, {
                    data: results,
                    timestamp: Date.now()
                });
                
                return results;
            };
        }
        
        // Enhanced getClientsByStatus with caching
        if (indexedDBManager.getClientsByStatus) {
            const originalGetClientsByStatus = indexedDBManager.getClientsByStatus;
            
            indexedDBManager.getClientsByStatus = async function(status) {
                const cacheKey = getCacheKey('clients', { status });
                const cached = queryCache.get(cacheKey);
                
                if (isCacheValid(cached)) {
                    console.log(`📦 Using cached clients with status ${status}`);
                    return cached.data;
                }
                
                const results = await originalGetClientsByStatus.call(this, status);
                
                queryCache.set(cacheKey, {
                    data: results,
                    timestamp: Date.now()
                });
                
                return results;
            };
        }
        
        // Add cache invalidation methods
        indexedDBManager.invalidateCache = function(storeName = null) {
            if (storeName) {
                // Invalidate specific store
                for (const [key] of queryCache) {
                    if (key.startsWith(storeName + ':')) {
                        queryCache.delete(key);
                    }
                }
            } else {
                // Invalidate all
                queryCache.clear();
            }
            console.log('🗑️ Cache invalidated' + (storeName ? ` for ${storeName}` : ''));
        };
        
        // Auto-invalidate cache on updates
        if (indexedDBManager.put) {
            const originalPut = indexedDBManager.put;
            indexedDBManager.put = async function(storeName, data) {
                const result = await originalPut.call(this, storeName, data);
                this.invalidateCache(storeName);
                return result;
            };
        }
        
        if (indexedDBManager.delete) {
            const originalDelete = indexedDBManager.delete;
            indexedDBManager.delete = async function(storeName, key) {
                const result = await originalDelete.call(this, storeName, key);
                this.invalidateCache(storeName);
                return result;
            };
        }
        
        // Clean up old cache entries periodically
        setInterval(() => {
            const now = Date.now();
            for (const [key, entry] of queryCache) {
                if (!isCacheValid(entry)) {
                    queryCache.delete(key);
                }
            }
        }, CACHE_DURATION);
    }
    
    // Integrate with event system for cache invalidation
    if (window.subscribe) {
        window.subscribe('client:updated', () => {
            if (indexedDBManager.invalidateCache) {
                indexedDBManager.invalidateCache('clients');
            }
        });
        
        window.subscribe('tracker:updated', () => {
            if (indexedDBManager.invalidateCache) {
                indexedDBManager.invalidateCache('clients');
            }
        });
    }
    
    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDependencies);
    } else {
        waitForDependencies();
    }
    
    console.log('✅ IndexedDB optimization initialized');
})();




// Enhancement: onboarding-integration.js
/**
 * Onboarding System Integration
 * Loads onboarding assets and initializes the manager when the dashboard is ready.
 */

(function() {
    'use strict';

    // Feature flag: disable onboarding integration until assets are ready
    const ONBOARDING_ENABLED = false;
    if (!ONBOARDING_ENABLED) {
        console.log('[Onboarding] Disabled via feature flag');
        return;
    }

    if (window.__onboardingIntegrationLoaded) return;
    window.__onboardingIntegrationLoaded = true;

    const ASSET_PATH = 'onboarding/';
    const SCRIPT_FILES = [
        'onboarding-content.js',
        'onboarding-manager.js',
        'onboarding-video.js',
        'onboarding-tour.js',
        'onboarding-practice.js',
        'user-agreement.js'
    ];

    // Track if scripts are loading to prevent duplicate loads
    let scriptsLoading = false;
    let scriptsLoaded = false;

    function loadScript(src) {
        return new Promise((resolve, reject) => {
            if (document.querySelector(`script[data-onboarding="${src}"]`)) {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = src;
            script.async = false;
            script.dataset.onboarding = src;
            script.onload = resolve;
            script.onerror = () => reject(new Error(`Failed to load ${src}`));
            document.head.appendChild(script);
        });
    }

    function ensureStyles() {
        if (document.querySelector('link[data-onboarding-style="styles"]')) return;
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = `${ASSET_PATH}onboarding-styles.css`;
        link.dataset.onboardingStyle = 'styles';
        document.head.appendChild(link);
    }

    function loadAssets() {
        if (scriptsLoaded) {
            console.log('[Onboarding] Assets already loaded');
            return Promise.resolve();
        }
        
        if (scriptsLoading) {
            console.log('[Onboarding] Assets already loading, waiting...');
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (scriptsLoaded) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 5000);
            });
        }

        scriptsLoading = true;
        ensureStyles();
        
        return SCRIPT_FILES.reduce((promise, file) => {
            return promise.then(() => {
                console.log(`[Onboarding] Loading ${file}...`);
                return loadScript(`${ASSET_PATH}${file}`);
            }).then(() => {
                console.log(`[Onboarding] Loaded ${file}`);
            });
        }, Promise.resolve()).then(() => {
            scriptsLoaded = true;
            scriptsLoading = false;
            console.log('[Onboarding] All assets loaded');
            
            // Ensure manager is available
            if (!window.onboardingManager) {
                console.warn('[Onboarding] Manager not found after loading scripts, waiting...');
                return new Promise((resolve) => {
                    const checkManager = setInterval(() => {
                        if (window.onboardingManager) {
                            clearInterval(checkManager);
                            resolve();
                        }
                    }, 100);
                    setTimeout(() => {
                        clearInterval(checkManager);
                        resolve();
                    }, 2000);
                });
            }
        });
    }

    function waitForDashboardReady(timeoutMs = 30000) {
        return new Promise((resolve, reject) => {
            const start = Date.now();

            const interval = setInterval(() => {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const dashboardVisible = document.querySelector('.dashboard-container, #dashboardTab, [data-page="dashboard"], .dashboard-manager');
                const managerAvailable = window.onboardingManager;

                if (isLoggedIn && managerAvailable) {
                    // If dashboard is visible, great. If not, still proceed after a short delay
                    if (dashboardVisible || Date.now() - start > 2000) {
                        clearInterval(interval);
                        console.log('[Onboarding] Dashboard ready, initializing...');
                        resolve();
                    }
                }

                if (Date.now() - start > timeoutMs) {
                    clearInterval(interval);
                    console.warn('[Onboarding] Timeout waiting for dashboard, proceeding anyway...');
                    resolve(); // Resolve instead of reject to still try initialization
                }
            }, 500);
        });
    }

    async function initializeOnboarding() {
        try {
            console.log('[Onboarding] Starting initialization...');
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) {
                console.log('[Onboarding] User not logged in, skipping');
                return;
            }

            await loadAssets();
            console.log('[Onboarding] Assets loaded, waiting for dashboard...');
            await waitForDashboardReady();
            
            // Wait a moment for manager to be available
            let attempts = 0;
            while (!window.onboardingManager && attempts < 10) {
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }

            if (window.onboardingManager && typeof window.onboardingManager.initialize === 'function') {
                console.log('[Onboarding] Initializing manager...');
                await window.onboardingManager.initialize();
                console.log('[Onboarding] Manager initialized successfully');
            } else {
                console.error('[Onboarding] Manager not available after loading assets');
                console.error('[Onboarding] window.onboardingManager:', window.onboardingManager);
                console.error('[Onboarding] Available globals:', Object.keys(window).filter(k => k.includes('onboard')));
            }
        } catch (error) {
            console.error('[Onboarding] Error during initialization:', error);
        }
    }

    function hookLoginFlow() {
        // Hook into showDashboard if it exists
        const originalShowDashboard = window.showDashboard;
        if (originalShowDashboard) {
            window.showDashboard = async function(...args) {
                const result = originalShowDashboard.apply(this, args);
                setTimeout(() => initializeOnboarding(), 500);
                return result;
            };
        }

        // Also watch for login state changes
        const checkLoginState = () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (isLoggedIn) {
                setTimeout(() => initializeOnboarding(), 1000);
            }
        };

        // Check immediately
        checkLoginState();

        // Watch for changes
        const originalSetItem = Storage.prototype.setItem;
        Storage.prototype.setItem = function(key, value) {
            originalSetItem.apply(this, arguments);
            if (key === 'isLoggedIn' && value === 'true') {
                setTimeout(() => initializeOnboarding(), 1000);
            }
        };
    }

    function hookKeyboardShortcut() {
        document.addEventListener('keydown', (event) => {
            const isShortcut = (event.ctrlKey || event.metaKey) && event.shiftKey && event.key.toLowerCase() === 'o';
            if (!isShortcut) return;
            event.preventDefault();
            loadAssets().then(() => {
                if (window.onboardingManager) {
                    window.onboardingManager.replay();
                }
            });
        });
    }

    hookLoginFlow();
    hookKeyboardShortcut();

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initializeOnboarding();
    } else {
        window.addEventListener('DOMContentLoaded', initializeOnboarding);
    }

    window.triggerOnboardingTutorial = () => initializeOnboarding();
})();



</script>
    <!-- Client Tracking Styles -->
    <style>
        /* Base Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        /* Client Tracking Styles */
        .tab-navigation {
            display: none !important;
            visibility: hidden !important;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            background: #f9fafb;
            color: #374151;
            transform: translateY(-1px);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }
        
        .tab-content {
            display: none;
            height: 100%;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .client-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .client-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .client-header h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
        }
        
        .current-client-banner {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .current-client-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-avatar {
            width: 50px;
            height: 50px;
            background: white;
            color: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .client-details {
            flex: 1;
        }
        
        .client-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .client-id {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .client-actions {
            display: flex;
            gap: 10px;
        }
        
        .client-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .client-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .client-quick-add {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .client-form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .client-form-group {
            flex: 1;
        }
        
        .client-form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #4b5563;
            font-weight: 500;
        }
        
        .client-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .client-form-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .add-client-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-client-btn:hover {
            background: #5558e3;
        }
        
        .client-list-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .client-list-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-list-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-filter-tabs {
            display: flex;
            gap: 10px;
        }
        
        .client-filter-tab {
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .client-filter-tab:hover {
            border-color: #d1d5db;
            color: #4b5563;
        }
        
        .client-filter-tab.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .client-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .client-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .client-card:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .client-card.selected {
            background: #ede9fe;
            border-color: #8b5cf6;
        }
        
        .client-card-avatar {
            width: 40px;
            height: 40px;
            background: #e5e7eb;
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .client-card-info {
            flex: 1;
        }
        
        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .client-card-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .client-card-kipu {
            font-size: 14px;
            color: #6b7280;
        }
        
        .client-card-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #6b7280;
        }
        
        .client-status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .client-status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .client-status-badge.waitlist {
            background: #fef3c7;
            color: #92400e;
        }
        
        .client-status-badge.discharged {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .client-empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .client-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .client-search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        /* Alert Animation */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Milestone Indicator Styles */
        .milestone-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .milestone-indicator.complete {
            background-color: #10b981;
            color: white;
        }
        
        .milestone-indicator.overdue {
            background-color: #ef4444;
            color: white;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .milestone-indicator.due-today {
            background-color: #f59e0b;
            color: white;
        }
        
        .milestone-indicator.due-soon {
            background-color: #f59e0b;
            color: white;
            opacity: 0.8;
        }
        
        .milestone-indicator.in-progress {
            background-color: #3b82f6;
            color: white;
        }
        
        .milestone-indicator.pending {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .8;
            }
        }
        
        /* Days in care color coding */
        .days-in-care {
            font-weight: 500;
        }
        
        td.days-in-care {
            text-align: center;
        }
        
        /* Color code days based on milestones */
        .days-13 { color: #f59e0b; font-weight: 600; }
        .days-14 { color: #f59e0b; font-weight: 600; }
        .days-16plus { color: #ef4444; font-weight: 600; }
        
        /* CM Tracker House Navigation */
        .cm-tracker-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #f9fafb;
        }
        
        .house-navigation {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 0;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .house-tabs {
            display: flex;
            gap: 0;
            flex: 1;
            overflow-x: auto;
        }
        
        .house-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        
        .house-tab:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .house-tab.active {
            color: #6366f1;
            background: #eef2ff;
            border-bottom-color: #6366f1;
        }
        
        .house-tab .client-count {
            margin-left: 5px;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: normal;
        }
        
        .house-tab.active .client-count {
            background: #6366f1;
            color: white;
        }
        
        .house-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        .cm-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .cm-action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .cm-action-btn:hover {
            background: #f9fafb;
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .cm-action-btn.primary {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .cm-action-btn.primary:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }
        
        /* Prevent accidental JSON rendering */
        body > *:not(script):not(style):not(link) {
            white-space: normal;
        }
        
        /* Hide any raw JSON that might accidentally render */
        body > pre:not(.code-block),
        body > code:not(.inline-code) {
            display: none !important;
        }
        
        .clients-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .clients-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .clients-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .clients-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            color: #1f2937;
        }
        
        .clients-table tr:hover {
            background: #f9fafb;
        }
        
        .client-initials {
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
        }
        
        .client-initials:hover {
            color: #6366f1;
            text-decoration: underline;
        }
        
        .days-in-care {
            font-weight: 500;
            color: #6b7280;
        }
        
        .team-member {
            font-size: 13px;
            color: #6b7280;
        }
        
        .milestone-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .milestone-indicator.complete {
            background: #10b981;
            color: white;
        }
        
        .milestone-indicator.pending {
            background: #f3f4f6;
            color: #9ca3af;
            border: 1px solid #e5e7eb;
        }
        
        .milestone-indicator.overdue {
            background: #ef4444;
            color: white;
        }
        
        .aftercare-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .aftercare-status.sent {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .aftercare-status.engaged {
            background: #fef3c7;
            color: #92400e;
        }
        
        .aftercare-status.accepted {
            background: #d1fae5;
            color: #065f46;
        }
        
        .aftercare-status.declined {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 4px 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #e5e7eb;
        }
        
        /* Dark mode action buttons */
        body.dark-mode .action-btn,
        [data-theme="dark"] .action-btn {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(148, 163, 184, 0.3);
            color: #e2e8f0;
        }
        
        body.dark-mode .action-btn:hover,
        [data-theme="dark"] .action-btn:hover {
            background: rgba(51, 65, 85, 0.9);
            border-color: rgba(148, 163, 184, 0.5);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .empty-state-text {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 500px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #1f2937;
            font-size: 20px;
        }
        
        .modal-content label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
            font-size: 14px;
        }
        
        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
    
/* Enhancement: styles.css */

/* Custom Enhancements - Add your custom styles here */

/* Modal Overlay Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
}

/* Form Enhancements */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #2d3748;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #667eea;
}

.form-group small {
    display: block;
    margin-top: 4px;
    font-size: 12px;
}

/* Button Styles */
.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}

.btn-primary:hover {
    transform: translateY(-2px);
}

.btn-secondary {
    background: #e2e8f0;
    color: #2d3748;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-secondary:hover {
    background: #cbd5e0;
}

.btn-icon {
    background: transparent;
    border: 1px solid #e2e8f0;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    margin-left: 10px;
    transition: all 0.2s;
}

.btn-icon:hover {
    background: #f7fafc;
    border-color: #cbd5e0;
}

/* Notifications */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Enhancement: unified-design.css */


/* Enhancement: tracker-ui.css */
/**
 * Tracker UI Styles
 * Visual enhancements for tracker completion indicators
 */

/* Tracker Status in Client Cards */
.tracker-status {
    margin: 10px 0;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tracker-status:hover {
    background: #e9ecef;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Risk Level Indicators */
.tracker-status.risk-red {
    border-left: 4px solid #dc3545;
    background: #fff5f5;
}

.tracker-status.risk-yellow {
    border-left: 4px solid #ffc107;
    background: #fffdf5;
}

.tracker-status.risk-green {
    border-left: 4px solid #28a745;
    background: #f5fff7;
}

/* Completion Bar */
.completion-bar {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.completion-fill {
    height: 100%;
    background: linear-gradient(90deg, #0099cc 0%, #006699 100%);
    transition: width 0.5s ease;
    position: relative;
}

.completion-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255,255,255,0.3) 50%,
        transparent 100%
    );
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Completion Text */
.completion-text {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    margin-bottom: 4px;
}

.completion-percentage {
    font-weight: 600;
    color: #333;
}

.critical-missing {
    color: #dc3545;
    font-weight: 500;
}

/* Missing Items */
.missing-items {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
    font-style: italic;
}

/* Tracker Modal */
.tracker-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.tracker-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tracker-modal-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tracker-modal-header h3 {
    margin: 0;
    font-size: 20px;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.3s ease;
}

.close-btn:hover {
    background: rgba(255,255,255,0.2);
}

.tracker-modal-content {
    padding: 20px;
    overflow-y: auto;
    max-height: calc(80vh - 70px);
}

/* Summary Stats */
.tracker-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.summary-stat {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: #0099cc;
}

/* Missing & Upcoming Sections */
.missing-critical-section,
.upcoming-section {
    margin-bottom: 20px;
}

.missing-critical-section h4,
.upcoming-section h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 16px;
}

.missing-list,
.upcoming-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.missing-item,
.upcoming-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.missing-item:hover,
.upcoming-item:hover {
    border-color: #0099cc;
    box-shadow: 0 2px 8px rgba(0,153,204,0.1);
}

.missing-item {
    border-left: 3px solid #dc3545;
}

.upcoming-item {
    border-left: 3px solid #ffc107;
}

.item-label {
    font-weight: 500;
    color: #333;
}

.item-due {
    font-size: 12px;
    color: #666;
}

/* Tracker Actions */
.tracker-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.tracker-actions button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,153,204,0.3);
}

.btn-secondary {
    background: #f8f9fa;
    color: #333;
    border: 1px solid #dee2e6;
}

.btn-secondary:hover {
    background: #e9ecef;
}

/* Dashboard Integration */
.client-card {
    position: relative;
    transition: all 0.3s ease;
}

.client-card:has(.tracker-status.risk-red) {
    border-color: #dc3545;
}

.client-card:has(.tracker-status.risk-yellow) {
    border-color: #ffc107;
}

/* Flight Plan Integration */
.priority-item[data-tracker-generated="true"] {
    position: relative;
}

.priority-item[data-tracker-generated="true"]::before {
    content: '🤖';
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    opacity: 0.5;
}

/* Timeline Modal Specific */
.timeline-modal-large {
    width: 95%;
    max-width: 1200px;
}

.timeline-modal-large .tracker-modal-content {
    max-height: calc(90vh - 70px);
}

/* Responsive Design */
@media (max-width: 768px) {
    .tracker-modal {
        width: 95%;
        max-height: 90vh;
    }
    
    .tracker-summary {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .completion-text {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .tracker-actions {
        flex-direction: column;
    }
}


/* Enhancement: tracker-timeline.css */
/**
 * Tracker Timeline Styles
 * Visual timeline component for tracker progress
 */

/* Timeline Container */
.tracker-timeline {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Timeline Header */
.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.timeline-title h3 {
    margin: 0;
    color: #333;
    font-size: 20px;
}

.timeline-subtitle {
    display: block;
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.timeline-stats {
    display: flex;
    gap: 20px;
}

.stat-badge {
    text-align: center;
}

.stat-value {
    display: block;
    font-size: 28px;
    font-weight: 700;
    color: #0099cc;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Timeline Container */
.timeline-container {
    position: relative;
    margin: 40px 0;
    padding: 40px 0;
}

/* Timeline Track */
.timeline-track {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 4px;
    background: #e0e0e0;
    transform: translateY(-50%);
    border-radius: 2px;
}

.timeline-progress {
    height: 100%;
    background: linear-gradient(90deg, #0099cc 0%, #006699 100%);
    border-radius: 2px;
    transition: width 0.5s ease;
}

/* Timeline Markers */
.timeline-markers {
    position: relative;
    height: 60px;
}

.timeline-marker {
    position: absolute;
    transform: translateX(-50%);
}

.marker-line {
    width: 2px;
    height: 40px;
    background: #999;
    margin: 0 auto;
}

.marker-label {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    margin-top: 5px;
    text-align: center;
}

.timeline-marker.admission .marker-line {
    background: #28a745;
}

.timeline-marker.current .marker-line {
    background: #0099cc;
    width: 3px;
}

.timeline-marker.current .marker-label {
    font-weight: 600;
    color: #0099cc;
}

.timeline-marker.discharge .marker-line {
    background: #dc3545;
}

/* Timeline Items */
.timeline-items {
    position: relative;
    min-height: 200px;
    margin-top: 40px;
}

.timeline-group {
    position: absolute;
    transform: translateX(-50%);
}

.group-connector {
    width: 2px;
    height: 20px;
    background: #ddd;
    margin: 0 auto;
}

.group-label {
    font-size: 12px;
    color: #666;
    text-align: center;
    margin-bottom: 10px;
    font-weight: 600;
}

.group-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
}

/* Timeline Item */
.timeline-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    white-space: nowrap;
}

.timeline-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.item-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
}

.item-icon.complete {
    background: #28a745;
    color: white;
}

.item-icon.pending {
    background: #e0e0e0;
    color: #666;
}

.item-icon.upcoming {
    background: #ffc107;
    color: white;
}

.item-icon.overdue {
    background: #dc3545;
    color: white;
}

.item-content {
    flex: 1;
}

.item-title {
    font-size: 13px;
    font-weight: 500;
    color: #333;
    display: flex;
    align-items: center;
    gap: 5px;
}

.critical-badge {
    color: #dc3545;
    font-size: 12px;
}

.item-date {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
}

/* Timeline Item Status Colors */
.timeline-item.complete {
    background: #e8f5e9;
}

.timeline-item.overdue {
    background: #ffebee;
}

.timeline-item.upcoming {
    background: #fff8e1;
}

/* Tooltip */
.item-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-10px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
    pointer-events: none;
}

.item-tooltip.visible {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
}

.tooltip-content {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    min-width: 250px;
}

.tooltip-content h4 {
    margin: 0 0 8px 0;
    color: #333;
    font-size: 14px;
}

.tooltip-content p {
    margin: 0 0 10px 0;
    font-size: 12px;
    color: #666;
    line-height: 1.5;
}

.tooltip-status {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

.btn-mark-complete {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-mark-complete:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,153,204,0.3);
}

/* Legend */
.timeline-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #666;
}

.legend-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}

.legend-icon.complete {
    background: #28a745;
    color: white;
}

.legend-icon.pending {
    background: #e0e0e0;
    color: #666;
}

.legend-icon.overdue {
    background: #dc3545;
    color: white;
}

.legend-icon.critical {
    background: transparent;
    color: #dc3545;
}

/* Notifications */
.timeline-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 10000;
}

.timeline-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.timeline-notification.success {
    background: #28a745;
}

.timeline-notification.error {
    background: #dc3545;
}

.timeline-notification.info {
    background: #0099cc;
}

/* Responsive Design */
@media (max-width: 768px) {
    .timeline-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .timeline-stats {
        justify-content: center;
    }
    
    .timeline-container {
        overflow-x: auto;
        padding-bottom: 60px;
    }
    
    .timeline-items {
        min-width: 600px;
    }
    
    .timeline-legend {
        flex-wrap: wrap;
        gap: 10px;
    }
}


/* Enhancement: tracker-bulk-update.css */
/**
 * Tracker Bulk Update Modal Styles
 * Quick-entry interface for updating multiple tracker items
 */

/* Overlay */
.bulk-update-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

/* Modal Container */
.bulk-update-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

/* Header */
.bulk-update-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-info h3 {
    margin: 0 0 8px 0;
    font-size: 20px;
}

.header-stats {
    display: flex;
    gap: 15px;
    font-size: 14px;
    opacity: 0.9;
}

.header-stats .stat {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.header-stats .stat::after {
    content: '•';
    margin-left: 10px;
    opacity: 0.5;
}

.header-stats .stat:last-child::after {
    display: none;
}

/* Content */
.bulk-update-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Filters */
.bulk-update-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.filter-btn {
    padding: 8px 16px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-btn:hover {
    background: #f8f9fa;
}

.filter-btn.active {
    background: #0099cc;
    color: white;
    border-color: #0099cc;
}

/* Categories */
.bulk-update-categories {
    margin-bottom: 20px;
}

.update-category {
    margin-bottom: 25px;
}

.category-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid #e0e0e0;
}

.category-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Items */
.update-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.update-item:hover {
    background: #e9ecef;
}

.update-item.complete {
    background: #e8f5e9;
}

.update-item.overdue {
    background: #ffebee;
    border-left: 3px solid #dc3545;
}

.item-label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    flex: 1;
}

.item-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.item-text {
    font-size: 14px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.critical-badge {
    color: #dc3545;
    font-size: 12px;
}

.item-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
}

.completed-date {
    color: #28a745;
}

.due-date {
    color: #666;
}

.overdue-badge {
    background: #dc3545;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

/* Notes Section */
.bulk-update-notes {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.bulk-update-notes label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.bulk-update-notes textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 14px;
    resize: vertical;
    font-family: inherit;
}

.bulk-update-notes textarea:focus {
    outline: none;
    border-color: #0099cc;
    box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
}

/* Footer */
.bulk-update-footer {
    padding: 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

.footer-info {
    font-size: 14px;
    color: #666;
}

.footer-actions {
    display: flex;
    gap: 10px;
}

.footer-actions button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary {
    background: white;
    color: #333;
    border: 1px solid #dee2e6;
}

.btn-secondary:hover {
    background: #e9ecef;
}

.btn-primary {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,153,204,0.3);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Notifications */
.bulk-update-notification {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.bulk-update-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.bulk-update-notification.success {
    background: #28a745;
}

.bulk-update-notification.error {
    background: #dc3545;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .bulk-update-modal {
        width: 95%;
        max-height: 95vh;
    }
    
    .bulk-update-header {
        padding: 15px;
    }
    
    .header-info h3 {
        font-size: 18px;
    }
    
    .header-stats {
        font-size: 12px;
    }
    
    .bulk-update-filters {
        flex-wrap: wrap;
    }
    
    .update-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .item-info {
        margin-left: 30px;
    }
    
    .footer-actions {
        flex-direction: column;
        width: 100%;
    }
    
    .footer-actions button {
        width: 100%;
    }
}


/* Enhancement: tracker-compliance-widget.css */
/**
 * Tracker Compliance Widget Styles
 * House-level compliance dashboard visualization
 */

/* Widget Container */
.compliance-widget {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Widget Header */
.compliance-widget .widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.compliance-widget .widget-header h3 {
    margin: 0;
    font-size: 18px;
    color: #333;
}

.refresh-btn {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    background: #f8f9fa;
    transform: rotate(180deg);
}

.refresh-icon {
    font-size: 16px;
    color: #666;
}

/* Compliance Overview */
.compliance-overview {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 20px;
    margin-bottom: 25px;
    padding-bottom: 25px;
    border-bottom: 1px solid #e0e0e0;
}

/* Overall Score Circle */
.overall-score {
    display: flex;
    align-items: center;
    justify-content: center;
}

.score-circle {
    position: relative;
    width: 100px;
    height: 100px;
}

.circular-chart {
    display: block;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.circle-bg {
    fill: none;
    stroke: #f0f0f0;
    stroke-width: 2.8;
}

.circle {
    fill: none;
    stroke: #0099cc;
    stroke-width: 2.8;
    stroke-linecap: round;
    animation: progress 1s ease-out forwards;
}

@keyframes progress {
    0% {
        stroke-dasharray: 0 100;
    }
}

.percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.percentage .value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: #0099cc;
}

.percentage .label {
    display: block;
    font-size: 11px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Compliance Metrics */
.compliance-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    align-items: center;
}

.metric {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.metric-value {
    display: block;
    font-size: 28px;
    font-weight: 700;
    color: #333;
    margin-bottom: 5px;
}

.metric-label {
    display: block;
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* House Compliance List */
.house-compliance-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

/* House Card */
.house-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.house-card.good {
    border-color: #28a745;
}

.house-card.warning {
    border-color: #ffc107;
}

.house-card.danger {
    border-color: #dc3545;
}

.house-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.house-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.house-header h4 {
    margin: 0;
    font-size: 16px;
    color: #333;
}

.house-score {
    font-size: 20px;
    font-weight: 700;
}

.house-card.good .house-score {
    color: #28a745;
}

.house-card.warning .house-score {
    color: #ffc107;
}

.house-card.danger .house-score {
    color: #dc3545;
}

/* House Details */
.house-details {
    margin-bottom: 12px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    padding: 3px 0;
}

.detail-row span:first-child {
    color: #666;
}

.detail-row span:last-child {
    font-weight: 600;
    color: #333;
}

.text-danger {
    color: #dc3545 !important;
}

/* Category Breakdown */
.category-breakdown {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e0e0e0;
}

.category-bar {
    display: grid;
    grid-template-columns: 60px 1fr 40px;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}

.cat-label {
    font-size: 11px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.cat-progress {
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
}

.cat-fill {
    height: 100%;
    background: linear-gradient(90deg, #0099cc 0%, #006699 100%);
    transition: width 0.5s ease;
}

.cat-value {
    font-size: 11px;
    font-weight: 600;
    color: #333;
    text-align: right;
}

/* At Risk Section */
.at-risk-section {
    background: #fff5f5;
    border: 1px solid #ffcdd2;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.at-risk-section h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    color: #c62828;
}

.at-risk-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.at-risk-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid #ffebee;
}

.client-info {
    font-size: 13px;
    color: #333;
}

.action-btn {
    padding: 6px 12px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-btn:hover {
    background: #c82333;
    transform: translateY(-1px);
}

/* Widget Error */
.widget-error {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}

/* Responsive Design */
@media (max-width: 768px) {
    .compliance-overview {
        grid-template-columns: 1fr;
        text-align: center;
    }
    
    .overall-score {
        margin: 0 auto 20px;
    }
    
    .compliance-metrics {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .house-compliance-list {
        grid-template-columns: 1fr;
    }
    
    .metric {
        padding: 10px;
    }
    
    .metric-value {
        font-size: 20px;
    }
}


/* Enhancement: tracker-document-hub.css */
/**
 * Tracker Document Hub Styles
 * Visual status indicators for document tracking
 */

/* Document Hub Overlay */
.document-hub-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

/* Document Hub Modal */
.document-hub-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

/* Header */
.document-hub-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.document-hub-header h3 {
    margin: 0;
    font-size: 20px;
}

/* Content */
.document-hub-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Document Summary */
.document-summary {
    margin-bottom: 25px;
    padding-bottom: 25px;
    border-bottom: 2px solid #e0e0e0;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
}

.summary-stat {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.summary-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.summary-stat.danger {
    background: #ffebee;
    border: 1px solid #ffcdd2;
}

.summary-stat.warning {
    background: #fff8e1;
    border: 1px solid #ffe0b2;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #0099cc;
    display: block;
    margin-bottom: 5px;
}

.summary-stat.danger .stat-value {
    color: #dc3545;
}

.summary-stat.warning .stat-value {
    color: #ffc107;
}

.stat-label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Document Categories */
.document-categories {
    margin-bottom: 20px;
}

.document-category {
    margin-bottom: 25px;
}

.document-category h4 {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 15px 0;
    padding-bottom: 8px;
    border-bottom: 2px solid #e0e0e0;
}

/* Document List */
.document-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Document Item */
.document-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.document-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.document-item.complete {
    background: #e8f5e9;
    border-color: #4caf50;
}

.document-item.overdue {
    background: #ffebee;
    border-color: #f44336;
}

.document-item.urgent {
    background: #fff8e1;
    border-color: #ff9800;
}

/* Document Icon */
.document-icon {
    font-size: 24px;
    width: 40px;
    text-align: center;
}

/* Document Info */
.document-info {
    flex: 1;
}

.document-name {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.required-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: #dc3545;
    color: white;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.signature-badge {
    font-size: 10px;
    padding: 2px 6px;
    background: #6c757d;
    color: white;
    border-radius: 3px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.document-status {
    font-size: 12px;
    color: #666;
}

.document-item.overdue .document-status {
    color: #dc3545;
    font-weight: 600;
}

.document-item.urgent .document-status {
    color: #ff9800;
    font-weight: 600;
}

/* Document Actions */
.document-actions {
    display: flex;
    gap: 8px;
}

.btn-icon {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: #f8f9fa;
    transform: scale(1.1);
}

.btn-small {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-small:hover {
    background: #f8f9fa;
}

.btn-small.primary {
    background: #0099cc;
    color: white;
    border-color: #0099cc;
}

.btn-small.primary:hover {
    background: #0088bb;
    transform: translateY(-1px);
}

/* Document Actions Footer */
.document-hub-content .document-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.document-hub-content .document-actions button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Document Hub Button on Cards */
.document-hub-btn {
    margin-top: 8px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #333;
}

.document-hub-btn:hover {
    background: #e9ecef;
    border-color: #0099cc;
    color: #0099cc;
}

/* Notifications */
.document-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 10001;
}

.document-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.document-notification.success {
    background: #28a745;
}

.document-notification.error {
    background: #dc3545;
}

.document-notification.info {
    background: #0099cc;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .document-hub-modal {
        width: 95%;
        max-height: 95vh;
    }
    
    .summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .document-item {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .document-info {
        width: 100%;
    }
    
    .document-actions {
        width: 100%;
        justify-content: center;
    }
    
    .document-hub-content .document-actions {
        flex-direction: column;
    }
    
    .document-hub-content .document-actions button {
        width: 100%;
    }
}


/* Enhancement: tracker-aftercare-cascade.css */
/**
 * Aftercare Options Cascade Styles
 * Visual flow for aftercare decisions
 */

/* Overlay */
.aftercare-cascade-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

/* Modal */
.aftercare-cascade-modal {
    background: white;
    border-radius: 12px;
    width: 95%;
    max-width: 1100px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
}

/* Header */
.cascade-header {
    background: linear-gradient(135deg, #0099cc 0%, #006699 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-info h3 {
    margin: 0 0 8px 0;
    font-size: 20px;
}

.header-stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    opacity: 0.9;
}

.header-stats span {
    position: relative;
}

.header-stats span:not(:last-child)::after {
    content: '•';
    position: absolute;
    right: -12px;
    opacity: 0.5;
}

/* Content */
.cascade-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Timeline */
.cascade-timeline {
    margin-bottom: 30px;
}

.timeline-header {
    display: grid;
    grid-template-columns: 2fr 2fr 1.5fr;
    gap: 20px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
}

.timeline-label {
    font-size: 14px;
    font-weight: 600;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Cascade Options */
.cascade-options {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 20px;
}

/* Individual Option */
.cascade-option {
    display: grid;
    grid-template-columns: 40px 2fr 60px 2fr 60px 1.5fr;
    gap: 0;
    align-items: start;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.cascade-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.option-number {
    width: 32px;
    height: 32px;
    background: #0099cc;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
}

/* Option Stages */
.option-stage {
    padding: 0 15px;
}

.stage-content h4 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #333;
}

.option-details {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
}

.detail-item {
    font-size: 12px;
    padding: 3px 8px;
    background: white;
    border-radius: 4px;
    color: #666;
}

.date-label {
    font-size: 11px;
    color: #999;
    margin-top: 5px;
}

.stage-actions {
    margin-top: 10px;
}

/* Connectors */
.option-connector {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    height: 100%;
}

.connector-line {
    position: absolute;
    width: 100%;
    height: 2px;
    background: #ddd;
    top: 50%;
    transform: translateY(-50%);
}

.connector-icon {
    position: relative;
    background: white;
    padding: 5px;
    font-size: 18px;
    z-index: 1;
}

/* Response Status */
.response-status {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.response-text {
    font-size: 13px;
    color: #666;
    font-style: italic;
    margin: 8px 0;
}

/* Status Colors */
.status-accepted .option-number,
.status-accepted .connector-icon {
    background: #28a745;
    color: white;
}

.status-declined .option-number,
.status-declined .connector-icon {
    background: #dc3545;
    color: white;
}

.status-pending .option-number,
.status-pending .connector-icon {
    background: #ffc107;
    color: white;
}

.status-waitlist .option-number,
.status-waitlist .connector-icon {
    background: #6c757d;
    color: white;
}

.cascade-option.status-accepted {
    border-color: #28a745;
    background: #f0fdf4;
}

.cascade-option.status-declined {
    border-color: #dc3545;
    background: #fef2f2;
}

/* Next Steps */
.next-steps-list {
    margin: 10px 0;
    padding-left: 20px;
    font-size: 13px;
    color: #666;
}

.next-steps-list li {
    margin: 5px 0;
}

.declined-note,
.waitlist-note,
.pending-note {
    padding: 10px;
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
}

.declined-note {
    background: #ffebee;
    color: #c62828;
}

.waitlist-note {
    background: #f5f5f5;
    color: #616161;
}

.pending-note {
    background: #fff8e1;
    color: #f57c00;
}

/* Option Timeline */
.option-timeline {
    grid-column: 2 / -1;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
}

.timeline-event {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-right: 20px;
    font-size: 12px;
    color: #666;
}

.event-date {
    font-weight: 600;
}

/* Empty State */
.cascade-empty {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.cascade-empty h4 {
    margin: 0 0 10px 0;
    color: #333;
}

/* Add Option Section */
.add-option-section {
    text-align: center;
    padding: 20px;
}

.btn-add-option {
    padding: 12px 24px;
    background: white;
    border: 2px dashed #0099cc;
    border-radius: 8px;
    color: #0099cc;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-add-option:hover {
    background: #f0f9ff;
    border-style: solid;
}

/* Summary Section */
.cascade-summary {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.summary-section h4 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #333;
}

.summary-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.summary-stats .stat {
    flex: 1;
    text-align: center;
    padding: 15px;
    border-radius: 8px;
    font-size: 20px;
    font-weight: 700;
}

.stat.accepted {
    background: #e8f5e9;
    color: #2e7d32;
}

.stat.pending {
    background: #fff8e1;
    color: #f57c00;
}

.stat.declined {
    background: #ffebee;
    color: #c62828;
}

.primary-selection,
.waiting-response,
.recommendation {
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.primary-selection {
    background: #e8f5e9;
    border: 1px solid #4caf50;
}

.waiting-response {
    background: #fff8e1;
    border: 1px solid #ffc107;
}

.recommendation {
    background: #e3f2fd;
    border: 1px solid #2196f3;
}

.primary-selection h5,
.waiting-response h5,
.recommendation h5 {
    margin: 0 0 8px 0;
    font-size: 14px;
}

.selection-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

/* Actions */
.cascade-actions {
    display: flex;
    gap: 10px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.cascade-actions button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Buttons */
.btn-icon {
    background: none;
    border: 1px solid #dee2e6;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: #f8f9fa;
    transform: scale(1.1);
}

.btn-small {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-small:hover {
    background: #f8f9fa;
}

/* Notifications */
.cascade-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s ease;
    z-index: 10001;
}

.cascade-notification.visible {
    opacity: 1;
    transform: translateY(0);
}

.cascade-notification.success {
    background: #28a745;
}

.cascade-notification.error {
    background: #dc3545;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 1024px) {
    .cascade-option {
        grid-template-columns: 40px 1fr;
        gap: 10px;
    }
    
    .option-stage,
    .option-connector {
        grid-column: 2;
        margin-bottom: 15px;
    }
    
    .option-connector {
        height: 40px;
        flex-direction: column;
    }
    
    .connector-line {
        width: 2px;
        height: 100%;
        left: 50%;
        top: 0;
        transform: translateX(-50%);
    }
    
    .timeline-header {
        display: none;
    }
}

@media (max-width: 768px) {
    .aftercare-cascade-modal {
        width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
    }
    
    .cascade-actions {
        flex-direction: column;
    }
    
    .cascade-actions button {
        width: 100%;
    }
}


/* Enhancement: discharge-checklist.css */
/* Discharge Checklist Styles */

.discharge-checklist-modal .modal-content {
    max-height: 90vh;
    overflow-y: auto;
}

.discharge-checklist-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 2px solid #e5e7eb;
}

.discharge-checklist-modal h2 {
    margin: 0;
    color: #1f2937;
    font-size: 24px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-close:hover {
    color: #1f2937;
}

/* Progress Bar */
.checklist-progress {
    padding: 20px;
    background: #f9fafb;
}

.progress-bar {
    width: 100%;
    height: 24px;
    background: #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    transition: width 0.3s ease;
}

.progress-text {
    margin-top: 10px;
    text-align: center;
    font-size: 14px;
    color: #6b7280;
}

/* Checklist Sections */
.checklist-sections {
    padding: 20px;
}

.checklist-section {
    margin-bottom: 30px;
}

.checklist-section h3 {
    color: #374151;
    font-size: 18px;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e5e7eb;
}

/* Checklist Items */
.checklist-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.checklist-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px 16px;
    transition: all 0.2s ease;
}

.checklist-item:hover {
    border-color: #9ca3af;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.checklist-item.completed {
    background: #f0fdf4;
    border-color: #86efac;
}

.checklist-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    gap: 12px;
}

.checklist-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-top: 2px;
    cursor: pointer;
    flex-shrink: 0;
}

.item-label {
    flex: 1;
    font-size: 15px;
    color: #1f2937;
    line-height: 1.5;
}

.checklist-item.completed .item-label {
    color: #059669;
    text-decoration: line-through;
}

.required {
    color: #ef4444;
    font-weight: bold;
    margin-left: 4px;
}

.item-description {
    margin-left: 32px;
    margin-top: 6px;
    font-size: 13px;
    color: #6b7280;
    font-style: italic;
}

.item-meta {
    margin-left: 32px;
    margin-top: 6px;
    font-size: 12px;
    color: #10b981;
    font-weight: 500;
}

/* Modal Footer */
.discharge-checklist-modal .modal-footer {
    padding: 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Print Styles */
@media print {
    .discharge-checklist-modal {
        position: static;
        background: white;
    }
    
    .discharge-checklist-modal .modal-content {
        box-shadow: none;
        max-width: 100%;
    }
    
    .btn-close,
    .modal-footer button {
        display: none;
    }
    
    .checklist-item {
        break-inside: avoid;
    }
    
    .checklist-section {
        page-break-inside: avoid;
    }
}

/* Add discharge button to client cards */
.btn-discharge-checklist {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: transform 0.2s;
}

.btn-discharge-checklist:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}


/* Enhancement: missions-redesign.css */
/* Modern Missions Widget Redesign */

.missions-widget {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 20px 40px rgba(102, 126, 234, 0.25);
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
}

.missions-widget::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 60%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
}

/* Header Section */
.missions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    position: relative;
    z-index: 1;
}

.missions-title {
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    font-size: 24px;
    font-weight: 700;
}

.missions-title::before {
    content: '🎯';
    font-size: 28px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.missions-progress {
    display: flex;
    align-items: center;
    gap: 16px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    padding: 8px 16px;
    border-radius: 100px;
    color: white;
    font-weight: 600;
}

.progress-circles {
    display: flex;
    gap: 8px;
}

.progress-circle {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    background: transparent;
    transition: all 0.3s ease;
}

.progress-circle.completed {
    background: white;
    border-color: white;
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.4);
}

/* Mission Sections */
.mission-section {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.mission-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.mission-section.primary {
    border-left: 4px solid #ef4444;
}

.mission-section.secondary {
    border-left: 4px solid #f59e0b;
}

.mission-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.mission-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #1f2937;
    font-size: 16px;
}

.mission-label .icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.mission-section.primary .icon {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.mission-section.secondary .icon {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
}

.mission-time {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
}

/* Mission Items */
.mission-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px;
    border-radius: 12px;
    background: linear-gradient(135deg, #fafafa 0%, #f9fafb 100%);
    margin-bottom: 12px;
    transition: all 0.2s ease;
    position: relative;
}

.mission-item:hover {
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    transform: translateX(4px);
}

.mission-item.critical {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.mission-checkbox {
    position: relative;
}

.mission-checkbox input[type="checkbox"] {
    width: 24px;
    height: 24px;
    appearance: none;
    border: 2px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.mission-checkbox input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-color: #059669;
}

.mission-checkbox input[type="checkbox"]:checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 14px;
    font-weight: bold;
}

.mission-content {
    flex: 1;
}

.mission-client {
    display: inline-block;
    background: #1f2937;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 8px;
}

.mission-text {
    color: #4b5563;
    font-size: 15px;
    line-height: 1.4;
}

.mission-critical {
    display: inline-block;
    background: #ef4444;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    margin-left: 8px;
}

.mission-action {
    padding: 8px 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.mission-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Quick Actions Bar */
.quick-actions {
    display: flex;
    gap: 12px;
    padding: 20px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    flex-wrap: wrap;
    justify-content: center;
}

.quick-action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 100px;
}

.quick-action-btn:hover {
    background: linear-gradient(135deg, white 0%, #f9fafb 100%);
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.quick-action-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.quick-action-label {
    font-size: 13px;
    color: #6b7280;
    font-weight: 600;
    text-align: center;
}

/* Animations */
@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

.missions-widget {
    animation: slideInFromTop 0.5s ease;
}

.mission-section {
    animation: slideInFromTop 0.5s ease;
    animation-fill-mode: both;
}

.mission-section:nth-child(2) {
    animation-delay: 0.1s;
}

.mission-section:nth-child(3) {
    animation-delay: 0.2s;
}

/* Empty State */
.missions-empty {
    text-align: center;
    padding: 40px;
    color: rgba(255, 255, 255, 0.9);
}

.missions-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.missions-empty-text {
    font-size: 18px;
    font-weight: 500;
}

/* Responsive Design */
@media (max-width: 768px) {
    .missions-widget {
        padding: 20px;
    }
    
    .missions-title {
        font-size: 20px;
    }
    
    .quick-actions {
        padding: 12px;
    }
    
    .quick-action-btn {
        min-width: 80px;
        padding: 12px 8px;
    }
}


/* Enhancement: morning-review.css */
/* Morning Review Dashboard Styles */

.morning-review-modal .modal-content {
    max-height: 90vh;
    overflow-y: auto;
    background: #f9fafb;
}

/* Morning Header */
.morning-header {
    background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3b7cb8 100%);
    color: white;
    padding: 32px 36px;
    margin: -30px -30px 24px -30px;
    border-radius: 12px 12px 0 0;
    position: relative;
    overflow: hidden;
}

.morning-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, transparent 100%);
    pointer-events: none;
}

.morning-greeting {
    position: relative;
    z-index: 1;
}

.morning-greeting h2 {
    margin: 0;
    font-size: 28px;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    letter-spacing: -0.3px;
    line-height: 1.3;
    display: flex;
    align-items: center;
    gap: 12px;
}

.review-date {
    margin: 8px 0 0 0;
    font-size: 15px;
    opacity: 0.85;
    font-weight: 400;
    letter-spacing: 0.3px;
}

.morning-header .btn-close {
    color: white;
    opacity: 0.7;
    position: relative;
    z-index: 1;
    transition: opacity 0.2s ease;
}

.morning-header .btn-close:hover {
    opacity: 1;
}

/* Review Content */
.review-content {
    padding: 0 20px 20px;
}

/* Morning Stats */
.morning-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.95);
    padding: 26px 24px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    border: 2px solid rgba(229, 231, 235, 0.8);
    transition: all 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
    border-color: rgba(229, 231, 235, 1);
}

.stat-card.alert {
    border-color: rgba(239, 68, 68, 0.5);
    background: rgba(254, 242, 242, 0.95);
}

.stat-card.primary {
    border-color: rgba(59, 130, 246, 0.5);
    background: rgba(239, 246, 255, 0.95);
}

.stat-card.success {
    border-color: rgba(16, 185, 129, 0.5);
    background: rgba(240, 253, 244, 0.95);
}

.stat-number {
    font-size: 38px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 10px;
    letter-spacing: -0.5px;
}

.stat-card.alert .stat-number {
    color: #dc2626;
}

.stat-card.primary .stat-number {
    color: #2563eb;
}

.stat-card.success .stat-number {
    color: #059669;
}

.stat-label {
    font-size: 13px;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
}

/* Daily Insights */
.daily-insights {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 30px;
}

.insight-banner {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    border-radius: 8px;
    font-size: 15px;
}

.insight-banner.critical {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    color: #991b1b;
    border-left: 4px solid #dc2626;
}

.insight-banner.warning {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    color: #92400e;
    border-left: 4px solid #f59e0b;
}

.insight-banner.efficiency {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    color: #075985;
    border-left: 4px solid #0284c7;
}

.insight-banner.reminder {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    color: #374151;
    border-left: 4px solid #6b7280;
}

.insight-banner.success {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    color: #14532d;
    border-left: 4px solid #22c55e;
}

.insight-icon {
    font-size: 20px;
    flex-shrink: 0;
}

/* Batch Actions */
.batch-actions-section {
    margin-bottom: 30px;
}

.batch-actions-section h3 {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    color: #1f2937;
}

.batch-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.batch-action-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 22px;
    transition: all 0.2s ease;
}

.batch-action-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.batch-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 13px;
    color: #6b7280;
}

.batch-count {
    background: #3b82f6;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
}

.batch-time {
    display: flex;
    align-items: center;
    gap: 4px;
}

.batch-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
}

.batch-clients {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 16px;
}

.btn-batch {
    width: 100%;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-batch:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Review Sections */
.review-sections {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.review-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.review-section h3 {
    margin: 0 0 16px 0;
    color: #1f2937;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.review-section.overdue {
    border-left: 4px solid #ef4444;
}

.review-section.today {
    border-left: 4px solid #3b82f6;
}

.review-section.upcoming {
    border-left: 4px solid #8b5cf6;
}

.review-section.followups {
    border-left: 4px solid #f59e0b;
}

.review-section.opportunities {
    border-left: 4px solid #10b981;
}

/* Task List */
.task-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.review-task-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 16px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
}

.review-task-item:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
}

.task-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.task-details {
    flex: 1;
}

.task-client {
    font-size: 13px;
    font-weight: 600;
    color: #6b7280;
    margin-bottom: 4px;
}

.task-name {
    font-size: 15px;
    color: #1f2937;
    font-weight: 500;
}

.task-overdue {
    font-size: 12px;
    color: #dc2626;
    margin-top: 4px;
    font-weight: 600;
}

.task-due {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
}

.btn-task-action {
    padding: 6px 12px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 13px;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-task-action:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

/* Follow-up List */
.followup-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.followup-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.followup-client {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
}

.followup-options {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.option-tag {
    background: #fef3c7;
    color: #92400e;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.btn-followup {
    padding: 8px 16px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-followup:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

/* Opportunity List */
.opportunity-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.opportunity-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border-radius: 8px;
    border: 1px solid #86efac;
}

.opp-icon {
    font-size: 32px;
    flex-shrink: 0;
}

.opp-details {
    flex: 1;
}

.opp-message {
    font-weight: 600;
    color: #166534;
    margin-bottom: 4px;
}

.opp-benefit {
    font-size: 13px;
    color: #15803d;
}

.btn-opportunity {
    padding: 8px 20px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-opportunity:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* Morning Review Button */
.btn-morning-review {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
}

.btn-morning-review:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

/* Dark Mode Support for Morning Review */
.morning-review-modal .stat-card {
    background: rgba(255, 255, 255, 0.95);
}

body.dark-mode .morning-review-modal .modal-content,
.dark-mode .morning-review-modal .modal-content {
    background: #1f2937;
}

body.dark-mode .stat-card,
.dark-mode .stat-card {
    background: rgba(31, 41, 55, 0.95);
    border-color: rgba(75, 85, 99, 0.6);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

body.dark-mode .stat-card:hover,
.dark-mode .stat-card:hover {
    border-color: rgba(75, 85, 99, 0.9);
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.4);
}

body.dark-mode .stat-card.alert,
.dark-mode .stat-card.alert {
    background: rgba(127, 29, 29, 0.4);
    border-color: rgba(239, 68, 68, 0.5);
}

body.dark-mode .stat-card.primary,
.dark-mode .stat-card.primary {
    background: rgba(30, 58, 138, 0.4);
    border-color: rgba(59, 130, 246, 0.5);
}

body.dark-mode .stat-card.success,
.dark-mode .stat-card.success {
    background: rgba(6, 78, 59, 0.4);
    border-color: rgba(16, 185, 129, 0.5);
}

body.dark-mode .stat-number,
.dark-mode .stat-number {
    color: #f9fafb;
}

body.dark-mode .stat-label,
.dark-mode .stat-label {
    color: #9ca3af;
}

/* Responsive */
@media (max-width: 768px) {
    .morning-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .batch-actions-grid {
        grid-template-columns: 1fr;
    }
    
    .review-task-item {
        flex-wrap: wrap;
    }
    
    .task-details {
        flex: 1 0 100%;
    }
}

/* Print Styles */
@media print {
    .morning-review-modal {
        position: static;
        background: white;
    }
    
    .morning-header {
        color: black;
        background: none;
        border-bottom: 2px solid #000;
    }
    
    .btn-close,
    .modal-footer,
    .btn-batch,
    .btn-task-action,
    .btn-followup,
    .btn-opportunity {
        display: none;
    }
    
    .review-section {
        page-break-inside: avoid;
    }
}

        /* Clinician Workspace Auth Screen */
        .auth-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
            background:
                radial-gradient(circle at top left, rgba(255, 255, 255, 0.12), transparent 55%),
                radial-gradient(circle at bottom right, rgba(30, 64, 175, 0.4), transparent 55%),
                linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #0f172a;
        }

        .auth-orb {
            position: absolute;
            border-radius: 999px;
            filter: blur(40px);
            opacity: 0.75;
            pointer-events: none;
            animation: authOrbFloat 12s ease-in-out infinite;
        }

        .auth-orb--1 {
            width: 340px;
            height: 340px;
            top: -80px;
            left: -40px;
            background: radial-gradient(circle, rgba(248, 250, 252, 0.9), rgba(148, 163, 184, 0.1));
            animation-delay: -2s;
        }

        .auth-orb--2 {
            width: 260px;
            height: 260px;
            bottom: -40px;
            right: 12%;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.85), rgba(37, 99, 235, 0.1));
            animation-delay: -4s;
        }

        .auth-orb--3 {
            width: 220px;
            height: 220px;
            top: 18%;
            right: -60px;
            background: radial-gradient(circle, rgba(249, 115, 22, 0.85), rgba(126, 34, 206, 0.15));
            animation-delay: -6s;
        }

        @keyframes authOrbFloat {
            0%, 100% { transform: translate3d(0, 0, 0); }
            33% { transform: translate3d(18px, -10px, 0); }
            66% { transform: translate3d(-14px, 12px, 0); }
        }

        .auth-shell {
            position: relative;
            width: 100%;
            max-width: 1120px;
            min-height: 540px;
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
            gap: 32px;
            z-index: 1;
        }

        .auth-panel {
            position: relative;
            border-radius: 28px;
            backdrop-filter: blur(26px);
            -webkit-backdrop-filter: blur(26px);
        }

        .auth-panel--left {
            padding: 32px;
            background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.96), rgba(241, 245, 249, 0.94));
            box-shadow:
                0 24px 60px rgba(15, 23, 42, 0.30),
                0 0 0 1px rgba(226, 232, 240, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .auth-panel--right {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-brand {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 24px;
        }

        .auth-brand-text {
            flex: 1;
        }

        .auth-logo {
            width: 100px;
            height: 100px;
            margin-left: -12px;
            display: block;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            padding: 14px;
            object-fit: contain;
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(15, 23, 42, 0.12);
        }

        .auth-logo[alt] {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            text-align: center;
            color: #4b5563;
        }

        .auth-brand-parent {
            font-size: 14px;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 600;
        }

        .auth-brand-product {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.04em;
            color: #111827;
        }

        .auth-brand-org {
            margin-top: 4px;
            font-size: 14px;
            color: #4b5563;
        }

        .auth-title {
            margin: 24px 0 6px;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: #111827;
        }

        .auth-subtitle {
            margin: 0 0 18px;
            font-size: 14px;
            color: #4b5563;
            max-width: 420px;
        }

        .auth-bullets {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .auth-bullets li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 14px;
            color: #111827;
            margin-bottom: 12px;
        }

        .auth-bullets li::before {
            content: '•';
            color: #4f46e5;
            font-weight: 700;
            margin-top: 1px;
        }

        .auth-footnote {
            margin-top: 24px;
            padding-top: 18px;
            border-top: 1px solid rgba(209, 213, 219, 0.9);
        }

        .auth-footnote-main {
            font-size: 13px;
            color: #374151;
            margin: 0 0 4px;
        }

        .auth-footnote-sub {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }

        .auth-card {
            width: 100%;
            max-width: 420px;
            padding: 28px 26px;
            border-radius: 24px;
            background: rgba(248, 250, 252, 0.98);
            box-shadow:
                0 20px 45px rgba(15, 23, 42, 0.40),
                0 0 0 1px rgba(226, 232, 240, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .auth-card-header h2 {
            margin: 0 0 6px;
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .auth-card-header p {
            margin: 0;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .auth-form {
            margin-top: 20px;
        }

        .auth-alert {
            display: none;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(254, 215, 215, 0.8);
            color: #9b2c2c;
            border: 1px solid rgba(252, 165, 165, 0.8);
            font-size: 13px;
            margin-bottom: 16px;
        }

        .auth-field {
            margin-bottom: 16px;
        }

        .auth-field label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .auth-field input {
            width: 100%;
            padding: 11px 12px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            background: #ffffff;
            color: #111827;
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
        }

        .auth-field input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.16);
        }

        .auth-form-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin: 2px 0 18px;
        }

        .auth-remember {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #4b5563;
        }

        .auth-remember input {
            width: 16px;
            height: 16px;
            accent-color: #4f46e5;
        }

        .auth-link {
            border: none;
            background: none;
            padding: 0;
            font-size: 12px;
            color: #4f46e5;
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-submit-btn {
            width: 100%;
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #f9fafb;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 12px 30px rgba(79, 70, 229, 0.40);
            transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
        }

        .auth-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 40px rgba(79, 70, 229, 0.50);
            filter: brightness(1.03);
        }

        .auth-submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 10px 24px rgba(79, 70, 229, 0.35);
        }

        .auth-small-print {
            font-size: 11px;
            color: #6b7280;
            line-height: 1.45;
            margin: 0 0 12px;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            gap: 16px;
        }
        
        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(209, 213, 219, 0.6);
        }
        
        .auth-divider span {
            font-size: 12px;
            color: #9CA3AF;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .auth-create-account {
            margin-bottom: 16px;
        }
        
        .auth-create-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 20px;
            background: linear-gradient(135deg, #0D9488, #14B8A6);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .auth-create-btn:hover {
            background: linear-gradient(135deg, #0F766E, #0D9488);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.3);
        }
        
        .auth-create-icon {
            font-size: 18px;
        }

        .auth-support {
            margin-top: 14px;
            padding-top: 12px;
            border-top: 1px dashed rgba(209, 213, 219, 0.9);
        }

        .auth-support-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .auth-support p {
            margin: 0;
            font-size: 12px;
            color: #6b7280;
            line-height: 1.6;
        }

        @media (max-width: 960px) {
            .auth-shell {
                grid-template-columns: minmax(0, 1fr);
                max-width: 560px;
                gap: 20px;
            }

            .auth-panel--left {
                padding: 26px 24px;
                border-radius: 24px;
            }

            .auth-panel--right {
                justify-content: stretch;
            }

            .auth-card {
                margin: 0 auto;
            }
        }

        @media (max-width: 640px) {
            .auth-screen {
                padding: 18px;
            }

            .auth-panel--left {
                padding: 22px 20px;
                border-radius: 22px;
            }

            .auth-card {
                border-radius: 20px;
                padding: 22px 20px;
            }

            .auth-brand-product {
                font-size: 26px;
            }

            .auth-title {
                font-size: 22px;
            }

            .auth-form-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .auth-link {
                align-self: flex-start;
            }
        }

</style>
    <style>
        .programs-docs-loader,
        .programs-docs-error {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(110, 123, 255, 0.2);
            background: rgba(233, 236, 255, 0.55);
            color: #151633;
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .programs-docs-loader .loader-spinner {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 3px solid rgba(110, 123, 255, 0.3);
            border-top-color: #6E7BFF;
            animation: programsDocsSpin 0.9s linear infinite;
        }

        .programs-docs-error {
            flex-direction: column;
            align-items: flex-start;
            background: rgba(255, 245, 245, 0.85);
            border: 1px solid rgba(221, 72, 72, 0.35);
        }

        .programs-docs-error h3 {
            margin: 0;
            font-size: 16px;
            color: #b42318;
        }

        .programs-docs-error p {
            margin: 4px 0 12px 0;
            color: #7a271a;
            font-size: 14px;
        }

        .programs-docs-error-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        body.programs-docs-v2-active {
            overflow-x: hidden;
        }
        
        body.programs-docs-v2-active #mainApp {
            padding: 0 !important;
        }
        
        .programs-docs-container {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - var(--programs-header-height, 180px));
            position: relative;
            overflow: visible;
        }
        
        /* Ensure Programs tab takes full space */
        #programsTab.tab-content {
            width: 100%;
            height: 100%;
            min-height: calc(100vh - var(--programs-header-height, 180px));
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        
        #programsTab.tab-content.active {
            display: flex !important;
        }
        
        /* Hide legacy elements when module is loaded */
        body.programs-docs-v2-active .legacy-programs-wrapper,
        body.programs-docs-v2-active #programsDocsError,
        body.programs-docs-v2-active #programsDocsLoader {
            display: none !important;
        }
        
        /* Make sure the module content fills the container */
        .programs-docs-container > * {
            width: 100%;
            height: 100%;
        }
        
        /* When module is loaded, ensure its root elements take full space */
        body.programs-docs-v2-active #programsDocsContainer,
        body.programs-docs-v2-active #programsDocsContainer > body,
        body.programs-docs-v2-active #programsDocsContainer > html {
            width: 100% !important;
            height: 100% !important;
            min-height: calc(100vh - var(--programs-header-height, 180px)) !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Ensure the module's workspace takes full space */
        body.programs-docs-v2-active .workspace,
        body.programs-docs-v2-active .three-pane-layout,
        body.programs-docs-v2-active [class*="workspace"] {
            width: 100% !important;
            height: 100% !important;
            min-height: calc(100vh - var(--programs-header-height, 180px)) !important;
        }
        
        /* Remove any max-width constraints */
        body.programs-docs-v2-active #programsDocsContainer * {
            max-width: none !important;
        }
        
        /* Ensure tab content area doesn't constrain */
        body.programs-docs-v2-active #programsTab {
            max-width: 100% !important;
            overflow: visible !important;
        }
        
        /* Stretch the outer container to full viewport */
        body.programs-docs-v2-active .container {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: clamp(16px, 2.5vw, 44px) clamp(16px, 2.5vw, 56px) !important;
            border-radius: 0 !important;
            min-height: 100vh !important;
            box-shadow: none !important;
            background: transparent !important;
        }
        
        /* Apply purple gradient background to html and body when Programs & Docs is active */
        html.programs-docs-v2-active,
        body.programs-docs-v2-active {
            position: relative !important;
            background:
                radial-gradient(circle at 12% 18%, rgba(203, 207, 255, 0.35), transparent 45%),
                radial-gradient(circle at 88% 8%, rgba(110, 123, 255, 0.22), transparent 52%),
                linear-gradient(145deg, #ffffff 0%, #F3F4FF 100%) !important;
            min-height: 100vh !important;
        }
        
        html.programs-docs-v2-active::before,
        body.programs-docs-v2-active::before {
            content: "" !important;
            position: fixed !important;
            inset: 0 !important;
            pointer-events: none !important;
            background: radial-gradient(circle at 20% 70%, rgba(110, 123, 255, 0.08), transparent 60%) !important;
            z-index: -1 !important;
        }
        
        /* Ensure #mainApp is transparent */
        body.programs-docs-v2-active #mainApp {
            padding: 0 !important;
            background: transparent !important;
        }
        
        body.programs-docs-v2-active .main-content {
            max-width: 100% !important;
            border-radius: 24px !important;
        }
        
        body.programs-docs-v2-active .main-content {
            padding: clamp(16px, 2vw, 36px) !important;
            grid-template-columns: 1fr !important; /* Override grid layout */
            background: transparent !important;
        }
        
        /* Override module's fixed layout */
        body.programs-docs-v2-active .app-shell {
            max-width: 100% !important;
            width: 100% !important;
            margin: 0 !important;
            padding-left: clamp(16px, 2vw, 32px) !important;
            padding-right: clamp(16px, 2vw, 32px) !important;
            padding-top: 32px !important;
            padding-bottom: 80px !important;
            grid-template-columns: minmax(200px, 1fr) minmax(400px, 3fr) minmax(250px, 1fr) !important;
            gap: clamp(16px, 2vw, 24px) !important;
        }
        
        /* Make panes responsive and semi-transparent to show gradient */
        body.programs-docs-v2-active .pane {
            width: 100% !important;
            box-sizing: border-box !important;
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        /* Dynamic height calculation */
        body.programs-docs-v2-active #programsDocsContainer {
            height: calc(100vh - var(--programs-header-height, 180px)) !important;
        }
        
        /* Ultra-wide screens (>2000px) */
        @media (min-width: 2000px) {
            body.programs-docs-v2-active .app-shell {
                grid-template-columns: minmax(300px, 0.18fr) minmax(600px, 1fr) minmax(350px, 0.22fr) !important;
                padding-left: 3vw !important;
                padding-right: 3vw !important;
            }
        }
        
        /* Standard desktop (1400px - 2000px) */
        @media (min-width: 1400px) and (max-width: 2000px) {
            body.programs-docs-v2-active .app-shell {
                grid-template-columns: minmax(260px, 0.2fr) minmax(500px, 1fr) minmax(320px, 0.24fr) !important;
            }
        }
        
        /* Tablet/small desktop (<1400px) */
        @media (max-width: 1400px) {
            body.programs-docs-v2-active .app-shell {
                grid-template-columns: minmax(240px, 0.22fr) minmax(400px, 1fr) minmax(280px, 0.26fr) !important;
            }
        }
        
        /* Remove fixed padding from body and containers */
        body.programs-docs-v2-active {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Override programs panel constraints */
        body.programs-docs-v2-active .programs-panel {
            max-width: 100% !important;
            width: 100% !important;
        }
        
        /* Ensure selection panel doesn't interfere */
        body.programs-docs-v2-active .selection-panel {
            display: none !important;
        }
        
        body.programs-docs-v2-active .app-footer {
            max-width: 100% !important;
            margin: 0 !important;
            padding-left: 2vw !important;
            padding-right: 2vw !important;
        }
        
        /* Ensure toolbar stretches full width and reduce height significantly */
        body.programs-docs-v2-active .toolbar {
            width: 100% !important;
            max-width: 100% !important;
            left: 0 !important;
            right: 0 !important;
            margin: 0 !important;
            padding: 8px clamp(16px, 2vw, 28px) !important;
            min-height: auto !important;
            height: auto !important;
        }
        
        /* Reduce toolbar brand icon size */
        body.programs-docs-v2-active .toolbar__brand span {
            width: 28px !important;
            height: 28px !important;
            font-size: 0.75rem !important;
        }
        
        /* Reduce toolbar brand text size */
        body.programs-docs-v2-active .toolbar__brand {
            font-size: 0.85rem !important;
            gap: 8px !important;
        }
        
        /* Reduce search bar height */
        body.programs-docs-v2-active .toolbar__search label {
            padding: 6px 14px !important;
            min-height: auto !important;
        }
        
        /* Reduce search input size */
        body.programs-docs-v2-active .toolbar__search input {
            font-size: 0.875rem !important;
            padding: 0 !important;
        }
        
        /* Reduce toolbar action buttons */
        body.programs-docs-v2-active .toolbar__actions {
            gap: 8px !important;
        }
        
        body.programs-docs-v2-active .toolbar__document-toggle-btn,
        body.programs-docs-v2-active .toolbar__actions button {
            padding: 6px 12px !important;
            font-size: 0.8rem !important;
            min-height: auto !important;
            height: auto !important;
        }

        .legacy-programs-wrapper {
            margin-top: 24px;
        }

        .legacy-programs-notice {
            padding: 20px;
            border: 1px dashed rgba(110, 123, 255, 0.35);
            border-radius: 16px;
            background: white;
            color: #48508A;
        }

        .legacy-programs-notice h4 {
            margin: 0 0 8px 0;
            color: #0F1020;
            font-size: 16px;
        }

        .legacy-programs-notice p {
            margin: 0;
            font-size: 14px;
        }

        .legacy-programs-fallback {
            margin-top: 16px;
            border: 1px solid rgba(110, 123, 255, 0.18);
            border-radius: 18px;
            background: rgba(233, 236, 255, 0.25);
            box-shadow: 0 12px 32px rgba(15, 16, 32, 0.08);
            overflow: hidden;
        }

        .legacy-programs-frame {
            width: 100%;
            min-height: 720px;
            border: 0;
            background: white;
        }

        .legacy-programs-disclaimer {
            margin: 0;
            padding: 12px 18px 16px;
            font-size: 13px;
            color: #48508A;
            background: rgba(233, 236, 255, 0.65);
            border-top: 1px solid rgba(110, 123, 255, 0.18);
        }

        body.programs-docs-v2-active .selection-panel {
            display: none !important;
        }

        @keyframes programsDocsSpin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- ═══════════════════════════════════════════════════════════════════════════
         CM TRACKER - EXTRACTED TO EXTERNAL MODULE
         
         The comprehensive CM Tracker code (~3,950 lines) has been extracted to:
         cm-tracker.js (loaded at line 168)
         
         Extraction Date: December 7, 2025
         
         Exported functions include:
         - window.initializeCMTracker, window.switchToHouse, window.loadHouseView
         - window.filterClients, window.selectClient, window.editClient
         - window.toggleMilestone, window.exportCurrentView
         - Plus ~40 other client management functions
         
         See cm-tracker.js JSDoc header for full documentation.
         ═══════════════════════════════════════════════════════════════════════════ -->
    <!-- Initialize Service Worker -->
    <script>
        // Function to clear IndexedDB if needed
        async function clearIndexedDB() {
            try {
                await indexedDB.deleteDatabase('CareConnectPro');
                console.log('Database cleared successfully');
                return true;
            } catch (error) {
                console.error('Failed to clear database:', error);
                return false;
            }
        }

        // Robust login handler
        (function() {
            function initLogin() {
                const forms = document.querySelectorAll('form');
                forms.forEach(form => {
                    const hasPassword = form.querySelector('input[type="password"]');
                    const hasUsername = form.querySelector('input[type="text"], input[name="username"]');
                    
                    if (hasPassword && hasUsername) {
                        // This is the login form
                        form.onsubmit = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const username = hasUsername.value;
                            const password = hasPassword.value;
                            
                            // Validate credentials - DISABLED (use proper handleLogin function)
                            // if ((username === 'MasterAdmin' || username === 'Doc121') && password === 'FFA121') {
                            //     localStorage.setItem('isLoggedIn', 'true');
                            //     localStorage.setItem('username', username);
                            //     localStorage.setItem('userRole', username === 'MasterAdmin' ? 'admin' : 'user');
                            //     location.reload();
                            // } else {
                            //     alert('Invalid username or password');
                            // }
                            
                            // Use the proper handleLogin function instead
                            if (typeof handleLogin === 'function') {
                                const event = { preventDefault: () => {}, stopPropagation: () => {}, target: form };
                                handleLogin(event);
                            } else {
                                alert('Login system not loaded. Please refresh the page.');
                            }
                            
                            return false;
                        };
                        
                        // Also handle button click
                        const submitBtn = form.querySelector('button[type="submit"], button.sign-in-btn, input[type="submit"]');
                        if (submitBtn) {
                            submitBtn.onclick = function(e) {
                                e.preventDefault();
                                form.onsubmit(e);
                                return false;
                            };
                        }
                    }
                });
            }
            
            // Initialize on multiple events to ensure it runs
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLogin);
            } else {
                initLogin();
            }
            
            // Also try on window load as backup
            window.addEventListener('load', initLogin);
        })();


        // Fix login form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Find the login form
            const loginForm = document.querySelector('form');
            if (loginForm && loginForm.querySelector('input[type="password"]')) {
                // Prevent default form submission
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get username and password
                    const username = document.querySelector('input[type="text"]').value;
                    const password = document.querySelector('input[type="password"]').value;
                    
                    // Call the login function
                    if (typeof handleLogin === 'function') {
                        handleLogin(username, password);
                    } else {
                        // Fallback login handling - DISABLED (use proper handleLogin function)
                        alert('Login system not loaded. Please refresh the page and try again.');
                    }
                    
                    return false;
                });
                
                // Also handle button click
                const signInButton = loginForm.querySelector('button[type="submit"]') || 
                                   loginForm.querySelector('.sign-in-btn') ||
                                   loginForm.querySelector('button');
                
                if (signInButton) {
                    signInButton.onclick = function(e) {
                        e.preventDefault();
                        loginForm.dispatchEvent(new Event('submit'));
                        return false;
                    };
                }
            }
        });

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js")
                .then(reg => console.log("Service Worker registered:", reg.scope))
                .catch(err => console.log("Service Worker registration failed:", err));
        }
    </script>
    
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Family First Adolescent Services - Document Creation Tool">
    <meta name="theme-color" content="#0099cc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FFAS Docs">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232196a6'/%3E%3Cpath d='M 20 15 Q 32 12 44 15 L 40 22 Q 32 20 24 22 Q 18 28 18 38 L 26 38 Q 26 32 29 29 Q 32 27 37 28 L 35 33 Q 32 32 30 33 Q 28 35 28 38 L 36 38 Q 36 35 37 33 Q 40 32 44 33 L 42 38 Q 38 37 37 38 Q 36 40 36 45 L 29 45 Q 29 42 26 42 L 18 45 Q 15 32 22 22 Q 26 18 32 15' fill='white'/%3E%3C/svg%3E">
    
    <style>
        /* Modern UI Enhancement Styles - Override Existing */
        
        /* Beautiful Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Override Program Cards for Better Look */
        .program-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%) !important;
            padding: 24px !important;
            border-radius: 16px !important;
            border: 2px solid transparent !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            position: relative !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08) !important;
            animation: fadeIn 0.5s ease;
        }
        
        .program-card:hover {
            transform: translateY(-6px) scale(1.02) !important;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.18) !important;
            border-color: #667eea !important;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%) !important;
        }
        
        .program-card.selected {
            background: linear-gradient(135deg, #f0f4ff, #e5edff) !important;
            border: 2px solid #667eea !important;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.28) !important;
            transform: scale(1.02) !important;
        }
        
        /* Beautiful Buttons */
        .btn-primary, button[onclick*="generate"] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 14px 28px !important;
            border: none !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            font-size: 15px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .btn-primary:hover, button[onclick*="generate"]:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.45) !important;
        }
        
        .btn-primary:active, button[onclick*="generate"]:active {
            transform: translateY(-1px) !important;
        }
        
        /* Modern Modal Overlay */
        .modal {
            background-color: rgba(0,0,0,0.7) !important;
            backdrop-filter: blur(10px) !important;
            animation: modalFadeIn 0.3s ease !important;
        }
        
        .modal-content {
            border-radius: 20px !important;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3) !important;
            animation: modalSlideIn 0.3s ease !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            padding: 25px 30px !important;
            border-radius: 20px 20px 0 0 !important;
        }
        
        .modal-header h2 {
            color: white !important;
            font-weight: 600 !important;
            font-size: 24px !important;
        }
        
        /* Input Field Styling */
        input[type="text"], input[type="email"], input[type="password"], textarea, select {
            padding: 12px 16px !important;
            border-radius: 10px !important;
            border: 2px solid #e5e7eb !important;
            font-size: 15px !important;
            transition: all 0.3s ease !important;
            background: white !important;
        }
        
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            border-color: #667eea !important;
            outline: none !important;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1) !important;
        }
        
        /* Checkbox and Radio Styling */
        input[type="checkbox"], input[type="radio"] {
            width: 20px !important;
            height: 20px !important;
            cursor: pointer !important;
            accent-color: #667eea !important;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46a2);
        }
        
        /* Loading Animation */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        /* Smooth Transitions for All Interactive Elements */
        button, a, input, textarea, select, .card, .panel {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        /* Responsive Design Improvements */
        @media screen and (max-width: 1200px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }
            
        .main-content {
                flex-direction: column;
            }
            
            .selection-panel {
                width: 100%;
                max-width: 100%;
                border-left: none;
                border-top: 2px solid #e5e7eb;
                margin-top: 20px;
                position: relative;
                top: 0;
            }
            
            .programs-panel {
                max-height: none;
            }
        }
        
        @media screen and (max-width: 768px) {
            .header {
                padding: 20px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 24px !important;
            }
            
            .program-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 95vh;
            }
            
            .wizard-steps {
                gap: 8px;
            }
            
            .wizard-step-indicator {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .btn-primary, button[onclick*="generate"] {
                padding: 12px 20px !important;
                font-size: 14px !important;
            }
            
            .doc-type-buttons {
                flex-direction: column;
            }
            
            .doc-type-btn {
                width: 100%;
            }
        }
        
        @media screen and (max-width: 480px) {
            .programs-panel, .selection-panel {
                padding: 15px;
            }
            
            .program-card {
                padding: 16px !important;
            }
            
            input[type="text"], textarea, select {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            .modal-header {
                padding: 20px !important;
            }
            
            .modal-header h2 {
                font-size: 20px !important;
            }
            
            .wizard-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .wizard-actions button {
                width: 100%;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white !important;
            }
            
            .theme-toggle, .modal, button {
                display: none !important;
            }
            
            .container {
                box-shadow: none !important;
                max-width: 100% !important;
            }
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .program-card {
                border: 3px solid #000 !important;
            }
            
            .btn-primary {
                border: 2px solid #000 !important;
            }
            
            input, textarea, select {
                border: 2px solid #000 !important;
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Additional Polish */
        .guided-btn {
            background: linear-gradient(135deg, #34d399, #059669) !important;
            color: white !important;
            font-weight: 600 !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 14px 24px !important;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .guided-btn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 10px 28px rgba(5, 150, 105, 0.4) !important;
        }
        
        .wizard-back {
            background: #e5e7eb !important;
            color: #374151 !important;
        }
        
        .wizard-back:hover {
            background: #d1d5db !important;
        }
        
        .wizard-next {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: white !important;
        }
        
        .wizard-next:hover {
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4) !important;
        }
        
        .wizard-finish {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            color: white !important;
        }
        
        .wizard-finish:hover {
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4) !important;
        }
        
        /* Fix overlapping elements */
        .selection-panel {
            z-index: 10;
            visibility: visible !important;
        }

        .parent-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04) !important;
            margin-bottom: 24px !important;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .parent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .parent-card:hover {
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.12) !important;
            transform: translateY(-4px);
            border-color: #cbd5e1 !important;
        }
        
        .parent-card:hover::before {
            transform: scaleX(1);
        }

        .parent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .parent-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .org-badge {
            background: #e0e7ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .expand-icon {
            font-size: 14px;
            color: #1d4ed8;
            transition: transform 0.2s ease;
        }

        .parent-expand-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: rgba(59, 130, 246, 0.08);
            color: #1d4ed8;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .parent-expand-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.35);
        }

        .parent-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .parent-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 13px;
            color: #475569;
            margin-bottom: 10px;
        }
        
        .parent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }
        
        .parent-tag {
            background: rgba(59, 130, 246, 0.08);
            color: #3b82f6;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(59, 130, 246, 0.15);
        }
        
        .parent-stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            font-size: 13px;
            color: #64748b;
        }
        
        .parent-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .parent-stat-icon {
            color: #3b82f6;
            font-weight: bold;
        }
        
        /* Interactive Profile Modal - Enhanced */
        .program-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            z-index: 10000;
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .program-profile-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .profile-container {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 100px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            animation: modalSlideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center bottom;
        }
        
        /* .profile-header styles moved to css/client-profile.css */
        
        .profile-navigation {
            position: absolute;
            top: 24px;
            left: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .profile-back-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .profile-back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(-2px);
        }
        
        .profile-breadcrumb {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .profile-close {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05) rotate(90deg);
        }
        
        .profile-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 50px;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
        }
        
        .profile-subtitle {
            font-size: 16px;
            opacity: 0.95;
            display: flex;
            gap: 20px;
            align-items: center;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;
        }
        
        .profile-body {
            padding: 40px;
            overflow-y: auto;
            flex: 1;
            background: linear-gradient(to bottom, #ffffff 0%, #fafbfc 100%);
        }
        .profile-section {
            margin-bottom: 40px;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both;
        }
        .profile-section-title {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid transparent;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }
        
        .profile-section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 2px;
            animation: slideInLeft 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.4s both;
        }
        
        .profile-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        }
        
        .profile-info-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .profile-info-item:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .profile-info-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        .profile-info-value {
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
        }
        
        .profile-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }
        
        .profile-feature {
            padding: 18px 20px;
            background: white;
            border-left: 4px solid transparent;
            background: linear-gradient(to right, white, white),
                        linear-gradient(135deg, #6366f1, #8b5cf6);
            background-clip: padding-box, border-box;
            background-origin: border-box;
            border: 1px solid transparent;
            border-left-width: 4px;
            border-radius: 12px;
            font-size: 15px;
            color: #334155;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        
        .profile-feature:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
        }

        .profile-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .profile-tag {
            background: rgba(59, 130, 246, 0.12);
            color: #1d4ed8;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .profile-overview-text {
            font-size: 15px;
            color: #1f2937;
            line-height: 1.6;
            background: #f8fafc;
            border-radius: 10px;
            padding: 16px 18px;
        }

        .profile-subprogram-section {
            margin-top: 10px;
        }

        .profile-subprogram-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .profile-subprogram-item {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .profile-subprogram-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-subprogram-item:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.1);
            border-color: #cbd5e1;
        }
        
        .profile-subprogram-item:hover::before {
            transform: scaleY(1);
        }

        .profile-subprogram-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .profile-subprogram-meta {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .profile-subprogram-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .profile-subprogram-actions button {
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }

        .profile-view-btn {
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
        }

        .profile-add-btn-inline {
            background: #10b981;
            color: white;
        }

        .profile-add-btn-inline.selected {
            background: #ef4444;
        }
        
        /* Loading state */
        .profile-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        .profile-loading.active {
            display: block;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .profile-container {
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
            }
            
            /* .profile-header responsive styles moved to css/client-profile.css */
            
            .profile-body {
                padding: 24px;
            }
            
            .profile-title {
                font-size: 24px;
            }
            
            .profile-features {
                grid-template-columns: 1fr;
            }
            
            .profile-info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .profile-actions {
            padding: 20px 30px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .profile-add-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 14px 36px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .profile-add-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .profile-add-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }
        
        .profile-add-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .profile-add-btn.added {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .profile-contact-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .profile-contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .profile-contact-icon {
            color: #667eea;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideUp {
            from { 
                transform: translateY(40px) scale(0.95);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                width: 0;
                opacity: 0;
            }
            to {
                width: 60px;
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        .parent-overview {
            font-size: 14px;
            color: #334155;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .parent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .parent-tag {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .sub-programs-container {
            margin-top: 16px;
            display: grid;
            gap: 12px;
        }

        .sub-program-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .sub-program-card:hover {
            border-color: #2563eb;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.15);
        }

        .sub-program-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .sub-program-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .sub-program-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .sub-program-info {
            font-size: 13px;
            color: #475569;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .sub-program-badge {
            background: #f1f5f9;
            color: #0f172a;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .sub-program-features {
            margin: 0;
            padding-left: 18px;
            font-size: 12px;
            color: #4b5563;
        }

        .sub-program-features li {
            margin-bottom: 4px;
        }

        .sub-program-toggle {
            border: 1px solid #bfdbfe;
            background: #e0f2fe;
            color: #1d4ed8;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sub-program-toggle:hover {
            border-color: #2563eb;
            background: #dbeafe;
        }

        .sub-program-toggle.selected {
            background: #2563eb;
            color: #ffffff;
            border-color: #2563eb;
        }

        .programs-panel {
            z-index: 5;
        }

        .header {
            z-index: 20;
        }
        
        /* Ensure text is readable */
        h1, h2, h3, h4, h5, h6 {
            line-height: 1.4;
            margin-bottom: 0.5em;
        }
        
        p {
            line-height: 1.6;
            margin-bottom: 1em;
        }
        
        /* Better focus states */
        a:focus, button:focus, input:focus, textarea:focus, select:focus {
            outline: 3px solid rgba(102, 126, 234, 0.5) !important;
            outline-offset: 2px;
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.95) 0%, rgba(147, 51, 234, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            animation: fadeIn 0.3s ease;
        }
        
        .loading-spinner {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 0 100px rgba(147, 51, 234, 0.3);
            min-width: 400px;
            max-width: 500px;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Modern Circular Progress */
        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 25px;
        }
        
        .progress-ring-circle {
            fill: transparent;
            stroke: #e5e7eb;
            stroke-width: 8;
        }
        
        .progress-ring-circle-progress {
            fill: transparent;
            stroke: url(#gradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
            transition: stroke-dashoffset 0.35s;
        }
        
        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Status Text */
        .loading-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .loading-status {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
            min-height: 40px;
        }
        
        .status-detail {
            font-size: 12px;
            color: #9ca3af;
            font-style: italic;
            margin-top: 4px;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Steps Indicator */
        .loading-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .loading-step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .loading-step::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .loading-step.active::before {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }
        
        .loading-step.completed::before {
            background: #10b981;
        }
        
        .loading-step-label {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .loading-step.active .loading-step-label {
            color: #4f46e5;
            font-weight: 600;
        }
        
        /* Beautiful Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .notification-message {
            font-size: 14px;
            opacity: 0.95;
        }
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.5);
            animation: notificationProgress 3s linear;
        }
        @keyframes notificationProgress {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        /* Old spinner for backwards compatibility */
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0099cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
    

        /* Enhanced Features CSS */
        .client-switcher {
            margin-bottom: 20px;
        }
        
        .natural-language-search {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .natural-language-search:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .filter-suggestions {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .smart-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .smart-preset {
            padding: 6px 12px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .smart-preset:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .match-score {
            display: inline-block;
            padding: 2px 8px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .data-quality-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
        }
        
        .data-quality-high { background: #10b981; }
        .data-quality-medium { background: #f59e0b; }
        .data-quality-low { background: #ef4444; }

    

        /* Map System Styles */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        .leaflet-popup-content {
            margin: 12px !important;
        }
        
        .program-marker {
            transition: transform 0.2s;
        }
        
        .program-marker:hover {
            transform: scale(1.1);
            z-index: 1000 !important;
        }
        
        /* Custom map controls */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        .leaflet-control-zoom a {
            background: white !important;
            color: #374151 !important;
            border: none !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: #f3f4f6 !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           ADMIN COMMAND CENTER - Enhanced Analytics Dashboard
           ═══════════════════════════════════════════════════════════════════════════ */
        .acc-container {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            border-radius: 16px;
            min-height: calc(100vh - 200px);
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           HEADER
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .acc-header__title-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .acc-header__eyebrow {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #818cf8;
        }
        .acc-header__title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ffffff;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .acc-header__badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.75rem;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #4ade80;
        }
        .acc-header__badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #4ade80;
            border-radius: 50%;
            animation: accPulse 2s infinite;
        }
        @keyframes accPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .acc-header__controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .acc-date-select {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.85rem;
        }
        .acc-date-select select {
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
        }
        .acc-date-select select option {
            background: #1e293b;
            color: #ffffff;
        }
        .acc-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .acc-btn--primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        .acc-btn--primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .acc-btn--secondary {
            background: #1e293b;
            color: #e2e8f0;
            border: 1px solid #334155;
        }
        .acc-btn--secondary:hover {
            background: #334155;
            border-color: #475569;
        }
        .acc-btn--ghost {
            background: transparent;
            color: #94a3b8;
            border: 1px solid transparent;
        }
        .acc-btn--ghost:hover {
            background: rgba(148, 163, 184, 0.1);
            color: #e2e8f0;
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           ALERTS / ATTENTION NEEDED
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-alerts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .acc-alert {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            border-radius: 10px;
            font-size: 0.85rem;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .acc-alert:hover {
            transform: translateX(4px);
        }
        .acc-alert--warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.25);
            color: #fbbf24;
        }
        .acc-alert--danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.25);
            color: #ef4444;
        }
        .acc-alert--info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.25);
            color: #3b82f6;
        }
        .acc-alert__icon {
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .acc-alert__content {
            flex: 1;
        }
        .acc-alert__title {
            font-weight: 600;
            margin-bottom: 0.1rem;
        }
        .acc-alert__detail {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .acc-alert__arrow {
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
        }
        .acc-alert:hover .acc-alert__arrow {
            opacity: 1;
            transform: translateX(2px);
        }
        
        /* Custom Program Promotion Prompt */
        .acc-custom-prompt {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            margin-bottom: 1rem;
            grid-column: 1 / -1;
        }
        .acc-custom-prompt__icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .acc-custom-prompt__content {
            flex: 1;
        }
        .acc-custom-prompt__title {
            font-weight: 600;
            color: #a5b4fc;
            margin-bottom: 0.25rem;
        }
        .acc-custom-prompt__text {
            font-size: 0.85rem;
            color: #94a3b8;
            line-height: 1.5;
        }
        .acc-custom-prompt__text strong {
            color: #e2e8f0;
        }
        .acc-custom-prompt__btn {
            padding: 0.5rem 1rem;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            color: #a5b4fc;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .acc-custom-prompt__btn:hover {
            background: rgba(99, 102, 241, 0.3);
            color: #f1f5f9;
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           KPI CARDS ROW
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .acc-kpi {
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .acc-kpi::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--kpi-accent, #6366f1);
        }
        .acc-kpi__header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        .acc-kpi__label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #cbd5e1;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .acc-kpi__trend {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .acc-kpi__trend--up {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        .acc-kpi__trend--down {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        .acc-kpi__trend--neutral {
            background: rgba(148, 163, 184, 0.15);
            color: #94a3b8;
        }
        .acc-kpi__value {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .acc-kpi__subtitle {
            font-size: 0.8rem;
            color: #94a3b8;
        }
        .acc-kpi--referrals { --kpi-accent: #6366f1; }
        .acc-kpi--admissions { --kpi-accent: #22c55e; }
        .acc-kpi--conversion { --kpi-accent: #f59e0b; }
        .acc-kpi--compliance { --kpi-accent: #3b82f6; }
        .acc-kpi--documents { --kpi-accent: #8b5cf6; }
        .acc-kpi--tasks { --kpi-accent: #ec4899; }
        .acc-kpi--census { --kpi-accent: #14b8a6; }

        /* ─────────────────────────────────────────────────────────────────────────────
           TABS NAVIGATION
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            padding: 0.35rem;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            border: 1px solid #334155;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .acc-tab {
            flex: 1;
            padding: 0.85rem 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .acc-tab:hover {
            color: #e2e8f0;
            background: rgba(148, 163, 184, 0.1);
        }
        .acc-tab--active {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #475569;
        }
        .acc-tab__icon {
            font-size: 1rem;
        }
        .acc-tab__badge {
            padding: 0.1rem 0.4rem;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           CONTENT PANELS
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-panel {
            display: none;
        }
        .acc-panel--active {
            display: block;
        }
        .acc-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1rem;
        }
        .acc-grid--2col {
            grid-template-columns: repeat(2, 1fr);
        }
        .acc-col-8 { grid-column: span 8; }
        .acc-col-6 { grid-column: span 6; }
        .acc-col-4 { grid-column: span 4; }
        .acc-col-12 { grid-column: span 12; }
        @media (max-width: 1024px) {
            .acc-col-8, .acc-col-6, .acc-col-4 { grid-column: span 12; }
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           CARDS
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        .acc-card__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--card-border);
            background: var(--bg-surface-sunken);
        }
        .acc-card__title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .acc-card__title-icon {
            font-size: 1.1rem;
        }
        .acc-card__actions {
            display: flex;
            gap: 0.5rem;
        }
        .acc-card__body {
            padding: 1.25rem;
        }
        .acc-card__body--flush {
            padding: 0;
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           TABLES
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-table {
            width: 100%;
            border-collapse: collapse;
        }
        .acc-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--table-header-text);
            background: var(--table-header-bg);
            border-bottom: 1px solid var(--table-border);
        }
        .acc-table td {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--table-border);
        }
        .acc-table tr:hover td {
            background: var(--table-row-bg-hover);
        }
        .acc-table tr:last-child td {
            border-bottom: none;
        }
        .acc-table__program {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .acc-table__program-type {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .acc-table__program-type--rtc { background: var(--status-purple-bg); color: var(--status-purple); }
        .acc-table__program-type--tbs { background: var(--status-green-bg); color: var(--status-green); }
        .acc-table__program-type--wild { background: var(--status-yellow-bg); color: var(--status-yellow); }
        .acc-table__program-type--iop { background: var(--status-blue-bg); color: var(--status-blue); }
        .acc-table__program-type--php { background: var(--status-red-bg); color: var(--status-red); }
        .acc-table__program-info {
            display: flex;
            flex-direction: column;
        }
        .acc-table__program-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        .acc-table__program-location {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .acc-table__number {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        .acc-table__number--highlight {
            color: var(--status-green);
        }
        .acc-table__rate {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .acc-table__rate-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-surface-sunken);
            border-radius: 3px;
            overflow: hidden;
            max-width: 60px;
        }
        .acc-table__rate-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
            border-radius: 3px;
        }
        .acc-table__rate-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 36px;
        }
        .acc-table__status {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .acc-table__status--admitted { background: var(--status-green-bg); color: var(--status-green); }
        .acc-table__status--pending { background: var(--status-yellow-bg); color: var(--status-yellow); }
        .acc-table__status--declined { background: var(--status-red-bg); color: var(--status-red); }

        /* ─────────────────────────────────────────────────────────────────────────────
           CHARTS
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-chart {
            height: 200px;
            position: relative;
        }
        .acc-chart__placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 0.85rem;
        }
        /* Simple bar chart */
        .acc-bar-chart {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .acc-bar-chart__item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .acc-bar-chart__label {
            width: 100px;
            font-size: 0.8rem;
            color: #94a3b8;
            text-align: right;
            flex-shrink: 0;
        }
        .acc-bar-chart__bar-container {
            flex: 1;
            height: 24px;
            background: #0f172a;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .acc-bar-chart__bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            padding-left: 0.5rem;
        }
        .acc-bar-chart__bar--primary {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }
        .acc-bar-chart__bar--success {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }
        .acc-bar-chart__bar--warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        .acc-bar-chart__bar--danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        .acc-bar-chart__value {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .acc-bar-chart__count {
            width: 40px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #e2e8f0;
            text-align: right;
        }
        /* Donut chart */
        .acc-donut {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .acc-donut__chart {
            width: 140px;
            height: 140px;
            position: relative;
        }
        .acc-donut__svg {
            transform: rotate(-90deg);
        }
        .acc-donut__circle {
            fill: none;
            stroke-width: 20;
        }
        .acc-donut__circle--bg {
            stroke: #1e293b;
        }
        .acc-donut__circle--value {
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }
        .acc-donut__center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .acc-donut__center-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #f1f5f9;
            line-height: 1;
        }
        .acc-donut__center-label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .acc-donut__legend {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .acc-donut__legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #94a3b8;
        }
        .acc-donut__legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }
        .acc-donut__legend-value {
            margin-left: auto;
            font-weight: 600;
            color: #e2e8f0;
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           COMPLIANCE METRICS
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-compliance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        .acc-compliance-item {
            text-align: center;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
        }
        .acc-compliance-item__value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        .acc-compliance-item__value--success { color: #22c55e; }
        .acc-compliance-item__value--warning { color: #f59e0b; }
        .acc-compliance-item__value--danger { color: #ef4444; }
        .acc-compliance-item__value--info { color: #3b82f6; }
        .acc-compliance-item__label {
            font-size: 0.75rem;
            color: #64748b;
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           RELATIONSHIP HEALTH
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-health-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .acc-health-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: #0f172a;
            border-radius: 8px;
            border-left: 3px solid var(--health-color, #64748b);
        }
        .acc-health-item--preferred { --health-color: #22c55e; }
        .acc-health-item--active { --health-color: #3b82f6; }
        .acc-health-item--stale { --health-color: #f59e0b; }
        .acc-health-item--inactive { --health-color: #ef4444; }
        .acc-health-item__name {
            flex: 1;
            font-weight: 500;
            color: #e2e8f0;
        }
        .acc-health-item__meta {
            font-size: 0.75rem;
            color: #64748b;
        }
        .acc-health-item__days {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           HOUSE OCCUPANCY PANEL
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-occupancy-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .acc-occupancy-house {
            background: #0f172a;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            border-left: 4px solid var(--house-color, #64748b);
        }
        .acc-occupancy-house--available { --house-color: #22c55e; }
        .acc-occupancy-house--warning { --house-color: #f59e0b; }
        .acc-occupancy-house--critical { --house-color: #ef4444; }
        .acc-occupancy-house--full { --house-color: #dc2626; }
        
        .acc-occupancy-house__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .acc-occupancy-house__name {
            font-weight: 600;
            font-size: 1rem;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .acc-occupancy-house__type {
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .acc-occupancy-house__stats {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            color: #94a3b8;
        }
        .acc-occupancy-house__count {
            font-weight: 600;
            color: #e2e8f0;
        }
        .acc-occupancy-house__pct {
            font-weight: 500;
        }
        .acc-occupancy-house__pct--high { color: #ef4444; }
        .acc-occupancy-house__pct--medium { color: #f59e0b; }
        .acc-occupancy-house__pct--low { color: #22c55e; }
        
        .acc-occupancy-bar {
            height: 8px;
            background: #1e293b;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        .acc-occupancy-bar__fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .acc-occupancy-bar__fill--available { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .acc-occupancy-bar__fill--warning { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .acc-occupancy-bar__fill--critical { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .acc-occupancy-bar__fill--full { background: linear-gradient(90deg, #dc2626, #b91c1c); }
        
        .acc-occupancy-subunits {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #1e293b;
        }
        .acc-occupancy-subunit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #94a3b8;
        }
        .acc-occupancy-subunit__name {
            color: #cbd5e1;
        }
        .acc-occupancy-subunit__count {
            font-weight: 500;
            color: #e2e8f0;
        }
        .acc-occupancy-full-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            animation: pulse-badge 2s infinite;
        }
        @keyframes pulse-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           EXPORT SECTION
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-export-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        .acc-export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .acc-export-option {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .acc-export-option:hover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }
        .acc-export-option--selected {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }
        .acc-export-option__radio {
            width: 18px;
            height: 18px;
            border: 2px solid #475569;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 0.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .acc-export-option--selected .acc-export-option__radio {
            border-color: #6366f1;
        }
        .acc-export-option--selected .acc-export-option__radio::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #6366f1;
            border-radius: 50%;
        }
        .acc-export-option__content {
            flex: 1;
        }
        .acc-export-option__title {
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        .acc-export-option__desc {
            font-size: 0.8rem;
            color: #64748b;
        }
        .acc-export-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           EMPTY STATES
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-empty {
            text-align: center;
            padding: 3rem 1.5rem;
            color: #64748b;
        }
        .acc-empty__icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        .acc-empty__title {
            font-size: 1rem;
            font-weight: 500;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }
        .acc-empty__desc {
            font-size: 0.85rem;
            max-width: 300px;
            margin: 0 auto;
        }

        /* ─────────────────────────────────────────────────────────────────────────────
           UTILITIES
           ───────────────────────────────────────────────────────────────────────────── */
        .acc-divider {
            height: 1px;
            background: #334155;
            margin: 1.5rem 0;
        }
        .acc-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-bottom: 1rem;
        }
        .acc-flex {
            display: flex;
        }
        .acc-flex--between {
            justify-content: space-between;
        }
        .acc-flex--center {
            align-items: center;
        }
        .acc-gap-1 { gap: 0.5rem; }
        .acc-gap-2 { gap: 1rem; }
        .acc-mb-1 { margin-bottom: 0.5rem; }
        .acc-mb-2 { margin-bottom: 1rem; }
        .acc-mb-3 { margin-bottom: 1.5rem; }

        /* ═══════════════════════════════════════════════════════════════════════════
           ADMIN COMMAND CENTER - ALWAYS DARK MODE OVERRIDES
           Forces the Admin Command Center to always use dark theme
           ═══════════════════════════════════════════════════════════════════════════ */
        
        /* Force dark background on the admin tab and its parent */
        #adminTab {
            background: linear-gradient(145deg, #0c0f1a 0%, #111827 50%, #0c0f1a 100%) !important;
            min-height: 100vh;
        }
        
        #adminTab .acc-container {
            --card-bg: #1e293b;
            --card-border: #334155;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --bg-surface-sunken: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --table-header-bg: #0f172a;
            --table-header-text: #94a3b8;
            --table-border: #334155;
            --table-row-bg-hover: rgba(99, 102, 241, 0.1);
            background: transparent !important;
        }
        
        /* Card dark overrides */
        #adminTab .acc-card {
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%) !important;
            border-color: #334155 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
        }
        
        #adminTab .acc-card__header {
            background: rgba(15, 23, 42, 0.8) !important;
            border-bottom-color: #334155 !important;
        }
        
        #adminTab .acc-card__title {
            color: #f1f5f9 !important;
        }
        
        #adminTab .acc-card__body {
            background: transparent !important;
            color: #e2e8f0 !important;
        }
        
        /* Table dark overrides */
        #adminTab .acc-table {
            background: transparent !important;
        }
        
        #adminTab .acc-table th {
            background: #0f172a !important;
            color: #94a3b8 !important;
            border-bottom-color: #334155 !important;
        }
        
        #adminTab .acc-table td {
            background: transparent !important;
            color: #e2e8f0 !important;
            border-bottom-color: #1e293b !important;
        }
        
        #adminTab .acc-table tr:hover td {
            background: rgba(99, 102, 241, 0.1) !important;
        }
        
        #adminTab .acc-table tbody tr {
            background: transparent !important;
        }
        
        /* Empty state text */
        #adminTab .acc-table td[colspan] {
            color: #64748b !important;
            text-align: center;
            padding: 2rem !important;
        }
        
        /* Date picker dark override */
        #adminTab .acc-date-select {
            background: rgba(15, 23, 42, 0.9) !important;
            border-color: #475569 !important;
        }
        
        #adminTab .acc-date-select input[type="date"],
        #adminTab .acc-date-select input[type="text"] {
            background: transparent !important;
            color: #f1f5f9 !important;
            border: none !important;
        }
        
        #adminTab .acc-date-select input::-webkit-calendar-picker-indicator {
            filter: invert(1) !important;
        }
        
        /* Donut chart legend */
        #adminTab .acc-donut__legend-item {
            color: #e2e8f0 !important;
        }
        
        #adminTab .acc-donut__legend-value {
            color: #94a3b8 !important;
        }
        
        #adminTab .acc-donut__center-value {
            color: #f1f5f9 !important;
        }
        
        #adminTab .acc-donut__center-label {
            color: #94a3b8 !important;
        }
        
        /* Placement rate text */
        #adminTab .acc-donut__rate {
            color: #94a3b8 !important;
        }
        
        #adminTab .acc-donut__rate strong {
            color: #22c55e !important;
        }
        
        /* Stats boxes */
        #adminTab .acc-stat-box {
            background: #0f172a !important;
            border-color: #334155 !important;
        }
        
        #adminTab .acc-stat-box__value {
            color: #f1f5f9 !important;
        }
        
        #adminTab .acc-stat-box__label {
            color: #94a3b8 !important;
        }
        
        /* Time to admission stats */
        #adminTab .acc-time-stats {
            background: transparent !important;
        }
        
        #adminTab .acc-time-stat {
            background: #0f172a !important;
            border-radius: 8px;
            padding: 1rem;
        }
        
        #adminTab .acc-time-stat__value {
            color: #f1f5f9 !important;
        }
        
        #adminTab .acc-time-stat__label {
            color: #64748b !important;
        }
        
        /* Relationship health */
        #adminTab .acc-relationship-summary {
            color: #94a3b8 !important;
        }
        
        /* Empty states */
        #adminTab .acc-empty {
            color: #64748b !important;
        }
        
        #adminTab .acc-empty__title {
            color: #94a3b8 !important;
        }
        
        #adminTab .acc-empty__desc {
            color: #64748b !important;
        }
        
        /* House occupancy total */
        #adminTab .acc-occupancy-total {
            color: #94a3b8 !important;
        }
        
        /* Override any white backgrounds from parent containers */
        .main-content:has(#adminTab.active),
        .content-area:has(#adminTab.active) {
            background: #0c0f1a !important;
        }
        
        /* Force programs-panel dark when admin tab is active */
        .programs-panel:has(#adminTab) {
            background: #0c0f1a !important;
            border-radius: 16px !important;
        }
        
        /* Fallback for browsers that don't support :has() */
        #adminTab.active ~ .programs-panel,
        .programs-panel #adminTab.active,
        body:has(#adminTab.active) .programs-panel {
            background: #0c0f1a !important;
        }
        
        /* Footer in admin tab */
        #adminTab ~ .footer,
        #adminTab + .footer,
        .programs-panel:has(#adminTab) .footer {
            background: #0c0f1a !important;
            color: #64748b !important;
            border-top: 1px solid #1e293b !important;
        }
        
        /* Fix the outer container */
        .container:has(#adminTab.active) {
            background: #0c0f1a !important;
        }
        
        /* Document Creator footer styling for admin */
        #adminTab .footer,
        #adminTab + .footer,
        .programs-panel:has(#adminTab) + .footer {
            background: #0c0f1a !important;
            color: #475569 !important;
        }

    </style>
    <style>
        /* Tab Navigation Styles */
        .tab-navigation {
            display: none !important;
            visibility: hidden !important;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tab-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .tab-btn.active {
            background: #6366f1;
            color: white;
            font-weight: 600;
        }
        
        .tab-btn.active:hover {
            background: #4f46e5;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Hide selection panel when dashboard is active */
        #dashboardTab.active ~ * .selection-panel,
        #dashboardTab.active ~ .selection-panel,
        body:has(#dashboardTab.active) .selection-panel,
        body:has(#dashboardTab.active) [class*="selection-panel"],
        body:has(#dashboardTab.active) aside:has-text("GENERATE DOCUMENT"),
        #dashboardTab.active ~ * aside {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Ensure dashboard gets full width */
        body:has(#dashboardTab.active) .main-content {
            grid-template-columns: 1fr !important;
        }
        
        /* Dashboard Styles */
        .dashboard-container {
            padding: 20px;
            background: var(--bg-surface);
            min-height: calc(100vh - 200px);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .dashboard-greeting {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .dashboard-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .dashboard-headline {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 260px;
        }
        
        .dashboard-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .dashboard-view-toggle {
            display: inline-flex;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .dashboard-view-toggle button {
            padding: 8px 18px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        
        .dashboard-view-toggle button.active {
            background: var(--brand-primary);
            color: var(--text-inverse);
        }
        
        /* Make dashboard content wider so more information fits horizontally */
        body.dashboard-active .main-content {
            max-width: 1400px;
        }
        
        .dashboard-main-grid {
            margin-top: 24px;
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
            gap: 20px;
        }
        
        .dashboard-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .dashboard-empty-banner {
            margin-top: 12px;
            padding: 16px 20px;
            border: 1px dashed var(--border-default);
            border-radius: 12px;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        
        .dashboard-empty-banner h4 {
            margin: 0 0 6px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .dashboard-empty-banner p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .banner-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .banner-actions button {
            border: none;
            border-radius: 999px;
            padding: 8px 18px;
            font-weight: 600;
            cursor: pointer;
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
        }
        
        .banner-actions button.ghost {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--btn-secondary-border);
        }
        
        .dashboard-quick-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 280px;
        }
        
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .quick-actions__row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .quick-actions__btn {
            flex: 1;
            min-width: 120px;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            background: var(--card-bg);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .quick-actions__btn span {
            font-size: 20px;
        }
        
        .quick-actions__btn small {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .coach-schedule-widget .schedule-section {
            margin-bottom: 16px;
        }
        
        .schedule-section__title {
            font-size: 13px;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }
        
        .schedule-item {
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 10px;
            background: var(--card-bg);
        }
        
        .schedule-item__main {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .schedule-client {
            background: var(--brand-primary);
            color: var(--text-inverse);
            border-radius: 8px;
            padding: 2px 8px;
            font-size: 12px;
        }
        
        .schedule-item__meta {
            margin-top: 6px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .schedule-action {
            border: none;
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .schedule-date {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        @media (max-width: 1024px) {
            .dashboard-header {
                flex-direction: column;
            }
            
            .dashboard-main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Widget base styles */
        .dashboard-widget {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .widget-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .widget-skeleton {
            height: 200px;
            background: linear-gradient(90deg, rgba(243,244,246,1) 25%, rgba(229,231,235,1) 50%, rgba(243,244,246,1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        .widget-empty {
            padding: 32px 24px;
            text-align: center;
            border: 1px dashed var(--border-default);
            border-radius: 16px;
            background: var(--bg-surface-sunken);
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
        }

        .widget-empty p {
            margin: 0;
        }

        .widget-empty__action {
            margin-top: 12px;
            padding: 8px 18px;
            border-radius: 999px;
            border: none;
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .widget-empty__action:hover {
            transform: translateY(-1px);
        }

        .widget-empty.widget-empty--inline {
            padding: 20px;
            margin: 12px 0;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Priority zones */
        .priority-zones {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .priority-zone {
            background: var(--bg-surface);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-default);
        }
        
        .zone-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
        }
        
        .zone-header:hover {
            background: var(--bg-surface-sunken);
        }
        
        .zone-icon {
            font-size: 18px;
            margin-right: 12px;
        }
        
        .zone-title {
            flex: 1;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .zone-count {
            background: var(--brand-primary);
            color: var(--text-inverse);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .zone-red .zone-count { background: var(--status-red); }
        .zone-purple .zone-count { background: var(--status-purple); }
        .zone-yellow .zone-count { background: var(--status-yellow); }
        .zone-green .zone-count { background: var(--status-green); }
        
        .zone-toggle {
            color: #6b7280;
            font-size: 12px;
        }
        
        .zone-content {
            padding: 0 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .zone-content.expanded {
            max-height: 500px;
            padding-bottom: 16px;
        }
        
        .priority-item {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--card-border);
        }
        
        .item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .client-badge {
            display: inline-block;
            background: #e5e7eb;
            color: #374151;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            width: fit-content;
        }
        
        .item-message {
            font-size: 14px;
            color: #111827;
        }
        
        .due-date {
            font-size: 12px;
            color: #6b7280;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-action, .btn-quick-complete {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-action {
            background: #6366f1;
            color: white;
        }
        
        .btn-action:hover {
            background: #4f46e5;
        }
        
        .btn-quick-complete {
            background: white;
            color: #10b981;
            border: 1px solid #10b981;
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-quick-complete:hover {
            background: #10b981;
            color: white;
        }
        
        /* House weather cards */
        .house-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .house-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .house-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .house-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .weather-icon {
            font-size: 24px;
        }
        
        .house-name {
            font-weight: 600;
            color: #111827;
            flex: 1;
        }
        
        .trend {
            font-size: 14px;
            font-weight: 600;
        }
        
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #6b7280; }
        
        .house-score {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .score-value {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
        }
        
        .score-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        .house-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .client-count {
            color: #6b7280;
        }
        
        .issue-count {
            color: #ef4444;
            font-weight: 500;
            cursor: pointer;
        }
        
        .no-issues {
            color: #10b981;
            font-weight: 500;
        }
        
        /* Journey radar */
        .journey-timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .journey-segment {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .journey-segment.has-clients:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .segment-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .segment-count {
            font-size: 24px;
            font-weight: 600;
        }
        
        .segment-green { color: #10b981; }
        .segment-yellow { color: #f59e0b; }
        .segment-blue { color: #3b82f6; }
        .segment-orange { color: #f97316; }
        .segment-purple { color: #8b5cf6; }
        .segment-gray { color: #6b7280; }
        
        .journey-segment.critical-stage {
            border: 2px solid #fbbf24;
            background: #fef3c7;
        }
        
        .critical-indicator {
            margin-left: 4px;
            font-size: 16px;
        }
        
        .segment-connector {
            color: #d1d5db;
            font-size: 20px;
        }
        
        .segment-detail {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        /* Segment client list modal */
        .segment-clients-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .segment-client-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .segment-client-item:hover {
            background: #f9fafb;
        }
        
        .segment-client-item .client-initials {
            font-weight: 600;
            margin-right: 8px;
        }
        
        .segment-client-item .client-house {
            color: #6b7280;
            margin-right: 8px;
        }
        
        .segment-client-item .client-info {
            flex: 1;
            color: #6b7280;
        }
        
        .segment-client-item .status-indicator {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-indicator.urgent {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* Metrics grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }
        
        .metric-item {
            text-align: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .metric-label {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .metric-detail {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .trend-indicator {
            font-size: 16px;
            font-weight: 600;
        }
        
        .trend-positive { color: #10b981; }
        .trend-negative { color: #ef4444; }
        
        /* Quick actions */
        .actions-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: #f9fafb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .action-icon {
            font-size: 20px;
        }
        
        .action-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* Responsive design */
        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        @media (min-width: 1280px) {
            .dashboard-grid {
                grid-template-columns: 3fr 2fr;
            }
        }
    </style>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
            background: #f5f6ff;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0.85;
            z-index: -1;
        }

        .container {
            max-width: 100%;
            margin: calc(var(--app-shell-total-header, 128px) + 20px) auto 60px;
            padding: 32px;
            background: white;
            min-height: calc(100vh - var(--app-shell-total-header, 128px) - 80px);
            border-radius: 28px;
            box-shadow: 0 25px 60px rgba(102, 126, 234, 0.25);
            overflow: hidden;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .demo-btn.active {
            background: #fbbf24;
            color: #1f2937;
            border-color: #f59e0b;
        }
        
        .demo-btn.active:hover {
            background: #f59e0b;
        }
        
        .demo-indicator {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #fbbf24;
            color: #1f2937;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
            z-index: 10000;
            display: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
            }
            50% {
                box-shadow: 0 4px 20px rgba(251, 191, 36, 0.8);
            }
            100% {
                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.5);
            }
        }

        .main-content {
            display: grid !important;
            grid-template-columns: 1fr 440px; /* left: programs, right: controls */
            gap: 20px;
            min-height: 600px;
            position: relative;
            align-items: start;
            visibility: visible !important;
        }
        
        /* Dashboard-specific layout override */
        .dashboard-active .main-content {
            display: block !important;
            grid-template-columns: none !important;
        }
        
        .dashboard-active .selection-panel {
            display: none !important;
        }
        
        .dashboard-active .programs-panel {
            max-width: 100% !important;
            width: 100% !important;
        }
        
        .programs-panel {
            padding: 30px;
            overflow-y: auto;
            background: #ffffff;
            max-height: 85vh;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 1;
        }
        
        .selection-panel {
            width: 440px;
            min-width: 440px;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 20px;
            display: none; /* Hidden by default - only show for Programs tab */
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 12px;
            position: sticky;
            top: 10px;
            height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 10;
        }
        
        .document-type-selector {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .doc-type-buttons {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .doc-type-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #0099cc;
            background: white;
            color: #0099cc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .doc-type-btn.active {
            background: #0099cc;
            color: white;
        }

        .guided-btn {
            width: 100%;
            margin-bottom: 20px;
            padding: 12px 18px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #34d399, #059669);
            color: white;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .guided-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(5, 150, 105, 0.35);
        }

        .guided-btn:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .wizard-actions button {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .wizard-actions .wizard-back {
            background: #e5e7eb;
            color: #374151;
        }

        .wizard-actions .wizard-next {
            background: #4f46e5;
            color: white;
        }

        .wizard-actions .wizard-finish {
            background: #059669;
            color: white;
        }

        .wizard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .wizard-card {
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.08);
        }

        .wizard-program-list {
            display: grid;
            gap: 10px;
            max-height: 260px;
            overflow-y: auto;
        }

        .wizard-program-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
            transition: border-color 0.2s ease;
        }

        .wizard-program-item input[type="checkbox"] {
            margin-top: 4px;
            transform: scale(1.1);
        }

        .wizard-program-item.active {
            border-color: #4f46e5;
            box-shadow: 0 4px 14px rgba(79, 70, 229, 0.18);
            background: #eef2ff;
        }

        .wizard-program-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .wizard-program-meta .name {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-program-meta .location {
            font-size: 12px;
            color: #4b5563;
        }

        .wizard-program-meta .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .wizard-program-meta .chip {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .wizard-toggles {
            display: grid;
            gap: 10px;
        }

        .wizard-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
        }

        .wizard-toggle span {
            font-weight: 600;
            color: #1f2937;
        }

        .wizard-note {
            font-size: 13px;
            color: #4b5563;
            background: #ecfeff;
            border-left: 4px solid #0891b2;
            padding: 12px 14px;
            border-radius: 8px;
        }

        .wizard-no-results {
            text-align: center;
            padding: 30px 20px;
            color: #6b7280;
            font-size: 14px;
            border: 1px dashed #cbd5f5;
            border-radius: 10px;
            background: #f8fafc;
        }

        .input-error {
            border-color: #f87171 !important;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.2) !important;
        }

        .document-preview-modal {
            max-width: 95%;
            width: 900px;
        }

        /* Document preview container - clean and simple */
        #documentPreviewContainer {
            background: white;
            margin: 0 auto;
            padding: 40px 60px;
            box-sizing: border-box;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        /* Ensure all document styles apply in preview */
        #documentPreviewContainer .doc-page {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        #documentPreviewContainer .doc-content {
            padding-bottom: 40px;
        }
        
        #documentPreviewContainer .doc-footer {
            position: relative;
            bottom: auto;
            margin-top: 40px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media screen and (max-width: 900px) {
            #documentPreviewContainer {
                padding: 20px 30px;
            }
        }
        
        .client-info {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 8px rgba(0,153,204,0.08);
        }
        
        .client-info h3 {
            color: #0c4a6e;
            margin-bottom: 14px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .client-info input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            margin-bottom: 0;
            font-family: -apple-system, 'Calibri', Arial, sans-serif;
            font-size: 15px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .client-info input:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        /* Checkbox specific styles */
        #includeAtHome {
            accent-color: #0099cc;
            transform: scale(1.1);
            margin-right: 2px;
        }
        
        #includeAtHome:hover {
            transform: scale(1.2);
        }
        
        .search-container {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
        }
        
        .search-box {
            width: 100%;
            padding: 14px 18px;
            padding-right: 120px; /* Space for button */
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #0099cc;
            box-shadow: 0 0 0 3px rgba(0,153,204,0.1);
        }
        
        .search-indicator {
            display: none;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #666;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .add-program-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            background: linear-gradient(45deg, #0099cc, #00b4d8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 153, 204, 0.3);
            z-index: 10;
        }
        
        .add-program-btn.show {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }
        
        .add-program-btn:hover {
            background: linear-gradient(45deg, #0088bb, #00a3c7);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 153, 204, 0.4);
        }
        
        .add-program-btn:active {
            transform: translateY(-50%) scale(0.98);
        }
        
        .search-animation {
            animation: searchPulse 2s infinite;
        }
        
        @keyframes searchPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .add-animation {
            animation: addSuccess 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes addSuccess {
            0% { transform: translateY(-50%) scale(1); }
            20% { transform: translateY(-50%) scale(1.2) rotate(5deg); }
            40% { transform: translateY(-50%) scale(0.9) rotate(-3deg); }
            60% { transform: translateY(-50%) scale(1.1) rotate(2deg); }
            80% { transform: translateY(-50%) scale(0.95) rotate(-1deg); }
            100% { transform: translateY(-50%) scale(1) rotate(0deg); }
        }
        
        .filter-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .filter-btn:hover {
            border-color: #0099cc;
            color: #0099cc;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .filter-btn.active {
            background: #0099cc;
            color: white;
            border-color: #0099cc;
            box-shadow: 0 2px 8px rgba(0,153,204,0.2);
        }
        
        .program-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            padding: 0;
            margin-top: 15px;
        }
        
        .program-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .program-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-color: #cbd5e1;
        }
        
        .program-card.primary {
            border-color: #0099cc;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            box-shadow: 0 4px 12px rgba(0,153,204,0.15);
        }
        
        .program-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            background: #0099cc;
        }
        
        .program-name {
            font-weight: bold;
            font-size: 15px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .program-location {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .program-type {
            display: inline-block;
            padding: 2px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            margin-top: 5px;
        }
        
        .program-info-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #0099cc;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            z-index: 2;
            transition: all 0.3s;
        }
        
        .program-info-btn:hover {
            background: #0077aa;
            transform: scale(1.1);
        }
        
        .selected-section {
            flex: 0 1 auto;
            min-height: 120px;
            margin-bottom: 10px;
        }
        
        .section-title {
            font-weight: 600;
            margin: 20px 0 16px 0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            color: #1e40af;
            border-left: 4px solid #0099cc;
        }
        
        .selected-program {
            background: white;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e0e0e0;
            font-size: 13px;
            cursor: move;
            transition: all 0.3s;
        }
        
        .selected-program.dragging {
            opacity: 0.5;
            background: #f0f8ff;
        }
        
        .selected-program.drag-over {
            border-top: 3px solid #0099cc;
        }
        
        .drag-handle {
            cursor: move;
            color: #999;
            margin-right: 8px;
            font-size: 16px;
        }
        
        .program-order-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .order-btn {
            background: #0099cc;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .order-btn:hover {
            background: #0077aa;
        }
        
        .order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #0099cc, #0077aa);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,153,204,0.3);
            width: 100%;
            letter-spacing: 0.5px;
            min-height: 44px;
            max-height: 44px;
        }
        
        .generate-btn:hover {
            background: linear-gradient(135deg, #0077aa, #005588);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,153,204,0.4);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        .generate-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .instructions {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
            border: 1px solid #fbbf24;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(251,191,36,0.1);
        }
        
        .instructions h3 {
            color: #92400e;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .instructions ul {
            margin-left: 20px;
            color: #78350f;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .instructions ul li {
            margin-bottom: 6px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 15px;
            font-style: italic;
            font-size: 13px;
        }
        
        #selectedList {
            min-height: 80px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 10px;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }

        body.dark-mode .panel {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .program-card {
            background: #252538;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .program-card:hover {
            background: #2a2a3e;
            border-color: #4a4a5e;
        }

        body.dark-mode .program-card.selected {
            background: #2a3f5f;
            border-color: #3498db;
        }

        body.dark-mode input[type="text"],
        body.dark-mode select {
            background: #252538;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        body.dark-mode .modal-content {
            background: #1a1a2e;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: static;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 999px;
            padding: 8px 14px;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: inherit;
            box-shadow: none;
        }
        
        .theme-toggle:hover,
        .theme-toggle:focus-visible {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.55);
        }
        
        body.dark-mode .theme-toggle {
            border-color: rgba(255, 255, 255, 0.35);
            color: #f3f4ff;
        }

        /* Comparison View Styles */
        .comparison-view {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            overflow: hidden;
        }

        .comparison-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-content {
            display: flex;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .comparison-column {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #ddd;
        }

        .comparison-column:last-child {
            border-right: none;
        }

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .quick-action-btn:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        body.dark-mode .quick-action-btn {
            background: #252538;
            border-color: #3a3a4e;
            color: #e0e0e0;
        }

        body.dark-mode .quick-action-btn:hover {
            background: #2a2a3e;
        }

        /* Document History Panel */
        .history-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 999;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        
        .history-panel.active {
            display: block;
        }

        .history-panel.open {
            right: 0;
        }

        .history-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .history-item:hover {
            background: #f5f5f5;
        }

        body.dark-mode .history-panel {
            background: #1a1a2e;
        }

        body.dark-mode .history-item {
            border-bottom-color: #2a2a3e;
        }

        body.dark-mode .history-item:hover {
            background: #252538;
        }

        /* Analytics Dashboard */
        .analytics-dashboard {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .analytics-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .analytics-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #6366f1;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 80%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: #0099cc;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            position: relative;
            z-index: 1001;
            padding: 5px;
            line-height: 1;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            color: #f0f0f0;
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            min-height: 0; /* Important for flex children */
        }
        
        .preview-section {
            margin-bottom: 20px;
        }
        
        .preview-section h3 {
            color: #0099cc;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        
        .preview-features {
            list-style: none;
            padding: 0;
        }
        
        .preview-features li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        .preview-features li strong {
            color: #333;
        }
        
        .preview-contact {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        
        .preview-contact div {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .modal-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .add-from-preview {
            background: #0099cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .add-from-preview:hover {
            background: #0077aa;
        }
        
        .add-from-preview.selected {
            background: #dc3545;
        }
        
        /* Print Styles - Professional Clean Document */
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .main-content { flex-direction: column; }
            .programs-panel, .selection-panel { width: 100%; max-width: 100%; }
            .program-grid { grid-template-columns: 1fr; }
            .filter-buttons, .quick-actions { flex-wrap: wrap; }
            .history-panel { width: 100%; }
            .comparison-view { width: 95%; }
            .comparison-content { flex-direction: column; }
        }
        
        @media print {
            @page {
                size: letter;
                margin: 1in 0.75in 1in 0.75in; /* Top, Right, Bottom, Left - content width ~6.5" */
            }
            
            /* Hide ALL UI elements during print */
            .theme-toggle,
            .history-panel,
            .comparison-view,
            .analytics-dashboard,
            .container,
            .modal,
            .quick-actions,
            #historyPanel,
            #comparisonView,
            #analyticsDashboard {
                display: none !important;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .container {
                display: none !important;
            }
            
            .document-output {
                display: block !important;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                color: black;
                font-family: Helvetica, Arial, "Segoe UI", sans-serif;
                font-size: 11pt;
                line-height: 1.6;
            }
            
            .doc-page {
                position: relative;
                width: 100%;
                padding: 0;
                page-break-inside: avoid;
                overflow: visible; /* ensure header image not clipped */
            }
            
            /* Hide web elements completely */
            .modal, .program-info-btn, .program-badge {
                display: none !important;
            }
        }
        
        /* Document output styles */
        .document-output {
            display: none;
            font-family: Helvetica, Arial, "Segoe UI", sans-serif;
            font-size: 11pt; /* Body size 11-12pt as specified */
            line-height: 1.6;
            color: #000;
        }
        
        .doc-page {
            background: white;
            position: relative;
            min-height: 100%;
            overflow: visible; /* allow header graphics to render fully */
            width: 720px; /* 7.5 inches of usable space at 96 DPI */
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        .doc-content {
            padding-bottom: 100px; /* More space for footer to prevent overlap */
            padding-top: 0; /* Remove top padding */
            margin-top: 0;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: calc(100vh - 150px); /* Ensure proper page height */
        }
        
        /* Letterhead Header */
        .doc-letterhead {
            text-align: center;
                            margin-bottom: 20px;
            padding-bottom: 0;
                            margin-top: 0;
                            padding-top: 0;
                        }
                        .letterhead-image {
                            width: 100%;
                            max-width: 100%;
                            height: auto;
                            margin: 0 auto;
                            display: block;
        }
        
        .doc-letterhead-logo {
            height: 80px !important; /* fixed visual height to avoid partial decode/cropping */
            width: auto !important;
            max-width: 160px !important;
            margin: 0 auto 15px !important;
            display: block !important;
            object-fit: contain !important;
            object-position: center center !important;
            /* Ensure image loads properly in print */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .doc-logo {
            width: 200px;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }
        
        .doc-letterhead-lockup {
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }
        
        .doc-letterhead-icon {
            width: 40px;
            height: 40px;
            background: #0099cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        
        .doc-letterhead-text {
            text-align: center;
        }
        
        .doc-letterhead-text h1 {
            font-size: 24pt;
            color: #0099cc;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        
        .doc-letterhead-text p {
            font-size: 12pt;
            color: #000000;
            margin: 2px 0 0 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        /* Document Body */
        .doc-greeting {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: normal;
            margin-bottom: 8px;
        }
        
        .doc-intro {
            font-size: 9pt;
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-style: italic;
            text-decoration: underline;
            margin-bottom: 18pt;
            line-height: 1.4;
        }
        
        /* Section headers - CALIBRI 10PT BOLD (e.g., "Aftercare Options:") */
        .doc-section-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            margin: 18pt 0 14pt 0;
            text-align: left;
        }
        
        /* Category headers - CALIBRI 9PT BOLD (e.g., "PHP Options") */
        .doc-category-header {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: bold;
            margin: 14pt 0 10pt 0;
        }
        
        /* Program Cards */
        .doc-program {
            margin-bottom: 24pt; /* Two blank lines between programs */
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        /* Program title line with en dash - MUST BE CALIBRI 10PT BOLD */
        .doc-program-title {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 10pt;
            font-weight: bold;
            color: #000;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        /* Level of Care & Services section - MUST BE SINGLE PARAGRAPH, CALIBRI 9PT */
        .doc-program-descriptor {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-top: 12pt;
            margin-bottom: 0;
            line-height: 1.4;
        }
        
        .doc-program-descriptor strong {
            font-weight: bold;
        }
        
        /* Program Details heading - CALIBRI 9PT BOLD */
        .doc-program-details-heading {
            font-family: 'Calibri', Arial, sans-serif;
            font-weight: bold;
            font-size: 9pt;
            margin-bottom: 6pt;
            margin-top: 12pt;
        }
        
        /* Bullet lists - REAL BULLETS, CALIBRI 9PT */
        .doc-program-bullets {
            margin: 0 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-program-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            margin-bottom: 4pt;
            position: relative;
            padding-left: 15px;
            line-height: 1.4;
        }
        
        .doc-program-bullets li:before {
            content: "•";
            position: absolute;
            left: 0;
        }
        
        /* Bold concept introductions in bullets */
        .doc-program-bullets li strong {
            font-weight: bold;
        }
        
        /* Sub-bullets with dashes */
        .doc-sub-bullets {
            margin: 4pt 0 0 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .doc-sub-bullets li {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            margin-bottom: 2pt;
            position: relative;
            padding-left: 15px;
        }
        
        .doc-sub-bullets li:before {
            content: "–";
            position: absolute;
            left: 0;
        }
        
        /* Contact Information block - CALIBRI 9PT */
        .doc-contact-section {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 9pt;
            font-weight: normal;
            line-height: 1.4;
            margin-top: 6pt;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .doc-contact-section strong {
            font-weight: bold;
        }
        
        .doc-contact-section a {
            word-break: break-all;
            color: #0066cc;
            text-decoration: none;
        }
        
        .doc-contact-section a:hover {
            text-decoration: underline;
        }
        
        /* Footer - stacked format */
        .doc-footer {
            position: fixed;
            bottom: 20px;
            left: 50px;
            right: 50px;
            text-align: center;
            font-size: 10pt;
            color: #333;
            background: white;
            padding: 15px 10px 10px 10px;
            border-top: 1px solid #ccc;
            z-index: 1000;
            box-shadow: 0 -2px 5px rgba(255,255,255,0.9);
            line-height: 1.4;
        }
        
        .doc-footer div {
            margin: 2px 0;
        }
        
        /* Mini card styles for AT HOME sections */
        .doc-mini-card {
            margin-bottom: 18pt;
            padding: 12pt;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafbfc;
        }
        .doc-mini-title {
            font-size: 11pt;
            font-weight: bold;
            margin-bottom: 8pt;
            color: #374151;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 4pt;
        }
        .doc-mini-blurb {
            font-size: 10pt;
            margin-bottom: 8pt;
            min-height: 24pt;
            border-bottom: 1px dotted #9ca3af;
            padding-bottom: 4pt;
            color: #6b7280;
        }
        
        .doc-mini-contact {
            font-size: 10pt;
            color: #374151;
        }
        
        .doc-mini-contact .contact-line {
            display: flex;
            align-items: center;
            margin-bottom: 4pt;
        }
        
        .doc-mini-contact .contact-label {
            font-weight: 600;
            min-width: 70px;
            color: #1f2937;
        }
        
        .doc-mini-contact .contact-fill {
            flex: 1;
            border-bottom: 1px solid #d1d5db;
            min-height: 16pt;
            margin-left: 8px;
        }
        
        /* Special emphasis for AT HOME Recommendation */
        .doc-emphasis-section {
            font-family: Calibri, Arial, sans-serif;
            font-size: 10pt;
            font-style: italic;
            text-decoration: underline;
        }
        
        /* Print-specific styles for blank lines */
        @media print {
            .doc-mini-title, .doc-mini-blurb, .doc-mini-contact {
                min-height: 1.2em;
            }
            
            .doc-footer {
                position: fixed;
                bottom: 0.5in;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 10pt;
                color: #333;
                background: white;
                padding: 10px 0;
                z-index: 100;
            }
            
            .doc-content {
                padding-bottom: 80px; /* More space for fixed footer */
            }
        }
        
        /* Delete button for custom programs */
        .program-delete-btn {
            position: absolute;
            top: 8px;
            right: 38px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
            transition: all 0.2s ease;
            z-index: 10;
            opacity: 0.8;
        }
        
        .program-delete-btn:hover {
            opacity: 1;
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .program-delete-btn:active {
            transform: scale(0.95);
        }
        
        /* Login Form Styles */
        .login-content .form-group {
            margin-bottom: 20px;
        }
        
        .login-content .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }
        
        .login-content .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .login-content .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-content .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-content .login-btn:hover {
            transform: translateY(-2px);
        }
        
        /* User Profile Button */
        .user-profile-btn {
            position: static;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6e7bff 0%, #8b5cf6 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(110, 123, 255, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-profile-btn:hover,
        .user-profile-btn:focus-visible {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(110, 123, 255, 0.45);
        }
        
        .user-profile-btn:active {
            transform: translateY(0);
        }
        
        /* User Menu Dropdown */
        .user-menu {
            position: fixed;
            top: 96px;
            right: 32px;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 999;
            animation: slideDown 0.2s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Welcome Animation */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            animation: overlayFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: opacity, transform;
        }
        
        .welcome-overlay.fade-out {
            animation: overlayFadeOut 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes overlayFadeIn {
            from { 
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to { 
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }
        
        @keyframes overlayFadeOut {
            0% { 
                opacity: 1;
                backdrop-filter: blur(10px);
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                backdrop-filter: blur(5px);
                transform: scale(1.01);
            }
            100% { 
                opacity: 0;
                backdrop-filter: blur(0px);
                transform: scale(1.05);
            }
        }
        
        .welcome-message {
            color: white;
            text-align: center;
            animation: messageSlideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center center;
            will-change: transform, opacity;
        }
        
        .welcome-message.fade-out {
            animation: messageFadeDown 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .welcome-message h1 {
            font-size: 48px;
            margin: 0 0 15px 0;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.1);
            background: linear-gradient(90deg, #fff, rgba(255,255,255,0.8), #fff);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shimmerText 3s ease-in-out infinite;
        }
        
        .welcome-message p {
            font-size: 24px;
            margin: 0 0 30px 0;
            opacity: 0.95;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        @keyframes shimmerText {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }
        
        @media (max-width: 768px) {
            .welcome-message h1 {
                font-size: 32px;
            }
            
            .welcome-message p {
                font-size: 18px;
                margin: 0 0 20px 0;
            }
            
            .welcome-progress {
                width: 150px;
            }
        }
        
        .welcome-progress {
            width: 200px;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .welcome-progress-bar {
            height: 100%;
            background: white;
            border-radius: 3px;
            animation: progressFill 2.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        @keyframes messageSlideUp {
            0% {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            60% {
                opacity: 1;
                transform: translateY(-5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes messageFadeDown {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
        }
        
        @keyframes progressFill {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: #1a202c;
        }
        
        .user-username {
            font-size: 13px;
            color: #718096;
        }
        
        /* Landing Page Responsive Styles */
        @media (min-width: 768px) {
            .landing-left {
                display: block !important;
            }
            .mobile-branding {
                display: none !important;
            }
        }
        
        @media (max-width: 767px) {
            .landing-left {
                display: none !important;
            }
            .mobile-branding {
                display: block !important;
            }
            #loginScreen > div > div:last-child {
                flex: 1 1 100% !important;
                max-width: 100% !important;
            }
        }
        
        /* Enhanced input focus styles for ClearHive branding */
        #loginUsername:focus, #loginPassword:focus {
            outline: none;
            border-color: #0891b2 !important;
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1) !important;
        }
        
        /* Login button hover effect */
        .login-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(8, 145, 178, 0.4) !important;
        }
        
        .login-btn:active {
            transform: translateY(-1px) !important;
        }
        
        /* User Menu Dropdown Styles - Enhanced */
        .user-menu {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255,255,255,0.08), inset 0 1px 0 rgba(255,255,255,0.05);
            min-width: 280px;
            z-index: 10001;
            overflow: hidden;
            animation: userMenuSlide 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(20px);
        }
        
        @keyframes userMenuSlide {
            from {
                opacity: 0;
                transform: translateY(-12px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .user-menu-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        .user-menu-avatar {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            flex-shrink: 0;
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .user-menu-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-menu-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #f1f5f9;
            letter-spacing: -0.01em;
        }
        
        .user-menu-username {
            font-size: 13px;
            color: rgba(148, 163, 184, 0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-menu-body {
            padding: 8px;
        }
        
        .user-menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.06);
            margin: 6px 8px;
        }
        
        .user-menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border: none;
            background: transparent;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 10px;
            margin: 2px 0;
        }
        
        .user-menu-item:hover {
            background: rgba(255,255,255,0.06);
            color: #f8fafc;
        }
        
        .user-menu-item:active {
            background: rgba(255,255,255,0.08);
            transform: scale(0.98);
        }
        
        .user-menu-item--danger {
            color: #f87171;
        }
        
        .user-menu-item--danger:hover {
            background: rgba(239, 68, 68, 0.12);
            color: #fca5a5;
        }
        
        .user-menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
            opacity: 0.8;
        }
        
        .user-menu-item:hover .user-menu-icon {
            opacity: 1;
        }
        
        .user-menu-footer {
            padding: 12px 16px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.04);
            font-size: 11px;
            color: rgba(148, 163, 184, 0.5);
            text-align: center;
        }
        
        /* User profile button styles */
        .user-profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .user-profile-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .user-profile-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="auth-screen">
        <div class="auth-orb auth-orb--1"></div>
        <div class="auth-orb auth-orb--2"></div>
        <div class="auth-orb auth-orb--3"></div>

        <div class="auth-shell">
            <section class="auth-panel auth-panel--left">
                <header class="auth-brand">
                    <div class="auth-brand-text">
                        <div class="auth-brand-parent">ClearHive Health</div>
                        <div class="auth-brand-product">CareConnect</div>
                        <div class="auth-brand-org">for Family First Adolescent Services</div>
                    </div>
                    <img src="images/file.svg" alt="Family First" class="auth-logo" />
                </header>

                <div class="auth-copy">
                    <h1 class="auth-title">Clinician Workspace</h1>
                    <p class="auth-subtitle">
                        A secure space for therapists, case managers, and clinical coaches to manage
                        aftercare planning and documentation.
                    </p>
                    <ul class="auth-bullets">
                        <li>Build discharge and aftercare packets in minutes</li>
                        <li>Track aftercare planning tasks in one view</li>
                        <li>Keep documentation consistent across the team</li>
                    </ul>
                </div>

                <footer class="auth-footnote">
                    <p class="auth-footnote-main">
                        🔒 All data stays on this device. CareConnect stores no PHI or full names.
                    </p>
                    <p class="auth-footnote-sub">
                        Internal use only · Family First Adolescent Services
                    </p>
                </footer>
            </section>

            <section class="auth-panel auth-panel--right">
                <div class="auth-card">
                    <header class="auth-card-header">
                        <h2>Sign in to CareConnect</h2>
                        <p>
                            Use your assigned CareConnect credentials.<br>
                            This login is for Family First clinical staff only.
                        </p>
                    </header>
                
                    <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                        <div id="loginError" class="auth-alert" role="alert"></div>

                        <div class="auth-field">
                            <label for="loginUsername">Username</label>
                            <input
                                id="loginUsername"
                                name="username"
                                type="text"
                                autocomplete="username"
                                placeholder="e.g. cmolina"
                                required
                            >
                        </div>
                        
                        <div class="auth-field">
                            <label for="loginPassword">Password</label>
                            <input
                                id="loginPassword"
                                name="password"
                                type="password"
                                autocomplete="current-password"
                                placeholder="••••••••"
                                required
                            >
                        </div>
                        
                        <div class="auth-form-row">
                            <label class="auth-remember">
                                <input type="checkbox" id="rememberMe">
                                <span>Remember me on this device</span>
                            </label>
                            <button type="button" class="auth-link" onclick="alert('If you forgot your password, contact your supervisor or IT admin.');">
                                Forgot password?
                            </button>
                        </div>
                        
                        <button type="submit" class="auth-submit-btn">
                            Enter workspace
                        </button>

                        <p class="auth-small-print">
                            By signing in you confirm you are an authorized member of the Family First clinical team
                            and agree to follow all HIPAA and privacy policies.
                        </p>
                    </form>

                    <div class="auth-divider">
                        <span>or</span>
                    </div>
                    
                    <div class="auth-create-account">
                        <button type="button" class="auth-create-btn" onclick="showCreateAccountForm()">
                            <span class="auth-create-icon">👤</span>
                            <span>New Coach? Create Account</span>
                        </button>
                    </div>

                    <div class="auth-support">
                        <div class="auth-support-label">Need help?</div>
                        <p>
                            Locked out of your account?<br>
                            Contact your supervisor or CareConnect admin.
                        </p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" style="display: none;">
    <header class="app-header" id="appHeader" aria-label="CareConnect workspace navigation">
        <div class="app-header__top">
            <button type="button"
                    class="app-header__icon-btn app-header__menu-btn"
                    id="appNavToggle"
                    aria-label="Open navigation"
                    aria-controls="appNavDrawer"
                    aria-expanded="false">
                ☰
            </button>
            <div class="app-header__brand">
                <img src="assets/clearhive-logo.png" alt="ClearHive Health" class="app-header__brand-mark app-header__brand-logo" onerror="this.src='assets/clearhive-logo.svg'">
                <div class="app-header__brand-text">
                    <strong>CareConnect</strong>
                    <span class="app-header__brand-subtitle">Family First Adolescent Services</span>
                </div>
            </div>
            <div class="app-header__top-actions">
                <button type="button"
                        class="app-header__icon-btn"
                        id="appHelpButton"
                        aria-label="Open help and shortcuts"
                        onclick="showHelp()">
                    ?
                </button>
                <button class="theme-toggle dark-mode-toggle" type="button" onclick="ThemeManager.toggle()" aria-label="Toggle dark mode">
                    <span class="dark-mode-toggle-icon">🌙</span>
                    <span class="app-header__action-label dark-mode-toggle-label">DARK MODE</span>
                </button>
                <button class="user-profile-btn"
                        type="button"
                        onclick="toggleUserMenu()"
                        id="userProfileBtn"
                        title="User Profile"
                        aria-haspopup="true"
                        aria-expanded="false">
                    <span id="userInitials">?</span>
                </button>
            </div>
        </div>
        <div class="app-header__section" id="appSectionHeader"></div>
    </header>
    
    <!-- User Menu Dropdown - Enhanced -->
    <div id="userMenu" class="user-menu" style="display: none;" role="menu" aria-label="User menu">
        <div class="user-menu-header">
            <div class="user-menu-avatar" id="userMenuInitials">?</div>
            <div class="user-menu-info">
                <div class="user-menu-name" id="userMenuName">User</div>
                <div class="user-menu-username" id="userMenuUsername">@username</div>
            </div>
        </div>
        <div class="user-menu-body">
            <button type="button" class="user-menu-item" onclick="window.showUserProfile && window.showUserProfile()" role="menuitem">
                <span class="user-menu-icon">👤</span>
                <span>Profile</span>
            </button>
            <div class="user-menu-divider"></div>
            <button type="button" class="user-menu-item user-menu-item--danger" onclick="handleLogout()" role="menuitem">
                <span class="user-menu-icon">🚪</span>
                <span>Sign Out</span>
            </button>
        </div>
        <div class="user-menu-footer">
            CareConnect Pro · Family First
        </div>
    </div>
    
    <div class="app-drawer-overlay" id="appNavOverlay" tabindex="-1" aria-hidden="true"></div>
    <nav class="app-drawer" id="appNavDrawer" aria-hidden="true" aria-label="Primary navigation">
        <div class="app-drawer__header">
            <p class="app-drawer__title">Navigate</p>
            <div class="app-drawer__product">CareConnect</div>
            <button type="button" class="app-drawer__close" id="appNavClose" aria-label="Close navigation">×</button>
        </div>
        <div class="app-drawer__body">
            <button type="button" class="app-drawer__item" data-nav-target="dashboard">
                <span class="app-drawer__icon">🎯</span>
                <span>Dashboard</span>
            </button>
            <button type="button" class="app-drawer__item" data-nav-target="programs">
                <span class="app-drawer__icon">📑</span>
                <span>Programs &amp; Docs</span>
            </button>
            <button type="button" class="app-drawer__item" data-nav-target="clients">
                <span class="app-drawer__icon">👥</span>
                <span>Clients</span>
            </button>
            <button type="button" class="app-drawer__item" id="documentVaultBtn" onclick="openDocumentVault()">
                <span class="app-drawer__icon">🗄️</span>
                <span>Document Vault</span>
            </button>
            <button type="button" class="app-drawer__item app-drawer__item--admin" data-nav-target="admin" data-admin-only="true" style="display:none;">
                <span class="app-drawer__icon">⚙️</span>
                <span>Admin Command Center</span>
            </button>
        </div>
    </nav>
    <!-- App Shell Controller - EXTRACTED TO EXTERNAL MODULE
         See js/core/shell.js for navigation drawer, section headers, and ccShell API.
         Extraction Date: December 7, 2025 -->
    <script src="js/core/shell.js"></script>
    </script>
    <script>
        // History panel toggle (document history drawer)
        window.toggleHistory = window.toggleHistory || function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            if (!panel) return;
            panel.classList.toggle('active');
            panel.classList.toggle('open');
            // When opened, refresh contents if helper exists
            if (panel.classList.contains('open') && typeof updateHistoryPanel === 'function') {
                try {
                    updateHistoryPanel().catch?.(console.error);
                } catch (err) {
                    console.error('Error updating history panel:', err);
                }
            }
        };

        // Close comparison view panel
        window.closeComparison = window.closeComparison || function closeComparison() {
            const view = document.getElementById('comparisonView');
            if (view) {
                view.style.display = 'none';
            }
        };
    </script>
    
    <!-- Legacy User Menu removed - using enhanced version above -->
    
    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h3>Document History</h3>
            <button onclick="toggleHistory()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">✕</button>
        </div>
        <div id="historyContent"></div>
    </div>
    
    <!-- Comparison View -->
    <div class="comparison-view" id="comparisonView">
        <div class="comparison-header">
            <h3>Program Comparison</h3>
            <button onclick="closeComparison()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">✕</button>
        </div>
        <div class="comparison-content" id="comparisonContent"></div>
    </div>
    
    <!-- Slide-out Menu removed: functionality is consolidated into Admin Command Center and Programs toolbar -->
    
    <style>
        .slide-menu {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        
        .slide-menu.active {
            right: 0;
        }
        
        .menu-header {
            background: #0099cc;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .close-menu {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-content {
            padding: 20px;
        }
        
        .menu-section {
            margin-bottom: 30px;
        }
        
        .menu-section h4 {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .menu-item {
            width: 100%;
            padding: 12px 15px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .menu-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* Dark mode styles for menu */
        body.dark-mode .slide-menu {
            background: #2a2a2a;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .menu-header {
            background: #1a1a2a;
        }
        
        body.dark-mode .menu-section h4 {
            color: #999;
            border-color: #444;
        }
        
        body.dark-mode .menu-item {
            background: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .menu-item:hover {
            background: #404040;
        }
        
        /* Menu overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 9998;
        }
        
        .menu-overlay.active {
            display: block;
        }

        :root {
            --app-shell-top-offset: 72px;
            --app-shell-header-z: 120;
        }

        .app-header {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            z-index: var(--app-shell-header-z, 120);
            background: rgba(15, 16, 32, 0.95);
            color: #f8fbff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
            box-shadow: 0 12px 32px rgba(15, 16, 32, 0.32);
        }

        .app-header__top {
            display: flex;
            align-items: center;
            gap: 18px;
            min-height: 64px;
            padding: 14px clamp(16px, 3vw, 36px);
        }

        .app-header__brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-header__brand-mark {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #6e7bff, #c9ceff);
            color: #0f1020;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.08em;
        }
        
        /* Logo image variant - dark mode default */
        .app-header__brand-logo {
            background: transparent;
            border-radius: 10px;
            object-fit: contain;
            width: 44px;
            height: 44px;
            transition: all 0.2s ease;
        }
        
        /* Light mode - white background to make logo distinct */
        html:not([data-theme="dark"]):not(.dark) .app-header__brand-logo,
        body:not(.dark-mode) .app-header__brand-logo {
            background: white;
            padding: 5px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(30, 58, 95, 0.15);
            width: 50px;
            height: 50px;
        }
        
        /* Reset for dark mode (ensure no background) */
        html[data-theme="dark"] .app-header__brand-logo,
        html.dark .app-header__brand-logo,
        body.dark-mode .app-header__brand-logo {
            background: transparent;
            padding: 0;
            box-shadow: none;
            width: 44px;
            height: 44px;
        }

        .app-header__brand-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .app-header__brand-text strong {
            font-size: 1rem;
            letter-spacing: 0.04em;
        }

        .app-header__brand-subtitle {
            font-size: 0.76rem;
            opacity: 0.7;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        .app-header__top-actions {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .app-header__icon-btn {
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.08);
            color: inherit;
            border-radius: 999px;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }

        .app-header__icon-btn:hover,
        .app-header__icon-btn:focus-visible {
            background: rgba(255, 255, 255, 0.22);
            border-color: rgba(255, 255, 255, 0.45);
            transform: translateY(-1px);
        }

        .app-header__menu-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            font-size: 1.3rem;
            background: rgba(255, 255, 255, 0.12);
        }

        .app-header__action-label {
            font-size: 0.8rem;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .app-header__section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px clamp(16px, 3vw, 36px) 14px;
            background: rgba(24, 26, 60, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .app-header__section.is-hidden {
            display: none;
        }

        .section-header__content {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .section-eyebrow {
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            font-size: 0.7rem;
            opacity: 0.65;
        }

        .section-header__title {
            margin: 2px 0 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .section-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
        }

        .section-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8d97ff;
            animation: pulse 1.2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.7; }
        }

        .section-header__actions {
            display: inline-flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-chip {
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 999px;
            padding: 6px 14px;
            background: transparent;
            color: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .section-chip:hover,
        .section-chip:focus-visible {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.12);
        }

        .section-chip.is-primary {
            background: linear-gradient(135deg, #6e7bff, #8b5cf6);
            border-color: transparent;
            color: #0f1020;
        }

        .app-drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 12, 32, 0.55);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: calc(var(--app-shell-header-z, 120) + 5);
        }

        .app-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            max-width: 86vw;
            height: 100vh;
            background: #0f1020;
            color: #f7f8ff;
            box-shadow: 8px 0 30px rgba(5, 7, 20, 0.6);
            transform: translateX(-105%);
            transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: calc(var(--app-shell-header-z, 120) + 10);
            display: flex;
            flex-direction: column;
        }

        .app-drawer__header {
            padding: 22px 24px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .app-drawer__title {
            margin: 0;
            font-size: 0.85rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            opacity: 0.6;
        }

        .app-drawer__product {
            margin: 6px 0 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .app-drawer__body {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .app-drawer__item {
            border: none;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.04);
            color: inherit;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s ease, transform 0.2s ease;
            text-align: left;
        }

        .app-drawer__item:hover,
        .app-drawer__item:focus-visible {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(4px);
        }

        .app-drawer__item.is-active {
            background: linear-gradient(135deg, rgba(110, 123, 255, 0.28), rgba(110, 123, 255, 0.18));
            border: 1px solid rgba(110, 123, 255, 0.45);
        }

        .app-drawer__icon {
            font-size: 1.2rem;
            width: 28px;
            text-align: center;
        }

        .app-drawer__close {
            margin-left: auto;
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: transparent;
            color: inherit;
            border-radius: 10px;
            width: 38px;
            height: 38px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .app-drawer__close:hover,
        .app-drawer__close:focus-visible {
            background: rgba(255, 255, 255, 0.12);
        }

        body.app-nav-open .app-drawer {
            transform: translateX(0);
        }

        body.app-nav-open .app-drawer-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        @media (max-width: 768px) {
            .app-header__top {
                flex-wrap: wrap;
                padding: 12px 18px;
            }

            .app-header__top-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .app-header__action-label {
                display: none;
            }

            .app-header__section {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        /* ============= DASHBOARD STYLES ============= */
        .tab-navigation {
            display: none !important;
            visibility: hidden !important;
        }

        body.tab-nav-fallback .tab-navigation {
            display: none !important;
            visibility: hidden !important;
        }

        .tab-btn {
            padding: 12px 24px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn:hover {
            background: #e0e0e0;
            border-color: #999;
        }

        .tab-btn.active {
            background: #0099cc;
            color: white;
            border-color: #0099cc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Admin Command Center Styles */
        .admin-command-center {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .admin-header {
            margin-bottom: 30px;
        }
        
        .admin-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 8px 0;
        }
        
        .admin-subtitle {
            color: #6b7280;
            font-size: 16px;
            margin: 0;
        }
        
        .admin-sections {
            display: grid;
            gap: 24px;
        }
        
        .admin-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }
        
        .admin-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 12px 0;
        }
        
        .admin-section p {
            color: #6b7280;
            font-size: 14px;
            margin: 0 0 16px 0;
        }

        .admin-2col {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
            gap: 24px;
        }

        .admin-3col {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .admin-subheading {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            margin: 0 0 8px 0;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .admin-table th,
        .admin-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        .admin-table th {
            font-weight: 600;
            color: #6b7280;
            background: #f9fafb;
        }

        .stacked-bar {
            position: relative;
            width: 100%;
            height: 18px;
            border-radius: 999px;
            background: #f3f4f6;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .stacked-bar-segment {
            height: 100%;
            float: left;
        }

        .stacked-bar-legend {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 12px;
            color: #6b7280;
        }

        .stacked-bar-legend li {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .legend-swatch {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .admin-metric-panel {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .metric-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .metric-pill {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
        }

        .metric-bar {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: #e5e7eb;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .metric-bar-fill {
            height: 100%;
            width: 0%;
            border-radius: inherit;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            transition: width 0.4s ease;
        }

        .metric-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 12px;
            color: #6b7280;
        }

        .metric-list li {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .export-history {
            font-size: 12px;
            color: #6b7280;
        }

        .export-history-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .export-history-item:last-child {
            border-bottom: none;
        }
        
        .admin-btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .admin-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .admin-btn.primary {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        .admin-btn.primary:hover {
            background: #4f46e5;
        }
        
        .admin-btn.warning {
            background: #fef3c7;
            color: #92400e;
            border-color: #fcd34d;
        }
        
        .admin-btn.warning:hover {
            background: #fde68a;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .analytics-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .analytics-value {
            font-size: 32px;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 4px;
        }
        
        .analytics-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }
        
        .admin-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .system-info {
            background: #f8fafc;
            border-radius: 10px;
            padding: 16px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row span:first-child {
            color: #64748b;
            font-weight: 500;
        }
        
        .info-row span:last-child {
            color: #1f2937;
            font-weight: 600;
        }

        /* Flight Plan Widget */
        .priority-zones {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .priority-zone {
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        .zone-red {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .zone-purple {
            border-color: #6f42c1;
            background: #f8f5ff;
        }

        .zone-yellow {
            border-color: #ffc107;
            background: #fffef5;
        }

        .zone-green {
            border-color: #28a745;
            background: #f5fff8;
        }

        .zone-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 600;
            background: rgba(255,255,255,0.5);
        }

        .zone-icon {
            font-size: 20px;
        }

        .zone-title {
            flex: 1;
            color: #333;
        }

        .zone-count {
            background: rgba(0,0,0,0.1);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .zone-toggle {
            font-size: 12px;
            color: #666;
        }

        .zone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .zone-content.expanded {
            max-height: 2000px;
        }

        .priority-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .priority-item:last-child {
            border-bottom: none;
        }

        .priority-item-content {
            flex: 1;
        }

        .priority-item-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .priority-item-subtitle {
            font-size: 13px;
            color: #666;
        }

        .priority-item-action {
            padding: 6px 12px;
            background: #0099cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .priority-item-action:hover {
            background: #0077aa;
        }

        .empty-zone {
            padding: 20px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        /* House Weather Widget */
        .house-card {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .house-card:hover {
            border-color: #0099cc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .house-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .weather-icon {
            font-size: 24px;
        }

        .house-name {
            flex: 1;
            font-weight: 600;
            font-size: 18px;
            color: #1a1a1a;
        }

        .house-score {
            text-align: center;
            margin: 12px 0;
        }

        .score-value {
            font-size: 36px;
            font-weight: bold;
            color: #0099cc;
        }

        .score-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .house-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        /* Metrics Widget */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .metric-card {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #0099cc;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
        }

        /* Missions Widget */
        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mission-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #0099cc;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .mission-item.completed {
            background: #f0fdf4;
            border-left-color: #22c55e;
            opacity: 0.8;
        }
        
        .mission-item .mission-content {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            flex: 1;
        }
        
        .mission-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #22c55e;
            transition: transform 0.2s ease;
        }
        
        .mission-checkbox:checked {
            transform: scale(1.1);
        }
        
        .mission-task.task-complete {
            text-decoration: line-through;
            color: #6b7280;
        }
        
        .progress-circle {
            display: inline-flex;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin: 0 2px;
            border: 2px solid #e5e7eb;
            color: #9ca3af;
            background: white;
            transition: all 0.3s ease;
        }
        
        .progress-circle.completed {
            border-color: #22c55e;
            background: #22c55e;
            color: white;
        }
        
        @keyframes missionComplete {
            0% {
                transform: translateX(0);
                background: #f8f9fa;
            }
            50% {
                transform: translateX(5px);
                background: #dcfce7;
            }
            100% {
                transform: translateX(0);
                background: #f0fdf4;
            }
        }

        /* Health Bar Styles */
        .health-bar-container {
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .health-bar {
            flex: 1;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        .health-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255,255,255,0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s ease-out infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .score-text {
            font-weight: 700;
            font-size: 18px;
            min-width: 45px;
            text-align: right;
        }
        
        .house-card.score-excellent .health-bar-fill {
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }
        
        .house-card.score-good .health-bar-fill {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }
        
        .house-card.score-fair .health-bar-fill {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .house-card.score-critical .health-bar-fill {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        
        .house-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .house-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        /* Zone Content Styling */
        .zone-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .zone-content.expanded {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Quick Actions Widget */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .quick-action-button {
            padding: 16px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .quick-action-button:hover {
            border-color: #0099cc;
            background: #e6f7ff;
            transform: translateY(-2px);
        }

        .quick-action-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .quick-action-label {
            font-weight: 600;
            color: #1a1a1a;
        }
        
        /* ============= UNIVERSAL LIGHT MODE FIX ============= */
        /* Fix dark border appearing in Dashboard, Clients, Programs sections */
        body:not(.dark-mode) .container,
        html:not([data-theme="dark"]) .container {
            background: var(--bg-base, #F8F7FC) !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        body:not(.dark-mode) .main-content,
        html:not([data-theme="dark"]) .main-content {
            background: var(--bg-base, #F8F7FC) !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        body:not(.dark-mode) .programs-panel,
        html:not([data-theme="dark"]) .programs-panel {
            background: var(--bg-base, #F8F7FC) !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        body:not(.dark-mode) .tab-content,
        html:not([data-theme="dark"]) .tab-content {
            background: var(--bg-base, #F8F7FC) !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        body:not(.dark-mode) #dashboardTab,
        body:not(.dark-mode) #clientsTab,
        body:not(.dark-mode) #programsTab,
        body:not(.dark-mode) #adminTab,
        html:not([data-theme="dark"]) #dashboardTab,
        html:not([data-theme="dark"]) #clientsTab,
        html:not([data-theme="dark"]) #programsTab,
        html:not([data-theme="dark"]) #adminTab {
            background: var(--bg-base, #F8F7FC) !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        /* Dashboard container light mode */
        body:not(.dark-mode) .dashboard-container,
        html:not([data-theme="dark"]) .dashboard-container {
            background: var(--bg-base, #F8F7FC) !important;
            border: none !important;
        }
        
        /* Ensure main body has no dark borders in light mode */
        body:not(.dark-mode) #mainApp,
        html:not([data-theme="dark"]) #mainApp {
            background: var(--bg-base, #F8F7FC) !important;
            border: none !important;
            outline: none !important;
        }
    </style>
    
    <!-- Menu Overlay -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>
    
    <div class="container">
        <div class="main-content">
            <!-- Left Panel: Program List -->
            <div class="programs-panel">
                
                <!-- Tab Navigation - Hidden (using drawer navigation instead) -->
                <div class="tab-navigation" style="display: none !important;">
                    <button class="tab-btn" data-tab-target="dashboard" onclick="window.switchTab && window.switchTab('dashboard')">
                        <span>🎯 Dashboard</span>
                    </button>
                    <button class="tab-btn active" data-tab-target="programs" onclick="window.switchTab && window.switchTab('programs')">
                        <span>📑 Programs &amp; Docs</span>
                    </button>
                    <button class="tab-btn" data-tab-target="clients" onclick="window.switchTab && window.switchTab('clients')">
                        <span>👥 Clients</span>
                    </button>
                </div>
                
                <!-- Dashboard Tab Content -->
                <div id="dashboardTab" class="tab-content">
                    <div class="dashboard-container">
                        <!-- Empty State Banner (hidden when clients exist) -->
                        <div id="dashboardEmptyState" class="dashboard-empty-banner" style="display: none;">
                            <div class="banner-copy">
                                <h4>No clients yet</h4>
                                <p>Add your first client to unlock Coach Mission Control.</p>
                            </div>
                            <div class="banner-actions">
                                <button onclick="window.showAddClientModal && window.showAddClientModal()">Add Client</button>
                            </div>
                        </div>

                        <!-- Quick Actions Widget (with greeting, KPIs, and action buttons) -->
                        <div id="quickActionsWidget" class="dashboard-widget widget-quick-actions"></div>
                        
                        <!-- Journey Radar - Full Width -->
                        <div id="journeyRadarWidget" class="dashboard-widget widget-journey journey-radar-full-width"></div>
                        
                        <!-- Main Grid: Flight Plan + Sidebar -->
                        <div class="dashboard-main-grid">
                            <div class="dashboard-column dashboard-column--primary">
                                <div id="flightPlanWidget" class="dashboard-widget widget-flight-plan"></div>
                            </div>
                            <div class="dashboard-column dashboard-column--secondary">
                                <div id="changesTodayWidget" class="dashboard-widget widget-changes-today"></div>
                                <div id="pipelineWidget" class="dashboard-widget widget-pipeline"></div>
                                <div id="gapsWidget" class="dashboard-widget widget-gaps"></div>
                                <div id="programSpotlightWidget" class="dashboard-widget widget-spotlight"></div>
                            </div>
                        </div>
                        
                        <!-- House Health Widget - Full Width -->
                        <div id="houseHealthWidget" class="dashboard-widget widget-house-health"></div>
                    </div>
                </div>
                
                <script>
                    // Tab switching function - make globally available
                    // Debounce lock to prevent flickering from rapid switches
                    let _tabSwitchLock = false;
                    let _currentTab = null;
                    
                    window.switchTab = function switchTab(tab) {
                        // Skip if already on this tab or locked
                        if (tab === _currentTab) return;
                        if (_tabSwitchLock) {
                            console.log('[Tab] Skipping switch to', tab, '- locked');
                            return;
                        }
                        
                        _tabSwitchLock = true;
                        _currentTab = tab;
                        
                        // Release lock after transition
                        setTimeout(() => { _tabSwitchLock = false; }, 150);
                        
                        try {
                            console.log('[Tab] Switching to:', tab);
                            
                            // Update shell UI
                            if (window.ccShell?.setActiveNavItem) {
                                window.ccShell.setActiveNavItem(tab);
                            }
                            if (tab === 'programs' && window.ccShell?.setSectionState) {
                                window.ccShell.setSectionState('programs-loading');
                            } else if (window.ccShell?.setSectionState) {
                                window.ccShell.setSectionState(tab);
                            }
                            
                            // Remove active class from all tabs and buttons, and hide them
                            document.querySelectorAll('.tab-content').forEach(t => {
                                if (t) {
                                    t.classList.remove('active');
                                    // Explicitly hide inactive tabs
                                    if (t.id !== tab + 'Tab') {
                                        t.style.display = 'none';
                                    }
                                }
                            });
                            document.querySelectorAll('.tab-btn').forEach(b => {
                                if (b) b.classList.remove('active');
                            });
                            
                            // Add active class to selected tab and ensure it's visible
                            const tabElement = document.getElementById(tab + 'Tab');
                            if (tabElement) {
                                tabElement.classList.add('active');
                                // Explicitly show the active tab
                                tabElement.style.display = 'block';
                                tabElement.style.visibility = 'visible';
                                tabElement.style.opacity = '1';
                                console.log('Activated tab:', tab + 'Tab');
                            } else {
                                console.warn('Tab element not found:', tab + 'Tab');
                            }
                            
                            // Add active class to corresponding button
                            const tabButtons = document.querySelectorAll('.tab-btn');
                            tabButtons.forEach(btn => {
                                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tab)) {
                                    btn.classList.add('active');
                                    console.log('Activated button for:', tab);
                                }
                            });
                            
                            // Special handling for dashboard tab
                            if (tab === 'dashboard') {
                                document.body.classList.add('dashboard-active');
                                
                                // Initialize dashboard if not already done
                                setTimeout(() => {
                                    if (window.dashboardManager) {
                                        if (!window.dashboardManager.initialized) {
                                            initializeDashboard();
                                        } else {
                                            // Re-render widgets if already initialized - ensure containers exist first
                                            const widgetContainers = [
                                                'flightPlanWidget',
                                                'journeyRadarWidget',
                                                'coachScheduleWidget',
                                                'quickActionsWidget'
                                            ];
                                            
                                            const allContainersExist = widgetContainers.every(id => {
                                                const container = document.getElementById(id);
                                                return container !== null;
                                            });
                                            
                                            if (allContainersExist && window.dashboardWidgets && window.dashboardWidgets.renderAll) {
                                                window.dashboardWidgets.renderAll().then(() => {
                                                    console.log('✅ Dashboard widgets re-rendered');
                                                }).catch(error => {
                                                    console.error('❌ Failed to re-render widgets:', error);
                                                    // Re-initialize if render fails
                                                    if (window.dashboardWidgets && window.dashboardWidgets.initialize) {
                                                        window.dashboardWidgets.initialize().then(() => {
                                                            return window.dashboardWidgets.renderAll();
                                                        }).catch(console.error);
                                                    }
                                                });
                                            } else {
                                                console.warn('⚠️ Widget containers missing, re-initializing...');
                                                initializeDashboard();
                                            }
                                        }
                                    } else {
                                        console.log('Dashboard manager not available, will retry...');
                                        setTimeout(() => {
                                            if (window.dashboardManager) {
                                                initializeDashboard();
                                            }
                                        }, 1000);
                                    }
                                }, 200);
                                
                                // IMPORTANT: Hide the document generation panel for Dashboard tab
                                const selectionPanel = document.querySelector('.selection-panel');
                                if (selectionPanel) {
                                    selectionPanel.style.display = 'none';
                                    selectionPanel.style.visibility = 'hidden';
                                    console.log('✅ Hidden selection panel for Dashboard tab');
                                }
                                
                                // Adjust main content layout to full width
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr';
                                    mainContent.style.maxWidth = '100%';
                                }
                            } else if (tab === 'programs') {
                                document.body.classList.remove('dashboard-active');
                                
                                // Load Programs & Docs module if needed
                                if (typeof shouldUseProgramsDocs === 'function' && shouldUseProgramsDocs()) {
                                    if (typeof mountProgramsDocsModule === 'function') {
                                        console.log('[Programs & Docs] Attempting to mount module...');
                                        mountProgramsDocsModule()
                                            .then(() => {
                                                window.ccShell?.setSectionState?.('programs');
                                            })
                                            .catch(error => {
                                                window.ccShell?.setSectionState?.('programs-error');
                                                console.error('[Programs & Docs] Failed to mount:', error);
                                            });
                                    } else {
                                        console.warn('[Programs & Docs] mountProgramsDocsModule function not available');
                                        window.ccShell?.setSectionState?.('programs-error');
                                    }
                                } else {
                                    console.log('[Programs & Docs] Feature flag disabled or function not available');
                                    window.ccShell?.setSectionState?.('programs-error');
                                }
                                
                                // Hide selection panel for Programs & Docs module (it has its own UI)
                                const selectionPanel = document.querySelector('.selection-panel');
                                if (selectionPanel) {
                                    selectionPanel.style.display = 'none';
                                    selectionPanel.style.visibility = 'hidden';
                                    console.log('✅ Hidden selection panel for Programs & Docs module');
                                }
                                
                                // Make main content full width for Programs & Docs module
                                const mainContent = document.querySelector('.main-content');
                                if (mainContent) {
                                    mainContent.style.gridTemplateColumns = '1fr';
                                    mainContent.style.maxWidth = '100%';
                                }
                                
                                // Initialize client selector when programs tab is shown
                                setTimeout(() => {
                                    if (typeof initializeClientSelector === 'function') {
                                        initializeClientSelector();
                                    }
                                }, 100);
                            } else if (tab === 'clients') {
                                document.body.classList.remove('dashboard-active');

                                // Initialize CM Tracker / Clients view so house tabs + table populate
                                try {
                                    if (typeof initializeClientTracker === 'function') {
                                        initializeClientTracker();
                                    } else if (typeof initializeCMTracker === 'function') {
                                        initializeCMTracker();
                                    } else {
                                        console.warn('Client tracker initialization functions not available');
                                    }
                                } catch (cmInitError) {
                                    console.error('Error initializing client tracker:', cmInitError);
                                }
                            }
                            
                            // Save preference
                            localStorage.setItem('lastActiveTab', tab);
                        } catch (error) {
                            console.error('Error switching tabs:', error);
                        }
                    }
                    
                    // Restore last active tab AFTER login completes (prevents flickering on load)
                    window.addEventListener('ccpro-login-success', () => {
                        const savedTab = localStorage.getItem('lastActiveTab');
                        if (savedTab && savedTab !== _currentTab) {
                            console.log('[Tab] Restoring last active tab:', savedTab);
                            setTimeout(() => switchTab(savedTab), 100);
                        }
                    }, { once: true });
                    
                    // Function to show selection panel (document generation UI) - make globally available
                    window.showSelectionPanel = function showSelectionPanel() {
                        // Restore all elements marked as hidden by dashboard
                        const hiddenElements = document.querySelectorAll('[data-dashboard-hidden="true"]');
                        hiddenElements.forEach(el => {
                            el.style.display = '';
                            el.style.visibility = '';
                            el.removeAttribute('data-dashboard-hidden');
                        });
                        console.log('✅ Restored selection panel');
                    }
                    
                    // Function to hide selection panel (document generation UI)
                    // IMPORTANT: Only target the actual .selection-panel element to avoid affecting dashboard
                    function hideSelectionPanel() {
                        // ONLY target the specific selection panel element
                        const selectionPanel = document.querySelector('.selection-panel');
                        if (selectionPanel) {
                            // Double-check it's not inside dashboard tab
                            if (!selectionPanel.closest('#dashboardTab') && !selectionPanel.closest('.dashboard-container')) {
                                selectionPanel.style.display = 'none';
                                selectionPanel.style.visibility = 'hidden';
                                selectionPanel.setAttribute('data-dashboard-hidden', 'true');
                                console.log('✅ Hidden selection panel (document generation UI)');
                            } else {
                                console.log('⚠️ Selection panel is inside dashboard - skipping hide');
                            }
                        }
                    }
                    
                    // EMERGENCY: Simple dashboard fallback
                    window.injectSimpleDashboard = function(reason = 'unspecified') {
                        if (!canUseFallbackDashboard(reason) && window.dashboardState?.mode !== 'fallback') {
                            return false;
                        }
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (!dashboardTab) {
                            console.error('Dashboard tab not found!');
                            return false;
                        }
                        
                        if (window.dashboardState?.mode === 'fallback' && window.dashboardState.fallbackInjected) {
                            console.warn(`Re-rendering fallback dashboard (${reason}).`);
                        } else {
                            console.warn(`Injecting fallback dashboard (${reason}).`);
                        }
                        
                        dashboardTab.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: var(--bg-surface) !important;';
                        dashboardTab.innerHTML = `
                            <div class="dashboard-container" style="padding: 20px; background: var(--bg-surface) !important; min-height: 600px; display: block !important;">
                                <h1 style="color: var(--text-primary) !important; margin-bottom: 20px;">🎯 Coach Dashboard (Fallback Mode)</h1>
                                <p style="color: var(--status-red) !important; padding: 10px; background: var(--status-red-bg); border-radius: 6px;">
                                    ⚠️ Dashboard widgets failed - showing emergency fallback
                                </p>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                                    <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--card-border);">
                                        <h3 style="color: var(--text-secondary) !important;">📊 Dashboard Status</h3>
                                        <p style="color: var(--status-green) !important;">✅ Fallback dashboard loaded</p>
                                        <p style="color: var(--text-secondary) !important;">Time: ${new Date().toLocaleTimeString()}</p>
                                    </div>
                                    
                                    <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--card-border);">
                                        <h3 style="color: var(--text-secondary) !important;">🔧 Quick Fix</h3>
                                        <button onclick="location.reload()" style="padding: 10px 20px; background: var(--btn-primary-bg); color: var(--btn-primary-text); border: none; border-radius: 6px; cursor: pointer;">
                                            🔄 Reload Page
                                        </button>
                                        <button onclick="window.clearCacheAndReload()" style="padding: 10px 20px; background: var(--status-red); color: var(--text-inverse); border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                                            🗑️ Clear Cache & Reload
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 30px; padding: 20px; background: var(--status-blue-bg); border-radius: 8px;">
                                    <h3 style="color: var(--status-blue-text) !important;">ℹ️ What Happened?</h3>
                                    <p style="color: var(--status-blue-text) !important;">The dashboard widgets failed to render. This fallback ensures you can still see something.</p>
                                    <p style="color: var(--status-blue-text) !important; margin-top: 10px;">To fix: Try clearing browser cache or using a different browser.</p>
                                </div>
                            </div>
                        `;
                        
                        setDashboardMode('fallback', reason);
                        console.log('✅ Simple fallback dashboard injected successfully');
                        return true;
                    }
                    
                    // Auto-inject fallback if main dashboard fails
                    setTimeout(() => {
                        if (window.dashboardState?.mode === 'modern') {
                            return;
                        }
                        const dashboardTab = document.getElementById('dashboardTab');
                        if (dashboardTab && dashboardTab.classList.contains('active')) {
                            const widgets = document.querySelectorAll('.dashboard-widget');
                            if (widgets.length === 0) {
                                console.warn('⚠️ No dashboard widgets found after 3 seconds, injecting fallback');
                                window.injectSimpleDashboard('timeout-no-widgets');
                            }
                        }
                    }, 3000);
                    
                    let dashboardWidgetsInitialized = false;
                    
                    async function waitForDashboardDependencies(timeout = 15000) {
                        const start = Date.now();
                        while (Date.now() - start < timeout) {
                            const hasClientManager = !!(window.clientManager?.getAllClients);
                            const hasHousesManager = !!(window.housesManager?.getHouses);
                            if (hasClientManager && hasHousesManager) {
                                return true;
                            }
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                        console.warn('Dashboard dependencies not ready within timeout', {
                            clientManager: !!window.clientManager,
                            housesManager: !!window.housesManager,
                            milestonesManager: !!window.milestonesManager
                        });
                        return false;
                    }
                    
                    function updateDashboardShell() {
                        if (!window.dashboardManager) return;
                        const greeting = dashboardManager.getTimeAwareGreeting();
                        const greetingEl = document.getElementById('dashboardGreeting');
                        const subtitleEl = document.getElementById('dashboardSubtitle');
                        const coachEl = document.getElementById('coachIndicator');
                        const updateEl = document.getElementById('lastUpdateTime');
                        
                        if (greetingEl) greetingEl.textContent = greeting.greeting;
                        if (subtitleEl) subtitleEl.textContent = greeting.focus;
                        // Show full coach name if available, fallback to initials
                        const coachName = dashboardManager.currentCoach?.fullName || 
                                         dashboardManager.currentCoach?.name ||
                                         dashboardManager.currentCoach?.initials || 
                                         '--';
                        if (coachEl) coachEl.textContent = `Coach: ${coachName}`;
                        if (updateEl) {
                            const timestamp = dashboardManager.lastUpdate || new Date();
                            updateEl.textContent = `Last updated: ${timestamp.toLocaleTimeString()}`;
                        }
                        
                        document.querySelectorAll('.dashboard-view-toggle button').forEach(button => {
                            const view = button.getAttribute('data-view');
                            button.classList.toggle('active', view === dashboardManager.currentView);
                        });
                        
                        const emptyBanner = document.getElementById('dashboardEmptyState');
                        if (emptyBanner) {
                            const activeClients = dashboardManager.cache?.metrics?.activeClients || 0;
                            emptyBanner.style.display = activeClients > 0 ? 'none' : 'flex';
                        }
                    }
                    
                    async function initializeDashboard(forceRefresh = false) {
                        if (!window.dashboardManager || !window.dashboardWidgets) {
                            console.log('Dashboard scripts not ready, retrying initializeDashboard...');
                            setTimeout(() => initializeDashboard(forceRefresh), 400);
                            return;
                        }
                        
                        setDashboardMode('loading', forceRefresh ? 'force-refresh' : 'initializeDashboard');
                        
                        await waitForDashboardDependencies();
                        
                        if (!window.milestonesManager) {
                            console.warn('MilestonesManager not available - dashboard schedule will be limited');
                        }
                        
                        try {
                            if (!dashboardManager.initialized) {
                                await dashboardManager.initialize();
                            } else if (forceRefresh) {
                                await dashboardManager.refreshDashboard();
                            } else {
                                await dashboardManager.loadDashboardData();
                            }
                            
                            // Demo data auto-populate removed for production
                            // Use the Demo Data Generator panel to manually populate test data
                            
                            if (!dashboardWidgetsInitialized) {
                                await window.dashboardWidgets.initialize();
                                dashboardWidgetsInitialized = true;
                            }
                            
                            await window.dashboardWidgets.renderAll();
                            updateDashboardShell();
                            setDashboardMode('modern', 'widgets-rendered');
                            
                            const selectionPanel = document.querySelector('.selection-panel');
                            if (selectionPanel && !selectionPanel.closest('#dashboardTab')) {
                                selectionPanel.style.display = 'none';
                                selectionPanel.style.visibility = 'hidden';
                            }
                            
                            console.log('✅ Dashboard initialized successfully');
                        } catch (error) {
                            console.error('Failed to initialize dashboard:', error);
                            setDashboardMode('error', 'initialize-dashboard-failed');
                        }
                    }
                    
                    // Manual function to force demo data creation and dashboard refresh
                    window.forceDemoData = async function() {
                        if (!window.ccConfig?.demoMode) {
                            window.showNotification('Demo data is disabled in this environment.', 'info');
                            return;
                        }

                        console.log('Forcing demo data creation...');
                        
                        if (!window.clientManager || !window.demoDataGenerator) {
                            console.error('Required components not loaded');
                            return;
                        }
                        
                        try {
                            // Clear existing demo clients first
                            const existingClients = await window.clientManager.getAllClients();
                            const demoClients = existingClients.filter(c => c.isDemo);
                            
                            for (const client of demoClients) {
                                await window.clientManager.deleteClient(client.id);
                            }
                            console.log('Cleared', demoClients.length, 'existing demo clients');
                            
                            // Create new demo clients
                            const created = await window.clientManager.generateDemoClients(40);
                            console.log('✅ Created', created.length, 'new demo clients');
                            
                            // Force complete dashboard refresh
                            await dashboardManager.initialize();
                            await dashboardManager.loadDashboardData();
                            await window.dashboardWidgets.renderAll();
                            updateDashboardShell();
                            
                            console.log('✅ Dashboard refreshed with demo data');
                        } catch (error) {
                            console.error('Failed to force demo data:', error);
                        }
                    };
                    
                    window.setDashboardView = async function(view) {
                        if (!window.dashboardManager || !view) return;
                        if (dashboardManager.currentView === view) {
                            return;
                        }
                        dashboardManager.currentView = view;
                        dashboardManager.savePreferences?.();
                        document.querySelectorAll('.dashboard-view-toggle button').forEach(button => {
                            const buttonView = button.getAttribute('data-view');
                            button.classList.toggle('active', buttonView === view);
                        });
                        await dashboardManager.refreshDashboard();
                        if (window.dashboardWidgets?.renderAll) {
                            await window.dashboardWidgets.renderAll();
                        }
                        updateDashboardShell();
                    };
                    
                    // Set programs as default on page load
                    document.addEventListener('DOMContentLoaded', function() {
                        // Start with Programs tab as default
                        const defaultTab = 'programs';
                        
                        // Initially hide the selection panel
                        const selectionPanel = document.querySelector('.selection-panel');
                        if (selectionPanel) {
                            selectionPanel.style.display = 'none';
                            selectionPanel.style.visibility = 'hidden';
                        }
                        
                        // Hide demo-only UI when demo mode is off
                        if (!window.ccConfig?.demoMode) {
                            document.querySelectorAll('[data-demo-only=\"true\"]').forEach(el => {
                                el.style.display = 'none';
                            });
                        }
                        
                        // Load programs tab by default
                        setTimeout(() => {
                            switchTab(defaultTab);
                        }, 100);
                        
                        // Diagnostic scripts removed - no longer needed
                        // These were temporary fixes that caused console noise
                        
                        /* Commented out diagnostic scripts:
                        // Run diagnostics after a delay
                        setTimeout(() => {
                            const script = document.createElement('script');
                            script.src = 'dashboard-diagnostics-fix.js?v=' + Date.now();
                            document.body.appendChild(script);
                        }, 2000);
                        
                        // Apply visibility fix
                        setTimeout(() => {
                            const fixScript = document.createElement('script');
                            fixScript.src = 'dashboard-visibility-fix.js?v=' + Date.now();
                            document.body.appendChild(fixScript);
                        }, 2500);
                        
                        // Apply parent visibility fix immediately
                        setTimeout(() => {
                            const parentFixScript = document.createElement('script');
                            parentFixScript.src = 'parent-visibility-fix.js?v=' + Date.now();
                            document.body.appendChild(parentFixScript);
                        }, 500);
                        */
                    });
                    
                    // Helper function for notifications
                    function showNotification(message, type = 'info') {
                        const notification = document.createElement('div');
                        notification.className = `notification notification-${type}`;
                        notification.innerHTML = `
                            <div class="notification-content">
                                <div class="notification-message">${message}</div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                        
                        // Add styles if not already present
                        if (!document.querySelector('#notificationStyles')) {
                            const style = document.createElement('style');
                            style.id = 'notificationStyles';
                            style.textContent = `
                                .notification {
                                    position: fixed;
                                    top: 20px;
                                    right: 20px;
                                    padding: 16px 24px;
                                    border-radius: 8px;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                    z-index: 10000;
                                    animation: slideIn 0.3s ease-out;
                                }
                                .notification-success { background: #10b981; color: white; }
                                .notification-error { background: #ef4444; color: white; }
                                .notification-info { background: #3b82f6; color: white; }
                                @keyframes slideIn {
                                    from { transform: translateX(100%); opacity: 0; }
                                    to { transform: translateX(0); opacity: 1; }
                                }
                            `;
                            document.head.appendChild(style);
                        }
                        
                        setTimeout(() => notification.remove(), 3000);
                    }

                    // Theme management using CareConnect design system
                    const ThemeManager = {
                        STORAGE_KEY: 'careconnect-theme',
                        LEGACY_KEY: 'theme',
                      
                        init() {
                            // Check for saved theme (new key first, then legacy key for migration)
                            let savedTheme = localStorage.getItem(this.STORAGE_KEY);
                            
                            // Migrate from legacy key if needed
                            if (!savedTheme) {
                                const legacyTheme = localStorage.getItem(this.LEGACY_KEY);
                                if (legacyTheme) {
                                    savedTheme = legacyTheme;
                                    localStorage.setItem(this.STORAGE_KEY, legacyTheme);
                                    localStorage.removeItem(this.LEGACY_KEY);
                                }
                            }
                            
                            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                            
                            if (savedTheme) {
                                this.setTheme(savedTheme);
                            } else if (prefersDark) {
                                this.setTheme('dark');
                            } else {
                                this.setTheme('light');
                            }
                      
                            // Listen for system preference changes when user has no explicit choice
                            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                                if (!localStorage.getItem(this.STORAGE_KEY)) {
                                    this.setTheme(e.matches ? 'dark' : 'light');
                                }
                            });
                        },
                      
                        setTheme(theme) {
                            document.documentElement.setAttribute('data-theme', theme);
                            document.documentElement.classList.toggle('dark', theme === 'dark');
                            document.body.classList.toggle('dark-mode', theme === 'dark');
                            localStorage.setItem(this.STORAGE_KEY, theme);
                            this.updateToggleUI(theme);
                            
                            // Sync map tiles with theme if map controller is available
                            if (window.ccMapController && typeof window.ccMapController.getTileLayer === 'function') {
                                const currentLayer = window.ccMapController.getTileLayer();
                                const desired = theme === 'dark' ? 'dark' : 'light';
                                if (currentLayer !== desired && typeof window.ccMapController.toggleTileLayer === 'function') {
                                    window.ccMapController.toggleTileLayer();
                                }
                            }
                        },
                      
                        toggle() {
                            const current = this.getCurrentTheme();
                            this.setTheme(current === 'dark' ? 'light' : 'dark');
                        },
                      
                        updateToggleUI(theme) {
                            const toggleBtn = document.querySelector('.dark-mode-toggle');
                            if (toggleBtn) {
                                const icon = toggleBtn.querySelector('.dark-mode-toggle-icon');
                                const label = toggleBtn.querySelector('.dark-mode-toggle-label');
                                
                                if (theme === 'dark') {
                                    if (icon) icon.textContent = '☀️';
                                    if (label) label.textContent = 'LIGHT MODE';
                                } else {
                                    if (icon) icon.textContent = '🌙';
                                    if (label) label.textContent = 'DARK MODE';
                                }
                            }
                        },
                      
                        getCurrentTheme() {
                            return document.documentElement.getAttribute('data-theme') || 'light';
                        }
                    };
                      
                    window.ThemeManager = ThemeManager;
                      
                    document.addEventListener('DOMContentLoaded', () => {
                        ThemeManager.init();
                    });
                    
                    // Helper function for modals
                    function showModal(options) {
                        const modal = document.createElement('div');
                        modal.className = 'modal cc-generic-modal';
                        modal.style.display = 'block';
                        modal.innerHTML = `
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2>${options.title}</h2>
                                    <button class="modal-close" onclick="window.closeModal(this.closest('.cc-generic-modal'))">&times;</button>
                                </div>
                                <div class="modal-body">
                                    ${options.content}
                                </div>
                                <div class="modal-actions">
                                    ${options.buttons.map(btn => 
                                        `<button onclick="${btn.action}; window.closeModal(this.closest('.cc-generic-modal'))">${btn.text}</button>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }

                    // Dark Mode Logic - delegates to ThemeManager
                    window.toggleTheme = function() {
                        if (window.ThemeManager) {
                            ThemeManager.toggle();
                        }
                    };

                    // Legacy initializeTheme - now handled by ThemeManager.init()
                    function initializeTheme() {
                        // ThemeManager.init() is called on DOMContentLoaded
                        // This function is kept for backwards compatibility
                    }
                </script>
                
                <!-- Programs Tab Content -->
                <div id="programsTab" class="tab-content active">
                    <div id="programsDocsLoader" class="programs-docs-loader" role="status" aria-live="polite">
                        <span class="loader-spinner" aria-hidden="true"></span>
                        <span class="loader-copy">Loading Programs &amp; Docs workspace…</span>
                    </div>
                    <div id="programsDocsContainer" class="programs-docs-container" hidden></div>
                    <div id="programsDocsError" class="programs-docs-error" hidden role="alert">
                        <h3>Programs workspace unavailable</h3>
                        <p>Please retry loading or switch back to the legacy module if needed.</p>
                        <div class="programs-docs-error-actions">
                            <button type="button" class="btn btn-primary" onclick="retryProgramsDocsMount()">Retry load</button>
                            <button type="button" class="btn" onclick="toggleLegacyPrograms(true)">Open legacy Programs view</button>
                        </div>
                    </div>
                    <div id="legacyProgramsWrapper" class="legacy-programs-wrapper" hidden aria-live="polite"></div>
                </div> <!-- End of programsTab -->
                
                <!-- Clients Tab Content -->
                <div id="clientsTab" class="tab-content">
                    <!-- Active/Discharged Tab Navigation -->
                    <div class="clients-view-tabs">
                        <button class="clients-view-tab clients-view-tab--active" id="activeClientsTab" onclick="showActiveClientsView()">
                            Active Clients
                            <span class="clients-view-tab__badge" id="activeClientCount">0</span>
                        </button>
                        <button class="clients-view-tab" id="dischargedClientsTab" onclick="showDischargedClientsView()">
                            Discharged Archive
                            <span class="clients-view-tab__badge" id="dischargedClientCount">0</span>
                        </button>
                    </div>
                    
                    <!-- Active Clients View -->
                    <div id="activeClientsView" class="clients-view">
                    <div class="cm-tracker-container">
                        <!-- House Navigation -->
                        <div class="house-navigation">
                            <div class="house-tabs" id="houseTabs">
                                <!-- House tabs will be dynamically generated -->
                            </div>
                        </div>
                        
                        <!-- House Content Area -->
                        <div class="house-content" id="houseContent">
                            <div class="cm-quick-actions">
                                <button class="cm-action-btn primary" onclick="window.showAddClientModal && window.showAddClientModal()">
                                    ➕ Add Client
                                </button>
                                <button class="cm-action-btn" onclick="showBulkImport()">
                                    📥 Import Excel
                                </button>
                                <button class="cm-action-btn" onclick="exportCurrentHouse()">
                                    💾 Export House
                                </button>
                                <button class="cm-action-btn" onclick="exportAllData()">
                                    📊 Export All
                                </button>
                                <button class="cm-action-btn" onclick="showReports()">
                                    📈 Reports
                                </button>
                                <button class="cm-action-btn" onclick="window.switchTab && window.switchTab('programs')" style="background: #f3f4f6;" data-tab-target="programs">
                                    📑 Programs &amp; Docs
                                </button>
                            </div>
                            
                            <div id="houseClientsList">
                                <!-- Client table will be dynamically generated here -->
                            </div>
                        </div>
                        
                    </div>
                    </div> <!-- End of activeClientsView -->
                    
                    <!-- Discharged Clients View -->
                    <div id="dischargedClientsView" class="clients-view" style="display: none;">
                        <!-- Content will be rendered by discharged-clients-view.js -->
                    </div>
                    
                </div> <!-- End of clientsTab -->
                
                <!-- Admin Command Center Tab (Admin Only) -->
                <div id="adminTab" class="tab-content" data-admin-only="true" style="display:none;">
                    <div class="acc-container">
                        
                        <!-- ═══════════════════════════════════════════════════════════════════════
                             HEADER
                             ═══════════════════════════════════════════════════════════════════════ -->
                        <header class="acc-header">
                            <div class="acc-header__title-group">
                                <span class="acc-header__eyebrow">Administration</span>
                                <h1 class="acc-header__title">
                                    Command Center
                                    <span class="acc-header__badge">Collecting Data</span>
                                </h1>
                            </div>
                            
                            <div class="acc-header__controls">
                                <div class="acc-date-select">
                                    <span>📅</span>
                                    <select id="accDateRange" onchange="accDateRangeChanged && accDateRangeChanged(this)">
                                        <option value="7d">Last 7 Days</option>
                                        <option value="30d" selected>Last 30 Days</option>
                                        <option value="90d">Last 90 Days</option>
                                        <option value="ytd">Year to Date</option>
                                        <option value="all">All Time</option>
                                    </select>
                                </div>
                                <button class="acc-btn acc-btn--secondary" onclick="accRefreshData && accRefreshData()">
                                    <span>↻</span> Refresh
                                </button>
                                <button class="acc-btn acc-btn--primary" onclick="accExportData && accExportData()">
                                    <span>📤</span> Export Data
                                </button>
                                <button class="acc-btn acc-btn--ghost" onclick="window.featureFlags && window.featureFlags.showPanel()">
                                    <span>🎛️</span> Feature Flags
                                </button>
                                <button class="acc-btn acc-btn--secondary" onclick="window.showUserManagement && window.showUserManagement()" title="Manage user accounts and admin access">
                                    <span>👥</span> Manage Users
                                </button>
                            </div>
                        </header>

                        <!-- ═══════════════════════════════════════════════════════════════════════
                             ATTENTION ALERTS
                             ═══════════════════════════════════════════════════════════════════════ -->
                        <div class="acc-alerts" id="accAlerts">
                            <!-- Dynamically populated by JS -->
                        </div>

                        <!-- ═══════════════════════════════════════════════════════════════════════
                             KPI CARDS
                             ═══════════════════════════════════════════════════════════════════════ -->
                        <div class="acc-kpis">
                            <div class="acc-kpi acc-kpi--referrals">
                                <div class="acc-kpi__header">
                                    <span class="acc-kpi__label">Aftercare Plans</span>
                                    <span class="acc-kpi__info" data-metric="acc_aftercare_plans">i</span>
                                    <span class="acc-kpi__trend acc-kpi__trend--neutral" id="accKpiReferralsTrend">—</span>
                                </div>
                                <div class="acc-kpi__value" id="accKpiReferrals">--</div>
                                <div class="acc-kpi__subtitle">Documents created</div>
                            </div>
                            
                            <div class="acc-kpi acc-kpi--admissions">
                                <div class="acc-kpi__header">
                                    <span class="acc-kpi__label">Successful Placements</span>
                                    <span class="acc-kpi__info" data-metric="acc_successful_placements">i</span>
                                    <span class="acc-kpi__trend acc-kpi__trend--neutral" id="accKpiAdmissionsTrend">—</span>
                                </div>
                                <div class="acc-kpi__value" id="accKpiAdmissions">--</div>
                                <div class="acc-kpi__subtitle">Confirmed transitions</div>
                            </div>
                            
                            <div class="acc-kpi acc-kpi--conversion">
                                <div class="acc-kpi__header">
                                    <span class="acc-kpi__label">Placement Rate</span>
                                    <span class="acc-kpi__info" data-metric="acc_placement_rate">i</span>
                                    <span class="acc-kpi__trend acc-kpi__trend--neutral" id="accKpiConversionTrend">—</span>
                                </div>
                                <div class="acc-kpi__value" id="accKpiConversion">--</div>
                                <div class="acc-kpi__subtitle">Plans → Placements</div>
                            </div>
                            
                            <div class="acc-kpi acc-kpi--compliance">
                                <div class="acc-kpi__header">
                                    <span class="acc-kpi__label">Doc Compliance</span>
                                    <span class="acc-kpi__info" data-metric="acc_doc_compliance">i</span>
                                    <span class="acc-kpi__trend acc-kpi__trend--neutral" id="accKpiComplianceTrend">—</span>
                                </div>
                                <div class="acc-kpi__value" id="accKpiCompliance">--</div>
                                <div class="acc-kpi__subtitle">On-time completion</div>
                            </div>
                            
                            <div class="acc-kpi acc-kpi--documents">
                                <div class="acc-kpi__header">
                                    <span class="acc-kpi__label">Discharge Packets</span>
                                    <span class="acc-kpi__info" data-metric="acc_discharge_packets">i</span>
                                    <span class="acc-kpi__trend acc-kpi__trend--neutral" id="accKpiPacketsTrend">—</span>
                                </div>
                                <div class="acc-kpi__value" id="accKpiPackets">--</div>
                                <div class="acc-kpi__subtitle">Completed &amp; uploaded</div>
                            </div>
                            
                            <div class="acc-kpi acc-kpi--tasks">
                                <div class="acc-kpi__header">
                                    <span class="acc-kpi__label">Tasks Completed</span>
                                    <span class="acc-kpi__info" data-metric="acc_tasks_completed">i</span>
                                    <span class="acc-kpi__trend acc-kpi__trend--neutral" id="accKpiTasksTrend">—</span>
                                </div>
                                <div class="acc-kpi__value" id="accKpiTasks">--</div>
                                <div class="acc-kpi__subtitle">This period</div>
                            </div>
                            
                            <div class="acc-kpi acc-kpi--census">
                                <div class="acc-kpi__header">
                                    <span class="acc-kpi__label">Active Census</span>
                                    <span class="acc-kpi__info" data-metric="acc_active_census">i</span>
                                    <span class="acc-kpi__trend acc-kpi__trend--neutral" id="accKpiCensusTrend">—</span>
                                </div>
                                <div class="acc-kpi__value" id="accKpiCensus">--</div>
                                <div class="acc-kpi__subtitle" id="accKpiCensusCapacity">of -- capacity</div>
                            </div>
                        </div>

                        <!-- ═══════════════════════════════════════════════════════════════════════
                             TAB NAVIGATION
                             ═══════════════════════════════════════════════════════════════════════ -->
                        <div class="acc-tabs">
                            <button class="acc-tab acc-tab--active" onclick="accSwitchTab('bizdev', this)">
                                <span class="acc-tab__icon">🤝</span>
                                Business Development
                            </button>
                            <button class="acc-tab" onclick="accSwitchTab('clinical', this)">
                                <span class="acc-tab__icon">📋</span>
                                Clinical Operations
                                <span class="acc-tab__badge" id="accClinicalBadge" style="display:none;">0</span>
                            </button>
                            <button class="acc-tab" onclick="accSwitchTab('data', this)">
                                <span class="acc-tab__icon">📂</span>
                                Data Management
                            </button>
                            <button class="acc-tab" onclick="accSwitchTab('export', this)">
                                <span class="acc-tab__icon">📤</span>
                                Export &amp; Reports
                            </button>
                        </div>

                        <!-- ═══════════════════════════════════════════════════════════════════════
                             BUSINESS DEVELOPMENT PANEL
                             ═══════════════════════════════════════════════════════════════════════ -->
                        <div class="acc-panel acc-panel--active" id="accPanelBizdev">
                            <div class="acc-grid">
                                
                                <!-- Top Programs Table -->
                                <div class="acc-col-8">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">📊</span>
                                                Top Placement Destinations
                                            </h3>
                                        </div>
                                        <div class="acc-card__body acc-card__body--flush">
                                            <table class="acc-table">
                                                <thead>
                                                    <tr>
                                                        <th>Program</th>
                                                        <th>Type</th>
                                                        <th>Placements</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="accProgramTable">
                                                    <tr><td colspan="3" class="acc-empty">Loading placement data...</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right column -->
                                <div class="acc-col-4">
                                    <!-- Referral Status Donut -->
                                    <div class="acc-card acc-mb-2">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">🎯</span>
                                                Discharge Outcomes
                                            </h3>
                                        </div>
                                        <div class="acc-card__body">
                                            <div class="acc-donut">
                                                <div class="acc-donut__chart">
                                                    <svg class="acc-donut__svg" viewBox="0 0 100 100" width="140" height="140">
                                                        <circle class="acc-donut__circle acc-donut__circle--bg" cx="50" cy="50" r="40"/>
                                                        <circle class="acc-donut__circle acc-donut__circle--value" id="accDonutProgram" cx="50" cy="50" r="40" 
                                                                stroke="var(--status-green)" stroke-dasharray="0 251" stroke-dashoffset="0"/>
                                                        <circle class="acc-donut__circle acc-donut__circle--value" id="accDonutHome" cx="50" cy="50" r="40" 
                                                                stroke="#3b82f6" stroke-dasharray="0 251" stroke-dashoffset="0"/>
                                                        <circle class="acc-donut__circle acc-donut__circle--value" id="accDonutClinicianRec" cx="50" cy="50" r="40" 
                                                                stroke="var(--status-yellow)" stroke-dasharray="0 251" stroke-dashoffset="0"/>
                                                        <circle class="acc-donut__circle acc-donut__circle--value" id="accDonutAMA" cx="50" cy="50" r="40" 
                                                                stroke="var(--status-red)" stroke-dasharray="0 251" stroke-dashoffset="0"/>
                                                    </svg>
                                                    <div class="acc-donut__center">
                                                        <div class="acc-donut__center-value" id="accDonutTotal">0</div>
                                                        <div class="acc-donut__center-label">Total</div>
                                                    </div>
                                                </div>
                                                <div class="acc-donut__legend">
                                                    <div class="acc-donut__legend-item">
                                                        <span class="acc-donut__legend-dot" style="background: var(--status-green)"></span>
                                                        Program
                                                        <span class="acc-donut__legend-value" id="accLegendProgram">0</span>
                                                    </div>
                                                    <div class="acc-donut__legend-item">
                                                        <span class="acc-donut__legend-dot" style="background: #3b82f6"></span>
                                                        Home w/ Supports
                                                        <span class="acc-donut__legend-value" id="accLegendHome">0</span>
                                                    </div>
                                                    <div class="acc-donut__legend-item">
                                                        <span class="acc-donut__legend-dot" style="background: var(--status-yellow)"></span>
                                                        Clinician Rec
                                                        <span class="acc-donut__legend-value" id="accLegendClinicianRec">0</span>
                                                    </div>
                                                    <div class="acc-donut__legend-item">
                                                        <span class="acc-donut__legend-dot" style="background: var(--status-red)"></span>
                                                        AMA / No Plan
                                                        <span class="acc-donut__legend-value" id="accLegendAMA">0</span>
                                                    </div>
                                                </div>
                                                <div class="acc-donut__footer" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #334155; font-size: 0.85rem; color: #94a3b8;">
                                                    Placement Rate: <strong id="accPlacementRate" style="color: #22c55e;">0%</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Relationship Health -->
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">💚</span>
                                                Relationship Health
                                            </h3>
                                        </div>
                                        <div class="acc-card__body">
                                            <div class="acc-health-list" id="accHealthList">
                                                <div class="acc-empty">No program relationships tracked yet</div>
                                            </div>
                                            <div class="acc-section-title" style="margin-top: 1rem; margin-bottom: 0.5rem;">Summary</div>
                                            <div id="accHealthSummary" style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-secondary);">
                                                <span>🟢 Preferred: <span id="accHealthPreferred">0</span></span>
                                                <span>🔵 Active: <span id="accHealthActive">0</span></span>
                                                <span>🟡 Stale: <span id="accHealthStale">0</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Decline Reasons -->
                                <div class="acc-col-6">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">📉</span>
                                                Decline Reasons
                                            </h3>
                                        </div>
                                        <div class="acc-card__body">
                                            <div class="acc-bar-chart" id="accDeclineReasons">
                                                <div class="acc-empty">No decline data yet</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Time to Admission -->
                                <div class="acc-col-6">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">⏱️</span>
                                                Time to Admission
                                            </h3>
                                        </div>
                                        <div class="acc-card__body">
                                            <div class="acc-compliance-grid" id="accTimeToAdmission">
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--info" id="accAvgDays">--</div>
                                                    <div class="acc-compliance-item__label">Avg Days</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--success" id="accMedianDays">--</div>
                                                    <div class="acc-compliance-item__label">Median Days</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--warning" id="accLongestDays">--</div>
                                                    <div class="acc-compliance-item__label">Longest Wait</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--success" id="accFastestDays">--</div>
                                                    <div class="acc-compliance-item__label">Fastest</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- House Occupancy Panel -->
                            <div class="acc-col-12">
                                <div class="acc-card">
                                    <div class="acc-card__header">
                                        <h3 class="acc-card__title">
                                            <span class="acc-card__title-icon">🏠</span>
                                            House Occupancy
                                        </h3>
                                        <div class="acc-card__header-meta">
                                            <span class="acc-card__subtitle" id="accOccupancyTotal">Total: --/-- beds</span>
                                            <span class="acc-card__info" data-metric="acc_house_occupancy_panel">i</span>
                                        </div>
                                    </div>
                                    <div class="acc-card__body">
                                        <div class="acc-occupancy-grid" id="accOccupancyGrid">
                                            <div class="acc-empty">Loading occupancy data...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ═══════════════════════════════════════════════════════════════════════
                             CLINICAL OPERATIONS PANEL
                             ═══════════════════════════════════════════════════════════════════════ -->
                        <div class="acc-panel" id="accPanelClinical">
                            <div class="acc-grid">
                                <!-- ASAM Compliance -->
                                <div class="acc-col-6">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">📝</span>
                                                Document Compliance
                                            </h3>
                                            <span class="acc-card__info" data-metric="acc_doc_panel">i</span>
                                        </div>
                                        <div class="acc-card__body">
                                            <div class="acc-compliance-grid acc-mb-3">
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--success" id="accDocOnTime">--</div>
                                                    <div class="acc-compliance-item__label">On Time</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--warning" id="accDocLate">--</div>
                                                    <div class="acc-compliance-item__label">Late</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--danger" id="accDocOverdue">--</div>
                                                    <div class="acc-compliance-item__label">Overdue</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--info" id="accDocTotal">--</div>
                                                    <div class="acc-compliance-item__label">Total</div>
                                                </div>
                                            </div>
                                            
                                            <div class="acc-section-title">By Type</div>
                                            <div class="acc-bar-chart" id="accDocByType">
                                                <div class="acc-empty">No document data yet</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discharge Packets -->
                                <div class="acc-col-6">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">📦</span>
                                                Discharge Packets
                                            </h3>
                                            <span class="acc-card__info" data-metric="acc_packets_panel">i</span>
                                        </div>
                                        <div class="acc-card__body">
                                            <div class="acc-compliance-grid acc-mb-3">
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--info" id="accPacketsCompleted">--</div>
                                                    <div class="acc-compliance-item__label">Completed</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--success" id="accPacketsUploaded">--</div>
                                                    <div class="acc-compliance-item__label">Uploaded</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--warning" id="accPacketsPending">--</div>
                                                    <div class="acc-compliance-item__label">Pending</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--success" id="accPacketsAvgTime">--</div>
                                                    <div class="acc-compliance-item__label">Avg Time</div>
                                                </div>
                                            </div>
                                            
                                            <div class="acc-section-title">Upload Rate</div>
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <div style="flex: 1; height: 12px; background: #0f172a; border-radius: 6px; overflow: hidden;">
                                                    <div id="accUploadRateBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); border-radius: 6px;"></div>
                                                </div>
                                            <span id="accUploadRate" style="font-size: 1.25rem; font-weight: 700; color: var(--status-green);">--%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Authorization Metrics -->
                                <div class="acc-col-8">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">🏥</span>
                                                Authorization Performance by Payer
                                            </h3>
                                            <span class="acc-card__info" data-metric="acc_auth_panel">i</span>
                                        </div>
                                        <div class="acc-card__body acc-card__body--flush">
                                            <table class="acc-table">
                                                <thead>
                                                    <tr>
                                                        <th>Payer</th>
                                                        <th>Requests</th>
                                                        <th>Approved</th>
                                                        <th>Denied</th>
                                                        <th>Approval Rate</th>
                                                        <th>Avg Decision</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="accAuthTable">
                                                    <tr><td colspan="6" class="acc-empty">Loading authorization data...</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Client Journey -->
                                <div class="acc-col-4">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">🛤️</span>
                                                Client Journey
                                            </h3>
                                            <span class="acc-card__info" data-metric="acc_journey_panel">i</span>
                                        </div>
                                        <div class="acc-card__body">
                                            <div class="acc-compliance-grid" style="grid-template-columns: repeat(2, 1fr);">
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--info" id="accCensus">--</div>
                                                    <div class="acc-compliance-item__label">Current Census</div>
                                                </div>
                                                <div class="acc-compliance-item">
                                                    <div class="acc-compliance-item__value acc-compliance-item__value--success" id="accAvgLOS">--</div>
                                                    <div class="acc-compliance-item__label">Avg LOS</div>
                                                </div>
                                            </div>
                                            
                                            <div class="acc-section-title" style="margin-top: 1.25rem;">Discharge Destinations</div>
                                            <div class="acc-bar-chart" id="accDischargeDestinations" style="margin-top: 0.75rem;">
                                                <div class="acc-empty">No discharge data yet</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ═══════════════════════════════════════════════════════════════════════
                             DATA MANAGEMENT PANEL
                             ═══════════════════════════════════════════════════════════════════════ -->
                        <div class="acc-panel" id="accPanelData">
                            <div class="acc-grid">
                                <!-- Import Data -->
                                <div class="acc-col-4">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">📥</span>
                                                Import Data
                                            </h3>
                                        </div>
                                        <div class="acc-card__body">
                                            <p class="acc-card__subtitle">
                                                Import demo or production data from a structured export file.
                                            </p>
                                            <button class="acc-btn acc-btn--primary" onclick="adminImportData && adminImportData()">
                                                <span>📥</span> Import Data
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Manage Programs -->
                                <div class="acc-col-4">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">⚙️</span>
                                                Manage Programs
                                            </h3>
                                        </div>
                                        <div class="acc-card__body">
                                            <p class="acc-card__subtitle">
                                                Open the program catalog management tools.
                                            </p>
                                            <button class="acc-btn acc-btn--secondary" onclick="adminOpenProgramManager && adminOpenProgramManager()">
                                                <span>⚙️</span> Open Program Manager
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Danger Zone -->
                                <div class="acc-col-4">
                                    <div class="acc-card acc-card--danger">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">🗑️</span>
                                                Clear All Programs
                                            </h3>
                                        </div>
                                        <div class="acc-card__body">
                                            <p class="acc-card__subtitle">
                                                Clears locally stored program selections and drafts. This cannot be undone.
                                            </p>
                                            <button class="acc-btn acc-btn--danger" onclick="adminClearAllPrograms && adminClearAllPrograms()">
                                                Clear All Programs
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ═══════════════════════════════════════════════════════════════════════
                             EXPORT PANEL
                             ═══════════════════════════════════════════════════════════════════════ -->
                        <div class="acc-panel" id="accPanelExport">
                            <div class="acc-grid">
                                <div class="acc-col-12">
                                    <div class="acc-card acc-export-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">📤</span>
                                                Export Analytics Data
                                            </h3>
                                        </div>
                                        <div class="acc-card__body">
                                            <p style="color: var(--text-secondary); margin-bottom: 1.25rem;">
                                                Export your analytics data for aggregation, reporting, or backup. All exports are structured JSON files ready for model processing or future backend import.
                                            </p>
                                            
                                            <div class="acc-export-options">
                                                <div class="acc-export-option acc-export-option--selected" onclick="accSelectExportType(this, 'full')">
                                                    <div class="acc-export-option__radio"></div>
                                                    <div class="acc-export-option__content">
                                                        <div class="acc-export-option__title">Full Export</div>
                                                        <div class="acc-export-option__desc">All data including clients, referrals, documents, and events</div>
                                                    </div>
                                                </div>
                                                <div class="acc-export-option" onclick="accSelectExportType(this, 'analytics_only')">
                                                    <div class="acc-export-option__radio"></div>
                                                    <div class="acc-export-option__content">
                                                        <div class="acc-export-option__title">Analytics Only</div>
                                                        <div class="acc-export-option__desc">Referrals, documents, auths, tasks — no client PII</div>
                                                    </div>
                                                </div>
                                                <div class="acc-export-option" onclick="accSelectExportType(this, 'summary')">
                                                    <div class="acc-export-option__radio"></div>
                                                    <div class="acc-export-option__content">
                                                        <div class="acc-export-option__title">Summary Report</div>
                                                        <div class="acc-export-option__desc">Aggregated metrics and KPIs only</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="acc-export-actions">
                                                <button class="acc-btn acc-btn--primary" onclick="accDownloadExport()">
                                                    <span>⬇️</span> Download JSON Export
                                                </button>
                                                <button class="acc-btn acc-btn--secondary" onclick="accCopyToClipboard()">
                                                    <span>📋</span> Copy to Clipboard
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Export History -->
                                <div class="acc-col-6">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">📜</span>
                                                Recent Exports
                                            </h3>
                                        </div>
                                        <div class="acc-card__body acc-card__body--flush">
                                            <table class="acc-table">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Type</th>
                                                        <th>Records</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="accExportHistory">
                                                    <tr><td colspan="3" class="acc-empty">No exports yet</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data Summary -->
                                <div class="acc-col-6">
                                    <div class="acc-card">
                                        <div class="acc-card__header">
                                            <h3 class="acc-card__title">
                                                <span class="acc-card__title-icon">💾</span>
                                                Data Store Summary
                                            </h3>
                                        </div>
                                        <div class="acc-card__body">
                                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; background: #0f172a; border-radius: 6px;">
                                                    <span style="color: var(--text-secondary);">Referrals</span>
                                                    <span style="font-weight: 600; color: var(--text-primary);" id="accStoreReferrals">0</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; background: #0f172a; border-radius: 6px;">
                                                    <span style="color: var(--text-secondary);">Documents</span>
                                                    <span style="font-weight: 600; color: var(--text-primary);" id="accStoreDocs">0</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; background: #0f172a; border-radius: 6px;">
                                                    <span style="color: var(--text-secondary);">Authorizations</span>
                                                    <span style="font-weight: 600; color: var(--text-primary);" id="accStoreAuths">0</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; background: #0f172a; border-radius: 6px;">
                                                    <span style="color: var(--text-secondary);">Tasks</span>
                                                    <span style="font-weight: 600; color: var(--text-primary);" id="accStoreTasks">0</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; background: #0f172a; border-radius: 6px;">
                                                    <span style="color: var(--text-secondary);">Events</span>
                                                    <span style="font-weight: 600; color: var(--text-primary);" id="accStoreEvents">0</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; background: #0f172a; border-radius: 6px;">
                                                    <span style="color: var(--text-secondary);">Programs</span>
                                                    <span style="font-weight: 600; color: var(--text-primary);" id="accStorePrograms">0</span>
                                                </div>
                                            </div>
                                            
                                            <div class="acc-divider"></div>
                                            
                                            <div class="acc-section-title">System Info</div>
                                            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem;">
                                                <div style="display: flex; justify-content: space-between; color: #94a3b8;">
                                                    <span>Version</span>
                                                    <span style="color: #f1f5f9;">v13.0.0-beta</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; color: #94a3b8;">
                                                    <span>Environment</span>
                                                    <span style="color: #f1f5f9;" id="accEnvMode">--</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between; color: #94a3b8;">
                                                    <span>Storage Used</span>
                                                    <span style="color: #f1f5f9;" id="accStorageUsed">--</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div> <!-- End of adminTab -->
                
            </div>
            
    <!-- ClearHive Branding -->
    <div style="text-align: center; padding: 20px; border-top: 1px solid #eee; margin-top: 40px; color: #999; font-size: 12px;">
        Document Creator by <strong>ClearHive Health LLC</strong>
    </div>

    <!-- Programs Data Loader already loaded in <head> -->

    <!-- Onboarding Video Intro - loads before first-login-flow -->
    <script src="js/onboarding/intro/intro.js"></script>
    
    <!-- Session Management & Data Persistence Scripts - MUST BE LOADED LAST -->
    <script src="js/auth/login-robust.js"></script>
    <script src="js/auth/first-login-flow.js"></script>
    <script src="js/data-persistence.js"></script>
    
    <!-- Admin Command Center Dashboard Functions (extracted to external module) -->
    <!-- See js/admin/admin-command-center.js for documentation -->
    <script src="js/admin/admin-command-center.js"></script>
    
    <!-- Admin Data Management Wrappers (extracted to external module) -->
    <script src="js/admin/admin-data-wrappers.js"></script>
    
    <!-- ═══════════════════════════════════════════════════════════════════════════
         USER MENU FUNCTIONS - Header dropdown and account management
         
         EXTRACTED TO: js/ui/user-menu.js (~330 lines)
         Extraction Date: December 7, 2025
         
         This module handles:
           - toggleUserMenu() - Toggle menu visibility
           - updateUserMenuInfo() - Update user info display
           - showCreateAccountForm() - Create account modal
           - handleLogout() - Secure logout
         
         See REFACTOR-MASTER-PLAN.md Phase 1.3
         ═══════════════════════════════════════════════════════════════════════════ -->
    <script src="js/ui/user-menu.js"></script>
    
    <!-- Session migration is handled by login-robust.js -->
    <!-- No additional migration script needed -->
    
    <!-- Admin Command Center Functions -->
    <script>
        (function() {
            'use strict';
            
            // Check if user is admin and show admin-only elements
            function checkAdminAccess() {
                const userRole = localStorage.getItem('userRole');
                const isAdmin = userRole === 'admin';
                
                // Show/hide admin-only elements
                document.querySelectorAll('[data-admin-only="true"]').forEach(el => {
                    el.style.display = isAdmin ? '' : 'none';
                });
                
                console.log('Admin access check:', isAdmin ? '✅ Admin' : '👤 User');
            }
            
            // Refresh admin analytics
            window.refreshAdminAnalytics = async function() {
                try {
                    // Total clients
                    if (window.clientManager) {
                        try {
                            const clients = await window.clientManager.getAllClients();
                            updateTextContent('totalClients', clients.length);
                        } catch (err) {
                            console.warn('[AdminAnalytics] Failed to load client count', err);
                        }
                    }
                    
                    // Total programs
                    if (window.programsData) {
                        updateTextContent('totalPrograms', window.programsData.length || 0);
                    }
                    
                    // Active users (approximate current device)
                    updateTextContent('activeUsers', '1');
                    
                    // Docs generated (from localStorage counter)
                    const docsCount = localStorage.getItem('docsGeneratedCount') || '0';
                    updateTextContent('docsGenerated', docsCount);
                    
                    // Environment mode
                    const envEl = document.getElementById('envMode');
                    if (envEl) {
                        const host = window.location.hostname;
                        envEl.textContent = (host === 'localhost' || host === '127.0.0.1') ? 'Development' : 'Production';
                    }
                    
                    // Storage used
                    const storageEl = document.getElementById('storageUsed');
                    if (storageEl && navigator.storage && navigator.storage.estimate) {
                        const estimate = await navigator.storage.estimate();
                        const usedMB = ((estimate.usage || 0) / (1024 * 1024)).toFixed(2);
                        storageEl.textContent = usedMB + ' MB';
                    } else if (storageEl) {
                        storageEl.textContent = 'N/A';
                    }
                    
                    // Analytics summary + export history
                    const [summary, exportHistory] = await Promise.all([
                        getAnalyticsSummarySafe(),
                        getExportHistorySafe()
                    ]);
                    
                    renderBusinessDevelopment(summary?.referrals);
                    renderClinicalOperations(summary);
                    renderExportHistory(exportHistory);
                    
                    if (window.attachMetricTooltips) {
                        window.attachMetricTooltips(document);
                    }
                    
                    console.log('✅ Admin analytics refreshed (app + CareConnect analytics)');
                } catch (error) {
                    console.error('Failed to refresh admin analytics:', error);
                }
            };
            
            async function getAnalyticsSummarySafe() {
                if (window.CareConnectAnalytics?.getSummary) {
                    try {
                        return await window.CareConnectAnalytics.getSummary();
                    } catch (err) {
                        console.warn('[AdminAnalytics] CareConnectAnalytics.getSummary failed', err);
                    }
                }
                if (window.analyticsExport?.generateSummary) {
                    try {
                        return await window.analyticsExport.generateSummary();
                    } catch (err) {
                        console.warn('[AdminAnalytics] analyticsExport.generateSummary failed', err);
                    }
                }
                return null;
            }
            
            async function getExportHistorySafe() {
                if (window.analyticsExport?.getExportHistory) {
                    try {
                        return await window.analyticsExport.getExportHistory();
                    } catch (err) {
                        console.warn('[AdminAnalytics] getExportHistory failed', err);
                    }
                }
                return [];
            }
            
            function updateTextContent(id, value) {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            }
            
            function renderBusinessDevelopment(referralData) {
                const tbody = document.getElementById('bdTopProgramsTableBody');
                const statusBar = document.getElementById('bdReferralStatusBar');
                const statusLegend = document.getElementById('bdReferralStatusLegend');
                
                if (tbody) {
                    const byProgram = referralData?.byProgram || {};
                    const entries = Object.entries(byProgram);
                    entries.sort((a, b) => (b[1] || 0) - (a[1] || 0));
                    const topEntries = entries.slice(0, 5);
                    
                    if (topEntries.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#9ca3af;">No referral analytics captured yet</td></tr>`;
                    } else {
                        tbody.innerHTML = topEntries.map(([name, count], idx) => `
                            <tr>
                                <td>${idx + 1}</td>
                                <td>${name || 'Unknown Program'}</td>
                                <td>${count}</td>
                            </tr>
                        `).join('');
                    }
                }
                
                if (statusBar && statusLegend) {
                    const total = Math.max(referralData?.total || 0, 0);
                    const byStatus = referralData?.byStatus || {};
                    const statusEntries = Object.entries(byStatus).filter(([, count]) => count > 0);
                    
                    if (total === 0 || statusEntries.length === 0) {
                        statusBar.innerHTML = `<div style="font-size:12px; color:#9ca3af; padding:2px 4px;">No data</div>`;
                        statusLegend.innerHTML = '';
                        return;
                    }
                    
                    const colors = {
                        admitted: '#22c55e',
                        pending: '#3b82f6',
                        declined: '#ef4444',
                        withdrawn: '#f97316',
                        no_response: '#9ca3af'
                    };
                    
                    statusBar.innerHTML = statusEntries.map(([status, count]) => {
                        const pct = Math.min(100, Math.max(0, (count / total) * 100));
                        const color = colors[status] || '#6b7280';
                        return `<div class="stacked-bar-segment" style="width:${pct}%; background:${color};"></div>`;
                    }).join('');
                    
                    statusLegend.innerHTML = statusEntries.map(([status, count]) => {
                        const color = colors[status] || '#6b7280';
                        return `
                            <li>
                                <span class="legend-swatch" style="background:${color};"></span>
                                <span>${status} (${count})</span>
                            </li>
                        `;
                    }).join('');
                }
            }
            
            function renderClinicalOperations(summary) {
                const documents = summary?.documents || {};
                const authorizations = summary?.authorizations || {};
                const tasks = summary?.tasks || {};
                
                updateMetricPanel({
                    pillId: 'docCompletionRateKpi',
                    barId: 'docCompletionBar',
                    listId: 'docMetricsList',
                    rate: documents.completionRate,
                    rows: [
                        ['Total', documents.total ?? 0],
                        ['Completed', documents.completed ?? 0],
                        ['Pending', documents.pending ?? 0],
                        ['Overdue', documents.overdue ?? 0],
                        ['Uploaded to EMR', documents.uploaded ?? 0]
                    ]
                });
                
                updateMetricPanel({
                    pillId: 'authApprovalRateKpi',
                    barId: 'authApprovalBar',
                    listId: 'authMetricsList',
                    rate: authorizations.approvalRate,
                    rows: [
                        ['Total', authorizations.total ?? 0],
                        ['Approved', authorizations.approved ?? 0],
                        ['Denied', authorizations.denied ?? 0],
                        ['Pending', authorizations.pending ?? 0]
                    ]
                });
                
                updateMetricPanel({
                    pillId: 'taskCompletionRateKpi',
                    barId: 'taskCompletionBar',
                    listId: 'taskMetricsList',
                    rate: tasks.completionRate,
                    rows: [
                        ['Total', tasks.total ?? 0],
                        ['Completed', tasks.completed ?? 0],
                        ['Pending', tasks.pending ?? 0],
                        ['Overdue', tasks.overdue ?? 0]
                    ]
                });
            }
            
            function updateMetricPanel({ pillId, barId, listId, rate, rows }) {
                const pill = document.getElementById(pillId);
                const bar = document.getElementById(barId);
                const list = document.getElementById(listId);
                
                if (pill) pill.textContent = rate || 'N/A';
                
                if (bar) {
                    const numericRate = parseFloat(rate);
                    const width = Number.isFinite(numericRate) ? Math.min(Math.max(numericRate, 0), 100) : 0;
                    bar.style.width = width + '%';
                }
                
                if (list && Array.isArray(rows)) {
                    list.innerHTML = rows.map(([label, value]) => `
                        <li><span>${label}</span><span>${value}</span></li>
                    `).join('');
                }
            }
            
            function renderExportHistory(history) {
                const container = document.getElementById('exportHistoryList');
                if (!container) return;
                
                if (!history || history.length === 0) {
                    container.innerHTML = `
                        <div class="export-history-item">
                            <span>No exports yet</span>
                            <span>—</span>
                        </div>
                    `;
                    return;
                }
                
                const recent = history.slice(-5).reverse();
                container.innerHTML = recent.map(record => {
                    const date = (record.exportDate || '').split('T')[0] || 'Unknown date';
                    const type = record.exportType || 'full';
                    const events = record.recordCounts?.analyticsEvents;
                    const eventsLabel = typeof events === 'number' ? `${events} events` : '—';
                    return `
                        <div class="export-history-item">
                            <span>${date} (${type})</span>
                            <span>${eventsLabel}</span>
                        </div>
                    `;
                }).join('');
            }
            
            // Run on page load
            document.addEventListener('DOMContentLoaded', function() {
                // Check admin access after a short delay to ensure login state is loaded
                setTimeout(checkAdminAccess, 500);
                
                // Also check when storage changes (login/logout)
                window.addEventListener('storage', function(e) {
                    if (e.key === 'userRole' || e.key === 'isLoggedIn') {
                        checkAdminAccess();
                    }
                });
            });
            
            // Listen for tab changes to refresh admin analytics
            // Using MutationObserver instead of wrapping switchTab to avoid conflicts
            const adminTab = document.getElementById('adminTab');
            if (adminTab) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class' && adminTab.classList.contains('active')) {
                            window.refreshAdminAnalytics();
                        }
                    });
                });
                observer.observe(adminTab, { attributes: true });
            }
        })();
    </script>

    <style>
        /* Theme-aware shell overrides using design tokens */
        .app-header {
            background-color: var(--header-bg);
            color: var(--header-text);
        }

        .app-header__brand-text strong {
            color: var(--header-text);
        }

        .app-header__brand-subtitle {
            color: var(--header-text-muted);
        }

        .app-header__icon-btn {
            color: var(--header-text-muted);
        }

        .app-header__icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.06);
        }

        .app-drawer {
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
        }

        .app-drawer__item {
            color: var(--sidebar-text);
        }

        .app-drawer__item.is-active {
            background-color: var(--brand-primary);
            color: var(--sidebar-text-active);
        }

        /* Generic cards & panels */
        .card,
        .dashboard-card,
        .widget,
        .panel,
        .section-header,
        .history-panel,
        .comparison-view {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all var(--transition-fast);
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background-color: var(--btn-primary-bg);
            color: var(--btn-primary-text);
        }

        .btn-primary:hover {
            background-color: var(--btn-primary-bg-hover);
        }

        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--btn-secondary-border);
        }

        .btn-secondary:hover {
            background-color: var(--btn-secondary-bg-hover);
        }

        .btn-danger {
            background-color: var(--btn-danger-bg);
            color: var(--btn-danger-text);
        }

        .btn-danger:hover {
            background-color: var(--btn-danger-bg-hover);
        }

        .btn-success {
            background-color: var(--btn-success-bg);
            color: var(--btn-success-text);
        }

        .btn-success:hover {
            background-color: var(--btn-success-bg-hover);
        }

        /* Inputs */
        input[type="text"],
        input[type="search"],
        input[type="number"],
        input[type="email"],
        input[type="password"],
        input[type="date"],
        textarea,
        select {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--input-text);
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--input-placeholder);
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--input-border-focus);
            box-shadow: 0 0 0 3px var(--border-focus-ring);
            outline: none;
        }

        /* Tables */
        table thead th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            border-bottom: 1px solid var(--table-border);
        }

        table tbody tr {
            background-color: var(--table-row-bg);
        }

        table tbody tr:nth-child(even) {
            background-color: var(--table-row-bg-stripe);
        }

        table tbody tr:hover {
            background-color: var(--table-row-bg-hover);
        }

        /* Tabs */
        .acc-tab,
        .house-tab {
            background-color: var(--tab-bg);
            color: var(--tab-text);
            border-color: var(--tab-border);
        }

        .acc-tab.acc-tab--active,
        .house-tab.active {
            background-color: var(--tab-bg-active);
            color: var(--tab-text-active);
        }

        /* Status zones */
        .zone-red {
            background-color: var(--status-red-bg);
            border: 1px solid var(--status-red-border);
        }

        .zone-yellow {
            background-color: var(--status-yellow-bg);
            border: 1px solid var(--status-yellow-border);
        }

        .zone-purple {
            background-color: var(--status-purple-bg);
            border: 1px solid var(--status-purple-border);
        }

        .zone-green {
            background-color: var(--status-green-bg);
            border: 1px solid var(--status-green-border);
        }

        /* Alerts & notifications */
        .alert-banner.alert-banner-warning {
            background-color: var(--alert-warning-bg);
            border-color: var(--alert-warning-border);
            color: var(--alert-warning-text);
        }

        .alert-banner.alert-banner-error {
            background-color: var(--alert-error-bg);
            border-color: var(--alert-error-border);
            color: var(--alert-error-text);
        }

        .notification-success {
            background-color: var(--alert-success-bg);
            color: var(--alert-success-text);
        }

        .notification-error {
            background-color: var(--alert-error-bg);
            color: var(--alert-error-text);
        }

        .notification-info {
            background-color: var(--alert-info-bg);
            color: var(--alert-info-text);
        }

        /* Programs & Docs surfaces */
        .programs-module,
        .programs-docs-container,
        .selection-panel,
        .document-builder,
        .doc-builder-panel,
        .history-panel,
        .comparison-view,
        .slide-menu,
        .menu-content {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .program-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            color: var(--text-primary);
        }

        .program-card-header {
            background: var(--card-header-dark);
            color: var(--card-header-dark-text);
        }

        .program-card-body {
            background: transparent;
            color: var(--text-primary);
        }

        .program-card.selected {
            box-shadow: 0 0 0 2px var(--brand-primary);
        }

        .program-info-btn,
        .program-card .btn {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--btn-secondary-border);
        }

        .program-info-btn:hover,
        .program-card .btn:hover {
            background: var(--btn-secondary-bg-hover);
        }

        .filter-btn,
        .section-chip,
        .tab-btn {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            border: 1px solid var(--btn-secondary-border);
        }

        .filter-btn.active,
        .tab-btn.active,
        .section-chip.is-primary {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            border-color: var(--btn-primary-bg);
        }

        .document-builder,
        .document-builder .doc-program-item,
        .document-builder .doc-section,
        .wizard-card,
        .wizard-program-item,
        .wizard-toggle,
        .instructions,
        .client-info,
        .search-box,
        #documentPreviewContainer {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
        }

        .document-builder h3,
        .doc-program-item-name,
        .wizard-program-meta .name,
        .wizard-section-title {
            color: var(--text-primary);
        }

        .history-panel,
        .comparison-view {
            background: var(--bg-surface-elevated);
            border: 1px solid var(--card-border);
        }

        .history-panel h3,
        .comparison-view h3 {
            color: var(--text-primary);
        }

        .slide-menu .menu-item {
            background: var(--bg-surface);
            border: 1px solid transparent;
            color: var(--text-primary);
        }

        .slide-menu .menu-item:hover {
            border-color: var(--border-default);
            background: var(--bg-surface-sunken);
        }

        /* CM Tracker surfaces */
        .cm-tracker-container,
        .house-content,
        .cm-quick-actions,
        .house-tabs {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .house-tabs .house-tab {
            background: var(--tab-bg);
            border: 1px solid var(--tab-border);
            color: var(--tab-text);
        }

        .house-tabs .house-tab.active {
            background: var(--tab-bg-active);
            color: var(--tab-text-active);
        }

        .cm-action-btn {
            background: var(--btn-secondary-bg);
            border: 1px solid var(--btn-secondary-border);
            color: var(--btn-secondary-text);
        }

        .cm-action-btn.primary {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            border-color: var(--btn-primary-bg);
        }

        .client-row,
        .client-card,
        .bulk-client-checkbox,
        .bulk-item-checkbox {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
        }

        .task-status-pill,
        .status-pill {
            background: var(--status-blue-bg);
            color: var(--status-blue-text);
        }

        .task-status-pill.status-overdue { background: var(--status-red-bg); color: var(--status-red-text); }
        .task-status-pill.status-due { background: var(--status-yellow-bg); color: var(--status-yellow-text); }
        .task-status-pill.status-complete { background: var(--status-green-bg); color: var(--status-green-text); }

        .bulk-tracker-update,
        .bulk-selection,
        .bulk-summary {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .quick-update-modal,
        .profile-modal,
        .document-hub-modal,
        .aftercare-cascade-modal {
            background: var(--bg-surface-elevated);
            color: var(--text-primary);
        }
    </style>

    <!-- Interactive Step-by-Step Coach Tour (ONE system only) -->
    <script src="js/interactive-tour.js"></script>
    
    <!-- Document Vault System - Password Protected (extracted to external module) -->
    <!-- See js/ui/document-vault.js for documentation -->
    <script src="js/ui/document-vault.js"></script>
</body>
</html>


